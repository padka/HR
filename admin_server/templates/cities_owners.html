{% extends "base.html" %}
{% block title %}–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞ –≥–æ—Ä–æ–¥–∞{% endblock %}
{% block content %}

{% if not owner_field_exists %}
  <div class="card glass grain" data-tilt style="padding:16px;">
    <h3 style="margin:0 0 8px; display:flex; align-items:center; gap:8px;">
      –ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–ª–µ –¥–ª—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ
      <span class="badge">City model</span>
    </h3>
    <p class="muted" style="margin:0;">
      –í –º–æ–¥–µ–ª–∏ <code>City</code> –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–≥–æ –ø–æ–ª—è:
      <code>responsible_recruiter_id</code>, <code>owner_id</code>, <code>recruiter_id</code>, <code>manager_id</code>.
      –î–æ–±–∞–≤—å—Ç–µ –æ–¥–Ω–æ –∏–∑ –Ω–∏—Ö –≤ –ë–î –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
    </p>
  </div>
{% else %}

<!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
<div class="card glass grain" data-tilt style="margin-bottom:12px; padding:12px;">
  <div style="display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap;">
    <div class="field" style="min-width:260px;">
      <label for="search">–ü–æ–∏—Å–∫ –ø–æ –≥–æ—Ä–æ–¥—É</label>
      <input id="search" type="text" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞‚Ä¶">
    </div>

    <label class="badge" style="cursor:pointer; margin-bottom:6px; display:flex; align-items:center; gap:6px;">
      <input id="only_unassigned" type="checkbox">
      –¢–æ–ª—å–∫–æ –±–µ–∑ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ
    </label>

    <div class="muted" style="margin-left:auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <span>–ü–æ–ª–µ –≤ –ë–î: <code>{{ owner_field }}</code></span>
      <span class="badge" title="–ú–µ—Ç—Ä–∏–∫–∏">
        –ì–æ—Ä–æ–¥–∞: {{ cities|length }} ¬∑ –†–µ–∫—Ä—É—Ç—ë—Ä—ã: {{ recruiters|length }}
      </span>
    </div>
  </div>
  <div class="muted" style="margin-top:8px; font-size:12px;">
    –ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∫–∞—Ä—Ç–æ—á–∫—É –≥–æ—Ä–æ–¥–∞ –≤ –∫–æ–ª–æ–Ω–∫—É —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞, —á—Ç–æ–±—ã –Ω–∞–∑–Ω–∞—á–∏—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ. –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
  </div>
</div>

<!-- –õ–µ–≥–µ–Ω–¥–∞ -->
<div class="card glass grain" style="margin-bottom:12px; padding:12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
  <span class="badge" title="–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ">üñ±Ô∏è Drag &amp; Drop</span>
  <span class="badge" title="–ü–æ–∏—Å–∫">‚åò/Ctrl+F ‚Äî –ø–æ–∏—Å–∫</span>
  <span class="badge" title="–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: –∞–≤—Ç–æ</span>
</div>

<!-- –ö–∞–Ω–±–∞–Ω -->
<div id="board" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:12px;">
  <!-- –ö–æ–ª–æ–Ω–∫–∞ "–ë–µ–∑ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ" -->
  <div class="glass grain column" data-rec="">
    <div class="card glass grain" data-tilt>
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div style="font-weight:700;">–ë–µ–∑ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ</div>
        <span class="badge count">0</span>
      </div>
    </div>
    <div class="dropzone" style="display:flex; flex-direction:column; gap:8px; min-height:80px;"></div>
  </div>

  {% for r in recruiters %}
  <div class="glass grain column" data-rec="{{ r.id }}">
    <div class="card glass grain" data-tilt>
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div style="font-weight:700;">{{ r.name }}</div>
        <span class="badge count">0</span>
      </div>
      <div class="muted" style="font-size:12px;">TZ: {{ r.tz or "Europe/Moscow" }}</div>
    </div>
    <div class="dropzone" style="display:flex; flex-direction:column; gap:8px; min-height:80px;"></div>
  </div>
  {% endfor %}
</div>

<!-- –°–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç–æ—á–µ–∫ (—Å–∫—Ä—ã—Ç—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä-–∏—Å—Ç–æ—á–Ω–∏–∫) -->
<div id="cards" style="display:none;">
  {% for c in cities %}
    {% set owner = owners.get(c.id) if owners else None %}
    <div class="card glass grain city-card"
         draggable="true"
         data-city="{{ c.id }}"
         data-name="{{ (c.name or '')|lower|e }}"
         data-owner="{{ owner if owner is not none else '' }}"
         title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –≤ –Ω—É–∂–Ω—É—é –∫–æ–ª–æ–Ω–∫—É">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div style="font-weight:600;">{{ c.name }}</div>
        <span class="badge">{{ c.tz or "Europe/Moscow" }}</span>
      </div>
    </div>
  {% endfor %}
</div>

<style>
  /* DnD visuals tuned to Liquid Glass tokens */
  .dropzone {
    border: 1px dashed var(--row-sep);
    border-radius: var(--radius-lg);
    padding: 8px;
    transition: background .15s ease, border-color .15s ease, box-shadow .15s ease;
    background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.015));
  }
  .dropzone.hover {
    background: rgba(255,255,255,.04);
    border-color: var(--ring);
    box-shadow: 0 0 0 2px color-mix(in oklab, var(--ring) 26%, transparent);
  }
  .city-card { cursor: grab; }
  .city-card:active { cursor: grabbing; }
  .city-card.dragging { opacity: .6; transform: scale(.98); }
</style>

{% raw %}
<script>
(function(){
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

  const board = $('#board');
  const cardsPool = $('#cards');
  const search = $('#search');
  const onlyUn = $('#only_unassigned');

  // –ü–æ–¥—Å—Ç–∞–≤–∏–º –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –∏—Ö –∫–æ–ª–æ–Ω–∫–∏
  function mountCards(){
    const dzMap = {};
    $$('.column').forEach(col=>{
      dzMap[col.dataset.rec] = $('.dropzone', col);
      dzMap[col.dataset.rec].innerHTML = '';
    });

    const cards = $$('.city-card', cardsPool);
    cards.forEach(card=>{
      const owner = card.dataset.owner || '';
      const dz = Object.prototype.hasOwnProperty.call(dzMap, owner) ? dzMap[owner] : dzMap[''];
      dz.appendChild(card);
    });

    recount();
    applyFilter();
  }

  function recount(){
    $$('.column').forEach(col=>{
      const visible = $$('.city-card', $('.dropzone', col)).filter(x=>x.style.display!=='none').length;
      $('.count', col).textContent = String(visible);
    });
  }

  // drag & drop
  let dragging = null;
  document.addEventListener('dragstart', (e)=>{
    const card = e.target.closest('.city-card');
    if (!card) return;
    dragging = card;
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', card.dataset.city);
    setTimeout(()=> card.classList.add('dragging'), 0);
  });
  document.addEventListener('dragend', ()=>{
    if (dragging) dragging.classList.remove('dragging');
    dragging = null;
  });

  $$('.dropzone').forEach(dz=>{
    dz.addEventListener('dragover', (e)=>{
      e.preventDefault();
      dz.classList.add('hover');
      e.dataTransfer.dropEffect = 'move';
    });
    dz.addEventListener('dragleave', ()=> dz.classList.remove('hover'));
    dz.addEventListener('drop', async (e)=>{
      e.preventDefault();
      dz.classList.remove('hover');
      const cityId = e.dataTransfer.getData('text/plain');
      if (!cityId) return;

      const col = dz.closest('.column');
      const recId = col ? (col.dataset.rec || null) : null;

      // –ø–µ—Ä–µ–º–µ—Å—Ç–∏–º –≤ UI —Å—Ä–∞–∑—É
      const sel = `.city-card[data-city="${CSS.escape(cityId)}"]`;
      const card = document.querySelector(sel);
      if (card) {
        card.dataset.owner = recId || '';
        dz.appendChild(card);
        recount();
        applyFilter();
      }

      // –∑–∞–ø—Ä–æ—Å –Ω–∞ –±—ç–∫–µ–Ω–¥
      try{
        const resp = await fetch('/cities/owners/assign', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({city_id: Number(cityId), recruiter_id: recId ? Number(recId) : null})
        });
        const json = await resp.json();
        if (!json.ok){
          alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (json.error || 'unknown'));
        }
      }catch(err){
        alert('–°–µ—Ç—å/—Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
      }
    });
  });

  function applyFilter(){
    const q = (search?.value || '').toLowerCase().trim();
    const only = !!onlyUn?.checked;

    $$('.city-card').forEach(card=>{
      const name = (card.dataset.name || '');
      const unassigned = !card.dataset.owner;
      const okByText = !q || name.includes(q);
      const okByOnly = !only || unassigned;
      card.style.display = (okByText && okByOnly) ? '' : 'none';
    });

    recount();
  }

  search?.addEventListener('input', applyFilter);
  onlyUn?.addEventListener('change', applyFilter);

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  mountCards();
})();
</script>
{% endraw %}

{% endif %}
{% endblock %}