{% extends "base_liquid.html" %}
{% block title %}Дашборд{% endblock %}
{% block content %}
<section class="dashboard-hero">
  <div class="hero__copy">
    <p class="hero__eyebrow">TG Bot · HR Operations</p>
    <h1 class="hero__title">Центр управления рекрутингом</h1>
    <p class="hero__description">Следите за воронкой кандидатов, слотами и продуктивностью команды в режиме реального времени.</p>
    <div class="hero__cta-group">
      <a class="btn btn-primary" href="/candidates">К кандидатам</a>
      <a class="btn btn-secondary" href="/recruiters">Управление рекрутёрами</a>
    </div>
  </div>
  <div class="hero__actions">
    <p class="hero__actions-title">Быстрые действия</p>
    <div class="hero__cta-secondary">
      <a class="btn btn-ghost" href="/slots/new">Создать слот</a>
      <a class="btn btn-ghost" href="/templates/new">Добавить шаблон</a>
      <a class="btn btn-ghost" href="/questions/new">Новый вопрос</a>
    </div>
  </div>
</section>

<section class="dashboard-metrics">
  <article class="metric-card glass-card">
    <span class="metric-card__label">Рекрутёры</span>
    <span class="metric-card__value">{{ counts.recruiters }}</span>
    <span class="metric-card__meta">Активных городов: {{ counts.cities }}</span>
  </article>
  <article class="metric-card glass-card">
    <span class="metric-card__label">Слоты</span>
    <span class="metric-card__value">{{ counts.slots_total }}</span>
    <span class="metric-card__meta">Свободно: {{ counts.slots_free }} • В ожидании: {{ counts.slots_pending }} • Забронировано: {{ counts.slots_booked }}</span>
  </article>
  <article class="metric-card glass-card calendar-summary">
    <span class="metric-card__label">Интервью · <span data-calendar-label>{{ calendar.selected_label }}</span></span>
    <span class="metric-card__value" data-calendar-total>{{ calendar.events_total }}</span>
    <span class="metric-card__meta" data-calendar-meta>{{ calendar.meta }}</span>
    <span class="metric-card__meta muted" data-calendar-updated>{{ calendar.updated_label }}</span>
  </article>
  <article class="metric-card glass-card calendar-status-card">
    <span class="metric-card__label">Статусы интервью</span>
    <ul class="calendar-status-list" data-calendar-status>
      <li class="calendar-status-list__item">
        <span class="calendar-status-list__label">Подтверждено</span>
        <span class="calendar-status-list__value" data-calendar-status-confirmed>{{ calendar.status_summary['CONFIRMED_BY_CANDIDATE'] }}</span>
      </li>
      <li class="calendar-status-list__item">
        <span class="calendar-status-list__label">Назначено</span>
        <span class="calendar-status-list__value" data-calendar-status-booked>{{ calendar.status_summary['BOOKED'] }}</span>
      </li>
      <li class="calendar-status-list__item">
        <span class="calendar-status-list__label">Ожидает подтверждения</span>
        <span class="calendar-status-list__value" data-calendar-status-pending>{{ calendar.status_summary['PENDING'] }}</span>
      </li>
      <li class="calendar-status-list__item">
        <span class="calendar-status-list__label">Отменено</span>
        <span class="calendar-status-list__value" data-calendar-status-canceled>{{ calendar.status_summary['CANCELED'] }}</span>
      </li>
    </ul>
    <span class="metric-card__meta muted">Часовой пояс: {{ calendar.timezone }}</span>
  </article>
</section>

<section class="surface calendar-surface" data-calendar-root data-calendar-endpoint="/api/dashboard/calendar" data-calendar-initial='{{ calendar | tojson }}'>
  <header class="section-header calendar-header">
    <div>
      <h2 class="section-title">Календарь собеседований</h2>
      <p class="section-hint">Выбирайте дату, чтобы видеть интервью в реальном времени и переходить к карточке кандидата.</p>
    </div>
    <div class="calendar-controls">
      <label class="calendar-date-picker">
        <span class="calendar-date-picker__label">Дата</span>
        <input type="date" value="{{ calendar.selected_date }}" data-calendar-input>
      </label>
      <button type="button" class="btn btn-ghost btn-sm" data-calendar-refresh>Обновить</button>
    </div>
  </header>
  <div class="calendar-board">
    <div class="calendar-days" data-calendar-days>
      {% for day in calendar.days %}
        <button type="button" class="calendar-day{% if day.is_selected %} is-active{% endif %}{% if day.is_today %} is-today{% endif %}" data-calendar-day="{{ day.date }}">
          <span class="calendar-day__weekday">{{ day.weekday }}</span>
          <span class="calendar-day__date">{{ day.label }}</span>
          <span class="calendar-day__count">{{ day.count }}</span>
        </button>
      {% endfor %}
    </div>
    <div class="calendar-events" data-calendar-events>
      {% if calendar.events %}
        {% for event in calendar.events %}
          <article class="calendar-event glass-card" data-calendar-event-id="{{ event.id }}">
            <div class="calendar-event__clock">
              <span class="calendar-event__start">{{ event.start_time }}</span>
              <span class="calendar-event__end">до {{ event.end_time }}</span>
            </div>
            <div class="calendar-event__details">
              <div class="calendar-event__header">
                <h3 class="calendar-event__title">
                  {% if event.candidate.profile_url %}
                    <a href="{{ event.candidate.profile_url }}" class="calendar-event__candidate">{{ event.candidate.name }}</a>
                  {% else %}
                    {{ event.candidate.name }}
                  {% endif %}
                </h3>
                <span class="badge badge--{{ event.status_variant }}">{{ event.status_label }}</span>
              </div>
              <p class="calendar-event__meta">{{ event.recruiter.name or 'Без рекрутёра' }}{% if event.city.name %} · {{ event.city.name }}{% endif %}</p>
              {% if event.candidate.telegram_id %}
                <p class="calendar-event__meta muted">tg: {{ event.candidate.telegram_id }}</p>
              {% endif %}
            </div>
          </article>
        {% endfor %}
      {% else %}
        <p class="calendar-empty">На выбранную дату интервью не запланировано.</p>
      {% endif %}
    </div>
  </div>
  <div class="calendar-feedback" data-calendar-feedback role="status" aria-live="polite"></div>
</section>
{% endblock %}

{% block extra_js %}
  <script type="module" src="/static/js/modules/dashboard-calendar.js"></script>
{% endblock %}
