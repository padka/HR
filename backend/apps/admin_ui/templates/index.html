{% extends "base.html" %}
{% block title %}Дашборд{% endblock %}
{% block content %}
<section class="dashboard-hero">
  <div class="hero__copy">
    <p class="hero__eyebrow">TG Bot · HR Operations</p>
    <h1 class="hero__title">Центр управления рекрутингом</h1>
    <p class="hero__description">Следите за воронкой кандидатов, слотами и продуктивностью команды в режиме реального времени.</p>
    <div class="hero__cta-group">
      <a class="btn btn-primary" href="/candidates">К кандидатам</a>
      <a class="btn btn-secondary" href="/recruiters">Управление рекрутёрами</a>
    </div>
  </div>
  <div class="hero__actions">
    <p class="hero__actions-title">Быстрые действия</p>
    <div class="hero__cta-secondary">
      <a class="btn btn-ghost" href="/slots/new">Создать слот</a>
      <a class="btn btn-ghost" href="/templates/new">Добавить шаблон</a>
      <a class="btn btn-ghost" href="/questions/new">Новый вопрос</a>
    </div>
  </div>
</section>

<section class="dashboard-metrics">
  <article class="metric-card">
    <span class="metric-card__label">Команда рекрутёров</span>
    <span class="metric-card__value">{{ counts.recruiters }}</span>
    <span class="metric-card__meta">Поддерживаемых городов: {{ counts.cities }}</span>
  </article>
  <article class="metric-card">
    <span class="metric-card__label">Слоты интервью</span>
    <span class="metric-card__value">{{ counts.slots_total }}</span>
    <span class="metric-card__meta">Свободно: {{ counts.slots_free }} • Ожидают: {{ counts.slots_pending }} • Бронь: {{ counts.slots_booked }}</span>
  </article>
  <article class="metric-card">
    <span class="metric-card__label">Тест 1 — отказы</span>
    <span class="metric-card__value">{{ counts.test1_rejections_percent }}%</span>
    <span class="metric-card__meta">Отказов: {{ counts.test1_rejections_total }} • Всего попыток: {{ counts.test1_total_seen }}</span>
  </article>
  <article class="metric-card">
    <span class="metric-card__label">Статус бота</span>
    <span class="metric-card__value">
      {{ 'Онлайн' if bot_status.ready else ('Активен' if bot_status.runtime_enabled else 'Отключён') }}
    </span>
    <span class="metric-card__meta">Обновлён: {{ bot_status.updated_at or '—' }}</span>
  </article>
</section>

{% if recent_slots %}
  <section class="surface">
    <header class="section-header">
      <h2 class="section-title">Ближайшие интервью</h2>
      <p class="section-hint">Следующие подтверждённые слоты по часовым поясам кандидатов.</p>
    </header>
    <div class="list-table-wrapper">
      <table class="list-table">
        <thead>
          <tr>
            <th scope="col">Кандидат</th>
            <th scope="col">Рекрутёр</th>
            <th scope="col">Город</th>
            <th scope="col">Дата/время</th>
            <th scope="col">Статус</th>
          </tr>
        </thead>
        <tbody>
        {% for slot in recent_slots %}
          <tr>
            <td>
              <div class="entity">
                <span class="entity__title">{{ slot.candidate.fio }}</span>
                <span class="muted">{{ slot.candidate.telegram_id }}</span>
              </div>
            </td>
            <td>{{ slot.recruiter.name }}</td>
            <td>{{ slot.city or '—' }}</td>
            <td>{{ fmt_local(slot.start_utc, slot.candidate_tz or 'Europe/Moscow') }}</td>
            <td>{{ slot.status }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
{% else %}
  <section class="surface">
    <header class="section-header">
      <h2 class="section-title">Ближайшие интервью</h2>
      <p class="section-hint">Следующие подтверждённые слоты по часовым поясам кандидатов.</p>
    </header>
    <p class="muted">Пока нет запланированных интервью. Добавьте новые слоты или отправьте приглашения кандидатам.</p>
  </section>
{% endif %}

{% if recent_candidates %}
  <section class="surface">
    <header class="section-header">
      <h2 class="section-title">Недавние кандидаты</h2>
      <p class="section-hint">Последние подключившиеся кандидаты и их статус.</p>
    </header>
    <div class="list-table-wrapper">
      <table class="list-table">
        <thead>
          <tr>
            <th scope="col">Кандидат</th>
            <th scope="col">Город</th>
            <th scope="col">Статус</th>
            <th scope="col">Последняя активность</th>
            <th scope="col">Карточка</th>
          </tr>
        </thead>
        <tbody>
        {% for item in recent_candidates %}
          <tr>
            <td>
              <div class="entity">
                <span class="entity__title">{{ item.user.fio }}</span>
                <span class="muted">TG {{ item.user.telegram_id }}</span>
              </div>
            </td>
            <td>{{ item.user.city or '—' }}</td>
            <td>
              {% if item.user.is_active %}
                <span class="badge badge--success">Активен</span>
              {% else %}
                <span class="badge badge--muted">Отключен</span>
              {% endif %}
            </td>
            <td>{{ item.user.last_activity.strftime('%d.%m.%Y %H:%M') if item.user.last_activity else '—' }}</td>
            <td><a class="btn btn-ghost btn-sm" href="/candidates/{{ item.user.id }}">Открыть</a></td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
{% else %}
  <section class="surface">
    <header class="section-header">
      <h2 class="section-title">Недавние кандидаты</h2>
      <p class="section-hint">Последние подключившиеся кандидаты и их статус.</p>
    </header>
    <p class="muted">Пока нет новых кандидатов. Добавьте пользователя вручную или пригласите через бота.</p>
  </section>
{% endif %}
{% endblock %}
