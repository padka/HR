{% extends "base.html" %}
{% from "page_primitives.html" import page_header, kpi_section, stat_cards %}
{% block title %}Дашборд{% endblock %}
{% block content %}
{% set health_state = bot_status.health or 'missing' %}
{% set health_value = 'Здоров' if health_state == 'ok' else ('Замедлен' if health_state in ['degraded', 'warning'] else 'Нет связи') %}
{% set health_tone = 'ok' if health_state == 'ok' else ('warn' if health_state in ['degraded', 'warning'] else 'danger') %}
{% set hero_badges = [
  {
    'tone': 'ok' if bot_status.config_enabled else 'danger',
    'label': 'Интеграция: ' ~ ('Включена' if bot_status.config_enabled else 'Отключена')
  },
  {
    'tone': 'ok' if bot_status.runtime_enabled else 'warn',
    'label': 'Процесс: ' ~ ('Активен' if bot_status.runtime_enabled else 'Пауза')
  },
  {
    'tone': health_tone,
    'label': 'Здоровье: ' ~ health_value
  },
  {
    'tone': 'ok' if bot_status.ready else 'warn',
    'label': 'Готовность: ' ~ ('Готов' if bot_status.ready else 'Ожидает')
  },
  {
    'tone': 'ok' if bot_status.mode == 'real' else 'info',
    'label': 'Режим: ' ~ ('Продакшен' if bot_status.mode == 'real' else 'Тестовый')
  }
] %}
{% set hero_meta = bot_status.updated_at and 'Обновлено: ' ~ (bot_status.updated_at | replace('T', ' ')) %}
<section class="dashboard-hero">
  <div class="hero__copy" role="status" aria-live="polite">
    {% call page_header(
      title='Контур управления рекрутингом',
      eyebrow='TG Bot · HR Operations',
      description='Сводка статуса бота, KPI и календаря собеседований на одном экране.',
      meta=hero_meta,
      badges=hero_badges
    ) %}
      <div class="page-header__actions hero__cta-group">
        <a class="btn btn-primary btn-sm" href="/candidates">К кандидатам</a>
        <a class="btn btn-ghost btn-sm" href="/recruiters">Управление рекрутёрами</a>
      </div>
    {% endcall %}
  </div>
  <aside class="hero__actions panel" aria-label="Быстрые действия">
    <h2 class="hero__actions-title">Быстрые действия</h2>
    <p class="hero__actions-hint muted">Создайте ключевые сущности без смены страницы.</p>
    <ul class="hero__action-list">
      <li><a class="btn btn-ghost btn-sm" href="/slots/new">Создать слот</a></li>
      <li><a class="btn btn-ghost btn-sm" href="/templates/new">Добавить шаблон</a></li>
      <li><a class="btn btn-ghost btn-sm" href="/questions/new">Новый вопрос</a></li>
    </ul>
  </aside>
</section>

{% set weekly_cards = weekly_kpis.current.metrics if weekly_kpis.current and weekly_kpis.current.metrics else [] %}
{% set weekly_label = weekly_kpis.current.label if weekly_kpis.current else '—' %}
{% set weekly_meta = 'Неделя ' ~ weekly_label ~ ' · автообновление раз в минуту' %}
{% call kpi_section(
  'weekly_kpi_title',
  eyebrow='Week-to-date · ' ~ weekly_kpis.timezone,
  title='Ключевые показатели',
  meta=weekly_meta,
  cards=weekly_cards,
  empty_text='Пока нет данных за текущую неделю.',
  placeholder_text='Показатели пока недоступны. Проверьте подключение базы данных или выполните миграции.',
  is_placeholder=weekly_kpis.get('is_placeholder'),
  default_hint='за эту неделю'
) %}
  <a class="btn btn-ghost btn-sm" href="/api/kpis/history" target="_blank" rel="noopener">История KPI</a>
{% endcall %}

{% call stat_cards(class_name='dashboard-metrics') %}
  <article class="stat-card metric-card surface">
    <span class="stat-card__label metric-card__label">Рекрутёры</span>
    <span class="stat-card__value metric-card__value">{{ counts.recruiters }}</span>
    <span class="stat-card__meta metric-card__meta">Активных городов: {{ counts.cities }}</span>
  </article>
  <article class="stat-card metric-card surface">
    <span class="stat-card__label metric-card__label">Слоты</span>
    <span class="stat-card__value metric-card__value">{{ counts.slots_total }}</span>
    <span class="stat-card__meta metric-card__meta">Свободно: {{ counts.slots_free }} • В ожидании: {{ counts.slots_pending }} • Забронировано: {{ counts.slots_booked }}</span>
  </article>
  <article class="stat-card metric-card surface calendar-summary">
    <span class="stat-card__label metric-card__label">Интервью · <span data-calendar-label>{{ calendar.selected_label }}</span></span>
    <span class="stat-card__value metric-card__value" data-calendar-total>{{ calendar.events_total }}</span>
    <span class="stat-card__meta metric-card__meta" data-calendar-meta>{{ calendar.meta }}</span>
    <span class="stat-card__meta metric-card__meta muted" data-calendar-updated>{{ calendar.updated_label }}</span>
  </article>
  <article class="stat-card metric-card surface calendar-status-card">
    <span class="stat-card__label metric-card__label">Статусы интервью</span>
    <ul class="calendar-status-list" data-calendar-status>
      <li class="calendar-status-list__item">
        <span class="calendar-status-list__label">Подтверждено</span>
        <span class="calendar-status-list__value" data-calendar-status-confirmed>{{ calendar.status_summary['CONFIRMED_BY_CANDIDATE'] }}</span>
      </li>
      <li class="calendar-status-list__item">
        <span class="calendar-status-list__label">Назначено</span>
        <span class="calendar-status-list__value" data-calendar-status-booked>{{ calendar.status_summary['BOOKED'] }}</span>
      </li>
      <li class="calendar-status-list__item">
        <span class="calendar-status-list__label">Ожидает подтверждения</span>
        <span class="calendar-status-list__value" data-calendar-status-pending>{{ calendar.status_summary['PENDING'] }}</span>
      </li>
      <li class="calendar-status-list__item">
        <span class="calendar-status-list__label">Отменено</span>
        <span class="calendar-status-list__value" data-calendar-status-canceled>{{ calendar.status_summary['CANCELED'] }}</span>
      </li>
    </ul>
    <span class="stat-card__meta metric-card__meta muted">Часовой пояс: {{ calendar.timezone }}</span>
  </article>
{% endcall %}

<section
  class="calendar-panel panel"
  data-calendar-root
  data-calendar-endpoint="/api/dashboard/calendar"
  data-calendar-initial='{{ calendar | tojson }}'
>
  <header class="calendar-header">
    <div class="calendar-header__text">
      <h2 class="calendar-header__title">Календарь собеседований</h2>
      <p class="calendar-header__hint muted">Живое расписание по выбранной дате и моментальный переход к карточкам.</p>
    </div>
    <div class="calendar-controls">
      <label class="calendar-date-picker">
        <span class="calendar-date-picker__label">Дата</span>
        <span class="calendar-date-picker__field pill">
          <input class="calendar-date-picker__input" type="date" value="{{ calendar.selected_date }}" data-calendar-input>
        </span>
      </label>
      <button type="button" class="btn btn-ghost btn-sm" data-calendar-refresh>Обновить</button>
    </div>
  </header>
  <div class="calendar-board">
    <div class="calendar-days" data-calendar-days>
      {% for day in calendar.days %}
        <button
          type="button"
          class="calendar-day pill focus-ring{% if day.is_selected %} is-active{% endif %}{% if day.is_today %} is-today{% endif %}"
          data-calendar-day="{{ day.date }}"
        >
          <span class="calendar-day__weekday">{{ day.weekday }}</span>
          <span class="calendar-day__date">{{ day.label }}</span>
          <span class="calendar-day__count">{{ day.count }}</span>
        </button>
      {% endfor %}
    </div>
    <div class="calendar-events" data-calendar-events>
      {% if calendar.events %}
        {% for event in calendar.events %}
          <article class="calendar-event surface" data-calendar-event-id="{{ event.id }}">
            <div class="calendar-event__clock">
              <span class="calendar-event__start">{{ event.start_time }}</span>
              <span class="calendar-event__end">до {{ event.end_time }}</span>
            </div>
            <div class="calendar-event__details">
              <div class="calendar-event__header">
                <h3 class="calendar-event__title">
                  {% if event.candidate.profile_url %}
                    <a href="{{ event.candidate.profile_url }}" class="calendar-event__candidate">{{ event.candidate.name }}</a>
                  {% else %}
                    {{ event.candidate.name }}
                  {% endif %}
                </h3>
                <span class="badge badge--{{ event.status_variant }}">{{ event.status_label }}</span>
              </div>
              <p class="calendar-event__meta">{{ event.recruiter.name or 'Без рекрутёра' }}{% if event.city.name %} · {{ event.city.name }}{% endif %}</p>
              {% if event.candidate.telegram_id %}
                <p class="calendar-event__meta muted">tg: {{ event.candidate.telegram_id }}</p>
              {% endif %}
            </div>
          </article>
        {% endfor %}
      {% else %}
        <p class="calendar-empty muted">На выбранную дату интервью не запланировано.</p>
      {% endif %}
    </div>
  </div>
  <div class="calendar-feedback" data-calendar-feedback role="status" aria-live="polite"></div>
</section>

<aside id="kpi_drawer" class="kpi-drawer" hidden aria-modal="true" role="dialog" aria-labelledby="kpi_drawer_title">
  <div class="kpi-drawer__scrim" data-close="true"></div>
  <div class="kpi-drawer__panel" role="document">
    <header class="kpi-drawer__header">
      <div>
        <p class="kpi-drawer__eyebrow">Неделя {{ weekly_kpis.current.label }}</p>
        <h3 id="kpi_drawer_title" class="kpi-drawer__title">Показатель</h3>
        <p class="kpi-drawer__subtitle">{{ weekly_kpis.timezone }}</p>
      </div>
      <div class="kpi-drawer__actions">
        <button type="button" class="btn btn-ghost" data-export="true">Export CSV</button>
        <button type="button" class="btn btn-icon" data-close="true" aria-label="Закрыть слайдовер">✕</button>
      </div>
    </header>
    <div class="kpi-drawer__content">
      <p class="kpi-drawer__trend" data-role="trend"></p>
      <div class="list-table-wrapper" data-role="table-wrapper">
        <table class="list-table kpi-table">
          <thead>
            <tr>
              <th scope="col">Кандидат</th>
              <th scope="col">Рекрутёр</th>
              <th scope="col">Дата события</th>
              <th scope="col">Город / часовой пояс</th>
            </tr>
          </thead>
          <tbody data-role="table-body"></tbody>
        </table>
      </div>
      <p class="kpi-drawer__empty" data-role="empty" hidden>Для этой метрики пока нет событий на текущей неделе.</p>
    </div>
  </div>
</aside>

<script type="application/json" id="weekly_kpi_data">{{ weekly_kpis|tojson }}</script>

{% endblock %}

{% block extra_js %}
  {{ super() }}
  <script>
    (function () {
      const dataEl = document.getElementById('weekly_kpi_data');
      if (!dataEl) return;
      let parsed;
      try {
        parsed = JSON.parse(dataEl.textContent || '{}');
      } catch (err) {
        console.error('weekly-kpi.parse-error', err);
        parsed = {};
      }
      const drawer = document.getElementById('kpi_drawer');
      if (!drawer) return;
      const panel = drawer.querySelector('.kpi-drawer__panel');
      const closeButtons = drawer.querySelectorAll('[data-close]');
      const exportButton = drawer.querySelector('[data-export]');
      const tableBody = drawer.querySelector('[data-role="table-body"]');
      const tableWrapper = drawer.querySelector('[data-role="table-wrapper"]');
      const emptyState = drawer.querySelector('[data-role="empty"]');
      const trendLabel = drawer.querySelector('[data-role="trend"]');
      const titleEl = drawer.querySelector('#kpi_drawer_title');
      const focusableSelector = 'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])';
      let lastActive = null;

      function findMetric(key) {
        const metrics = (parsed.current && parsed.current.metrics) || [];
        return metrics.find((item) => item.key === key);
      }

      function formatRow(detail) {
        const row = document.createElement('tr');
        const cells = [
          detail.candidate || '—',
          detail.recruiter || '—',
          detail.event_label || detail.event_at || '—',
          detail.city ? `${detail.city} • ${detail.timezone || ''}`.trim() : (detail.timezone || '—')
        ];
        cells.forEach((value, index) => {
          const cell = document.createElement('td');
          cell.textContent = value;
          if (index === 2) {
            cell.dataset.sortValue = detail.event_at || '';
          }
          row.appendChild(cell);
        });
        return row;
      }

      function exportCsv(metric) {
        if (!metric) return;
        const rows = metric.details || [];
        const header = ['candidate', 'recruiter', 'event_at', 'event_label', 'city', 'timezone'];
        const lines = [header.join(',')];
        rows.forEach((detail) => {
          const values = header.map((key) => {
            const raw = detail[key];
            const safe = (raw == null ? '' : String(raw)).replace(/"/g, '""');
            return `"${safe}"`;
          });
          lines.push(values.join(','));
        });
        const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        const slug = metric.key.replace(/[^a-z0-9_-]+/gi, '_');
        link.href = url;
        link.download = `weekly_${slug}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }

      function closeDrawer() {
        drawer.hidden = true;
        drawer.removeAttribute('data-open');
        drawer.removeEventListener('keydown', handleKeyDown);
        if (lastActive && typeof lastActive.focus === 'function') {
          lastActive.focus();
        }
        lastActive = null;
      }

      function handleKeyDown(event) {
        if (event.key === 'Escape') {
          event.preventDefault();
          closeDrawer();
          return;
        }
        if (event.key === 'Tab') {
          const focusables = panel.querySelectorAll(focusableSelector);
          if (!focusables.length) return;
          const first = focusables[0];
          const last = focusables[focusables.length - 1];
          if (event.shiftKey && document.activeElement === first) {
            event.preventDefault();
            last.focus();
          } else if (!event.shiftKey && document.activeElement === last) {
            event.preventDefault();
            first.focus();
          }
        }
      }

      function renderMetric(metric) {
        if (!metric || !tableBody || !titleEl) return;
        tableBody.innerHTML = '';
        titleEl.textContent = metric.label || 'Показатель';
        if (trendLabel) {
          trendLabel.textContent = metric.trend ? metric.trend.label : '';
        }
        const entries = metric.details || [];
        if (!entries.length) {
          if (tableWrapper) tableWrapper.setAttribute('hidden', 'true');
          if (emptyState) emptyState.hidden = false;
        } else {
          entries.forEach((detail) => tableBody.appendChild(formatRow(detail)));
          if (tableWrapper) tableWrapper.removeAttribute('hidden');
          if (emptyState) emptyState.hidden = true;
        }
        if (exportButton) {
          exportButton.disabled = entries.length === 0;
          exportButton.onclick = () => exportCsv(metric);
        }
      }

      function openDrawer(metricKey, trigger) {
        const metric = findMetric(metricKey);
        renderMetric(metric);
        drawer.hidden = false;
        drawer.setAttribute('data-open', 'true');
        lastActive = trigger || document.activeElement;
        drawer.addEventListener('keydown', handleKeyDown);
        const firstFocus = panel.querySelector(focusableSelector);
        if (firstFocus && typeof firstFocus.focus === 'function') {
          firstFocus.focus();
        }
      }

      closeButtons.forEach((btn) => {
        btn.addEventListener('click', () => closeDrawer());
      });

      document.querySelectorAll('.kpi-card').forEach((btn) => {
        btn.addEventListener('click', () => {
          const key = btn.getAttribute('data-metric');
          if (key) {
            openDrawer(key, btn);
          }
        });
      });
    })();
  </script>
  <script type="module" src="/static/js/modules/dashboard-calendar.js"></script>
{% endblock %}
