{% extends "base.html" %}
{% from "partials/list_toolbar.html" import list_toolbar %}
{% block title %}Слоты{% endblock %}
{% block content %}
<section class="page">
  <header class="page-header">
    <div>
      <h1 class="page-title">Слоты</h1>
      <p class="page-description">
        Управляйте слотами интервью, фильтруйте по рекрутёрам и статусу и следите за балансом загрузки.
      </p>
    </div>
    <div class="page-actions">
      <a class="btn btn-primary" href="/slots/new">+ Новый слот</a>
    </div>
  </header>

  {% call list_toolbar(
    form_id="flt",
    form_action="/slots",
    method="get",
    sticky=True,
    mass_actions=[{'label': 'Показать', 'type': 'button', 'variant': 'primary', 'button_type': 'submit'}],
    chips=[
      {'label': 'FREE', 'value': status_counts.FREE, 'tone': 'success', 'value_id': 'cnt-free'},
      {'label': 'PENDING', 'value': status_counts.PENDING, 'tone': 'warning', 'value_id': 'cnt-pending'},
      {'label': 'BOOKED', 'value': status_counts.BOOKED, 'tone': 'info', 'value_id': 'cnt-booked'},
      {'label': 'Всего', 'value': status_counts.total, 'value_id': 'cnt-total'}
    ]
  ) %}
    <div class="form-field">
      <label for="recruiter_id">Рекрутёр</label>
      <select id="recruiter_id" name="recruiter_id">
        <option value="">— все —</option>
        {% for r in recruiter_options %}
          <option value="{{ r.id }}" {% if filter_recruiter_id and filter_recruiter_id == r.id %}selected{% endif %}>
            {{ r.name }} ({{ r.tz or "Europe/Moscow" }})
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="form-field form-field--narrow">
      <label for="status">Статус</label>
      <select id="status" name="status">
        <option value="">— все —</option>
        <option value="FREE" {% if filter_status == 'FREE' %}selected{% endif %}>FREE</option>
        <option value="PENDING" {% if filter_status == 'PENDING' %}selected{% endif %}>PENDING</option>
        <option value="BOOKED" {% if filter_status == 'BOOKED' %}selected{% endif %}>BOOKED</option>
      </select>
    </div>

    <div class="form-field form-field--narrow">
      <label for="per_page">На странице</label>
      <select id="per_page" name="per_page">
        {% for n in [10, 20, 50, 100] %}
          <option value="{{ n }}" {% if per_page == n %}selected{% endif %}>{{ n }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="field-stack">
      <label class="form-toggle" for="toggle_cand_tz">
        <input id="toggle_cand_tz" type="checkbox"> Время кандидата
      </label>
      <label class="form-toggle" for="only_future">
        <input id="only_future" type="checkbox"> Только будущие
      </label>
    </div>
  {% endcall %}

  {% if not slots %}
    <div class="card glass grain">
      <h3 class="section-title">Пусто</h3>
      <p class="page-description">Слотов по выбранным условиям нет.</p>
    </div>
  {% else %}
    <div class="list-table-wrapper">
      <table id="slots-table" class="list-table list-table--responsive">
        <thead>
          <tr>
            <th class="sortable" data-sort="id">ID <span class="dir"></span></th>
            <th class="sortable" data-sort="rec">Рекрутёр <span class="dir"></span></th>
            <th class="sortable" data-sort="utc">UTC <span class="dir"></span></th>
            <th>Локальное (TZ рекрутёра)</th>
            <th class="col-cand-tz is-optional">Локальное (TZ кандидата)</th>
            <th class="sortable" data-sort="status">Статус <span class="dir"></span></th>
            <th class="sortable" data-sort="cand">Кандидат <span class="dir"></span></th>
            <th class="is-optional">Детали</th>
          </tr>
        </thead>
        <tbody>
        {% for s in slots %}
          {% set st = norm_status(s.status) %}
          {% set row_cls = 'row-free' if st=='FREE' else ('row-pending' if st=='PENDING' else ('row-booked' if st=='BOOKED' else '')) %}
          <tr class="{{ row_cls }}" data-st="{{ st or '' }}" data-id="{{ s.id }}" data-utc="{{ s.start_utc.isoformat() }}" data-rec="{{ s.recruiter.name if s.recruiter else '' }}" data-cand="{{ s.candidate_fio or '' }}" data-sto="{{ 0 if st=='FREE' else (1 if st=='PENDING' else (2 if st=='BOOKED' else 9)) }}">
            <td data-label="ID">
              <span class="copyable" data-copy="{{ s.id }}" title="Скопировать ID">{{ s.id }}</span>
            </td>
            <td data-label="Рекрутёр">
              <div>{{ s.recruiter.name if s.recruiter else "—" }}</div>
              <div class="badge">{{ (s.recruiter.tz if s.recruiter and s.recruiter.tz else "Europe/Moscow") }}</div>
            </td>
            <td data-label="UTC">
              <span class="copyable" data-copy="{{ fmt_utc(s.start_utc) }}" title="Скопировать UTC-время" data-utc-iso="{{ s.start_utc.isoformat() }}">
                {{ fmt_utc(s.start_utc) }}
              </span>
              <div class="muted" data-rel></div>
            </td>
            <td data-label="Локальное (рекрутёр)">
              {% set tz_rec = (s.recruiter.tz if s.recruiter and s.recruiter.tz else "Europe/Moscow") %}
              <span class="copyable" data-copy="{{ fmt_local(s.start_utc, tz_rec) }}" title="Скопировать локальное время рекрутёра">
                {{ fmt_local(s.start_utc, tz_rec) }}
              </span>
            </td>
            <td class="col-cand-tz is-optional" data-label="Кандидат TZ">
              {% if s.candidate_tz %}
                <div class="badge">{{ s.candidate_tz }}</div>
                <span class="copyable" data-copy="{{ fmt_local(s.start_utc, s.candidate_tz) }}" title="Скопировать локальное время кандидата">
                  {{ fmt_local(s.start_utc, s.candidate_tz) }}
                </span>
              {% else %}
                <span class="badge">—</span>
              {% endif %}
            </td>
            <td data-label="Статус">
              {% if st == "FREE" %}
                <span class="status-badge" data-tone="success">FREE</span>
              {% elif st == "PENDING" %}
                <span class="status-badge" data-tone="warning">PENDING</span>
              {% elif st == "BOOKED" %}
                <span class="status-badge" data-tone="info">BOOKED</span>
              {% else %}
                <span class="badge">{{ st or "—" }}</span>
              {% endif %}
            </td>
            <td data-label="Кандидат">
              {% if s.candidate_fio %}
                <div>{{ s.candidate_fio }}</div>
                <div class="badge copyable" data-copy="{{ s.candidate_tg_id or '' }}" title="Скопировать tg_id">tg_id: {{ s.candidate_tg_id or "—" }}</div>
              {% else %}
                <span class="badge">—</span>
              {% endif %}
            </td>
            <td class="list-table__details" data-label="">
              <details>
                <summary>Подробнее</summary>
                <div class="meta-list">
                  <span>UTC: {{ fmt_utc(s.start_utc) }}</span>
                  <span>Рекрутёр: {{ s.recruiter.name if s.recruiter else '—' }}</span>
                  {% if s.candidate_fio %}<span>Кандидат: {{ s.candidate_fio }}</span>{% endif %}
                  {% if s.candidate_tz %}<span>TZ кандидата: {{ s.candidate_tz }}</span>{% endif %}
                </div>
              </details>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="pagination">
      {% set qrecr = '&recruiter_id=' ~ filter_recruiter_id if filter_recruiter_id else '' %}
      {% set qstat = '&status=' ~ filter_status if filter_status else '' %}
      {% set qpp = '&per_page=' ~ per_page if per_page else '' %}

      <span class="badge">Стр. {{ page }} из {{ pages_total }}</span>

      {% if page > 1 %}
        <a class="btn btn-ghost" href="/slots?page=1{{ qrecr }}{{ qstat }}{{ qpp }}">« Первая</a>
        <a class="btn btn-ghost" href="/slots?page={{ page-1 }}{{ qrecr }}{{ qstat }}{{ qpp }}">‹ Назад</a>
      {% else %}
        <span class="btn btn-ghost" aria-disabled="true">« Первая</span>
        <span class="btn btn-ghost" aria-disabled="true">‹ Назад</span>
      {% endif %}

      {% if page < pages_total %}
        <a class="btn btn-ghost" href="/slots?page={{ page+1 }}{{ qrecr }}{{ qstat }}{{ qpp }}">Вперёд ›</a>
        <a class="btn btn-ghost" href="/slots?page={{ pages_total }}{{ qrecr }}{{ qstat }}{{ qpp }}">Последняя »</a>
      {% else %}
        <span class="btn btn-ghost" aria-disabled="true">Вперёд ›</span>
        <span class="btn btn-ghost" aria-disabled="true">Последняя »</span>
      {% endif %}
    </div>
  {% endif %}
</section>

{% raw %}
<script>
(function(){
  const $ = function(s, r){ return (r||document).querySelector(s); };
  const $$= function(s, r){ return Array.from((r||document).querySelectorAll(s)); };

  var rows = $$('#slots-table tbody tr');
  var onlyFuture = $('#only_future');
  var candTzToggle = $('#toggle_cand_tz');

  // Copy helper
  $$('.copyable[data-copy]').forEach(function(el){
    el.addEventListener('click', function(){
      var val = el.getAttribute('data-copy') || '';
      navigator.clipboard.writeText(val).then(function(){
        var prev = el.textContent;
        el.textContent = 'Скопировано';
        setTimeout(function(){ el.textContent = prev; }, 900);
      }).catch(function(){ alert('Не удалось скопировать'); });
    });
  });

  function isFuture(tr){
    var iso = tr.getAttribute('data-utc');
    if(!iso) return true;
    var t = Date.parse(iso);
    return isFinite(t) ? t >= Date.now() : true;
  }

  function refreshCounts(){
    var fut = !!(onlyFuture && onlyFuture.checked);
    var free=0, pend=0, book=0, total=0;
    rows.forEach(function(tr){
      var visible = !fut || isFuture(tr);
      tr.style.display = visible ? '' : 'none';
      if(visible){
        total++;
        var st = tr.getAttribute('data-st');
        if(st==='FREE') free++; else if(st==='PENDING') pend++; else if(st==='BOOKED') book++;
      }
    });
    var totalEl = $('#cnt-total');
    if(totalEl) totalEl.textContent = total;
    var freeEl = $('#cnt-free');
    if(freeEl) freeEl.textContent = free;
    var pendEl = $('#cnt-pending');
    if(pendEl) pendEl.textContent = pend;
    var bookEl = $('#cnt-booked');
    if(bookEl) bookEl.textContent = book;
  }

  if(onlyFuture){
    onlyFuture.addEventListener('change', function(){
      refreshCounts();
    });
  }

  function setCandCol(show){
    $$('.col-cand-tz').forEach(function(col){
      col.classList.toggle('hidden-col', !show);
    });
  }
  if(candTzToggle){
    candTzToggle.addEventListener('change', function(){
      setCandCol(candTzToggle.checked);
    });
    setCandCol(candTzToggle.checked);
  }

  // Relative time now + update every minute
  function rel(ts){
    var diff = Math.round((ts - Date.now())/60000);
    var abs = Math.abs(diff);
    if(abs<60) return (diff>=0? 'через ':'') + abs + ' мин';
    var h = Math.round(abs/60);
    return (diff>=0? 'через ':'') + h + ' ч';
  }
  function updateRel(){
    $$('#slots-table [data-utc-iso]').forEach(function(el){
      var iso = el.getAttribute('data-utc-iso');
      var d = iso ? new Date(iso) : null;
      var holder = el.parentElement.querySelector('[data-rel]');
      if(d && holder){ holder.textContent = rel(d.getTime()); }
    });
  }
  updateRel();
  setInterval(updateRel, 60000);

  // Column sorting (client-side, visible rows)
  var sortKey = 'utc';
  var sortDir = 'asc';

  function applySortIndicator(){
    $$('#slots-table thead th.sortable').forEach(function(th){
      th.classList.remove('active');
      var d = th.querySelector('.dir');
      if(d) d.textContent='';
    });
    var th = $('#slots-table thead th.sortable[data-sort="'+sortKey+'"]');
    if (th){
      th.classList.add('active');
      var d = th.querySelector('.dir');
      if(d) d.textContent = sortDir==='asc' ? '▲' : '▼';
    }
  }

  function cmp(a,b){ return a<b?-1:a>b?1:0; }

  function sortRows(){
    var tbody = $('#slots-table tbody');
    var arr = rows.slice();
    arr.sort(function(tr1, tr2){
      var v1, v2;
      if (sortKey==='id'){ v1 = parseInt(tr1.getAttribute('data-id')||'0',10); v2 = parseInt(tr2.getAttribute('data-id')||'0',10); }
      else if (sortKey==='utc'){ v1 = Date.parse(tr1.getAttribute('data-utc')||''); v2 = Date.parse(tr2.getAttribute('data-utc')||''); }
      else if (sortKey==='rec'){ v1 = (tr1.getAttribute('data-rec')||'').toLowerCase(); v2 = (tr2.getAttribute('data-rec')||'').toLowerCase(); }
      else if (sortKey==='cand'){ v1 = (tr1.getAttribute('data-cand')||'').toLowerCase(); v2 = (tr2.getAttribute('data-cand')||'').toLowerCase(); }
      else if (sortKey==='status'){ v1 = parseInt(tr1.getAttribute('data-sto')||'9',10); v2 = parseInt(tr2.getAttribute('data-sto')||'9',10); }
      else { v1 = 0; v2 = 0; }
      var r = cmp(v1,v2);
      return sortDir==='asc' ? r : -r;
    });
    arr.forEach(function(tr){ tbody.appendChild(tr); });
  }

  $$('#slots-table thead th.sortable').forEach(function(th){
    th.addEventListener('click', function(){
      var key = th.getAttribute('data-sort');
      if (sortKey===key){ sortDir = (sortDir==='asc') ? 'desc' : 'asc'; }
      else { sortKey = key; sortDir = 'asc'; }
      applySortIndicator(); sortRows();
      refreshCounts();
    });
  });

  document.addEventListener('keydown', function(e){
    if(e.key==='t' && candTzToggle){ candTzToggle.checked = !candTzToggle.checked; candTzToggle.dispatchEvent(new Event('change')); }
    if(e.key==='f' && onlyFuture){ onlyFuture.checked = !onlyFuture.checked; onlyFuture.dispatchEvent(new Event('change')); }
  });

  applySortIndicator();
  sortRows();
  refreshCounts();
})();
</script>
{% endraw %}

{% endblock %}
