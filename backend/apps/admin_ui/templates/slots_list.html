{% extends "base.html" %}
{% from "partials/list_toolbar.html" import list_toolbar %}
{% block title %}–°–ª–æ—Ç—ã{% endblock %}
{% block content %}
{% set has_slots = slots|length > 0 %}
{% set summary_query_parts = [] %}
{% if per_page %}
  {% set _ = summary_query_parts.append('per_page=' ~ per_page) %}
{% endif %}
{% if filter_recruiter_id %}
  {% set _ = summary_query_parts.append('recruiter_id=' ~ filter_recruiter_id) %}
{% endif %}
{% if filter_city %}
  {% set _ = summary_query_parts.append('city=' ~ filter_city) %}
{% endif %}
{% if filter_date %}
  {% set _ = summary_query_parts.append('date=' ~ filter_date) %}
{% endif %}
{% if search_query %}
  {% set _ = summary_query_parts.append('q=' ~ search_query) %}
{% endif %}
{% set summary_tail = '&'.join(summary_query_parts) %}
<section class="page page--slots" data-page="slots" aria-labelledby="slots-title">
  <header class="page-header">
    <div>
      <h1 id="slots-title" class="page-title">–°–ª–æ—Ç—ã</h1>
    </div>
    <div class="page-actions">
      <a class="liquid-glass-btn liquid-glass-btn--primary" href="/slots/new">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        –ù–æ–≤—ã–π —Å–ª–æ—Ç
      </a>
      <div class="dropdown-menu-wrapper">
        <button type="button" class="liquid-glass-btn liquid-glass-btn--secondary" id="more_actions_btn" aria-expanded="false" aria-haspopup="true">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <circle cx="12" cy="12" r="1"></circle>
            <circle cx="19" cy="12" r="1"></circle>
            <circle cx="5" cy="12" r="1"></circle>
          </svg>
        </button>
        <div class="dropdown-menu" id="more_actions_menu" hidden>
          <button type="button" class="dropdown-menu__item" id="delete_selected_slots">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
          </button>
          <button type="button" class="dropdown-menu__item" id="export_slots">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M12 5v14"></path>
              <polyline points="19 12 12 19 5 12"></polyline>
              <rect x="5" y="4" width="14" height="4" rx="1"></rect>
            </svg>
            –≠–∫—Å–ø–æ—Ä—Ç CSV
          </button>
          <button type="button" class="dropdown-menu__item dropdown-menu__item--danger" id="delete_all_slots">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–ª–æ—Ç—ã
          </button>
        </div>
      </div>
    </div>
  </header>

  <section class="card glass grain" style="margin-bottom:16px;">
    <form class="slot-generator" method="post" action="/slots/generate-default">
      {{ csrf_input(request) }}
      <div class="slot-generator__row">
        <label>
          <span>–†–µ–∫—Ä—É—Ç—ë—Ä</span>
          <select name="recruiter_id" required>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
            {% for rec in recruiter_options %}
              <option value="{{ rec.id }}">{{ rec.name }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          <span>–î–∞—Ç–∞</span>
          <input type="date" name="date" value="{{ filter_date or '' }}" required>
        </label>
        <label>
          <span>–ì–æ—Ä–æ–¥ —Å–ª–æ—Ç–∞ (–æ–ø—Ü.)</span>
          <select name="city_id">
            <option value="">–ê–≤—Ç–æ</option>
            {% for city in city_choices %}
              <option value="{{ city.id }}">{{ city.name }}</option>
            {% endfor %}
          </select>
        </label>
        <div class="slot-generator__actions">
          <p class="slot-generator__hint">–°–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 24 —Å–ª–æ—Ç–∞: 09:00‚Äì12:00, 13:00‚Äì18:00, —à–∞–≥ 20 –º–∏–Ω—É—Ç, –æ–±–µ–¥ 12:00‚Äì13:00.</p>
          <button class="btn btn-primary" type="submit">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –¥–µ–Ω—å</button>
        </div>
      </div>
    </form>
  </section>

  <style>
    .dropdown-menu-wrapper { position: relative; }
    .dropdown-menu {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      min-width: 220px;
      padding: 8px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(15, 23, 42, 0.94);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      z-index: 100;
      animation: dropdownFadeIn 0.2s ease;
    }
    .dropdown-menu[hidden] { display: none; }
    .dropdown-menu__item {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border: none;
      border-radius: 10px;
      background: transparent;
      color: var(--fg);
      font-size: 14px;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .dropdown-menu__item:hover { background: rgba(255, 255, 255, 0.08); }
    .dropdown-menu__item--danger { color: #ef4444; }
    .dropdown-menu__item--danger:hover { background: rgba(239, 68, 68, 0.15); }
    @keyframes dropdownFadeIn {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .slot-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    .slot-chip {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.03);
      color: var(--fg);
      text-decoration: none;
      transition: all 0.2s ease;
      min-width: 160px;
    }
    .slot-chip__value { font-size: 20px; font-weight: 800; line-height: 1; }
    .slot-chip__label { font-size: 12px; color: var(--muted); letter-spacing: 0.04em; }
    .slot-chip__icon { font-size: 18px; }
    .slot-chip--active {
      border-color: var(--accent);
      background: rgba(105, 183, 255, 0.15);
      box-shadow: 0 12px 30px rgba(105, 183, 255, 0.25);
    }
    .slot-generator {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .slot-generator__row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      align-items: end;
    }
    .slot-generator label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
      color: var(--muted);
    }
    .slot-generator input,
    .slot-generator select {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.04);
      color: var(--fg);
    }
    .slot-generator__actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .slot-generator__hint {
      margin: 0;
      color: var(--muted);
      font-size: 12px;
    }

    .status-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 12px 0 4px;
    }
    .status-tab {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.04);
      color: var(--fg);
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 600;
      letter-spacing: 0.01em;
    }
    .status-tab__count {
      padding: 4px 8px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.08);
      font-size: 12px;
    }
    .status-tab.is-active {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(105, 183, 255, 0.18), rgba(105, 183, 255, 0.08));
      box-shadow: 0 10px 30px rgba(105, 183, 255, 0.25);
    }


    .slot-filters {
      margin: 14px 0 8px;
      padding: 16px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .slot-filters__row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    .slot-filters__group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 180px;
    }
    .slot-filters__group--stretch { flex: 1; min-width: 260px; }
    .slot-filters__group select,
    .slot-filters__group input[type="date"],
    .slot-filters__group input[type="search"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(10, 15, 25, 0.75);
      color: var(--fg);
      font-size: 14px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .slot-filters__group select:focus,
    .slot-filters__group input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(105, 183, 255, 0.2);
    }
    .slot-filters__label {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }
    .slot-filters__actions {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-left: auto;
    }

    .search-field { position: relative; display: flex; align-items: center; }
    .search-field__icon {
      position: absolute;
      left: 12px;
      color: rgba(255, 255, 255, 0.55);
      pointer-events: none;
    }
    .search-field__input { padding-left: 38px !important; }
    .search-field__counter {
      position: absolute;
      right: 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
      background: rgba(255, 255, 255, 0.06);
      padding: 6px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    .search-field__spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }

    .chip-group { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip {
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(255, 255, 255, 0.05);
      color: var(--fg);
      padding: 8px 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
      font-weight: 600;
      letter-spacing: 0.02em;
    }
    .chip.is-active {
      border-color: var(--accent);
      background: rgba(105, 183, 255, 0.16);
      box-shadow: 0 8px 24px rgba(105, 183, 255, 0.25);
    }

    .slot-table-region { margin-top: 6px; }
    .list-table-wrapper {
      max-height: 72vh;
      overflow-x: hidden;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: 0 16px 50px rgba(0, 0, 0, 0.28);
    }
    .slot-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: auto;
    }
    .slot-table thead { display: none; }
    .slot-table tbody { display: flex; flex-direction: column; gap: 12px; }
    .slot-table th,
    .slot-table td {
      padding: 0;
      border: none;
    }
    .slot-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px 14px;
      padding: 14px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.02);
    }
    .col-select { align-self: flex-start; }
    .col-actions { display: flex; justify-content: flex-end; gap: 6px; }

    .slot-row {
      transition: all 0.2s ease;
      background: rgba(255, 255, 255, 0.01);
    }
    .slot-row:hover { background: rgba(255, 255, 255, 0.05); }
    .slot-row.is-selected { box-shadow: inset 0 0 0 1px rgba(105, 183, 255, 0.5); background: rgba(105, 183, 255, 0.07); }
    .slot-row.is-expanded { box-shadow: inset 0 0 0 1px rgba(105, 183, 255, 0.4); }

    .slot-time { display: flex; flex-direction: column; gap: 6px; }
    .slot-time__primary { font-size: 16px; font-weight: 800; letter-spacing: 0.02em; }
    .slot-time__meta { display: flex; gap: 8px; flex-wrap: wrap; color: rgba(255, 255, 255, 0.7); }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.06);
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
    }
    .pill--ghost { background: rgba(255, 255, 255, 0.08); }
    .pill--accent { background: rgba(105, 183, 255, 0.14); color: rgba(255, 255, 255, 0.95); }

    .slot-cell-primary {
      font-weight: 700;
      color: rgba(255, 255, 255, 0.95);
      display: block;
      margin-bottom: 4px;
      white-space: normal;
      line-height: 1.2;
    }
    .slot-cell-meta { color: rgba(255, 255, 255, 0.7); font-size: 12px; line-height: 1.3; }

    .action-group {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .icon-btn {
      height: 32px;
      width: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.04);
      color: var(--fg);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .icon-btn:hover { border-color: var(--accent); box-shadow: 0 6px 18px rgba(105, 183, 255, 0.28); }
    .icon-btn[disabled] { opacity: 0.4; cursor: not-allowed; }
    .icon-btn--danger {
      border-color: rgba(239, 68, 68, 0.5);
      background: rgba(239, 68, 68, 0.12);
      color: #fecaca;
    }
    .icon-btn--danger,
    .icon-btn[data-action="reject-booking"] {
      border-color: rgba(239, 68, 68, 0.55);
      background: rgba(239, 68, 68, 0.14);
      color: #fecaca;
    }
    .icon-btn--danger:hover {
      border-color: rgba(239, 68, 68, 0.8);
      box-shadow: 0 6px 18px rgba(239, 68, 68, 0.3);
    }

    .slot-row-details { background: rgba(255, 255, 255, 0.02); }
    .slot-row-details[hidden] { display: none; }
    .slot-details {
      padding: 14px 16px;
      border-radius: 14px;
      background: rgba(10, 12, 22, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    .slot-details__grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      color: rgba(255, 255, 255, 0.85);
    }
    .slot-details__grid span { color: rgba(255, 255, 255, 0.65); font-size: 12px; }
    .slot-details__actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }

    .table-state {
      border-radius: 16px;
      padding: 20px;
      border: 1px dashed rgba(255, 255, 255, 0.14);
      background: rgba(10, 12, 22, 0.9);
      text-align: center;
      color: rgba(255, 255, 255, 0.85);
      margin-bottom: 10px;
    }
    .table-state[hidden] { display: none; }
    .table-state--error { border-color: #ef4444; color: #fecaca; }
    .skeleton-row {
      display: grid;
      grid-template-columns: 42px 1.2fr 1fr 1fr 0.7fr 0.7fr;
      gap: 10px;
      margin-bottom: 12px;
    }
    @media (max-width: 1360px) {
      .skeleton-row { grid-template-columns: 42px 1.2fr 1fr 0.9fr 0.7fr; }
    }
    .skeleton-line {
      height: 14px;
      border-radius: 10px;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.05));
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    .slot-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap: 12px; margin-top: 12px; }
    .slot-card {
      padding: 16px;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: linear-gradient(145deg, rgba(20, 24, 38, 0.95), rgba(15, 18, 30, 0.92));
      box-shadow: 0 14px 36px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .slot-card__header { display: flex; justify-content: space-between; gap: 10px; align-items: center; }
    .slot-card__title { font-size: 17px; font-weight: 800; letter-spacing: 0.01em; }
    .slot-card__status { display: inline-flex; align-items: center; gap: 6px; }
    .slot-card__meta { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px,1fr)); gap: 10px; color: rgba(255,255,255,0.8); font-size: 13px; }
    .slot-card__meta span { color: rgba(255,255,255,0.6); font-size: 12px; display: block; }
    .slot-card__footer { display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-end; }
    .profile-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 10px; background: rgba(255, 255, 255, 0.08); font-size: 12px; }

    .calendar-view { margin-top: 12px; display: flex; flex-direction: column; gap: 12px; }
    .calendar-day { border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; overflow: hidden; background: rgba(10,12,22,0.9); box-shadow: 0 10px 28px rgba(0,0,0,0.25); }
    .calendar-day__header { padding: 10px 14px; background: rgba(255,255,255,0.04); font-weight: 700; letter-spacing: 0.04em; display: flex; justify-content: space-between; color: rgba(255,255,255,0.9); }
    .calendar-day__list { display: flex; flex-direction: column; }
    .calendar-item { padding: 12px 14px; display: grid; grid-template-columns: 120px 1fr 1fr 160px; gap: 10px; align-items: center; border-top: 1px solid rgba(255,255,255,0.05); }
    .calendar-item:first-child { border-top: none; }
    .calendar-item__time { font-weight: 800; letter-spacing: 0.01em; }
    .calendar-item__meta { display: flex; flex-direction: column; gap: 2px; color: rgba(255,255,255,0.75); }
    .calendar-item__actions { display: flex; justify-content: flex-end; gap: 6px; flex-wrap: wrap; }
    @media (max-width: 1100px) {
      .calendar-item { grid-template-columns: 1fr; align-items: flex-start; }
      .calendar-item__actions { justify-content: flex-start; }
    }
  </style>

  {% if flash %}
    {% set tone = {'success': 'success', 'error': 'danger', 'info': 'info'}.get(flash.status, 'info') %}
    <div class="surface glass grain alert" data-tone="{{ tone }}" role="alert">
      <p class="page-description">{{ flash.message }}</p>
    </div>
  {% endif %}

  
  {% set status_cards = [
    {'key': None, 'label': '–í—Å–µ —Å–ª–æ—Ç—ã', 'icon': 'üìä', 'count': status_counts.total, 'id': 'cnt-total'},
    {'key': 'FREE', 'label': '–°–≤–æ–±–æ–¥–Ω—ã–µ', 'icon': 'üü¢', 'count': status_counts.FREE, 'id': 'cnt-free'},
    {'key': 'PENDING', 'label': '–û–∂–∏–¥–∞—é—Ç', 'icon': '‚è≥', 'count': status_counts.PENDING, 'id': 'cnt-pending'},
    {'key': 'BOOKED', 'label': '–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω—ã', 'icon': 'üìÖ', 'count': status_counts.BOOKED, 'id': 'cnt-booked'},
    {'key': 'CONFIRMED_BY_CANDIDATE', 'label': '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã', 'icon': '‚úÖ', 'count': status_counts.CONFIRMED_BY_CANDIDATE, 'id': 'cnt-confirmed'},
  ] %}

  <div class="status-tabs" role="tablist" aria-label="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É">
    {% for tab in status_cards %}
      {% set is_active = filter_status == tab.key or (not filter_status and not tab.key) %}
      <button type="button"
              class="status-tab{% if is_active %} is-active{% endif %}"
              data-status="{{ tab.key or '' }}"
              aria-pressed="{{ 'true' if is_active else 'false' }}">
        <span>{{ tab.label }}</span>
        <span class="status-tab__count" id="tab-{{ tab.id }}">{{ tab.count }}</span>
      </button>
    {% endfor %}
  </div>

  {% if has_slots %}
    <form class="slot-filters" id="slot_filters_form" method="get" novalidate data-animate-in>
      <input type="hidden" name="status" id="filter_status" value="{{ filter_status or '' }}">
      <input type="hidden" name="per_page" value="{{ per_page }}">
      <input type="hidden" name="page" value="{{ page }}">
      <div class="slot-filters__row">
        <label class="slot-filters__group slot-filters__group--stretch">
          <span class="slot-filters__label">–ü–æ–∏—Å–∫</span>
          <div class="search-field">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="search-field__icon" aria-hidden="true">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="search"
                   id="slots_search"
                   name="q"
                   class="search-field__input"
                   placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–∞–Ω–¥–∏–¥–∞—Ç—É, TG ID, –≥–æ—Ä–æ–¥—É, —Ä–µ–∫—Ä—É—Ç–µ—Ä—É, —Å—Ç–∞—Ç—É—Å—É..."
                   aria-label="–ü–æ–∏—Å–∫ —Å–ª–æ—Ç–æ–≤"
                   value="{{ search_query or '' }}"
                   autocomplete="off">
            <span class="search-field__counter" id="search_counter" hidden>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="search-field__spinner" aria-hidden="true">
                <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
              </svg>
            </span>
          </div>
        </label>
        <label class="slot-filters__group">
          <span class="slot-filters__label">–ì–æ—Ä–æ–¥</span>
          <select name="city" id="filter_city">
            <option value="">–í—Å–µ</option>
            {% for city_name in (city_options or []) %}
              <option value="{{ city_name }}" {% if filter_city == city_name %}selected{% endif %}>
                {{ city_name }}
              </option>
            {% endfor %}
          </select>
        </label>
        <label class="slot-filters__group">
          <span class="slot-filters__label">–†–µ–∫—Ä—É—Ç–µ—Ä</span>
          <select name="recruiter_id" id="filter_recruiter">
            <option value="">–í—Å–µ</option>
            {% for rec in recruiter_options %}
              <option value="{{ rec.id }}" {% if filter_recruiter_id == rec.id %}selected{% endif %}>
                {{ rec.name }}
              </option>
            {% endfor %}
          </select>
        </label>
        <div class="slot-filters__group">
          <span class="slot-filters__label">–î–∞—Ç–∞</span>
          <div class="chip-group" id="date_shortcuts">
            <button type="button" class="chip" data-date="today">–°–µ–≥–æ–¥–Ω—è</button>
            <button type="button" class="chip" data-date="tomorrow">–ó–∞–≤—Ç—Ä–∞</button>
            <button type="button" class="chip" data-date="week">7 –¥–Ω–µ–π</button>
            <button type="button" class="chip" data-date="range">–î–∏–∞–ø–∞–∑–æ–Ω</button>
          </div>
          <div class="slot-filters__row" id="date_range" hidden>
            <label class="slot-filters__group">
              <span class="slot-filters__label">C</span>
              <input type="date" id="filter_date_from" name="date_from">
            </label>
            <label class="slot-filters__group">
              <span class="slot-filters__label">–ü–æ</span>
              <input type="date" id="filter_date_to" name="date_to">
            </label>
          </div>
        </div>
        <div class="slot-filters__actions">
          <button type="button" class="liquid-glass-btn liquid-glass-btn--primary" id="apply_filters">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <button type="button" class="liquid-glass-btn liquid-glass-btn--ghost" data-clear-filters>–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
      </div>
    </form>

    <div class="slot-table-region" data-animate-in>
      <div class="table-state table-state--loading" id="slots_loading" hidden>
        {% for i in range(4) %}
        <div class="skeleton-row" aria-hidden="true">
          <span class="skeleton-line"></span>
          <span class="skeleton-line"></span>
          <span class="skeleton-line"></span>
          <span class="skeleton-line"></span>
          <span class="skeleton-line"></span>
          <span class="skeleton-line"></span>
        </div>
        {% endfor %}
      </div>
      <div class="table-state table-state--error" id="slots_error" hidden>
        <p class="page-description">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–ª–æ—Ç–æ–≤.</p>
        <button type="button" class="liquid-glass-btn liquid-glass-btn--secondary" id="reload_slots">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div class="table-state table-state--empty" id="slots_empty" hidden>
        <h3 class="section-title">–ù–µ—Ç —Å–ª–æ—Ç–æ–≤ –ø–æ —Ç–µ–∫—É—â–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º</h3>
        <p class="page-description">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Å–ª–æ—Ç.</p>
        <div class="slot-empty-state__actions">
          <a class="liquid-glass-btn liquid-glass-btn--primary" href="/slots/new">+ –ù–æ–≤—ã–π —Å–ª–æ—Ç</a>
          <button type="button" class="liquid-glass-btn liquid-glass-btn--ghost" data-clear-filters>–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
        </div>
      </div>

      <div class="list-table-wrapper" id="slot_table_shell" hidden data-testid="slots-table-wrapper">
        <table class="list-table slot-table" id="slots_table" data-testid="slots-table">
        <thead>
          <tr>
            <th scope="col" class="col-select">
              <input type="checkbox" id="select_all_slots" aria-label="–í—ã–±—Ä–∞—Ç—å –≤—Å–µ —Å–ª–æ—Ç—ã">
            </th>
            <th scope="col" class="col-recruiter sortable">
              <button class="sort" type="button" data-key="slot" aria-sort="none">–†–µ–∫—Ä—É—Ç–µ—Ä / –≤—Ä–µ–º—è <span class="arrow" aria-hidden="true"></span></button>
            </th>
            <th scope="col" class="col-city sortable">
              <button class="sort" type="button" data-key="city" aria-sort="none">–ì–æ—Ä–æ–¥ <span class="arrow" aria-hidden="true"></span></button>
            </th>
            <th scope="col" class="col-candidate sortable">
              <button class="sort" type="button" data-key="candidate" aria-sort="none">–ö–∞–Ω–¥–∏–¥–∞—Ç <span class="arrow" aria-hidden="true"></span></button>
            </th>
            <th scope="col" class="col-status sortable">
              <button class="sort" type="button" data-key="status" aria-sort="none">–°—Ç–∞—Ç—É—Å <span class="arrow" aria-hidden="true"></span></button>
            </th>
            <th scope="col" class="col-actions">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="slots_tbody">
        {% for s in slots %}
          {% set st = norm_status(s.status) %}
          {% set tz_rec = s.recruiter.tz if s.recruiter and s.recruiter.tz else "Europe/Moscow" %}
          {% set slot_tz = s.tz_name or tz_rec %}
          {% set cand_tz = s.candidate_tz %}
          {% set status_order = 0 if st == 'FREE' else (1 if st == 'PENDING' else (2 if st == 'BOOKED' else (3 if st == 'CONFIRMED_BY_CANDIDATE' else 9))) %}
          <tr class="slot-row"
              tabindex="0"
              data-id="{{ s.id }}"
              data-status="{{ st or '' }}"
              data-status-order="{{ status_order }}"
              data-start-iso="{{ s.start_utc.isoformat() }}"
              data-city="{{ s.city.name if s.city else '' }}"
              data-city-tz="{{ s.city.tz if s.city else (slot_tz or '') }}"
              data-recruiter="{{ s.recruiter.name if s.recruiter else '' }}"
              data-recruiter-id="{{ s.recruiter.id if s.recruiter else '' }}"
              data-recruiter-tz="{{ tz_rec }}"
              data-candidate="{{ s.candidate_fio or '' }}"
              data-candidate-id="{{ s.candidate_tg_id or '' }}"
              data-candidate-username="{{ s.candidate_username or '' }}"
              data-candidate-tz="{{ cand_tz or '' }}"
              data-outcome="{{ s.interview_outcome or '' }}"
              data-created="{{ s.created_at.isoformat() if s.created_at else '' }}"
              data-updated="{{ s.updated_at.isoformat() if s.updated_at else '' }}"
              data-slot-tz="{{ slot_tz }}"
              data-can-delete="{{ 1 if st in ['FREE', 'PENDING'] else 0 }}">
            <td class="col-select" data-label="–í—ã–±–æ—Ä">
              <input type="checkbox" class="row-select" aria-label="–°–ª–æ—Ç {{ s.id }}">
            </td>
            <td class="col-recruiter" data-label="–†–µ–∫—Ä—É—Ç–µ—Ä –∏ –≤—Ä–µ–º—è" data-testid="slot-recruiter-cell">
              <div class="slot-cell-primary">{{ s.recruiter.name if s.recruiter else '‚Äî' }}</div>
              <div class="slot-cell-meta">ID {{ s.recruiter.id if s.recruiter else '‚Äî' }} ¬∑ {{ tz_display(tz_rec) }}</div>
              <div class="slot-time">
                <div class="slot-time__primary" data-testid="slot-local-time">{{ fmt_local(s.start_utc, slot_tz) }}</div>
                <div class="slot-time__meta">
                  <span class="pill pill--accent">UTC {{ fmt_utc(s.start_utc) }}</span>
                  <span class="pill pill--ghost" data-role="relative">‚Äî</span>
                </div>
              </div>
            </td>
            <td class="col-city" data-label="–ì–æ—Ä–æ–¥">
              {% if s.city %}
                <div class="slot-cell-primary">{{ s.city.name }}</div>
                <div class="slot-cell-meta">{{ tz_display(s.city.tz) }}</div>
              {% else %}
                <div class="slot-cell-primary">‚Äî</div>
                <div class="slot-cell-meta">{{ tz_display(slot_tz) }}</div>
              {% endif %}
            </td>
            <td class="col-candidate" data-label="–ö–∞–Ω–¥–∏–¥–∞—Ç">
              {% if s.candidate_fio %}
                <div class="slot-cell-primary">{{ s.candidate_fio }}</div>
                <div class="slot-cell-meta">tg: {{ s.candidate_tg_id or "‚Äî" }}{% if s.candidate_username %} ¬∑ @{{ s.candidate_username }}{% endif %}</div>
              {% else %}
                <span class="liquid-glass-badge liquid-glass-badge--info">FREE</span>
              {% endif %}
            </td>
            <td class="col-status" data-label="–°—Ç–∞—Ç—É—Å">
              {% if st == "FREE" %}
                <span class="liquid-glass-badge liquid-glass-badge--success">FREE</span>
              {% elif st == "PENDING" %}
                <span class="liquid-glass-badge liquid-glass-badge--warning">PENDING</span>
              {% elif st == "BOOKED" %}
                <span class="liquid-glass-badge liquid-glass-badge--info">BOOKED</span>
              {% elif st == "CONFIRMED_BY_CANDIDATE" %}
                <span class="liquid-glass-badge liquid-glass-badge--success">CONFIRMED</span>
              {% else %}
                <span class="liquid-glass-badge liquid-glass-badge--neutral">{{ st or "‚Äî" }}</span>
              {% endif %}
            </td>
            <td class="col-actions" data-label="–î–µ–π—Å—Ç–≤–∏—è">
              <div class="action-group">
                {% if s.candidate_tg_id %}
                  <a href="/candidates?q={{ s.candidate_tg_id }}" class="icon-btn" title="–û—Ç–∫—Ä—ã—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞" aria-label="–û—Ç–∫—Ä—ã—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                      <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                  </a>
                {% endif %}
                {% if st == 'FREE' %}
                  <button type="button" class="icon-btn" data-action="delete-slot" title="–£–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç" aria-label="–£–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                {% elif st == 'PENDING' %}
                  <button type="button" class="icon-btn icon-btn--danger" data-action="reject-booking" title="–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å" aria-label="–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                {% elif st == 'BOOKED' %}
                  <button type="button" class="icon-btn" data-action="reschedule-booking" title="–û—Å–≤–æ–±–æ–¥–∏—Ç—å –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞" aria-label="–û—Å–≤–æ–±–æ–¥–∏—Ç—å –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <polyline points="23 4 23 10 17 10"></polyline>
                      <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                    </svg>
                  </button>
                {% elif st == 'CONFIRMED_BY_CANDIDATE' %}
                  <button type="button" class="icon-btn" data-action="set-outcome" data-outcome="attended" title="–û—Ç–º–µ—Ç–∏—Ç—å —è–≤–∫—É" aria-label="–û—Ç–º–µ—Ç–∏—Ç—å —è–≤–∫—É">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  </button>
                  <button type="button" class="icon-btn" data-action="set-outcome" data-outcome="no_show" title="–û—Ç–º–µ—Ç–∏—Ç—å –Ω–µ—è–≤–∫—É" aria-label="–û—Ç–º–µ—Ç–∏—Ç—å –Ω–µ—è–≤–∫—É">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                {% else %}
                  <button type="button" class="icon-btn" data-action="delete-slot" title="–£–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç" aria-label="–£–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                {% endif %}
              </div>
            </td>
          </tr>
          <tr class="slot-row-details" data-details-for="{{ s.id }}" hidden>
            <td colspan="7">
              <div class="slot-details">
                <div class="slot-details__grid">
                  <div>
                    <span>Recruiter TZ</span>
                    <strong>{{ tz_display(tz_rec) }}</strong>
                  </div>
                  <div>
                    <span>Candidate TZ</span>
                    <strong>{% if cand_tz %}{{ tz_display(cand_tz) }}{% else %}‚Äî{% endif %}</strong>
                  </div>
                  <div>
                    <span>TG ID</span>
                    <strong>{{ s.candidate_tg_id or '‚Äî' }}</strong>
                  </div>
                  <div>
                    <span>Username</span>
                    <strong>{% if s.candidate_username %}@{{ s.candidate_username }}{% else %}‚Äî{% endif %}</strong>
                  </div>
                  <div>
                    <span>–°–æ–∑–¥–∞–Ω</span>
                    <strong>{% if s.created_at %}{{ fmt_local(s.created_at, slot_tz) }}{% else %}‚Äî{% endif %}</strong>
                  </div>
                  <div>
                    <span>–û–±–Ω–æ–≤–ª–µ–Ω</span>
                    <strong>{% if s.updated_at %}{{ fmt_local(s.updated_at, slot_tz) }}{% else %}‚Äî{% endif %}</strong>
                  </div>
                  <div>
                    <span>UTC</span>
                    <strong>{{ fmt_utc(s.start_utc) }}</strong>
                  </div>
                  <div>
                    <span>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</span>
                    <strong>{{ s.duration_min }} –º–∏–Ω</strong>
                  </div>
                </div>
                <div class="slot-details__actions">
                  {% if s.candidate_tg_id %}
                    <a class="liquid-glass-btn liquid-glass-btn--secondary liquid-glass-btn--small" href="/candidates?q={{ s.candidate_tg_id }}">–û—Ç–∫—Ä—ã—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</a>
                  {% endif %}
                  {% if s.candidate_username %}
                    <a class="liquid-glass-btn liquid-glass-btn--ghost liquid-glass-btn--small" href="https://t.me/{{ s.candidate_username }}" target="_blank" rel="noreferrer noopener">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</a>
                  {% endif %}
                  <button type="button" class="liquid-glass-btn liquid-glass-btn--danger liquid-glass-btn--small" data-action="delete-slot">–£–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç</button>
                </div>
              </div>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      </div>
      <div class="slot-cards" id="slot_cards" hidden>
        {% for s in slots %}
          {% set st = norm_status(s.status) %}
          {% set tz_rec = s.recruiter.tz if s.recruiter and s.recruiter.tz else "Europe/Moscow" %}
          {% set slot_tz = s.tz_name or tz_rec %}
          {% set cand_tz = s.candidate_tz %}
          <article class="slot-card"
                   data-id="{{ s.id }}"
                   data-status="{{ st or '' }}"
                   data-status-order="{{ 0 if st == 'FREE' else (1 if st == 'PENDING' else (2 if st == 'BOOKED' else (3 if st == 'CONFIRMED_BY_CANDIDATE' else 9))) }}"
                   data-start-iso="{{ s.start_utc.isoformat() }}"
                   data-city="{{ s.city.name if s.city else '' }}"
                   data-city-tz="{{ s.city.tz if s.city else (slot_tz or '') }}"
                   data-recruiter="{{ s.recruiter.name if s.recruiter else '' }}"
                   data-recruiter-id="{{ s.recruiter.id if s.recruiter else '' }}"
                   data-recruiter-tz="{{ tz_rec }}"
                   data-candidate="{{ s.candidate_fio or '' }}"
                   data-candidate-id="{{ s.candidate_tg_id or '' }}"
                   data-candidate-username="{{ s.candidate_username or '' }}"
                   data-candidate-tz="{{ cand_tz or '' }}"
                   data-slot-tz="{{ slot_tz }}"
                   data-created="{{ s.created_at.isoformat() if s.created_at else '' }}"
                   data-updated="{{ s.updated_at.isoformat() if s.updated_at else '' }}">
            <div class="slot-card__header">
              <div>
                <div class="slot-card__title">{{ fmt_local(s.start_utc, slot_tz) }}</div>
                <div class="slot-cell-meta">UTC {{ fmt_utc(s.start_utc) }}</div>
              </div>
              <div class="slot-card__status">
                {% if st == "FREE" %}
                  <span class="liquid-glass-badge liquid-glass-badge--success">FREE</span>
                {% elif st == "PENDING" %}
                  <span class="liquid-glass-badge liquid-glass-badge--warning">PENDING</span>
                {% elif st == "BOOKED" %}
                  <span class="liquid-glass-badge liquid-glass-badge--info">BOOKED</span>
                {% elif st == "CONFIRMED_BY_CANDIDATE" %}
                  <span class="liquid-glass-badge liquid-glass-badge--success">CONFIRMED</span>
                {% else %}
                  <span class="liquid-glass-badge liquid-glass-badge--neutral">{{ st or "‚Äî" }}</span>
                {% endif %}
              </div>
            </div>
            <div class="slot-card__meta">
              <div><span>–ì–æ—Ä–æ–¥</span>{{ s.city.name if s.city else '‚Äî' }} ¬∑ {{ tz_display(s.city.tz) if s.city else tz_display(slot_tz) }}</div>
              <div><span>–†–µ–∫—Ä—É—Ç–µ—Ä</span>{{ s.recruiter.name if s.recruiter else '‚Äî' }}</div>
              <div><span>–ö–∞–Ω–¥–∏–¥–∞—Ç</span>{% if s.candidate_fio %}{{ s.candidate_fio }}{% else %}FREE{% endif %}</div>
              <div><span>TG</span>{{ s.candidate_tg_id or '‚Äî' }}{% if s.candidate_username %} / @{{ s.candidate_username }}{% endif %}</div>
            </div>
            <div class="slot-card__footer">
              {% if s.candidate_tg_id %}
                <a href="/candidates?q={{ s.candidate_tg_id }}" class="icon-btn" title="–û—Ç–∫—Ä—ã—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞" aria-label="–û—Ç–∫—Ä—ã—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg>
                </a>
              {% endif %}
              {% if st == 'FREE' %}
                <button type="button" class="icon-btn" data-action="delete-slot" title="–£–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç" aria-label="–£–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                </button>
              {% elif st == 'PENDING' %}
                <button type="button" class="icon-btn icon-btn--danger" data-action="reject-booking" title="–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å" aria-label="–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              {% elif st == 'BOOKED' %}
                <button type="button" class="icon-btn" data-action="reschedule-booking" title="–û—Å–≤–æ–±–æ–¥–∏—Ç—å –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞" aria-label="–û—Å–≤–æ–±–æ–¥–∏—Ç—å –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                  </svg>
                </button>
              {% elif st == 'CONFIRMED_BY_CANDIDATE' %}
                <button type="button" class="icon-btn" data-action="set-outcome" data-outcome="attended" title="–û—Ç–º–µ—Ç–∏—Ç—å —è–≤–∫—É" aria-label="–û—Ç–º–µ—Ç–∏—Ç—å —è–≤–∫—É">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </button>
                <button type="button" class="icon-btn" data-action="set-outcome" data-outcome="no_show" title="–û—Ç–º–µ—Ç–∏—Ç—å –Ω–µ—è–≤–∫—É" aria-label="–û—Ç–º–µ—Ç–∏—Ç—å –Ω–µ—è–≤–∫—É">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              {% else %}
                <button type="button" class="icon-btn" data-action="delete-slot" title="–£–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç" aria-label="–£–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                </button>
              {% endif %}
            </div>
          </article>
        {% endfor %}
      </div>
      <div class="calendar-view" id="slot_calendar">
        {% set last_date = None %}
        {% for s in slots %}
          {% set st = norm_status(s.status) %}
          {% set tz_rec = s.recruiter.tz if s.recruiter and s.recruiter.tz else "Europe/Moscow" %}
          {% set slot_tz = s.tz_name or tz_rec %}
          {% set cand_tz = s.candidate_tz %}
          {% set date_key = s.start_utc.date() %}
          {% if date_key != last_date %}
            {% if not loop.first %}</div></div>{% endif %}
            <div class="calendar-day" data-date="{{ date_key.isoformat() }}">
              <div class="calendar-day__header">
                <span>{{ date_key.strftime('%d.%m.%Y') }}</span>
                <span class="slot-cell-meta">{{ tz_display(slot_tz) }}</span>
              </div>
              <div class="calendar-day__list">
          {% endif %}
          <div class="calendar-item"
               data-id="{{ s.id }}"
               data-status="{{ st or '' }}"
               data-status-order="{{ 0 if st == 'FREE' else (1 if st == 'PENDING' else (2 if st == 'BOOKED' else (3 if st == 'CONFIRMED_BY_CANDIDATE' else 9))) }}"
               data-start-iso="{{ s.start_utc.isoformat() }}"
               data-city="{{ s.city.name if s.city else '' }}"
               data-city-tz="{{ s.city.tz if s.city else (slot_tz or '') }}"
               data-recruiter="{{ s.recruiter.name if s.recruiter else '' }}"
               data-recruiter-id="{{ s.recruiter.id if s.recruiter else '' }}"
               data-recruiter-tz="{{ tz_rec }}"
               data-candidate="{{ s.candidate_fio or '' }}"
               data-candidate-id="{{ s.candidate_tg_id or '' }}"
               data-candidate-username="{{ s.candidate_username or '' }}"
               data-candidate-tz="{{ cand_tz or '' }}"
               data-slot-tz="{{ slot_tz }}"
               data-created="{{ s.created_at.isoformat() if s.created_at else '' }}"
               data-updated="{{ s.updated_at.isoformat() if s.updated_at else '' }}">
            <div class="calendar-item__time">{{ fmt_local(s.start_utc, slot_tz) }}</div>
            <div class="calendar-item__meta">
              <strong>{{ s.recruiter.name if s.recruiter else '‚Äî' }}</strong>
              <span>{{ tz_display(tz_rec) }}</span>
            </div>
            <div class="calendar-item__meta">
              <strong>{{ s.city.name if s.city else '‚Äî' }}</strong>
              <span>{% if s.city %}{{ tz_display(s.city.tz) }}{% else %}{{ tz_display(slot_tz) }}{% endif %}</span>
              <strong>{% if s.candidate_fio %}{{ s.candidate_fio }}{% else %}FREE{% endif %}</strong>
            </div>
            <div class="calendar-item__actions">
              {% if s.candidate_tg_id %}
                <a href="/candidates?q={{ s.candidate_tg_id }}" class="icon-btn" title="–û—Ç–∫—Ä—ã—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞" aria-label="–û—Ç–∫—Ä—ã—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg>
                </a>
              {% endif %}
              {% if st == 'FREE' %}
                <button type="button" class="icon-btn" data-action="delete-slot" title="–£–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç" aria-label="–£–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                </button>
              {% elif st == 'PENDING' %}
                <button type="button" class="icon-btn icon-btn--danger" data-action="reject-booking" title="–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å" aria-label="–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              {% elif st == 'BOOKED' %}
                <button type="button" class="icon-btn" data-action="reschedule-booking" title="–û—Å–≤–æ–±–æ–¥–∏—Ç—å –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞" aria-label="–û—Å–≤–æ–±–æ–¥–∏—Ç—å –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                  </svg>
                </button>
              {% elif st == 'CONFIRMED_BY_CANDIDATE' %}
                <button type="button" class="icon-btn" data-action="set-outcome" data-outcome="attended" title="–û—Ç–º–µ—Ç–∏—Ç—å —è–≤–∫—É" aria-label="–û—Ç–º–µ—Ç–∏—Ç—å —è–≤–∫—É">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </button>
                <button type="button" class="icon-btn" data-action="set-outcome" data-outcome="no_show" title="–û—Ç–º–µ—Ç–∏—Ç—å –Ω–µ—è–≤–∫—É" aria-label="–û—Ç–º–µ—Ç–∏—Ç—å –Ω–µ—è–≤–∫—É">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              {% else %}
                <button type="button" class="icon-btn" data-action="delete-slot" title="–£–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç" aria-label="–£–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                </button>
              {% endif %}
            </div>
          </div>
          {% set last_date = date_key %}
          {% if loop.last %}</div></div>{% endif %}
        {% endfor %}
      </div>
    </div>

  {% else %}
    <div class="liquid-glass-card slot-empty-state" role="status" data-animate-in>
      <h3 class="section-title">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</h3>
      <p class="page-description">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Å–ª–æ—Ç –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ.</p>
      <div class="slot-empty-state__actions">
        <a class="liquid-glass-btn liquid-glass-btn--primary" href="/slots/new">+ –ù–æ–≤—ã–π —Å–ª–æ—Ç</a>
      </div>
    </div>
  {% endif %}

  <div id="toasts" class="toast-stack" aria-live="polite" aria-atomic="true"></div>

  <!-- Delete All Confirmation Modal -->
  <dialog id="delete_all_modal" class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
        <button type="button" class="modal-close" id="modal_close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p id="delete_all_message" class="modal-message">–≠—Ç–æ —É–¥–∞–ª–∏—Ç <strong id="slots_count">N</strong> —Å–ª–æ—Ç–æ–≤. –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
        <p class="modal-warning">‚ö†Ô∏è –ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ —Å–≤–æ–±–æ–¥–Ω—ã–µ –∏ –æ–∂–∏–¥–∞—é—â–∏–µ —Å–ª–æ—Ç—ã. –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞–Ω—É—Ç—Å—è.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="liquid-glass-btn liquid-glass-btn--secondary" id="modal_cancel">
          –û—Ç–º–µ–Ω–∞
        </button>
        <button type="button" class="liquid-glass-btn liquid-glass-btn--danger" id="modal_confirm">
          –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–ª–æ—Ç—ã
        </button>
      </div>
    </div>
  </dialog>

  <style>
    /* Modal Dialog */
    .modal-dialog {
      border: none;
      border-radius: 20px;
      padding: 0;
      background: transparent;
      max-width: 500px;
      width: 90%;
    }

    .modal-dialog::backdrop {
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    .modal-content {
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.95);
    }

    .modal-close {
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      padding: 4px;
      transition: color 0.2s ease;
    }

    .modal-close:hover {
      color: rgba(255, 255, 255, 0.95);
    }

    .modal-body {
      margin-bottom: 24px;
    }

    .modal-message {
      margin: 0 0 12px 0;
      font-size: 15px;
      color: rgba(255, 255, 255, 0.85);
      line-height: 1.5;
    }

    .modal-message strong {
      color: #ef4444;
      font-weight: 700;
    }

    .modal-warning {
      margin: 0;
      padding: 12px;
      border-radius: 12px;
      background: rgba(251, 191, 36, 0.12);
      border: 1px solid rgba(251, 191, 36, 0.3);
      color: rgba(255, 255, 255, 0.9);
      font-size: 13px;
      line-height: 1.4;
    }

    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
  </style>
</section>

<script>
(function(){
  const $ = (selector, root=document) => root.querySelector(selector);
  const $$ = (selector, root=document) => Array.from(root.querySelectorAll(selector));
  const on = (el, event, cb, opts) => el && el.addEventListener(event, cb, opts);

  const table = $('#slots_table');
  const tbody = $('#slots_tbody');
  const rows = tbody ? $$('.slot-row', tbody) : [];
  const detailMap = new Map();
  rows.forEach(row => {
    const next = row.nextElementSibling;
    if (next && next.dataset.detailsFor === row.dataset.id) {
      detailMap.set(row.dataset.id, next);
    }
  });
  const slotCardsEl = $('#slot_cards');
  const cards = slotCardsEl ? $$('.slot-card', slotCardsEl) : [];
  const cardMap = new Map();
  cards.forEach(card => cardMap.set(card.dataset.id, card));
  const calendarView = $('#slot_calendar');
  const calendarItems = calendarView ? $$('.calendar-item', calendarView) : [];
  const calendarDays = calendarView ? $$('.calendar-day', calendarView) : [];
  const resolveRowFromAction = (node) => {
    const row = node.closest('.slot-row');
    if (row) return row;
    const detail = node.closest('.slot-row-details');
    if (detail && detail.dataset.detailsFor) {
      return tbody?.querySelector(`.slot-row[data-id=\"${detail.dataset.detailsFor}\"]`) || null;
    }
    const card = node.closest('.slot-card');
    if (card && card.dataset.id) {
      return tbody?.querySelector(`.slot-row[data-id=\"${card.dataset.id}\"]`) || null;
    }
    const calItem = node.closest('.calendar-item');
    if (calItem && calItem.dataset.id) {
      return tbody?.querySelector(`.slot-row[data-id=\"${calItem.dataset.id}\"]`) || null;
    }
    return null;
  };

  const deleteAllBtn = $('#delete_all_slots');
  const deleteSelectedBtn = $('#delete_selected_slots');
  const exportBtn = $('#export_slots');
  const moreActionsBtn = $('#more_actions_btn');
  const moreActionsMenu = $('#more_actions_menu');
  const deleteAllModal = $('#delete_all_modal');
  const modalClose = $('#modal_close');
  const modalCancel = $('#modal_cancel');
  const modalConfirm = $('#modal_confirm');
  const slotsCountEl = $('#slots_count');

  const searchInput = $('#slots_search');
  const searchCounter = $('#search_counter');
  const filterStatusInput = $('#filter_status');
  const filterCity = $('#filter_city');
  const filterRecruiter = $('#filter_recruiter');
  const dateFrom = $('#filter_date_from');
  const dateTo = $('#filter_date_to');
  const dateShortcuts = $$('#date_shortcuts .chip');
  const statusTabs = $$('.status-tab');
  const summaryChips = $$('.slot-chip');
  const applyFiltersBtn = $('#apply_filters');
  const clearButtons = $$('[data-clear-filters]');
  const selectAll = $('#select_all_slots');
  const slotTableShell = $('#slot_table_shell');
  const loadingState = $('#slots_loading');
  const emptyState = $('#slots_empty');
  const errorState = $('#slots_error');
  const reloadBtn = $('#reload_slots');

  const chipTotal = $('#cnt-total');
  const chipFree = $('#cnt-free');
  const chipPending = $('#cnt-pending');
  const chipBookedEl = $('#cnt-booked');
  const chipConfirmed = $('#cnt-confirmed');
  const tabTotal = $('#tab-cnt-total');
  const tabFree = $('#tab-cnt-free');
  const tabPending = $('#tab-cnt-pending');
  const tabBooked = $('#tab-cnt-booked');
  const tabConfirmed = $('#tab-cnt-confirmed');

  const toastStack = $('#toasts');
  const notificationFeedKey = 'slots.notifications.lastId';
  let notificationFeedTimer = null;

  let sortState = { key: 'slot', dir: 'asc' };
  let relTimer = null;
  let filterTimer = null;
  let isLoading = false;

  const storage = window.localStorage;
  const csrfToken = window.__CSRF_TOKEN__ || '';

  const filters = {
    status: (filterStatusInput?.value || '').toUpperCase(),
    city: filterCity?.value || '',
    recruiter: filterRecruiter?.value || '',
    search: (searchInput?.value || '').trim().toLowerCase(),
    datePreset: null,
    from: '',
    to: '',
  };
  const selectedIds = new Set();
  if (filterStatusInput) filterStatusInput.value = filters.status;

  function toast(text, kind='info') {
    if (!toastStack) return;
    const el = document.createElement('div');
    el.className = 'toast';
    el.dataset.kind = kind;
    el.textContent = text;
    toastStack.appendChild(el);
    requestAnimationFrame(() => el.classList.add('toast--show'));
    setTimeout(() => el.classList.add('toast--hide'), 1800);
    setTimeout(() => el.remove(), 2200);
  }

  const notificationLabels = {
    interview_confirmed_candidate: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–ª–æ—Ç–∞',
    candidate_reschedule_prompt: '–ü–µ—Ä–µ–Ω–æ—Å —Å–ª–æ—Ç–∞',
    candidate_rejection: '–û—Ç–∫–∞–∑ –∫–∞–Ω–¥–∏–¥–∞—Ç—É',
    intro_day_invitation: '–û–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω—å',
  };
  const reminderLabels = {
    confirm_6h: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞ 6 —á–∞—Å–æ–≤',
    confirm_3h: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞ 3 —á–∞—Å–∞',
    confirm_2h: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞ 2 —á–∞—Å–∞',
    intro_remind_3h: '–û–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω—å —á–µ—Ä–µ–∑ 3 —á–∞—Å–∞',
  };

  function labelForNotification(item) {
    if (!item) return '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ';
    const direct = notificationLabels[item.type];
    if (direct) return direct;
    if (item.type && item.type.startsWith('slot_reminder:')) {
      const [, kind] = item.type.split(':', 2);
      return reminderLabels[kind] || '–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –≤—Å—Ç—Ä–µ—á–µ';
    }
    return item.type || '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ';
  }
  function shouldDisplayNotification(item) {
    const status = (item?.status || '').toLowerCase();
    return status === 'failed' || status === 'pending';
  }
  function toastKindForStatus(status) {
    if (status === 'failed') return 'error';
    if (status === 'pending') return 'info';
    return 'info';
  }
  function formatNotificationMessage(item) {
    const label = labelForNotification(item);
    const status = (item?.status || '').toLowerCase();
    if (status === 'failed') {
      return `${label}: ${item?.last_error || '–æ—à–∏–±–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏'}`;
    }
    if (status === 'pending') {
      return `${label}: –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è`;
    }
    return `${label}: —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω`;
  }
  async function fetchNotificationFeed() {
    const lastId = storage.getItem(notificationFeedKey);
    const query = lastId ? `?after_id=${encodeURIComponent(lastId)}` : '';
    try {
      const res = await fetch(`/api/notifications/feed${query}`);
      if (!res.ok) return;
      const payload = await res.json();
      const items = payload.items || [];
      const latestId = payload.latest_id || (items.length ? items[items.length - 1].id : null);
      if (!lastId) {
        if (latestId) storage.setItem(notificationFeedKey, latestId);
        return;
      }
      items.forEach(item => {
        if (!shouldDisplayNotification(item)) return;
        const status = (item.status || '').toLowerCase();
        toast(formatNotificationMessage(item), toastKindForStatus(status));
      });
      if (latestId) storage.setItem(notificationFeedKey, latestId);
    } catch (err) {
      console.warn('notification feed error', err);
    }
  }
  function startNotificationFeed() {
    if (notificationFeedTimer) {
      clearInterval(notificationFeedTimer);
    }
    fetchNotificationFeed();
    notificationFeedTimer = setInterval(fetchNotificationFeed, 30000);
  }

  function parseTime(row) {
    const iso = row?.dataset.startIso;
    if (!iso) return NaN;
    const value = Date.parse(iso);
    return Number.isNaN(value) ? NaN : value;
  }
  function relativeState(diffMin) {
    if (!Number.isFinite(diffMin)) return 'distant';
    if (diffMin < -5) return 'past';
    if (diffMin <= 15) return 'now';
    if (diffMin <= 120) return 'soon';
    return 'distant';
  }
  function formatRelative(ts) {
    if (!Number.isFinite(ts)) return '‚Äî';
    const diffMin = Math.round((ts - Date.now()) / 60000);
    const abs = Math.abs(diffMin);
    if (abs < 1) return diffMin >= 0 ? '—á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥' : '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    if (abs < 60) return `${diffMin >= 0 ? '—á–µ—Ä–µ–∑' : ''} ${abs} –º–∏–Ω`;
    const hours = Math.round(abs / 60);
    return `${diffMin >= 0 ? '—á–µ—Ä–µ–∑' : ''} ${hours} —á`;
  }

  function parseDate(value) {
    if (!value) return null;
    const ts = Date.parse(value);
    return Number.isNaN(ts) ? null : new Date(ts);
  }
  function matchesDate(row) {
    const ts = parseTime(row);
    if (!Number.isFinite(ts)) return false;
    const date = new Date(ts);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const start = filters.from ? parseDate(filters.from) : null;
    const end = filters.to ? parseDate(filters.to) : null;
    switch (filters.datePreset) {
      case 'today':
        return date.toDateString() === today.toDateString();
      case 'tomorrow': {
        const tmr = new Date(today);
        tmr.setDate(tmr.getDate() + 1);
        return date.toDateString() === tmr.toDateString();
      }
      case 'week': {
        const week = new Date(today);
        week.setDate(week.getDate() + 7);
        return date >= today && date <= week;
      }
      case 'range':
        if (start && date < start) return false;
        if (end) {
          const endCopy = new Date(end);
          endCopy.setHours(23, 59, 59, 999);
          if (date > endCopy) return false;
        }
        return true;
      default:
        return true;
    }
  }
  function matchesSearch(row) {
    if (!filters.search) return true;
    const haystack = [
      row.dataset.candidate,
      row.dataset.candidateId,
      row.dataset.candidateUsername,
      row.dataset.city,
      row.dataset.recruiter,
      row.dataset.status,
    ].join(' ').toLowerCase();
    return haystack.includes(filters.search);
  }
  function matchesFilters(row) {
    const status = (row.dataset.status || '').toUpperCase();
    if (filters.status && status !== filters.status) return false;
    if (filters.city && (row.dataset.city || '') !== filters.city) return false;
    if (filters.recruiter && (row.dataset.recruiterId || '') !== filters.recruiter) return false;
    if (!matchesDate(row)) return false;
    if (!matchesSearch(row)) return false;
    return true;
  }

  function showLoading() {
    isLoading = true;
    if (loadingState) loadingState.hidden = false;
    if (slotTableShell) slotTableShell.hidden = true;
    if (emptyState) emptyState.hidden = true;
  }
  function hideLoading() {
    isLoading = false;
    if (loadingState) loadingState.hidden = true;
  }

  function updateEmptyState(visibleCount) {
    const hasRows = visibleCount > 0;
    if (slotTableShell) slotTableShell.hidden = true;
    if (slotCardsEl) slotCardsEl.hidden = true;
    if (calendarView) calendarView.hidden = !hasRows;
    if (emptyState) emptyState.hidden = hasRows || isLoading;
  }

  function setError(message) {
    if (!errorState) return;
    const desc = errorState.querySelector('.page-description');
    if (desc && message) desc.textContent = message;
    errorState.hidden = false;
    if (slotTableShell) slotTableShell.hidden = true;
    if (slotCardsEl) slotCardsEl.hidden = true;
    hideLoading();
  }

  function updateCounters() {
    let total = 0, free = 0, pending = 0, booked = 0, confirmed = 0;
    rows.forEach(row => {
      if (row.hidden) return;
      total += 1;
      const st = row.dataset.status;
      if (st === 'FREE') free += 1;
      else if (st === 'PENDING') pending += 1;
      else if (st === 'BOOKED') booked += 1;
      else if (st === 'CONFIRMED_BY_CANDIDATE') confirmed += 1;
    });
    const assign = (el, val) => { if (el) el.textContent = val; };
    assign(chipTotal, total);
    assign(chipFree, free);
    assign(chipPending, pending);
    assign(chipBookedEl, booked);
    assign(chipConfirmed, confirmed);
    assign(tabTotal, total);
    assign(tabFree, free);
    assign(tabPending, pending);
    assign(tabBooked, booked);
    assign(tabConfirmed, confirmed);
  }

  function updateRelativeLabels() {
    const now = Date.now();
    rows.forEach(row => {
      const relEl = row.querySelector('[data-role="relative"]');
      const ts = parseTime(row);
      if (!relEl || !Number.isFinite(ts)) return;
      const diffMin = Math.round((ts - now) / 60000);
      const state = relativeState(diffMin);
      relEl.textContent = formatRelative(ts);
      relEl.dataset.state = state;
      row.classList.toggle('is-past', state === 'past');
      row.classList.toggle('is-now', state === 'now');
      row.classList.toggle('is-soon', state === 'soon');
      row.classList.toggle('is-distant', state === 'distant');
    });
  }

  function getSortValue(row, key) {
    switch(key) {
      case 'slot':
      case 'utc':
        return parseTime(row);
      case 'recruiter':
        return (row.dataset.recruiter || '').toLowerCase();
      case 'city':
        return (row.dataset.city || '').toLowerCase();
      case 'candidate':
        return ((row.dataset.candidate || '') + (row.dataset.candidateUsername || '')).toLowerCase();
      case 'status':
        return parseInt(row.dataset.statusOrder || '9', 10);
      default:
        return 0;
    }
  }

  function applySort() {
    if (!tbody) return;
    const sorted = rows.slice().sort((a, b) => {
      const av = getSortValue(a, sortState.key);
      const bv = getSortValue(b, sortState.key);
      if (av < bv) return sortState.dir === 'asc' ? -1 : 1;
      if (av > bv) return sortState.dir === 'asc' ? 1 : -1;
      return 0;
    });
    sorted.forEach(row => {
      tbody.appendChild(row);
      const details = detailMap.get(row.dataset.id);
      if (details) tbody.appendChild(details);
    });
  }

  function applySortIndicator() {
    if (!table) return;
    $$('.sort', table).forEach(btn => {
      const key = btn.dataset.key;
      const active = key === sortState.key;
      btn.classList.toggle('is-active', active);
      btn.setAttribute('aria-sort', active ? (sortState.dir === 'asc' ? 'ascending' : 'descending') : 'none');
    });
  }

  function applyFilters() {
    rows.forEach(row => {
      const match = matchesFilters(row);
      row.hidden = !match;
      const detail = detailMap.get(row.dataset.id);
      if (detail) detail.hidden = true;
      if (!match) selectedIds.delete(row.dataset.id);
    });
    cards.forEach(card => {
      const match = matchesFilters(card);
      card.hidden = !match;
    });
    calendarItems.forEach(item => {
      const match = matchesFilters(item);
      item.hidden = !match;
    });
    calendarDays.forEach(day => {
      const hasVisible = $$('.calendar-item', day).some(it => !it.hidden);
      day.hidden = !hasVisible;
    });
    const visible = rows.filter(r => !r.hidden).length;
    updateCounters();
    updateRelativeLabels();
    updateEmptyState(visible);
    updateSelectionUI();
    hideLoading();
  }

  function scheduleFilter() {
    if (searchCounter) searchCounter.hidden = false;
    showLoading();
    clearTimeout(filterTimer);
    filterTimer = setTimeout(() => {
      applySort();
      applyFilters();
      if (searchCounter) searchCounter.hidden = true;
    }, 200);
  }

  function resetFilters() {
    filters.status = '';
    filters.city = '';
    filters.recruiter = '';
    filters.search = '';
    filters.datePreset = null;
    filters.from = '';
    filters.to = '';
    if (filterStatusInput) filterStatusInput.value = '';
    if (filterCity) filterCity.value = '';
    if (filterRecruiter) filterRecruiter.value = '';
    if (searchInput) searchInput.value = '';
    if (dateFrom) dateFrom.value = '';
    if (dateTo) dateTo.value = '';
    dateShortcuts.forEach(btn => btn.classList.remove('is-active'));
    statusTabs.forEach(btn => btn.classList.remove('is-active'));
    if (statusTabs.length) statusTabs[0].classList.add('is-active');
    summaryChips.forEach(ch => ch.classList.toggle('slot-chip--active', !ch.dataset.status));
    scheduleFilter();
  }

  function toggleDropdown() {
    if (!moreActionsMenu || !moreActionsBtn) return;
    const isOpen = !moreActionsMenu.hidden;
    moreActionsMenu.hidden = isOpen;
    moreActionsBtn.setAttribute('aria-expanded', (!isOpen).toString());
  }
  function closeDropdown() {
    if (!moreActionsMenu || !moreActionsBtn) return;
    moreActionsMenu.hidden = true;
    moreActionsBtn.setAttribute('aria-expanded', 'false');
  }

  function removeRow(row) {
    if (!row) return;
    const id = row.dataset.id;
    const idx = rows.indexOf(row);
    if (idx !== -1) {
      rows.splice(idx, 1);
    }
    const detail = detailMap.get(id);
    if (detail) detail.remove();
    detailMap.delete(id);
    row.remove();
    selectedIds.delete(id);
    updateCounters();
    updateRelativeLabels();
    updateEmptyState(rows.filter(r => !r.hidden).length);
  }

  async function performDelete(row, options = {}) {
    if (!row) return;
    const { force = false, skipConfirm = false } = options;
    const id = row.dataset.id;
    if (!id) return;

    const canDelete = row.dataset.canDelete === '1';
    const status = row.dataset.status || '';
    const recruiterName = row.dataset.recruiter ? ` (${row.dataset.recruiter})` : '';

    if (!force && !canDelete) {
      const confirmForce = window.confirm(
        status
          ? `–°–ª–æ—Ç #${id}${recruiterName} –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å ${status}. –£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ?`
          : `–£–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç #${id}${recruiterName} –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ?`
      );
      if (!confirmForce) return;
      return await performDelete(row, { force: true, skipConfirm: true });
    }

    const confirmationText = force
      ? `–£–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç #${id}${recruiterName}? –≠—Ç–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ.`
      : `–£–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç #${id}${recruiterName}? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`;

    if (!skipConfirm && !window.confirm(confirmationText)) return;

    try {
      const response = await fetch(`/slots/${id}?force=${force ? 1 : 0}`, {
        method: 'DELETE',
        headers: {
          'Accept': 'application/json',
          'X-CSRFToken': csrfToken,
        },
      });
      const payload = await response.json().catch(() => null);

      if (!response.ok || !payload || payload.ok !== true) {
        const message = payload && payload.message ? payload.message : '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç.';
        if (!force && payload && payload.code === 'requires_force') {
          const askForce = window.confirm(`${message} –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ?`);
          if (askForce) {
            return await performDelete(row, { force: true, skipConfirm: true });
          }
        }
        toast(message, 'error');
        return;
      }

      toast(payload.message || '–°–ª–æ—Ç —É–¥–∞–ª—ë–Ω', 'success');
      removeRow(row);
      applyFilters();
    } catch (err) {
      console.error(err);
      toast('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç.', 'error');
      setError('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç.');
    }
  }

  async function performReschedule(row) {
    if (!row) return;
    const id = row.dataset.id;
    if (!id) return;

    const recruiterName = row.dataset.recruiter ? ` (${row.dataset.recruiter})` : '';
    if (!window.confirm(`–û—Å–≤–æ–±–æ–¥–∏—Ç—å —Å–ª–æ—Ç #${id}${recruiterName} –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞? –ö–∞–Ω–¥–∏–¥–∞—Ç—É –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.`)) return;

    try {
      const response = await fetch(`/slots/${id}/reschedule`, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'X-CSRFToken': csrfToken,
        },
      });
      const payload = await response.json().catch(() => null);

      if (!response.ok || !payload || payload.ok !== true) {
        const message = payload && payload.message ? payload.message : '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Å–ª–æ—Ç.';
        toast(message, 'error');
        return;
      }

      toast(payload.message || '–°–ª–æ—Ç –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞', 'success');
      window.location.reload();
    } catch (err) {
      console.error(err);
      toast('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Å–ª–æ—Ç.', 'error');
      setError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Å–ª–æ—Ç.');
    }
  }

  async function performReject(row) {
    if (!row) return;
    const id = row.dataset.id;
    if (!id) return;

    const recruiterName = row.dataset.recruiter ? ` (${row.dataset.recruiter})` : '';
    if (!window.confirm(`–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å —Å–ª–æ—Ç–∞ #${id}${recruiterName}? –ö–∞–Ω–¥–∏–¥–∞—Ç—É –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.`)) return;

    try {
      const response = await fetch(`/slots/${id}/reject_booking`, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'X-CSRFToken': csrfToken,
        },
      });
      const payload = await response.json().catch(() => null);

      if (!response.ok || !payload || payload.ok !== true) {
        const message = payload && payload.message ? payload.message : '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å.';
        toast(message, 'error');
        return;
      }

      toast(payload.message || '–ë—Ä–æ–Ω—å –æ—Ç–º–µ–Ω–µ–Ω–∞', 'success');
      window.location.reload();
    } catch (err) {
      console.error(err);
      toast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å.', 'error');
      setError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å.');
    }
  }

  async function performSetOutcome(row, outcome) {
    if (!row || !outcome) return;
    const id = row.dataset.id;
    if (!id) return;

    const recruiterName = row.dataset.recruiter ? ` (${row.dataset.recruiter})` : '';
    const outcomeLabel = outcome === 'attended' ? '—è–≤–∫—É' : '–Ω–µ—è–≤–∫—É';
    if (!window.confirm(`–û—Ç–º–µ—Ç–∏—Ç—å ${outcomeLabel} –¥–ª—è —Å–ª–æ—Ç–∞ #${id}${recruiterName}?`)) return;

    try {
      const response = await fetch(`/slots/${id}/outcome`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({ outcome }),
      });
      const payload = await response.json().catch(() => null);

      if (!response.ok || !payload || payload.ok !== true) {
        const message = payload && payload.message ? payload.message : '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.';
        toast(message, 'error');
        return;
      }

      toast(payload.message || '–†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±–Ω–æ–≤–ª—ë–Ω', 'success');
      window.location.reload();
    } catch (err) {
      console.error(err);
      toast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.', 'error');
      setError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.');
    }
  }

  function showDeleteAllModal() {
    if (!deleteAllModal) return;
    const deletableCount = rows.filter(row => {
      const status = row.dataset.status;
      return !row.hidden && (status === 'FREE' || status === 'PENDING');
    }).length;
    if (slotsCountEl) slotsCountEl.textContent = deletableCount;
    deleteAllModal.showModal();
  }
  function closeDeleteAllModal() {
    if (deleteAllModal) deleteAllModal.close();
  }

  async function deleteAllSlots(force = false) {
    closeDeleteAllModal();
    if (deleteAllBtn) deleteAllBtn.disabled = true;
    try {
      const response = await fetch('/slots/delete_all', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({ force })
      });
      const payload = await response.json().catch(() => null);

      if (!response.ok || !payload || payload.ok !== true) {
        const message = payload && payload.error ? payload.error : '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç—ã.';
        if (!force && payload && typeof payload.remaining === 'number' && payload.remaining > 0) {
          const askForce = window.confirm(`${message} –£–¥–∞–ª–∏—Ç—å –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Å–ª–æ—Ç—ã –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ?`);
          if (askForce) {
            return await deleteAllSlots(true);
          }
        }
        toast(message, 'error');
        return;
      }

      const deletedCount = Number(payload.deleted || 0);
      const remaining = Number(payload.remaining || 0);

      if (!force && remaining > 0) {
        toast(`–£–¥–∞–ª–µ–Ω–æ ${deletedCount} —Å–ª–æ—Ç(–æ–≤). –û—Å—Ç–∞–ª–æ—Å—å ${remaining}.`, 'info');
        const askForce = window.confirm('–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–ª–æ—Ç—ã –æ—Å—Ç–∞–ª–∏—Å—å. –£–¥–∞–ª–∏—Ç—å –∏—Ö –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ?');
        if (askForce) {
          return await deleteAllSlots(true);
        }
        return;
      }

      toast(`–£–¥–∞–ª–µ–Ω–æ ${deletedCount} —Å–ª–æ—Ç(–æ–≤).`, 'success');
      window.location.reload();
    } catch (err) {
      console.error(err);
      toast('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç—ã.', 'error');
      setError('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç—ã.');
    } finally {
      if (deleteAllBtn) deleteAllBtn.disabled = false;
    }
  }

  function toggleDetails(row) {
    const details = detailMap.get(row.dataset.id);
    if (!details) return;
    const expanded = !details.hidden;
    details.hidden = expanded;
    row.classList.toggle('is-expanded', !expanded);
  }

  function updateSelectionUI() {
    rows.forEach(row => {
      const checked = selectedIds.has(row.dataset.id);
      row.classList.toggle('is-selected', checked);
      const checkbox = row.querySelector('.row-select');
      if (checkbox) checkbox.checked = checked;
    });
    if (selectAll) {
      const visibleRows = rows.filter(r => !r.hidden);
      const allSelected = visibleRows.length && visibleRows.every(r => selectedIds.has(r.dataset.id));
      selectAll.indeterminate = selectedIds.size > 0 && !allSelected;
      selectAll.checked = allSelected;
    }
    if (deleteSelectedBtn) {
      deleteSelectedBtn.disabled = selectedIds.size === 0;
      deleteSelectedBtn.textContent = selectedIds.size ? `–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ (${selectedIds.size})` : '–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ';
    }
    if (exportBtn) {
      exportBtn.textContent = selectedIds.size ? `–≠–∫—Å–ø–æ—Ä—Ç (${selectedIds.size})` : '–≠–∫—Å–ø–æ—Ä—Ç';
    }
  }

  function handleSelection(row, checked) {
    if (!row || !row.dataset.id) return;
    if (checked) {
      selectedIds.add(row.dataset.id);
    } else {
      selectedIds.delete(row.dataset.id);
    }
    updateSelectionUI();
  }

  async function deleteSelected() {
    if (!selectedIds.size) return;
    const confirmText = selectedIds.size === 1
      ? '–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–ª–æ—Ç?'
      : `–£–¥–∞–ª–∏—Ç—å ${selectedIds.size} –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–ª–æ—Ç–∞?`;
    if (!window.confirm(confirmText)) return;
    for (const id of Array.from(selectedIds)) {
      const row = rows.find(r => r.dataset.id === id);
      if (row) {
        // Force delete only for non deletable rows if user confirms inside performDelete.
        await performDelete(row, { skipConfirm: true });
      }
    }
    updateSelectionUI();
  }

  function exportSlots() {
    const sourceRows = selectedIds.size ? rows.filter(r => selectedIds.has(r.dataset.id)) : rows.filter(r => !r.hidden);
    if (!sourceRows.length) {
      toast('–ù–µ—Ç —Å—Ç—Ä–æ–∫ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'info');
      return;
    }
    const headers = ['id','slot_time','city','city_tz','recruiter','candidate','status','tg_id','username'];
    const lines = [headers.join(',')];
    sourceRows.forEach(row => {
      const data = [
        row.dataset.id,
        row.querySelector('.slot-time__primary')?.textContent?.trim() || '',
        row.dataset.city || '',
        row.dataset.cityTz || '',
        row.dataset.recruiter || '',
        row.dataset.candidate || 'FREE',
        row.dataset.status || '',
        row.dataset.candidateId || '',
        row.dataset.candidateUsername || '',
      ];
      lines.push(data.map(val => `"${String(val || '').replace(/"/g, '""')}"`).join(','));
    });
    const blob = new Blob([lines.join('\\n')], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const date = new Date().toISOString().split('T')[0];
    link.download = `slots_${date}.csv`;
    link.href = URL.createObjectURL(blob);
    link.click();
    URL.revokeObjectURL(link.href);
  }

  function setStatusFilter(status) {
    filters.status = (status || '').toUpperCase();
    if (filterStatusInput) filterStatusInput.value = filters.status;
    statusTabs.forEach(btn => {
      const active = (btn.dataset.status || '').toUpperCase() === filters.status || (!filters.status && !btn.dataset.status);
      btn.classList.toggle('is-active', active);
      btn.setAttribute('aria-pressed', active ? 'true' : 'false');
    });
    summaryChips.forEach(ch => {
      const active = (ch.dataset.status || '').toUpperCase() === filters.status || (!filters.status && !ch.dataset.status);
      ch.classList.toggle('slot-chip--active', active);
    });
    scheduleFilter();
  }

  function setDatePreset(preset) {
    filters.datePreset = preset;
    dateShortcuts.forEach(btn => {
      const active = btn.dataset.date === preset;
      btn.classList.toggle('is-active', active);
    });
    if (preset === 'range') {
      if (dateRange) dateRange.hidden = false;
    } else {
      if (dateRange) dateRange.hidden = true;
      filters.from = '';
      filters.to = '';
      if (dateFrom) dateFrom.value = '';
      if (dateTo) dateTo.value = '';
    }
  }

  const dateRange = $('#date_range');

  if (!table || !tbody) return;

  applySort();
  applySortIndicator();
  applyFilters();
  updateSelectionUI();
  if (relTimer) clearInterval(relTimer);
  relTimer = window.setInterval(updateRelativeLabels, 60000);

  on(tbody, 'click', e => {
    const deleteBtn = e.target.closest('[data-action="delete-slot"]');
    if (deleteBtn) {
      e.preventDefault();
      const row = resolveRowFromAction(deleteBtn);
      performDelete(row);
      return;
    }
    const rescheduleBtn = e.target.closest('[data-action="reschedule-booking"]');
    if (rescheduleBtn) {
      e.preventDefault();
      const row = resolveRowFromAction(rescheduleBtn);
      performReschedule(row);
      return;
    }
    const rejectBtn = e.target.closest('[data-action="reject-booking"]');
    if (rejectBtn) {
      e.preventDefault();
      const row = resolveRowFromAction(rejectBtn);
      performReject(row);
      return;
    }
    const outcomeBtn = e.target.closest('[data-action="set-outcome"]');
    if (outcomeBtn) {
      e.preventDefault();
      const row = resolveRowFromAction(outcomeBtn);
      performSetOutcome(row, outcomeBtn.dataset.outcome);
      return;
    }
    const row = e.target.closest('.slot-row');
    const isControl = e.target.closest('button, a, input, label');
    if (row && !isControl) {
      toggleDetails(row);
    }
  });

  on(calendarView, 'click', e => {
    const deleteBtn = e.target.closest('[data-action="delete-slot"]');
    if (deleteBtn) {
      e.preventDefault();
      const row = resolveRowFromAction(deleteBtn);
      performDelete(row);
      return;
    }
    const rescheduleBtn = e.target.closest('[data-action="reschedule-booking"]');
    if (rescheduleBtn) {
      e.preventDefault();
      const row = resolveRowFromAction(rescheduleBtn);
      performReschedule(row);
      return;
    }
    const rejectBtn = e.target.closest('[data-action="reject-booking"]');
    if (rejectBtn) {
      e.preventDefault();
      const row = resolveRowFromAction(rejectBtn);
      performReject(row);
      return;
    }
    const outcomeBtn = e.target.closest('[data-action="set-outcome"]');
    if (outcomeBtn) {
      e.preventDefault();
      const row = resolveRowFromAction(outcomeBtn);
      performSetOutcome(row, outcomeBtn.dataset.outcome);
      return;
    }
  });

  on(tbody, 'change', e => {
    const checkbox = e.target.closest('.row-select');
    if (checkbox) {
      const row = checkbox.closest('.slot-row');
      handleSelection(row, checkbox.checked);
    }
  });

  on(table, 'click', e => {
    const sortButton = e.target.closest('.sort');
    if (!sortButton) return;
    const key = sortButton.dataset.key;
    if (!key) return;
    if (sortState.key === key) {
      sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
    } else {
      sortState.key = key;
      sortState.dir = 'asc';
    }
    applySort();
    applySortIndicator();
    applyFilters();
  });

  on(searchInput, 'input', e => {
    filters.search = (e.target.value || '').trim().toLowerCase();
    scheduleFilter();
  });
  on(filterCity, 'change', e => {
    filters.city = e.target.value;
    scheduleFilter();
  });
  on(filterRecruiter, 'change', e => {
    filters.recruiter = e.target.value;
    scheduleFilter();
  });
  on(dateFrom, 'change', e => {
    filters.from = e.target.value;
    filters.datePreset = 'range';
    setDatePreset('range');
    scheduleFilter();
  });
  on(dateTo, 'change', e => {
    filters.to = e.target.value;
    filters.datePreset = 'range';
    setDatePreset('range');
    scheduleFilter();
  });

  dateShortcuts.forEach(btn => {
    on(btn, 'click', () => {
      setDatePreset(btn.dataset.date);
      filters.datePreset = btn.dataset.date;
      scheduleFilter();
    });
  });

  statusTabs.forEach(btn => {
    on(btn, 'click', () => setStatusFilter(btn.dataset.status));
  });
  summaryChips.forEach(chip => {
    on(chip, 'click', (e) => {
      e.preventDefault();
      setStatusFilter(chip.dataset.status || '');
    });
  });

  on(applyFiltersBtn, 'click', () => scheduleFilter());
  clearButtons.forEach(btn => on(btn, 'click', () => resetFilters()));

  on(selectAll, 'change', e => {
    const checked = e.target.checked;
    rows.forEach(row => {
      if (row.hidden) return;
      if (checked) selectedIds.add(row.dataset.id);
      else selectedIds.delete(row.dataset.id);
    });
    updateSelectionUI();
  });

  on(moreActionsBtn, 'click', e => {
    e.stopPropagation();
    toggleDropdown();
  });
  on(document, 'click', e => {
    if (!moreActionsMenu || moreActionsMenu.hidden) return;
    if (!e.target.closest('.dropdown-menu-wrapper')) {
      closeDropdown();
    }
  });

  on(deleteAllBtn, 'click', () => {
    closeDropdown();
    showDeleteAllModal();
  });
  on(deleteSelectedBtn, 'click', () => {
    closeDropdown();
    deleteSelected();
  });
  on(exportBtn, 'click', () => {
    closeDropdown();
    exportSlots();
  });

  on(modalClose, 'click', closeDeleteAllModal);
  on(modalCancel, 'click', closeDeleteAllModal);
  on(modalConfirm, 'click', () => deleteAllSlots(false));
  on(reloadBtn, 'click', () => window.location.reload());

  startNotificationFeed();
})();
</script>
{% endblock %}
