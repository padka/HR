{% extends "base.html" %}
{% block title %}Слоты{% endblock %}
{% block content %}
<section class="slots-page flex flex-col gap-8" data-page="slots" aria-labelledby="slots-title">
  <header class="slots-header rounded-2xl border border-border bg-bg-elev1/70 p-6 shadow-glass backdrop-blur">
    <div class="flex flex-col gap-6 lg:flex-row lg:items-start lg:justify-between">
      <div class="flex flex-col gap-4">
        <div class="flex flex-wrap items-center gap-3">
          <h1 id="slots-title" class="text-3xl font-semibold tracking-tight text-fg-primary">Слоты</h1>
          {% if last_updated_at %}
            <span class="text-sm text-fg-muted" aria-live="polite">
              Обновлено {{ fmt_local(last_updated_at, 'Europe/Moscow') }}
            </span>
          {% endif %}
        </div>
        <p class="max-w-2xl text-sm text-fg-muted">
          Управляйте расписанием интервью в табличном представлении: фильтры и сортировка доступны из заголовков колонок и верхней панели.
        </p>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <button type="button" class="slots-btn slots-btn--ghost" data-action="refresh-slots">
          <span aria-hidden="true">⟳</span>
          <span>Обновить</span>
        </button>
        <a class="slots-btn slots-btn--primary" href="/slots/new">
          <span aria-hidden="true">＋</span>
          Создать слот
        </a>
      </div>
    </div>
    <dl class="slots-kpis" role="list">
      {% for card in status_cards %}
        <div class="slots-kpis__item" role="listitem">
          <dt class="slots-kpis__label">{{ card.label }}</dt>
          <dd class="slots-kpis__value">{{ card.value }}</dd>
          <p class="slots-kpis__hint">{{ card.hint }}</p>
        </div>
      {% endfor %}
    </dl>
  </header>

  <section class="slots-filters" aria-label="Фильтры слотов">
    <form id="slots_filters" class="slots-filters__form" method="get">
      <div class="slots-filters__grid">
        <label class="slots-field">
          <span class="slots-field__label">Город</span>
          <select id="filter_city" name="city_id" class="slots-select">
            <option value="">Все</option>
            {% for city in city_options %}
              <option value="{{ city.id }}" {% if filter_city_id == city.id %}selected{% endif %}>{{ city.name }}</option>
            {% endfor %}
          </select>
        </label>
        <div class="slots-field">
          <span class="slots-field__label">Дата</span>
          <div class="slots-field__range">
            <input id="filter_date_from" name="date_from" type="date" value="{{ filter_date_from or '' }}" class="slots-input" aria-label="Дата с">
            <span aria-hidden="true">—</span>
            <input id="filter_date_to" name="date_to" type="date" value="{{ filter_date_to or '' }}" class="slots-input" aria-label="Дата по">
          </div>
        </div>
        <label class="slots-field">
          <span class="slots-field__label">Рекрутер</span>
          <select id="filter_recruiter" name="recruiter_id" class="slots-select">
            <option value="">Все</option>
            {% for rec in recruiter_options %}
              <option value="{{ rec.id }}" {% if filter_recruiter_id == rec.id %}selected{% endif %}>{{ rec.name }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="slots-field">
          <span class="slots-field__label">Статус</span>
          <select id="filter_status" name="status" multiple size="4" class="slots-select slots-select--multiple" aria-describedby="filter_status_hint">
            {% set status_labels = {'Free':'Свободно','Booked':'Забронировано','Cancelled':'Отменено','Expired':'Прошло'} %}
            {% for key, label in status_labels.items() %}
              <option value="{{ key }}" {% if key in filter_statuses %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
          <p id="filter_status_hint" class="slots-field__hint">Удерживайте Ctrl/⌘ для мультивыбора</p>
        </label>
        <label class="slots-field">
          <span class="slots-field__label">Поиск</span>
          <input id="filter_search" name="search" value="{{ search_query or '' }}" class="slots-input" placeholder="ФИО или телефон">
        </label>
      </div>
      <div class="slots-filters__actions">
        <div id="slots_filter_chips" class="slots-filter-chips" aria-live="polite">
          {% set active_filters = [] %}
          {% if filter_city_id %}
            {% set active_filters = active_filters + [{'key':'city_id','label': city_options|selectattr('id','equalto',filter_city_id)|map(attribute='name')|list|first or 'Город'}] %}
          {% endif %}
          {% for status_label in filter_statuses %}
            {% set display = status_labels.get(status_label, status_label) %}
            {% set active_filters = active_filters + [{'key':'status','value':status_label,'label':display}] %}
          {% endfor %}
          {% if filter_date_from %}
            {% set active_filters = active_filters + [{'key':'date_from','label':'с ' ~ (filter_date_from|replace('-', '.'))}] %}
          {% endif %}
          {% if filter_date_to %}
            {% set active_filters = active_filters + [{'key':'date_to','label':'по ' ~ (filter_date_to|replace('-', '.'))}] %}
          {% endif %}
          {% if filter_recruiter_id %}
            {% set rec_label = recruiter_options | selectattr('id','equalto',filter_recruiter_id) | map(attribute='name') | list | first %}
            {% set active_filters = active_filters + [{'key':'recruiter_id','label': rec_label or ('ID ' ~ filter_recruiter_id)}] %}
          {% endif %}
          {% for token in search_tokens %}
            {% set active_filters = active_filters + [{'key':'search','value':token,'label':token}] %}
          {% endfor %}
          {% if active_filters %}
            {% for chip in active_filters %}
              <button type="button" class="slots-chip" data-chip-key="{{ chip.key }}" {% if chip.value %}data-chip-value="{{ chip.value }}"{% endif %}>
                <span>{{ chip.label }}</span>
                <span aria-hidden="true">✕</span>
              </button>
            {% endfor %}
          {% else %}
            <p class="text-sm text-fg-muted">Фильтры не выбраны.</p>
          {% endif %}
        </div>
        <div class="flex items-center gap-2">
          <button type="submit" class="slots-btn slots-btn--primary">Применить</button>
          <button type="button" class="slots-btn slots-btn--ghost" data-action="reset-filters">Сбросить</button>
        </div>
      </div>
    </form>
  </section>

  <div class="slots-table-card rounded-2xl border border-border bg-bg-elev1/70 shadow-glass">
    {% if table_slots %}
      <div class="slots-table-scroll" role="region" aria-labelledby="slots-title">
        <table id="slots_table" class="slots-table" role="grid">
          <thead class="slots-table__head">
            <tr>
              <th scope="col">
                <div class="slots-column">
                  <span>Дата и время</span>
                  <button type="button" class="slots-inline-filter" data-inline-filter="filter_date_from" aria-label="Фильтр по дате">
                    ⌄
                  </button>
                </div>
              </th>
              <th scope="col">
                <div class="slots-column">
                  <span>Город</span>
                  <button type="button" class="slots-inline-filter" data-inline-filter="filter_city" aria-label="Фильтр по городу">⌄</button>
                </div>
              </th>
              <th scope="col">
                <div class="slots-column">
                  <span>Рекрутер</span>
                  <button type="button" class="slots-inline-filter" data-inline-filter="filter_recruiter" aria-label="Фильтр по рекрутеру">⌄</button>
                </div>
              </th>
              <th scope="col">
                <div class="slots-column">
                  <span>Кандидат</span>
                  <button type="button" class="slots-inline-filter" data-inline-filter="filter_search" aria-label="Фильтр по кандидату">⌄</button>
                </div>
              </th>
              <th scope="col">
                <div class="slots-column">
                  <span>Статус</span>
                  <button type="button" class="slots-inline-filter" data-inline-filter="filter_status" aria-label="Фильтр по статусу">⌄</button>
                </div>
              </th>
              <th scope="col" class="text-right">Действия</th>
            </tr>
          </thead>
          <tbody id="slots_tbody">
            {% for slot in table_slots %}
              {% set city = slot.city %}
              {% set recruiter = slot.recruiter %}
              {% set candidate = slot.candidate %}
              <tr class="slots-row" data-slot-id="{{ slot.id }}">
                <td data-label="Дата и время">
                  <div class="slots-cell-time">
                    <time datetime="{{ slot.start_at.isoformat() }}">{{ fmt_local(slot.start_at, 'Europe/Moscow') }}</time>
                    <span class="slots-cell-sub">→ {{ fmt_local(slot.end_at, 'Europe/Moscow') }}</span>
                  </div>
                </td>
                <td data-label="Город">
                  <span>{{ city.name if city else '—' }}</span>
                </td>
                <td data-label="Рекрутер">
                  <span>{{ recruiter.name if recruiter else '—' }}</span>
                </td>
                <td data-label="Кандидат">
                  <div class="slots-cell-candidate">
                    <span class="slots-cell-main">{{ candidate.full_name or '—' }}</span>
                    {% set candidate_detail = candidate.phone or candidate.email or candidate.notes %}
                    <span class="slots-cell-sub" {% if not candidate_detail %}hidden{% endif %}>{{ candidate_detail or '' }}</span>
                  </div>
                </td>
                <td data-label="Статус">
                  {% set status = slot.status or 'Free' %}
                  <span class="slots-status slots-status--{{ status|lower }}">{{ status }}</span>
                </td>
                <td data-label="Действия" class="text-right">
                  <button type="button" class="slots-btn slots-btn--ghost" data-slot-detail="{{ slot.id }}">Подробнее</button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="slots-empty" role="status">
        <p class="slots-empty__title">Слоты не найдены</p>
        <p class="slots-empty__hint">Попробуйте изменить фильтры или создайте новый слот вручную.</p>
        <a class="slots-btn slots-btn--primary" href="/slots/new">Создать слот</a>
      </div>
    {% endif %}
  </div>
</section>

<div id="slot_modal" class="slots-modal" role="dialog" aria-modal="true" aria-labelledby="slot_modal_title" hidden>
  <div class="slots-modal__backdrop" data-modal-dismiss></div>
  <div class="slots-modal__content" role="document">
    <header class="slots-modal__header">
      <div>
        <h2 id="slot_modal_title" class="slots-modal__title">Слот</h2>
        <p id="slot_modal_subtitle" class="slots-modal__subtitle text-sm text-fg-muted"></p>
      </div>
      <button type="button" class="slots-modal__close" data-modal-dismiss aria-label="Закрыть модалку">✕</button>
    </header>
    <form id="slot_candidate_form" class="slots-modal__form">
      <div class="slots-modal__fieldset">
        <label class="slots-field">
          <span class="slots-field__label">ФИО кандидата</span>
          <input type="text" name="full_name" class="slots-input" autocomplete="name">
        </label>
        <label class="slots-field">
          <span class="slots-field__label">Телефон</span>
          <input type="tel" name="phone" class="slots-input" autocomplete="tel">
        </label>
        <label class="slots-field">
          <span class="slots-field__label">Email</span>
          <input type="email" name="email" class="slots-input" autocomplete="email">
        </label>
        <label class="slots-field">
          <span class="slots-field__label">Заметки</span>
          <textarea name="notes" rows="3" class="slots-textarea"></textarea>
        </label>
        <label class="slots-checkbox">
          <input type="checkbox" name="booking_confirmed">
          <span>Бронь подтверждена</span>
        </label>
      </div>
      <footer class="slots-modal__footer">
        <div class="flex items-center gap-2">
          <button type="submit" class="slots-btn slots-btn--primary">Сохранить</button>
          <button type="button" class="slots-btn slots-btn--ghost" data-action="slot-restore" hidden>Вернуть</button>
          <button type="button" class="slots-btn slots-btn--danger" data-action="slot-cancel">Отменить слот</button>
        </div>
        <button type="button" class="slots-btn slots-btn--ghost" data-modal-dismiss>Закрыть</button>
      </footer>
    </form>
  </div>
</div>
<div id="slot_toast" class="slots-toast" role="status" aria-live="polite"></div>
<div id="slots_loading" class="slots-skeleton" hidden>Загрузка…</div>

<script type="application/json" id="slots_context">{{ {
  'slots': slots_payload,
  'filters': slots_filters,
  'statusLabels': {
    'Free': 'Свободно',
    'Booked': 'Забронировано',
    'Cancelled': 'Отменено',
    'Expired': 'Прошло'
  }
} | tojson }}</script>
<script type="module" src="{{ url_for('static', path='js/modules/slots-notion.js') }}"></script>
{% endblock %}
