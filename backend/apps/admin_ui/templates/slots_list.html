{% extends "base.html" %}
{% block title %}Слоты{% endblock %}
{% block content %}
{% set has_slots = slots|length > 0 %}
{% set status_labels = {
  'FREE': 'Свободные',
  'PENDING': 'Ожидают',
  'BOOKED': 'Забронированы',
  'CONFIRMED_BY_CANDIDATE': 'Подтверждены',
  'CANCELED': 'Отменены'
} %}
{% set purpose_labels = {
  'interview': 'Интервью',
  'intro_day': 'Intro Day',
  'screening': 'Скрининг'
} %}
{% set filter_tags = [] %}
{% if filter_recruiter_id %}
  {% set recruiter_label = (recruiter_options | selectattr('id', 'equalto', filter_recruiter_id) | map(attribute='name') | list | first) %}
  {% set filter_tags = filter_tags + [{'key': 'recruiter_id', 'label': recruiter_label or ('ID ' ~ filter_recruiter_id)}] %}
{% endif %}
{% if filter_status %}
  {% set filter_tags = filter_tags + [{'key': 'status', 'label': status_labels.get(filter_status, filter_status)}] %}
{% endif %}
{% if filter_city_id %}
  {% set city_label = (city_options | selectattr('id', 'equalto', filter_city_id) | map(attribute='name') | list | first) %}
  {% set filter_tags = filter_tags + [{'key': 'city_id', 'label': city_label or ('ID ' ~ filter_city_id)}] %}
{% endif %}
{% if filter_purpose %}
  {% set purpose_label = purpose_labels.get(filter_purpose, filter_purpose) %}
  {% set filter_tags = filter_tags + [{'key': 'purpose', 'label': purpose_label}] %}
{% endif %}
{% if filter_date %}
  {% set filter_tags = filter_tags + [{'key': 'date', 'label': (filter_date | replace('-', '.'))}] %}
{% endif %}
{% for token in search_tokens %}
  {% set filter_tags = filter_tags + [{'key': 'search', 'label': token}] %}
{% endfor %}
{% set view_mode = (active_view or 'table') %}
{% set status_summary = [
  {'key': 'total', 'label': 'Всего', 'value': status_counts.total, 'tone': 'muted', 'hint': 'Все слоты'},
  {'key': 'free', 'label': 'Свободно', 'value': status_counts.FREE, 'tone': 'success', 'hint': 'доступно к брони'},
  {'key': 'booked', 'label': 'Занято', 'value': status_counts.BOOKED, 'tone': 'progress', 'hint': 'уже назначено'},
  {'key': 'pending', 'label': 'В ожидании', 'value': status_counts.PENDING, 'tone': 'warning', 'hint': 'ждёт ответа'},
  {'key': 'canceled', 'label': 'Отменено', 'value': status_counts.CANCELED, 'tone': 'danger', 'hint': 'отменённые брони'}
] %}
<section class="flex flex-col gap-6" data-page="slots" aria-labelledby="slots-title">
  <header class="rounded-2xl border border-border bg-bg-elev1/70 p-6 shadow-glass backdrop-blur glass" data-section="page-header">
    <div class="flex flex-col gap-6 xl:flex-row xl:items-start xl:justify-between">
      <div class="flex flex-col gap-4">
        <div class="flex flex-col gap-2">
          <p class="text-sm font-medium uppercase tracking-wide text-fg-muted">Расписание интервью</p>
          <div class="flex flex-wrap items-center gap-3">
            <h1 id="slots-title" class="text-3xl font-semibold tracking-tight text-fg-primary">Слоты</h1>
            {% if last_updated_at %}
              <div class="flex items-center gap-2 text-sm text-fg-muted" aria-live="polite">
                <span class="inline-flex h-6 w-6 items-center justify-center rounded-full border border-border bg-bg-elev2 text-xs">
                  ⟳
                </span>
                <time datetime="{{ last_updated_at.isoformat() }}">Обновлено {{ fmt_local(last_updated_at, 'Europe/Moscow') }}</time>
              </div>
            {% endif %}
          </div>
          <p class="max-w-2xl text-sm text-fg-muted">Отслеживайте занятость, свободные окна и быстро управляйте слотами — фильтры синхронизированы с URL и готовы к шарингу.</p>
        </div>
        <dl class="grid gap-3 sm:grid-cols-3 lg:grid-cols-5" role="list">
          {% for card in status_summary %}
            <div class="rounded-xl border border-border/80 bg-bg-elev2/60 p-4 shadow-sm" role="listitem">
              <dt class="flex items-center justify-between text-xs font-semibold uppercase tracking-wide text-fg-muted">
                {{ card.label }}
                <span class="inline-flex items-center rounded-full bg-bg-elev3 px-2 py-0.5 text-[11px] font-medium text-fg-muted">{{ card.hint }}</span>
              </dt>
              <dd class="mt-2 text-2xl font-semibold text-fg-primary" id="cnt-{{ card.key }}">{{ card.value }}</dd>
            </div>
          {% endfor %}
        </dl>
      </div>
      <div class="flex flex-wrap items-center justify-end gap-2">
        <button type="button" class="inline-flex items-center gap-2 rounded-md border border-border bg-bg-elev2 px-3 py-2 text-sm font-medium shadow-sm transition hover:bg-bg-elev3 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info" data-action="refresh-slots">
          <span class="sr-only">Обновить список</span>
          ⟳
          <span aria-hidden="true">Обновить</span>
        </button>
        <button type="button" class="inline-flex items-center gap-2 rounded-md border border-border bg-bg-elev2 px-3 py-2 text-sm font-medium shadow-sm transition hover:bg-bg-elev3 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info" data-action="export-slots">
          <span aria-hidden="true">⇩</span>
          Экспорт CSV
        </button>
        <a class="inline-flex items-center gap-2 rounded-md bg-accent px-3 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-accent-strong focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info" href="/slots/new">
          <span aria-hidden="true">＋</span>
          Новый слот
        </a>
      </div>
    </div>
  </header>

  <div class="rounded-2xl border border-border bg-bg-elev1/70 p-6 shadow-glass" data-section="filters">
    <div class="grid gap-4 lg:grid-cols-[1.5fr_1fr] lg:items-start">
      <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-3" id="slots_quick_filters">
        <label class="flex flex-col gap-1 text-sm font-medium text-fg-primary">
          Город
          <select id="filter_city" class="h-11 rounded-lg border border-border bg-bg-elev2 px-3 text-sm shadow-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info">
            <option value="">Все</option>
            {% for city in city_options %}
              <option value="{{ city.id }}" {% if filter_city_id == city.id %}selected{% endif %}>{{ city.name }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="flex flex-col gap-1 text-sm font-medium text-fg-primary">
          Дата
          <input type="date" id="filter_date" value="{{ filter_date or '' }}" class="h-11 rounded-lg border border-border bg-bg-elev2 px-3 text-sm shadow-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info">
        </label>
        <label class="flex flex-col gap-1 text-sm font-medium text-fg-primary">
          Статус
          <select id="filter_status" class="h-11 rounded-lg border border-border bg-bg-elev2 px-3 text-sm shadow-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info">
            <option value="">Любой</option>
            {% for code, label in status_labels.items() %}
              <option value="{{ code }}" {% if filter_status == code %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="flex flex-col gap-1 text-sm font-medium text-fg-primary">
          Рекрутер
          <select id="filter_recruiter" class="h-11 rounded-lg border border-border bg-bg-elev2 px-3 text-sm shadow-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info">
            <option value="">Все</option>
            {% for rec in recruiter_options %}
              <option value="{{ rec.id }}" {% if filter_recruiter_id == rec.id %}selected{% endif %}>{{ rec.name }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="flex flex-col gap-1 text-sm font-medium text-fg-primary">
          Тип слота
          <select id="filter_purpose" class="h-11 rounded-lg border border-border bg-bg-elev2 px-3 text-sm shadow-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info">
            <option value="">Все</option>
            {% for item in purpose_options %}
              {% set key = item %}
              <option value="{{ key }}" {% if filter_purpose == key %}selected{% endif %}>{{ purpose_labels.get(key, key | capitalize) }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="flex flex-col gap-1 text-sm font-medium text-fg-primary">
          Вид
          <div class="flex h-11 items-center rounded-lg border border-border bg-bg-elev2 text-sm shadow-sm">
            <button type="button" data-view-toggle="table" class="flex-1 rounded-lg px-3 py-2 text-sm font-medium transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info {% if view_mode == 'table' %}bg-bg-elev3 text-fg-primary{% else %}text-fg-muted{% endif %}">Таблица</button>
            <button type="button" data-view-toggle="cards" class="flex-1 rounded-lg px-3 py-2 text-sm font-medium transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info {% if view_mode == 'cards' %}bg-bg-elev3 text-fg-primary{% else %}text-fg-muted{% endif %}">Карточки</button>
          </div>
        </label>
      </div>
      <div class="flex flex-col gap-3" data-role="search">
        <label class="flex flex-col gap-1 text-sm font-medium text-fg-primary">
          Поиск по кандидату или комментариям
          <div class="flex h-11 items-center rounded-lg border border-border bg-bg-elev2 px-3 text-sm shadow-sm focus-within:outline focus-within:outline-2 focus-within:outline-offset-2 focus-within:outline-info">
            <div class="flex flex-wrap items-center gap-2 overflow-hidden" id="slots_search_tokens" aria-live="polite"></div>
            <input type="text" id="slots_search_input" value="" class="ml-auto flex-1 border-none bg-transparent text-sm outline-none placeholder:text-fg-muted" placeholder="Добавьте токен и нажмите Enter" autocomplete="off">
          </div>
        </label>
        <div class="flex flex-wrap items-center gap-2" id="slots_active_tags" aria-live="polite">
          {% for tag in filter_tags %}
            <button type="button" class="inline-flex items-center gap-1 rounded-full border border-border bg-bg-elev2 px-3 py-1 text-xs font-medium text-fg-primary transition hover:bg-bg-elev3 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info" data-remove-filter="{{ tag.key }}" data-token-label="{{ tag.label }}">
              <span>{{ tag.label }}</span>
              <span aria-hidden="true">×</span>
              <span class="sr-only">Сбросить {{ tag.label }}</span>
            </button>
          {% endfor %}
          <button type="button" class="inline-flex items-center gap-2 rounded-full border border-dashed border-border px-3 py-1 text-xs font-medium text-fg-muted transition hover:text-fg-primary focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info" data-action="reset-filters">
            Сбросить фильтры
          </button>
        </div>
      </div>
    </div>
    <div class="mt-6 flex flex-wrap items-center gap-4">
      <label class="flex items-center gap-2 text-sm text-fg-muted">
        <input type="checkbox" id="slots_only_future" class="h-4 w-4 rounded border-border text-accent focus:ring-2 focus:ring-info" {% if only_future %}checked{% endif %}>
        Только будущие
      </label>
      <div class="flex items-center gap-2" role="group" aria-label="Роль времени">
        <button type="button" class="inline-flex items-center gap-2 rounded-md border border-border px-3 py-1.5 text-sm font-medium transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info {% if time_role == 'recruiter' %}bg-bg-elev3 text-fg-primary{% else %}bg-bg-elev2 text-fg-muted{% endif %}" data-role-target="recruiter">Время рекрутера</button>
        <button type="button" class="inline-flex items-center gap-2 rounded-md border border-border px-3 py-1.5 text-sm font-medium transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info {% if time_role == 'candidate' %}bg-bg-elev3 text-fg-primary{% else %}bg-bg-elev2 text-fg-muted{% endif %}" data-role-target="candidate">Время кандидата</button>
      </div>
      <div class="ml-auto flex items-center gap-2 text-sm">
        <label for="per_page" class="text-fg-muted">На странице</label>
        <select id="per_page" name="per_page" class="h-10 rounded-lg border border-border bg-bg-elev2 px-3 text-sm shadow-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info">
          {% for n in [20, 50, 100, 200, 500] %}
            <option value="{{ n }}" {% if per_page == n %}selected{% endif %}>{{ n }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <div class="rounded-2xl border border-border bg-bg-elev1/70 shadow-glass" data-section="slots-data">
    <div class="flex items-center justify-between gap-3 border-b border-border/60 px-6 py-4 text-sm text-fg-muted" id="slots_meta_bar">
      <span>Найдено: <strong>{{ status_counts.total }}</strong></span>
      <div class="flex items-center gap-2">
        <span>Страница {{ page }} из {{ pages_total }}</span>
        {% set query_parts = [] %}
        {% if filter_recruiter_id %}{% set query_parts = query_parts + ['recruiter_id=' ~ filter_recruiter_id] %}{% endif %}
        {% if filter_status %}{% set query_parts = query_parts + ['status=' ~ filter_status] %}{% endif %}
        {% if filter_city_id %}{% set query_parts = query_parts + ['city_id=' ~ filter_city_id] %}{% endif %}
        {% if filter_purpose %}{% set query_parts = query_parts + ['purpose=' ~ filter_purpose] %}{% endif %}
        {% if filter_date %}{% set query_parts = query_parts + ['date=' ~ filter_date] %}{% endif %}
        {% if per_page %}{% set query_parts = query_parts + ['per_page=' ~ per_page] %}{% endif %}
        {% if only_future %}{% set query_parts = query_parts + ['future=1'] %}{% endif %}
        {% if view_mode != 'table' %}{% set query_parts = query_parts + ['view=' ~ view_mode] %}{% endif %}
        {% if time_role != 'recruiter' %}{% set query_parts = query_parts + ['role=' ~ time_role] %}{% endif %}
        {% for token in search_tokens %}{% set query_parts = query_parts + ['search=' ~ token|urlencode] %}{% endfor %}
        {% set base_query = query_parts | join('&') %}
        <nav class="flex items-center gap-1" aria-label="Пагинация">
          {% if page > 1 %}
            <a class="inline-flex items-center rounded-md border border-border px-2 py-1 text-xs text-fg-primary transition hover:bg-bg-elev2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info" href="?page=1{% if base_query %}&{{ base_query }}{% endif %}">« Первая</a>
            <a class="inline-flex items-center rounded-md border border-border px-2 py-1 text-xs text-fg-primary transition hover:bg-bg-elev2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info" href="?page={{ page - 1 }}{% if base_query %}&{{ base_query }}{% endif %}">‹ Назад</a>
          {% else %}
            <span class="inline-flex items-center rounded-md px-2 py-1 text-xs text-fg-muted" aria-disabled="true">« Первая</span>
            <span class="inline-flex items-center rounded-md px-2 py-1 text-xs text-fg-muted" aria-disabled="true">‹ Назад</span>
          {% endif %}
          {% if page < pages_total %}
            <a class="inline-flex items-center rounded-md border border-border px-2 py-1 text-xs text-fg-primary transition hover:bg-bg-elev2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info" href="?page={{ page + 1 }}{% if base_query %}&{{ base_query }}{% endif %}">Вперёд ›</a>
            <a class="inline-flex items-center rounded-md border border-border px-2 py-1 text-xs text-fg-primary transition hover:bg-bg-elev2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info" href="?page={{ pages_total }}{% if base_query %}&{{ base_query }}{% endif %}">Последняя »</a>
          {% else %}
            <span class="inline-flex items-center rounded-md px-2 py-1 text-xs text-fg-muted" aria-disabled="true">Вперёд ›</span>
            <span class="inline-flex items-center rounded-md px-2 py-1 text-xs text-fg-muted" aria-disabled="true">Последняя »</span>
          {% endif %}
        </nav>
      </div>
    </div>

    <div class="relative" data-view="table" {% if view_mode != 'table' %}hidden{% endif %}>
      <div class="overflow-x-auto">
        <table class="min-w-full border-separate text-left text-sm" id="slots_table" style="border-spacing: 0">
          <caption class="sr-only">Таблица слотов</caption>
          <thead class="sticky top-0 z-10 bg-bg-elev1/95 backdrop-blur">
            <tr class="text-xs uppercase tracking-wide text-fg-muted">
              <th scope="col" class="w-10 px-4 py-3">
                <label class="inline-flex items-center">
                  <input type="checkbox" id="slots_select_all" class="h-4 w-4 rounded border-border text-accent focus:ring-2 focus:ring-info">
                  <span class="sr-only">Выбрать все слоты</span>
                </label>
              </th>
              <th scope="col" class="px-4 py-3">Слот</th>
              <th scope="col" class="px-4 py-3">Дата / время</th>
              <th scope="col" class="px-4 py-3">Кандидат</th>
              <th scope="col" class="px-4 py-3">Детали</th>
              <th scope="col" class="px-4 py-3 text-right">Действия</th>
            </tr>
          </thead>
          <tbody id="slots_tbody" class="divide-y divide-border/60 bg-bg-elev1">
            {% for s in slots %}
              {% set st = norm_status(s.status) %}
              {% set tz_rec = s.recruiter.tz if s.recruiter and s.recruiter.tz else 'Europe/Moscow' %}
              {% set cand_tz = s.candidate_tz %}
              {% set status_label = status_labels.get(st, st or '—') %}
              {% if st == 'FREE' %}
                {% set tone = 'success' %}
              {% elif st == 'PENDING' %}
                {% set tone = 'warning' %}
              {% elif st == 'BOOKED' %}
                {% set tone = 'progress' %}
              {% elif st == 'CONFIRMED_BY_CANDIDATE' %}
                {% set tone = 'success' %}
              {% elif st == 'CANCELED' %}
                {% set tone = 'danger' %}
              {% else %}
                {% set tone = 'muted' %}
              {% endif %}
              <tr class="slot-row transition hover:bg-bg-elev2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-[-4px] focus-visible:outline-info" tabindex="0"
                  data-id="{{ s.id }}"
                  data-status="{{ st or '' }}"
                  data-status-label="{{ status_label }}"
                  data-start-iso="{{ s.start_utc.isoformat() }}"
                  data-start-utc="{{ fmt_utc(s.start_utc) }}"
                  data-start-rec="{{ fmt_local(s.start_utc, tz_rec) }}"
                  data-start-cand="{{ fmt_local(s.start_utc, cand_tz) if cand_tz else '' }}"
                  data-recruiter="{{ s.recruiter.name if s.recruiter else '' }}"
                  data-recruiter-id="{{ s.recruiter.id if s.recruiter else '' }}"
                  data-recruiter-tz="{{ tz_rec }}"
                  data-city-id="{{ s.city.id if s.city else '' }}"
                  data-city-name="{{ s.city.name if s.city else '' }}"
                  data-city-tz="{{ tz_display(s.city.tz) if s.city else '' }}"
                  data-duration="{{ s.duration_min }}"
                  data-candidate="{{ s.candidate_fio or '' }}"
                  data-candidate-id="{{ s.candidate_tg_id or '' }}"
                  data-candidate-tz="{{ cand_tz or '' }}"
                  data-outcome="{{ s.interview_outcome or '' }}"
                  data-purpose="{{ s.purpose or '' }}"
                  data-can-delete="{{ 1 if st in ['FREE', 'PENDING'] else 0 }}">
                <td class="px-4 py-4 align-top">
                  <label class="inline-flex items-center gap-2">
                    <input type="checkbox" class="slot-select h-4 w-4 rounded border-border text-accent focus:ring-2 focus:ring-info" value="{{ s.id }}">
                    <span class="sr-only">Выбрать слот {{ s.id }}</span>
                  </label>
                </td>
                <td class="px-4 py-4 align-top">
                  <div class="flex flex-col gap-1 text-sm">
                    <div class="flex items-center gap-2">
                      <span class="rounded-full bg-bg-elev3 px-2 py-0.5 text-xs font-semibold text-fg-muted">ID {{ s.id }}</span>
                      <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold" data-badge="{{ tone }}">{{ status_label }}</span>
                    </div>
                    <div class="flex flex-wrap items-center gap-2 text-sm text-fg-muted">
                      <span>{{ s.recruiter.name if s.recruiter else 'Не назначен' }}</span>
                      {% if s.city %}
                        <span class="inline-flex items-center gap-1 rounded-full bg-bg-elev2 px-2 py-0.5 text-xs">{{ s.city.name }}</span>
                      {% else %}
                        <span class="text-fg-muted">Город не выбран</span>
                      {% endif %}
                    </div>
                  </div>
                </td>
                <td class="px-4 py-4 align-top text-sm text-fg-primary">
                  <div class="flex flex-col gap-1" data-role="time">
                    <span class="font-medium" data-role="time-primary">{{ fmt_local(s.start_utc, tz_rec) }}</span>
                    <span class="text-xs text-fg-muted" data-role="time-secondary">UTC {{ fmt_utc(s.start_utc) }}</span>
                    {% if cand_tz %}
                      <span class="text-xs text-fg-muted" data-role="time-candidate">{{ fmt_local(s.start_utc, cand_tz) }} · {{ tz_display(cand_tz) }}</span>
                    {% endif %}
                    <span class="text-xs text-fg-muted" data-role="deadline">—</span>
                  </div>
                </td>
                <td class="px-4 py-4 align-top text-sm">
                  {% if s.candidate_fio %}
                    <div class="flex flex-col gap-1">
                      <span class="font-medium">{{ s.candidate_fio }}</span>
                      <div class="flex flex-wrap items-center gap-2 text-xs text-fg-muted">
                        <span>tg_id: {{ s.candidate_tg_id or '—' }}</span>
                        {% if cand_tz %}<span>{{ tz_display(cand_tz) }}</span>{% endif %}
                      </div>
                      <button type="button" class="inline-flex w-fit items-center gap-2 rounded-md border border-border px-2 py-1 text-xs font-medium text-fg-primary transition hover:bg-bg-elev2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info" data-action="write-tg" data-tg-id="{{ s.candidate_tg_id or '' }}" {% if not s.candidate_tg_id %}disabled{% endif %}>Написать в TG</button>
                    </div>
                  {% else %}
                    <span class="text-sm text-fg-muted">Нет брони</span>
                  {% endif %}
                </td>
                <td class="px-4 py-4 align-top text-sm text-fg-muted">
                  <dl class="grid gap-1 text-xs">
                    <div><dt class="font-medium text-fg-primary">Длительность</dt><dd>{{ s.duration_min }} мин</dd></div>
                    <div><dt class="font-medium text-fg-primary">Часовой пояс</dt><dd>{{ tz_display(tz_rec) }}</dd></div>
                    <div><dt class="font-medium text-fg-primary">Тип</dt><dd>{{ purpose_labels.get(s.purpose, s.purpose or '—') }}</dd></div>
                  </dl>
                </td>
                <td class="px-4 py-4 align-top">
                  <div class="relative flex justify-end" data-role="menu">
                    <button type="button" class="slot-actions__trigger inline-flex items-center rounded-md border border-border bg-bg-elev2 px-2 py-1 text-sm font-medium text-fg-primary shadow-sm transition hover:bg-bg-elev3 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info" aria-haspopup="menu" aria-expanded="false">⋯</button>
                    <div class="slot-actions__menu absolute right-0 top-8 hidden min-w-[12rem] rounded-lg border border-border bg-bg-elev1 p-2 text-sm shadow-lg" role="menu">
                      <button type="button" class="slot-menu__item" data-action="open-slot" role="menuitem">Подробнее</button>
                      <button type="button" class="slot-menu__item" data-action="duplicate-slot" role="menuitem">Дублировать</button>
                      <button type="button" class="slot-menu__item" data-action="copy-slot" role="menuitem">Скопировать ссылку</button>
                      <button type="button" class="slot-menu__item text-danger" data-action="delete-slot" role="menuitem">Удалить</button>
                    </div>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div id="slots_table_empty" class="px-6 py-10 text-center text-sm text-fg-muted" hidden>
        <h3 class="text-lg font-semibold text-fg-primary">Нет результатов</h3>
        <p class="mt-2">Попробуйте изменить фильтры или сбросьте условия поиска.</p>
        <div class="mt-4 flex items-center justify-center gap-2">
          <button type="button" class="inline-flex items-center gap-2 rounded-md border border-border px-3 py-2 text-sm font-medium text-fg-primary transition hover:bg-bg-elev2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info" data-action="reset-filters">Сбросить фильтры</button>
          <a class="inline-flex items-center gap-2 rounded-md bg-accent px-3 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-accent-strong focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info" href="/slots/new">Создать слот</a>
        </div>
      </div>
    </div>

    <div class="p-6" data-view="cards" {% if view_mode != 'cards' %}hidden{% endif %}>
      <div id="slots_card_container" class="grid gap-4 sm:grid-cols-2 xl:grid-cols-3" data-card-root>
        {% for s in slots %}
          {% set st = norm_status(s.status) %}
          {% set tz_rec = s.recruiter.tz if s.recruiter and s.recruiter.tz else 'Europe/Moscow' %}
          {% set cand_tz = s.candidate_tz %}
          {% set status_label = status_labels.get(st, st or '—') %}
          {% if st == 'FREE' %}
            {% set tone = 'success' %}
          {% elif st == 'PENDING' %}
            {% set tone = 'warning' %}
          {% elif st == 'BOOKED' %}
            {% set tone = 'progress' %}
          {% elif st == 'CONFIRMED_BY_CANDIDATE' %}
            {% set tone = 'success' %}
          {% elif st == 'CANCELED' %}
            {% set tone = 'danger' %}
          {% else %}
            {% set tone = 'muted' %}
          {% endif %}
          <article class="slot-card flex flex-col gap-4 rounded-2xl border border-border bg-bg-elev2/80 p-4 shadow-sm transition hover:border-accent focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info" tabindex="0"
            data-id="{{ s.id }}"
            data-status="{{ st or '' }}"
            data-status-label="{{ status_label }}"
            data-start-iso="{{ s.start_utc.isoformat() }}"
            data-start-utc="{{ fmt_utc(s.start_utc) }}"
            data-start-rec="{{ fmt_local(s.start_utc, tz_rec) }}"
            data-start-cand="{{ fmt_local(s.start_utc, cand_tz) if cand_tz else '' }}"
            data-recruiter="{{ s.recruiter.name if s.recruiter else '' }}"
            data-recruiter-id="{{ s.recruiter.id if s.recruiter else '' }}"
            data-recruiter-tz="{{ tz_rec }}"
            data-city-id="{{ s.city.id if s.city else '' }}"
            data-city-name="{{ s.city.name if s.city else '' }}"
            data-city-tz="{{ tz_display(s.city.tz) if s.city else '' }}"
            data-duration="{{ s.duration_min }}"
            data-candidate="{{ s.candidate_fio or '' }}"
            data-candidate-id="{{ s.candidate_tg_id or '' }}"
            data-candidate-tz="{{ cand_tz or '' }}"
            data-outcome="{{ s.interview_outcome or '' }}"
            data-purpose="{{ s.purpose or '' }}"
            data-can-delete="{{ 1 if st in ['FREE', 'PENDING'] else 0 }}">
            <header class="flex items-start justify-between gap-3">
              <div class="flex flex-col gap-1" data-role="time">
                <span class="text-xs text-fg-muted">{{ s.city.name if s.city else 'Без города' }}</span>
                <h3 class="text-xl font-semibold text-fg-primary" data-role="time-primary">{{ fmt_local(s.start_utc, tz_rec) }}</h3>
                <span class="text-xs text-fg-muted" data-role="time-secondary">UTC {{ fmt_utc(s.start_utc) }}</span>
                {% if cand_tz %}
                  <span class="text-xs text-fg-muted" data-role="time-candidate">{{ fmt_local(s.start_utc, cand_tz) }} · {{ tz_display(cand_tz) }}</span>
                {% endif %}
              </div>
              <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold" data-badge="{{ tone }}">{{ status_label }}</span>
            </header>
            <div class="flex flex-col gap-2 text-sm">
              <div class="flex items-center gap-2">
                <span class="rounded-full bg-bg-elev3 px-2 py-0.5 text-xs font-semibold text-fg-muted">ID {{ s.id }}</span>
                <span class="text-fg-muted">{{ purpose_labels.get(s.purpose, s.purpose or '—') }}</span>
              </div>
              <p class="text-fg-primary">{{ s.recruiter.name if s.recruiter else 'Рекрутер не назначен' }}</p>
              {% if s.candidate_fio %}
                <div class="rounded-lg border border-border/60 bg-bg-elev1/60 p-3 text-sm">
                  <p class="font-medium text-fg-primary">{{ s.candidate_fio }}</p>
                  <p class="text-xs text-fg-muted">tg_id: {{ s.candidate_tg_id or '—' }}{% if cand_tz %} · {{ tz_display(cand_tz) }}{% endif %}</p>
                </div>
              {% else %}
                <p class="text-sm text-fg-muted">Слот свободен</p>
              {% endif %}
            </div>
            <footer class="flex items-center justify-between gap-2">
              <div class="text-xs text-fg-muted">Длительность {{ s.duration_min }} мин</div>
              <div class="flex items-center gap-2">
                <button type="button" class="inline-flex items-center gap-1 rounded-md border border-border px-2 py-1 text-xs font-medium text-fg-primary transition hover:bg-bg-elev3 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info" data-action="open-slot">Подробнее</button>
                <button type="button" class="inline-flex items-center gap-1 rounded-md border border-border px-2 py-1 text-xs font-medium text-fg-primary transition hover:bg-bg-elev3 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info" data-action="duplicate-slot">Дублировать</button>
              </div>
            </footer>
          </article>
        {% endfor %}
      </div>
      <div id="slots_card_empty" class="mt-10 text-center text-sm text-fg-muted" hidden>
        <h3 class="text-lg font-semibold text-fg-primary">Нет карточек по выбранным фильтрам</h3>
        <p class="mt-2">Измените параметры или создайте новый слот.</p>
        <div class="mt-4 flex items-center justify-center gap-2">
          <button type="button" class="inline-flex items-center gap-2 rounded-md border border-border px-3 py-2 text-sm font-medium text-fg-primary transition hover:bg-bg-elev2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info" data-action="reset-filters">Сбросить фильтры</button>
          <a class="inline-flex items-center gap-2 rounded-md bg-accent px-3 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-accent-strong focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info" href="/slots/new">Создать слот</a>
        </div>
      </div>
    </div>

    <div id="slots_skeleton" class="hidden border-t border-border/60 px-6 py-8" aria-hidden="true">
      <div class="flex flex-col gap-4">
        {% for _ in range(3) %}
          <div class="animate-pulse rounded-xl bg-bg-elev2/80 p-4">
            <div class="h-4 w-1/2 rounded-full bg-border/70"></div>
            <div class="mt-3 h-3 w-full rounded-full bg-border/50"></div>
            <div class="mt-2 h-3 w-3/4 rounded-full bg-border/50"></div>
          </div>
        {% endfor %}
      </div>
    </div>

    <div id="slots_error" class="hidden border-t border-border/60 px-6 py-10 text-center text-sm text-danger">
      <h3 class="text-lg font-semibold">Не удалось загрузить слоты</h3>
      <p class="mt-2">Проверьте подключение или попробуйте ещё раз.</p>
      <div class="mt-4 flex items-center justify-center">
        <button type="button" class="inline-flex items-center gap-2 rounded-md border border-border px-3 py-2 text-sm font-medium text-fg-primary transition hover:bg-bg-elev2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info" data-action="retry-load">Повторить</button>
      </div>
    </div>
  </div>

  <div id="slots_bulk_bar" class="sticky bottom-4 z-20 hidden w-full rounded-full border border-border bg-bg-elev2/95 px-6 py-3 shadow-glass" aria-hidden="true">
    <div class="flex flex-wrap items-center gap-3">
      <div class="flex items-center gap-2 text-sm text-fg-primary">Выбрано: <strong id="slots_bulk_count">0</strong></div>
      <label class="flex items-center gap-2 text-sm text-fg-muted">
        <span>Назначить</span>
        <select id="slots_bulk_assign" class="h-9 rounded-lg border border-border bg-bg-elev1 px-3 text-sm shadow-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info">
          <option value="">— Выберите —</option>
          {% for rec in recruiter_options %}
            <option value="{{ rec.id }}">{{ rec.name }}</option>
          {% endfor %}
        </select>
      </label>
      <div class="flex flex-wrap items-center gap-2">
        <button type="button" class="inline-flex items-center gap-2 rounded-md border border-border px-3 py-2 text-sm font-medium text-fg-primary transition hover:bg-bg-elev3 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info" data-bulk-action="assign">Применить</button>
        <button type="button" class="inline-flex items-center gap-2 rounded-md border border-border px-3 py-2 text-sm font-medium text-fg-primary transition hover:bg-bg-elev3 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-info" data-bulk-action="remind">Напоминание</button>
        <button type="button" class="inline-flex items-center gap-2 rounded-md border border-danger/60 bg-danger/10 px-3 py-2 text-sm font-medium text-danger transition hover:bg-danger/20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-danger" data-bulk-action="delete">Удалить</button>
      </div>
    </div>
  </div>
</section>

{% include "partials/slot_sheet.html" %}
<div id="toasts" class="toast-stack" aria-live="polite" aria-atomic="true"></div>

<script id="slots_context" type="application/json">{{ {
  'filters': {
    'recruiter_id': filter_recruiter_id,
    'status': filter_status,
    'city_id': filter_city_id,
    'purpose': filter_purpose,
    'date': filter_date,
  },
  'search_tokens': search_tokens,
  'status_counts': status_counts,
  'recruiters': recruiter_options,
  'cities': city_options,
  'purposes': purpose_options,
  'page': page,
  'pages_total': pages_total,
  'per_page': per_page,
  'has_slots': has_slots,
  'view': view_mode,
  'role': time_role,
  'only_future': only_future
} | tojson }}</script>
{% endblock %}
{% block extra_js %}
  <script type="module" src="{{ url_for('static', path='js/modules/slots-list.js') }}"></script>
{% endblock %}
