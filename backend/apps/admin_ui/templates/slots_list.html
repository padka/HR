{% extends "base.html" %}
{% from "partials/list_toolbar.html" import list_toolbar %}
{% block title %}–°–ª–æ—Ç—ã{% endblock %}
{% block content %}
{% set has_slots = slots|length > 0 %}
<section class="page page--slots" data-page="slots" aria-labelledby="slots-title">
  <header class="page-header">
    <div>
      <h1 id="slots-title" class="page-title">–°–ª–æ—Ç—ã</h1>
      <p class="page-description">
        –°–ª–µ–¥–∏—Ç–µ –∑–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º –∏–Ω—Ç–µ—Ä–≤—å—é: —Ñ–∏–ª—å—Ç—Ä—É–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É –ø–æ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞–º –∏ —Å—Ç–∞—Ç—É—Å—É, –ø–µ—Ä–µ–∫–ª—é—á–∞–π—Ç–µ—Å—å –º–µ–∂–¥—É –±—É–¥—É—â–∏–º–∏ –∏ –ø—Ä–æ—à–µ–¥—à–∏–º–∏ —Å–ª–æ—Ç–∞–º–∏, –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏.
      </p>
    </div>
    <div class="page-actions">
      <a class="btn btn-primary" href="/slots/new">+ –ù–æ–≤—ã–π —Å–ª–æ—Ç</a>
      <button type="button" class="btn btn-danger" id="delete_all_slots">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ</button>
    </div>
  </header>

  {% if flash %}
    {% set tone = {'success': 'success', 'error': 'danger', 'info': 'info'}.get(flash.status, 'info') %}
    <div class="surface glass grain alert" data-tone="{{ tone }}" role="alert">
      <p class="page-description">{{ flash.message }}</p>
    </div>
  {% endif %}

  <section class="slot-summary" aria-label="–ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–ª–æ—Ç–∞–º">
    <article class="slot-summary__item liquid-glass-card liquid-glass-card--interactive" data-tone="success" data-icon="üü¢" data-animate-in data-parallax>
      <span class="slot-summary__label">–°–≤–æ–±–æ–¥–Ω—ã–µ</span>
      <span class="slot-summary__value" id="cnt-free">{{ status_counts.FREE }}</span>
      <p class="slot-summary__hint">–ì–æ—Ç–æ–≤—ã –∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é</p>
    </article>
    <article class="slot-summary__item liquid-glass-card liquid-glass-card--interactive" data-tone="warning" data-icon="‚è≥" data-animate-in data-parallax>
      <span class="slot-summary__label">–û–∂–∏–¥–∞—é—Ç</span>
      <span class="slot-summary__value" id="cnt-pending">{{ status_counts.PENDING }}</span>
      <p class="slot-summary__hint">–ó–∞—è–≤–∫–∏ —Ç—Ä–µ–±—É—é—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</p>
    </article>
    <article class="slot-summary__item liquid-glass-card liquid-glass-card--interactive" data-tone="info" data-icon="üìÖ" data-animate-in data-parallax>
      <span class="slot-summary__label">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω—ã</span>
      <span class="slot-summary__value" id="cnt-booked">{{ status_counts.BOOKED }}</span>
      <p class="slot-summary__hint">–ò–Ω—Ç–µ—Ä–≤—å—é –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º</p>
    </article>
    <article class="slot-summary__item liquid-glass-card liquid-glass-card--interactive" data-tone="primary" data-icon="‚úÖ" data-animate-in data-parallax data-glow-pulse>
      <span class="slot-summary__label">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã</span>
      <span class="slot-summary__value" id="cnt-confirmed">{{ status_counts.CONFIRMED_BY_CANDIDATE }}</span>
      <p class="slot-summary__hint">–ö–∞–Ω–¥–∏–¥–∞—Ç—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ —É—á–∞—Å—Ç–∏–µ</p>
    </article>
    <article class="slot-summary__item liquid-glass-card liquid-glass-card--interactive" data-tone="neutral" data-icon="üìä" data-animate-in data-parallax>
      <span class="slot-summary__label">–í—Å–µ–≥–æ</span>
      <span class="slot-summary__value" id="cnt-total">{{ status_counts.total }}</span>
      <p class="slot-summary__hint">–° —É—á—ë—Ç–æ–º –¥–µ–π—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤</p>
    </article>
  </section>

  {% call list_toolbar(
    form_id="slot_filters",
    form_action="/slots",
    method="get",
    sticky=True,
    mass_actions=[{'label': '–ü–æ–∫–∞–∑–∞—Ç—å', 'type': 'button', 'variant': 'primary', 'button_type': 'submit'}]
  ) %}
    <div class="form-field">
      <label for="recruiter_id">–†–µ–∫—Ä—É—Ç—ë—Ä</label>
      <select id="recruiter_id" name="recruiter_id">
        <option value="">‚Äî –í—Å–µ ‚Äî</option>
        {% for r in recruiter_options %}
          <option value="{{ r.id }}" {% if filter_recruiter_id and filter_recruiter_id == r.id %}selected{% endif %}>
            {{ r.name }} ({{ tz_display(r.tz) }})
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="form-field form-field--narrow">
      <label for="status">–°—Ç–∞—Ç—É—Å</label>
      <select id="status" name="status">
        <option value="">‚Äî –í—Å–µ ‚Äî</option>
        <option value="FREE" {% if filter_status == 'FREE' %}selected{% endif %}>FREE</option>
        <option value="PENDING" {% if filter_status == 'PENDING' %}selected{% endif %}>PENDING</option>
        <option value="BOOKED" {% if filter_status == 'BOOKED' %}selected{% endif %}>BOOKED</option>
        <option value="CONFIRMED_BY_CANDIDATE" {% if filter_status == 'CONFIRMED_BY_CANDIDATE' %}selected{% endif %}>CONFIRMED_BY_CANDIDATE</option>
      </select>
    </div>

    <div class="form-field form-field--narrow">
      <label for="per_page">–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</label>
      <select id="per_page" name="per_page">
        {% for n in [10, 20, 50, 100] %}
          <option value="{{ n }}" {% if per_page == n %}selected{% endif %}>{{ n }}</option>
        {% endfor %}
      </select>
    </div>

    <p class="slot-toolbar-note">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—é—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∂–∏–º—ã –Ω–∏–∂–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ.</p>
  {% endcall %}

  <div class="slot-toggle-bar" role="group" aria-label="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∂–∏–º—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è">
    <label class="slot-toggle">
      <input id="only_future" type="checkbox" autocomplete="off">
      <span class="slot-toggle__indicator" aria-hidden="true"></span>
      <span class="slot-toggle__label">–¢–æ–ª—å–∫–æ –±—É–¥—É—â–∏–µ —Å–ª–æ—Ç—ã</span>
    </label>
    <label class="slot-toggle">
      <input id="toggle_cand_tz" type="checkbox" autocomplete="off">
      <span class="slot-toggle__indicator" aria-hidden="true"></span>
      <span class="slot-toggle__label">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Ä–µ–º—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</span>
    </label>
  </div>

  {% if has_slots %}
    <div class="liquid-glass-table" data-animate-in>
      <div class="list-table-wrapper">
        <table class="list-table list-table--responsive slot-table" id="slots_table">
        <thead>
          <tr>
            <th scope="col" class="sortable">
              <button class="sort" type="button" data-key="recruiter" aria-sort="none">–°–ª–æ—Ç <span class="arrow" aria-hidden="true"></span></button>
            </th>
            <th scope="col" class="sortable is-optional">
              <button class="sort" type="button" data-key="city" aria-sort="none">–ì–æ—Ä–æ–¥ <span class="arrow" aria-hidden="true"></span></button>
            </th>
            <th scope="col" class="sortable col-utc">
              <button class="sort" type="button" data-key="utc" aria-sort="none">UTC <span class="arrow" aria-hidden="true"></span></button>
            </th>
            <th scope="col">–õ–æ–∫–∞–ª—å–Ω–æ–µ (TZ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞)</th>
            <th scope="col" class="col-cand-tz is-optional">–õ–æ–∫–∞–ª—å–Ω–æ–µ (TZ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞)</th>
            <th scope="col" class="sortable">
              <button class="sort" type="button" data-key="status" aria-sort="none">–°—Ç–∞—Ç—É—Å <span class="arrow" aria-hidden="true"></span></button>
            </th>
            <th scope="col" class="sortable is-optional">
              <button class="sort" type="button" data-key="candidate" aria-sort="none">–ö–∞–Ω–¥–∏–¥–∞—Ç <span class="arrow" aria-hidden="true"></span></button>
            </th>
            <th scope="col" class="col-actions">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="slots_tbody">
        {% for s in slots %}
          {% set st = norm_status(s.status) %}
          {% set tz_rec = s.recruiter.tz if s.recruiter and s.recruiter.tz else "Europe/Moscow" %}
          {% set cand_tz = s.candidate_tz %}
          {% set status_order = 0 if st == 'FREE' else (1 if st == 'PENDING' else (2 if st == 'BOOKED' else 9)) %}
          <tr class="slot-row"
              tabindex="0"
              data-id="{{ s.id }}"
              data-status="{{ st or '' }}"
              data-status-order="{{ status_order }}"
              data-start-iso="{{ s.start_utc.isoformat() }}"
              data-start-utc="{{ fmt_utc(s.start_utc) }}"
              data-start-rec="{{ fmt_local(s.start_utc, tz_rec) }}"
              data-start-cand="{{ fmt_local(s.start_utc, cand_tz) if cand_tz else '' }}"
              data-recruiter="{{ s.recruiter.name if s.recruiter else '' }}"
              data-recruiter-id="{{ s.recruiter.id if s.recruiter else '' }}"
              data-recruiter-tz="{{ tz_rec }}"
              data-city="{{ s.city.name if s.city else '' }}"
              data-duration="{{ s.duration_min }}"
              data-candidate="{{ s.candidate_fio or '' }}"
              data-candidate-id="{{ s.candidate_tg_id or '' }}"
              data-candidate-tz="{{ cand_tz or '' }}"
              data-outcome="{{ s.interview_outcome or '' }}"
              data-can-delete="{{ 1 if st in ['FREE', 'PENDING'] else 0 }}">
            <td data-label="–°–ª–æ—Ç">
              <div class="slot-cell-primary">{{ s.recruiter.name if s.recruiter else "‚Äî" }}</div>
              <div class="slot-cell-meta">
                <span class="badge badge--soft">ID {{ s.id }}</span>
                <span class="badge badge--soft">{{ tz_display(tz_rec) }}</span>
              </div>
            </td>
            <td data-label="–ì–æ—Ä–æ–¥" class="is-optional">
              {% if s.city %}
                <div class="slot-cell-primary">{{ s.city.name or "‚Äî" }}</div>
                {% if s.city.tz %}
                  <span class="badge badge--soft">{{ tz_display(s.city.tz) }}</span>
                {% endif %}
              {% else %}
                <span class="badge badge--soft">‚Äî</span>
              {% endif %}
            </td>
            <td data-label="UTC" class="col-utc">
              <div class="slot-time">
                <span class="slot-time__value">{{ fmt_utc(s.start_utc) }}</span>
                <span class="slot-time__relative" data-role="relative">‚Äî</span>
              </div>
            </td>
            <td data-label="–í—Ä–µ–º—è (—Ä–µ–∫—Ä—É—Ç—ë—Ä)">
              <span class="slot-time__value">{{ fmt_local(s.start_utc, tz_rec) }}</span>
            </td>
            <td data-label="–í—Ä–µ–º—è (–∫–∞–Ω–¥–∏–¥–∞—Ç)" class="col-cand-tz is-optional">
              {% if cand_tz %}
                <div class="badge badge--soft">{{ tz_display(cand_tz) }}</div>
                <span class="slot-time__value">{{ fmt_local(s.start_utc, cand_tz) }}</span>
              {% else %}
                <span class="badge badge--soft">‚Äî</span>
              {% endif %}
            </td>
            <td data-label="–°—Ç–∞—Ç—É—Å">
              {% if st == "FREE" %}
                <span class="liquid-glass-badge liquid-glass-badge--success">FREE</span>
              {% elif st == "PENDING" %}
                <span class="liquid-glass-badge liquid-glass-badge--warning">PENDING</span>
              {% elif st == "BOOKED" %}
                <span class="liquid-glass-badge liquid-glass-badge--info">BOOKED</span>
              {% else %}
                <span class="liquid-glass-badge liquid-glass-badge--neutral">{{ st or "‚Äî" }}</span>
              {% endif %}
            </td>
            <td data-label="–ö–∞–Ω–¥–∏–¥–∞—Ç" class="is-optional">
              {% if s.candidate_fio %}
                <div class="slot-cell-primary">{{ s.candidate_fio }}</div>
                <span class="badge badge--soft">tg_id: {{ s.candidate_tg_id or "‚Äî" }}</span>
              {% else %}
                <span class="badge badge--soft">‚Äî</span>
              {% endif %}
            </td>
            <td class="col-actions" data-label="–î–µ–π—Å—Ç–≤–∏—è">
              <button type="button"
                      class="btn btn-danger btn--small"
                      data-action="delete-slot">
                –£–¥–∞–ª–∏—Ç—å
              </button>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      </div>
    </div>

    <div class="pagination">
      {% set qrecr = '&recruiter_id=' ~ filter_recruiter_id if filter_recruiter_id else '' %}
      {% set qstat = '&status=' ~ filter_status if filter_status else '' %}
      {% set qpp = '&per_page=' ~ per_page if per_page else '' %}

      <span class="badge badge--soft">–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page }} –∏–∑ {{ pages_total }}</span>

      {% if page > 1 %}
        <a class="btn btn-ghost" href="/slots?page=1{{ qrecr }}{{ qstat }}{{ qpp }}">¬´ –ü–µ—Ä–≤–∞—è</a>
        <a class="btn btn-ghost" href="/slots?page={{ page-1 }}{{ qrecr }}{{ qstat }}{{ qpp }}">‚Äπ –ù–∞–∑–∞–¥</a>
      {% else %}
        <span class="btn btn-ghost" aria-disabled="true">¬´ –ü–µ—Ä–≤–∞—è</span>
        <span class="btn btn-ghost" aria-disabled="true">‚Äπ –ù–∞–∑–∞–¥</span>
      {% endif %}

      {% if page < pages_total %}
        <a class="btn btn-ghost" href="/slots?page={{ page+1 }}{{ qrecr }}{{ qstat }}{{ qpp }}">–í–ø–µ—Ä—ë–¥ ‚Ä∫</a>
        <a class="btn btn-ghost" href="/slots?page={{ pages_total }}{{ qrecr }}{{ qstat }}{{ qpp }}">–ü–æ—Å–ª–µ–¥–Ω—è—è ¬ª</a>
      {% else %}
        <span class="btn btn-ghost" aria-disabled="true">–í–ø–µ—Ä—ë–¥ ‚Ä∫</span>
        <span class="btn btn-ghost" aria-disabled="true">–ü–æ—Å–ª–µ–¥–Ω—è—è ¬ª</span>
      {% endif %}
    </div>
  {% else %}
    <div class="liquid-glass-card slot-empty-state" role="status" data-animate-in>
      <h3 class="section-title">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</h3>
      <p class="page-description">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Å–ª–æ—Ç –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ.</p>
      <div class="slot-empty-state__actions">
        <a class="liquid-glass-btn liquid-glass-btn--primary" href="/slots/new">+ –ù–æ–≤—ã–π —Å–ª–æ—Ç</a>
      </div>
    </div>
  {% endif %}
  <div id="toasts" class="toast-stack" aria-live="polite" aria-atomic="true"></div>
</section>

<script>
(function(){
  const $ = (selector, root=document) => root.querySelector(selector);
  const $$ = (selector, root=document) => Array.from(root.querySelectorAll(selector));
  const on = (el, event, cb, opts) => el && el.addEventListener(event, cb, opts);

  const table = $('#slots_table');
  const tbody = $('#slots_tbody');
  const rows = tbody ? $$('.slot-row', tbody) : [];

  const onlyFuture = $('#only_future');
  const candToggle = $('#toggle_cand_tz');
  const emptyCard = $('#slot_empty_state');
  const deleteAllBtn = $('#delete_all_slots');

  const chipTotal = $('#cnt-total');
  const chipFree = $('#cnt-free');
  const chipPending = $('#cnt-pending');
  const chipBookedEl = $('#cnt-booked');

  const toastStack = $('#toasts');
  const notificationFeedKey = 'slots.notifications.lastId';
  let notificationFeedTimer = null;

  let sortState = { key: 'utc', dir: 'asc' };
  let relTimer = null;

  const storage = window.localStorage;
  const storageKeys = {
    future: 'slots.onlyFuture',
    candidate: 'slots.showCandidateTz'
  };
  const csrfToken = window.__CSRF_TOKEN__ || '';

  function toast(text, kind='info'){
    if (!toastStack) return;
    const el = document.createElement('div');
    el.className = 'toast';
    el.dataset.kind = kind;
    el.textContent = text;
    toastStack.appendChild(el);
    requestAnimationFrame(() => el.classList.add('toast--show'));
    setTimeout(() => el.classList.add('toast--hide'), 1800);
    setTimeout(() => el.remove(), 2200);
  }

  const notificationLabels = {
    interview_confirmed_candidate: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–ª–æ—Ç–∞',
    candidate_reschedule_prompt: '–ü–µ—Ä–µ–Ω–æ—Å —Å–ª–æ—Ç–∞',
    candidate_rejection: '–û—Ç–∫–∞–∑ –∫–∞–Ω–¥–∏–¥–∞—Ç—É',
    intro_day_invitation: '–û–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω—å',
  };

  const reminderLabels = {
    confirm_6h: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞ 6 —á–∞—Å–æ–≤',
    confirm_3h: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞ 3 —á–∞—Å–∞',
    confirm_2h: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞ 2 —á–∞—Å–∞',
    intro_remind_3h: '–û–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω—å —á–µ—Ä–µ–∑ 3 —á–∞—Å–∞',
  };

  function labelForNotification(item){
    if (!item) return '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ';
    const direct = notificationLabels[item.type];
    if (direct) return direct;
    if (item.type && item.type.startsWith('slot_reminder:')){
      const [, kind] = item.type.split(':', 2);
      return reminderLabels[kind] || '–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –≤—Å—Ç—Ä–µ—á–µ';
    }
    return item.type || '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ';
  }

  function shouldDisplayNotification(item){
    const status = (item?.status || '').toLowerCase();
    return status === 'failed' || status === 'pending';
  }

  function toastKindForStatus(status){
    if (status === 'failed') return 'error';
    if (status === 'pending') return 'info';
    return 'info';
  }

  function formatNotificationMessage(item){
    const label = labelForNotification(item);
    const status = (item?.status || '').toLowerCase();
    if (status === 'failed'){
      return `${label}: ${item?.last_error || '–æ—à–∏–±–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏'}`;
    }
    if (status === 'pending'){
      return `${label}: –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è`;
    }
    return `${label}: —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω`;
  }

  async function fetchNotificationFeed(){
    const lastId = storage.getItem(notificationFeedKey);
    const query = lastId ? `?after_id=${encodeURIComponent(lastId)}` : '';
    try {
      const res = await fetch(`/api/notifications/feed${query}`);
      if (!res.ok) return;
      const payload = await res.json();
      const items = payload.items || [];
      const latestId = payload.latest_id || (items.length ? items[items.length - 1].id : null);
      if (!lastId){
        if (latestId) storage.setItem(notificationFeedKey, latestId);
        return;
      }
      items.forEach(item => {
        if (!shouldDisplayNotification(item)) return;
        const status = (item.status || '').toLowerCase();
        toast(formatNotificationMessage(item), toastKindForStatus(status));
      });
      if (latestId) storage.setItem(notificationFeedKey, latestId);
    } catch (err) {
      console.warn('notification feed error', err);
    }
  }

  function startNotificationFeed(){
    if (notificationFeedTimer){
      clearInterval(notificationFeedTimer);
    }
    fetchNotificationFeed();
    notificationFeedTimer = setInterval(fetchNotificationFeed, 30000);
  }

  function parseTime(row){
    const iso = row?.dataset.startIso;
    if (!iso) return NaN;
    const value = Date.parse(iso);
    return Number.isNaN(value) ? NaN : value;
  }

  function isFutureRow(row){
    const ts = parseTime(row);
    return Number.isNaN(ts) ? true : ts >= Date.now();
  }

  function formatRelative(timestamp){
    if (!Number.isFinite(timestamp)) return '‚Äî';
    const diffMin = Math.round((timestamp - Date.now()) / 60000);
    const abs = Math.abs(diffMin);
    if (abs < 1) return diffMin >= 0 ? '—á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥' : '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    if (abs < 60) return `${diffMin >= 0 ? '—á–µ—Ä–µ–∑' : ''} ${abs} –º–∏–Ω`;
    const hours = Math.round(abs / 60);
    return `${diffMin >= 0 ? '—á–µ—Ä–µ–∑' : ''} ${hours} —á`;
  }

  function relativeState(diffMin){
    if (!Number.isFinite(diffMin)) return 'distant';
    if (diffMin < -5) return 'past';
    if (diffMin <= 15) return 'now';
    if (diffMin <= 120) return 'soon';
    return 'distant';
  }

  function updateCounters(result){
    if (!result) result = computeVisibleStats();
    if (chipTotal) chipTotal.textContent = result.total;
    if (chipFree) chipFree.textContent = result.free;
    if (chipPending) chipPending.textContent = result.pending;
    if (chipBookedEl) chipBookedEl.textContent = result.booked;
  }

  function computeVisibleStats(){
    let total = 0, free = 0, pending = 0, booked = 0;
    rows.forEach(row => {
      if (row.style.display === 'none') return;
      total += 1;
      const st = row.dataset.status;
      if (st === 'FREE') free += 1;
      else if (st === 'PENDING') pending += 1;
      else if (st === 'BOOKED') booked += 1;
    });
    return { total, free, pending, booked };
  }

  function applyFutureFilter(){
    const onlyFutureEnabled = onlyFuture && onlyFuture.checked;
    let visible = 0;
    rows.forEach(row => {
      const show = !onlyFutureEnabled || isFutureRow(row);
      row.style.display = show ? '' : 'none';
      row.classList.toggle('is-hidden', !show);
      if (show) visible += 1;
    });
    updateCounters();
    toggleEmptyState(visible);
  }

  function toggleEmptyState(visibleCount){
    if (!emptyCard) return;
    if (!rows.length){
      emptyCard.hidden = false;
      return;
    }
    emptyCard.hidden = visibleCount > 0;
  }

  function setCandidateColumnVisibility(show){
    const targets = $$('.col-cand-tz');
    targets.forEach(el => el.classList.toggle('hidden-col', !show));
  }

  function getSortValue(row, key){
    switch(key){
      case 'id':
        return parseInt(row.dataset.id || '0', 10);
      case 'utc':
        return parseTime(row);
      case 'recruiter':
        return (row.dataset.recruiter || '').toLowerCase();
      case 'city':
        return (row.dataset.city || '').toLowerCase();
      case 'candidate':
        return (row.dataset.candidate || '').toLowerCase();
      case 'status':
        return parseInt(row.dataset.statusOrder || '9', 10);
      default:
        return 0;
    }
  }

  function applySortIndicator(){
    if (!table) return;
    $$('.sort', table).forEach(btn => {
      const key = btn.dataset.key;
      const active = key === sortState.key;
      btn.classList.toggle('is-active', active);
      btn.setAttribute('aria-sort', active ? (sortState.dir === 'asc' ? 'ascending' : 'descending') : 'none');
    });
  }

  function applySort(){
    if (!tbody) return;
    const sorted = rows.slice().sort((a, b) => {
      const av = getSortValue(a, sortState.key);
      const bv = getSortValue(b, sortState.key);
      if (av < bv) return sortState.dir === 'asc' ? -1 : 1;
      if (av > bv) return sortState.dir === 'asc' ? 1 : -1;
      return 0;
    });
    sorted.forEach(row => tbody.appendChild(row));
  }

  function updateRelativeLabels(){
    const now = Date.now();
    rows.forEach(row => {
      const relEl = $('[data-role="relative"]', row);
      const ts = parseTime(row);
      if (!relEl || !Number.isFinite(ts)) return;
      const diffMin = Math.round((ts - now) / 60000);
      const state = relativeState(diffMin);
      relEl.textContent = formatRelative(ts);
      relEl.dataset.state = state;
      row.classList.toggle('is-past', state === 'past');
      row.classList.toggle('is-now', state === 'now');
      row.classList.toggle('is-soon', state === 'soon');
      row.classList.toggle('is-distant', state === 'distant');
    });
  }

  function removeRow(row){
    if (!row) return;
    const idx = rows.indexOf(row);
    if (idx !== -1){
      rows.splice(idx, 1);
    }
    row.remove();
  }

  async function performDelete(row, options = {}){
    if (!row) return;
    const { force = false, skipConfirm = false } = options;
    const id = row.dataset.id;
    if (!id) return;

    const canDelete = row.dataset.canDelete === '1';
    const status = row.dataset.status || '';
    const recruiterName = row.dataset.recruiter ? ` (${row.dataset.recruiter})` : '';

    if (!force && !canDelete){
      const confirmForce = window.confirm(
        status
          ? `–°–ª–æ—Ç #${id}${recruiterName} –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å ${status}. –£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ?`
          : `–£–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç #${id}${recruiterName} –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ?`
      );
      if (!confirmForce) return;
      return await performDelete(row, { force: true, skipConfirm: true });
    }

    const confirmationText = force
      ? `–£–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç #${id}${recruiterName}? –≠—Ç–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ.`
      : `–£–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç #${id}${recruiterName}? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`;

    if (!skipConfirm && !window.confirm(confirmationText)) return;

    const rowDeleteBtn = row.querySelector('[data-action="delete-slot"]');
    if (rowDeleteBtn) rowDeleteBtn.disabled = true;

    try {
      const response = await fetch(`/slots/${id}?force=${force ? 1 : 0}`, {
        method: 'DELETE',
        headers: {
          'Accept': 'application/json',
          'X-CSRFToken': csrfToken,
        },
      });
      const payload = await response.json().catch(() => null);

      if (!response.ok || !payload || payload.ok !== true){
        const message = payload && payload.message ? payload.message : '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç.';
        if (!force && payload && payload.code === 'requires_force'){
          const askForce = window.confirm(`${message} –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ?`);
          if (askForce){
            return await performDelete(row, { force: true, skipConfirm: true });
          }
        }
        toast(message, 'error');
        if (rowDeleteBtn) rowDeleteBtn.disabled = false;
        return;
      }

      toast(payload.message || '–°–ª–æ—Ç —É–¥–∞–ª—ë–Ω', 'success');
      removeRow(row);
      applyFutureFilter();
      updateRelativeLabels();
    } catch (err){
      console.error(err);
      toast('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç.', 'error');
      if (rowDeleteBtn) rowDeleteBtn.disabled = false;
    }
  }

  async function deleteAllSlots(force = false){
    const confirmationText = force
      ? '–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–ª–æ—Ç—ã –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –¥–∞–∂–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞.'
      : '–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–≤–æ–±–æ–¥–Ω—ã–µ –∏ –æ–∂–∏–¥–∞—é—â–∏–µ —Å–ª–æ—Ç—ã? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.';

    if (!window.confirm(confirmationText)) return;

    if (deleteAllBtn) deleteAllBtn.disabled = true;

    try {
      const response = await fetch('/slots/delete_all', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({ force })
      });
      const payload = await response.json().catch(() => null);

      if (!response.ok || !payload || payload.ok !== true){
        const message = payload && payload.error ? payload.error : '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç—ã.';
        if (!force && payload && typeof payload.remaining === 'number' && payload.remaining > 0){
          const askForce = window.confirm(`${message} –£–¥–∞–ª–∏—Ç—å –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Å–ª–æ—Ç—ã –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ?`);
          if (askForce){
            return await deleteAllSlots(true);
          }
        }
        toast(message, 'error');
        return;
      }

      const deletedCount = Number(payload.deleted || 0);
      const remaining = Number(payload.remaining || 0);

      if (!force && remaining > 0){
        toast(`–£–¥–∞–ª–µ–Ω–æ ${deletedCount} —Å–ª–æ—Ç(–æ–≤). –û—Å—Ç–∞–ª–æ—Å—å ${remaining}.`, 'info');
        const askForce = window.confirm('–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–ª–æ—Ç—ã –æ—Å—Ç–∞–ª–∏—Å—å. –£–¥–∞–ª–∏—Ç—å –∏—Ö –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ?');
        if (askForce){
          return await deleteAllSlots(true);
        }
        return;
      }

      toast(`–£–¥–∞–ª–µ–Ω–æ ${deletedCount} —Å–ª–æ—Ç(–æ–≤).`, 'success');
      window.location.reload();
    } catch (err){
      console.error(err);
      toast('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç—ã.', 'error');
    } finally {
      if (deleteAllBtn) deleteAllBtn.disabled = false;
    }
  }

  function restorePreferences(){
    if (onlyFuture && storage){
      const saved = storage.getItem(storageKeys.future);
      if (saved !== null) onlyFuture.checked = saved === '1';
    }
    if (candToggle && storage){
      const saved = storage.getItem(storageKeys.candidate);
      if (saved !== null) candToggle.checked = saved === '1';
    }
  }

  function persistPreference(key, value){
    if (!storage) return;
    storage.setItem(key, value ? '1' : '0');
  }

  if (!table || !tbody) return;

  restorePreferences();
  setCandidateColumnVisibility(candToggle ? candToggle.checked : false);
  applySort();
  applySortIndicator();
  applyFutureFilter();
  updateRelativeLabels();

  if (relTimer) clearInterval(relTimer);
  relTimer = window.setInterval(updateRelativeLabels, 60000);

  on(tbody, 'click', e => {
    const deleteBtn = e.target.closest('[data-action="delete-slot"]');
    if (deleteBtn){
      e.preventDefault();
      e.stopPropagation();
      const row = deleteBtn.closest('.slot-row');
      performDelete(row);
      return;
    }
  });

  on(table, 'click', e => {
    const sortButton = e.target.closest('.sort');
    if (!sortButton) return;
    const key = sortButton.dataset.key;
    if (!key) return;
    if (sortState.key === key){
      sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
    } else {
      sortState.key = key;
      sortState.dir = 'asc';
    }
    applySort();
    applySortIndicator();
    applyFutureFilter();
  });

  on(onlyFuture, 'change', () => {
    persistPreference(storageKeys.future, !!onlyFuture.checked);
    applyFutureFilter();
  });

  on(candToggle, 'change', () => {
    persistPreference(storageKeys.candidate, !!candToggle.checked);
    setCandidateColumnVisibility(candToggle.checked);
  });

  on(deleteAllBtn, 'click', () => {
    deleteAllSlots(false);
  });

  document.addEventListener('keydown', e => {
    if (e.key === 'f' && onlyFuture){
      onlyFuture.checked = !onlyFuture.checked;
      persistPreference(storageKeys.future, onlyFuture.checked);
      applyFutureFilter();
    }
    if (e.key === 't' && candToggle){
      candToggle.checked = !candToggle.checked;
      persistPreference(storageKeys.candidate, candToggle.checked);
      setCandidateColumnVisibility(candToggle.checked);
    }
  });

  startNotificationFeed();

})();
</script>
{% endblock %}
