{% extends "base.html" %}
{% from "page_primitives.html" import kpi_section %}
{% block title %}Слоты{% endblock %}
{% block head %}{{ super() }}
<link rel="stylesheet" href="/static/css/main.css">
{% endblock %}
{% block content %}
{% set has_slots = slots|length > 0 %}
{% set status_labels = {
  'FREE': 'Свободные',
  'PENDING': 'Ожидают',
  'BOOKED': 'Забронированы',
  'CONFIRMED_BY_CANDIDATE': 'Подтверждены'
} %}
{% set filter_tags = [] %}
{% if filter_recruiter_id %}
  {% set recruiter_label = (recruiter_options | selectattr('id', 'equalto', filter_recruiter_id) | map(attribute='name') | list | first) %}
  {% set filter_tags = filter_tags + [{'key': 'recruiter', 'label': recruiter_label or ('ID ' ~ filter_recruiter_id)}] %}
{% endif %}
{% if filter_status %}
  {% set filter_tags = filter_tags + [{'key': 'status', 'label': status_labels.get(filter_status, filter_status)}] %}
{% endif %}
{% if filter_city_id %}
  {% set city_label = (city_options | selectattr('id', 'equalto', filter_city_id) | map(attribute='name') | list | first) %}
  {% set filter_tags = filter_tags + [{'key': 'city', 'label': city_label or ('ID ' ~ filter_city_id)}] %}
{% endif %}
{% set status_summary = [
  {'key': 'free', 'label': 'Свободно', 'value': status_counts.FREE, 'tone': 'success', 'hint': 'готовы к брони', 'value_id': 'cnt-free'},
  {'key': 'pending', 'label': 'Ожидают', 'value': status_counts.PENDING, 'tone': 'warning', 'hint': 'ждут ответа', 'value_id': 'cnt-pending'},
  {'key': 'booked', 'label': 'Забронированы', 'value': status_counts.BOOKED, 'tone': 'progress', 'hint': 'назначено', 'value_id': 'cnt-booked'},
  {'key': 'confirmed', 'label': 'Подтверждены', 'value': status_counts.CONFIRMED_BY_CANDIDATE, 'tone': 'success', 'hint': 'подтверждено', 'value_id': 'cnt-confirmed'},
  {'key': 'total', 'label': 'Всего', 'value': status_counts.total, 'tone': 'muted', 'hint': 'по фильтрам', 'value_id': 'cnt-total'}
] %}
<section class="page-grid slots-page" data-page="slots" aria-labelledby="slots-title">
  <aside class="page-aside panel slots-aside">
    <p class="page-header__eyebrow muted">Расписание интервью</p>
    <h1 id="slots-title" class="page-header__title">Слоты</h1>
    <p class="page-header__description muted">Управляйте бронями, напоминаниями и результатами интервью в одном окне.</p>
    <ul class="slots-aside__meta" role="list">
      <li>Всего слотов: {{ status_counts.total }}</li>
      <li>Подтверждено кандидатами: {{ status_counts.CONFIRMED_BY_CANDIDATE }}</li>
    </ul>
    <div class="page-actions">
      <a class="btn btn-primary btn-sm" href="/slots/new">+ Новый слот</a>
      <button type="button" class="btn btn-danger btn-sm" id="delete_all_slots">Удалить все</button>
    </div>
  </aside>
  <div class="page-main" data-slots-root>
    {% if flash %}
      {% set tone = {'success': 'success', 'error': 'danger', 'info': 'info'}.get(flash.status, 'info') %}
      <div class="slot-alert panel panel--flush" data-tone="{{ tone }}" role="alert">
        <p class="slot-alert__text">{{ flash.message }}</p>
      </div>
    {% endif %}

    <div class="slots-kpi">
      {{
        kpi_section(
          'slot_summary_title',
          eyebrow='Живой статус брони',
          title='Сводка по слотам',
          meta='Данные по текущим фильтрам',
          cards=status_summary
        )
      }}
    </div>

    <div class="panel slots-controls" data-role="toolbar">
      <div class="slots-controls__row slots-controls__row--primary">
        <div class="slots-chip-list" id="slots_chip_triggers">
          <button type="button" class="chip chip--trigger" data-chip="recruiter" aria-haspopup="dialog">
            <span class="chip__label">Рекрутёры</span>
            <span class="chip__value" data-chip-value="recruiter">{{ recruiter_label or 'Все' if filter_recruiter_id else 'Все' }}</span>
          </button>
          <button type="button" class="chip chip--trigger" data-chip="status" aria-haspopup="dialog">
            <span class="chip__label">Статусы</span>
            <span class="chip__value" data-chip-value="status">{{ status_labels.get(filter_status, 'Любой') if filter_status else 'Любой' }}</span>
          </button>
          <button type="button" class="chip chip--trigger" data-chip="city" aria-haspopup="dialog">
            <span class="chip__label">Города</span>
            <span class="chip__value" data-chip-value="city">{{ city_label or 'Все' if filter_city_id else 'Все' }}</span>
          </button>
        </div>
        <div class="slots-search" data-role="search">
          <div class="slots-search__tokens" id="slots_search_tokens" aria-live="polite"></div>
          <input type="text" id="slots_search_input" class="slots-search__input" placeholder="Поиск по кандидату, городу, ID…" autocomplete="off">
        </div>
      </div>
      <div class="slots-controls__row slots-controls__row--secondary">
        <div class="slots-role-switch" role="group" aria-label="Роль времени">
          <button type="button" class="slots-role-switch__btn is-active" data-role-target="recruiter">Рекрутёр</button>
          <button type="button" class="slots-role-switch__btn" data-role-target="candidate">Кандидат</button>
        </div>
        <label class="slots-toggle">
          <input type="checkbox" id="slots_only_future" autocomplete="off">
          <span>Только будущие</span>
        </label>
        <form class="slots-per-page" id="slots_per_page_form" method="get">
          <label for="per_page" class="slots-per-page__label">На странице</label>
          <div class="slots-per-page__field">
            <select id="per_page" name="per_page">
              {% for n in [10, 20, 50, 100] %}
                <option value="{{ n }}" {% if per_page == n %}selected{% endif %}>{{ n }}</option>
              {% endfor %}
            </select>
          </div>
          {% if filter_recruiter_id %}<input type="hidden" name="recruiter_id" value="{{ filter_recruiter_id }}">{% endif %}
          {% if filter_status %}<input type="hidden" name="status" value="{{ filter_status }}">{% endif %}
          {% if filter_city_id %}<input type="hidden" name="city_id" value="{{ filter_city_id }}">{% endif %}
          <noscript><button type="submit" class="btn btn-ghost btn-sm">Обновить</button></noscript>
        </form>
      </div>
      {% if filter_tags %}
        <div class="slots-controls__row slots-controls__row--tags" id="slots_active_tags" aria-live="polite">
          {% for tag in filter_tags %}
            <button type="button" class="chip chip--active" data-remove-filter="{{ tag.key }}">
              <span class="chip__label">{{ tag.label }}</span>
              <span class="chip__remove" aria-hidden="true">×</span>
              <span class="visually-hidden">Сбросить фильтр {{ tag.label }}</span>
            </button>
          {% endfor %}
          <button type="button" class="chip chip--ghost" data-action="reset-filters">Сбросить всё</button>
        </div>
      {% endif %}
    </div>

    <div id="slots_bulk_bar" class="slots-bulk" hidden aria-hidden="true">
      <div class="slots-bulk__count">Выбрано слотов: <span id="slots_bulk_count">0</span></div>
      <div class="slots-bulk__actions">
        <label class="slots-bulk__assign">
          <span class="slots-bulk__assign-label">Назначить ОД</span>
          <select id="slots_bulk_assign">
            <option value="">— Выберите —</option>
            {% for rec in recruiter_options %}
              <option value="{{ rec.id }}">{{ rec.name }}</option>
            {% endfor %}
          </select>
        </label>
        <button type="button" class="btn btn-primary btn-sm" data-bulk-action="assign">Применить</button>
        <button type="button" class="btn btn-soft btn-sm" data-bulk-action="remind">Напоминание</button>
        <button type="button" class="btn btn-danger btn-sm" data-bulk-action="delete">Удалить</button>
      </div>
    </div>

    {% set qrecr = '&recruiter_id=' ~ filter_recruiter_id if filter_recruiter_id else '' %}
    {% set qstat = '&status=' ~ filter_status if filter_status else '' %}
    {% set qcity = '&city_id=' ~ filter_city_id if filter_city_id else '' %}
    {% set qpp = '&per_page=' ~ per_page if per_page else '' %}

    <div class="panel panel--compact slots-table-card">
      {% if has_slots %}
        <div class="slots-pagination slots-pagination--top">
          <span class="badge badge--soft">Страница {{ page }} из {{ pages_total }}</span>
          <div class="slots-pagination__controls">
            {% if page > 1 %}
              <a class="btn btn-ghost" href="/slots?page=1{{ qrecr }}{{ qstat }}{{ qcity }}{{ qpp }}">« Первая</a>
              <a class="btn btn-ghost" href="/slots?page={{ page-1 }}{{ qrecr }}{{ qstat }}{{ qcity }}{{ qpp }}">‹ Назад</a>
            {% else %}
              <span class="btn btn-ghost" aria-disabled="true">« Первая</span>
              <span class="btn btn-ghost" aria-disabled="true">‹ Назад</span>
            {% endif %}
            {% if page < pages_total %}
              <a class="btn btn-ghost" href="/slots?page={{ page+1 }}{{ qrecr }}{{ qstat }}{{ qcity }}{{ qpp }}">Вперёд ›</a>
              <a class="btn btn-ghost" href="/slots?page={{ pages_total }}{{ qrecr }}{{ qstat }}{{ qcity }}{{ qpp }}">Последняя »</a>
            {% else %}
              <span class="btn btn-ghost" aria-disabled="true">Вперёд ›</span>
              <span class="btn btn-ghost" aria-disabled="true">Последняя »</span>
            {% endif %}
          </div>
        </div>

        <div class="table__wrap slots-table__wrap" data-testid="slots-table-wrapper">
          <table class="table slots-table table--stackable" id="slots_table" data-testid="slots-table">
            <caption class="visually-hidden">Таблица слотов</caption>
            <thead>
              <tr>
                <th scope="col" class="col-select">
                  <label class="slot-checkbox" aria-label="Выбрать все">
                    <input type="checkbox" id="slots_select_all">
                    <span class="slot-checkbox__box" aria-hidden="true"></span>
                  </label>
                </th>
                <th scope="col" class="sortable col-summary">
                  <button class="sort" type="button" data-sort="recruiter" aria-sort="none">Слот <span class="arrow" aria-hidden="true"></span></button>
                </th>
                <th scope="col" class="sortable col-time">
                  <button class="sort" type="button" data-sort="time" aria-sort="ascending">Время <span class="arrow" aria-hidden="true"></span></button>
                </th>
                <th scope="col" class="sortable col-candidate">
                  <button class="sort" type="button" data-sort="candidate" aria-sort="none">Кандидат <span class="arrow" aria-hidden="true"></span></button>
                </th>
                <th scope="col" class="col-meta">Детали</th>
                <th scope="col" class="col-actions">Действия</th>
              </tr>
            </thead>
            <tbody id="slots_tbody">
              {% for s in slots %}
                {% set st = norm_status(s.status) %}
                {% set tz_rec = s.recruiter.tz if s.recruiter and s.recruiter.tz else "Europe/Moscow" %}
                {% set cand_tz = s.candidate_tz %}
                {% set status_order = 0 if st == 'FREE' else (1 if st == 'PENDING' else (2 if st == 'BOOKED' else 9)) %}
                {% set status_label = status_labels.get(st, st or '—') %}
                {% if st == 'FREE' %}
                  {% set tone = 'success' %}
                {% elif st == 'PENDING' %}
                  {% set tone = 'warning' %}
                {% elif st == 'BOOKED' %}
                  {% set tone = 'progress' %}
                {% elif st == 'CONFIRMED_BY_CANDIDATE' %}
                  {% set tone = 'success' %}
                {% else %}
                  {% set tone = 'muted' %}
                {% endif %}
                <tr class="slot-row"
                    tabindex="0"
                    data-id="{{ s.id }}"
                    data-status="{{ st or '' }}"
                    data-status-label="{{ status_label }}"
                    data-status-order="{{ status_order }}"
                    data-start-iso="{{ s.start_utc.isoformat() }}"
                    data-start-utc="{{ fmt_utc(s.start_utc) }}"
                    data-start-rec="{{ fmt_local(s.start_utc, tz_rec) }}"
                    data-start-cand="{{ fmt_local(s.start_utc, cand_tz) if cand_tz else '' }}"
                    data-recruiter="{{ s.recruiter.name if s.recruiter else '' }}"
                    data-recruiter-id="{{ s.recruiter.id if s.recruiter else '' }}"
                    data-recruiter-tz="{{ tz_rec }}"
                    data-city-id="{{ s.city.id if s.city else '' }}"
                    data-city-name="{{ s.city.name if s.city else '' }}"
                    data-city-tz="{{ tz_display(s.city.tz) if s.city else '' }}"
                    data-duration="{{ s.duration_min }}"
                    data-candidate="{{ s.candidate_fio or '' }}"
                    data-candidate-id="{{ s.candidate_tg_id or '' }}"
                    data-candidate-tz="{{ cand_tz or '' }}"
                    data-outcome="{{ s.interview_outcome or '' }}"
                    data-can-delete="{{ 1 if st in ['FREE', 'PENDING'] else 0 }}">
                  <td class="col-select" data-label="Выбрать">
                    <label class="slot-checkbox">
                      <input type="checkbox" class="slot-select" value="{{ s.id }}">
                      <span class="slot-checkbox__box" aria-hidden="true"></span>
                      <span class="visually-hidden">Выбрать слот {{ s.id }}</span>
                    </label>
                  </td>
                  <td class="col-summary" data-label="Слот">
                    <div class="slot-summary">
                      <div class="slot-summary__top">
                        <span class="slot-summary__id">ID {{ s.id }}</span>
                        <span class="status-chip" data-tone="{{ tone }}">{{ status_label }}</span>
                      </div>
                      <div class="slot-summary__meta">
                        <span class="slot-summary__person" data-testid="slot-recruiter-cell">{{ s.recruiter.name if s.recruiter else 'Не назначен' }}</span>
                        {% if s.city %}
                          <span class="slot-summary__city">{{ s.city.name }}</span>
                        {% else %}
                          <span class="slot-summary__city slot-summary__city--empty">Город не выбран</span>
                        {% endif %}
                      </div>
                    </div>
                  </td>
                  <td class="col-time" data-label="Время">
                    <div class="slot-time" data-role="time">
                      <span class="slot-time__primary" data-role="time-primary" data-testid="slot-local-time">{{ fmt_local(s.start_utc, tz_rec) }}</span>
                      <span class="slot-time__secondary" data-role="time-secondary">UTC {{ fmt_utc(s.start_utc) }}</span>
                      {% if cand_tz %}
                        <span class="slot-time__candidate" data-role="time-candidate">{{ fmt_local(s.start_utc, cand_tz) }} · {{ tz_display(cand_tz) }}</span>
                      {% endif %}
                      <span class="slot-deadline" data-role="deadline">—</span>
                    </div>
                  </td>
                  <td class="col-candidate" data-label="Кандидат">
                    {% if s.candidate_fio %}
                      <div class="slot-candidate">
                        <span class="slot-candidate__name">{{ s.candidate_fio }}</span>
                        <div class="slot-candidate__meta">
                          <span class="slot-candidate__id">tg_id: {{ s.candidate_tg_id or '—' }}</span>
                          {% if cand_tz %}<span class="slot-candidate__tz">{{ tz_display(cand_tz) }}</span>{% endif %}
                        </div>
                        <button type="button" class="btn btn-outline btn-xs" data-action="write-tg" data-tg-id="{{ s.candidate_tg_id or '' }}" {% if not s.candidate_tg_id %}disabled{% endif %}>Написать в TG</button>
                      </div>
                    {% else %}
                      <span class="slot-candidate slot-candidate--empty">Нет брони</span>
                    {% endif %}
                  </td>
                  <td class="col-meta" data-label="Детали">
                    <dl class="slot-meta">
                      <div class="slot-meta__item"><dt>Длительность</dt><dd>{{ s.duration_min }} мин</dd></div>
                      <div class="slot-meta__item"><dt>Часовой пояс</dt><dd>{{ tz_display(tz_rec) }}</dd></div>
                    </dl>
                  </td>
                  <td class="col-actions" data-label="Действия">
                    <div class="slot-actions" data-role="menu">
                      <button type="button" class="slot-actions__trigger" aria-haspopup="menu" aria-expanded="false">⋯</button>
                      <div class="slot-actions__menu" role="menu">
                        <button type="button" data-action="open-slot" role="menuitem">Подробнее</button>
                        <button type="button" data-action="duplicate-slot" role="menuitem">Дублировать</button>
                        <button type="button" data-action="copy-slot" role="menuitem">Скопировать ссылку</button>
                        <button type="button" data-action="delete-slot" role="menuitem">Удалить</button>
                      </div>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="slots-empty" id="slot_empty_state" role="status" hidden aria-hidden="true">
          <h3 class="slots-empty__title">Нет слотов по выбранным условиям</h3>
          <p class="slots-empty__hint muted">Попробуйте изменить фильтры или создайте новый слот.</p>
          <div class="slots-empty__actions">
            <a class="btn btn-primary" href="/slots/new">+ Новый слот</a>
            <button type="button" class="btn btn-ghost" data-action="reset-filters">Сбросить фильтры</button>
          </div>
        </div>

        <div class="slots-pagination slots-pagination--bottom">
          <span class="badge badge--soft">Страница {{ page }} из {{ pages_total }}</span>
          <div class="slots-pagination__controls">
            {% if page > 1 %}
              <a class="btn btn-ghost" href="/slots?page=1{{ qrecr }}{{ qstat }}{{ qcity }}{{ qpp }}">« Первая</a>
              <a class="btn btn-ghost" href="/slots?page={{ page-1 }}{{ qrecr }}{{ qstat }}{{ qcity }}{{ qpp }}">‹ Назад</a>
            {% else %}
              <span class="btn btn-ghost" aria-disabled="true">« Первая</span>
              <span class="btn btn-ghost" aria-disabled="true">‹ Назад</span>
            {% endif %}
            {% if page < pages_total %}
              <a class="btn btn-ghost" href="/slots?page={{ page+1 }}{{ qrecr }}{{ qstat }}{{ qcity }}{{ qpp }}">Вперёд ›</a>
              <a class="btn btn-ghost" href="/slots?page={{ pages_total }}{{ qrecr }}{{ qstat }}{{ qcity }}{{ qpp }}">Последняя »</a>
            {% else %}
              <span class="btn btn-ghost" aria-disabled="true">Вперёд ›</span>
              <span class="btn btn-ghost" aria-disabled="true">Последняя »</span>
            {% endif %}
          </div>
        </div>
      {% else %}
        <div class="slots-empty slots-empty--initial" role="status">
          <h3 class="slots-empty__title">Пока нет слотов</h3>
          <p class="slots-empty__hint muted">Создайте первый слот или импортируйте серию, чтобы начать планирование интервью.</p>
          <div class="slots-empty__actions">
            <a class="btn btn-primary" href="/slots/new">+ Новый слот</a>
            <a class="btn btn-soft" href="/slots/new#panel-bulk">Импорт серией</a>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</section>

<div id="slots_filter_backdrop" class="sheet-backdrop" hidden></div>
<aside id="slots_filter_sheet" class="sheet slots-filter-sheet" hidden aria-modal="true" role="dialog" aria-labelledby="slots_filter_title">
  <header class="sheet-header">
    <div>
      <h3 id="slots_filter_title" class="sheet-title">Фильтры</h3>
      <p class="sheet-sub muted">Выберите значения и примените, чтобы обновить таблицу.</p>
    </div>
    <button type="button" class="btn btn-ghost btn-sm" data-filter-close aria-label="Закрыть">✕</button>
  </header>
  <div class="sheet-body slots-filter-body">
    <section class="slots-filter-section" data-filter="recruiter">
      <header><h4>Рекрутёры</h4></header>
      <div class="slots-filter-options" role="group" aria-label="Фильтр по рекрутёрам">
        <label class="slots-filter-option">
          <input type="radio" name="filter_recruiter" value="" {% if not filter_recruiter_id %}checked{% endif %}>
          <span>Все</span>
        </label>
        {% for rec in recruiter_options %}
          <label class="slots-filter-option">
            <input type="radio" name="filter_recruiter" value="{{ rec.id }}" {% if filter_recruiter_id == rec.id %}checked{% endif %}>
            <span>{{ rec.name }}</span>
          </label>
        {% endfor %}
      </div>
    </section>
    <section class="slots-filter-section" data-filter="status">
      <header><h4>Статусы</h4></header>
      <div class="slots-filter-options" role="group" aria-label="Фильтр по статусу">
        <label class="slots-filter-option">
          <input type="radio" name="filter_status" value="" {% if not filter_status %}checked{% endif %}>
          <span>Любой</span>
        </label>
        {% for code, label in status_labels.items() %}
          <label class="slots-filter-option">
            <input type="radio" name="filter_status" value="{{ code }}" {% if filter_status == code %}checked{% endif %}>
            <span>{{ label }}</span>
          </label>
        {% endfor %}
      </div>
    </section>
    <section class="slots-filter-section" data-filter="city">
      <header><h4>Города</h4></header>
      <div class="slots-filter-options" role="group" aria-label="Фильтр по городу">
        <label class="slots-filter-option">
          <input type="radio" name="filter_city" value="" {% if not filter_city_id %}checked{% endif %}>
          <span>Все</span>
        </label>
        {% for city in city_options %}
          <label class="slots-filter-option">
            <input type="radio" name="filter_city" value="{{ city.id }}" {% if filter_city_id == city.id %}checked{% endif %}>
            <span>{{ city.name }}</span>
          </label>
        {% endfor %}
      </div>
    </section>
  </div>
  <footer class="sheet-footer slots-filter-footer">
    <div class="form-actions">
      <button type="button" class="btn btn-soft" data-filter-reset>Сбросить</button>
      <button type="button" class="btn btn-primary" data-filter-apply>Применить</button>
    </div>
  </footer>
</aside>

{% include "partials/slot_sheet.html" %}
<div id="toasts" class="toast-stack" aria-live="polite" aria-atomic="true"></div>

<script id="slots_context" type="application/json">{{ slots_context | tojson }}</script>
{% endblock %}
{% block extra_js %}
  <script type="module" src="{{ url_for('static', path='js/modules/slots-list.js') }}"></script>
{% endblock %}
