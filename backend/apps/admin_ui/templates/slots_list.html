{% extends "base.html" %}
{% from "partials/list_toolbar.html" import list_toolbar, segmented_control %}
{% block title %}Слоты{% endblock %}

{% macro slot_status_icon(name) %}
  {% if name == 'FREE' %}
    <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M10 1.75a8.25 8.25 0 1 1 0 16.5 8.25 8.25 0 0 1 0-16.5Z" stroke="currentColor" stroke-width="1.4" />
      <path d="M6.75 10.25 9 12.5l4.25-4.25" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
    </svg>
  {% elif name == 'PENDING' %}
    <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="6.25" y="2.75" width="7.5" height="14.5" rx="2.4" stroke="currentColor" stroke-width="1.4" />
      <path d="M6.75 7h6.5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" />
      <path d="M6.75 13h6.5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" />
    </svg>
  {% elif name == 'BOOKED' %}
    <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="3.5" y="3.75" width="13" height="12.5" rx="2.2" stroke="currentColor" stroke-width="1.4" />
      <path d="M6.25 2.75v2.5M13.75 2.75v2.5M4.75 8.25h10.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" />
      <path d="m8 10.75 1.75 1.75L12 10.25" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" />
    </svg>
  {% elif name == 'TOTAL' %}
    <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M3.75 14.25c2.25-1.5 4.25-3.5 6.25-3.5s3.25 1.5 6.25 3.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" />
      <path d="M10 4.5a2 2 0 1 1 0 4 2 2 0 0 1 0-4Z" stroke="currentColor" stroke-width="1.4" />
    </svg>
  {% else %}
    <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M5 5h10v10H5z" stroke="currentColor" stroke-width="1.4" />
    </svg>
  {% endif %}
{% endmacro %}

{% block content %}
<section class="page">
  <header class="page-header">
    <div>
      <h1 class="page-title">Слоты</h1>
      <p class="page-description">
        Управляйте слотами интервью, фильтруйте по рекрутёрам и статусу и следите за балансом загрузки.
      </p>
    </div>
    <div class="page-actions">
      <a class="btn btn-primary" href="/slots/new">+ Новый слот</a>
    </div>
  </header>

  <section class="stat-grid" aria-label="Быстрая статистика по слотам">
    <article class="stat-card" data-tone="success">
      <span class="stat-card__icon" aria-hidden="true">{{ slot_status_icon('FREE') }}</span>
      <span class="stat-card__label">Свободные</span>
      <span class="stat-card__value" id="cnt-free">{{ status_counts.FREE }}</span>
      <p class="stat-card__hint">Готовы к бронированию</p>
    </article>
    <article class="stat-card" data-tone="warning">
      <span class="stat-card__icon" aria-hidden="true">{{ slot_status_icon('PENDING') }}</span>
      <span class="stat-card__label">В ожидании</span>
      <span class="stat-card__value" id="cnt-pending">{{ status_counts.PENDING }}</span>
      <p class="stat-card__hint">Требуют подтверждения</p>
    </article>
    <article class="stat-card" data-tone="info">
      <span class="stat-card__icon" aria-hidden="true">{{ slot_status_icon('BOOKED') }}</span>
      <span class="stat-card__label">Забронированные</span>
      <span class="stat-card__value" id="cnt-booked">{{ status_counts.BOOKED }}</span>
      <p class="stat-card__hint">Назначены кандидатам</p>
    </article>
    <article class="stat-card">
      <span class="stat-card__icon" aria-hidden="true">{{ slot_status_icon('TOTAL') }}</span>
      <span class="stat-card__label">Всего слотов</span>
      <span class="stat-card__value" id="cnt-total">{{ status_counts.total }}</span>
      <p class="stat-card__hint">С учётом активных фильтров</p>
    </article>
  </section>

  {% call list_toolbar(
    form_id="flt",
    form_action="/slots",
    method="get",
    sticky=True,
    mass_actions=[{'label': 'Показать', 'type': 'button', 'variant': 'primary', 'button_type': 'submit'}],
    filters_label='Фильтры'
  ) %}
    <div class="toolbar__cluster toolbar__cluster--grow">
      <div class="form-field form-field--wide">
        <label for="recruiter_id">Рекрутёр</label>
        <select id="recruiter_id" name="recruiter_id">
          <option value="">— все —</option>
          {% for r in recruiter_options %}
            <option value="{{ r.id }}" {% if filter_recruiter_id and filter_recruiter_id == r.id %}selected{% endif %}>
              {{ r.name }} ({{ r.tz or "Europe/Moscow" }})
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="form-field form-field--compact">
        <label for="per_page">На странице</label>
        <select id="per_page" name="per_page">
          {% for n in [10, 20, 50, 100] %}
            <option value="{{ n }}" {% if per_page == n %}selected{% endif %}>{{ n }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="toolbar__cluster toolbar__cluster--grow">
      <div class="form-field">
        <label for="status">Статус</label>
        {% set status_options = [
          {'label': 'Все', 'value': '', 'id': 'status-all', 'icon': slot_status_icon('TOTAL'), 'default': true},
          {'label': 'FREE', 'value': 'FREE', 'id': 'status-free', 'icon': slot_status_icon('FREE'), 'tone': 'success'},
          {'label': 'PENDING', 'value': 'PENDING', 'id': 'status-pending', 'icon': slot_status_icon('PENDING'), 'tone': 'warning'},
          {'label': 'BOOKED', 'value': 'BOOKED', 'id': 'status-booked', 'icon': slot_status_icon('BOOKED'), 'tone': 'info'}
        ] %}
        {{ segmented_control('status', status_options, value=filter_status, attrs='aria-label="Фильтр по статусу"') }}
      </div>
    </div>

    <div class="toolbar__cluster toolbar__cluster--compact">
      <label class="toolbar-toggle" for="only_future">
        <input id="only_future" type="checkbox">
        <span class="toolbar-toggle__indicator" aria-hidden="true"></span>
        <span class="toolbar-toggle__label">Только будущие слоты</span>
      </label>
      <label class="toolbar-toggle" for="toggle_cand_tz">
        <input id="toggle_cand_tz" type="checkbox">
        <span class="toolbar-toggle__indicator" aria-hidden="true"></span>
        <span class="toolbar-toggle__label">Показать время кандидата</span>
      </label>
    </div>
  {% endcall %}

  {% if not slots %}
    <div class="card glass grain">
      <h3 class="section-title">Пусто</h3>
      <p class="page-description">Слотов по выбранным условиям нет.</p>
    </div>
  {% else %}
    <div class="list-table-wrapper data-table" data-scroll-container>
      <div class="data-table__scroll" role="region" aria-label="Таблица слотов" tabindex="0">
        <table id="slots-table" class="list-table list-table--responsive">
          <thead>
            <tr>
              <th class="sortable" data-sort="id">ID <span class="dir"></span></th>
              <th class="sortable" data-sort="rec">Рекрутёр <span class="dir"></span></th>
              <th class="sortable" data-sort="utc">UTC <span class="dir"></span></th>
              <th>Локальное (TZ рекрутёра)</th>
              <th class="col-cand-tz is-optional">Локальное (TZ кандидата)</th>
              <th class="sortable" data-sort="status">Статус <span class="dir"></span></th>
              <th class="sortable" data-sort="cand">Кандидат <span class="dir"></span></th>
              <th data-label="">Действия</th>
            </tr>
          </thead>
          <tbody>
          {% for s in slots %}
            {% set st = norm_status(s.status) %}
            {% set row_cls = 'row-free' if st=='FREE' else ('row-pending' if st=='PENDING' else ('row-booked' if st=='BOOKED' else '')) %}
            {% set details_id = 'slot-details-' ~ s.id %}
            <tr class="{{ row_cls }}" data-st="{{ st or '' }}" data-id="{{ s.id }}" data-utc="{{ s.start_utc.isoformat() }}" data-rec="{{ s.recruiter.name if s.recruiter else '' }}" data-cand="{{ s.candidate_fio or '' }}" data-sto="{{ 0 if st=='FREE' else (1 if st=='PENDING' else (2 if st=='BOOKED' else 9)) }}">
              <td data-label="ID">
                <span class="copyable" data-copy="{{ s.id }}" title="Скопировать ID">{{ s.id }}</span>
              </td>
              <td data-label="Рекрутёр">
                <div>{{ s.recruiter.name if s.recruiter else "—" }}</div>
                <div class="badge">{{ (s.recruiter.tz if s.recruiter and s.recruiter.tz else "Europe/Moscow") }}</div>
              </td>
              <td data-label="UTC">
                <span class="copyable" data-copy="{{ fmt_utc(s.start_utc) }}" title="Скопировать UTC-время" data-utc-iso="{{ s.start_utc.isoformat() }}">
                  {{ fmt_utc(s.start_utc) }}
                </span>
                <div class="muted" data-rel></div>
              </td>
              <td data-label="Локальное (рекрутёр)">
                {% set tz_rec = (s.recruiter.tz if s.recruiter and s.recruiter.tz else "Europe/Moscow") %}
                <span class="copyable" data-copy="{{ fmt_local(s.start_utc, tz_rec) }}" title="Скопировать локальное время рекрутёра">
                  {{ fmt_local(s.start_utc, tz_rec) }}
                </span>
              </td>
              <td class="col-cand-tz is-optional" data-label="Кандидат TZ">
                {% if s.candidate_tz %}
                  <div class="badge">{{ s.candidate_tz }}</div>
                  <span class="copyable" data-copy="{{ fmt_local(s.start_utc, s.candidate_tz) }}" title="Скопировать локальное время кандидата">
                    {{ fmt_local(s.start_utc, s.candidate_tz) }}
                  </span>
                {% else %}
                  <span class="badge">—</span>
                {% endif %}
              </td>
              <td data-label="Статус">
                {% if st == "FREE" %}
                  <span class="status-pill" data-tone="success">
                    <span class="status-pill__icon" aria-hidden="true">{{ slot_status_icon('FREE') }}</span>
                    <span>FREE</span>
                  </span>
                {% elif st == "PENDING" %}
                  <span class="status-pill" data-tone="warning">
                    <span class="status-pill__icon" aria-hidden="true">{{ slot_status_icon('PENDING') }}</span>
                    <span>PENDING</span>
                  </span>
                {% elif st == "BOOKED" %}
                  <span class="status-pill" data-tone="info">
                    <span class="status-pill__icon" aria-hidden="true">{{ slot_status_icon('BOOKED') }}</span>
                    <span>BOOKED</span>
                  </span>
                {% else %}
                  <span class="badge">{{ st or "—" }}</span>
                {% endif %}
              </td>
              <td data-label="Кандидат">
                {% if s.candidate_fio %}
                  <div>{{ s.candidate_fio }}</div>
                  <div class="badge copyable" data-copy="{{ s.candidate_tg_id or '' }}" data-copy-feedback="tg_id скопирован" title="Скопировать tg_id">tg_id: {{ s.candidate_tg_id or "—" }}</div>
                {% else %}
                  <span class="badge">—</span>
                {% endif %}
              </td>
              <td class="slot-card__actions-cell" data-label="Действия">
                <div class="slot-card__actions">
                  <button
                    type="button"
                    class="slot-card__action"
                    data-role="expand"
                    data-target="{{ details_id }}"
                    aria-expanded="false"
                    aria-controls="{{ details_id }}">
                    <span class="slot-card__action-icon" aria-hidden="true">
                      <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M5 7.5 10 12.5 15 7.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                    </span>
                    <span class="slot-card__action-label">Подробнее</span>
                  </button>
                  <button type="button" class="slot-card__action" data-role="copy" data-copy="{{ s.id }}" data-copy-feedback="ID скопирован">
                    <span class="slot-card__action-icon" aria-hidden="true">
                      <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M7.25 5.25v-1.5a1.5 1.5 0 0 1 1.5-1.5h6.5a1.5 1.5 0 0 1 1.5 1.5v8.5a1.5 1.5 0 0 1-1.5 1.5h-1.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" />
                        <rect x="3.25" y="5.25" width="9.5" height="11.5" rx="1.8" stroke="currentColor" stroke-width="1.4" />
                      </svg>
                    </span>
                    <span class="slot-card__action-label" data-copy-label>ID {{ s.id }}</span>
                  </button>
                </div>
                <details class="slot-card__details" id="{{ details_id }}">
                  <summary>Подробнее о слоте {{ s.id }}</summary>
                  <div class="meta-list">
                    <span>UTC: {{ fmt_utc(s.start_utc) }}</span>
                    <span>Рекрутёр: {{ s.recruiter.name if s.recruiter else '—' }}</span>
                    {% if s.candidate_fio %}<span>Кандидат: {{ s.candidate_fio }}</span>{% endif %}
                    {% if s.candidate_tz %}<span>TZ кандидата: {{ s.candidate_tz }}</span>{% endif %}
                  </div>
                </details>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <nav class="pager" aria-label="Пагинация по слотам">
      {% set qrecr = '&recruiter_id=' ~ filter_recruiter_id if filter_recruiter_id else '' %}
      {% set qstat = '&status=' ~ filter_status if filter_status else '' %}
      {% set qpp = '&per_page=' ~ per_page if per_page else '' %}

      <span class="pager__badge">Стр. {{ page }} из {{ pages_total }}</span>

      {% if page > 1 %}
        <a class="btn btn-ghost" href="/slots?page=1{{ qrecr }}{{ qstat }}{{ qpp }}">« Первая</a>
        <a class="btn btn-ghost" href="/slots?page={{ page-1 }}{{ qrecr }}{{ qstat }}{{ qpp }}">‹ Назад</a>
      {% else %}
        <span class="btn btn-ghost" aria-disabled="true">« Первая</span>
        <span class="btn btn-ghost" aria-disabled="true">‹ Назад</span>
      {% endif %}

      {% if page < pages_total %}
        <a class="btn btn-ghost" href="/slots?page={{ page+1 }}{{ qrecr }}{{ qstat }}{{ qpp }}">Вперёд ›</a>
        <a class="btn btn-ghost" href="/slots?page={{ pages_total }}{{ qrecr }}{{ qstat }}{{ qpp }}">Последняя »</a>
      {% else %}
        <span class="btn btn-ghost" aria-disabled="true">Вперёд ›</span>
        <span class="btn btn-ghost" aria-disabled="true">Последняя »</span>
      {% endif %}
    </nav>
  {% endif %}
</section>

{% raw %}
<script>
(function(){
  const $ = (s, r) => (r || document).querySelector(s);
  const $$ = (s, r) => Array.from((r || document).querySelectorAll(s));

  const rows = $$('#slots-table tbody tr');
  const onlyFuture = $('#only_future');
  const candTzToggle = $('#toggle_cand_tz');
  const filterPanels = $$('[data-toolbar-collapsible]');
  const scrollContainer = document.querySelector('[data-scroll-container]');

  function copyText(value){
    if (navigator.clipboard && navigator.clipboard.writeText){
      return navigator.clipboard.writeText(value);
    }
    return new Promise(function(resolve, reject){
      try {
        const area = document.createElement('textarea');
        area.value = value;
        area.setAttribute('readonly', '');
        area.style.position = 'absolute';
        area.style.left = '-9999px';
        document.body.appendChild(area);
        area.select();
        const ok = typeof document.execCommand === 'function' ? document.execCommand('copy') : false;
        document.body.removeChild(area);
        if (ok) resolve();
        else reject(new Error('execCommand failed'));
      } catch (err){
        reject(err);
      }
    });
  }

  function attachCopyTriggers(scope){
    $$("[data-copy]", scope || document).forEach(function(trigger){
      if (trigger.dataset.copyBound) return;
      trigger.dataset.copyBound = '1';
      const value = trigger.getAttribute('data-copy') || '';
      const feedback = trigger.getAttribute('data-copy-feedback') || 'Скопировано';
      const labelEl = trigger.querySelector('[data-copy-label]');
      const original = labelEl ? labelEl.textContent : trigger.textContent;
      const delay = parseInt(trigger.getAttribute('data-copy-delay') || '900', 10);
      trigger.addEventListener('click', function(){
        copyText(value).then(function(){
          trigger.classList.add('is-copied');
          if (labelEl) { labelEl.textContent = feedback; }
          else { trigger.textContent = feedback; }
          window.setTimeout(function(){
            trigger.classList.remove('is-copied');
            if (labelEl) { labelEl.textContent = original; }
            else { trigger.textContent = original; }
          }, delay);
        }).catch(function(){
          alert('Не удалось скопировать');
        });
      });
    });
  }

  attachCopyTriggers(document);

  function isFuture(tr){
    const iso = tr.getAttribute('data-utc');
    if (!iso) return true;
    const t = Date.parse(iso);
    return Number.isFinite(t) ? t >= Date.now() : true;
  }

  function refreshCounts(){
    const fut = !!(onlyFuture && onlyFuture.checked);
    let free = 0, pend = 0, book = 0, total = 0;
    rows.forEach(function(tr){
      const visible = !fut || isFuture(tr);
      tr.style.display = visible ? '' : 'none';
      if (visible){
        total++;
        const st = tr.getAttribute('data-st');
        if (st === 'FREE') free++;
        else if (st === 'PENDING') pend++;
        else if (st === 'BOOKED') book++;
      }
    });
    const totalEl = $('#cnt-total');
    if (totalEl) totalEl.textContent = total;
    const freeEl = $('#cnt-free');
    if (freeEl) freeEl.textContent = free;
    const pendEl = $('#cnt-pending');
    if (pendEl) pendEl.textContent = pend;
    const bookEl = $('#cnt-booked');
    if (bookEl) bookEl.textContent = book;
  }

  if (onlyFuture){
    onlyFuture.addEventListener('change', refreshCounts);
  }

  function setCandCol(show){
    $$('.col-cand-tz').forEach(function(col){
      col.classList.toggle('hidden-col', !show);
    });
  }

  if (candTzToggle){
    candTzToggle.addEventListener('change', function(){
      setCandCol(candTzToggle.checked);
    });
    setCandCol(candTzToggle.checked);
  }

  if (filterPanels.length){
    const mq = window.matchMedia('(min-width: 960px)');
    const applyMediaState = function(panel, matches){
      if (matches){
        panel.open = true;
        panel.dataset.mediaOpen = '1';
      } else if (panel.dataset.mediaOpen){
        panel.open = false;
        delete panel.dataset.mediaOpen;
      }
    };
    filterPanels.forEach(function(panel){
      if (panel.hasAttribute('open')){
        panel.dataset.mediaOpen = panel.dataset.mediaOpen || '1';
      }
    });
    const syncFilters = function(matches){
      filterPanels.forEach(function(panel){ applyMediaState(panel, matches); });
    };
    syncFilters(mq.matches);
    const mqHandler = function(e){ syncFilters(e.matches); };
    if (mq.addEventListener) mq.addEventListener('change', mqHandler);
    else if (mq.addListener) mq.addListener(mqHandler);
    filterPanels.forEach(function(panel){
      panel.addEventListener('toggle', function(){
        if (!panel.open){
          delete panel.dataset.mediaOpen;
        }
      });
    });
  }

  if (scrollContainer){
    const scroller = scrollContainer.querySelector('.data-table__scroll');
    if (scroller){
      const updateScroll = function(){
        const scrollable = scroller.scrollWidth - scroller.clientWidth > 1;
        const atStart = scroller.scrollLeft <= 1;
        const atEnd = scroller.scrollLeft >= (scroller.scrollWidth - scroller.clientWidth - 1);
        scrollContainer.classList.toggle('is-scrollable', scrollable);
        scrollContainer.classList.toggle('is-scrolled', scrollable && !atStart);
        scrollContainer.classList.toggle('is-scroll-end', atEnd || !scrollable);
      };
      updateScroll();
      scroller.addEventListener('scroll', updateScroll);
      window.addEventListener('resize', updateScroll);
    }
  }

  $$('.slot-card__action[data-role="expand"]').forEach(function(btn){
    const targetId = btn.getAttribute('data-target');
    const details = targetId ? document.getElementById(targetId) : null;
    if (!details) return;
    const syncExpanded = function(){
      const expanded = details.hasAttribute('open') || details.open;
      btn.classList.toggle('is-active', expanded);
      btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
    };
    syncExpanded();
    btn.addEventListener('click', function(){
      const open = details.hasAttribute('open');
      if (open) { details.removeAttribute('open'); }
      else { details.setAttribute('open', ''); }
      syncExpanded();
    });
    details.addEventListener('toggle', syncExpanded);
  });

  function rel(ts){
    const diff = Math.round((ts - Date.now()) / 60000);
    const abs = Math.abs(diff);
    if (abs < 60) return (diff >= 0 ? 'через ' : '') + abs + ' мин';
    const h = Math.round(abs / 60);
    return (diff >= 0 ? 'через ' : '') + h + ' ч';
  }

  function updateRel(){
    $$('#slots-table [data-utc-iso]').forEach(function(el){
      const iso = el.getAttribute('data-utc-iso');
      const d = iso ? new Date(iso) : null;
      const holder = el.parentElement.querySelector('[data-rel]');
      if (d && holder) holder.textContent = rel(d.getTime());
    });
  }

  updateRel();
  setInterval(updateRel, 60000);

  let sortKey = 'utc';
  let sortDir = 'asc';

  function applySortIndicator(){
    $$('#slots-table thead th.sortable').forEach(function(th){
      th.classList.remove('active');
      const d = th.querySelector('.dir');
      if (d) d.textContent = '';
    });
    const th = $('#slots-table thead th.sortable[data-sort="' + sortKey + '"]');
    if (th){
      th.classList.add('active');
      const d = th.querySelector('.dir');
      if (d) d.textContent = sortDir === 'asc' ? '▲' : '▼';
    }
  }

  function cmp(a, b){ return a < b ? -1 : (a > b ? 1 : 0); }

  function sortRows(){
    const tbody = $('#slots-table tbody');
    const arr = rows.slice();
    arr.sort(function(tr1, tr2){
      let v1, v2;
      if (sortKey === 'id'){
        v1 = parseInt(tr1.getAttribute('data-id') || '0', 10);
        v2 = parseInt(tr2.getAttribute('data-id') || '0', 10);
      } else if (sortKey === 'utc'){
        v1 = Date.parse(tr1.getAttribute('data-utc') || '');
        v2 = Date.parse(tr2.getAttribute('data-utc') || '');
      } else if (sortKey === 'rec'){
        v1 = (tr1.getAttribute('data-rec') || '').toLowerCase();
        v2 = (tr2.getAttribute('data-rec') || '').toLowerCase();
      } else if (sortKey === 'cand'){
        v1 = (tr1.getAttribute('data-cand') || '').toLowerCase();
        v2 = (tr2.getAttribute('data-cand') || '').toLowerCase();
      } else if (sortKey === 'status'){
        v1 = parseInt(tr1.getAttribute('data-sto') || '9', 10);
        v2 = parseInt(tr2.getAttribute('data-sto') || '9', 10);
      } else {
        v1 = 0; v2 = 0;
      }
      const r = cmp(v1, v2);
      return sortDir === 'asc' ? r : -r;
    });
    arr.forEach(function(tr){ tbody.appendChild(tr); });
  }

  $$('#slots-table thead th.sortable').forEach(function(th){
    th.addEventListener('click', function(){
      const key = th.getAttribute('data-sort');
      if (sortKey === key) sortDir = (sortDir === 'asc') ? 'desc' : 'asc';
      else { sortKey = key; sortDir = 'asc'; }
      applySortIndicator();
      sortRows();
      refreshCounts();
    });
  });

  document.addEventListener('keydown', function(e){
    if (e.key === 't' && candTzToggle){
      candTzToggle.checked = !candTzToggle.checked;
      candTzToggle.dispatchEvent(new Event('change'));
    }
    if (e.key === 'f' && onlyFuture){
      onlyFuture.checked = !onlyFuture.checked;
      onlyFuture.dispatchEvent(new Event('change'));
    }
  });

  applySortIndicator();
  sortRows();
  refreshCounts();
})();
</script>
{% endraw %}

{% endblock %}
