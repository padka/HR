{% extends "base.html" %}
{% block title %}–®–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π{% endblock %}
{% block content %}
<section class="page">
  <header class="page-header">
    <div>
      <h1 class="page-title">–®–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π</h1>
      <p class="page-description">
        –£–ø—Ä–∞–≤–ª—è–π—Ç–µ –≤—Å–µ–º–∏ —Ç–µ–∫—Å—Ç–∞–º–∏ –±–æ—Ç–∞: —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —ç—Ç–∞–ø–∞—Ö –∏–Ω—Ç–µ—Ä–≤—å—é –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
        –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å—Ç—É–ø–∞—é—Ç –≤ —Å–∏–ª—É —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.
      </p>
    </div>
  </header>

  <!-- Main Tabs: –≠—Ç–∞–ø—ã / –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
  <nav class="template-tabs template-tabs--main" role="tablist" aria-label="–¢–∏–ø—ã —à–∞–±–ª–æ–Ω–æ–≤">
    <button type="button" class="template-tab is-active" data-main-tab="stages">
      üìã –≠—Ç–∞–ø—ã –∏–Ω—Ç–µ—Ä–≤—å—é
    </button>
    <button type="button" class="template-tab" data-main-tab="notifications">
      üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    </button>
  </nav>

  <!-- Tab 1: –≠–¢–ê–ü–´ –ò–ù–¢–ï–†–í–¨–Æ -->
  <div class="tab-content is-active" data-main-content="stages">
    <div class="page-actions mt-md">
      <a class="btn btn-primary" href="/templates/new">–ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω —ç—Ç–∞–ø–∞</a>
    </div>

    <div class="card glass grain mt-md">
      <h2 class="section-title">–≠—Ç–∞–ø—ã –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</h2>
      <p class="section-subtitle">–ö–ª—é—á–µ–≤—ã–µ —à–∞–≥–∏, –Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å –±–æ—Ç–æ–º.</p>
      <ol class="stage-flow muted">
        <li><strong>–®–∞–≥ 1.</strong> –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤—ã–±—Ä–∞—Ç—å –≤—Ä–µ–º—è –¥–ª—è –≤–∏–¥–µ–æ–∏–Ω—Ç–µ—Ä–≤—å—é.</li>
        <li><strong>–®–∞–≥ 2.</strong> –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 2 —á–∞—Å–∞ –¥–æ –∏–Ω—Ç–µ—Ä–≤—å—é —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º.</li>
        <li><strong>–®–∞–≥ 3.</strong> –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –Ω–∞ –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω—å –ø–æ—Å–ª–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã.</li>
        <li><strong>–®–∞–≥ 4.</strong> –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —è–≤–∫–∏ –∑–∞ 2 —á–∞—Å–∞ –¥–æ –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥–Ω—è.</li>
      </ol>
      <div class="badge info-badge">
        {% raw %}
        –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: <code>{{candidate_fio}}</code>, <code>{{city_name}}</code>, <code>{{interview_dt_hint}}</code>,
        <code>{{slot_date_local}}</code>, <code>{{slot_time_local}}</code>, <code>{{slot_datetime_local}}</code>,
        <code>{{recruiter_name}}</code>, <code>{{address}}</code>.
        {% endraw %}
      </div>
    </div>

    <!-- Sub-tabs for Stages: Global / Cities -->
    <nav class="template-tabs mt-md" role="tablist" aria-label="–û–±–ª–∞—Å—Ç–∏ –¥–µ–π—Å—Ç–≤–∏—è">
      <button type="button" class="template-tab is-active" data-tab-target="global">–ì–ª–æ–±–∞–ª—å–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã</button>
      <button type="button" class="template-tab" data-tab-target="cities">–®–∞–±–ª–æ–Ω—ã –≥–æ—Ä–æ–¥–æ–≤</button>
    </nav>

    <!-- Global Templates -->
    <section class="card glass grain mt-sm template-panel is-active" data-panel="global">
      <header class="template-panel__header">
        <div>
          <h3 class="card-title">–ì–ª–æ–±–∞–ª—å–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã</h3>
          <p class="page-description">–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è, –µ—Å–ª–∏ –¥–ª—è –≥–æ—Ä–æ–¥–∞ –Ω–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.</p>
        </div>
      </header>
      <div class="list-table-wrapper">
        <table class="list-table template-table" data-template-table="global">
          <thead>
            <tr>
              <th scope="col">–≠—Ç–∞–ø</th>
              <th scope="col" class="is-optional">–û–ø–∏—Å–∞–Ω–∏–µ</th>
              <th scope="col">–¢–µ–∫—Å—Ç</th>
              <th scope="col" class="col-align-end">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody>
            {% for stage in overview.global.stages %}
              {% set preview_text = stage.value or stage.default %}
              <tr
                class="template-row{% if stage.is_custom %} is-custom{% endif %}"
                data-template-row
                data-stage="{{ stage.key }}"
                data-stage-title="{{ stage.title }}"
                data-city=""
                data-default="{{ stage.default|e }}"
                data-current="{{ stage.value|e }}"
              >
                <td data-label="–≠—Ç–∞–ø">
                  <div class="template-stage">
                    <strong>{{ stage.title }}</strong>
                    <span class="template-stage__key"><code class="text-mono">{{ stage.key }}</code></span>
                  </div>
                </td>
                <td data-label="–û–ø–∏—Å–∞–Ω–∏–µ" class="template-description is-optional">{{ stage.description }}</td>
                <td data-label="–¢–µ–∫—Å—Ç" class="template-cell">
                  <div class="template-preview" data-role="preview">{{ preview_text or "‚Äî" }}</div>
                  <div class="template-status-line">
                    <span class="badge template-status{% if stage.is_custom %} template-status--custom{% endif %}" data-role="status">
                      {% if stage.is_custom %}–°–≤–æ–π —Ç–µ–∫—Å—Ç{% else %}–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é{% endif %}
                    </span>
                    <span class="badge muted template-save-indicator" data-role="save-indicator" hidden>–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>
                  </div>
                  <textarea
                    class="template-editor"
                    data-role="editor"
                    data-default="{{ stage.default|e }}"
                    rows="6"
                    hidden
                  >{{ stage.value or "" }}</textarea>
                </td>
                <td data-label="–î–µ–π—Å—Ç–≤–∏—è" class="col-align-end">
                  <div class="template-actions" data-role="view-actions">
                    <button type="button" class="btn btn-soft btn--small" data-action="edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button type="button" class="btn btn-ghost btn--small template-action--danger" data-action="clear">–£–¥–∞–ª–∏—Ç—å</button>
                  </div>
                  <div class="template-actions" data-role="edit-actions" hidden>
                    <button type="button" class="btn btn-primary btn--small" data-action="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-soft btn--small" data-action="cancel">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-ghost btn--small" data-action="reset">–°–±—Ä–æ—Å–∏—Ç—å –∫ —É–º–æ–ª—á–∞–Ω–∏—é</button>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- City Templates -->
    <section class="card glass grain mt-sm template-panel" data-panel="cities">
      <header class="template-panel__header">
        <div>
          <h3 class="card-title">–®–∞–±–ª–æ–Ω—ã –≥–æ—Ä–æ–¥–æ–≤</h3>
          <p class="page-description">–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤. –ï—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω—ã–µ.</p>
        </div>
      </header>
      {% for city_data in overview.cities %}
        <div class="city-block">
          <h4 class="city-block__title">{{ city_data.city_name }}</h4>
          <div class="list-table-wrapper">
            <table class="list-table template-table" data-template-table="city-{{ city_data.city_id }}">
              <thead>
                <tr>
                  <th scope="col">–≠—Ç–∞–ø</th>
                  <th scope="col">–¢–µ–∫—Å—Ç</th>
                  <th scope="col" class="col-align-end">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody>
                {% for stage in city_data.stages %}
                  {% set preview_text = stage.value or stage.default %}
                  <tr
                    class="template-row{% if stage.is_custom %} is-custom{% endif %}"
                    data-template-row
                    data-stage="{{ stage.key }}"
                    data-stage-title="{{ stage.title }}"
                    data-city="{{ city_data.city_id }}"
                    data-default="{{ stage.default|e }}"
                    data-current="{{ stage.value|e }}"
                  >
                    <td data-label="–≠—Ç–∞–ø">
                      <div class="template-stage">
                        <strong>{{ stage.title }}</strong>
                        <span class="template-stage__key"><code class="text-mono">{{ stage.key }}</code></span>
                      </div>
                    </td>
                    <td data-label="–¢–µ–∫—Å—Ç" class="template-cell">
                      <div class="template-preview" data-role="preview">{{ preview_text or "‚Äî" }}</div>
                      <div class="template-status-line">
                        <span class="badge template-status{% if stage.is_custom %} template-status--custom{% endif %}" data-role="status">
                          {% if stage.is_custom %}–°–≤–æ–π —Ç–µ–∫—Å—Ç{% else %}–ì–ª–æ–±–∞–ª—å–Ω—ã–π{% endif %}
                        </span>
                        <span class="badge muted template-save-indicator" data-role="save-indicator" hidden>–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>
                      </div>
                      <textarea
                        class="template-editor"
                        data-role="editor"
                        data-default="{{ stage.default|e }}"
                        rows="6"
                        hidden
                      >{{ stage.value or "" }}</textarea>
                    </td>
                    <td data-label="–î–µ–π—Å—Ç–≤–∏—è" class="col-align-end">
                      <div class="template-actions" data-role="view-actions">
                        <button type="button" class="btn btn-soft btn--small" data-action="edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button type="button" class="btn btn-ghost btn--small template-action--danger" data-action="clear">–£–¥–∞–ª–∏—Ç—å</button>
                      </div>
                      <div class="template-actions" data-role="edit-actions" hidden>
                        <button type="button" class="btn btn-primary btn--small" data-action="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button type="button" class="btn btn-soft btn--small" data-action="cancel">–û—Ç–º–µ–Ω–∞</button>
                        <button type="button" class="btn btn-ghost btn--small" data-action="reset">–°–±—Ä–æ—Å–∏—Ç—å –∫ –≥–ª–æ–±–∞–ª—å–Ω–æ–º—É</button>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endfor %}
    </section>
  </div>

  <!-- Tab 2: –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø -->
  <div class="tab-content" data-main-content="notifications">
    <div class="page-actions mt-md">
      <a class="btn btn-primary" href="/message-templates/new">–ù–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</a>
    </div>

    {% if missing_required %}
      <div class="alert alert--warning mt-md">
        <strong>–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è –∫–ª—é—á–µ–π:</strong>
        <span class="badge-list">
          {% for key in missing_required %}
            <span class="badge badge--warning">{{ key }}</span>
          {% endfor %}
        </span>
        <p class="mt-xs">–î–æ–±–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç—ã –¥–ª—è –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π, —á—Ç–æ–±—ã –±–æ—Ç –º–æ–≥ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.</p>
      </div>
    {% endif %}

    <div class="card glass grain mt-md">
      <h2 class="card-title">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∫–ª—é—á–µ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h2>
      <p class="page-description mb-sm">
        –≠—Ç–∏ –∫–ª—é—á–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º –∏ —Ä–µ–∫—Ä—É—Ç–µ—Ä–∞–º.
      </p>
      <div class="list-table-wrapper">
        <table class="list-table">
          <thead>
            <tr>
              <th scope="col">–ö–ª—é—á</th>
              <th scope="col">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</th>
            </tr>
          </thead>
          <tbody>
            {% for key, hint in known_hints.items() %}
              <tr>
                <td><code class="text-mono">{{ key }}</code></td>
                <td>{{ hint }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="card glass grain mt-md">
      <h2 class="card-title">–í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
      {% if message_templates %}
        <div class="list-table-wrapper">
          <table class="list-table">
            <thead>
              <tr>
                <th scope="col">–ö–ª—é—á</th>
                <th scope="col">–õ–æ–∫–∞–ª—å</th>
                <th scope="col">–ö–∞–Ω–∞–ª</th>
                <th scope="col">–í–µ—Ä—Å–∏—è</th>
                <th scope="col">–°—Ç–∞—Ç—É—Å</th>
                <th scope="col">–û–±–Ω–æ–≤–ª–µ–Ω–æ</th>
                <th scope="col">–§—Ä–∞–≥–º–µ–Ω—Ç</th>
                <th scope="col" class="col-align-end">–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody>
              {% for tmpl in message_templates %}
                <tr>
                  <td data-label="–ö–ª—é—á">
                    <code class="text-mono">{{ tmpl.key }}</code>
                  </td>
                  <td data-label="–õ–æ–∫–∞–ª—å">{{ tmpl.locale }}</td>
                  <td data-label="–ö–∞–Ω–∞–ª">{{ tmpl.channel }}</td>
                  <td data-label="–í–µ—Ä—Å–∏—è">v{{ tmpl.version }}</td>
                  <td data-label="–°—Ç–∞—Ç—É—Å">
                    {% if tmpl.is_active %}
                      <span class="badge badge--success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                    {% else %}
                      <span class="badge badge--muted">–û—Ç–∫–ª—é—á–µ–Ω</span>
                    {% endif %}
                  </td>
                  <td data-label="–û–±–Ω–æ–≤–ª–µ–Ω–æ">
                    <time datetime="{{ tmpl.updated_at.isoformat() }}">
                      {{ tmpl.updated_at.strftime('%d.%m.%Y %H:%M') }}
                    </time>
                  </td>
                  <td data-label="–§—Ä–∞–≥–º–µ–Ω—Ç" class="text-truncate" style="max-width: 300px;">
                    {{ tmpl.body_md[:100] }}{% if tmpl.body_md|length > 100 %}...{% endif %}
                  </td>
                  <td data-label="–î–µ–π—Å—Ç–≤–∏—è" class="col-align-end">
                    <a href="/message-templates/{{ tmpl.id }}/edit" class="btn btn-soft btn--small">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                    <form method="post" action="/message-templates/{{ tmpl.id }}/delete" style="display:inline;" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω?');">
                      <button type="submit" class="btn btn-ghost btn--small">–£–¥–∞–ª–∏—Ç—å</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="muted">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–ù–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ¬ª –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è.</p>
      {% endif %}
    </div>
  </div>
</section>

<style>
  /* Main tabs styling */
  .template-tabs--main {
    margin-top: 1.5rem;
    border-bottom: 2px solid var(--color-border, #e5e7eb);
    display: flex;
    gap: 0.5rem;
  }

  .template-tabs--main .template-tab {
    font-size: 1rem;
    padding: 0.75rem 1.5rem;
    font-weight: 500;
  }

  .tab-content {
    display: none;
  }

  .tab-content.is-active {
    display: block;
  }

  .city-block {
    margin-top: 1.5rem;
    padding: 1rem;
    border: 1px solid var(--color-border, #e5e7eb);
    border-radius: 0.5rem;
  }

  .city-block__title {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--color-primary, #3b82f6);
  }

  .stage-flow {
    padding-left: 1.5rem;
    line-height: 1.8;
    color: var(--color-text-secondary, #6b7280);
  }

  .stage-flow li {
    margin-bottom: 0.5rem;
  }

  .info-badge {
    margin-top: 1rem;
    padding: 0.75rem 1rem;
    background-color: var(--color-info-light, #dbeafe);
    border-radius: 0.375rem;
    font-size: 0.875rem;
    line-height: 1.6;
  }

  .badge-list {
    display: inline-flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Main tabs (–≠—Ç–∞–ø—ã / –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
    const mainTabs = document.querySelectorAll('[data-main-tab]');
    const mainContents = document.querySelectorAll('[data-main-content]');

    mainTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const target = tab.dataset.mainTab;

        // Update tabs
        mainTabs.forEach(t => t.classList.remove('is-active'));
        tab.classList.add('is-active');

        // Update content
        mainContents.forEach(c => c.classList.remove('is-active'));
        const activeContent = document.querySelector(`[data-main-content="${target}"]`);
        if (activeContent) {
          activeContent.classList.add('is-active');
        }
      });
    });

    // Sub-tabs (Global / Cities) - existing functionality
    const subTabs = document.querySelectorAll('[data-tab-target]');
    const panels = document.querySelectorAll('[data-panel]');

    subTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const target = tab.dataset.tabTarget;

        // Update tabs
        subTabs.forEach(t => t.classList.remove('is-active'));
        tab.classList.add('is-active');

        // Update panels
        panels.forEach(p => p.classList.remove('is-active'));
        const activePanel = document.querySelector(`[data-panel="${target}"]`);
        if (activePanel) {
          activePanel.classList.add('is-active');
        }
      });
    });
  });
</script>
{% endblock %}
