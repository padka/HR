{% extends "base.html" %}
{% import "partials/form_shell.html" as forms with context %}
{% block title %}Новый кандидат{% endblock %}
{% block content %}
<script nonce="{{ request.state.csp_nonce }}">
  document.body.dataset.page = 'candidates-new';
</script>
{% set error = request.query_params.get('error') %}
{% if error %}
  {% set messages = {
    'validation': 'Проверьте корректность введённых данных.',
    'duplicate': 'Кандидат уже существует.',
    'slot_conflict': 'Не удалось создать слот: пересечение с расписанием. Выберите другое время.'
  } %}
  <div class="surface glass grain alert" data-tone="danger" role="alert">
    {{ messages.get(error, 'Не удалось сохранить кандидата.') }}
  </div>
{% endif %}
{% if not city_choices or not recruiters %}
  <div class="surface glass grain alert" data-tone="warning" role="alert" id="entity_alert">
    {% if not recruiters and not city_choices %}
      Нет рекрутёров и городов. Добавьте сущности, чтобы создать связанного кандидата.
      <div class="btn-group mt-sm">
        <a class="btn btn--ghost btn--sm" href="/recruiters/new">+ Рекрутёр</a>
        <a class="btn btn--ghost btn--sm" href="/cities/new">+ Город</a>
      </div>
    {% elif not recruiters %}
      Нет рекрутёров. Добавьте рекрутёра, чтобы назначать интервью.
      <div class="btn-group mt-sm">
        <a class="btn btn--ghost btn--sm" href="/recruiters/new">+ Рекрутёр</a>
      </div>
    {% else %}
      Нет городов. Добавьте город, чтобы назначать интервью.
      <div class="btn-group mt-sm">
        <a class="btn btn--ghost btn--sm" href="/cities/new">+ Город</a>
      </div>
    {% endif %}
  </div>
{% endif %}

{% call forms.shell(
  title="Новый кандидат",
  description="Создайте лид и сразу назначьте собеседование, чтобы слот появился в календаре и списке.",
  form_id="candidate-form",
  action="/candidates/create",
  autocomplete="off",
  meta=["LEAD", "manual_call"],
  actions=[
    {"type": "submit", "text": "Сохранить", "variant": "primary"},
    {"href": "/candidates", "text": "Отмена", "variant": "ghost"}
  ]
) %}
  <div class="candidate-create">
    <div class="candidate-create__layout">
      <div class="candidate-create__main">
        {% call forms.section("Карточка кандидата", hint="Основные данные лида и ответственный рекрутёр") %}
          <div class="form-grid form-grid--two">
            {% call forms.field("ФИО", required=True) %}
              <input id="fio" type="text" name="fio" placeholder="Иван Иванов" required aria-required="true">
            {% endcall %}
            {% call forms.field("Телефон", hint="Для первичного прозвона") %}
              <input id="phone" type="text" name="phone" placeholder="+7 900 000-00-00">
            {% endcall %}
          </div>
          <div class="form-grid form-grid--two">
            {% call forms.field("Город", hint="Единый город для карточки и интервью", required=True) %}
              <select id="city_id" name="city_id" required aria-required="true"{% if not city_choices %} disabled{% endif %} data-has-items="{{ 1 if city_choices else 0 }}">
                <option value="">— выберите город —</option>
                {% for city in city_choices %}
                  {% set tz_label = tz_display(city.tz) if city.tz else '' %}
                  <option value="{{ city.id }}" data-label="{{ city.name }}" data-tz-label="{{ tz_label }}">
                    {{ city.name }}{% if tz_label %} ({{ tz_label }}){% endif %}
                  </option>
                {% endfor %}
              </select>
            {% endcall %}
            {% call forms.field("Ответственный рекрутёр", hint="Владелец лида", required=True) %}
              {% set has_single_recruiter = recruiters|length == 1 %}
              <select id="responsible_recruiter_id" name="responsible_recruiter_id" required aria-required="true"{% if not recruiters %} disabled{% endif %} data-has-items="{{ 1 if recruiters else 0 }}">
                <option value="">— выберите рекрутёра —</option>
                {% for rec in recruiters %}
                  {% set tz_value = rec.tz or 'Europe/Moscow' %}
                  {% set tz_label = tz_display(tz_value) %}
                  <option value="{{ rec.id }}" data-tz="{{ tz_value }}" data-tz-label="{{ tz_label }}" data-active="{{ 'true' if rec.active else 'false' }}"{% if has_single_recruiter %} selected{% endif %}>
                    {{ rec.name }}{% if not rec.active %} (неактивен){% elif tz_label %} ({{ tz_label }}){% endif %}
                  </option>
                {% endfor %}
              </select>
            {% endcall %}
          </div>
          <div class="form-grid form-grid--two">
            {% call forms.field("Источник") %}
              <div class="candidate-create__source">
                <span class="chip">manual_call</span>
                <span class="candidate-create__source-note">Создан вручную</span>
              </div>
            {% endcall %}
          </div>
        {% endcall %}

        {% call forms.section("Назначение собеседования", hint="Создаст слот и отобразится в календаре, слотах и карточке кандидата") %}
          {% call forms.meta() %}
            {% call forms.note(inline=True, id='city_tz_hint') %}Город собеседования: —{% endcall %}
          {% endcall %}
          <div class="form-grid form-grid--two">
            {% call forms.field("Дата собеседования", hint="Создаст слот в календаре", required=True) %}
              <input id="interview_date" type="date" name="interview_date" required aria-required="true">
              <div class="btn-group">
                <button class="btn btn--ghost btn--sm" type="button" data-quick-date="today">Сегодня</button>
                <button class="btn btn--ghost btn--sm" type="button" data-quick-date="tomorrow">Завтра</button>
                <button class="btn btn--ghost btn--sm" type="button" data-quick-date="next-week">Через неделю</button>
              </div>
            {% endcall %}
            {% call forms.field("Время собеседования", hint="Используется часовой пояс выбранного города", required=True) %}
              <input id="interview_time" type="time" name="interview_time" required aria-required="true">
              <div class="btn-group">
                <button class="btn btn--ghost btn--sm" type="button" data-quick-time="10:00">10:00</button>
                <button class="btn btn--ghost btn--sm" type="button" data-quick-time="14:00">14:00</button>
                <button class="btn btn--ghost btn--sm" type="button" data-quick-time="16:30">16:30</button>
                <button class="btn btn--ghost btn--sm" type="button" data-quick-time="next30">+30 мин</button>
              </div>
            {% endcall %}
          </div>
        {% endcall %}
      </div>

      <aside class="candidate-create__aside">
        <div class="candidate-create__card surface glass grain">
          <div class="candidate-create__card-header">
            <div>
              <div class="candidate-create__card-title">Связи лида</div>
              <div class="candidate-create__card-subtitle">LEAD · manual_call</div>
            </div>
          </div>
          <div class="candidate-create__card-grid">
            <div>
              <span class="candidate-create__label">ФИО</span>
              <strong id="preview_fio">—</strong>
            </div>
            <div>
              <span class="candidate-create__label">Телефон</span>
              <strong id="preview_phone">—</strong>
            </div>
            <div>
              <span class="candidate-create__label">Город</span>
              <strong id="preview_city">—</strong>
            </div>
            <div>
              <span class="candidate-create__label">Рекрутёр</span>
              <strong id="preview_recruiter">—</strong>
            </div>
          </div>
        </div>

        <div class="preview-panel candidate-create__preview-panel" id="schedule_preview" aria-live="polite" aria-atomic="true">
          <b>Интервью</b><br>
          Слот не назначен. Лид останется в статусе LEAD.
        </div>

        <div class="candidate-create__steps" id="candidate_steps">
          <div class="candidate-create__step" data-state="done">
            <span>1</span>
            Карточка появится в списке кандидатов
          </div>
          <div class="candidate-create__step" data-state="idle" id="step_schedule">
            <span>2</span>
            Назначьте собеседование, чтобы слот попал в календарь
          </div>
          <div class="candidate-create__step" data-state="idle">
            <span>3</span>
            Пригласите кандидата в бот через invite-token
          </div>
        </div>
      </aside>
    </div>
  </div>
{% endcall %}

<style nonce="{{ request.state.csp_nonce }}">
  .candidate-create__layout {
    display: grid;
    gap: var(--grid-gap);
    grid-template-columns: minmax(0, 1.1fr) minmax(260px, 0.85fr);
    align-items: start;
  }

  .candidate-create__aside {
    display: grid;
    gap: 16px;
    position: sticky;
    top: 24px;
  }

  .candidate-create__card {
    padding: 18px 20px;
    border-radius: 18px;
    border: 1px solid color-mix(in srgb, var(--glass-stroke) 70%, transparent);
    box-shadow: var(--elevation-1);
    overflow: hidden;
    position: relative;
  }

  .candidate-create__card::before {
    content: "";
    position: absolute;
    inset: 0;
    background: radial-gradient(120px 90px at 85% 10%, color-mix(in srgb, var(--accent) 22%, transparent), transparent 70%);
    opacity: 0.55;
    pointer-events: none;
  }

  .candidate-create__card-header {
    display: flex;
    justify-content: space-between;
    gap: 16px;
    align-items: center;
  }

  .candidate-create__card-title {
    font-weight: 600;
    font-size: 1rem;
  }

  .candidate-create__card-subtitle {
    font-size: 12px;
    color: var(--muted);
  }

  .candidate-create__card-grid {
    margin-top: 16px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
  }

  .candidate-create__label {
    display: block;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--muted);
    margin-bottom: 6px;
  }

  .candidate-create__card-grid strong {
    font-weight: 600;
    color: var(--fg-strong, var(--fg));
  }

  .candidate-create__source {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }

  .candidate-create__source-note {
    font-size: 12px;
    color: var(--muted);
  }

  .candidate-create__preview-panel {
    position: relative;
    overflow: hidden;
  }

  .candidate-create__preview-panel::after {
    content: "";
    position: absolute;
    inset: 0;
    background: radial-gradient(120px 80px at 90% 20%, color-mix(in srgb, var(--success) 20%, transparent), transparent 70%);
    opacity: 0.4;
    pointer-events: none;
  }

  .candidate-create__steps {
    display: grid;
    gap: 10px;
  }

  .candidate-create__step {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 12px;
    align-items: center;
    padding: 12px 14px;
    border-radius: 14px;
    border: 1px solid color-mix(in srgb, var(--glass-stroke) 70%, transparent);
    background: linear-gradient(180deg, color-mix(in srgb, var(--glass-tint) 70%, transparent), color-mix(in srgb, var(--on-surface) 10%, transparent));
    font-size: 12px;
    color: var(--muted);
  }

  .candidate-create__step span {
    width: 26px;
    height: 26px;
    border-radius: 999px;
    display: grid;
    place-items: center;
    font-weight: 600;
    font-size: 12px;
    background: color-mix(in srgb, var(--accent) 20%, transparent);
    color: var(--fg);
  }

  .candidate-create__step[data-state="done"] {
    color: var(--fg);
    border-color: color-mix(in srgb, var(--success) 45%, transparent);
  }

  .candidate-create__step[data-state="done"] span {
    background: color-mix(in srgb, var(--success) 30%, transparent);
  }

  .candidate-create__step[data-state="warn"] {
    color: var(--warning);
    border-color: color-mix(in srgb, var(--warning) 35%, transparent);
  }

  @media (max-width: 980px) {
    .candidate-create__layout {
      grid-template-columns: 1fr;
    }

    .candidate-create__aside {
      position: static;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .candidate-create__schedule-body {
      transition: none;
    }
  }
</style>

<script nonce="{{ request.state.csp_nonce }}">
  const fioInput = document.getElementById('fio');
  const phoneInput = document.getElementById('phone');
  const citySelect = document.getElementById('city_id');
  const recruiterSelect = document.getElementById('responsible_recruiter_id');
  const interviewDateInput = document.getElementById('interview_date');
  const interviewTimeInput = document.getElementById('interview_time');
  const schedulePreview = document.getElementById('schedule_preview');
  const scheduleStep = document.getElementById('step_schedule');
  const cityHint = document.getElementById('city_tz_hint');
  const entityAlert = document.getElementById('entity_alert');

  const previewFio = document.getElementById('preview_fio');
  const previewPhone = document.getElementById('preview_phone');
  const previewCity = document.getElementById('preview_city');
  const previewRecruiter = document.getElementById('preview_recruiter');

  const getSelectedOption = (select) => {
    if (!select) return null;
    return select.selectedOptions && select.selectedOptions.length ? select.selectedOptions[0] : null;
  };

  const formatDate = (value) => {
    if (!value) return '';
    try {
      const date = new Date(`${value}T00:00:00`);
      return new Intl.DateTimeFormat('ru-RU', { dateStyle: 'medium' }).format(date);
    } catch (err) {
      return value;
    }
  };

  const updateCityHint = () => {
    if (!cityHint) return;
    const cityOption = getSelectedOption(citySelect);
    if (!cityOption) {
      cityHint.textContent = 'Город собеседования: —';
      return;
    }
    const cityLabel = cityOption?.dataset?.label || cityOption?.textContent.trim() || '—';
    const tzLabel = cityOption?.dataset?.tzLabel || 'Europe/Moscow';
    cityHint.textContent = `Город собеседования: ${cityLabel} · ${tzLabel}`;
  };

  const updateLeadPreview = () => {
    if (previewFio) previewFio.textContent = (fioInput.value || '').trim() || '—';
    if (previewPhone) previewPhone.textContent = (phoneInput.value || '').trim() || '—';
    const cityOption = getSelectedOption(citySelect);
    const cityLabel = cityOption?.dataset?.label || cityOption?.textContent.trim() || '';
    if (previewCity) previewCity.textContent = cityLabel || '—';

    const recruiterOption = getSelectedOption(recruiterSelect);
    if (previewRecruiter) {
      previewRecruiter.textContent = recruiterOption ? recruiterOption.textContent.trim() : '—';
    }
  };

  const updateSchedulePreview = () => {
    if (!schedulePreview || !scheduleStep) return;

    const missing = [];
    if (!recruiterSelect.value) missing.push('рекрутёра');
    if (!citySelect.value) missing.push('город');
    if (!interviewDateInput.value || !interviewTimeInput.value) missing.push('дату и время');

    if (missing.length) {
      schedulePreview.innerHTML = `<b>Интервью</b><br>Для создания слота выберите ${missing.join(', ')}.`;
      scheduleStep.dataset.state = 'warn';
      updateCityHint();
      return;
    }

    const cityOption = getSelectedOption(citySelect);
    const recruiterOption = getSelectedOption(recruiterSelect);
    if (recruiterOption && recruiterOption.dataset.active === 'false') {
      schedulePreview.innerHTML = '<b>Интервью</b><br>Выберите активного рекрутёра для назначения слота.';
      scheduleStep.dataset.state = 'warn';
      updateCityHint();
      return;
    }
    const tzLabel = cityOption?.dataset?.tzLabel || recruiterOption?.dataset?.tzLabel || 'Europe/Moscow';
    const dateLabel = formatDate(interviewDateInput.value);
    const timeLabel = interviewTimeInput.value || '—';
    const cityLabel = cityOption?.dataset?.label || cityOption?.textContent.trim() || '—';

    schedulePreview.innerHTML = `
      <b>Интервью</b><br>
      Дата: ${dateLabel}, ${timeLabel}<br>
      Город: ${cityLabel} · ${tzLabel}<br>
      Рекрутёр: ${recruiterOption ? recruiterOption.textContent.trim() : '—'}<br>
      <span class="hint">Слот появится в календаре, списке слотов и карточке кандидата.</span>
    `;
    scheduleStep.dataset.state = 'done';
    updateCityHint();
  };

  [fioInput, phoneInput, citySelect, recruiterSelect].forEach((el) => {
    if (!el) return;
    el.addEventListener('input', updateLeadPreview);
    el.addEventListener('change', updateLeadPreview);
  });

  [recruiterSelect, citySelect, interviewDateInput, interviewTimeInput].forEach((el) => {
    if (!el) return;
    el.addEventListener('change', () => {
      updateSchedulePreview();
    });
  });

  document.querySelectorAll('[data-quick-date]').forEach((btn) => {
    btn.addEventListener('click', () => {
      if (!interviewDateInput) return;
      const now = new Date();
      const quick = btn.dataset.quickDate;
      if (quick === 'tomorrow') now.setDate(now.getDate() + 1);
      if (quick === 'next-week') now.setDate(now.getDate() + 7);
      const iso = now.toISOString().slice(0, 10);
      interviewDateInput.value = iso;
      updateSchedulePreview();
    });
  });

  document.querySelectorAll('[data-quick-time]').forEach((btn) => {
    btn.addEventListener('click', () => {
      if (!interviewTimeInput) return;
      const quick = btn.dataset.quickTime;
      if (quick === 'next30') {
        const now = new Date();
        now.setMinutes(now.getMinutes() + 30);
        interviewTimeInput.value = now.toTimeString().slice(0, 5);
      } else {
        interviewTimeInput.value = quick;
      }
      updateSchedulePreview();
    });
  });

  const autoSelectSingle = (select) => {
    if (!select || select.value || select.disabled) return;
    const options = Array.from(select.options).filter((opt) => opt.value);
    if (options.length === 1) {
      select.value = options[0].value;
    }
  };

  autoSelectSingle(recruiterSelect);
  autoSelectSingle(citySelect);

  const hasOptions = (select) => select && select.options.length > 1;

  const ensureEntityAlert = () => {
    if (!entityAlert) return;
    if (hasOptions(citySelect) && hasOptions(recruiterSelect)) {
      entityAlert.remove();
    }
  };

  const populateCities = (items) => {
    if (!citySelect || !Array.isArray(items) || hasOptions(citySelect)) return;
    items.forEach((city) => {
      if (!city || !city.id || !city.name) return;
      const opt = document.createElement('option');
      opt.value = city.id;
      opt.textContent = `${city.name}${city.tz ? ` (${city.tz})` : ''}`;
      opt.dataset.label = city.name;
      opt.dataset.tzLabel = city.tz || '';
      citySelect.appendChild(opt);
    });
    if (citySelect.options.length > 1) {
      citySelect.disabled = false;
    }
  };

  const populateRecruiters = (items) => {
    if (!recruiterSelect || !Array.isArray(items) || hasOptions(recruiterSelect)) return;
    items.forEach((rec) => {
      if (!rec || !rec.id || !rec.name) return;
      const opt = document.createElement('option');
      opt.value = rec.id;
      opt.dataset.tz = rec.tz || '';
      opt.dataset.tzLabel = rec.tz || '';
      opt.dataset.active = rec.active === false ? 'false' : 'true';
      opt.textContent = `${rec.name}${rec.active === false ? ' (неактивен)' : rec.tz ? ` (${rec.tz})` : ''}`;
      recruiterSelect.appendChild(opt);
    });
    if (recruiterSelect.options.length > 1) {
      recruiterSelect.disabled = false;
    }
  };

  const hydrateEntities = async () => {
    try {
      if (!hasOptions(citySelect)) {
        const cityResp = await fetch('/api/cities');
        if (cityResp.ok) {
          populateCities(await cityResp.json());
        }
      }
      if (!hasOptions(recruiterSelect)) {
        const recResp = await fetch('/api/recruiters');
        if (recResp.ok) {
          populateRecruiters(await recResp.json());
        }
      }
    } catch (err) {
      // Keep the warning if fetch fails.
    }
    autoSelectSingle(recruiterSelect);
    autoSelectSingle(citySelect);
    ensureEntityAlert();
    updateLeadPreview();
    updateSchedulePreview();
  };

  if (interviewDateInput && !interviewDateInput.value) {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    interviewDateInput.value = tomorrow.toISOString().slice(0, 10);
  }
  if (interviewTimeInput && !interviewTimeInput.value) {
    interviewTimeInput.value = '10:00';
  }
  ensureEntityAlert();
  updateLeadPreview();
  updateSchedulePreview();
  if ((!hasOptions(citySelect) && citySelect) || (!hasOptions(recruiterSelect) && recruiterSelect)) {
    hydrateEntities();
  }
</script>
{% endblock %}
