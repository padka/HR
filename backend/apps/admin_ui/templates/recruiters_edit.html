{% extends "base.html" %}
{% import "partials/form_shell.html" as forms with context %}
{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞{% endblock %}
{% block content %}
{% set form_state = form_data or {} %}
{% set errors = field_errors or {} %}
{% set selected_values = (form_state.get('cities', selected_ids) or []) %}
{% set selected_string_values = namespace(items=[]) %}
{% for value in selected_values %}
  {% set selected_string_values.items = selected_string_values.items + [value|string] %}
{% endfor %}
{% set name_value = form_state.get('name', recruiter.name) %}
{% set tz_value = form_state.get('tz', recruiter.tz or 'Europe/Moscow') %}
{% set telemost_value = form_state.get('telemost', recruiter.telemost_url or '') %}
{% set tg_value = form_state.get('tg_chat_id', recruiter.tg_chat_id or '') %}
{% set assigned_count = selected_values|length if selected_values else 0 %}
{% set active_flag = form_state.get('active', recruiter.active) %}
{% set is_active = active_flag if active_flag is not none else False %}
{% set name_parts = (name_value or '').split() %}
{% set initials = ((name_parts[0][0] if name_parts else 'R') ~ (name_parts[1][0] if name_parts|length > 1 else ''))[:2].upper() %}
{% if not initials.strip() %}
  {% set initials = 'R' %}
{% endif %}
{% if form_error %}
  <div class="liquid-glass-card alert" data-tone="danger" role="alert" data-animate-in>
    <span class="liquid-glass-badge liquid-glass-badge--danger">–û—à–∏–±–∫–∞</span>
    {{ form_error }}
  </div>
{% endif %}
{% call forms.shell(
  title=recruiter.name,
  description="–ò–∑–º–µ–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ –≥–æ—Ä–æ–¥–∞.",
  form_id="recruiter-edit",
  action='/recruiters/' ~ recruiter.id ~ '/update',
  autocomplete="off",
  back_href="/recruiters",
  back_label="–ö —Å–ø–∏—Å–∫—É —Ä–µ–∫—Ä—É—Ç—ë—Ä–æ–≤",
  meta=['ID #' ~ recruiter.id],
  actions=[
    {"type": "submit", "text": "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", "variant": "primary"},
    {"href": "/recruiters", "text": "–û—Ç–º–µ–Ω–∞", "variant": "ghost"}
  ]
) %}
  <div class="recruiter-edit__summary liquid-glass-card" data-animate-in>
    <div class="recruiter-edit__summary-main">
      <div class="recruiter-card__avatar recruiter-edit__avatar" aria-hidden="true">{{ initials }}</div>
      <div>
        <p class="recruiter-edit__eyebrow">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞</p>
        <h2 class="recruiter-edit__title">{{ name_value }}</h2>
        <div class="recruiter-edit__meta">
          <span class="recruiter-card__badge">ID #{{ recruiter.id }}</span>
          <span class="recruiter-card__badge" title="–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å">{{ tz_display(tz_value) }}</span>
          <span class="recruiter-card__badge recruiter-card__badge--ghost">{{ telemost_value or '–¢–µ–ª–µ–º–æ—Å—Ç –Ω–µ —É–∫–∞–∑–∞–Ω' }}</span>
        </div>
      </div>
    </div>
    <div class="recruiter-edit__chips">
      <div class="recruiter-edit__chip" data-tone="accent">
        <span>–ì–æ—Ä–æ–¥–∞</span>
        <strong>{{ assigned_count }}</strong>
      </div>
      <div class="recruiter-edit__chip" data-tone="info">
        <span>Telegram</span>
        <strong>{{ '–ü–æ–¥–∫–ª—é—á–µ–Ω' if tg_value else '–ù–µ —É–∫–∞–∑–∞–Ω' }}</strong>
      </div>
      <div class="recruiter-edit__chip" data-tone="{{ 'success' if is_active else 'muted' }}">
        <span>–°—Ç–∞—Ç—É—Å</span>
        <strong>{{ '–ê–∫—Ç–∏–≤–µ–Ω' if is_active else '–û—Ç–∫–ª—é—á–µ–Ω' }}</strong>
      </div>
    </div>
  </div>

  <div class="recruiter-edit__grid">
    <section class="recruiter-edit__card">
      <header class="recruiter-edit__card-header">
        <h3>–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
        <p>–ò–º—è –∏ —Ä–∞–±–æ—á–∏–π —Ä–µ–≥–∏–æ–Ω –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.</p>
      </header>
      <div class="recruiter-edit__card-body">
        <div class="form-grid form-grid--two form-grid--compact">
          {% call forms.field("–ò–º—è", required=True) %}
            <input type="text" name="name" value="{{ name_value }}" required aria-required="true" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–Ω–Ω–∞ –°–æ–∫–æ–ª–æ–≤–∞">
          {% endcall %}
          {% call forms.field("–†–µ–≥–∏–æ–Ω", hint="–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –±–∞–∑–æ–≤–∞—è —Ç–∞–π–º–∑–æ–Ω–∞ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞", required=True) %}
            <select name="tz" required aria-required="true">
              {% for option in tz_options %}
                <option value="{{ option.value }}" {% if option.value == tz_value %}selected{% endif %}>
                  {{ option.label }}
                </option>
              {% endfor %}
            </select>
          {% endcall %}
        </div>
        <div class="recruiter-edit__status-toggle">
          {{ forms.switch(name='active', value='1', checked=is_active, label='–ê–∫—Ç–∏–≤–µ–Ω') }}
          <p class="form-note">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–∫—Ä—É—Ç—ë—Ä—ã —Å–∫—Ä—ã–≤–∞—é—Ç—Å—è –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π –∏ –Ω–µ –ø–æ–ª—É—á–∞—é—Ç –Ω–æ–≤—ã–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è.</p>
        </div>
      </div>
    </section>

    <section class="recruiter-edit__card">
      <header class="recruiter-edit__card-header">
        <h3>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h3>
        <p>–£–∫–∞–∂–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –¢–µ–ª–µ–º–æ—Å—Ç –∏ chat_id –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –±–æ—Ç–æ–º.</p>
      </header>
      <div class="recruiter-edit__card-body">
        <div class="form-grid form-grid--two form-grid--compact">
          {% call forms.field("–°—Å—ã–ª–∫–∞ –Ω–∞ –¢–µ–ª–µ–º–æ—Å—Ç", hint="–ù–∞–ø—Ä–∏–º–µ—Ä: https://telemost.yandex.ru/j/XXXXX") %}
            <input type="url" name="telemost" value="{{ telemost_value }}"{% if errors.get('telemost') %} class="is-invalid"{% endif %} placeholder="https://telemost.yandex.ru/j/XXXXX">
            {% if errors.get('telemost') %}
              <p class="form-error" role="alert">{{ errors.get('telemost') }}</p>
            {% endif %}
          {% endcall %}
          {% call forms.field("Telegram chat_id", hint="—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã; –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º") %}
            <input type="number" name="tg_chat_id" value="{{ tg_value }}" min="1" step="1" inputmode="numeric" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 7588303412"{% if errors.get('tg_chat_id') %} class="is-invalid"{% endif %}>
            {% if errors.get('tg_chat_id') %}
              <p class="form-error" role="alert">{{ errors.get('tg_chat_id') }}</p>
            {% endif %}
          {% endcall %}
        </div>
      </div>
    </section>
  </div>

  <section class="recruiter-edit__card recruiter-edit__card--full">
    <header class="recruiter-edit__card-header">
      <h3>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –≥–æ—Ä–æ–¥–∞</h3>
      <p>–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥–æ—Ä–æ–¥–æ–≤. –û–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞ –∏ –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ö —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.</p>
    </header>
    <div class="recruiter-city-picker" data-multiselect>
      <div class="recruiter-city-picker__toolbar">
        <input type="search" class="input recruiter-city-picker__search" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞" aria-label="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞" data-multiselect-search>
        <span class="recruiter-city-picker__counter" data-cities-counter>
          {{ '–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö' if assigned_count == 0 else assigned_count ~ (' –≤—ã–±—Ä–∞–Ω' if assigned_count == 1 else ' –≤—ã–±—Ä–∞–Ω–æ') }}
        </span>
      </div>
      <div class="recruiter-city-picker__selected" data-selected-pills>
        {% if assigned_count %}
          {% set counter = 0 %}
          {% for city in cities %}
            {% if (city.id|string) in selected_string_values.items and counter < 4 %}
              <span class="recruiter-city-picker__pill">{{ city.display_name }}</span>
              {% set counter = counter + 1 %}
            {% endif %}
          {% endfor %}
          {% if assigned_count > counter %}
            <span class="recruiter-city-picker__pill recruiter-city-picker__pill--ghost">+{{ assigned_count - counter }}</span>
          {% endif %}
        {% else %}
          <span class="muted">–ì–æ—Ä–æ–¥–∞ –ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</span>
        {% endif %}
      </div>
      <div class="choice-grid" role="group" aria-label="–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –≥–æ—Ä–æ–¥–∞" data-multiselect-options>
        {% for city in cities %}
          {% set checked = (city.id|string) in selected_string_values.items %}
          <label class="choice-tile" data-filter="{{ city.name_plain|lower }} {{ city.tz|lower }}">
            <input type="checkbox" name="cities" value="{{ city.id }}" {% if checked %}checked{% endif %} data-city-checkbox>
            <span class="choice-tile__checkmark" aria-hidden="true">‚úì</span>
            <span class="choice-tile__title">{{ city.display_name }}</span>
            <span class="choice-tile__meta">{{ city.tz }}</span>
          </label>
        {% endfor %}
      </div>
      <p class="muted recruiter-city-picker__empty" data-multiselect-empty hidden>–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
      <p class="form-note">üí° –°–æ–≤–µ—Ç: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –∏–ª–∏ –∫–ª–∏–∫–∞–π—Ç–µ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–∞–º, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –∑–∞–∫—Ä–µ–ø–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥–æ—Ä–æ–¥–æ–≤.</p>
    </div>
  </section>
{% endcall %}
{% endblock %}

<script>
(function(){
  const form = document.getElementById('recruiter-edit');
  if (!form) return;
  form.addEventListener('submit', ()=>{
    window.requestAnimationFrame(()=>{ window.scrollTo(0, 0); });
  });
})();

(function(){
  const widgets = document.querySelectorAll('[data-multiselect]');
  widgets.forEach((widget) => {
    const search = widget.querySelector('[data-multiselect-search]');
    const options = Array.from(widget.querySelectorAll('[data-filter]'));
    const emptyHint = widget.querySelector('[data-multiselect-empty]');
    const counter = widget.querySelector('[data-cities-counter]');
    const selectedPanel = widget.querySelector('[data-selected-pills]');
    const checkboxes = Array.from(widget.querySelectorAll('[data-city-checkbox]'));

    // Update counter and selection preview
    function updateSelection() {
      const checkedBoxes = checkboxes.filter(cb => cb.checked);
      const checkedCount = checkedBoxes.length;
      if (counter) {
        counter.textContent = checkedCount === 0 ? '–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö' :
                              checkedCount === 1 ? '1 –≤—ã–±—Ä–∞–Ω' :
                              `${checkedCount} –≤—ã–±—Ä–∞–Ω–æ`;
      }

      if (selectedPanel) {
        selectedPanel.innerHTML = '';
        if (!checkedCount) {
          const empty = document.createElement('span');
          empty.className = 'muted';
          empty.textContent = '–ì–æ—Ä–æ–¥–∞ –ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã';
          selectedPanel.appendChild(empty);
          return;
        }
        const maxVisible = 4;
        checkedBoxes.slice(0, maxVisible).forEach((cb) => {
          const label = cb.closest('.choice-tile');
          const titleNode = label ? label.querySelector('.choice-tile__title') : null;
          const pill = document.createElement('span');
          pill.className = 'recruiter-city-picker__pill';
          pill.textContent = titleNode ? titleNode.textContent.trim() : `ID ${cb.value}`;
          selectedPanel.appendChild(pill);
        });
        if (checkedCount > maxVisible) {
          const remainder = document.createElement('span');
          remainder.className = 'recruiter-city-picker__pill recruiter-city-picker__pill--ghost';
          remainder.textContent = `+${checkedCount - maxVisible}`;
          selectedPanel.appendChild(remainder);
        }
      }
    }

    // Listen to checkbox changes
    checkboxes.forEach(cb => {
      cb.addEventListener('change', updateSelection);
    });

    // Initial update
    updateSelection();

    // Search functionality
    if (!search || !options.length) {
      if (emptyHint) {
        emptyHint.hidden = true;
      }
      return;
    }
    search.addEventListener('input', () => {
      const term = search.value.trim().toLowerCase();
      let visible = 0;
      options.forEach((option) => {
        const haystack = option.getAttribute('data-filter') || '';
        const match = !term || haystack.indexOf(term) !== -1;
        option.hidden = !match;
        if (match) visible += 1;
      });
      if (emptyHint) {
        emptyHint.hidden = visible !== 0;
      }
    });
  });
})();
</script>
