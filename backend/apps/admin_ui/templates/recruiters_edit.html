{% extends "base_liquid.html" %}
{% import "partials/form_shell.html" as forms %}
{% block title %}Редактирование рекрутёра{% endblock %}
{% block content %}
{% set form_state = form_data or {} %}
{% set selected_values = form_state.get('cities', selected_ids) %}
{% set city_threshold = 16 %}
{% if form_error %}
  <div class="surface glass grain alert" data-tone="danger" role="alert">
    {{ form_error }}
  </div>
{% endif %}
{% call forms.shell(
  title=recruiter.name,
  description="Обновите контакты, статус и закреплённые города.",
  form_id="recruiter-edit",
  action='/recruiters/' ~ recruiter.id ~ '/update',
  autocomplete="off",
  back_href="/recruiters",
  back_label="К списку",
  meta=['ID #' ~ recruiter.id],
  actions=[
    {"type": "submit", "text": "Сохранить изменения", "variant": "primary"},
    {"href": "/recruiters", "text": "Отмена", "variant": "ghost"}
  ]
) %}
  {% call forms.section("Основные данные", hint="Имя, часовой пояс и контакты для связи") %}
    <div class="panel-grid">
      <div class="panel-grid__col">
        {% call forms.field("Имя", hint="Отображается во всех списках") %}
          <input type="text" name="name" value="{{ form_state.get('name', recruiter.name) }}" required>
        {% endcall %}
      </div>
      <div class="panel-grid__col">
        {% call forms.field("Часовой пояс", hint="Определяет локальное время слотов") %}
          {% set current_tz = form_state.get('tz', recruiter.tz or 'Europe/Moscow') %}
          <select name="tz" required>
            {% for option in tz_options %}
              <option value="{{ option.value }}" {% if option.value == current_tz %}selected{% endif %}>
                {{ option.label }}
              </option>
            {% endfor %}
          </select>
        {% endcall %}
      </div>
      <div class="panel-grid__col">
        {% call forms.field("Ссылка на телемост", hint="Например: https://telemost.yandex.ru/j/XXXXX") %}
          {% set telemost_value = form_state.get('telemost', recruiter.telemost_url or '') %}
          <input type="url" name="telemost" value="{{ telemost_value }}" placeholder="https://">
        {% endcall %}
      </div>
      <div class="panel-grid__col">
        {% call forms.field("Telegram chat_id", hint="Можно оставить пустым до подключения") %}
          {% set tg_value = form_state.get('tg_chat_id', recruiter.tg_chat_id or '') %}
          <input type="number" name="tg_chat_id" value="{{ tg_value }}" min="1" step="1" placeholder="7588303412">
        {% endcall %}
      </div>
      <div class="panel-grid__col panel-grid__col--wide">
        {% call forms.field("Активность", hint="Влияет на подбор слотов и показ в ботах") %}
          {{ forms.switch(name='active', value='1', checked=form_state.get('active', recruiter.active), label='Рекрутёр активен') }}
        {% endcall %}
      </div>
    </div>
  {% endcall %}

  {% call forms.section("Ответственные города", hint="Выберите несколько — бот назначит им заявки") %}
    <div
      class="city-selector"
      data-city-selector
      data-total="{{ cities|length }}"
      data-threshold="{{ city_threshold }}"
      data-mode="{{ 'list' if cities|length > city_threshold else 'tiles' }}"
    >
      <div class="city-selector__header">
        <div class="city-selector__summary">
          <span class="city-selector__count" data-selected-count>{{ selected_values|length }}</span>
          <span class="city-selector__count-label">выбрано</span>
        </div>
        <div class="city-selector__actions" role="group" aria-label="Быстрые действия">
          <button type="button" class="city-selector__action" data-select="all">Выбрать все</button>
          <button type="button" class="city-selector__action" data-select="none">Снять все</button>
        </div>
      </div>
      <div class="city-selector__search" data-city-search {% if cities|length <= city_threshold %}hidden{% endif %}>
        <svg viewBox="0 0 24 24" aria-hidden="true" class="city-selector__search-icon">
          <circle cx="11" cy="11" r="7.5" fill="none" stroke="currentColor" stroke-width="1.6"></circle>
          <path d="m16.5 16.5 4 4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"></path>
        </svg>
        <input
          type="search"
          name="city-search"
          placeholder="Поиск по названию или часовому поясу"
          autocomplete="off"
          data-city-search-input
        >
      </div>
      <div class="city-selector__chips" data-selected-chips hidden></div>
      <div class="city-selector__options" role="group" aria-label="Список городов">
        {% for city in cities %}
          {% set checked = city.id in selected_values %}
          <label
            class="city-option"
            data-city-option
            data-name="{{ city.name|lower }}"
            data-tz="{{ city.tz|lower }}"
          >
            <input type="checkbox" name="cities" value="{{ city.id }}" {% if checked %}checked{% endif %}>
            <span class="city-option__check" aria-hidden="true">
              <svg viewBox="0 0 20 20" fill="none">
                <path d="m4.5 10.5 3 3.5 8-8.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            </span>
            <span class="city-option__body">
              <span class="city-option__name">{{ city.name }}</span>
              <span class="city-option__tz">{{ city.tz }}</span>
            </span>
          </label>
        {% endfor %}
      </div>
      <p class="city-selector__empty" data-empty-state hidden>Ничего не найдено. Попробуйте другой запрос.</p>
      <div class="sr-only" data-city-live aria-live="polite"></div>
    </div>
  {% endcall %}
{% endcall %}

<script type="module">
import { initCitySelector } from "/static/js/modules/city-selector.js";
import { installDirtyGuard } from "/static/js/modules/form-dirty-guard.js";

const selectorRoot = document.querySelector('[data-city-selector]');
if (selectorRoot) {
  initCitySelector(selectorRoot);
}

const form = document.getElementById('recruiter-edit');
if (form) {
  installDirtyGuard(form, { message: 'Несохранённые изменения будут потеряны.' });
}
</script>
{% endblock %}
