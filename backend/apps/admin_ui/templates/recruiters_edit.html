{% extends "base.html" %}
{% import "partials/form_shell.html" as forms with context %}
{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞{% endblock %}
{% block content %}
{% set form_state = form_data or {} %}
{% set errors = field_errors or {} %}
{% set selected_values = form_state.get('cities', selected_ids) %}
{% if form_error %}
  <div class="liquid-glass-card alert" data-tone="danger" role="alert" data-animate-in>
    <span class="liquid-glass-badge liquid-glass-badge--danger">–û—à–∏–±–∫–∞</span>
    {{ form_error }}
  </div>
{% endif %}
{% call forms.shell(
  title=recruiter.name,
  description="–ò–∑–º–µ–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ –≥–æ—Ä–æ–¥–∞.",
  form_id="recruiter-edit",
  action='/recruiters/' ~ recruiter.id ~ '/update',
  autocomplete="off",
  back_href="/recruiters",
  back_label="–ö —Å–ø–∏—Å–∫—É —Ä–µ–∫—Ä—É—Ç—ë—Ä–æ–≤",
  meta=['ID #' ~ recruiter.id],
  actions=[
    {"type": "submit", "text": "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", "variant": "primary"},
    {"href": "/recruiters", "text": "–û—Ç–º–µ–Ω–∞", "variant": "ghost"}
  ]
) %}
  {% call forms.section("–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ") %}
    <div class="form-grid form-grid--two">
      {% call forms.field("–ò–º—è", required=True) %}
        <input type="text" name="name" value="{{ form_state.get('name', recruiter.name) }}" required aria-required="true">
      {% endcall %}
      {% call forms.field("–†–µ–≥–∏–æ–Ω", hint="–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–ª–æ—Ç–æ–≤", required=True) %}
        {% set current_tz = form_state.get('tz', recruiter.tz or 'Europe/Moscow') %}
        <select name="tz" required aria-required="true">
          {% for option in tz_options %}
            <option value="{{ option.value }}" {% if option.value == current_tz %}selected{% endif %}>
              {{ option.label }}
            </option>
          {% endfor %}
        </select>
      {% endcall %}
    </div>
    <div class="form-grid form-grid--two">
      {% call forms.field("–°—Å—ã–ª–∫–∞ –Ω–∞ –¢–µ–ª–µ–º–æ—Å—Ç", hint="–ù–∞–ø—Ä–∏–º–µ—Ä: https://telemost.yandex.ru/j/XXXXX") %}
        {% set telemost_value = form_state.get('telemost', recruiter.telemost_url or '') %}
        <input type="url" name="telemost" value="{{ telemost_value }}"{% if errors.get('telemost') %} class="is-invalid"{% endif %}>
        {% if errors.get('telemost') %}
          <p class="form-error" role="alert">{{ errors.get('telemost') }}</p>
        {% endif %}
      {% endcall %}
      {% call forms.field("Telegram chat_id", hint="ID –±–µ—Ä—ë—Ç—Å—è –∏–∑ Telegram, —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã. –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ —á–∞—Ç –µ—â—ë –Ω–µ —Å–≤—è–∑–∞–Ω.") %}
        {% set tg_value = form_state.get('tg_chat_id', recruiter.tg_chat_id or '') %}
        <input type="number" name="tg_chat_id" value="{{ tg_value }}" min="1" step="1" inputmode="numeric" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 7588303412"{% if errors.get('tg_chat_id') %} class="is-invalid"{% endif %}>
        {% if errors.get('tg_chat_id') %}
          <p class="form-error" role="alert">{{ errors.get('tg_chat_id') }}</p>
        {% endif %}
      {% endcall %}
    </div>
  {% endcall %}

  {% call forms.section("–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –≥–æ—Ä–æ–¥–∞", hint="–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥–æ—Ä–æ–¥–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ") %}
    <div class="multiselect" data-multiselect>
      <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px;">
        <input type="search" class="input" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞" aria-label="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞" data-multiselect-search style="flex: 1;">
        <span class="badge" data-cities-counter style="background: var(--accent); color: white; padding: 6px 12px; border-radius: 16px; font-size: 14px; font-weight: 600; min-width: 60px; text-align: center;">0 –≤—ã–±—Ä–∞–Ω–æ</span>
      </div>
      <div class="choice-grid" role="group" aria-label="–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –≥–æ—Ä–æ–¥–∞" data-multiselect-options>
        {% for city in cities %}
          <label class="choice-tile" data-filter="{{ city.name_plain|lower }} {{ city.tz|lower }}">
            {% set checked = city.id in selected_values %}
            <input type="checkbox" name="cities" value="{{ city.id }}" {% if checked %}checked{% endif %} data-city-checkbox>
            <span class="choice-tile__checkmark" style="position: absolute; top: 8px; right: 8px; width: 20px; height: 20px; border-radius: 4px; border: 2px solid currentColor; display: none; align-items: center; justify-content: center; background: var(--accent); color: white; font-size: 14px; font-weight: bold;">‚úì</span>
            <span class="choice-tile__title">{{ city.display_name }}</span>
            <span class="choice-tile__meta">{{ city.tz }}</span>
          </label>
        {% endfor %}
      </div>
      <p class="muted" data-multiselect-empty hidden>–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
      <p class="form-note" style="margin-top: 12px; color: var(--muted); font-size: 13px;">üí° –°–æ–≤–µ—Ç: –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞. –í—ã–±—Ä–∞–Ω–Ω—ã–µ –≥–æ—Ä–æ–¥–∞ –±—É–¥—É—Ç –ø–æ–¥—Å–≤–µ—á–µ–Ω—ã.</p>
    </div>
  {% endcall %}

  {% call forms.field("–°—Ç–∞—Ç—É—Å") %}
    {{ forms.switch(name='active', value='1', checked=form_state.get('active', recruiter.active), label='–ê–∫—Ç–∏–≤–µ–Ω') }}
  {% endcall %}
{% endcall %}
{% endblock %}

<script>
(function(){
  const form = document.getElementById('recruiter-edit');
  if (!form) return;
  form.addEventListener('submit', ()=>{
    window.requestAnimationFrame(()=>{ window.scrollTo(0, 0); });
  });
})();

(function(){
  const widgets = document.querySelectorAll('[data-multiselect]');
  widgets.forEach((widget) => {
    const search = widget.querySelector('[data-multiselect-search]');
    const options = Array.from(widget.querySelectorAll('[data-filter]'));
    const emptyHint = widget.querySelector('[data-multiselect-empty]');
    const counter = widget.querySelector('[data-cities-counter]');
    const checkboxes = Array.from(widget.querySelectorAll('[data-city-checkbox]'));

    // Update counter and checkmarks
    function updateSelection() {
      const checkedCount = checkboxes.filter(cb => cb.checked).length;
      if (counter) {
        counter.textContent = checkedCount === 0 ? '0 –≤—ã–±—Ä–∞–Ω–æ' :
                              checkedCount === 1 ? '1 –≤—ã–±—Ä–∞–Ω' :
                              `${checkedCount} –≤—ã–±—Ä–∞–Ω–æ`;
      }

      // Update checkmarks visibility
      checkboxes.forEach(cb => {
        const label = cb.closest('.choice-tile');
        const checkmark = label ? label.querySelector('.choice-tile__checkmark') : null;
        if (checkmark) {
          checkmark.style.display = cb.checked ? 'flex' : 'none';
        }
      });
    }

    // Listen to checkbox changes
    checkboxes.forEach(cb => {
      cb.addEventListener('change', updateSelection);
    });

    // Initial update
    updateSelection();

    // Search functionality
    if (!search || !options.length) {
      if (emptyHint) {
        emptyHint.hidden = true;
      }
      return;
    }
    search.addEventListener('input', () => {
      const term = search.value.trim().toLowerCase();
      let visible = 0;
      options.forEach((option) => {
        const haystack = option.getAttribute('data-filter') || '';
        const match = !term || haystack.indexOf(term) !== -1;
        option.hidden = !match;
        if (match) visible += 1;
      });
      if (emptyHint) {
        emptyHint.hidden = visible !== 0;
      }
    });
  });
})();
</script>
