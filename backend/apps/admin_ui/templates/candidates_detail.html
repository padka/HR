{% extends "base.html" %}
{% block title %}–ö–∞–Ω–¥–∏–¥–∞—Ç {{ user.fio }}{% endblock %}
{% block content %}
<style>
  /* Liquid Glass Variables */
  :root {
    --liquid-glass-bg: linear-gradient(135deg,
      rgba(255, 255, 255, 0.05) 0%,
      rgba(255, 255, 255, 0.02) 100%);
    --liquid-glass-bg-hover: linear-gradient(135deg,
      rgba(255, 255, 255, 0.09) 0%,
      rgba(255, 255, 255, 0.04) 100%);
    --liquid-glass-border: rgba(255, 255, 255, 0.08);
    --liquid-glass-highlight: linear-gradient(180deg,
      rgba(255, 255, 255, 0.12) 0%,
      rgba(255, 255, 255, 0) 50%);
    --liquid-glass-shadow:
      0 8px 32px 0 rgba(0, 0, 0, 0.25),
      inset 0 1px 2px 0 rgba(255, 255, 255, 0.05);
    --liquid-glass-shadow-hover:
      0 16px 48px 0 rgba(0, 0, 0, 0.35),
      inset 0 1px 2px 0 rgba(255, 255, 255, 0.08);
    --liquid-glass-blur: blur(40px);
  }

  html[data-theme="light"] {
    --liquid-glass-bg: linear-gradient(135deg,
      rgba(255, 255, 255, 0.6) 0%,
      rgba(255, 255, 255, 0.4) 100%);
    --liquid-glass-bg-hover: linear-gradient(135deg,
      rgba(255, 255, 255, 0.8) 0%,
      rgba(255, 255, 255, 0.55) 100%);
    --liquid-glass-border: rgba(255, 255, 255, 0.4);
    --liquid-glass-highlight: linear-gradient(180deg,
      rgba(255, 255, 255, 0.95) 0%,
      rgba(255, 255, 255, 0) 50%);
    --liquid-glass-shadow:
      0 8px 32px 0 rgba(31, 38, 135, 0.15),
      inset 0 1px 2px 0 rgba(255, 255, 255, 0.6);
    --liquid-glass-shadow-hover:
      0 16px 48px 0 rgba(31, 38, 135, 0.22),
      inset 0 1px 2px 0 rgba(255, 255, 255, 0.75);
    --liquid-glass-blur: blur(35px);
  }

  .candidate-overview {
    margin-top: 32px;
    padding: 32px;
    border-radius: 32px;
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.55));
    border: 1px solid rgba(255, 255, 255, 0.12);
    box-shadow: 0 45px 70px rgba(2, 6, 23, 0.45);
    display: grid;
    gap: 32px;
  }

  html[data-theme="light"] .candidate-overview {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(241, 245, 255, 0.9));
    border-color: rgba(15, 23, 42, 0.12);
    box-shadow: 0 35px 60px rgba(15, 23, 42, 0.18);
  }

  .candidate-hero {
    display: flex;
    justify-content: space-between;
    gap: 32px;
    flex-wrap: wrap;
  }

  .candidate-hero__summary {
    flex: 1 1 320px;
    min-width: 280px;
  }

  .candidate-hero__eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.72rem;
    color: var(--muted);
    margin: 0 0 10px;
  }

  .candidate-hero__stage-wrap {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .candidate-hero__stage {
    font-size: 2rem;
    line-height: 1.2;
    margin: 0;
  }

  .candidate-hero__stage-pill {
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.25);
    background: rgba(255, 255, 255, 0.08);
  }

  html[data-theme="light"] .candidate-hero__stage-pill {
    border-color: rgba(15, 23, 42, 0.15);
    background: rgba(15, 23, 42, 0.05);
  }

  .candidate-hero__meta {
    margin-top: 6px;
    color: var(--muted);
  }

  .candidate-hero__tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
  }

  .candidate-hero__tag {
    padding: 6px 14px;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.08);
    font-size: 0.85rem;
  }

  html[data-theme="light"] .candidate-hero__tag {
    border-color: rgba(15, 23, 42, 0.12);
    background: rgba(15, 23, 42, 0.05);
  }

  .candidate-hero__chat {
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .candidate-hero__chat-note {
    font-size: 0.85rem;
    color: var(--muted);
    margin-left: 4px;
  }

  .telegram-panel {
    margin-top: 20px;
    padding: 18px 20px;
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.04);
    display: grid;
    gap: 14px;
  }

  html[data-theme="light"] .telegram-panel {
    border-color: rgba(15, 23, 42, 0.12);
    background: rgba(15, 23, 42, 0.03);
  }

  .telegram-panel__eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.7rem;
    color: var(--muted);
  }

  .telegram-panel__title {
    font-size: 1.2rem;
    margin: 0;
  }

  .telegram-panel__meta {
    color: var(--muted);
    font-size: 0.85rem;
  }

  .telegram-panel__grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
  }

  .telegram-panel__item {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .telegram-panel__label {
    font-size: 0.8rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--muted);
  }

  .telegram-panel__value {
    display: inline-flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    font-family: var(--font-mono);
    font-size: 0.95rem;
  }

  .telegram-panel__value code {
    padding: 4px 8px;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.08);
  }

  html[data-theme="light"] .telegram-panel__value code {
    background: rgba(15, 23, 42, 0.08);
  }

  .telegram-panel__hint {
    font-size: 0.85rem;
    color: var(--muted);
  }

  .telegram-panel__actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }

  .telegram-panel__links {
    display: inline-flex;
    flex-direction: column;
    gap: 6px;
  }

  .telegram-panel__links a {
    color: var(--accent);
    text-decoration: none;
  }

  .chat-panel {
    margin-top: 24px;
    padding: 20px;
    border-radius: 24px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.03);
    display: grid;
    gap: 16px;
  }

  html[data-theme="light"] .chat-panel {
    border-color: rgba(15, 23, 42, 0.12);
    background: rgba(15, 23, 42, 0.02);
  }

  .chat-panel__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }

  .chat-panel__title {
    margin: 0;
    font-size: 1.1rem;
  }

  .chat-panel__log {
    max-height: 420px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding-right: 4px;
  }

  .chat-message {
    padding: 12px 16px;
    border-radius: 16px;
    background: rgba(255, 255, 255, 0.06);
    max-width: 80%;
    position: relative;
  }

  .chat-message--outbound {
    margin-left: auto;
    background: rgba(99, 102, 241, 0.15);
  }

  .chat-message__meta {
    font-size: 0.75rem;
    color: var(--muted);
    margin-top: 6px;
    display: flex;
    justify-content: space-between;
    gap: 8px;
  }

  .chat-panel__templates {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .chat-panel__form textarea {
    width: 100%;
    min-height: 80px;
    padding: 12px;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(0, 0, 0, 0.2);
    color: inherit;
    resize: vertical;
  }

  html[data-theme="light"] .chat-panel__form textarea {
    border-color: rgba(15, 23, 42, 0.2);
    background: rgba(15, 23, 42, 0.03);
  }

  .chat-panel__form-actions {
    margin-top: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
  }

  .chat-panel__status {
    font-size: 0.85rem;
    color: var(--muted);
  }

  .chat-panel__placeholder {
    padding: 12px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.04);
  }

  .candidate-hero__status {
    flex: 1 1 260px;
    min-width: 240px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .candidate-hero__status-pill {
    align-self: flex-start;
    padding: 6px 14px;
    border-radius: 999px;
    font-weight: 600;
    background: rgba(52, 211, 153, 0.15);
    border: 1px solid rgba(52, 211, 153, 0.4);
  }

  html[data-theme="light"] .candidate-hero__status-pill {
    background: rgba(34, 197, 94, 0.15);
    border-color: rgba(34, 197, 94, 0.35);
  }

  .candidate-hero__status-pill.is-muted {
    background: rgba(239, 68, 68, 0.15);
    border-color: rgba(239, 68, 68, 0.4);
  }

  .candidate-hero__status-note {
    color: var(--muted);
    font-size: 0.9rem;
  }

  .candidate-hero__metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
    gap: 12px;
  }

  .candidate-hero__metrics div {
    padding: 12px 14px;
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.04);
  }

  html[data-theme="light"] .candidate-hero__metrics div {
    border-color: rgba(15, 23, 42, 0.12);
    background: rgba(15, 23, 42, 0.05);
  }

  .candidate-hero__metrics dt {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.72rem;
    color: var(--muted);
    margin-bottom: 4px;
  }

  .candidate-hero__metrics dd {
    font-size: 1.25rem;
    margin: 0;
    font-weight: 600;
  }

  .manual-slot-card {
    margin-top: 24px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    align-items: center;
    border-radius: 24px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.04);
    padding: 24px;
  }

  html[data-theme="light"] .manual-slot-card {
    border-color: rgba(15, 23, 42, 0.08);
    background: rgba(15, 23, 42, 0.03);
  }

  .manual-slot-card__eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.75rem;
    color: var(--muted);
    margin: 0 0 6px;
  }

  .manual-slot-card__window {
    font-size: 1.3rem;
    margin: 0;
    font-weight: 600;
  }

  .manual-slot-card__note {
    margin: 8px 0 0;
    color: var(--fg);
  }

  .manual-slot-card__meta {
    font-size: 0.85rem;
    color: var(--muted);
    margin: 4px 0 0;
  }

  .manual-slot-card__actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    flex-wrap: wrap;
  }

  .candidate-next {
    padding: 24px;
    border-radius: 24px;
    background: rgba(255, 255, 255, 0.06);
    border: 1px solid rgba(255, 255, 255, 0.12);
  }

  html[data-theme="light"] .candidate-next {
    background: rgba(15, 23, 42, 0.03);
    border-color: rgba(15, 23, 42, 0.08);
  }

  .candidate-next__eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.72rem;
    color: var(--muted);
    margin: 0 0 10px;
  }

  .candidate-next__timeline {
    display: flex;
    align-items: flex-start;
    gap: 14px;
    margin-bottom: 12px;
  }

  .candidate-next__dot {
    width: 12px;
    height: 12px;
    border-radius: 999px;
    background: linear-gradient(180deg, #34d399, #059669);
    box-shadow: 0 0 0 4px rgba(52, 211, 153, 0.18);
    margin-top: 6px;
  }

  html[data-theme="light"] .candidate-next__dot {
    background: linear-gradient(180deg, #2563eb, #1d4ed8);
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.22);
  }

  .candidate-next__time {
    font-size: 1.45rem;
    font-weight: 600;
    margin: 0 0 4px;
  }

  .candidate-next__meta,
  .candidate-next__note {
    color: var(--muted);
    font-size: 0.95rem;
  }

  .candidate-next__actions {
    margin-top: 12px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .candidate-slot-control {
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 18px;
    padding: 14px 16px;
    background: rgba(15, 23, 42, 0.35);
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  html[data-theme="light"] .candidate-slot-control {
    background: rgba(255, 255, 255, 0.9);
    border-color: rgba(15, 23, 42, 0.12);
  }

  .candidate-slot-control__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }

  .candidate-slot-panel {
    display: grid;
    gap: 14px;
  }

  .candidate-slot-panel[hidden] {
    display: none;
  }

  .candidate-slot-panel__group {
    border-top: 1px solid rgba(255, 255, 255, 0.08);
    padding-top: 12px;
    display: grid;
    gap: 10px;
  }

  html[data-theme="light"] .candidate-slot-panel__group {
    border-top-color: rgba(15, 23, 42, 0.08);
  }

  .candidate-slot-panel__label {
    margin: 0;
    font-weight: 600;
  }

  .candidate-slot-panel__actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .candidate-slot-panel__hint {
    margin: 0;
    font-size: 0.9rem;
    color: var(--muted);
  }

  .candidate-slot-panel__hint[data-tone="success"] {
    color: color-mix(in srgb, var(--ok) 80%, var(--fg));
  }

  .candidate-slot-panel__hint[data-tone="error"] {
    color: color-mix(in srgb, var(--bad) 80%, var(--fg));
  }

  .candidate-slot-control.is-disabled {
    opacity: 0.6;
  }

  .surface.mt-lg {
    margin-top: 32px;
  }

  .text-prewrap {
    white-space: pre-wrap;
  }

  .interview-section {
    padding: 32px;
  }

  .questionnaire {
    display: grid;
    grid-template-columns: minmax(280px, 0.85fr) minmax(360px, 1.15fr);
    gap: 32px;
  }

  @media (max-width: 1100px) {
    .questionnaire {
      grid-template-columns: 1fr;
    }
  }

  .questionnaire-summary,
  .questionnaire-form {
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 28px;
    padding: 24px;
    background: rgba(15, 23, 42, 0.3);
  }

  html[data-theme="light"] .questionnaire-summary,
  html[data-theme="light"] .questionnaire-form {
    background: rgba(255, 255, 255, 0.95);
    border-color: rgba(15, 23, 42, 0.08);
  }

  .interview-card {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 16px;
    padding: 20px;
    border-radius: 20px;
    background: rgba(15, 23, 42, 0.45);
    border: 1px solid rgba(255, 255, 255, 0.08);
    margin-bottom: 20px;
  }

  html[data-theme="light"] .interview-card {
    background: rgba(255, 255, 255, 0.9);
    border-color: rgba(15, 23, 42, 0.08);
  }

  .interview-card__eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.75rem;
    color: var(--muted);
  }

  .interview-card__title {
    margin: 6px 0;
    font-size: 1.2rem;
  }

  .interview-card__meta {
    display: flex;
    flex-direction: column;
    gap: 6px;
    font-size: 0.9rem;
  }

  .interview-card__actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .questionnaire-form fieldset {
    border: none;
    margin: 0 0 24px;
    padding: 0;
    border-top: 1px solid rgba(255, 255, 255, 0.08);
    padding-top: 20px;
  }

  .questionnaire-form fieldset:first-child {
    border-top: none;
    padding-top: 0;
  }

  html[data-theme="light"] .questionnaire-form fieldset {
    border-color: rgba(15, 23, 42, 0.08);
  }

  .questionnaire-form legend {
    font-weight: 600;
    margin-bottom: 8px;
  }

  .question-description {
    margin: 0 0 16px;
    font-size: 0.9rem;
    color: var(--muted);
  }

  .checkbox-pill {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    border-radius: 16px;
    background: rgba(255, 255, 255, 0.04);
    border: 1px dashed rgba(255, 255, 255, 0.12);
    margin-bottom: 10px;
  }

  html[data-theme="light"] .checkbox-pill {
    background: rgba(15, 23, 42, 0.04);
    border-color: rgba(15, 23, 42, 0.12);
  }

  .checkbox-pill input {
    width: 18px;
    height: 18px;
  }

  .question-field {
    margin-bottom: 16px;
  }

  .question-field label {
    display: block;
    font-size: 0.9rem;
    margin-bottom: 6px;
  }

  .questionnaire-form textarea,
  .questionnaire-form input[type="text"],
  .questionnaire-form input[type="datetime-local"] {
    width: 100%;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(15, 23, 42, 0.15);
    padding: 10px 12px;
    color: inherit;
    font-size: 0.95rem;
  }

  html[data-theme="light"] .questionnaire-form textarea,
  html[data-theme="light"] .questionnaire-form input[type="text"],
  html[data-theme="light"] .questionnaire-form input[type="datetime-local"] {
    background: rgba(255, 255, 255, 0.9);
    border-color: rgba(15, 23, 42, 0.12);
  }

  .questionnaire-form textarea {
    min-height: 90px;
    resize: vertical;
  }

  .decision-options {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }

  .decision-option {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(15, 23, 42, 0.2);
  }

  html[data-theme="light"] .decision-option {
    border-color: rgba(15, 23, 42, 0.15);
    background: rgba(15, 23, 42, 0.04);
  }

  .questionnaire-form .btn {
    margin-top: 12px;
  }

  .test-results-grid {
    display: grid;
    gap: 16px;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  }

  .test-result-card {
    padding: 20px;
    border-radius: 24px;
    background: var(--liquid-glass-bg);
    backdrop-filter: var(--liquid-glass-blur) saturate(200%);
    -webkit-backdrop-filter: var(--liquid-glass-blur) saturate(200%);
    border: 1px solid var(--liquid-glass-border);
    box-shadow: var(--liquid-glass-shadow);
    display: flex;
    flex-direction: column;
    gap: 14px;
    position: relative;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .test-result-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 100%;
    background: var(--liquid-glass-highlight);
    pointer-events: none;
  }
  .test-result-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--liquid-glass-shadow-hover);
    border-color: rgba(255, 255, 255, 0.12);
  }

  .test-result-card__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
  }

  .test-result-card__title {
    margin: 0;
    font-size: 1.05rem;
  }

  .test-result-card__meta {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .test-result-card__actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .test-result-card__body dl {
    display: grid;
    gap: 8px;
  }

  .test-result-card__body dl div {
    display: flex;
    justify-content: space-between;
    gap: 12px;
  }

  .test-result-card__details {
    border-top: 1px solid rgba(15, 23, 42, 0.08);
    padding-top: 12px;
  }

  .test-result-card__details summary {
    cursor: pointer;
    font-weight: 600;
    margin-bottom: 8px;
    outline: none;
  }

  .test-result-card__stats {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    font-size: 0.9rem;
    margin-bottom: 12px;
  }

  .test-result-card__stats span {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 999px;
    padding: 6px 12px;
    transition: all 0.3s ease;
  }
  .test-result-card__stats span:hover {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
    border-color: rgba(255, 255, 255, 0.1);
  }

  .test-result-card__questions .list-table th,
  .test-result-card__questions .list-table td {
    vertical-align: top;
  }

  .status-note {
    font-size: 0.85rem;
    color: #6b7280;
  }

  .test-history {
    margin-top: 16px;
    font-size: 0.9rem;
  }

  .test-history ul {
    margin: 8px 0 0;
    padding-left: 18px;
  }

  .page-actions form.approve-form {
    display: inline-flex;
    flex-direction: column;
    gap: 4px;
    align-items: flex-start;
  }

  .page-actions__note {
    font-size: 0.85rem;
    color: var(--muted);
  }

  .approve-form__hint {
    font-size: 12px;
    color: var(--muted);
  }
</style>
{% set slots = slots or [] %}
{% set pending_ns = namespace(slot=None) %}
{% for slot in slots %}
  {% if pending_ns.slot is none and slot.status == 'pending' %}
    {% set pending_ns.slot = slot %}
  {% endif %}
{% endfor %}
{% set pending_slot = pending_ns.slot %}
{% set saved = request.query_params.get('saved') %}
{% set error = request.query_params.get('error') %}
{% if saved %}
  <div class="surface glass grain alert" data-tone="success" role="status">
    –î–∞–Ω–Ω—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.
  </div>
{% elif error %}
  <div class="surface glass grain alert" data-tone="danger" role="alert">
    –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.
  </div>
{% endif %}
{% set interview_saved = request.query_params.get('interview_saved') %}
{% if interview_saved %}
  <div class="surface glass grain alert" data-tone="success" role="status">
    –°–∫—Ä–∏–ø—Ç —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—ë–Ω.
  </div>
{% elif request.query_params.get('interview_error') %}
  <div class="surface glass grain alert" data-tone="danger" role="alert">
    –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–º–µ—Ç–∫–∏ –ø–æ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—é.
  </div>
{% endif %}
{% set approval_status = request.query_params.get('approval') %}
{% if approval_status %}
  {% set approval_tone = {
    'approved': 'success',
    'notify_failed': 'warning',
    'already': 'info',
    'slot_free': 'warning',
    'missing_candidate': 'danger',
    'not_found': 'danger',
    'error': 'danger',
    'candidate_missing': 'danger',
    'telegram_missing': 'warning',
    'slot_missing': 'warning',
    'invalid_candidate': 'danger'
  } %}
  {% set approval_messages = {
    'approved': '–ò–Ω—Ç–µ—Ä–≤—å—é —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ, –∫–∞–Ω–¥–∏–¥–∞—Ç —É–≤–µ–¥–æ–º–ª—ë–Ω.',
    'notify_failed': '–°–ª–æ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω, –Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—É –Ω–µ —É–¥–∞–ª–æ—Å—å.',
    'already': '–°–ª–æ—Ç —É–∂–µ –±—ã–ª —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω —Ä–∞–Ω–µ–µ.',
    'slot_free': '–°–ª–æ—Ç —É–∂–µ –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω.',
    'missing_candidate': '–°–ª–æ—Ç –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∫–∞–Ω–¥–∏–¥–∞—Ç—É.',
    'not_found': '–ó–∞—è–≤–∫–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –∏–ª–∏ —Å–ª–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.',
    'error': '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å —Å–ª–æ—Ç.',
    'candidate_missing': '–ö–∞–Ω–¥–∏–¥–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.',
    'telegram_missing': '–î–ª—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω Telegram ID.',
    'slot_missing': '–°–ª–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ —É–¥–∞–ª—ë–Ω.',
    'invalid_candidate': '–°–ª–æ—Ç –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –¥—Ä—É–≥–æ–º—É –∫–∞–Ω–¥–∏–¥–∞—Ç—É.'
  } %}
  {% set approval_message = request.query_params.get('approval_message') %}
  {% set tone = approval_tone.get(approval_status, 'info') %}
  <div class="surface glass grain alert" data-tone="{{ tone }}" role="status">
    {{ approval_message or approval_messages.get(approval_status, '–î–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.') }}
  </div>
{% endif %}
{% set manual_slot_status = request.query_params.get('slot_scheduled') %}
{% if manual_slot_status %}
  {% set slot_tones = {
    'success': 'success',
    'notify_failed': 'warning',
    'missing_telegram': 'danger'
  } %}
  {% set slot_messages = {
    'success': '–°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ –∏ –∫–∞–Ω–¥–∏–¥–∞—Ç —É–≤–µ–¥–æ–º–ª—ë–Ω.',
    'notify_failed': '–°–ª–æ—Ç —Å–æ–∑–¥–∞–Ω, –Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—É –Ω–µ —É–¥–∞–ª–æ—Å—å ‚Äî —Å–≤—è–∂–∏—Ç–µ—Å—å –≤—Ä—É—á–Ω—É—é.',
    'missing_telegram': '–ù–µ–ª—å–∑—è –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ ‚Äî —É –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç Telegram ID.'
  } %}
  <div class="surface glass grain alert" data-tone="{{ slot_tones.get(manual_slot_status, 'info') }}" role="status">
    {{ slot_messages.get(manual_slot_status, '–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω.') }}
  </div>
{% endif %}
{% set interview_record = interview_notes|default({}) %}
{% set interview_data = interview_record.get('data', {}) or {} %}
{% set interview_recommendation = interview_data.get('recommendation', 'undecided') %}
{% set interview_sections = interview_form_sections or [] %}
{% set recommendation_lookup = interview_recommendation_lookup or {} %}
{% set show_interview_form = request.query_params.get('interview_edit') or (interview_data|length == 0) %}
{% set telegram_user_id = user.telegram_user_id or user.telegram_id %}
{% set telegram_username = user.telegram_username or user.username %}
{% set telegram_linked_at = user.telegram_linked_at %}
{% set chat_templates = chat_templates or [] %}
<section class="page-header">
  <div>
    <a class="muted" href="/candidates">‚Üê –ö —Å–ø–∏—Å–∫—É –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤</a>
    <h1 class="page-title">{{ user.fio }}</h1>
    <p class="page-description">
      Telegram ID {{ telegram_user_id or '‚Äî' }} ¬∑ {{ user.city or '–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω' }}
    </p>
  </div>
  <div class="page-actions">
    {% set cs = (candidate_status_slug or user.candidate_status or '')|lower %}
    {% set has_test2_completed = false %}
    {% for res in tests or [] %}
      {% if res.rating and res.rating|upper == 'TEST2' %}
        {% set has_test2_completed = true %}
      {% endif %}
    {% endfor %}
    {% set intro_day_allowed = can_schedule_intro_day or (cs in ['test2_completed', 'intro_day_scheduled', 'intro_day_confirmed_preliminary', 'intro_day_confirmed_day_of'] or has_test2_completed) %}
    {% if not (has_intro_day_slot | default(false)) and intro_day_allowed %}
      <a href="/candidates/{{ user.id }}/schedule-intro-day" class="btn btn-primary">
        üìÜ –ù–∞–∑–Ω–∞—á–∏—Ç—å –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω—å
      </a>
    {% endif %}
    <div class="btn-group">
      {% if cs in ['waiting_slot', 'stalled_waiting_slot', 'test1_completed', 'interview_declined', 'interview_scheduled'] or not has_interview_slot %}
        <a href="/candidates/{{ user.id }}/schedule-slot" class="btn {% if cs in ['waiting_slot', 'stalled_waiting_slot'] %}btn-primary{% else %}btn-secondary{% endif %}">
          üïí {% if cs in ['waiting_slot', 'stalled_waiting_slot'] %}–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤—Ä–µ–º—è —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è{% else %}–ù–∞–∑–Ω–∞—á–∏—Ç—å/–ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ{% endif %}
        </a>
      {% endif %}
      <form method="post" action="/candidates/{{ user.id }}/status" style="display:inline;" onsubmit="return confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ {{ user.fio }}?');">
        {{ csrf_input(request) }}
        <input type="hidden" name="status" value="interview_declined">
        <button class="btn btn-ghost" type="submit">üö´ –û—Ç–∫–∞–∑</button>
      </form>
    </div>
    {% if pending_slot %}
      <form method="post" action="/candidates/{{ user.id }}/slots/{{ pending_slot.id }}/approve" class="approve-form">
        {{ csrf_input(request) }}
        <button class="btn btn-primary" type="submit">
          ‚úÖ –°–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é
        </button>
        <span class="approve-form__hint">
          {{ fmt_local(pending_slot.start_utc, pending_slot.candidate_tz or 'Europe/Moscow') }} ¬∑
          {% if pending_slot.recruiter %}{{ pending_slot.recruiter.name }}{% else %}–ë–µ–∑ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞{% endif %}
        </span>
      </form>
    {% endif %}

    {# Manual status change buttons for HIRED/NOT_HIRED #}
    {% if cs in ['intro_day_confirmed_day_of', 'intro_day_confirmed_preliminary'] %}
      <form method="post" action="/candidates/{{ user.id }}/status" style="display: inline;">
        {{ csrf_input(request) }}
        <input type="hidden" name="status" value="hired">
        <button class="btn btn-primary" type="submit" onclick="return confirm('–ó–∞–∫—Ä–µ–ø–∏—Ç—å {{ user.fio }} –Ω–∞ –æ–±—É—á–µ–Ω–∏–µ?');">
          üéâ –ó–∞–∫—Ä–µ–ø–ª–µ–Ω –Ω–∞ –æ–±—É—á–µ–Ω–∏–µ
        </button>
      </form>
      <form method="post" action="/candidates/{{ user.id }}/status" style="display: inline;">
        {{ csrf_input(request) }}
        <input type="hidden" name="status" value="not_hired">
        <button class="btn btn-ghost" type="submit" onclick="return confirm('–ü–æ–º–µ—Ç–∏—Ç—å {{ user.fio }} –∫–∞–∫ –Ω–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–≥–æ?');">
          ‚ö†Ô∏è –ù–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω
        </button>
      </form>
      <form method="post" action="/candidates/{{ user.id }}/status" style="display: inline;">
        {{ csrf_input(request) }}
        <input type="hidden" name="status" value="intro_day_declined_day_of">
        <button class="btn btn-soft" type="submit" onclick="return confirm('–û—Ç–∫–∞–∑–∞—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç—É {{ user.fio }} –ø–æ—Å–ª–µ –û–î?');">
          ‚õîÔ∏è –û—Ç–∫–∞–∑
        </button>
      </form>
    {% endif %}

    <form method="post" action="/candidates/{{ user.id }}/toggle">
      {{ csrf_input(request) }}
      {% if user.is_active %}
        <input type="hidden" name="active" value="false">
        <button class="btn btn-ghost" type="submit">–û—Ç–∫–ª—é—á–∏—Ç—å</button>
      {% else %}
        <input type="hidden" name="active" value="true">
        <button class="btn btn-primary" type="submit">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
      {% endif %}
    </form>
    <form method="post" action="/candidates/{{ user.id }}/delete" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ {{ user.fio }}?');">
      {{ csrf_input(request) }}
      <button class="btn btn-soft" type="submit">–£–¥–∞–ª–∏—Ç—å</button>
    </form>
  </div>
</section>

<section class="telegram-panel" aria-labelledby="telegram-panel-title">
  <div>
    <p class="telegram-panel__eyebrow">Telegram</p>
    <h2 class="telegram-panel__title" id="telegram-panel-title">–ö–æ–Ω—Ç–∞–∫—Ç—ã –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</h2>
    {% if telegram_linked_at %}
      <p class="telegram-panel__meta">
        –°–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ {{ fmt_local(telegram_linked_at, 'Europe/Moscow') }}
      </p>
    {% endif %}
  </div>
  <div class="telegram-panel__grid">
    <div class="telegram-panel__item">
      <span class="telegram-panel__label">TG ID</span>
      {% if telegram_user_id %}
        <div class="telegram-panel__value">
          <code>{{ telegram_user_id }}</code>
          <button
            class="btn btn-ghost btn--xs"
            type="button"
            data-copy-value="{{ telegram_user_id }}"
            data-copy-success="–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ">
            –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å TG ID
          </button>
        </div>
      {% else %}
        <p class="telegram-panel__hint">–ë–æ—Ç –µ—â—ë –Ω–µ –ø–æ–ª—É—á–∏–ª Telegram ID.</p>
      {% endif %}
    </div>
    <div class="telegram-panel__item">
      <span class="telegram-panel__label">Username</span>
      {% if telegram_username %}
        <div class="telegram-panel__value">
          <code>@{{ telegram_username }}</code>
          <button
            class="btn btn-ghost btn--xs"
            type="button"
            data-copy-value="{{ telegram_username }}"
            data-copy-success="–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ">
            –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å username
          </button>
        </div>
      {% else %}
        <p class="telegram-panel__hint">–ö–∞–Ω–¥–∏–¥–∞—Ç —Å–∫—Ä—ã–≤–∞–µ—Ç username ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ TG ID.</p>
      {% endif %}
    </div>
    <div class="telegram-panel__item">
      <span class="telegram-panel__label">–î–µ–π—Å—Ç–≤–∏—è</span>
      {% if telegram_username %}
        <div class="telegram-panel__actions">
          <a class="btn btn-soft" href="https://t.me/{{ telegram_username }}" target="_blank" rel="noopener">
            –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç
          </a>
        </div>
        <p class="telegram-panel__hint">–û—Ç–∫—Ä–æ–µ—Ç—Å—è Telegram –∏–ª–∏ Telegram Web.</p>
      {% elif telegram_user_id %}
        <div class="telegram-panel__actions">
          <a class="btn btn-soft" href="tg://user?id={{ telegram_user_id }}">tg://user?id={{ telegram_user_id }}</a>
        </div>
        <p class="telegram-panel__hint">
          –ï—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç tg:// ‚Äî —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ TG ID –∏ –Ω–∞–π–¥–∏—Ç–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é.
        </p>
      {% else %}
        <p class="telegram-panel__hint">–¢–µ–ª–µ–≥—Ä–∞–º –µ—â—ë –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω ‚Äî –¥–æ–∂–¥–∏—Ç–µ—Å—å –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.</p>
      {% endif %}
    </div>
  </div>
</section>

{% set chat_disabled = 1 if not telegram_user_id else 0 %}
<section
  class="chat-panel"
  data-chat-root
  data-chat-disabled="{{ chat_disabled }}"
  data-chat-url="/api/candidates/{{ user.id }}/chat"
  data-chat-retry-base="/api/candidates/{{ user.id }}/chat"
>
  <div class="chat-panel__header">
    <div>
      <p class="telegram-panel__eyebrow">–ß–∞—Ç (Telegram)</p>
      <h2 class="chat-panel__title">–û–±—â–µ–Ω–∏–µ —Å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–º</h2>
    </div>
    <button class="btn btn-ghost btn--xs" type="button" data-chat-refresh>–û–±–Ω–æ–≤–∏—Ç—å</button>
  </div>
  {% if not telegram_user_id %}
    <div class="chat-panel__placeholder">
      <p>–ö–∞–Ω–¥–∏–¥–∞—Ç –µ—â—ë –Ω–µ –ø–∏—Å–∞–ª –±–æ—Ç—É ‚Äî —á–∞—Ç —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.</p>
    </div>
  {% else %}
    <div class="chat-panel__log" data-chat-list>
      <p class="chat-panel__placeholder">–°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–¥–≥—Ä—É–∂–∞—é—Ç—Å—è‚Ä¶</p>
    </div>
    <button class="btn btn-ghost btn--xs" type="button" data-chat-more hidden>–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë</button>
    <div class="chat-panel__templates">
      {% for template in chat_templates or [] %}
        <button
          class="btn btn-ghost btn--xs"
          type="button"
          data-chat-template="{{ template.key }}"
          data-template-text="{{ template.text }}">
          {{ template.label }}
        </button>
      {% endfor %}
    </div>
    <form class="chat-panel__form" data-chat-form>
      <textarea data-chat-input placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—É‚Ä¶" maxlength="2000"></textarea>
      <div class="chat-panel__form-actions">
        <span class="chat-panel__status" data-chat-status></span>
        <button class="btn btn-primary" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </form>
  {% endif %}
</section>

{% set avg_score_label = '%.1f'|format(stats.average_score) if stats.average_score is not none else '‚Äî' %}
<section class="surface glass grain candidate-overview" id="candidate-overview">
  <div class="candidate-hero">
    <div class="candidate-hero__summary">
      <p class="candidate-hero__eyebrow">–¢–µ–∫—É—â–∞—è —Å—Ç–∞–¥–∏—è</p>
      <div class="candidate-hero__stage-wrap">
        <p class="candidate-hero__stage">{{ stage or '–ë–µ–∑ –∏–Ω—Ç–µ—Ä–≤—å—é' }}</p>
        <span class="candidate-hero__stage-pill">
          {% if upcoming_slot and upcoming_slot.start_utc %}
            –ù–∞–∑–Ω–∞—á–µ–Ω–æ –∏–Ω—Ç–µ—Ä–≤—å—é
          {% elif stats.tests_total %}
            –ò–¥—ë—Ç –æ—Ü–µ–Ω–∫–∞
          {% else %}
            –ù—É–∂–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ
          {% endif %}
        </span>
      </div>
      <p class="candidate-hero__meta">
        {% if user.last_activity %}
          –û–±–Ω–æ–≤–ª—ë–Ω {{ fmt_local(user.last_activity, 'Europe/Moscow') }}
        {% else %}
          –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–∫–∞ –Ω–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞
        {% endif %}
      </p>
      <div class="candidate-hero__tags">
        <span class="candidate-hero__tag">{{ user.city or '–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω' }}</span>
        {% if telegram_user_id %}
          <span class="candidate-hero__tag">TG {{ telegram_user_id }}</span>
        {% endif %}
        {% if telegram_username %}
          <span class="candidate-hero__tag">@{{ telegram_username }}</span>
        {% elif telegram_user_id %}
          <span class="candidate-hero__chat-note">username –Ω–µ —É–∫–∞–∑–∞–Ω</span>
        {% endif %}
        {% if user.intro_decline_reason %}
          <span class="candidate-hero__tag" title="{{ user.intro_decline_reason }}">–û—Ç–∫–∞–∑ –û–î: {{ user.intro_decline_reason[:40] ~ ('‚Ä¶' if user.intro_decline_reason|length > 40 else '') }}</span>
        {% endif %}
      </div>
    </div>
    <div class="candidate-hero__status">
      <span class="candidate-hero__status-pill {% if not user.is_active %}is-muted{% endif %}">
        {% if user.is_active %}–ê–∫—Ç–∏–≤–µ–Ω{% else %}–û—Ç–∫–ª—é—á—ë–Ω{% endif %}
      </span>
      <p class="candidate-hero__status-note">
        {% if upcoming_slot and upcoming_slot.start_utc %}
          –°–ª–µ–¥—É—é—â–µ–µ —Å–æ–±—ã—Ç–∏–µ {{ fmt_local(upcoming_slot.start_utc, upcoming_slot.candidate_tz or 'Europe/Moscow') }}
        {% elif stats.tests_total %}
          –ü—Ä–æ—à—ë–ª {{ stats.tests_total }} —Ç–µ—Å—Ç(–∞)
        {% else %}
          –ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
        {% endif %}
      </p>
      <dl class="candidate-hero__metrics">
        <div>
          <dt>–¢–µ—Å—Ç–æ–≤</dt>
          <dd>{{ stats.tests_total }}</dd>
        </div>
        <div>
          <dt>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</dt>
          <dd>{{ avg_score_label }}</dd>
        </div>
        <div>
          <dt>–°–æ–æ–±—â–µ–Ω–∏–π</dt>
          <dd>{{ messages|length }}</dd>
        </div>
      </dl>
    </div>
  </div>

  {# –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–µ –∏–Ω—Ç–µ—Ä–≤—å—é (–Ω–µ free) #}
  {% set interview_ns = namespace(has_slot=false) %}
  {% for slot in slots or [] %}
    {% set status_raw = (slot.status or '')|lower %}
    {% if (slot.purpose is not defined or slot.purpose != 'intro_day') and status_raw in ['pending', 'booked', 'confirmed_by_candidate'] %}
      {% set interview_ns.has_slot = true %}
    {% endif %}
  {% endfor %}

  {% set manual_tz = user.manual_slot_timezone or 'Europe/Moscow' %}
  {% if (user.manual_slot_from or user.manual_slot_comment or user.manual_slot_requested_at) and not interview_ns.has_slot %}
  <section class="manual-slot-card" id="manual-availability">
    <div>
      <p class="manual-slot-card__eyebrow">–ö–∞–Ω–¥–∏–¥–∞—Ç –æ—Å—Ç–∞–≤–∏–ª –ø–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏</p>
      {% if user.manual_slot_from %}
        <p class="manual-slot-card__window">
          {{ fmt_local(user.manual_slot_from, manual_tz) }}
          {% if user.manual_slot_to %}
            ‚Äî {{ fmt_local(user.manual_slot_to, manual_tz) }}
          {% endif %}
        </p>
      {% elif user.manual_slot_comment %}
        <p class="manual-slot-card__window">{{ user.manual_slot_comment }}</p>
      {% else %}
        <p class="manual-slot-card__window">–û–∂–∏–¥–∞–µ—Ç —Ä—É—á–Ω–æ–≥–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è</p>
      {% endif %}

      {% if user.manual_slot_comment and user.manual_slot_from %}
        <p class="manual-slot-card__note">üìù {{ user.manual_slot_comment }}</p>
      {% endif %}
      {% if user.manual_slot_requested_at or user.manual_slot_response_at %}
        <p class="manual-slot-card__meta">
          –ó–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–µ–Ω {{ fmt_local(user.manual_slot_requested_at or user.manual_slot_response_at, manual_tz) }}
        </p>
      {% endif %}
    </div>
    <div class="manual-slot-card__actions">
      <a class="btn btn-primary" href="/candidates/{{ user.id }}/schedule-slot">–ù–∞–∑–Ω–∞—á–∏—Ç—å —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ</a>
      {% if telegram_user_id %}
        <a class="btn btn-soft" href="tg://user?id={{ telegram_user_id }}">–ù–∞–ø–∏—Å–∞—Ç—å –≤ TG</a>
      {% endif %}
    </div>
  </section>
  {% endif %}

  <div class="candidate-next">
    <p class="candidate-next__eyebrow">–ë–ª–∏–∂–∞–π—à–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ</p>
    <div class="candidate-next__timeline">
      <span class="candidate-next__dot" aria-hidden="true"></span>
      <div>
        {% if upcoming_slot and upcoming_slot.start_utc %}
          <p class="candidate-next__time">{{ fmt_local(upcoming_slot.start_utc, upcoming_slot.candidate_tz or 'Europe/Moscow') }}</p>
          <p class="candidate-next__meta">
            {% set slot_city = upcoming_slot.city.name if upcoming_slot.city else (upcoming_slot.candidate_city or user.city or '–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω') %}
            {{ slot_city }}
            {% if upcoming_slot.recruiter %}
              ¬∑ {{ upcoming_slot.recruiter.name }}
            {% endif %}
          </p>
        {% else %}
          <p class="candidate-next__time">–ù–µ—Ç –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ</p>
          <p class="candidate-next__meta">–ù–∞–∑–Ω–∞—á—å—Ç–µ –∏–Ω—Ç–µ—Ä–≤—å—é –∏–ª–∏ —Ç–µ—Å—Ç, —á—Ç–æ–±—ã –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥.</p>
        {% endif %}
      </div>
    </div>
    <div class="candidate-next__actions">
      {% if telemost_url %}
        <a class="btn btn-soft btn-xs" href="{{ telemost_url }}" target="_blank" rel="noopener noreferrer">–û—Ç–∫—Ä—ã—Ç—å —Ç–µ–ª–µ–º–æ—Å—Ç</a>
        <span class="candidate-next__note">
          {% if telemost_source == 'upcoming' %}
            –°—Å—ã–ª–∫–∞ –¥–ª—è –±–ª–∏–∂–∞–π—à–µ–≥–æ –∏–Ω—Ç–µ—Ä–≤—å—é
          {% elif telemost_source == 'recent' %}
            –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–π —Å–ª–æ—Ç
          {% else %}
            –ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
          {% endif %}
        </span>
      {% else %}
        <span class="candidate-next__note">–°—Å—ã–ª–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–≤—å—é.</span>
      {% endif %}

      {% if upcoming_slot %}
        {% set slot_state = (upcoming_slot.status or '')|lower %}
        <div class="candidate-slot-control"
             data-slot-controls
             data-slot-id="{{ upcoming_slot.id }}"
             data-slot-status="{{ slot_state }}"
             data-slot-has-candidate="{{ 1 if upcoming_slot.candidate_tg_id else 0 }}">
          <div class="candidate-slot-control__header">
            <strong>–°–ª–æ—Ç —Å {{ fmt_local(upcoming_slot.start_utc, upcoming_slot.candidate_tz or 'Europe/Moscow') }}</strong>
            <button class="btn btn-ghost btn--small" type="button" data-slot-toggle>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç</button>
          </div>
          <div class="candidate-slot-panel" data-slot-panel hidden>
            <div class="candidate-slot-panel__group">
              <p class="candidate-slot-panel__label">–ë—Ä–æ–Ω—å</p>
              <div class="candidate-slot-panel__actions">
                <button class="btn btn-ghost btn--small" type="button" data-slot-action="reschedule">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏</button>
                <button class="btn btn-ghost btn--small" type="button" data-slot-action="cancel">–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å</button>
              </div>
              <p class="candidate-slot-panel__hint" data-slot-message></p>
            </div>
            <div class="candidate-slot-panel__group">
              <p class="candidate-slot-panel__label">–ò—Å—Ö–æ–¥ –∏–Ω—Ç–µ—Ä–≤—å—é</p>
              <div class="candidate-slot-panel__actions">
                <button class="btn btn-ghost btn--small" type="button" data-slot-outcome="success">–ü—Ä–æ—à—ë–ª</button>
                <button class="btn btn-ghost btn--small" type="button" data-slot-outcome="reject">–ù–µ –ø—Ä–æ—à—ë–ª</button>
              </div>
              <p class="candidate-slot-panel__hint" data-slot-outcome-status>
                {% if upcoming_slot.interview_outcome == 'success' %}
                  –û—Ç–º–µ—á–µ–Ω –∫–∞–∫ ¬´–ü—Ä–æ—à—ë–ª¬ª
                {% elif upcoming_slot.interview_outcome == 'reject' %}
                  –û—Ç–º–µ—á–µ–Ω –∫–∞–∫ ¬´–ù–µ –ø—Ä–æ—à—ë–ª¬ª
                {% else %}
                  –ò—Å—Ö–æ–¥ –µ—â—ë –Ω–µ –≤—ã–±—Ä–∞–Ω
                {% endif %}
              </p>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</section>

<section class="surface glass grain mt-lg interview-section" id="interview-script">
  <header class="section-header">
    <div>
      <h2 class="section-title">–ê–Ω–∫–µ—Ç–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è Smart Service</h2>
      <p class="section-hint">–ó–∞–ø–æ–ª–Ω—è–π—Ç–µ –ø–æ —Ö–æ–¥—É —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ ‚Äî –∏—Ç–æ–≥ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.</p>
    </div>
    <div class="interview-meta">
      {% if interview_record.get('updated_at') %}
        <span class="muted">–û–±–Ω–æ–≤–ª–µ–Ω–æ {{ fmt_local(interview_record.get('updated_at'), 'Europe/Moscow') }}</span>
      {% endif %}
    </div>
  </header>
  <div class="questionnaire">
    <aside class="questionnaire-summary">
      {% if interview_data %}
        {% set rec_meta = recommendation_lookup.get(interview_recommendation) %}
        <div class="interview-card">
          <div>
            <span class="interview-card__eyebrow">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>
            <h3 class="interview-card__title">{{ rec_meta.label if rec_meta else '–ê–Ω–∫–µ—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞' }}</h3>
            <div class="interview-card__meta">
              <span>–ò–Ω—Ç–µ—Ä–≤—å—é–µ—Ä: {{ interview_record.get('interviewer_name') or '‚Äî' }}</span>
              <span>–ü—Ä–æ–≤–µ–¥–µ–Ω–æ: {{ interview_data.get('interviewed_at') or '‚Äî' }}</span>
            </div>
          </div>
          <div class="interview-card__actions">
            <a class="btn btn-soft" href="/candidates/{{ user.id }}/interview-notes/download" rel="noopener">üìÑ –°–∫–∞—á–∞—Ç—å</a>
            <a class="btn btn-primary" href="/candidates/{{ user.id }}?interview_edit=1#interview-script">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
          </div>
        </div>
      {% else %}
        <p class="muted">–ê–Ω–∫–µ—Ç–∞ –ø–æ–∫–∞ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ ¬´–ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É¬ª, —á—Ç–æ–±—ã –ø—Ä–æ–π—Ç–∏ —Å–∫—Ä–∏–ø—Ç.</p>
        <a class="btn btn-primary" href="/candidates/{{ user.id }}?interview_edit=1#interview-script">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É</a>
      {% endif %}
    </aside>
    {% if show_interview_form %}
      <div class="questionnaire-form">
        <form method="post" action="/candidates/{{ user.id }}/interview-notes">
          {{ csrf_input(request) }}
          {% for section in interview_sections %}
            <fieldset>
              <legend>{{ section.title }}</legend>
              {% if section.description %}
                <p class="question-description">{{ section.description }}</p>
              {% endif %}
              {% for question in section.questions %}
                {% set field_id = 'question-' ~ question.key %}
                {% set value = interview_data.get(question.key) %}
                {% if question.type == 'checkbox' %}
                  <label class="checkbox-pill" for="{{ field_id }}">
                    <input type="checkbox" id="{{ field_id }}" name="{{ question.key }}" {% if value %}checked{% endif %}>
                    <span>{{ question.label }}</span>
                  </label>
                {% elif question.type == 'textarea' %}
                  <div class="question-field">
                    <label for="{{ field_id }}">{{ question.label }}</label>
                    <textarea id="{{ field_id }}" name="{{ question.key }}" placeholder="{{ question.placeholder or '' }}">{{ value or '' }}</textarea>
                  </div>
                {% elif question.type == 'text' %}
                  <div class="question-field">
                    <label for="{{ field_id }}">{{ question.label }}</label>
                    <input type="text" id="{{ field_id }}" name="{{ question.key }}" value="{{ value or '' }}" placeholder="{{ question.placeholder or '' }}">
                  </div>
                {% elif question.type == 'datetime' %}
                  <div class="question-field">
                    <label for="{{ field_id }}">{{ question.label }}</label>
                    <input type="datetime-local" id="{{ field_id }}" name="{{ question.key }}" value="{{ value or '' }}">
                  </div>
                {% elif question.type == 'radio' %}
                  <div class="question-field">
                    <label>{{ question.label }}</label>
                    <div class="decision-options">
                      {% for option in question.options %}
                        <label class="decision-option">
                          <input type="radio" name="{{ question.key }}" value="{{ option.value }}" {% if interview_recommendation == option.value %}checked{% endif %}>
                          <span>{{ option.label }}</span>
                        </label>
                      {% endfor %}
                    </div>
                  </div>
                {% endif %}
              {% endfor %}
            </fieldset>
          {% endfor %}
          <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É</button>
        </form>
      </div>
    {% endif %}
  </div>
</section>

<section class="surface glass grain mt-lg">
  <header class="section-header">
    <h2 class="section-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</h2>
    <p class="section-hint">–°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –∏ –ø–æ–¥—Ä–æ–±–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.</p>
  </header>
  {% set status_meta = {
    'passed': {'class': 'badge badge--success', 'icon': '‚úÖ', 'label': '–ü—Ä–æ–π–¥–µ–Ω'},
    'failed': {'class': 'badge badge--warning', 'icon': '‚ùå', 'label': '–ù–µ –ø—Ä–æ–π–¥–µ–Ω'},
    'in_progress': {'class': 'badge badge--info', 'icon': '‚è≥', 'label': '–í –ø—Ä–æ—Ü–µ—Å—Å–µ'},
    'not_started': {'class': 'badge badge--muted', 'icon': '‚Äî', 'label': '–ù–µ –ø—Ä–æ—Ö–æ–¥–∏–ª'}
  } %}
  <div class="test-results-grid">
    {% for section in test_sections %}
      {% set meta = status_meta.get(section.status, status_meta['not_started']) %}
      {% set stats = section.details.stats %}
      <article class="test-result-card">
        <header class="test-result-card__header">
          <div class="test-result-card__meta">
            <h3 class="test-result-card__title">{{ section.title }}</h3>
            <span class="{{ meta.class }}">{{ meta.icon }} {{ section.status_label or meta.label }}</span>
          </div>
          <div class="test-result-card__actions">
            {% if section.report_url %}
              <a class="btn btn-soft btn-xs" href="{{ section.report_url }}" download>–°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç</a>
            {% endif %}
          </div>
        </header>
        <div class="test-result-card__body">
          <dl>
            <div>
              <dt>–°—Ç–∞—Ç—É—Å</dt>
              <dd>{{ meta.icon }} {{ section.status_label or meta.label }}</dd>
            </div>
            <div>
              <dt>–ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ</dt>
              <dd>
                {% if section.completed_at %}
                  {{ fmt_local(section.completed_at, 'Europe/Moscow') }}
                {% else %}
                  <span class="muted">‚Äî</span>
                {% endif %}
              </dd>
            </div>
            <div>
              <dt>–ö—Ä–∞—Ç–∫–æ</dt>
              <dd>{{ section.summary }}</dd>
            </div>
          </dl>
        </div>
        {% if section.pending_since %}
          <p class="status-note">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {{ fmt_local(section.pending_since, 'Europe/Moscow') }}</p>
        {% endif %}
        {% set has_details = section.details.questions|length > 0 or section.history|length > 1 %}
        {% if has_details %}
          <details class="test-result-card__details">
            <summary>–û—Ç–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏</summary>
            <div class="test-result-card__stats">
              <span>–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤: {{ stats.total_questions }}</span>
              <span>–í–µ—Ä–Ω–æ: {{ stats.correct_answers }}</span>
              {% if stats.overtime_questions %}
                <span>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: {{ stats.overtime_questions }}</span>
              {% endif %}
              {% if stats.final_score is not none %}
                <span>–ë–∞–ª–ª—ã: {{ '%.1f'|format(stats.final_score) }}</span>
              {% endif %}
              {% if stats.total_time %}
                <span>–í—Ä–µ–º—è: {{ stats.total_time }} —Å–µ–∫</span>
              {% endif %}
            </div>
            <div class="test-result-card__questions list-table-wrapper">
              <table class="list-table">
                <thead>
                  <tr>
                    <th scope="col">–í–æ–ø—Ä–æ—Å</th>
                    <th scope="col">–û—Ç–≤–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</th>
                    <th scope="col">–ü—Ä–æ–≤–µ—Ä–∫–∞</th>
                  </tr>
                </thead>
                <tbody>
                  {% for question in section.details.questions %}
                    <tr>
                      <td>
                        <strong>{{ question.question_index }}.</strong>
                        <div class="text-prewrap">{{ question.question_text }}</div>
                      </td>
                      <td class="text-prewrap">{{ question.user_answer or '‚Äî' }}</td>
                      <td>
                        {% if question.correct_answer %}
                          <div class="text-prewrap">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {{ question.correct_answer }}</div>
                        {% endif %}
                        <div>
                          {% if question.is_correct %}
                            <span class="badge badge--success">–í–µ—Ä–Ω–æ</span>
                          {% else %}
                            <span class="badge badge--muted">–ù–µ–≤–µ—Ä–Ω–æ</span>
                          {% endif %}
                          {% if question.overtime %}
                            <span class="badge badge--warning">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
                          {% endif %}
                          {% if question.attempts_count and question.attempts_count > 1 %}
                            <span class="badge badge--soft">–ü–æ–ø—ã—Ç–æ–∫: {{ question.attempts_count }}</span>
                          {% endif %}
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% if section.history|length > 1 %}
            <div class="test-history">
              <strong>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–ø—ã—Ç–æ–∫</strong>
              <ul>
                {% for item in section.history %}
                  <li>
                    {% if item.completed_at %}
                      {{ fmt_local(item.completed_at, 'Europe/Moscow') }}
                    {% else %}
                      ‚Äî
                    {% endif %}
                    ¬∑ {{ '%.1f'|format(item.final_score) if item.final_score is not none else '‚Äî' }} –±–∞–ª–ª–æ–≤
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
          </details>
        {% else %}
          <p class="muted">–î–µ—Ç–∞–ª–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∞.</p>
        {% endif %}
      </article>
    {% endfor %}
  </div>
</section>

<script>
(function () {
  const chatRoot = document.querySelector('[data-chat-root]');
  if (!chatRoot) {
    return;
  }
  if (chatRoot.dataset.chatDisabled === '1') {
    return;
  }
  const chatList = chatRoot.querySelector('[data-chat-list]');
  const loadMoreBtn = chatRoot.querySelector('[data-chat-more]');
  const refreshBtn = chatRoot.querySelector('[data-chat-refresh]');
  const form = chatRoot.querySelector('[data-chat-form]');
  const input = chatRoot.querySelector('[data-chat-input]');
  const statusEl = chatRoot.querySelector('[data-chat-status]');
  const templateButtons = chatRoot.querySelectorAll('[data-chat-template]');
  const chatUrl = chatRoot.dataset.chatUrl;
  const retryBase = chatRoot.dataset.chatRetryBase;
  const csrfToken = window.__CSRF_TOKEN__ || document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
  let pollTimer = null;
  let state = [];

  const setStatus = (message, tone = 'muted') => {
    if (!statusEl) return;
    statusEl.textContent = message || '';
    statusEl.dataset.tone = tone;
  };

  const sortMessages = (messages) => {
    return [...messages].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
  };

  const render = () => {
    if (!chatList) return;
    chatList.innerHTML = '';
    if (!state.length) {
      chatList.innerHTML = '<p class="chat-panel__placeholder">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π.</p>';
      return;
    }
    state.forEach((msg) => {
      const row = document.createElement('div');
      row.className = 'chat-message' + (msg.direction === 'outbound' ? ' chat-message--outbound' : '');
      const content = document.createElement('div');
      content.className = 'chat-message__text';
      content.textContent = msg.text || '';
      row.appendChild(content);
      const meta = document.createElement('div');
      meta.className = 'chat-message__meta';
      const dt = new Date(msg.created_at);
      meta.innerHTML = `<span>${dt.toLocaleString('ru-RU')}</span><span>${msg.status}</span>`;
      row.appendChild(meta);
      if (msg.error) {
        const error = document.createElement('div');
        error.className = 'chat-message__status';
        error.textContent = msg.error;
        row.appendChild(error);
      }
      if (msg.can_retry) {
        const retryBtn = document.createElement('button');
        retryBtn.type = 'button';
        retryBtn.className = 'btn btn-ghost btn--xs';
        retryBtn.dataset.chatRetry = String(msg.id);
        retryBtn.textContent = '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å';
        row.appendChild(retryBtn);
      }
      chatList.appendChild(row);
    });
  };

  const upsertMessages = (messages, { replace = false, prepend = false } = {}) => {
    if (!messages || !messages.length) {
      if (replace) {
        state = [];
        render();
      }
      return;
    }
    if (replace) {
      state = sortMessages(messages);
    } else if (prepend) {
      const existingIds = new Set(state.map((msg) => msg.id));
      const ordered = sortMessages(messages);
      state = [...ordered.filter((msg) => !existingIds.has(msg.id)), ...state];
    } else {
      const map = new Map(state.map((msg) => [msg.id, msg]));
      messages.forEach((msg) => map.set(msg.id, msg));
      state = sortMessages(Array.from(map.values()));
    }
    render();
    if (state.length) {
      state = sortMessages(state);
    }
  };

  const fetchJson = async (url, options) => {
    const response = await fetch(url, options);
    if (!response.ok) {
      const payload = await response.json().catch(() => ({}));
      const message = payload?.detail?.message || payload?.message || response.statusText;
      throw new Error(message || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å');
    }
    return response.json();
  };

  const loadLatest = async () => {
    try {
      const data = await fetchJson(chatUrl);
      upsertMessages(data.messages || [], { replace: true });
      if (loadMoreBtn) {
        loadMoreBtn.hidden = !data.has_more;
      }
    } catch (err) {
      console.error(err);
      setStatus(err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–∞—Ç', 'danger');
    }
  };

  const loadOlder = async () => {
    if (!state.length) return;
    const before = state[0]?.created_at;
    if (!before) return;
    const url = `${chatUrl}?before=${encodeURIComponent(before)}`;
    try {
      const data = await fetchJson(url);
      upsertMessages(data.messages || [], { prepend: true });
      if (loadMoreBtn) {
        loadMoreBtn.hidden = !data.has_more;
      }
    } catch (err) {
      setStatus(err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è', 'danger');
    }
  };

  const sendMessage = async (text) => {
    const payload = {
      text,
      client_request_id: (crypto?.randomUUID && crypto.randomUUID()) || String(Date.now()),
    };
    const body = JSON.stringify(payload);
    setStatus('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º‚Ä¶', 'info');
    const result = await fetchJson(chatUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken,
      },
      body,
    });
    if (result?.message) {
      upsertMessages([result.message]);
    } else {
      await loadLatest();
    }
    setStatus('');
  };

  const retryMessage = async (messageId) => {
    const url = `${retryBase}/${messageId}/retry`;
    setStatus('–ü—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ‚Ä¶', 'info');
    const data = await fetchJson(url, {
      method: 'POST',
      headers: {
        'X-CSRF-Token': csrfToken,
      },
    });
    if (data?.message) {
      upsertMessages([data.message]);
    }
    setStatus('');
  };

  loadMoreBtn?.addEventListener('click', () => {
    loadOlder();
  });

  refreshBtn?.addEventListener('click', () => {
    loadLatest();
  });

  templateButtons.forEach((button) => {
    button.addEventListener('click', () => {
      const text = button.getAttribute('data-template-text') || '';
      if (input) {
        input.value = text;
        input.focus();
      }
    });
  });

  chatList?.addEventListener('click', (event) => {
    const target = event.target.closest('[data-chat-retry]');
    if (!target) return;
    const messageId = target.getAttribute('data-chat-retry');
    if (messageId) {
      retryMessage(messageId);
    }
  });

  form?.addEventListener('submit', async (event) => {
    event.preventDefault();
    if (!input) return;
    const text = (input.value || '').trim();
    if (!text) {
      setStatus('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'warning');
      return;
    }
    try {
      await sendMessage(text);
      input.value = '';
      setStatus('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
      setTimeout(() => setStatus(''), 1500);
    } catch (err) {
      setStatus(err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å', 'danger');
    }
  });

  loadLatest();
  pollTimer = window.setInterval(loadLatest, 5000);

  window.addEventListener('beforeunload', () => {
    if (pollTimer) {
      window.clearInterval(pollTimer);
    }
  });
})();
</script>

<script>
(function(){
  const slotControls = document.querySelector('[data-slot-controls]');
  if (!slotControls) return;
  const slotId = slotControls.dataset.slotId;
  if (!slotId) return;
  const toggleBtn = slotControls.querySelector('[data-slot-toggle]');
  const panel = slotControls.querySelector('[data-slot-panel]');
  const messageEl = slotControls.querySelector('[data-slot-message]');
  const outcomeStatusEl = slotControls.querySelector('[data-slot-outcome-status]');
  const nextTime = document.querySelector('.candidate-next__time');
  const nextMeta = document.querySelector('.candidate-next__meta');
  const emptyMetaText = '–ù–∞–∑–Ω–∞—á—å—Ç–µ –∏–Ω—Ç–µ—Ä–≤—å—é –∏–ª–∏ —Ç–µ—Å—Ç, —á—Ç–æ–±—ã –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥.';
  const csrfToken = window.__CSRF_TOKEN__ || document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
  const slotStatus = (slotControls.dataset.slotStatus || '').toLowerCase();
  const slotHasCandidate = slotControls.dataset.slotHasCandidate !== '0';
  const actionableStatuses = new Set(['pending', 'booked', 'confirmed_by_candidate']);
  const slotEligible = slotHasCandidate && actionableStatuses.has(slotStatus);

  const setMessage = (el, text, tone = 'muted') => {
    if (!el) { return; }
    el.textContent = text || '';
    if (tone) {
      el.dataset.tone = tone;
    } else {
      el.removeAttribute('data-tone');
    }
  };

  const disableButtons = (selector, disabled) => {
    slotControls.querySelectorAll(selector).forEach(btn => {
      btn.disabled = disabled;
    });
  };

  const closePanel = () => {
    if (!panel) { return; }
    panel.setAttribute('hidden', '');
    slotControls.classList.remove('is-open');
    if (toggleBtn) {
      toggleBtn.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç';
    }
  };

  const lockPanel = (message, tone = 'warning') => {
    closePanel();
    slotControls.classList.add('is-disabled');
    disableButtons('[data-slot-action]', true);
    disableButtons('[data-slot-outcome]', true);
    if (toggleBtn) {
      toggleBtn.disabled = true;
    }
    setMessage(messageEl, message || '', tone);
  };

  toggleBtn?.addEventListener('click', () => {
    if (!panel) return;
    const isHidden = panel.hasAttribute('hidden');
    if (isHidden) {
      panel.removeAttribute('hidden');
      slotControls.classList.add('is-open');
      toggleBtn.textContent = '–°–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å';
    } else {
      closePanel();
    }
  });

  async function postSlotAction(path) {
    const response = await fetch(`/slots/${slotId}/${path}`, {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'X-CSRFToken': csrfToken,
      },
    });
    const payload = await response.json().catch(() => null);
    if (!response.ok || !payload || payload.ok === false) {
      const message = payload && payload.message ? payload.message : '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ.';
      const error = new Error(message);
      error.status = response.status;
      throw error;
    }
    return payload;
  }

  async function postOutcome(outcome) {
    const response = await fetch(`/slots/${slotId}/outcome`, {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
      },
      body: JSON.stringify({ outcome }),
    });
    const payload = await response.json().catch(() => null);
    if (!response.ok || !payload || payload.ok === false) {
      const message = payload && payload.message ? payload.message : '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∏—Å—Ö–æ–¥.';
      const error = new Error(message);
      error.status = response.status;
      throw error;
    }
    return payload;
  }

  const markSlotAsInactive = (message, tone = 'success') => {
    lockPanel(message, tone);
    if (nextTime) {
      nextTime.textContent = '–ù–µ—Ç –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ';
    }
    if (nextMeta) {
      nextMeta.textContent = emptyMetaText;
    }
  };

  if (!slotEligible) {
    const warningText = slotHasCandidate
      ? '–°–ª–æ—Ç –≤ —ç—Ç–æ–º —Å—Ç–∞—Ç—É—Å–µ –Ω–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.'
      : '–°–ª–æ—Ç –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∫–∞–Ω–¥–∏–¥–∞—Ç—É.';
    lockPanel(warningText, slotHasCandidate ? 'warning' : 'error');
    return;
  }

  slotControls.addEventListener('click', async (event) => {
    const actionBtn = event.target.closest('[data-slot-action]');
    if (!actionBtn || actionBtn.disabled) return;
    const action = actionBtn.dataset.slotAction;
    if (!action) return;
    actionBtn.disabled = true;
    setMessage(messageEl, '–í—ã–ø–æ–ª–Ω—è–µ–º‚Ä¶');
    try {
      const payload = await postSlotAction(action === 'reschedule' ? 'reschedule' : 'reject_booking');
      markSlotAsInactive(payload.message || '–°–ª–æ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω.');
    } catch (err) {
      console.error(err);
      setMessage(messageEl, err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å–ª–æ—Ç.', 'error');
      if (err && err.status === 404) {
        markSlotAsInactive(err.message || '–°–ª–æ—Ç –±–æ–ª—å—à–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.', 'warning');
        return;
      }
      actionBtn.disabled = false;
    }
  });

  slotControls.addEventListener('click', async (event) => {
    const outcomeBtn = event.target.closest('[data-slot-outcome]');
    if (!outcomeBtn || outcomeBtn.disabled) return;
    const outcome = outcomeBtn.dataset.slotOutcome;
    if (!outcome) return;
    outcomeBtn.disabled = true;
    disableButtons('[data-slot-outcome]', true);
    setMessage(outcomeStatusEl, '–û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ö–æ–¥‚Ä¶');
    let unlockOutcomes = true;
    try {
      const payload = await postOutcome(outcome);
      setMessage(outcomeStatusEl, payload.message || '–ò—Å—Ö–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω.', 'success');
    } catch (err) {
      console.error(err);
      setMessage(outcomeStatusEl, err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∏—Å—Ö–æ–¥.', 'error');
      if (err && err.status === 404) {
        markSlotAsInactive(err.message || '–°–ª–æ—Ç –±–æ–ª—å—à–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.', 'warning');
        unlockOutcomes = false;
      }
    } finally {
      if (unlockOutcomes) {
        disableButtons('[data-slot-outcome]', false);
      }
    }
  });
})();
</script>
{# –°–æ–æ–±—â–µ–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç—É –∏ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—è —Å–∫—Ä—ã—Ç—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É #}
{% endblock %}
