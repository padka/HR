{% extends "base.html" %}
{% block title %}{{ user.fio }}{% endblock %}
{% block content %}
  {% set query_status = request.query_params.get('status') %}
  {% set query_notice = request.query_params.get('notice') %}
  {% if query_status %}
    {% set tone = {'success': 'success', 'error': 'danger', 'info': 'info'}.get(query_status, 'info') %}
    {% set default_notice = 'Тест 2 отправлен' if query_status == 'success' else ('Операция выполнена' if query_status == 'info' else 'Не удалось выполнить действие') %}
    <div class="surface glass grain alert" data-tone="{{ tone }}" role="alert">
      <p>{{ query_notice or default_notice }}</p>
    </div>
  {% endif %}

  <section class="page-header">
    <div>
      <a class="muted" href="/candidates">← К списку кандидатов</a>
      <h1 class="page-title">{{ user.fio }}</h1>
      <p class="page-description">Telegram ID {{ user.telegram_id }}{% if user.city %} · {{ user.city }}{% endif %}</p>
    </div>
  </section>

  <div class="page-grid" data-page="candidate" aria-labelledby="candidate-summary">
    <div class="page-main">
      <section class="surface" aria-labelledby="candidate-summary">
        <header class="flex flex-col gap-2">
          <h2 id="candidate-summary" class="section-title">Сводка</h2>
        </header>
        <div class="grid gap-4 md:grid-cols-3">
          <div>
            <h3 class="muted text-sm">Статус</h3>
            <p>
              {% if user.is_active %}
                <span class="badge badge--success">Активен</span>
              {% else %}
                <span class="badge badge--muted">Отключен</span>
              {% endif %}
            </p>
          </div>
          <div>
            <h3 class="muted text-sm">Город</h3>
            <p>{{ user.city or 'Город не указан' }}</p>
          </div>
          <div>
            <h3 class="muted text-sm">Последняя активность</h3>
            <p>
              {% if user.last_activity %}
                {{ fmt_local(user.last_activity, 'Europe/Moscow') }}
              {% else %}
                —
              {% endif %}
            </p>
          </div>
          <div>
            <h3 class="muted text-sm">Всего тестов</h3>
            <p>{{ stats.tests_total }}</p>
          </div>
          <div>
            <h3 class="muted text-sm">Средний балл</h3>
            <p>{{ '%.1f'|format(stats.average_score) if stats.average_score is not none else '—' }}</p>
          </div>
          <div>
            <h3 class="muted text-sm">Текущий этап</h3>
            <p>{{ stage }}</p>
          </div>
        </div>
        {% if test_stage_summary %}
          <div class="mt-4">
            <h3 class="muted text-sm">Этапы тестов</h3>
            <ul class="stage-flow" role="list">
              {% for item in test_stage_summary %}
                <li>
                  <strong>{{ item.label }}</strong>
                  — {{ item.score }}{% if item.rating %} ({{ item.rating }}){% endif %}
                  {% if item.dt %}
                    — {{ fmt_local(item.dt, 'Europe/Moscow') }}
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      </section>

      <section class="surface" aria-labelledby="interview-title">
        <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div>
            <h2 id="interview-title" class="section-title">Интервью</h2>
            {% if latest_interview and latest_interview.start_utc %}
              <p class="muted text-sm">{{ fmt_local(latest_interview.start_utc, latest_interview.candidate_tz or 'Europe/Moscow') }}</p>
            {% else %}
              <p class="muted text-sm">Интервью пока не запланировано.</p>
            {% endif %}
          </div>
          {% if latest_interview and latest_interview.recruiter and latest_interview.recruiter.telemost_url %}
            <a class="btn btn-primary btn-sm" href="{{ latest_interview.recruiter.telemost_url }}" target="_blank" rel="noopener">Перейти в конференцию</a>
          {% endif %}
        </header>

        {% if latest_interview %}
          <div class="flex flex-wrap gap-3 mt-4">
            <form method="post" action="/candidates/{{ user.id }}/slots/{{ latest_interview.id }}/outcome">
              <input type="hidden" name="outcome" value="success">
              <button class="btn btn-primary btn-sm" type="submit">Прошёл</button>
            </form>
            <form method="post" action="/candidates/{{ user.id }}/slots/{{ latest_interview.id }}/outcome">
              <input type="hidden" name="outcome" value="reject">
              <button class="btn btn--danger btn-sm" type="submit">Не прошёл</button>
            </form>
          </div>

          <form class="mt-6 flex flex-col gap-4" method="post" action="/candidates/{{ user.id }}/interview-feedback">
            <input type="hidden" name="slot_id" value="{{ latest_interview.id }}">
            <fieldset class="flex flex-col gap-3">
              <legend class="section-title text-base">Сценарий интервью</legend>
              {% for step in interview_script %}
                {% set is_checked = False %}
                {% if interview_feedback.checklist %}
                  {% set stored = interview_feedback.checklist.get(step.id) %}
                  {% if stored is not none %}
                    {% set is_checked = stored %}
                  {% else %}
                    {% set as_string = interview_feedback.checklist.get(step.id|string) %}
                    {% if as_string is not none %}{% set is_checked = as_string %}{% endif %}
                  {% endif %}
                {% endif %}
                <label class="panel panel--flush">
                  <div class="flex items-start gap-3">
                    <input id="interview-step-{{ step.id }}" name="checklist[]" value="{{ step.id }}" type="checkbox" {% if is_checked %}checked{% endif %}>
                    <div>
                      <span class="font-semibold">{{ step.title }}</span>
                      <p class="muted text-sm">{{ step.description }}</p>
                    </div>
                  </div>
                </label>
              {% endfor %}
            </fieldset>
            <label class="flex flex-col gap-2">
              <span class="section-title text-base">Заметки</span>
              <textarea class="textarea" name="notes" placeholder="Что важно запомнить для следующего этапа?">{{ interview_feedback.notes or '' }}</textarea>
            </label>
            <div class="flex items-center justify-between text-sm muted">
              {% if interview_feedback.updated_at %}
                <span>Обновлено {{ interview_feedback.updated_at }}</span>
              {% endif %}
              <button class="btn btn-soft btn-sm" type="submit">Сохранить</button>
            </div>
          </form>
        {% endif %}
      </section>

      <section class="surface" aria-labelledby="tests-title">
        <header class="flex items-center justify-between">
          <h2 id="tests-title" class="section-title">Результаты тестов</h2>
          <span class="muted text-sm">{{ stats.tests_total }} попыток</span>
        </header>
        {% if tests %}
          <div class="table__wrap mt-4">
            <table class="table list-table">
              <thead>
                <tr>
                  <th scope="col">Дата</th>
                  <th scope="col">Баллы</th>
                  <th scope="col">Рейтинг</th>
                  <th scope="col">Время (сек)</th>
                  <th scope="col">Ответы</th>
                </tr>
              </thead>
              <tbody>
                {% for result in tests %}
                  {% set answers = answers_map.get(result.id) %}
                  <tr>
                    <td data-label="Дата">{{ fmt_local(result.created_at, 'Europe/Moscow') }}</td>
                    <td data-label="Баллы">{{ result.final_score }} / {{ result.raw_score }}</td>
                    <td data-label="Рейтинг">{{ result.rating or '—' }}</td>
                    <td data-label="Время">{{ result.total_time }}</td>
                    <td data-label="Ответы">
                      {% if answers %}
                        <button
                          type="button"
                          class="btn btn-soft btn-sm"
                          data-answer-modal-target="answers-{{ result.id }}"
                          aria-haspopup="dialog"
                          aria-controls="answers-{{ result.id }}"
                        >
                          Посмотреть ответы
                        </button>
                      {% else %}
                        <span class="muted">—</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          {% for result in tests %}
            {% set answers = answers_map.get(result.id) %}
            {% if answers %}
              <div class="modal" id="answers-{{ result.id }}" data-answer-modal hidden>
                <div
                  class="modal__dialog"
                  role="dialog"
                  aria-modal="true"
                  aria-labelledby="answers-title-{{ result.id }}"
                  aria-describedby="answers-description-{{ result.id }}"
                  tabindex="-1"
                >
                  <div class="flex items-start justify-between gap-3">
                    <div>
                      <h3 id="answers-title-{{ result.id }}" class="section-title">Ответы теста от {{ fmt_local(result.created_at, 'Europe/Moscow') }}</h3>
                      <p id="answers-description-{{ result.id }}" class="muted text-sm">
                        Правильных: {{ answers.questions_correct }} из {{ answers.questions_total }}{% if answers.questions_overtime %}, просрочено: {{ answers.questions_overtime }}{% endif %}
                      </p>
                    </div>
                    <button type="button" class="btn btn-ghost btn-sm" data-answer-modal-close aria-label="Закрыть">Закрыть</button>
                  </div>
                  <div class="modal__body" tabindex="0">
                    <ol class="flex flex-col gap-4" role="list">
                      {% for answer in answers.questions %}
                        <li class="flex flex-col gap-2">
                          <div class="flex flex-wrap items-center gap-2">
                            <span class="font-semibold">Вопрос {{ loop.index }}: {{ answer.question_text }}</span>
                            {% if answer.is_correct %}
                              <span class="badge badge--success">Верно</span>
                            {% else %}
                              <span class="badge badge--muted">Неверно</span>
                            {% endif %}
                            {% if answer.overtime %}
                              <span class="badge badge--soft">Просрочено</span>
                            {% endif %}
                          </div>
                          <p>Ответ кандидата: <strong>{{ answer.user_answer or '—' }}</strong></p>
                          {% if not answer.is_correct and answer.correct_answer %}
                            <p>Правильный ответ: <strong>{{ answer.correct_answer }}</strong></p>
                          {% endif %}
                          <p class="muted text-sm">Время: {{ answer.time_spent }} сек · Попытки: {{ answer.attempts_count }}</p>
                        </li>
                      {% endfor %}
                    </ol>
                  </div>
                  <div class="flex justify-end">
                    <button type="button" class="btn btn-soft btn-sm" data-answer-modal-close>Закрыть</button>
                  </div>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        {% else %}
          <p class="muted mt-4">Кандидат ещё не проходил тесты.</p>
        {% endif %}
      </section>

      {% if latest_interview and latest_interview.interview_outcome == 'success' and test2_completed %}
        <section class="surface" aria-labelledby="intro-day-title">
          <header>
            <h2 id="intro-day-title" class="section-title">Ознакомительный день</h2>
            <p class="muted text-sm">Отправьте кандидату приглашение с датой и временем.</p>
          </header>
          <form class="mt-4 flex flex-col gap-4" method="post" action="/candidates/{{ user.id }}/intro-day">
            <div class="grid gap-4 md:grid-cols-2">
              <label class="flex flex-col gap-2">
                <span class="muted text-sm">Дата</span>
                <input class="input" type="date" name="date_value" required>
              </label>
              <label class="flex flex-col gap-2">
                <span class="muted text-sm">Время</span>
                <input class="input" type="time" name="time_value" required>
              </label>
            </div>
            <label class="flex flex-col gap-2">
              <span class="muted text-sm">Сообщение кандидату</span>
              <textarea class="textarea" name="message_text" placeholder="{{ intro_message_template|format(fio=user.fio, date='дд.мм.гггг', time='чч:мм') }}"></textarea>
            </label>
            <div class="flex justify-end">
              <button class="btn btn-primary btn-sm" type="submit">Отправить приглашение</button>
            </div>
          </form>
        </section>
      {% endif %}
    </div>

    <aside class="page-aside" id="history">
      <section class="surface" aria-labelledby="history-title">
        <header>
          <h2 id="history-title" class="section-title">История событий</h2>
        </header>
        {% if timeline %}
          <ol class="flex flex-col gap-3 text-sm" role="list">
            {% for event in timeline %}
              <li class="panel panel--flush">
                <div class="flex items-center justify-between muted text-xs uppercase tracking-wide">
                  <span>
                    {% if event.kind == 'slot' %}
                      Интервью
                    {% elif event.kind == 'test' %}
                      Тест
                    {% elif event.kind == 'message' %}
                      Сообщение
                    {% else %}
                      Событие
                    {% endif %}
                  </span>
                  <time datetime="{{ event.dt.isoformat() if event.dt }}">{{ fmt_local(event.dt, event.tz or 'Europe/Moscow') if event.dt else '—' }}</time>
                </div>
                <div class="mt-2 space-y-1">
                  {% if event.kind == 'slot' %}
                    <p>Статус: {{ (event.status or '')|upper }}</p>
                    {% if event.recruiter %}<p>Рекрутёр: {{ event.recruiter }}</p>{% endif %}
                    {% if event.city %}<p>Город: {{ event.city }}</p>{% endif %}
                  {% elif event.kind == 'test' %}
                    <p>Баллы: {{ event.score }} ({{ event.rating or '—' }})</p>
                  {% elif event.kind == 'message' %}
                    <p class="whitespace-pre-line">{{ event.text }}</p>
                    {% if event.send_time %}<p class="muted text-xs">Запланировано: {{ event.send_time }}</p>{% endif %}
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          </ol>
        {% else %}
          <p class="muted text-sm mt-4">История пока пуста.</p>
        {% endif %}
      </section>
    </aside>
  </div>
{% endblock %}

{% block extra_js %}
  <script>
    (function () {
      const triggers = document.querySelectorAll('[data-answer-modal-target]');
      const modals = new Map();
      let activeModal = null;
      let lastTrigger = null;

      document.querySelectorAll('[data-answer-modal]').forEach((modal) => {
        const id = modal.id;
        if (!id) {
          return;
        }
        modals.set(id, modal);
        const dialog = modal.querySelector('[role="dialog"]');
        modal.addEventListener('click', (event) => {
          if (event.target === modal) {
            closeModal(modal);
          }
        });
        modal.querySelectorAll('[data-answer-modal-close]').forEach((btn) => {
          btn.addEventListener('click', () => closeModal(modal));
        });
        modal.addEventListener('keydown', (event) => {
          if (event.key === 'Escape') {
            event.preventDefault();
            closeModal(modal);
          }
        });
        if (dialog) {
          dialog.addEventListener('click', (event) => {
            event.stopPropagation();
          });
        }
      });

      function openModal(modal, trigger) {
        activeModal = modal;
        lastTrigger = trigger;
        modal.removeAttribute('hidden');
        const dialog = modal.querySelector('[role="dialog"]');
        if (dialog) {
          dialog.focus();
        }
        document.body.style.overflow = 'hidden';
      }

      function closeModal(modal) {
        modal.setAttribute('hidden', '');
        if (activeModal === modal) {
          activeModal = null;
        }
        if (lastTrigger) {
          lastTrigger.focus();
        }
        if (!document.querySelector('[data-answer-modal]:not([hidden])')) {
          document.body.style.overflow = '';
        }
      }

      triggers.forEach((trigger) => {
        trigger.addEventListener('click', () => {
          const targetId = trigger.getAttribute('data-answer-modal-target');
          if (!targetId) {
            return;
          }
          const modal = modals.get(targetId);
          if (!modal) {
            return;
          }
          openModal(modal, trigger);
        });
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && activeModal) {
          event.preventDefault();
          closeModal(activeModal);
        }
      });
    })();
  </script>
{% endblock %}
