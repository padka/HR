{% extends "base.html" %}
{% from "page_primitives.html" import page_header, metric_grid, table_shell, toast, form_section, empty_state %}
{% block title %}{{ user.fio }}{% endblock %}
{% block content %}
  {% set query_status = request.query_params.get('status') %}
  {% set query_notice = request.query_params.get('notice') %}
  {% if query_status %}
    {% set tone = {'success': 'success', 'error': 'danger', 'info': 'info'}.get(query_status, 'info') %}
    {% set default_notice = 'Тест 2 отправлен' if query_status == 'success' else ('Операция выполнена' if query_status == 'info' else 'Не удалось выполнить действие') %}
    {{ toast(query_notice or default_notice, tone=tone, dismissible=True) }}
  {% endif %}

  {% set breadcrumbs = [
    {'label': 'Кандидаты', 'url': '/candidates'},
    {'label': user.fio}
  ] %}
  {% set summary_badges = [
    {'tone': 'success' if user.is_active else 'muted', 'label': 'Статус: ' ~ ('Активен' if user.is_active else 'Отключен')},
    {'tone': 'info', 'label': 'Этап: ' ~ stage},
    {'tone': 'soft', 'label': 'Тестов: ' ~ stats.tests_total}
  ] %}
  {% set header_meta = 'Последняя активность: ' ~ (fmt_local(user.last_activity, 'Europe/Moscow') if user.last_activity else '—') %}

  {% call page_header(
    title=user.fio,
    eyebrow='Кандидат',
    description='Telegram ID ' ~ user.telegram_id ~ ((' · ' ~ user.city) if user.city else ''),
    meta=header_meta,
    badges=summary_badges,
    trail=breadcrumbs
  ) %}
    <div class="header-actions">
      <a class="btn btn-ghost btn-sm" href="/candidates">Назад к списку</a>
    </div>
  {% endcall %}

  {% set summary_cards = [
    {'label': 'Всего тестов', 'value': stats.tests_total, 'meta': 'Средний балл: ' ~ ('%.1f'|format(stats.average_score) if stats.average_score is not none else '—')},
    {'label': 'Последнее интервью', 'value': fmt_local(latest_interview.start_utc, latest_interview.candidate_tz or 'Europe/Moscow') if latest_interview and latest_interview.start_utc else 'Не назначено', 'meta': latest_interview.recruiter.name if latest_interview and latest_interview.recruiter else ''},
    {'label': 'Сообщений за всё время', 'value': timeline|length, 'meta': 'История событий'}
  ] %}
  {{ metric_grid(items=summary_cards, class_name='metrics-overview') }}

  <div class="page-columns" id="candidate-summary" aria-live="polite">
    <div class="page-columns__main">
      <section class="surface panel" aria-labelledby="interview-title">
        <header class="panel__header">
          <div>
            <h2 id="interview-title" class="section-title">Интервью</h2>
            {% if latest_interview and latest_interview.start_utc %}
              <p class="muted">{{ fmt_local(latest_interview.start_utc, latest_interview.candidate_tz or 'Europe/Moscow') }}</p>
            {% else %}
              <p class="muted">Интервью пока не запланировано.</p>
            {% endif %}
          </div>
          {% if latest_interview and latest_interview.recruiter and latest_interview.recruiter.telemost_url %}
            <a class="btn btn-primary btn-sm" href="{{ latest_interview.recruiter.telemost_url }}" target="_blank" rel="noopener">Перейти в конференцию</a>
          {% endif %}
        </header>

        {% if latest_interview %}
          <div class="panel__actions">
            <form class="inline-form" method="post" action="/candidates/{{ user.id }}/slots/{{ latest_interview.id }}/outcome">
              <input type="hidden" name="outcome" value="success">
              <button class="btn btn-primary btn-sm" type="submit" data-outcome-button data-outcome="success">Прошёл</button>
            </form>
            <form class="inline-form" method="post" action="/candidates/{{ user.id }}/slots/{{ latest_interview.id }}/outcome">
              <input type="hidden" name="outcome" value="reject">
              <button class="btn btn-danger btn-sm" type="submit" data-outcome-button data-outcome="reject">Не прошёл</button>
            </form>
          </div>

          {% set raw_checklist = interview_feedback.checklist %}
          {% if raw_checklist is mapping %}
            {% set checklist_map = raw_checklist %}
            {% set checklist_list = [] %}
          {% elif raw_checklist %}
            {% set checklist_map = {} %}
            {% set checklist_list = raw_checklist %}
          {% else %}
            {% set checklist_map = {} %}
            {% set checklist_list = [] %}
          {% endif %}
          {% set checklist_ids = namespace(ids=[]) %}
          {% if checklist_map %}
            {% for key, value in checklist_map.items() %}
              {% if value %}
                {% set checklist_ids.ids = checklist_ids.ids + [key|string] %}
              {% endif %}
            {% endfor %}
          {% elif checklist_list %}
            {% for value in checklist_list %}
              {% set checklist_ids.ids = checklist_ids.ids + [value|string] %}
            {% endfor %}
          {% endif %}
          {% set total_steps = interview_script|length %}
          {% set checked_count = checklist_ids.ids|length %}

          <form class="interview-script" method="post" action="/candidates/{{ user.id }}/interview-feedback" data-interview-form>
            <input type="hidden" name="slot_id" value="{{ latest_interview.id }}">
            <div class="interview-script__header">
              <h3 class="section-title">Сценарий интервью</h3>
              <span class="pill pill--soft">Прогресс: <strong data-interview-progress>{{ checked_count }}/{{ total_steps }}</strong></span>
            </div>
            <div class="interview-script__list">
              {% for step in interview_script %}
                {% set is_checked = step.id|string in checklist_ids.ids %}
                <label class="interview-step surface{% if is_checked %} is-complete{% endif %}">
                  <span class="interview-step__checkbox">
                    <input id="interview-step-{{ step.id }}" name="checklist[]" value="{{ step.id }}" type="checkbox" {% if is_checked %}checked{% endif %}>
                  </span>
                  <div class="interview-step__body">
                    <span class="interview-step__title">{{ step.title }}</span>
                    <p class="muted">{{ step.description }}</p>
                  </div>
                </label>
              {% endfor %}
            </div>
            <label class="form-field">
              <span class="form-field__label">Заметки</span>
              <textarea class="textarea" name="notes" placeholder="Что важно отметить?" rows="4">{{ interview_feedback.notes or '' }}</textarea>
            </label>
            <div class="form-footer">
              {% if interview_feedback.updated_at %}
                <span class="muted">Обновлено {{ interview_feedback.updated_at }}</span>
              {% endif %}
              <button class="btn btn-soft btn-sm" type="submit">Сохранить</button>
            </div>
          </form>
        {% endif %}
      </section>

      <section class="surface panel" aria-labelledby="tests-title">
        <header class="panel__header">
          <h2 id="tests-title" class="section-title">Результаты тестов</h2>
          <span class="muted">{{ stats.tests_total }} попыток</span>
        </header>
        {% if tests %}
          {% set columns = [
            {'label': 'Дата'},
            {'label': 'Баллы'},
            {'label': 'Рейтинг'},
            {'label': 'Время (сек)'},
            {'label': 'Ответы', 'class': 'col-actions'}
          ] %}
          {% call table_shell(columns=columns, caption='Результаты тестов кандидата', table_id='candidate-tests') %}
            {% for result in tests %}
              {% set answers = answers_map.get(result.id) %}
              <tr>
                <td data-label="Дата">{{ fmt_local(result.created_at, 'Europe/Moscow') }}</td>
                <td data-label="Баллы">{{ result.final_score }} / {{ result.raw_score }}</td>
                <td data-label="Рейтинг">{{ result.rating or '—' }}</td>
                <td data-label="Время">{{ result.total_time }}</td>
                <td data-label="Ответы" class="table-actions">
                  {% if answers %}
                    {% set payload = {
                      'title': 'Ответы теста от ' ~ fmt_local(result.created_at, 'Europe/Moscow'),
                      'stats': {
                        'total': answers.questions_total,
                        'correct': answers.questions_correct,
                        'overtime': answers.questions_overtime
                      },
                      'questions': answers.questions
                    } %}
                    <button
                      type="button"
                      class="btn btn-soft btn-sm"
                      data-answer-modal-trigger
                      data-answer-modal-payload='{{ payload | tojson }}'
                      aria-haspopup="dialog"
                    >
                      Посмотреть ответы
                    </button>
                  {% else %}
                    <span class="muted">—</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% endcall %}
        {% else %}
          <p class="muted">Кандидат ещё не проходил тесты.</p>
        {% endif %}
      </section>

      {% if latest_interview and latest_interview.interview_outcome == 'success' and test2_completed %}
        <section class="surface panel" aria-labelledby="intro-day-title">
          <header class="panel__header">
            <div>
              <h2 id="intro-day-title" class="section-title">Ознакомительный день</h2>
              <p class="muted">Пригласите кандидата на ознакомительный день.</p>
            </div>
          </header>
          <form class="form-grid" method="post" action="/candidates/{{ user.id }}/intro-day">
            <div class="grid-cols">
              <label class="form-field">
                <span class="form-field__label">Дата</span>
                <input class="input" type="date" name="date_value" required>
              </label>
              <label class="form-field">
                <span class="form-field__label">Время</span>
                <input class="input" type="time" name="time_value" required>
              </label>
            </div>
            <label class="form-field">
              <span class="form-field__label">Сообщение кандидату</span>
              <textarea class="textarea" name="message_text" placeholder="{{ intro_message_template|format(fio=user.fio, date='дд.мм.гггг', time='чч:мм') }}" rows="3"></textarea>
            </label>
            <div class="form-footer">
              <button class="btn btn-primary btn-sm" type="submit">Отправить приглашение</button>
            </div>
          </form>
        </section>
      {% endif %}
    </div>

    <aside class="page-columns__aside" id="history">
      <section class="surface panel" aria-labelledby="history-title">
        <header class="panel__header">
          <h2 id="history-title" class="section-title">История событий</h2>
        </header>
        {% if timeline %}
          <ol class="timeline" role="list">
            {% for event in timeline %}
              <li class="timeline__item">
                <div class="timeline__meta">
                  <span class="timeline__kind">
                    {% if event.kind == 'slot' %}
                      Интервью
                    {% elif event.kind == 'test' %}
                      Тест
                    {% elif event.kind == 'message' %}
                      Сообщение
                    {% else %}
                      Событие
                    {% endif %}
                  </span>
                  <time datetime="{{ event.dt.isoformat() if event.dt }}">{{ fmt_local(event.dt, event.tz or 'Europe/Moscow') if event.dt else '—' }}</time>
                </div>
                <div class="timeline__body">
                  {% if event.kind == 'slot' %}
                    <p>Статус: {{ (event.status or '')|upper }}</p>
                    {% if event.recruiter %}<p>Рекрутёр: {{ event.recruiter }}</p>{% endif %}
                    {% if event.city %}<p>Город: {{ event.city }}</p>{% endif %}
                  {% elif event.kind == 'test' %}
                    <p>Баллы: {{ event.score }}{% if event.rating %} ({{ event.rating }}){% endif %}</p>
                  {% elif event.kind == 'message' %}
                    <p class="whitespace-pre-line">{{ event.text }}</p>
                    {% if event.send_time %}<p class="muted text-xs">Запланировано: {{ event.send_time }}</p>{% endif %}
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          </ol>
        {% else %}
          <p class="muted">История пока пуста.</p>
        {% endif %}
      </section>
    </aside>
  </div>

  <div class="modal" data-answer-modal hidden>
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="answers-modal-title" aria-describedby="answers-modal-description" tabindex="-1">
      <div class="modal__header">
        <div>
          <h3 id="answers-modal-title" class="section-title" data-answer-modal-title>Ответы теста</h3>
          <p id="answers-modal-description" class="muted" data-answer-modal-meta></p>
        </div>
        <button type="button" class="btn btn-ghost btn-sm" data-answer-modal-close aria-label="Закрыть">Закрыть</button>
      </div>
      <div class="modal__body" data-answer-modal-body></div>
      <div class="modal__footer">
        <button type="button" class="btn btn-soft btn-sm" data-answer-modal-close>Закрыть</button>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  {{ super() }}
  <script type="module" src="/static/js/modules/answers-modal.js"></script>
  <script type="module" src="/static/js/modules/candidate-profile.js"></script>
{% endblock %}
