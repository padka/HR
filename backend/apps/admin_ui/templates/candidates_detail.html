{% extends "base.html" %}
{% block title %}–ö–∞–Ω–¥–∏–¥–∞—Ç {{ user.fio }}{% endblock %}
{% block content %}
<script nonce="{{ request.state.csp_nonce }}">
  document.body.dataset.page = 'candidates-detail';
</script>
<style>
  /* Candidate profile shell ‚Äî calm, decision-first */
  .profile-shell {
    margin: 28px 0;
    display: flex;
    flex-direction: column;
    gap: 18px;
  }

  .profile-header {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 14px 18px;
    align-items: center;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 10px;
    border-radius: 12px;
    color: var(--ink-soft);
    text-decoration: none;
    border: 1px solid var(--layer-border);
    background: var(--layer-panel);
    transition: all 0.2s ease;
  }

  .back-link:hover {
    color: var(--ink);
    border-color: color-mix(in srgb, var(--ink) 16%, var(--layer-border));
  }

  .profile-title h1 {
    margin: 0;
    font-size: clamp(22px, 3vw, 28px);
    font-weight: 700;
    letter-spacing: -0.01em;
  }

  .profile-title .eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--ink-soft);
    margin: 0 0 6px;
    font-size: 12px;
  }

  .profile-title .subtitle {
    margin: 4px 0 0;
    color: var(--ink-soft);
  }

  .status-chip {
    justify-self: end;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    border-radius: 999px;
    border: 1px solid var(--layer-border-strong);
    background: var(--layer-panel-strong);
    font-weight: 600;
    color: var(--ink);
  }

  .status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: color-mix(in srgb, var(--accent) 70%, var(--ok));
    box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 20%, transparent);
  }

  .profile-grid {
    display: grid;
    grid-template-columns: 2fr 1.1fr;
    gap: 16px;
  }

  .card {
    border-radius: 20px;
    border: 1px solid var(--layer-border);
    background: var(--layer-panel);
    box-shadow: var(--shadow-lg, 0 18px 50px rgba(15, 23, 42, 0.18));
    padding: 18px;
  }

  .card.glass {
    background: linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    backdrop-filter: blur(12px) saturate(140%);
    -webkit-backdrop-filter: blur(12px) saturate(140%);
    border-color: color-mix(in srgb, var(--layer-border) 70%, rgba(255,255,255,0.4));
  }

  .card-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 10px;
  }

  .card-head h3 {
    margin: 0;
    font-size: 18px;
    letter-spacing: -0.01em;
  }

  .card .eyebrow {
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 12px;
    color: var(--ink-soft);
  }

  .pill {
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid var(--layer-border);
    background: var(--layer-panel-strong);
    font-size: 12px;
  }

  .identity-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 12px;
  }

  .identity-item {
    padding: 12px;
    border-radius: 14px;
    border: 1px solid var(--layer-border);
    background: color-mix(in srgb, var(--layer-panel) 90%, transparent);
    display: grid;
    gap: 6px;
    min-height: 110px;
  }

  .identity-label {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--ink-soft);
    font-size: 12px;
  }

  .identity-value {
    font-family: var(--font-mono, 'SFMono-Regular', ui-monospace, monospace);
    font-size: 15px;
    word-break: break-word;
  }

  .inline-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
  }

  .action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    min-height: 44px;
    padding: 0 14px;
    border-radius: 12px;
    border: 1px solid var(--layer-border);
    background: var(--layer-panel-strong);
    color: var(--ink);
    text-decoration: none;
    transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease;
  }

  .action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 24px rgba(15, 23, 42, 0.18);
    background: color-mix(in srgb, var(--layer-panel-strong) 80%, var(--accent) 8%);
  }

  .action-btn--primary {
    background: color-mix(in srgb, var(--accent) 82%, var(--layer-panel) 18%);
    color: #0b1223;
    border-color: color-mix(in srgb, var(--accent) 70%, transparent);
    box-shadow: 0 12px 32px rgba(37, 99, 235, 0.2);
  }

  .action-btn--secondary {
    background: color-mix(in srgb, var(--layer-panel-strong) 92%, var(--accent) 8%);
  }

  .action-btn--ghost {
    background: transparent;
    border-color: var(--layer-border);
    color: var(--ink-soft);
  }

  .action-btn--danger {
    background: color-mix(in srgb, var(--bad) 18%, var(--layer-panel));
    border-color: color-mix(in srgb, var(--bad) 40%, var(--layer-border));
    color: color-mix(in srgb, var(--ink) 80%, var(--bad));
  }

  .status-control {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 10px;
    align-items: center;
  }

  .status-select {
    width: 100%;
    border-radius: 12px;
    border: 1px solid var(--layer-border);
    background: var(--layer-panel-strong);
    padding: 10px 12px;
    font-size: 14px;
  }

  .status-meta {
    color: var(--ink-soft);
    margin: 6px 0 0;
  }

  .action-btn[disabled] {
    opacity: 0.55;
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
  }

  .actions-card {
    display: grid;
    gap: 10px;
    align-content: start;
  }

  .action-grid {
    display: grid;
    gap: 8px;
  }

  .action-grid .action-btn,
  .action-row .action-btn {
    width: 100%;
  }

  .inline-actions .action-btn {
    width: auto;
  }

  .action-row {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
  }

  .action-error {
    margin: 0;
    color: color-mix(in srgb, var(--bad) 80%, var(--ink));
    font-size: 14px;
  }

  .profile-states {
    display: grid;
    gap: 8px;
  }

  .state-card {
    padding: 12px 14px;
    border-radius: 14px;
    border: 1px dashed var(--layer-border);
    background: var(--layer-panel);
    color: var(--ink);
  }

  .state-card--error {
    border-color: color-mix(in srgb, var(--bad) 50%, var(--layer-border));
    color: color-mix(in srgb, var(--bad) 80%, var(--ink));
  }

  .state-card--success {
    border-color: color-mix(in srgb, var(--ok) 50%, var(--layer-border));
    color: color-mix(in srgb, var(--ok) 80%, var(--ink));
  }

  .timeline-shell {
    border-radius: 16px;
    border: 1px solid var(--layer-border);
    background: var(--layer-panel);
    padding: 12px 14px;
    transition: all 0.2s ease;
  }

  .timeline-shell summary {
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    font-weight: 600;
    list-style: none;
  }

  .timeline-shell[open] {
    box-shadow: var(--shadow-md, 0 12px 28px rgba(15, 23, 42, 0.16));
  }

  .timeline-body {
    margin-top: 12px;
  }

  .timeline-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 12px;
  }

  .timeline-item {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 10px;
    align-items: center;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--layer-border);
    background: color-mix(in srgb, var(--layer-panel) 92%, transparent);
    animation: fadeUp 0.35s ease both;
  }

  .timeline-icon {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    display: grid;
    place-items: center;
    background: color-mix(in srgb, var(--layer-panel-strong) 90%, var(--accent) 10%);
    color: var(--ink);
  }

  .timeline-meta {
    color: var(--ink-soft);
    font-size: 13px;
  }

  .timeline-title {
    font-weight: 600;
    color: var(--ink);
  }

  .timeline-empty {
    color: var(--ink-soft);
    font-size: 14px;
    padding: 10px;
    border: 1px dashed var(--layer-border);
    border-radius: 12px;
  }

  .timeline-filters {
    display: flex;
    gap: 6px;
    margin-bottom: 12px;
    flex-wrap: wrap;
  }

  .timeline-filter-btn {
    padding: 6px 12px;
    border-radius: 8px;
    border: 1px solid var(--layer-border);
    background: var(--layer-panel);
    color: var(--ink-soft);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .timeline-filter-btn:hover {
    border-color: var(--accent);
    color: var(--ink);
  }

  .timeline-filter-btn[aria-pressed="true"] {
    background: color-mix(in srgb, var(--accent) 15%, var(--layer-panel));
    border-color: var(--accent);
    color: var(--ink);
  }

  .timeline-item[hidden] {
    display: none;
  }

  @keyframes fadeUp {
    from {
      opacity: 0;
      transform: translateY(6px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .quiet-link {
    color: var(--accent);
    text-decoration: none;
  }

  @media (max-width: 1024px) {
    .profile-header {
      grid-template-columns: 1fr auto;
      grid-template-areas:
        "back status"
        "title status";
    }
    .back-link { grid-area: back; }
    .profile-title { grid-area: title; }
    .status-chip { grid-area: status; justify-self: end; }
    .profile-grid { grid-template-columns: 1fr; }
    .actions-card .action-btn { width: 100%; }
  }

  @media (max-width: 640px) {
    .profile-header {
      grid-template-columns: 1fr;
      grid-template-areas:
        "back"
        "title"
        "status";
    }
    .status-chip { justify-self: start; }
    .timeline-item {
      grid-template-columns: auto 1fr;
      grid-template-rows: auto auto;
    }
    .timeline-item time { grid-column: 1 / -1; }
    .actions-card .action-row:nth-child(n+3) {
      display: none;
    }
  }

  /* Liquid Glass Variables */
  :root {
    --liquid-glass-bg: linear-gradient(135deg,
      rgba(255, 255, 255, 0.05) 0%,
      rgba(255, 255, 255, 0.02) 100%);
    --liquid-glass-bg-hover: linear-gradient(135deg,
      rgba(255, 255, 255, 0.09) 0%,
      rgba(255, 255, 255, 0.04) 100%);
    --liquid-glass-border: rgba(255, 255, 255, 0.08);
    --liquid-glass-highlight: linear-gradient(180deg,
      rgba(255, 255, 255, 0.12) 0%,
      rgba(255, 255, 255, 0) 50%);
    --liquid-glass-shadow:
      0 8px 32px 0 rgba(0, 0, 0, 0.25),
      inset 0 1px 2px 0 rgba(255, 255, 255, 0.05);
    --liquid-glass-shadow-hover:
      0 16px 48px 0 rgba(0, 0, 0, 0.35),
      inset 0 1px 2px 0 rgba(255, 255, 255, 0.08);
    --liquid-glass-blur: blur(40px);
    --detail-surface: var(--layer-panel-strong);
    --detail-surface-2: var(--layer-panel);
    --detail-veil: var(--layer-glass-weak);
    --detail-veil-strong: var(--layer-glass);
    --detail-border: var(--layer-border);
    --detail-border-strong: var(--layer-border-strong);
    --detail-shadow: var(--shadow-xl, 0 35px 60px rgba(15, 23, 42, 0.18));
    --detail-muted: var(--ink-soft);
    --detail-muted-strong: var(--ink-softer);
    --detail-hover: var(--interactive-hover);
  }

  html[data-theme="light"] {
    --liquid-glass-bg: linear-gradient(135deg,
      rgba(255, 255, 255, 0.6) 0%,
      rgba(255, 255, 255, 0.4) 100%);
    --liquid-glass-bg-hover: linear-gradient(135deg,
      rgba(255, 255, 255, 0.8) 0%,
      rgba(255, 255, 255, 0.55) 100%);
    --liquid-glass-border: rgba(255, 255, 255, 0.4);
    --liquid-glass-highlight: linear-gradient(180deg,
      rgba(255, 255, 255, 0.95) 0%,
      rgba(255, 255, 255, 0) 50%);
    --liquid-glass-shadow:
      0 8px 32px 0 rgba(31, 38, 135, 0.15),
      inset 0 1px 2px 0 rgba(255, 255, 255, 0.6);
    --liquid-glass-shadow-hover:
      0 16px 48px 0 rgba(31, 38, 135, 0.22),
      inset 0 1px 2px 0 rgba(255, 255, 255, 0.75);
    --liquid-glass-blur: blur(35px);
  }

  .btn-secondary {
    background: color-mix(in srgb, var(--accent) 12%, var(--detail-veil-strong));
    border-color: color-mix(in srgb, var(--accent) 38%, var(--detail-border-strong));
    color: color-mix(in srgb, var(--accent) 85%, var(--fg));
  }

  .btn-secondary:hover {
    background: color-mix(in srgb, var(--accent) 18%, var(--detail-veil-strong));
    border-color: color-mix(in srgb, var(--accent) 48%, var(--detail-border-strong));
  }

  html[data-theme="light"] .btn-secondary {
    background: color-mix(in srgb, var(--accent) 12%, #ffffff);
    border-color: color-mix(in srgb, var(--accent) 45%, rgba(15, 23, 42, 0.15));
    color: color-mix(in srgb, var(--accent) 90%, #111827);
    box-shadow: 0 8px 20px rgba(37, 99, 235, 0.12);
  }

  html[data-theme="light"] .btn-secondary:hover {
    background: color-mix(in srgb, var(--accent) 18%, #ffffff);
    border-color: color-mix(in srgb, var(--accent) 55%, rgba(15, 23, 42, 0.18));
    box-shadow: 0 12px 26px rgba(37, 99, 235, 0.18);
  }

  .candidate-overview {
    margin-top: 32px;
    padding: 32px;
    border-radius: 32px;
    background: linear-gradient(135deg, var(--detail-surface), var(--detail-surface-2));
    border: 1px solid var(--detail-border);
    box-shadow: var(--detail-shadow);
    display: grid;
    gap: 32px;
  }

  .candidate-actions {
    margin-top: 24px;
  }

  .candidate-actions__list {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
  }

  .candidate-actions__hint {
    margin-top: 12px;
    color: var(--danger, #dc2626);
  }

  .candidate-core {
    margin-top: 24px;
    padding: 24px;
    border-radius: 24px;
    background: linear-gradient(135deg, var(--detail-surface), var(--detail-surface-2));
    border: 1px solid var(--detail-border);
    box-shadow: var(--detail-shadow);
    display: grid;
    gap: 16px;
  }

  .candidate-core__header {
    display: flex;
    justify-content: space-between;
    gap: 12px;
    align-items: flex-start;
  }

  .candidate-core__eyebrow {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin: 0 0 6px;
  }

  .candidate-core__title {
    margin: 0;
    font-size: 24px;
    font-weight: 700;
  }

  .candidate-core__stage {
    margin: 4px 0 0;
    color: var(--text-muted);
  }

  .candidate-core__status {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .candidate-core__contacts {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 12px;
  }

  .candidate-core__contact {
    padding: 12px;
    border: 1px solid var(--detail-border);
    border-radius: 12px;
    background: var(--detail-veil);
    display: grid;
    gap: 6px;
  }

  .candidate-core__contact label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-muted);
  }

  .candidate-core__contact code {
    font-family: var(--font-mono);
  }

  .candidate-core__actions {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
  }

  .candidate-hero {
    display: flex;
    justify-content: space-between;
    gap: 32px;
    flex-wrap: wrap;
  }

  .candidate-hero__summary {
    flex: 1 1 320px;
    min-width: 280px;
  }

  .candidate-hero__eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.72rem;
    color: var(--muted);
    margin: 0 0 10px;
  }

  .candidate-hero__stage-wrap {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .candidate-hero__stage {
    font-size: 2rem;
    line-height: 1.2;
    margin: 0;
  }

  .candidate-hero__stage-pill {
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid var(--detail-border-strong);
    background: var(--detail-veil-strong);
  }

  .candidate-hero__meta {
    margin-top: 6px;
    color: var(--muted);
  }

  .candidate-hero__tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
  }

  .candidate-hero__tag {
    padding: 6px 14px;
    border-radius: 999px;
    border: 1px solid var(--detail-border);
    background: var(--detail-veil);
    font-size: 0.85rem;
  }

  .candidate-hero__chat {
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .candidate-hero__chat-note {
    font-size: 0.85rem;
    color: var(--muted);
    margin-left: 4px;
  }

  .telegram-panel {
    margin-top: 20px;
    padding: 18px 20px;
    border-radius: 20px;
    border: 1px solid var(--detail-border);
    background: var(--detail-veil);
    display: grid;
    gap: 14px;
  }

  .telegram-panel__eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.7rem;
    color: var(--muted);
  }

  .telegram-panel__title {
    font-size: 1.2rem;
    margin: 0;
  }

  .telegram-panel__meta {
    color: var(--muted);
    font-size: 0.85rem;
  }

  .telegram-panel__grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
  }

  .telegram-panel__item {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .telegram-panel__label {
    font-size: 0.8rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--muted);
  }

  .telegram-panel__value {
    display: inline-flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    font-family: var(--font-mono);
    font-size: 0.95rem;
  }

  .telegram-panel__value code {
    padding: 4px 8px;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.08);
  }

  html[data-theme="light"] .telegram-panel__value code {
    background: rgba(15, 23, 42, 0.08);
  }

  .telegram-panel__hint {
    font-size: 0.85rem;
    color: var(--muted);
  }

  .telegram-panel__actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }

  .telegram-panel__links {
    display: inline-flex;
    flex-direction: column;
    gap: 6px;
  }

  .telegram-panel__links a {
    color: var(--accent);
    text-decoration: none;
  }

  .chat-panel {
    margin-top: 24px;
    padding: 20px;
    border-radius: 24px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.03);
    display: grid;
    gap: 16px;
  }

  html[data-theme="light"] .chat-panel {
    border-color: rgba(15, 23, 42, 0.12);
    background: rgba(15, 23, 42, 0.02);
  }

  .chat-panel__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }

  .chat-panel__title {
    margin: 0;
    font-size: 1.1rem;
  }

  .chat-panel__log {
    max-height: 420px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding-right: 4px;
  }

  .chat-message {
    padding: 12px 16px;
    border-radius: 16px;
    background: rgba(255, 255, 255, 0.06);
    max-width: 80%;
    position: relative;
  }

  .chat-message--outbound {
    margin-left: auto;
    background: rgba(99, 102, 241, 0.15);
  }

  .chat-message__meta {
    font-size: 0.75rem;
    color: var(--muted);
    margin-top: 6px;
    display: flex;
    justify-content: space-between;
    gap: 8px;
  }

  .chat-message__status-icon {
    font-size: 0.85rem;
    opacity: 0.8;
  }

  .chat-message__status-icon--failed {
    color: var(--bad, #ef4444);
  }

  .chat-message--outbound .chat-message__status-icon {
    color: var(--ok, #22c55e);
  }

  .chat-message__error {
    font-size: 0.75rem;
    color: var(--bad, #ef4444);
    margin-top: 4px;
    padding: 4px 8px;
    background: rgba(239, 68, 68, 0.1);
    border-radius: 6px;
  }

  .chat-panel__templates {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .chat-panel__form textarea {
    width: 100%;
    min-height: 80px;
    padding: 12px;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(0, 0, 0, 0.2);
    color: inherit;
    resize: vertical;
  }

  html[data-theme="light"] .chat-panel__form textarea {
    border-color: rgba(15, 23, 42, 0.2);
    background: rgba(15, 23, 42, 0.03);
  }

  .chat-panel__form-actions {
    margin-top: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
  }

  .chat-panel__status {
    font-size: 0.85rem;
    color: var(--muted);
  }

  .chat-panel__placeholder {
    padding: 12px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.04);
  }

    .chat-panel__header-actions {
      display: flex;
      gap: 6px;
    }

    .chat-panel[hidden] {
      display: none !important;
    }

  .candidate-hero__status {
    flex: 1 1 260px;
    min-width: 240px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .candidate-hero__status-pill {
    align-self: flex-start;
    padding: 6px 14px;
    border-radius: 999px;
    font-weight: 600;
    background: rgba(52, 211, 153, 0.15);
    border: 1px solid rgba(52, 211, 153, 0.4);
  }

  html[data-theme="light"] .candidate-hero__status-pill {
    background: rgba(34, 197, 94, 0.15);
    border-color: rgba(34, 197, 94, 0.35);
  }

  .candidate-hero__status-pill.is-muted {
    background: rgba(239, 68, 68, 0.15);
    border-color: rgba(239, 68, 68, 0.4);
  }

  .candidate-hero__status-note {
    color: var(--muted);
    font-size: 0.9rem;
  }

  .candidate-hero__metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
    gap: 12px;
  }

  .candidate-hero__metrics div {
    padding: 12px 14px;
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.04);
  }

  html[data-theme="light"] .candidate-hero__metrics div {
    border-color: rgba(15, 23, 42, 0.12);
    background: rgba(15, 23, 42, 0.05);
  }

  .candidate-hero__metrics dt {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.72rem;
    color: var(--muted);
    margin-bottom: 4px;
  }

  .candidate-hero__metrics dd {
    font-size: 1.25rem;
    margin: 0;
    font-weight: 600;
  }

  .candidate-outcome {
    padding: 12px 14px;
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.04);
    display: grid;
    gap: 8px;
  }

  html[data-theme="light"] .candidate-outcome {
    border-color: rgba(15, 23, 42, 0.12);
    background: rgba(15, 23, 42, 0.05);
  }

  .candidate-next {
    padding: 24px;
    border-radius: 24px;
    background: rgba(255, 255, 255, 0.06);
    border: 1px solid rgba(255, 255, 255, 0.12);
  }

  html[data-theme="light"] .candidate-next {
    background: rgba(15, 23, 42, 0.03);
    border-color: rgba(15, 23, 42, 0.08);
  }

  .candidate-next__eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.72rem;
    color: var(--muted);
    margin: 0 0 10px;
  }

  .candidate-next__timeline {
    display: flex;
    align-items: flex-start;
    gap: 14px;
    margin-bottom: 12px;
  }

  .candidate-next__dot {
    width: 12px;
    height: 12px;
    border-radius: 999px;
    background: linear-gradient(180deg, #34d399, #059669);
    box-shadow: 0 0 0 4px rgba(52, 211, 153, 0.18);
    margin-top: 6px;
  }

  html[data-theme="light"] .candidate-next__dot {
    background: linear-gradient(180deg, #2563eb, #1d4ed8);
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.22);
  }

  .candidate-next__time {
    font-size: 1.45rem;
    font-weight: 600;
    margin: 0 0 4px;
  }

  .candidate-next__meta,
  .candidate-next__note {
    color: var(--muted);
    font-size: 0.95rem;
  }

  .candidate-next__actions {
    margin-top: 12px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .surface.mt-lg {
    margin-top: 32px;
  }

  .text-prewrap {
    white-space: pre-wrap;
  }

  .interview-section {
    padding: 32px;
  }

  .questionnaire {
    display: grid;
    grid-template-columns: minmax(280px, 0.85fr) minmax(360px, 1.15fr);
    gap: 32px;
  }

  @media (max-width: 1100px) {
    .questionnaire {
      grid-template-columns: 1fr;
    }
  }

  .questionnaire-summary,
  .questionnaire-form {
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 28px;
    padding: 24px;
    background: rgba(15, 23, 42, 0.3);
  }

  html[data-theme="light"] .questionnaire-summary,
  html[data-theme="light"] .questionnaire-form {
    background: rgba(255, 255, 255, 0.95);
    border-color: rgba(15, 23, 42, 0.08);
  }

  .interview-card {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 16px;
    padding: 20px;
    border-radius: 20px;
    background: rgba(15, 23, 42, 0.45);
    border: 1px solid rgba(255, 255, 255, 0.08);
    margin-bottom: 20px;
  }

  html[data-theme="light"] .interview-card {
    background: rgba(255, 255, 255, 0.9);
    border-color: rgba(15, 23, 42, 0.08);
  }

  .interview-card__eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.75rem;
    color: var(--muted);
  }

  .interview-card__title {
    margin: 6px 0;
    font-size: 1.2rem;
  }

  .interview-card__meta {
    display: flex;
    flex-direction: column;
    gap: 6px;
    font-size: 0.9rem;
  }

  .interview-card__actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .questionnaire-form fieldset {
    border: none;
    margin: 0 0 24px;
    padding: 0;
    border-top: 1px solid rgba(255, 255, 255, 0.08);
    padding-top: 20px;
  }

  .questionnaire-form fieldset:first-child {
    border-top: none;
    padding-top: 0;
  }

  html[data-theme="light"] .questionnaire-form fieldset {
    border-color: rgba(15, 23, 42, 0.08);
  }

  .questionnaire-form legend {
    font-weight: 600;
    margin-bottom: 8px;
  }

  .question-description {
    margin: 0 0 16px;
    font-size: 0.9rem;
    color: var(--muted);
  }

  .checkbox-pill {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    border-radius: 16px;
    background: rgba(255, 255, 255, 0.04);
    border: 1px dashed rgba(255, 255, 255, 0.12);
    margin-bottom: 10px;
  }

  html[data-theme="light"] .checkbox-pill {
    background: rgba(15, 23, 42, 0.04);
    border-color: rgba(15, 23, 42, 0.12);
  }

  .checkbox-pill input {
    width: 18px;
    height: 18px;
  }

  .question-field {
    margin-bottom: 16px;
  }

  .question-field label {
    display: block;
    font-size: 0.9rem;
    margin-bottom: 6px;
  }

  .questionnaire-form textarea,
  .questionnaire-form input[type="text"],
  .questionnaire-form input[type="datetime-local"] {
    width: 100%;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(15, 23, 42, 0.15);
    padding: 10px 12px;
    color: inherit;
    font-size: 0.95rem;
  }

  html[data-theme="light"] .questionnaire-form textarea,
  html[data-theme="light"] .questionnaire-form input[type="text"],
  html[data-theme="light"] .questionnaire-form input[type="datetime-local"] {
    background: rgba(255, 255, 255, 0.9);
    border-color: rgba(15, 23, 42, 0.12);
  }

  .questionnaire-form textarea {
    min-height: 90px;
    resize: vertical;
  }

  .decision-options {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }

  .decision-option {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(15, 23, 42, 0.2);
  }

  html[data-theme="light"] .decision-option {
    border-color: rgba(15, 23, 42, 0.15);
    background: rgba(15, 23, 42, 0.04);
  }

  .questionnaire-form .btn {
    margin-top: 12px;
  }

  .test-results-grid {
    display: grid;
    gap: 16px;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  }

  .test-result-card {
    padding: 20px;
    border-radius: 24px;
    background: var(--liquid-glass-bg);
    backdrop-filter: var(--liquid-glass-blur) saturate(200%);
    -webkit-backdrop-filter: var(--liquid-glass-blur) saturate(200%);
    border: 1px solid var(--liquid-glass-border);
    box-shadow: var(--liquid-glass-shadow);
    display: flex;
    flex-direction: column;
    gap: 14px;
    position: relative;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .test-result-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 100%;
    background: var(--liquid-glass-highlight);
    pointer-events: none;
  }
  .test-result-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--liquid-glass-shadow-hover);
    border-color: rgba(255, 255, 255, 0.12);
  }

  .test-result-card__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
  }

  .test-result-card__title {
    margin: 0;
    font-size: 1.05rem;
  }

  .test-result-card__meta {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .test-result-card__actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .test-result-card__body dl {
    display: grid;
    gap: 8px;
  }

  .test-result-card__body dl div {
    display: flex;
    justify-content: space-between;
    gap: 12px;
  }

  .test-result-card__details {
    border-top: 1px solid rgba(15, 23, 42, 0.08);
    padding-top: 12px;
  }

  .test-result-card__details summary {
    cursor: pointer;
    font-weight: 600;
    margin-bottom: 8px;
    outline: none;
  }

  .test-result-card__stats {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    font-size: 0.9rem;
    margin-bottom: 12px;
  }

  .test-result-card__stats span {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 999px;
    padding: 6px 12px;
    transition: all 0.3s ease;
  }
  .test-result-card__stats span:hover {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
    border-color: rgba(255, 255, 255, 0.1);
  }

  .test-result-card__questions .list-table th,
  .test-result-card__questions .list-table td {
    vertical-align: top;
  }

  .status-note {
    font-size: 0.85rem;
    color: #6b7280;
  }

  .test-history {
    margin-top: 16px;
    font-size: 0.9rem;
  }

  .test-history ul {
    margin: 8px 0 0;
    padding-left: 18px;
  }

  .page-actions form.approve-form {
    display: inline-flex;
    flex-direction: column;
    gap: 4px;
    align-items: flex-start;
  }

  .page-actions__note {
    font-size: 0.85rem;
    color: var(--muted);
  }

  .approve-form__hint {
    font-size: 12px;
    color: var(--muted);
  }
</style>
{% set slots = slots or [] %}
{% set pending_ns = namespace(slot=None) %}
{% for slot in slots %}
  {% if pending_ns.slot is none and slot.status == 'pending' %}
    {% set pending_ns.slot = slot %}
  {% endif %}
{% endfor %}
{% set pending_slot = pending_ns.slot %}
{% set saved = request.query_params.get('saved') %}
{% set status_updated = request.query_params.get('status_updated') %}
{% set error = request.query_params.get('error') %}
{% set error_message = request.query_params.get('error_message') %}

{# Success messages #}
{% if saved %}
  <div class="surface glass grain alert" data-tone="success" role="status">
    –î–∞–Ω–Ω—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.
  </div>
{% elif status_updated %}
  <div class="surface glass grain alert" data-tone="success" role="status">
    –°—Ç–∞—Ç—É—Å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω.
  </div>
{% endif %}

{# Error messages with specific codes #}
{% if error %}
  {% set error_messages = {
    'candidate_not_found': '–ö–∞–Ω–¥–∏–¥–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ.',
    'slot_not_found': '–î–ª—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Å–ª–æ—Ç. –°–æ–∑–¥–∞–π—Ç–µ —Å–ª–æ—Ç –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞.',
    'invalid_status': '–£–∫–∞–∑–∞–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å. –í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.',
    'missing_telegram': '–£ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω Telegram ID. –°–≤—è–∂–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç Telegram –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞.',
    'status_not_manual': '–≠—Ç–æ—Ç —Å—Ç–∞—Ç—É—Å –Ω–µ–ª—å–∑—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è.',
    'slot_approval_failed': '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å —Å–ª–æ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.',
    'status_update_failed': '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.'
  } %}
  {% set display_message = error_messages.get(error, error_message or '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.') %}
  <div class="surface glass grain alert" data-tone="danger" role="alert">
    <strong>–û—à–∏–±–∫–∞:</strong> {{ display_message }}
  </div>
{% endif %}
{% set interview_saved = request.query_params.get('interview_saved') %}
{% if interview_saved %}
  <div class="surface glass grain alert" data-tone="success" role="status">
    –°–∫—Ä–∏–ø—Ç —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—ë–Ω.
  </div>
{% elif request.query_params.get('interview_error') %}
  <div class="surface glass grain alert" data-tone="danger" role="alert">
    –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–º–µ—Ç–∫–∏ –ø–æ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—é.
  </div>
{% endif %}
{% set approval_status = request.query_params.get('approval') %}
{% if approval_status %}
  {% set approval_tone = {
    'approved': 'success',
    'notify_failed': 'warning',
    'already': 'info',
    'slot_free': 'warning',
    'missing_candidate': 'danger',
    'not_found': 'danger',
    'error': 'danger',
    'candidate_missing': 'danger',
    'telegram_missing': 'warning',
    'slot_missing': 'warning',
    'invalid_candidate': 'danger'
  } %}
  {% set approval_messages = {
    'approved': '–ò–Ω—Ç–µ—Ä–≤—å—é —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ, –∫–∞–Ω–¥–∏–¥–∞—Ç —É–≤–µ–¥–æ–º–ª—ë–Ω.',
    'notify_failed': '–°–ª–æ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω, –Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—É –Ω–µ —É–¥–∞–ª–æ—Å—å.',
    'already': '–°–ª–æ—Ç —É–∂–µ –±—ã–ª —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω —Ä–∞–Ω–µ–µ.',
    'slot_free': '–°–ª–æ—Ç —É–∂–µ –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω.',
    'missing_candidate': '–°–ª–æ—Ç –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∫–∞–Ω–¥–∏–¥–∞—Ç—É.',
    'not_found': '–ó–∞—è–≤–∫–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –∏–ª–∏ —Å–ª–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.',
    'error': '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å —Å–ª–æ—Ç.',
    'candidate_missing': '–ö–∞–Ω–¥–∏–¥–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.',
    'telegram_missing': '–î–ª—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω Telegram ID.',
    'slot_missing': '–°–ª–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ —É–¥–∞–ª—ë–Ω.',
    'invalid_candidate': '–°–ª–æ—Ç –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –¥—Ä—É–≥–æ–º—É –∫–∞–Ω–¥–∏–¥–∞—Ç—É.'
  } %}
  {% set approval_message = request.query_params.get('approval_message') %}
  {% set tone = approval_tone.get(approval_status, 'info') %}
  <div class="surface glass grain alert" data-tone="{{ tone }}" role="status">
    {{ approval_message or approval_messages.get(approval_status, '–î–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.') }}
  </div>
{% endif %}
{% set manual_slot_status = request.query_params.get('slot_scheduled') %}
{% if manual_slot_status %}
  {% set slot_tones = {
    'success': 'success',
    'notify_failed': 'warning',
    'missing_telegram': 'danger',
    'scheduled': 'success',
    'failed': 'danger'
  } %}
  {% set slot_messages = {
    'success': '–°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ –∏ –∫–∞–Ω–¥–∏–¥–∞—Ç —É–≤–µ–¥–æ–º–ª—ë–Ω.',
    'notify_failed': '–°–ª–æ—Ç —Å–æ–∑–¥–∞–Ω, –Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—É –Ω–µ —É–¥–∞–ª–æ—Å—å ‚Äî —Å–≤—è–∂–∏—Ç–µ—Å—å –≤—Ä—É—á–Ω—É—é.',
    'missing_telegram': '–ù–µ–ª—å–∑—è –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ ‚Äî —É –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç Telegram ID.',
    'scheduled': '–°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ (–±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞).',
    'failed': '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞—Ç—É, –≤—Ä–µ–º—è –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞.'
  } %}
  <div class="surface glass grain alert" data-tone="{{ slot_tones.get(manual_slot_status, 'info') }}" role="status">
    {{ slot_messages.get(manual_slot_status, '–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω.') }}
  </div>
{% endif %}
{% set interview_record = interview_notes|default({}) %}
{% set interview_data = interview_record.get('data', {}) or {} %}
{% set interview_recommendation = interview_data.get('recommendation', 'undecided') %}
{% set interview_sections = interview_form_sections or [] %}
{% set recommendation_lookup = interview_recommendation_lookup or {} %}
{% set show_interview_form = request.query_params.get('interview_edit') or (interview_data|length == 0) %}
{% set telegram_user_id = user.telegram_user_id or user.telegram_id %}
{% set telegram_username = user.telegram_username or user.username %}
{% set telegram_linked_at = user.telegram_linked_at %}
{% set chat_templates = chat_templates or [] %}
{% set test2_section = test_sections_map.get('test2') if test_sections_map else None %}
{% set has_test2_result = test2_passed or (test2_section and test2_section.status in ['passed', 'failed']) %}
{% set has_test2_completed = has_test2_result %}
{% set status_option = (candidate_status_options | selectattr('slug', 'equalto', candidate_status_slug) | list | first) %}
{% set status_label = status_option.label if status_option else (workflow_status_label or stage or '–°—Ç–∞—Ç—É—Å –Ω–µ —É–∫–∞–∑–∞–Ω') %}
{% set status_color = workflow_status_color or candidate_status_color or 'muted' %}
{% set profile_state = 'ready' %}
{% if error %}
  {% set profile_state = 'error' %}
{% elif saved or status_updated or interview_saved %}
  {% set profile_state = 'success' %}
{% endif %}
{% set timeline_items = timeline or [] %}

<section class="page-header">
  <div>
    <a class="muted" href="/candidates">‚Üê –ö —Å–ø–∏—Å–∫—É –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤</a>
    <h1 class="page-title">{{ user.fio }}</h1>
    <p class="page-description">
      Telegram ID {{ telegram_user_id or '‚Äî' }} ¬∑ {{ user.city or '–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω' }}
    </p>
  </div>
  <div class="page-actions">
    {% set cs = (candidate_status_slug or user.candidate_status or '')|lower %}
    {% set intro_day_allowed = can_schedule_intro_day or (cs in ['test2_completed', 'intro_day_scheduled', 'intro_day_confirmed_preliminary', 'intro_day_confirmed_day_of'] or has_test2_completed) %}
    {% if not (has_intro_day_slot | default(false)) and intro_day_allowed %}
      <a href="/candidates/{{ user.id }}/schedule-intro-day" class="btn btn-primary">
        üìÜ –ù–∞–∑–Ω–∞—á–∏—Ç—å –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω—å
      </a>
    {% endif %}
    <div class="btn-group">
      {% if cs not in ['intro_day_confirmed_day_of', 'intro_day_confirmed_preliminary'] and not has_test2_completed and (cs in ['waiting_slot', 'stalled_waiting_slot', 'test1_completed', 'interview_declined', 'interview_scheduled'] or not has_interview_slot) %}
        <a href="/candidates/{{ user.id }}/schedule-slot" class="btn {% if cs in ['waiting_slot', 'stalled_waiting_slot'] %}btn-primary{% else %}btn-secondary{% endif %}">
          üïí {% if cs in ['waiting_slot', 'stalled_waiting_slot'] %}–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤—Ä–µ–º—è —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è{% else %}–ù–∞–∑–Ω–∞—á–∏—Ç—å/–ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ{% endif %}
        </a>
      {% endif %}
      {% if cs not in ['intro_day_confirmed_day_of', 'intro_day_confirmed_preliminary'] %}
        <button class="btn btn-ghost" type="button" data-reject-candidate="{{ user.id }}" data-reject-name="{{ user.fio }}">üö´ –û—Ç–∫–∞–∑</button>
      {% endif %}
    </div>
    {% if pending_slot %}
      <form method="post" action="/candidates/{{ user.id }}/slots/{{ pending_slot.id }}/approve" class="approve-form" data-pending-form>
        {{ csrf_input(request) }}
        <button class="btn btn-primary" type="submit" data-loading-text="–û–±—Ä–∞–±–æ—Ç–∫–∞...">
          ‚úÖ –°–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é
        </button>
        <span class="approve-form__hint">
          {{ fmt_local(pending_slot.start_utc, pending_slot.candidate_tz or 'Europe/Moscow') }} ¬∑
          {% if pending_slot.recruiter %}{{ pending_slot.recruiter.name }}{% else %}–ë–µ–∑ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞{% endif %}
        </span>
      </form>
    {% endif %}
  </div>
</section>

{% set signals = namespace(items=[]) %}
{% if not telegram_user_id %}
  {% set _ = signals.items.append('–ù–µ—Ç Telegram ‚Äî —á–∞—Ç –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã') %}
{% endif %}
{% if not user.phone %}
  {% set _ = signals.items.append('–ù–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞') %}
{% endif %}
{% if not user.city %}
  {% set _ = signals.items.append('–ù–µ —É–∫–∞–∑–∞–Ω –≥–æ—Ä–æ–¥') %}
{% endif %}
{% if not responsible_recruiter %}
  {% set _ = signals.items.append('–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–µ–∫—Ä—É—Ç–µ—Ä') %}
{% endif %}
{% if needs_intro_day %}
  {% set _ = signals.items.append('–ù—É–∂–Ω–æ –Ω–∞–∑–Ω–∞—á–∏—Ç—å –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω—å') %}
{% endif %}
{% if not user.is_active %}
  {% set _ = signals.items.append('–ö–∞–Ω–¥–∏–¥–∞—Ç –≤ –∞—Ä—Ö–∏–≤–µ ‚Äî –≤–∫–ª—é—á–∏—Ç–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É') %}
{% endif %}
{% if signals.items %}
  <div class="surface glass grain alert" data-tone="warning" role="status">
    <strong>–ß—Ç–æ –ø–æ–ø—Ä–∞–≤–∏—Ç—å:</strong> {{ signals.items | join(' ¬∑ ') }}
  </div>
{% endif %}


<section class="profile-shell" data-profile-state="{{ profile_state }}">
  <header class="profile-header">
    <a class="back-link" href="/candidates" aria-label="–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É">‚Üê –ù–∞–∑–∞–¥</a>
    <div class="profile-title">
      <p class="eyebrow">–ü—Ä–æ—Ñ–∏–ª—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</p>
      <h1>{{ user.fio or telegram_username or '–ö–∞–Ω–¥–∏–¥–∞—Ç' }}</h1>
      <p class="subtitle">
        {{ user.city or '–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω' }}
        {% if status_label %} ¬∑ {{ status_label }}{% endif %}
      </p>
    </div>
    <div class="status-chip" aria-label="–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å">
      <span class="status-dot"></span>
      <span>{{ status_label }}</span>
    </div>
  </header>

  {% if legacy_status_enabled %}
    <!-- Status Center: –≥–ª–∞–≤–Ω—ã–π –±–ª–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–º (legacy) -->
    <section class="status-center card glass" data-status-center data-candidate-id="{{ user.id }}">
      <div class="status-center__header">
        <div class="status-center__current" data-tone="{{ candidate_status_color or 'muted' }}">
          <span class="status-center__dot"></span>
          <span class="status-center__label">{{ status_label }}</span>
          {% if status_is_terminal %}
            <span class="status-center__badge status-center__badge--terminal">–§–∏–Ω–∞–ª—å–Ω—ã–π</span>
          {% endif %}
        </div>
      </div>

      <!-- Pipeline progress -->
      <div class="status-center__pipeline">
        {% for stage in pipeline_stages %}
          <div class="pipeline-stage" data-state="{{ stage.state }}">
            <div class="pipeline-stage__dot"></div>
            <span class="pipeline-stage__label">{{ stage.label }}</span>
          </div>
          {% if not loop.last %}
            <div class="pipeline-connector" data-state="{{ stage.state }}"></div>
          {% endif %}
        {% endfor %}
      </div>

      <!-- Quick actions (only allowed transitions) -->
      {% if allowed_next_statuses %}
        <div class="status-center__actions">
          <p class="status-center__actions-label">–°–ª–µ–¥—É—é—â–∏–π —Å—Ç–∞—Ç—É—Å:</p>
          <div class="status-center__buttons">
            {% for next_status in allowed_next_statuses %}
              <button
                class="action-btn {% if next_status.is_terminal %}action-btn--danger{% elif loop.first %}action-btn--primary{% else %}action-btn--secondary{% endif %}"
                type="button"
                data-status-quick="{{ next_status.slug }}"
                {% if next_status.is_terminal %}data-action-confirm="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å ¬´{{ next_status.label }}¬ª? –≠—Ç–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å."{% endif %}
              >
                {{ next_status.label }}
              </button>
            {% endfor %}
          </div>
        </div>
      {% else %}
        <div class="status-center__actions">
          <p class="status-center__empty">{% if status_is_terminal %}–§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å ‚Äî –¥–∞–ª—å–Ω–µ–π—à–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã{% else %}–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤{% endif %}</p>
        </div>
      {% endif %}

      <!-- Manual override (collapsible) -->
      <details class="status-center__override">
        <summary>–†—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞</summary>
        <div class="status-center__override-content">
          <select class="status-select" data-status-manual-select aria-label="–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å">
            {% for option in candidate_status_options %}
              <option value="{{ option.slug }}" {% if option.slug == candidate_status_slug %}selected{% endif %}>
                {{ option.label }}
              </option>
            {% endfor %}
          </select>
          <button type="button" class="action-btn action-btn--secondary" data-status-manual-apply>–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
        <p class="status-center__hint">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è —Ä—É—á–Ω–æ–π –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏. –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –ø–æ—Ç—Ä–µ–±—É—é—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.</p>
      </details>

      <p class="action-error" data-status-center-error hidden></p>
    </section>
  {% endif %}

  <div class="profile-states">
    <div class="state-card" data-when="loading" hidden>–ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å‚Ä¶</div>
    <div class="state-card state-card--error" data-when="error" hidden>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</div>
    <div class="state-card state-card--empty" data-when="empty" hidden>–î–∞–Ω–Ω—ã—Ö –ø–æ –∫–∞–Ω–¥–∏–¥–∞—Ç—É –Ω–µ—Ç.</div>
    <div class="state-card state-card--success" data-when="success" hidden>–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã. –≠–∫—Ä–∞–Ω –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.</div>
  </div>

  <div class="profile-grid">
    <div class="card glass identity-card">
      <div class="card-head">
        <div>
          <p class="eyebrow">–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</p>
          <h3>–ü–∞—Å–ø–æ—Ä—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</h3>
        </div>
        <span class="pill">15 —Å–µ–∫ –Ω–∞ –ø–æ–Ω–∏–º–∞–Ω–∏–µ</span>
      </div>
      <div class="identity-grid">
        <div class="identity-item">
          <span class="identity-label">–¢–µ–ª–µ—Ñ–æ–Ω</span>
          {% if user.phone %}
            <span class="identity-value">{{ user.phone }}</span>
            <div class="inline-actions">
              <button class="action-btn action-btn--ghost" type="button" data-copy-value="{{ user.phone }}" data-copy-success="–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
              <span class="timeline-meta">–î–ª—è –∑–≤–æ–Ω–∫–∞ –∏–ª–∏ WhatsApp</span>
            </div>
          {% else %}
            <span class="identity-value muted">–ù–µ —É–∫–∞–∑–∞–Ω</span>
            <p class="timeline-meta">–î–æ–±–∞–≤—å—Ç–µ, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ–∑–≤–æ–Ω–∏—Ç—å –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å SMS.</p>
          {% endif %}
        </div>

        <div class="identity-item">
          <span class="identity-label">Telegram</span>
          {% if telegram_username or telegram_user_id %}
            <span class="identity-value">
              {% if telegram_username %}@{{ telegram_username }}{% else %}tg_id: {{ telegram_user_id }}{% endif %}
            </span>
            <div class="inline-actions">
              {% if telegram_username %}
                <button class="action-btn action-btn--ghost" type="button" data-copy-value="{{ telegram_username }}" data-copy-success="–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ">@ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω</button>
                <a class="action-btn action-btn--secondary" href="https://t.me/{{ telegram_username }}" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</a>
              {% elif telegram_user_id %}
                <button class="action-btn action-btn--ghost" type="button" data-copy-value="{{ telegram_user_id }}" data-copy-success="–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ">ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω</button>
                <a class="action-btn action-btn--secondary" href="tg://user?id={{ telegram_user_id }}">–û—Ç–∫—Ä—ã—Ç—å –≤ Telegram</a>
              {% endif %}
              <button class="action-btn action-btn--ghost" type="button" data-chat-toggle {% if not telegram_user_id %}disabled{% endif %}>
                –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
              </button>
            </div>
            <span class="timeline-meta">–°–≤—è–∑–∞–Ω {{ fmt_local(telegram_linked_at, 'Europe/Moscow') if telegram_linked_at else '–Ω–µ—Ç –æ—Ç–º–µ—Ç–∫–∏' }}</span>
          {% else %}
            <span class="identity-value muted">–ï—â—ë –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω</span>
            <p class="timeline-meta">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –≤ –±–æ—Ç–∞, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å —á–∞—Ç.</p>
          {% endif %}
        </div>

        <div class="identity-item">
          <span class="identity-label">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–µ–∫—Ä—É—Ç–µ—Ä</span>
          {% if responsible_recruiter %}
            <span class="identity-value">{{ responsible_recruiter.name }}</span>
            {% if responsible_recruiter.tg_chat_id %}
              <div class="inline-actions">
                <a class="quiet-link" href="tg://user?id={{ responsible_recruiter.tg_chat_id }}">–ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram</a>
              </div>
            {% endif %}
          {% else %}
            <span class="identity-value muted">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
            <p class="timeline-meta">–ó–∞–∫—Ä–µ–ø–∏—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.</p>
          {% endif %}
        </div>

        <div class="identity-item">
          <span class="identity-label">–ö–∞–Ω–∞–ª –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</span>
          <span class="identity-value">{{ user.source or '‚Äî' }}</span>
          <div class="inline-actions">
            <span class="pill">{% if user.is_active %}–ê–∫—Ç–∏–≤–µ–Ω{% else %}–ê—Ä—Ö–∏–≤{% endif %}</span>
            <span class="timeline-meta">{{ user.city or '–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω' }}</span>
          </div>
          {% if telemost_url %}
            <p class="timeline-meta">–°—Å—ã–ª–∫–∞ –Ω–∞ —Å–æ–∑–≤–æ–Ω: <a class="quiet-link" href="{{ telemost_url }}" target="_blank" rel="noopener">{{ telemost_source or '—Ç–µ–ª–µ–º–æ—Å—Ç' }}</a></p>
          {% endif %}
        </div>
      </div>
    </div>

    <aside class="card glass actions-card" data-candidate-actions data-candidate-id="{{ user.id }}">
      <div class="card-head">
        <div>
          <p class="eyebrow">–î–µ–π—Å—Ç–≤–∏—è</p>
          <h3>–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥</h3>
        </div>
        <span class="pill">–¥–æ 4 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</span>
      </div>
      {% set actions = candidate_actions %}
      <div class="action-grid">
        {% if actions %}
          {% set visible_actions = actions[:4] %}
          {% for action in visible_actions %}
            {% set href = action.url_pattern.replace('{id}', user.id|string) %}
            {% set variant = action.variant or 'secondary' %}
            {% set variant_class = 'action-btn--secondary' %}
            {% if loop.index == 1 and variant != 'danger' %}
              {% set variant_class = 'action-btn--primary' %}
            {% elif variant == 'danger' %}
              {% set variant_class = 'action-btn--danger' %}
            {% elif variant == 'ghost' %}
              {% set variant_class = 'action-btn--ghost' %}
            {% elif variant == 'primary' %}
              {% set variant_class = 'action-btn--primary' %}
            {% endif %}
            <div class="action-row">
              {% if action.method == 'GET' %}
                <a href="{{ href }}" class="action-btn {{ variant_class }}">
                  {% if action.icon %}<span aria-hidden="true">{{ action.icon }}</span>{% endif %}
                  <span>{{ action.label }}</span>
                </a>
              {% else %}
                <button
                  class="action-btn {{ variant_class }}"
                  type="button"
                  data-action-target="{{ action.target_status or action.key }}"
                  data-action-key="{{ action.key }}"
                  data-action-method="{{ action.method }}"
                  {% if action.confirmation %}data-action-confirm="{{ action.confirmation }}"{% endif %}>
                  {% if action.icon %}<span aria-hidden="true">{{ action.icon }}</span>{% endif %}
                  <span>{{ action.label }}</span>
                </button>
              {% endif %}
            </div>
          {% endfor %}
        {% else %}
          <div class="state-card state-card--empty">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞.</div>
        {% endif %}
      </div>
      {% if actions and (actions|length > 4) %}
        <p class="timeline-meta">–ü–æ–∫–∞–∑–∞–Ω—ã –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —à–∞–≥–∏; –ø–æ–ª–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é.</p>
      {% endif %}
      <p class="action-error" data-action-error hidden></p>
    </aside>
    {% if legacy_status_enabled %}
      <aside class="card glass actions-card" data-status-switcher data-candidate-id="{{ user.id }}">
        <div class="card-head">
          <div>
            <p class="eyebrow">–°—Ç–∞—Ç—É—Å</p>
            <h3>–ë—ã—Å—Ç—Ä–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ</h3>
          </div>
          <span class="pill">–ö–æ–Ω—Ç—Ä–æ–ª—å</span>
        </div>
        <div class="status-control">
          <select class="status-select" data-status-select aria-label="–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å">
            {% for option in candidate_status_options %}
              <option value="{{ option.slug }}" {% if option.slug == candidate_status_slug %}selected{% endif %}>
                {{ option.label }}
              </option>
            {% endfor %}
          </select>
          <button type="button" class="action-btn action-btn--secondary" data-status-apply>–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
        <p class="status-meta">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è —Ä—É—á–Ω–æ–π –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏. –û–ø–∞—Å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã —Ç—Ä–µ–±—É—é—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.</p>
        <p class="action-error" data-status-error hidden></p>
      </aside>
    {% endif %}
  </div>

  <details class="timeline-shell" data-collapsible>
    <summary>–ò—Å—Ç–æ—Ä–∏—è –∏ —Å–∏–≥–Ω–∞–ª—ã</summary>
    <div class="timeline-body" data-timeline>
      {% if timeline_items %}
        <div class="timeline-filters" data-timeline-filters>
          <button type="button" class="timeline-filter-btn" data-filter="all" aria-pressed="true">–í—Å–µ</button>
          <button type="button" class="timeline-filter-btn" data-filter="slot" aria-pressed="false">üóìÔ∏è –°–ª–æ—Ç—ã</button>
          <button type="button" class="timeline-filter-btn" data-filter="test" aria-pressed="false">üß† –¢–µ—Å—Ç—ã</button>
          <button type="button" class="timeline-filter-btn" data-filter="message" aria-pressed="false">üí¨ –°–æ–æ–±—â–µ–Ω–∏—è</button>
        </div>
        <ul class="timeline-list" data-timeline-list>
          {% for item in timeline_items %}
            {% set ts = item.dt %}
            {% set timestamp = fmt_local(ts, item.tz or 'Europe/Moscow') if ts else '‚Äî' %}
            {% if item.kind == 'slot' %}
              {% set label = '–°–ª–æ—Ç —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è' %}
              {% set recruiter_label = ' ¬∑ ' ~ item.recruiter if item.recruiter else '' %}
              {% set meta = (item.city or '–ë–µ–∑ –≥–æ—Ä–æ–¥–∞') ~ recruiter_label %}
              {% set tone = 'slot' %}
              {% set icon = 'üóìÔ∏è' %}
            {% elif item.kind == 'test' %}
              {% set label = item.rating or '–¢–µ—Å—Ç' %}
              {% set meta = item.test_key and item.test_key|upper or '' %}
              {% set tone = 'test' %}
              {% set icon = 'üß†' %}
            {% else %}
              {% set label = '–°–æ–æ–±—â–µ–Ω–∏–µ' %}
              {% set meta = item.text or '–¢–µ–∫—Å—Ç —Å–∫—Ä—ã—Ç' %}
              {% set tone = 'message' %}
              {% set icon = 'üí¨' %}
            {% endif %}
            <li class="timeline-item" data-stagger data-kind="{{ tone }}">
              <div class="timeline-icon" data-tone="{{ tone }}">{{ icon }}</div>
              <div>
                <div class="timeline-title">{{ label }}</div>
                <div class="timeline-meta">{{ meta }}</div>
              </div>
              <time class="timeline-meta">{{ timestamp }}</time>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="timeline-empty">–•—Ä–æ–Ω–æ–ª–æ–≥–∏—è –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π.</div>
      {% endif %}
    </div>
  </details>
</section>

<script nonce="{{ request.state.csp_nonce }}">
(function() {
  const shell = document.querySelector('[data-profile-state]');
  if (!shell) return;
  const state = shell.dataset.profileState || 'ready';
  shell.querySelectorAll('[data-when]').forEach((node) => {
    node.hidden = node.dataset.when !== state;
  });
  const timelineItems = shell.querySelectorAll('[data-stagger]');
  timelineItems.forEach((item, idx) => {
    item.style.animationDelay = `${idx * 0.04}s`;
  });
})();
</script>

<script nonce="{{ request.state.csp_nonce }}">
(function() {
  const STORAGE_KEY = 'timeline_filter';
  const filtersContainer = document.querySelector('[data-timeline-filters]');
  const timelineList = document.querySelector('[data-timeline-list]');
  if (!filtersContainer || !timelineList) return;

  const filterButtons = filtersContainer.querySelectorAll('[data-filter]');
  const items = timelineList.querySelectorAll('[data-kind]');

  function applyFilter(filter) {
    filterButtons.forEach((btn) => {
      btn.setAttribute('aria-pressed', btn.dataset.filter === filter ? 'true' : 'false');
    });
    items.forEach((item) => {
      if (filter === 'all' || item.dataset.kind === filter) {
        item.hidden = false;
      } else {
        item.hidden = true;
      }
    });
    try {
      localStorage.setItem(STORAGE_KEY, filter);
    } catch (e) {
      // localStorage unavailable
    }
  }

  // Restore saved filter
  let savedFilter = 'all';
  try {
    savedFilter = localStorage.getItem(STORAGE_KEY) || 'all';
  } catch (e) {
    // localStorage unavailable
  }
  applyFilter(savedFilter);

  // Handle clicks
  filtersContainer.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-filter]');
    if (!btn) return;
    applyFilter(btn.dataset.filter);
  });
})();
</script>

{% if pending_slot %}
  <section class="candidate-slot-control surface glass grain">
    <div class="candidate-slot-control__header">
      <div>
        <p class="candidate-next__eyebrow">–°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ –æ–∂–∏–¥–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è</p>
        <p class="candidate-next__time">
          {{ fmt_local(pending_slot.start_utc, pending_slot.candidate_tz or user.tz_name or 'Europe/Moscow') }}
        </p>
        <p class="candidate-next__meta">
          {% if pending_slot.city %}{{ pending_slot.city.name }}{% endif %}
          {% if pending_slot.city and pending_slot.recruiter %}&nbsp;‚Ä¢&nbsp;{% endif %}
          {% if pending_slot.recruiter %}–†–µ–∫—Ä—É—Ç—ë—Ä: {{ pending_slot.recruiter.name }}{% endif %}
        </p>
      </div>
      <span class="badge badge--warning">–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</span>
    </div>
    <div class="candidate-slot-panel">
      <div class="candidate-slot-panel__group">
        <p class="candidate-slot-panel__label">–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ö–æ–¥</p>
        <div class="candidate-slot-panel__actions">
          <form method="post" action="/candidates/{{ user.id }}/slots/{{ pending_slot.id }}/approve" data-pending-form>
            <input type="hidden" name="csrf_token" value="{{ csrf_token(request) }}">
            <button class="btn btn-primary" type="submit" data-loading-text="–û–±—Ä–∞–±–æ—Ç–∫–∞...">
              –°–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å —Å–ª–æ—Ç
            </button>
          </form>
          <button
            class="btn btn-ghost"
            type="button"
            data-slot-reject
            data-slot-id="{{ pending_slot.id }}">
            –û—Ç–∫–∞–∑–∞—Ç—å / –æ—Å–≤–æ–±–æ–¥–∏—Ç—å
          </button>
          <button
            class="btn btn-secondary"
            type="button"
            data-slot-reschedule
            data-slot-id="{{ pending_slot.id }}">
            –ó–∞–ø—Ä–æ—Å–∏—Ç—å –ø–µ—Ä–µ–Ω–æ—Å
          </button>
        </div>
        <p class="candidate-slot-panel__hint">
          –°–ª–æ—Ç –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞.
        </p>
      </div>
    </div>
  </section>
{% endif %}

{% set chat_disabled = 1 if not telegram_user_id else 0 %}
<section
  class="chat-panel"
  data-chat-root
  hidden
  data-chat-disabled="{{ chat_disabled }}"
  data-chat-url="/api/candidates/{{ user.id }}/chat"
  data-chat-retry-base="/api/candidates/{{ user.id }}/chat"
>
  <div class="chat-panel__header">
    <div>
      <p class="telegram-panel__eyebrow">–ß–∞—Ç (Telegram)</p>
      <h2 class="chat-panel__title">–û–±—â–µ–Ω–∏–µ —Å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–º</h2>
    </div>
    <div class="chat-panel__header-actions">
      <button class="btn btn-ghost btn--xs" type="button" data-chat-refresh>–û–±–Ω–æ–≤–∏—Ç—å</button>
      <button class="btn btn-ghost btn--xs" type="button" data-chat-close>–°–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
  {% if not telegram_user_id %}
    <div class="chat-panel__placeholder">
      <p>–ö–∞–Ω–¥–∏–¥–∞—Ç –µ—â—ë –Ω–µ –ø–∏—Å–∞–ª –±–æ—Ç—É ‚Äî —á–∞—Ç —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.</p>
    </div>
  {% else %}
    <div class="chat-panel__log" data-chat-list>
      <p class="chat-panel__placeholder">–°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–¥–≥—Ä—É–∂–∞—é—Ç—Å—è‚Ä¶</p>
    </div>
    <button class="btn btn-ghost btn--xs" type="button" data-chat-more hidden>–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë</button>
    <div class="chat-panel__templates">
      {% for template in chat_templates or [] %}
        <button
          class="btn btn-ghost btn--xs"
          type="button"
          data-chat-template="{{ template.key }}"
          data-template-text="{{ template.text }}">
          {{ template.label }}
        </button>
      {% endfor %}
    </div>
    <form class="chat-panel__form" data-chat-form>
      <textarea data-chat-input placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—É‚Ä¶" maxlength="2000"></textarea>
      <div class="chat-panel__form-actions">
        <span class="chat-panel__status" data-chat-status></span>
        <button class="btn btn-primary" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </form>
  {% endif %}
</section>

{% set avg_score_label = '%.1f'|format(stats.average_score) if stats.average_score is not none else '‚Äî' %}

<section class="surface glass grain mt-lg interview-section" id="interview-script">
  <header class="section-header">
    <div>
      <h2 class="section-title">–ê–Ω–∫–µ—Ç–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è Smart Service</h2>
      <p class="section-hint">–ó–∞–ø–æ–ª–Ω—è–π—Ç–µ –ø–æ —Ö–æ–¥—É —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ ‚Äî –∏—Ç–æ–≥ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.</p>
    </div>
    <div class="interview-meta">
      {% if interview_record.get('updated_at') %}
        <span class="muted">–û–±–Ω–æ–≤–ª–µ–Ω–æ {{ fmt_local(interview_record.get('updated_at'), 'Europe/Moscow') }}</span>
      {% endif %}
    </div>
  </header>
  <div class="questionnaire">
    <aside class="questionnaire-summary">
      {% if interview_data %}
        {% set rec_meta = recommendation_lookup.get(interview_recommendation) %}
        <div class="interview-card">
          <div>
            <span class="interview-card__eyebrow">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>
            <h3 class="interview-card__title">{{ rec_meta.label if rec_meta else '–ê–Ω–∫–µ—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞' }}</h3>
            <div class="interview-card__meta">
              <span>–ò–Ω—Ç–µ—Ä–≤—å—é–µ—Ä: {{ interview_record.get('interviewer_name') or '‚Äî' }}</span>
              <span>–ü—Ä–æ–≤–µ–¥–µ–Ω–æ: {{ interview_data.get('interviewed_at') or '‚Äî' }}</span>
            </div>
          </div>
          <div class="interview-card__actions">
            <a class="btn btn-soft" href="/candidates/{{ user.id }}/interview-notes/download" rel="noopener">üìÑ –°–∫–∞—á–∞—Ç—å</a>
            <a class="btn btn-primary" href="/candidates/{{ user.id }}?interview_edit=1#interview-script">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
          </div>
        </div>
      {% else %}
        <p class="muted">–ê–Ω–∫–µ—Ç–∞ –ø–æ–∫–∞ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ ¬´–ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É¬ª, —á—Ç–æ–±—ã –ø—Ä–æ–π—Ç–∏ —Å–∫—Ä–∏–ø—Ç.</p>
        <a class="btn btn-primary" href="/candidates/{{ user.id }}?interview_edit=1#interview-script">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É</a>
      {% endif %}
    </aside>
    {% if show_interview_form %}
      <div class="questionnaire-form">
        <form method="post" action="/candidates/{{ user.id }}/interview-notes">
          {{ csrf_input(request) }}
          {% for section in interview_sections %}
            <fieldset>
              <legend>{{ section.title }}</legend>
              {% if section.description %}
                <p class="question-description">{{ section.description }}</p>
              {% endif %}
              {% for question in section.questions %}
                {% set field_id = 'question-' ~ question.key %}
                {% set value = interview_data.get(question.key) %}
                {% if question.type == 'checkbox' %}
                  <label class="checkbox-pill" for="{{ field_id }}">
                    <input type="checkbox" id="{{ field_id }}" name="{{ question.key }}" {% if value %}checked{% endif %}>
                    <span>{{ question.label }}</span>
                  </label>
                {% elif question.type == 'textarea' %}
                  <div class="question-field">
                    <label for="{{ field_id }}">{{ question.label }}</label>
                    <textarea id="{{ field_id }}" name="{{ question.key }}" placeholder="{{ question.placeholder or '' }}">{{ value or '' }}</textarea>
                  </div>
                {% elif question.type == 'text' %}
                  <div class="question-field">
                    <label for="{{ field_id }}">{{ question.label }}</label>
                    <input type="text" id="{{ field_id }}" name="{{ question.key }}" value="{{ value or '' }}" placeholder="{{ question.placeholder or '' }}">
                  </div>
                {% elif question.type == 'datetime' %}
                  <div class="question-field">
                    <label for="{{ field_id }}">{{ question.label }}</label>
                    <input type="datetime-local" id="{{ field_id }}" name="{{ question.key }}" value="{{ value or '' }}">
                  </div>
                {% elif question.type == 'radio' %}
                  <div class="question-field">
                    <label>{{ question.label }}</label>
                    <div class="decision-options">
                      {% for option in question.options %}
                        <label class="decision-option">
                          <input type="radio" name="{{ question.key }}" value="{{ option.value }}" {% if interview_recommendation == option.value %}checked{% endif %}>
                          <span>{{ option.label }}</span>
                        </label>
                      {% endfor %}
                    </div>
                  </div>
                {% endif %}
              {% endfor %}
            </fieldset>
          {% endfor %}
          <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É</button>
        </form>
      </div>
    {% endif %}
  </div>
</section>

<section class="surface glass grain mt-lg">
  <header class="section-header">
    <h2 class="section-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</h2>
    <p class="section-hint">–°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –∏ –ø–æ–¥—Ä–æ–±–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.</p>
  </header>
  {% set status_meta = {
    'passed': {'class': 'badge badge--success', 'icon': '‚úÖ', 'label': '–ü—Ä–æ–π–¥–µ–Ω'},
    'failed': {'class': 'badge badge--warning', 'icon': '‚ùå', 'label': '–ù–µ –ø—Ä–æ–π–¥–µ–Ω'},
    'in_progress': {'class': 'badge badge--info', 'icon': '‚è≥', 'label': '–í –ø—Ä–æ—Ü–µ—Å—Å–µ'},
    'not_started': {'class': 'badge badge--muted', 'icon': '‚Äî', 'label': '–ù–µ –ø—Ä–æ—Ö–æ–¥–∏–ª'}
  } %}
  <div class="test-results-grid">
    {% for section in test_sections %}
      {% set meta = status_meta.get(section.status, status_meta['not_started']) %}
      {% set stats = section.details.stats %}
      {% set source_labels = {
        'bot': '–ë–æ—Ç',
        'invite_link': 'Invite-link',
        'invite': 'Invite-link'
      } %}
      <article class="test-result-card">
        <header class="test-result-card__header">
          <div class="test-result-card__meta">
            <h3 class="test-result-card__title">{{ section.title }}</h3>
            <span class="{{ meta.class }}">{{ meta.icon }} {{ section.status_label or meta.label }}</span>
          </div>
          <div class="test-result-card__actions">
            {% if section.report_url %}
              <a class="btn btn-soft btn-xs" href="{{ section.report_url }}" download>–°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç</a>
            {% endif %}
          </div>
        </header>
        <div class="test-result-card__body">
          <dl>
            <div>
              <dt>–°—Ç–∞—Ç—É—Å</dt>
              <dd>{{ meta.icon }} {{ section.status_label or meta.label }}</dd>
            </div>
            <div>
              <dt>–ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ</dt>
              <dd>
                {% if section.completed_at %}
                  {{ fmt_local(section.completed_at, 'Europe/Moscow') }}
                {% else %}
                  <span class="muted">‚Äî</span>
                {% endif %}
              </dd>
            </div>
            <div>
              <dt>–ö—Ä–∞—Ç–∫–æ</dt>
              <dd>{{ section.summary }}</dd>
            </div>
            {% if section.source %}
              <div>
                <dt>–ò—Å—Ç–æ—á–Ω–∏–∫</dt>
                <dd>{{ source_labels.get(section.source, section.source) }}</dd>
              </div>
            {% endif %}
          </dl>
        </div>
        {% if section.pending_since %}
          <p class="status-note">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {{ fmt_local(section.pending_since, 'Europe/Moscow') }}</p>
        {% endif %}
        {% set has_details = section.details.questions|length > 0 or section.history|length > 1 %}
        {% if has_details %}
          <details class="test-result-card__details">
            <summary>–û—Ç–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏</summary>
            <div class="test-result-card__stats">
              <span>–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤: {{ stats.total_questions }}</span>
              <span>–í–µ—Ä–Ω–æ: {{ stats.correct_answers }}</span>
              {% if stats.overtime_questions %}
                <span>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: {{ stats.overtime_questions }}</span>
              {% endif %}
              {% if stats.final_score is not none %}
                <span>–ë–∞–ª–ª—ã: {{ '%.1f'|format(stats.final_score) }}</span>
              {% endif %}
              {% if stats.total_time %}
                <span>–í—Ä–µ–º—è: {{ stats.total_time }} —Å–µ–∫</span>
              {% endif %}
            </div>
            <div class="test-result-card__questions list-table-wrapper">
              <table class="list-table">
                <thead>
                  <tr>
                    <th scope="col">–í–æ–ø—Ä–æ—Å</th>
                    <th scope="col">–û—Ç–≤–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</th>
                    <th scope="col">–ü—Ä–æ–≤–µ—Ä–∫–∞</th>
                  </tr>
                </thead>
                <tbody>
                  {% for question in section.details.questions %}
                    <tr>
                      <td>
                        <strong>{{ question.question_index }}.</strong>
                        <div class="text-prewrap">{{ question.question_text }}</div>
                      </td>
                      <td class="text-prewrap">{{ question.user_answer or '‚Äî' }}</td>
                      <td>
                        {% if question.correct_answer %}
                          <div class="text-prewrap">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {{ question.correct_answer }}</div>
                        {% endif %}
                        <div>
                          {% if question.is_correct %}
                            <span class="badge badge--success">–í–µ—Ä–Ω–æ</span>
                          {% else %}
                            <span class="badge badge--muted">–ù–µ–≤–µ—Ä–Ω–æ</span>
                          {% endif %}
                          {% if question.overtime %}
                            <span class="badge badge--warning">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
                          {% endif %}
                          {% if question.attempts_count and question.attempts_count > 1 %}
                            <span class="badge badge--soft">–ü–æ–ø—ã—Ç–æ–∫: {{ question.attempts_count }}</span>
                          {% endif %}
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% if section.history|length > 1 %}
            <div class="test-history">
              <strong>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–ø—ã—Ç–æ–∫</strong>
              <ul>
                {% for item in section.history %}
                  <li>
                    {% if item.completed_at %}
                      {{ fmt_local(item.completed_at, 'Europe/Moscow') }}
                    {% else %}
                      ‚Äî
                    {% endif %}
                    ¬∑ {{ '%.1f'|format(item.final_score) if item.final_score is not none else '‚Äî' }} –±–∞–ª–ª–æ–≤
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
          </details>
        {% else %}
          <p class="muted">–î–µ—Ç–∞–ª–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∞.</p>
        {% endif %}
      </article>
    {% endfor %}
  </div>
</section>

<style>
/* Confirm overlay (Apple-style destructive action) */
  .confirm-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: color-mix(in srgb, var(--ink-soft, #0f172a) 10%, transparent);
    backdrop-filter: blur(10px);
    z-index: 9998;
    padding: 12px;
    align-items: center;
    justify-content: center;
  }

  .confirm-overlay[data-open="true"] {
    display: flex;
  }

  .confirm-sheet {
    width: min(440px, 96vw);
    background: var(--surface-raised);
    border: 1px solid color-mix(in srgb, var(--border) 70%, transparent);
    border-radius: 18px;
    padding: 20px 18px 16px;
    box-shadow: 0 16px 50px rgba(0, 0, 0, 0.12);
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .confirm-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--ink);
    margin: 0;
  }

  .confirm-desc {
    margin: 0;
    color: var(--ink-soft);
    line-height: 1.5;
  }

  .confirm-error {
    color: var(--danger);
    font-size: 14px;
    margin: 0;
  }

  .confirm-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }

  .confirm-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid color-mix(in srgb, var(--danger) 20%, transparent);
    border-top-color: var(--danger);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-left: 8px;
    vertical-align: middle;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .mini-toast {
    position: fixed;
    bottom: 16px;
    right: 16px;
    padding: 12px 14px;
    border-radius: 12px;
    background: color-mix(in srgb, var(--ink) 6%, var(--surface-raised));
    color: var(--ink);
    border: 1px solid color-mix(in srgb, var(--border) 80%, transparent);
    box-shadow: 0 12px 40px rgba(0,0,0,0.12);
    z-index: 2100;
    font-size: 14px;
  }
</style>
</style>

{# Lightweight confirm overlay for destructive actions #}
<div class="confirm-overlay" data-confirm-overlay data-open="false" aria-hidden="true">
  <div class="confirm-sheet" role="dialog" aria-modal="true" aria-labelledby="confirm-title">
    <div class="confirm-copy">
      <p class="confirm-title" id="confirm-title" data-confirm-title>–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞?</p>
      <p class="confirm-desc" data-confirm-desc>–ö–∞–Ω–¥–∏–¥–∞—Ç –±—É–¥–µ—Ç –ø–µ—Ä–µ–≤–µ–¥—ë–Ω –≤ –∞—Ä—Ö–∏–≤. –ü—Ä–∏—á–∏–Ω—É –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ø–æ–∑–∂–µ.</p>
    </div>
    <p class="confirm-error" data-confirm-error hidden></p>
    <div class="confirm-actions">
      <button type="button" class="action-btn action-btn--secondary" data-confirm-cancel>–û—Ç–º–µ–Ω–∞</button>
      <button type="button" class="action-btn action-btn--danger" data-confirm-submit>
        <span data-confirm-submit-label>–û—Ç–∫–ª–æ–Ω–∏—Ç—å</span>
        <span class="confirm-spinner" data-confirm-spinner hidden></span>
      </button>
    </div>
  </div>
</div>

<script nonce="{{ request.state.csp_nonce }}">
(function () {
  const chatRoot = document.querySelector('[data-chat-root]');
  const chatToggle = document.querySelector('[data-chat-toggle]');
  const chatClose = chatRoot ? chatRoot.querySelector('[data-chat-close]') : null;
  if (!chatRoot) {
    return;
  }
  if (chatRoot.dataset.chatDisabled === '1') {
    return;
  }
  const chatList = chatRoot.querySelector('[data-chat-list]');
  const loadMoreBtn = chatRoot.querySelector('[data-chat-more]');
  const refreshBtn = chatRoot.querySelector('[data-chat-refresh]');
  const form = chatRoot.querySelector('[data-chat-form]');
  const input = chatRoot.querySelector('[data-chat-input]');
  const statusEl = chatRoot.querySelector('[data-chat-status]');
  const templateButtons = chatRoot.querySelectorAll('[data-chat-template]');
  const chatUrl = chatRoot.dataset.chatUrl;
  const retryBase = chatRoot.dataset.chatRetryBase;
  const csrfToken = window.__CSRF_TOKEN__ || document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
  let pollTimer = null;
  let state = [];

  const openChat = () => {
    chatRoot.hidden = false;
    if (chatToggle) chatToggle.hidden = true;
  };
  const closeChat = () => {
    chatRoot.hidden = true;
    if (chatToggle) chatToggle.hidden = false;
  };
  if (chatToggle) {
    chatToggle.addEventListener('click', openChat);
  }
  if (chatClose) {
    chatClose.addEventListener('click', closeChat);
  }

  const setStatus = (message, tone = 'muted') => {
    if (!statusEl) return;
    statusEl.textContent = message || '';
    statusEl.dataset.tone = tone;
  };

  const sortMessages = (messages) => {
    return [...messages].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
  };

  // Status icons for delivery indication
  const STATUS_ICONS = {
    'queued': 'üïê',      // Clock - waiting to send
    'sent': '‚úì',        // Single check - sent
    'received': '‚úì‚úì',   // Double check - delivered/read
    'failed': '‚ö†Ô∏è',      // Warning - failed
  };

  const getStatusIcon = (status) => STATUS_ICONS[status] || status;

  const render = (scrollToBottom = false) => {
    if (!chatList) return;
    chatList.innerHTML = '';
    if (!state.length) {
      chatList.innerHTML = '<p class="chat-panel__placeholder">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π.</p>';
      return;
    }
    state.forEach((msg) => {
      const row = document.createElement('div');
      row.className = 'chat-message' + (msg.direction === 'outbound' ? ' chat-message--outbound' : '');
      row.dataset.messageId = msg.id;

      const content = document.createElement('div');
      content.className = 'chat-message__text';
      content.textContent = msg.text || '';
      row.appendChild(content);

      const meta = document.createElement('div');
      meta.className = 'chat-message__meta';
      const dt = new Date(msg.created_at);
      const timeStr = dt.toLocaleString('ru-RU', { hour: '2-digit', minute: '2-digit', day: 'numeric', month: 'short' });

      // Show delivery status icon for outbound messages
      if (msg.direction === 'outbound') {
        const statusIcon = getStatusIcon(msg.status);
        const statusClass = msg.status === 'failed' ? 'chat-message__status-icon--failed' : '';
        meta.innerHTML = `<span>${timeStr}</span><span class="chat-message__status-icon ${statusClass}">${statusIcon}</span>`;
      } else {
        meta.innerHTML = `<span>${timeStr}</span>`;
      }
      row.appendChild(meta);

      if (msg.error) {
        const error = document.createElement('div');
        error.className = 'chat-message__error';
        error.textContent = msg.error;
        row.appendChild(error);
      }
      if (msg.can_retry) {
        const retryBtn = document.createElement('button');
        retryBtn.type = 'button';
        retryBtn.className = 'btn btn-ghost btn--xs';
        retryBtn.dataset.chatRetry = String(msg.id);
        retryBtn.textContent = '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å';
        row.appendChild(retryBtn);
      }
      chatList.appendChild(row);
    });

    // Auto-scroll to bottom if requested
    if (scrollToBottom && chatList.lastElementChild) {
      chatList.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }
  };

  const upsertMessages = (messages, { replace = false, prepend = false, scrollToBottom = false } = {}) => {
    if (!messages || !messages.length) {
      if (replace) {
        state = [];
        render();
      }
      return;
    }
    if (replace) {
      state = sortMessages(messages);
    } else if (prepend) {
      const existingIds = new Set(state.map((msg) => msg.id));
      const ordered = sortMessages(messages);
      state = [...ordered.filter((msg) => !existingIds.has(msg.id)), ...state];
    } else {
      const map = new Map(state.map((msg) => [msg.id, msg]));
      messages.forEach((msg) => map.set(msg.id, msg));
      state = sortMessages(Array.from(map.values()));
    }
    render(scrollToBottom);
    if (state.length) {
      state = sortMessages(state);
    }
  };

  const fetchJson = async (url, options) => {
    const response = await fetch(url, options);
    if (!response.ok) {
      const payload = await response.json().catch(() => ({}));
      const message = payload?.detail?.message || payload?.message || response.statusText;
      throw new Error(message || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å');
    }
    return response.json();
  };

  const loadLatest = async () => {
    try {
      const data = await fetchJson(chatUrl);
      upsertMessages(data.messages || [], { replace: true });
      if (loadMoreBtn) {
        loadMoreBtn.hidden = !data.has_more;
      }
    } catch (err) {
      console.error(err);
      setStatus(err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–∞—Ç', 'danger');
    }
  };

  const loadOlder = async () => {
    if (!state.length) return;
    const before = state[0]?.created_at;
    if (!before) return;
    const url = `${chatUrl}?before=${encodeURIComponent(before)}`;
    try {
      const data = await fetchJson(url);
      upsertMessages(data.messages || [], { prepend: true });
      if (loadMoreBtn) {
        loadMoreBtn.hidden = !data.has_more;
      }
    } catch (err) {
      setStatus(err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è', 'danger');
    }
  };

  const sendMessage = async (text) => {
    const payload = {
      text,
      client_request_id: (crypto?.randomUUID && crypto.randomUUID()) || String(Date.now()),
    };
    const body = JSON.stringify(payload);
    setStatus('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º‚Ä¶', 'info');
    const result = await fetchJson(chatUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken,
      },
      body,
    });
    if (result?.message) {
      upsertMessages([result.message], { scrollToBottom: true });
    } else {
      await loadLatest();
    }
    setStatus('');
  };

  const retryMessage = async (messageId) => {
    const url = `${retryBase}/${messageId}/retry`;
    setStatus('–ü—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ‚Ä¶', 'info');
    const data = await fetchJson(url, {
      method: 'POST',
      headers: {
        'X-CSRF-Token': csrfToken,
      },
    });
    if (data?.message) {
      upsertMessages([data.message], { scrollToBottom: true });
    }
    setStatus('');
  };

  loadMoreBtn?.addEventListener('click', () => {
    loadOlder();
  });

  refreshBtn?.addEventListener('click', () => {
    loadLatest();
  });

  templateButtons.forEach((button) => {
    button.addEventListener('click', () => {
      const text = button.getAttribute('data-template-text') || '';
      if (input) {
        input.value = text;
        input.focus();
      }
    });
  });

  chatList?.addEventListener('click', (event) => {
    const target = event.target.closest('[data-chat-retry]');
    if (!target) return;
    const messageId = target.getAttribute('data-chat-retry');
    if (messageId) {
      retryMessage(messageId);
    }
  });

  form?.addEventListener('submit', async (event) => {
    event.preventDefault();
    if (!input) return;
    const text = (input.value || '').trim();
    if (!text) {
      setStatus('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'warning');
      return;
    }
    try {
      await sendMessage(text);
      input.value = '';
      setStatus('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
      setTimeout(() => setStatus(''), 1500);
    } catch (err) {
      setStatus(err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å', 'danger');
    }
  });

  loadLatest();
  pollTimer = window.setInterval(loadLatest, 5000);

  window.addEventListener('beforeunload', () => {
    if (pollTimer) {
      window.clearInterval(pollTimer);
    }
  });
})();
</script>

<script nonce="{{ request.state.csp_nonce }}">
// Reject pending slot from candidate card (without triggering Test2)
(function(){
  const rejectBtn = document.querySelector('[data-slot-reject]');
  const rescheduleBtn = document.querySelector('[data-slot-reschedule]');
  if (!rejectBtn) return;
  const slotId = rejectBtn.dataset.slotId || rescheduleBtn?.dataset.slotId;
  const csrfToken = window.__CSRF_TOKEN__ || document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
  const statusEl = rejectBtn.closest('.candidate-slot-panel')?.querySelector('.candidate-slot-panel__hint');

  async function slotAction(path, button, confirmationText, successText) {
    if (!slotId || !button) return;
    if (confirmationText && !window.confirm(confirmationText)) return;
    button.disabled = true;
    try {
      const response = await fetch(`/slots/${slotId}/${path}`, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'X-CSRFToken': csrfToken,
        },
      });
      const payload = await response.json().catch(() => ({}));
      if (!response.ok || payload?.ok === false) {
        throw new Error(payload?.message || response.statusText);
      }
      if (statusEl) {
        statusEl.dataset.tone = 'success';
        statusEl.textContent = payload?.message || successText;
      }
    } catch (err) {
      alert(err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å–ª–æ—Ç.');
      button.disabled = false;
    }
  }

  rejectBtn.addEventListener('click', () => {
    slotAction('reject_booking', rejectBtn, '–û—Ç–∫–∞–∑–∞—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç—É –∏ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å —Å–ª–æ—Ç?', '–°–ª–æ—Ç –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω.');
  });

  rescheduleBtn?.addEventListener('click', () => {
    slotAction('reschedule', rescheduleBtn, '–ó–∞–ø—Ä–æ—Å–∏—Ç—å –ø–µ—Ä–µ–Ω–æ—Å —ç—Ç–æ–≥–æ —Å–ª–æ—Ç–∞?', '–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–µ—Ä–µ–Ω–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.');
  });
})();
</script>

<script nonce="{{ request.state.csp_nonce }}">
// Candidate actions (status transitions via JSON endpoint)
(function () {
  const root = document.querySelector('[data-candidate-actions]');
  if (!root) return;
  const candidateId = root.dataset.candidateId;
  const legacyStatusEnabled = {{ 'true' if legacy_status_enabled else 'false' }};
  const csrfToken = window.__CSRF_TOKEN__ || document.querySelector('meta[name=\"csrf-token\"]')?.getAttribute('content') || '';
  const errorEl = root.querySelector('[data-action-error]');
  const overlay = document.querySelector('[data-confirm-overlay]');
  const titleEl = document.querySelector('[data-confirm-title]');
  const descEl = document.querySelector('[data-confirm-desc]');
  const errorLine = document.querySelector('[data-confirm-error]');
  const cancelBtn = document.querySelector('[data-confirm-cancel]');
  const submitBtn = document.querySelector('[data-confirm-submit]');
  const spinner = document.querySelector('[data-confirm-spinner]');
  const submitLabel = document.querySelector('[data-confirm-submit-label]');
  const statusRoot = document.querySelector('[data-status-switcher]');
  const statusSelect = statusRoot?.querySelector('[data-status-select]');
  const statusApply = statusRoot?.querySelector('[data-status-apply]');
  const statusError = statusRoot?.querySelector('[data-status-error]');
  let pendingAction = null;

  const setError = (text) => {
    if (!errorEl) return;
    if (text) {
      errorEl.hidden = false;
      errorEl.textContent = text;
    } else {
      errorEl.hidden = true;
      errorEl.textContent = '';
    }
  };

  const setStatusError = (text) => {
    if (!statusError) return;
    if (text) {
      statusError.hidden = false;
      statusError.textContent = text;
    } else {
      statusError.hidden = true;
      statusError.textContent = '';
    }
  };

  const resetOverlayState = () => {
    if (!overlay) return;
    overlay.dataset.open = 'false';
    overlay.setAttribute('aria-hidden', 'true');
    pendingAction = null;
    if (errorLine) {
      errorLine.hidden = true;
      errorLine.textContent = '';
    }
    if (submitBtn) {
      submitBtn.disabled = false;
    }
    if (cancelBtn) {
      cancelBtn.disabled = false;
    }
    if (spinner) spinner.hidden = true;
  };

  const showToast = (text) => {
    const toast = document.createElement('div');
    toast.className = 'mini-toast';
    toast.textContent = text;
    document.body.appendChild(toast);
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(6px)';
      setTimeout(() => toast.remove(), 220);
    }, 1800);
  };

  const openConfirm = ({ title, desc, confirmLabel, onConfirm }) => {
    if (!overlay || !titleEl || !descEl || !cancelBtn || !submitBtn || !submitLabel) return;
    titleEl.textContent = title || '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ';
    descEl.textContent = desc || '';
    submitLabel.textContent = confirmLabel || '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
    pendingAction = onConfirm;
    overlay.dataset.open = 'true';
    overlay.setAttribute('aria-hidden', 'false');
    cancelBtn.focus({ preventScroll: true });
  };

  const handleConfirm = async () => {
    if (!pendingAction || !submitBtn || !cancelBtn) return;
    submitBtn.disabled = true;
    cancelBtn.disabled = true;
    if (spinner) spinner.hidden = false;
    if (errorLine) {
      errorLine.hidden = true;
      errorLine.textContent = '';
    }
    try {
      await pendingAction();
      showToast('–î–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ');
      window.setTimeout(() => window.location.reload(), 650);
    } catch (err) {
      submitBtn.disabled = false;
      cancelBtn.disabled = false;
      if (spinner) spinner.hidden = true;
      if (errorLine) {
        errorLine.hidden = false;
        errorLine.textContent = err?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ';
      }
    }
  };

  cancelBtn?.addEventListener('click', resetOverlayState);
  submitBtn?.addEventListener('click', handleConfirm);

  overlay?.addEventListener('click', (event) => {
    if (event.target === overlay) {
      resetOverlayState();
    }
  });

  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape' && overlay?.dataset.open === 'true') {
      resetOverlayState();
    }
  });

  const performCandidateAction = async (actionKey, btnToDisable) => {
    if (!actionKey) return;
    if (btnToDisable) btnToDisable.disabled = true;
    try {
      const response = await fetch(`/api/candidates/${candidateId}/actions/${actionKey}`, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'X-CSRFToken': csrfToken,
        },
      });
      const payload = await response.json().catch(() => ({}));
      if (!response.ok || payload.ok === false) {
        throw new Error(payload?.detail?.message || payload.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ');
      }
      return true;
    } finally {
      if (btnToDisable) btnToDisable.disabled = false;
    }
  };

  const sendLegacyStatus = async (targetStatus, btnToDisable, onError) => {
    if (!targetStatus) return;
    if (btnToDisable) btnToDisable.disabled = true;
    try {
      const response = await fetch(`/candidates/${candidateId}/status`, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({ status: targetStatus }),
      });
      const payload = await response.json().catch(() => ({}));
      if (!response.ok || payload.ok === false) {
        throw new Error(payload.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å');
      }
      return true;
    } catch (err) {
      if (onError) onError(err);
      throw err;
    } finally {
      if (btnToDisable) btnToDisable.disabled = false;
    }
  };

  const declineStatuses = new Set([
    'interview_declined',
    'test2_failed',
    'intro_day_declined_invitation',
    'intro_day_declined_day_of',
    'not_hired',
  ]);

  root.addEventListener('click', async (event) => {
    const btn = event.target.closest('[data-action-target]');
    if (!btn || btn.disabled) return;
    const targetStatus = btn.dataset.actionTarget;
    const actionKey = btn.dataset.actionKey || targetStatus;
    const confirmMsg = btn.dataset.actionConfirm;
    if (!actionKey) return;
    const performAction = async () => {
      return performCandidateAction(actionKey, btn);
    };

    if (confirmMsg) {
      const isDecline = declineStatuses.has(targetStatus);
      const defaultTitle = isDecline ? '–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞?' : '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ?';
      const defaultDesc = isDecline
        ? '–ö–∞–Ω–¥–∏–¥–∞—Ç –±—É–¥–µ—Ç –ø–µ—Ä–µ–≤–µ–¥—ë–Ω –≤ –∞—Ä—Ö–∏–≤. –ü—Ä–∏—á–∏–Ω—É –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ø–æ–∑–∂–µ.'
        : '';
      openConfirm({
        title: defaultTitle,
        desc: defaultDesc || confirmMsg,
        confirmLabel: (btn.textContent || '').trim() || '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å',
        onConfirm: performAction,
      });
      return;
    }

    try {
      await performAction();
      showToast('–î–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ');
      window.setTimeout(() => window.location.reload(), 650);
    } catch (err) {
      setError(err?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å');
    }
  });

  if (legacyStatusEnabled) {
    statusApply?.addEventListener('click', () => {
      const targetStatus = statusSelect?.value;
      if (!targetStatus) return;
      setStatusError('');
      const isDecline = declineStatuses.has(targetStatus);
      const doSend = async () => {
        try {
          await sendLegacyStatus(targetStatus, statusApply, (err) => setStatusError(err?.message));
          showToast('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω');
          window.setTimeout(() => window.location.reload(), 650);
        } catch (err) {
          // –û—à–∏–±–∫–∞ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–∞
        }
      };

      if (isDecline) {
        openConfirm({
          title: '–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞?',
          desc: '–ö–∞–Ω–¥–∏–¥–∞—Ç –±—É–¥–µ—Ç –ø–µ—Ä–µ–≤–µ–¥—ë–Ω –≤ –∞—Ä—Ö–∏–≤. –ü—Ä–∏—á–∏–Ω—É –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ø–æ–∑–∂–µ.',
          confirmLabel: '–û—Ç–∫–ª–æ–Ω–∏—Ç—å',
          onConfirm: doSend,
        });
        return;
      }
      doSend();
    });
  }

  // ===== Status Center handlers (legacy only) =====
  if (legacyStatusEnabled) {
    const statusCenter = document.querySelector('[data-status-center]');
    const statusCenterError = statusCenter?.querySelector('[data-status-center-error]');
    const manualSelect = statusCenter?.querySelector('[data-status-manual-select]');
    const manualApply = statusCenter?.querySelector('[data-status-manual-apply]');

    const setStatusCenterError = (text) => {
      if (!statusCenterError) return;
      if (text) {
        statusCenterError.hidden = false;
        statusCenterError.textContent = text;
      } else {
        statusCenterError.hidden = true;
        statusCenterError.textContent = '';
      }
    };

    const sendStatusWithLoading = async (targetStatus, btn) => {
      if (!targetStatus || !btn) return;
      const originalContent = btn.innerHTML;
      btn.setAttribute('data-loading', '');
      btn.disabled = true;
      setStatusCenterError('');

      try {
        await sendLegacyStatus(targetStatus, null, (err) => setStatusCenterError(err?.message));
        showToast('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω');
        window.setTimeout(() => window.location.reload(), 650);
        return true;
      } catch (err) {
        setStatusCenterError(err?.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
        btn.removeAttribute('data-loading');
        btn.disabled = false;
        btn.innerHTML = originalContent;
        throw err;
      }
    };

    // Quick action buttons in Status Center
    statusCenter?.addEventListener('click', async (event) => {
      const quickBtn = event.target.closest('[data-status-quick]');
      if (!quickBtn || quickBtn.disabled) return;

      const targetStatus = quickBtn.dataset.statusQuick;
      const confirmMsg = quickBtn.dataset.actionConfirm;
      if (!targetStatus) return;

      const performAction = () => sendStatusWithLoading(targetStatus, quickBtn);

      if (confirmMsg) {
        const isDecline = declineStatuses.has(targetStatus);
        openConfirm({
          title: isDecline ? '–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞?' : confirmMsg,
          desc: isDecline ? '–ö–∞–Ω–¥–∏–¥–∞—Ç –±—É–¥–µ—Ç –ø–µ—Ä–µ–≤–µ–¥—ë–Ω –≤ –∞—Ä—Ö–∏–≤.' : '',
          confirmLabel: (quickBtn.textContent || '').trim() || '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å',
          onConfirm: performAction,
        });
        return;
      }

      try {
        await performAction();
      } catch (err) {
        // –û—à–∏–±–∫–∞ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–∞
      }
    });

    // Manual override in Status Center
    manualApply?.addEventListener('click', async () => {
      const targetStatus = manualSelect?.value;
      if (!targetStatus) return;

      const isDecline = declineStatuses.has(targetStatus);
      const performAction = () => sendStatusWithLoading(targetStatus, manualApply);

      if (isDecline) {
        openConfirm({
          title: '–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞?',
          desc: '–ö–∞–Ω–¥–∏–¥–∞—Ç –±—É–¥–µ—Ç –ø–µ—Ä–µ–≤–µ–¥—ë–Ω –≤ –∞—Ä—Ö–∏–≤. –ü—Ä–∏—á–∏–Ω—É –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ø–æ–∑–∂–µ.',
          confirmLabel: '–û—Ç–∫–ª–æ–Ω–∏—Ç—å',
          onConfirm: performAction,
        });
        return;
      }

      try {
        await performAction();
      } catch (err) {
        // –û—à–∏–±–∫–∞ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–∞
      }
    });
  }
})();
</script>

<script nonce="{{ request.state.csp_nonce }}">
// Auto-dismiss alerts and add close buttons
(function() {
  'use strict';

  const alerts = document.querySelectorAll('.alert[role="status"], .alert[role="alert"]');

  alerts.forEach(function(alert) {
    // Add close button to all alerts
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = '&times;';
    closeBtn.className = 'alert-close';
    closeBtn.setAttribute('aria-label', '–ó–∞–∫—Ä—ã—Ç—å');
    closeBtn.style.cssText = 'position:absolute;top:8px;right:12px;background:none;border:none;color:inherit;opacity:0.6;cursor:pointer;font-size:24px;line-height:1;padding:0;width:24px;height:24px;';
    closeBtn.addEventListener('click', function() {
      alert.style.transition = 'opacity 0.3s, transform 0.3s';
      alert.style.opacity = '0';
      alert.style.transform = 'translateY(-10px)';
      setTimeout(function() { alert.remove(); }, 300);
    });

    // Position alert relatively for close button
    alert.style.position = 'relative';
    alert.style.paddingRight = '40px';
    alert.appendChild(closeBtn);

    // Auto-dismiss success messages after 5 seconds
    if (alert.getAttribute('data-tone') === 'success') {
      setTimeout(function() {
        closeBtn.click();
      }, 5000);
    }

    // Scroll to alert on page load
    if (alert.getAttribute('data-tone') === 'danger') {
      setTimeout(function() {
        alert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 100);
    }
  });
})();
</script>

<script nonce="{{ request.state.csp_nonce }}">
// Reject candidate button handler using new API
(function() {
  'use strict';

  const csrfToken = window.__CSRF_TOKEN__ || document.querySelector('[name="csrf_token"]')?.value || '';

  async function rejectCandidate(candidateId) {
    const response = await fetch(`/api/candidates/${candidateId}/actions/reject`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'X-CSRFToken': csrfToken,
      },
      body: JSON.stringify({}),
    });
    const payload = await response.json().catch(() => ({}));
    if (!response.ok) {
      throw new Error(payload.message || payload.detail?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞');
    }
    return payload;
  }

  document.querySelectorAll('[data-reject-candidate]').forEach(btn => {
    btn.addEventListener('click', async function() {
      const candidateId = this.dataset.rejectCandidate;
      const candidateName = this.dataset.rejectName || '';

      if (!confirm(`–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ ${candidateName}?`)) {
        return;
      }

      this.disabled = true;
      try {
        await rejectCandidate(candidateId);
        window.location.reload();
      } catch (err) {
        alert(err.message);
        this.disabled = false;
      }
    });
  });
})();
</script>

<script>
// Loading state for forms with data-pending-form attribute
document.querySelectorAll('[data-pending-form]').forEach(form => {
  form.addEventListener('submit', function() {
    const btn = this.querySelector('button[type="submit"]');
    if (btn && !btn.disabled) {
      btn.disabled = true;
      const loadingText = btn.dataset.loadingText || '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
      btn.dataset.originalText = btn.textContent;
      btn.textContent = loadingText;
    }
  });
});
</script>

{# –°–æ–æ–±—â–µ–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç—É –∏ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—è —Å–∫—Ä—ã—Ç—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É #}
{% endblock %}
