{% extends "base.html" %}
{% block title %}{{ user.fio }}{% endblock %}
{% block content %}
  <div class="space-y-10">
    <nav>
      <a class="inline-flex items-center gap-2 text-sm font-semibold text-sky-600 transition hover:text-sky-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-500 dark:text-sky-400 dark:hover:text-sky-300" href="/candidates">
        <span aria-hidden="true">←</span>
        К списку кандидатов
      </a>
    </nav>

    <header class="flex flex-col gap-6 lg:flex-row lg:items-start lg:justify-between">
      <div class="space-y-2">
        <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500 dark:text-slate-400">Кандидат</p>
        <h1 class="text-3xl font-semibold tracking-tight text-slate-900 dark:text-slate-50">{{ user.fio }}</h1>
        <div class="flex flex-wrap gap-3 text-sm text-slate-600 dark:text-slate-400">
          <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-600 dark:border-slate-600 dark:text-slate-300">
            {% if user.is_active %}Активен{% else %}Отключен{% endif %}
          </span>
          <span class="inline-flex items-center gap-2 text-sm">
            <svg class="h-4 w-4 text-slate-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M10 1.67 1.67 7.5v10.83h6.66v-4.16h3.34v4.16h6.66V7.5z"/></svg>
            {{ user.city or 'Город не указан' }}
          </span>
          <span class="inline-flex items-center gap-2 text-sm">
            <svg class="h-4 w-4 text-slate-400" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="m7.5 3.75 1.312-1.969a1 1 0 0 1 1.375-.281l1.2.8a1 1 0 0 1 .438.832V3.75M4.375 6h11.25A1.375 1.375 0 0 1 17 7.375v8.25A1.375 1.375 0 0 1 15.625 17h-11.25A1.375 1.375 0 0 1 3 15.625v-8.25A1.375 1.375 0 0 1 4.375 6Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M6.5 3.75h7"/></svg>
            Последняя активность: {% if user.last_activity %}{{ fmt_local(user.last_activity, 'Europe/Moscow') }}{% else %}—{% endif %}
          </span>
        </div>
      </div>
      <dl class="grid grid-cols-1 gap-4 text-sm text-slate-600 dark:text-slate-300 sm:grid-cols-2 lg:grid-cols-3">
        <div class="rounded-2xl border border-slate-200 bg-white/70 p-4 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
          <dt class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Всего тестов</dt>
          <dd class="mt-1 text-2xl font-semibold text-slate-900 dark:text-slate-50">{{ stats.tests_total }}</dd>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white/70 p-4 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
          <dt class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Средний балл</dt>
          <dd class="mt-1 text-2xl font-semibold text-slate-900 dark:text-slate-50">{{ '%.1f'|format(stats.average_score) if stats.average_score is not none else '—' }}</dd>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white/70 p-4 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
          <dt class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Текущий этап</dt>
          <dd class="mt-1 text-2xl font-semibold text-slate-900 dark:text-slate-50">{{ stage }}</dd>
        </div>
      </dl>
      {% if test_stage_summary %}
        <div class="mt-4 flex flex-wrap gap-3 text-xs font-medium text-slate-600 dark:text-slate-300">
          {% for item in test_stage_summary %}
            <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 dark:border-slate-600">
              <span class="uppercase tracking-wide">{{ item.label }}</span>
              <span>{{ item.score }} ({{ item.rating }})</span>
              {% if item.dt %}
                <span class="text-slate-400 dark:text-slate-500">{{ fmt_local(item.dt, 'Europe/Moscow') }}</span>
              {% endif %}
            </span>
          {% endfor %}
        </div>
      {% endif %}
    </header>

    <section class="grid gap-8 lg:grid-cols-3">
      <div class="space-y-6 lg:col-span-2">
        <article class="rounded-3xl border border-slate-200 bg-white/70 p-6 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
          <header class="flex flex-col gap-2 sm:flex-row sm:items-baseline sm:justify-between">
            <div>
              <h2 class="text-xl font-semibold text-slate-900 dark:text-slate-50">Интервью</h2>
              {% if latest_interview %}
                <p class="text-sm text-slate-600 dark:text-slate-400">{{ fmt_local(latest_interview.start_utc, latest_interview.candidate_tz or 'Europe/Moscow') if latest_interview.start_utc else 'Дата не указана' }}</p>
              {% else %}
                <p class="text-sm text-slate-600 dark:text-slate-400">Интервью пока не запланировано.</p>
              {% endif %}
            </div>
            {% if latest_interview and latest_interview.recruiter and latest_interview.recruiter.telemost_url %}
              <a class="inline-flex items-center gap-2 rounded-full bg-emerald-500 px-4 py-2 text-sm font-semibold text-white shadow transition hover:bg-emerald-600 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-400" href="{{ latest_interview.recruiter.telemost_url }}" target="_blank" rel="noopener">
                Перейти в конференцию
              </a>
            {% endif %}
          </header>
          {% if latest_interview %}
            <div class="mt-6 space-y-6">
              <div class="flex flex-wrap gap-3">
                <form method="post" action="/candidates/{{ user.id }}/slots/{{ latest_interview.id }}/outcome">
                  <input type="hidden" name="outcome" value="success">
                  <button class="inline-flex items-center justify-center rounded-full bg-emerald-500 px-4 py-2 text-sm font-semibold text-white shadow transition hover:bg-emerald-600 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-300" type="submit">Прошёл</button>
                </form>
                <form method="post" action="/candidates/{{ user.id }}/slots/{{ latest_interview.id }}/outcome">
                  <input type="hidden" name="outcome" value="reject">
                  <button class="inline-flex items-center justify-center rounded-full bg-rose-500 px-4 py-2 text-sm font-semibold text-white shadow transition hover:bg-rose-600 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-rose-300" type="submit">Не прошёл</button>
                </form>
              </div>

              <form class="space-y-5" method="post" action="/candidates/{{ user.id }}/interview-feedback">
                <input type="hidden" name="slot_id" value="{{ latest_interview.id }}">
                <fieldset class="space-y-3">
                  <legend class="text-sm font-semibold text-slate-900 dark:text-slate-100">Сценарий интервью</legend>
                  {% for step in interview_script %}
                    {% set is_checked = interview_feedback.checklist.get(step.id) if interview_feedback.checklist else False %}
                    <label class="flex items-start gap-3 rounded-2xl border border-slate-200 bg-white/60 p-3 transition hover:border-sky-300 focus-within:border-sky-300 dark:border-slate-700 dark:bg-slate-800/70">
                      <input id="interview-step-{{ step.id }}" name="checklist" value="{{ step.id }}" type="checkbox" class="mt-1 h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-500 dark:border-slate-600 dark:bg-slate-900" {% if is_checked %}checked{% endif %}>
                      <span>
                        <span class="block text-sm font-semibold text-slate-900 dark:text-slate-100">{{ step.title }}</span>
                        <span class="block text-xs text-slate-600 dark:text-slate-400">{{ step.description }}</span>
                      </span>
                    </label>
                  {% endfor %}
                </fieldset>
                <label class="flex flex-col gap-2 text-sm font-medium text-slate-900 dark:text-slate-100">
                  Заметки
                  <textarea class="h-28 w-full rounded-2xl border border-slate-200 bg-white/70 p-3 text-sm text-slate-700 shadow-sm focus:border-sky-400 focus:ring-2 focus:ring-sky-200 dark:border-slate-700 dark:bg-slate-900/70 dark:text-slate-100 dark:focus:border-sky-500 dark:focus:ring-sky-500/40" name="notes" placeholder="Что важно запомнить для следующего этапа?">{{ interview_feedback.notes or '' }}</textarea>
                </label>
                <div class="flex items-center justify-between text-xs text-slate-500 dark:text-slate-400">
                  {% if interview_feedback.updated_at %}
                    <span>Обновлено {{ interview_feedback.updated_at }}</span>
                  {% endif %}
                  <button class="inline-flex items-center justify-center rounded-full bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow transition hover:bg-slate-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-600 dark:bg-slate-100 dark:text-slate-900 dark:hover:bg-slate-200" type="submit">Сохранить</button>
                </div>
              </form>
            </div>
          {% endif %}
        </article>

        <article class="rounded-3xl border border-slate-200 bg-white/70 p-6 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
          <header class="flex items-center justify-between">
            <h2 class="text-xl font-semibold text-slate-900 dark:text-slate-50">Результаты тестов</h2>
            <span class="text-sm text-slate-500 dark:text-slate-400">{{ stats.tests_total }} попыток</span>
          </header>
          {% if tests %}
            <div class="mt-4 overflow-x-auto">
              <table class="min-w-full divide-y divide-slate-200 text-sm leading-6 dark:divide-slate-700">
                <thead class="bg-slate-50/70 text-left text-xs font-semibold uppercase tracking-wide text-slate-600 dark:bg-slate-800/70 dark:text-slate-300">
                  <tr>
                    <th scope="col" class="px-4 py-3">Дата</th>
                    <th scope="col" class="px-4 py-3">Сумма баллов</th>
                    <th scope="col" class="px-4 py-3">Оценка</th>
                    <th scope="col" class="px-4 py-3">Время, сек</th>
                    <th scope="col" class="px-4 py-3">Ответы</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 bg-white/70 text-slate-700 dark:divide-slate-800 dark:bg-slate-900/60 dark:text-slate-200">
                  {% for result in tests %}
                    {% set answers = answers_map.get(result.id) %}
                    <tr>
                      <td class="px-4 py-3">{{ fmt_local(result.created_at, 'Europe/Moscow') }}</td>
                      <td class="px-4 py-3">{{ result.final_score }} / {{ result.raw_score }}</td>
                      <td class="px-4 py-3">{{ result.rating }}</td>
                      <td class="px-4 py-3">{{ result.total_time }}</td>
                      <td class="px-4 py-3">
                        {% if answers %}
                          <button
                            type="button"
                            class="inline-flex items-center justify-center rounded-full border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-700 transition hover:border-sky-400 hover:text-sky-600 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-500 dark:border-slate-600 dark:text-slate-200 dark:hover:border-sky-500 dark:hover:text-sky-400"
                            data-open-modal="answers-{{ result.id }}"
                            aria-haspopup="dialog"
                            aria-controls="answers-{{ result.id }}"
                          >
                            Посмотреть ответы
                          </button>
                        {% else %}
                          <span class="text-slate-400 dark:text-slate-500">—</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% for result in tests %}
              {% set answers = answers_map.get(result.id) %}
              {% if answers %}
                <div id="answers-{{ result.id }}" data-modal class="fixed inset-0 z-40 hidden">
                  <div data-modal-backdrop class="absolute inset-0 bg-slate-900/60 opacity-0 transition-opacity"></div>
                  <div role="dialog" aria-modal="true" aria-labelledby="answers-title-{{ result.id }}" tabindex="-1" class="relative mx-auto mt-24 w-full max-w-3xl rounded-3xl border border-slate-200 bg-white p-6 shadow-xl outline-none transition focus:outline-none dark:border-slate-700 dark:bg-slate-900">
                    <div class="flex items-start justify-between gap-4">
                      <div>
                        <h3 id="answers-title-{{ result.id }}" class="text-lg font-semibold text-slate-900 dark:text-slate-50">Ответы теста от {{ fmt_local(result.created_at, 'Europe/Moscow') }}</h3>
                        <p class="text-sm text-slate-600 dark:text-slate-400">Правильных: {{ answers.questions_correct }} из {{ answers.questions_total }}{% if answers.questions_overtime %}, просрочено: {{ answers.questions_overtime }}{% endif %}</p>
                      </div>
                      <button type="button" class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-slate-200 text-slate-500 transition hover:border-slate-300 hover:text-slate-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-500 dark:border-slate-600 dark:text-slate-300 dark:hover:border-slate-500" data-modal-close aria-label="Закрыть">
                        ×
                      </button>
                    </div>
                    <div class="mt-4 max-h-96 overflow-y-auto rounded-2xl border border-slate-100 bg-slate-50/60 p-4 text-sm text-slate-700 dark:border-slate-700 dark:bg-slate-800/70 dark:text-slate-200">
                      <ol class="space-y-4">
                        {% for answer in answers.questions %}
                          <li class="space-y-1">
                            <p class="font-semibold text-slate-900 dark:text-slate-100">Вопрос {{ loop.index }}: {{ answer.question_text }}</p>
                            <p>Ответ кандидата: <span class="font-medium">{{ answer.user_answer or '—' }}</span></p>
                            <p>Правильный ответ: <span class="font-medium text-emerald-600 dark:text-emerald-400">{{ answer.correct_answer or '—' }}</span></p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">Время: {{ answer.time_spent }} сек • Попыток: {{ answer.attempts_count }}{% if answer.overtime %} • <span class="text-rose-500">Превышено время</span>{% endif %}</p>
                          </li>
                        {% endfor %}
                      </ol>
                    </div>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          {% else %}
            <p class="mt-4 text-sm text-slate-500 dark:text-slate-400">Кандидат ещё не проходил тесты.</p>
          {% endif %}
        </article>

        {% if test2_completed %}
          <article class="rounded-3xl border border-slate-200 bg-white/70 p-6 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
            <h2 class="text-xl font-semibold text-slate-900 dark:text-slate-50">Ознакомительный день</h2>
            <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">Отправьте кандидату приглашение с датой и временем.</p>
            <form class="mt-4 space-y-4" method="post" action="/candidates/{{ user.id }}/intro-day">
              <div class="grid gap-4 sm:grid-cols-2">
                <label class="flex flex-col gap-2 text-sm font-medium text-slate-900 dark:text-slate-100">
                  Дата
                  <input class="rounded-2xl border border-slate-200 bg-white/70 px-4 py-2 text-sm text-slate-700 shadow-sm focus:border-sky-400 focus:ring-2 focus:ring-sky-200 dark:border-slate-700 dark:bg-slate-900/70 dark:text-slate-100 dark:focus:border-sky-500 dark:focus:ring-sky-500/40" type="date" name="date_value" required>
                </label>
                <label class="flex flex-col gap-2 text-sm font-medium text-slate-900 dark:text-slate-100">
                  Время
                  <input class="rounded-2xl border border-slate-200 bg-white/70 px-4 py-2 text-sm text-slate-700 shadow-sm focus:border-sky-400 focus:ring-2 focus:ring-sky-200 dark:border-slate-700 dark:bg-slate-900/70 dark:text-slate-100 dark:focus:border-sky-500 dark:focus:ring-sky-500/40" type="time" name="time_value" required>
                </label>
              </div>
              <label class="flex flex-col gap-2 text-sm font-medium text-slate-900 dark:text-slate-100">
                Сообщение кандидату
                <textarea class="h-24 rounded-2xl border border-slate-200 bg-white/70 p-3 text-sm text-slate-700 shadow-sm focus:border-sky-400 focus:ring-2 focus:ring-sky-200 dark:border-slate-700 dark:bg-slate-900/70 dark:text-slate-100 dark:focus:border-sky-500 dark:focus:ring-sky-500/40" name="message_text" placeholder="{{ intro_message_template|format(fio=user.fio, date='дд.мм.гггг', time='чч:мм') }}"></textarea>
              </label>
              <div class="flex justify-end">
                <button class="inline-flex items-center justify-center rounded-full bg-sky-600 px-5 py-2 text-sm font-semibold text-white shadow focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-500 dark:bg-sky-500" type="submit">Отправить приглашение</button>
              </div>
            </form>
          </article>
        {% endif %}
      </div>

      <aside class="space-y-6">
        <section class="rounded-3xl border border-slate-200 bg-white/70 p-6 shadow-sm dark:border-slate-700 dark:bg-slate-900/60" id="history">
          <h2 class="text-xl font-semibold text-slate-900 dark:text-slate-50">История событий</h2>
          {% if timeline %}
            <ol class="mt-4 space-y-4 text-sm text-slate-600 dark:text-slate-300">
              {% for event in timeline %}
                <li class="rounded-2xl border border-slate-200 bg-white/60 p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800/60">
                  <div class="flex items-center justify-between text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
                    <span>
                      {% if event.kind == 'slot' %}
                        Интервью
                      {% elif event.kind == 'test' %}
                        Тест
                      {% elif event.kind == 'message' %}
                        Сообщение
                      {% else %}
                        Событие
                      {% endif %}
                    </span>
                    <time datetime="{{ event.dt.isoformat() if event.dt }}">{{ fmt_local(event.dt, event.tz or 'Europe/Moscow') if event.dt else '—' }}</time>
                  </div>
                  <div class="mt-2 space-y-1 text-sm">
                    {% if event.kind == 'slot' %}
                      <p>Статус: {{ (event.status or '')|upper }}</p>
                      {% if event.recruiter %}<p>Рекрутёр: {{ event.recruiter }}</p>{% endif %}
                      {% if event.city %}<p>Город: {{ event.city }}</p>{% endif %}
                    {% elif event.kind == 'test' %}
                      <p>Баллы: {{ event.score }} ({{ event.rating or '—' }})</p>
                    {% elif event.kind == 'message' %}
                      <p class="whitespace-pre-line">{{ event.text }}</p>
                      {% if event.send_time %}<p class="text-xs text-slate-500 dark:text-slate-400">Запланировано: {{ event.send_time }}</p>{% endif %}
                    {% endif %}
                  </div>
                </li>
              {% endfor %}
            </ol>
          {% else %}
            <p class="mt-4 text-sm text-slate-500 dark:text-slate-400">История пока пуста.</p>
          {% endif %}
        </section>
      </aside>
    </section>
  </div>
{% endblock %}

{% block extra_js %}
  <script>
    (function () {
      const modalButtons = document.querySelectorAll('[data-open-modal]');
      const modals = new Map();
      let previousFocus = null;

      function closeModal(modal) {
        modal.classList.add('hidden');
        const backdrop = modal.querySelector('[data-modal-backdrop]');
        if (backdrop) {
          backdrop.classList.add('opacity-0');
          setTimeout(() => backdrop.classList.add('hidden'), 150);
        }
        if (previousFocus) {
          previousFocus.focus();
        }
      }

      document.querySelectorAll('[data-modal]').forEach((modal) => {
        const id = modal.id;
        modals.set(id, modal);
        const closeButtons = modal.querySelectorAll('[data-modal-close]');
        const backdrop = modal.querySelector('[data-modal-backdrop]');
        closeButtons.forEach((btn) => {
          btn.addEventListener('click', () => closeModal(modal));
        });
        modal.addEventListener('keydown', (event) => {
          if (event.key === 'Escape') {
            event.preventDefault();
            closeModal(modal);
          }
        });
        if (backdrop) {
          backdrop.addEventListener('click', () => closeModal(modal));
        }
      });

      modalButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const targetId = button.getAttribute('data-open-modal');
          if (!targetId) {
            return;
          }
          const modal = modals.get(targetId);
          if (!modal) {
            return;
          }
          previousFocus = button;
          const backdrop = modal.querySelector('[data-modal-backdrop]');
          modal.classList.remove('hidden');
          if (backdrop) {
            backdrop.classList.remove('hidden');
            requestAnimationFrame(() => backdrop.classList.remove('opacity-0'));
          }
          const dialog = modal.querySelector('[role="dialog"]');
          if (dialog) {
            dialog.focus();
          }
        });
      });
    })();
  </script>
{% endblock %}
