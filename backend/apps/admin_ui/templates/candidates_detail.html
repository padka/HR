{% extends "base.html" %}
{% block title %}–ö–∞–Ω–¥–∏–¥–∞—Ç {{ user.fio }}{% endblock %}
{% block content %}
<style>
  /* Liquid Glass Variables */
  :root {
    --liquid-glass-bg: linear-gradient(135deg,
      rgba(255, 255, 255, 0.05) 0%,
      rgba(255, 255, 255, 0.02) 100%);
    --liquid-glass-bg-hover: linear-gradient(135deg,
      rgba(255, 255, 255, 0.09) 0%,
      rgba(255, 255, 255, 0.04) 100%);
    --liquid-glass-border: rgba(255, 255, 255, 0.08);
    --liquid-glass-highlight: linear-gradient(180deg,
      rgba(255, 255, 255, 0.12) 0%,
      rgba(255, 255, 255, 0) 50%);
    --liquid-glass-shadow:
      0 8px 32px 0 rgba(0, 0, 0, 0.25),
      inset 0 1px 2px 0 rgba(255, 255, 255, 0.05);
    --liquid-glass-shadow-hover:
      0 16px 48px 0 rgba(0, 0, 0, 0.35),
      inset 0 1px 2px 0 rgba(255, 255, 255, 0.08);
    --liquid-glass-blur: blur(40px);
  }

  html[data-theme="light"] {
    --liquid-glass-bg: linear-gradient(135deg,
      rgba(255, 255, 255, 0.6) 0%,
      rgba(255, 255, 255, 0.4) 100%);
    --liquid-glass-bg-hover: linear-gradient(135deg,
      rgba(255, 255, 255, 0.8) 0%,
      rgba(255, 255, 255, 0.55) 100%);
    --liquid-glass-border: rgba(255, 255, 255, 0.4);
    --liquid-glass-highlight: linear-gradient(180deg,
      rgba(255, 255, 255, 0.95) 0%,
      rgba(255, 255, 255, 0) 50%);
    --liquid-glass-shadow:
      0 8px 32px 0 rgba(31, 38, 135, 0.15),
      inset 0 1px 2px 0 rgba(255, 255, 255, 0.6);
    --liquid-glass-shadow-hover:
      0 16px 48px 0 rgba(31, 38, 135, 0.22),
      inset 0 1px 2px 0 rgba(255, 255, 255, 0.75);
    --liquid-glass-blur: blur(35px);
  }

  .cards-grid {
    display: grid;
    gap: 28px;
    grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
    margin-bottom: 32px;
  }

  .candidate-card .data-list {
    display: grid;
    gap: 14px;
  }

  .candidate-card .data-list div {
    display: flex;
    justify-content: space-between;
    gap: 12px;
  }

  .candidate-card__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 16px;
    margin-bottom: 20px;
  }

  .candidate-card__header .section-hint {
    margin: 6px 0 0;
    color: var(--muted);
    font-size: 0.9rem;
  }

  .candidate-highlights {
    display: grid;
    gap: 16px;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    margin-bottom: 24px;
  }

  .candidate-highlight {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 18px;
    padding: 16px 18px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .candidate-highlight::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 100%;
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.08), transparent);
    pointer-events: none;
  }

  .candidate-highlight:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2);
    border-color: rgba(255, 255, 255, 0.12);
  }

  .candidate-highlight__label {
    font-size: 0.7rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--muted);
    font-weight: 600;
  }

  .candidate-highlight strong {
    font-size: 1.15rem;
    background: linear-gradient(135deg, var(--fg-strong), var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .candidate-highlight__meta {
    color: var(--muted);
    font-size: 0.85rem;
  }

  .data-list--split {
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  }

  .data-list--grid {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }

  .data-list--split div,
  .data-list--grid div {
    flex-direction: column;
    align-items: flex-start;
  }

  .data-list--grid dt {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: #6b7280;
  }

  .data-list--grid dd {
    font-size: 1rem;
    font-weight: 600;
  }

  .candidate-card__code {
    font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
    background: rgba(15, 23, 42, 0.06);
    padding: 2px 6px;
    border-radius: 6px;
  }

  .candidate-card__note {
    color: #6b7280;
    font-size: 0.85rem;
    margin-bottom: 16px;
  }

  .surface.mt-lg {
    margin-top: 32px;
  }

  .text-prewrap {
    white-space: pre-wrap;
  }

  .test-results-grid {
    display: grid;
    gap: 16px;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  }

  .test-result-card {
    padding: 20px;
    border-radius: 24px;
    background: var(--liquid-glass-bg);
    backdrop-filter: var(--liquid-glass-blur) saturate(200%);
    -webkit-backdrop-filter: var(--liquid-glass-blur) saturate(200%);
    border: 1px solid var(--liquid-glass-border);
    box-shadow: var(--liquid-glass-shadow);
    display: flex;
    flex-direction: column;
    gap: 14px;
    position: relative;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .test-result-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 100%;
    background: var(--liquid-glass-highlight);
    pointer-events: none;
  }
  .test-result-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--liquid-glass-shadow-hover);
    border-color: rgba(255, 255, 255, 0.12);
  }

  .test-result-card__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
  }

  .test-result-card__title {
    margin: 0;
    font-size: 1.05rem;
  }

  .test-result-card__meta {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .test-result-card__actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .test-result-card__body dl {
    display: grid;
    gap: 8px;
  }

  .test-result-card__body dl div {
    display: flex;
    justify-content: space-between;
    gap: 12px;
  }

  .test-result-card__details {
    border-top: 1px solid rgba(15, 23, 42, 0.08);
    padding-top: 12px;
  }

  .test-result-card__details summary {
    cursor: pointer;
    font-weight: 600;
    margin-bottom: 8px;
    outline: none;
  }

  .test-result-card__stats {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    font-size: 0.9rem;
    margin-bottom: 12px;
  }

  .test-result-card__stats span {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 999px;
    padding: 6px 12px;
    transition: all 0.3s ease;
  }
  .test-result-card__stats span:hover {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
    border-color: rgba(255, 255, 255, 0.1);
  }

  .test-result-card__questions .list-table th,
  .test-result-card__questions .list-table td {
    vertical-align: top;
  }

  .status-note {
    font-size: 0.85rem;
    color: #6b7280;
  }

  .test-history {
    margin-top: 16px;
    font-size: 0.9rem;
  }

  .test-history ul {
    margin: 8px 0 0;
    padding-left: 18px;
  }
</style>
{% set saved = request.query_params.get('saved') %}
{% set error = request.query_params.get('error') %}
{% if saved %}
  <div class="surface glass grain alert" data-tone="success" role="status">
    –î–∞–Ω–Ω—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.
  </div>
{% elif error %}
  <div class="surface glass grain alert" data-tone="danger" role="alert">
    –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.
  </div>
{% endif %}
<section class="page-header">
  <div>
    <a class="muted" href="/candidates">‚Üê –ö —Å–ø–∏—Å–∫—É –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤</a>
    <h1 class="page-title">{{ user.fio }}</h1>
    <p class="page-description">Telegram ID {{ user.telegram_id }} ¬∑ {{ user.city or '–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω' }}</p>
  </div>
  <div class="page-actions">
    {% if needs_intro_day %}
      <a href="/candidates/{{ user.id }}/schedule-intro-day" class="btn btn-primary">
        üìÜ –ù–∞–∑–Ω–∞—á–∏—Ç—å –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω—å
      </a>
    {% endif %}
    <form method="post" action="/candidates/{{ user.id }}/toggle">
      {% if user.is_active %}
        <input type="hidden" name="active" value="false">
        <button class="btn btn-ghost" type="submit">–û—Ç–∫–ª—é—á–∏—Ç—å</button>
      {% else %}
        <input type="hidden" name="active" value="true">
        <button class="btn btn-primary" type="submit">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
      {% endif %}
    </form>
    <form method="post" action="/candidates/{{ user.id }}/delete" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ {{ user.fio }}?');">
      <button class="btn btn-soft" type="submit">–£–¥–∞–ª–∏—Ç—å</button>
    </form>
  </div>
</section>

<div class="cards-grid">
  <article class="glass grain candidate-card">
    <header class="candidate-card__header">
      <div>
        <h2 class="section-title">–°–≤–æ–¥–∫–∞</h2>
        <p class="section-hint">–°—Ç–∞—Ç—É—Å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∏ –∫–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏.</p>
      </div>
      <span class="badge badge--soft">{{ stage or '–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞' }}</span>
    </header>
    {% set avg_score_label = '%.1f'|format(stats.average_score) if stats.average_score is not none else '‚Äî' %}
    <div class="candidate-highlights">
      <div class="candidate-highlight">
        <span class="candidate-highlight__label">–¢–µ–∫—É—â–∞—è —Å—Ç–∞–¥–∏—è</span>
        <strong>{{ stage or '–ë–µ–∑ –∏–Ω—Ç–µ—Ä–≤—å—é' }}</strong>
        <span class="candidate-highlight__meta">
          {% if user.last_activity %}
            –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å {{ fmt_local(user.last_activity, 'Europe/Moscow') }}
          {% else %}
            –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞
          {% endif %}
        </span>
      </div>
      <div class="candidate-highlight">
        <span class="candidate-highlight__label">–ë–ª–∏–∂–∞–π—à–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ</span>
        {% if upcoming_slot and upcoming_slot.start_utc %}
          <strong>{{ fmt_local(upcoming_slot.start_utc, upcoming_slot.candidate_tz or 'Europe/Moscow') }}</strong>
          <span class="candidate-highlight__meta">
            {% set slot_city = upcoming_slot.city.name if upcoming_slot.city else (user.city or '–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω') %}
            {{ slot_city }}
            {% if upcoming_slot.recruiter %}
              ¬∑ {{ upcoming_slot.recruiter.name }}
            {% endif %}
          </span>
        {% else %}
          <strong>–ù–µ—Ç –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ</strong>
          <span class="candidate-highlight__meta">–ù–∞–∑–Ω–∞—á—å—Ç–µ –∏–Ω—Ç–µ—Ä–≤—å—é –∏–ª–∏ —Ç–µ—Å—Ç, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–∞—Ç—É.</span>
        {% endif %}
      </div>
      <div class="candidate-highlight">
        <span class="candidate-highlight__label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</span>
        <strong>{{ stats.tests_total }} —Ç–µ—Å—Ç–æ–≤</strong>
        <span class="candidate-highlight__meta">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª: {{ avg_score_label }} ¬∑ –°–æ–æ–±—â–µ–Ω–∏–π: {{ messages|length }}</span>
      </div>
    </div>
    <dl class="data-list data-list--split">
      <div>
        <dt>–°—Ç–∞—Ç—É—Å</dt>
        <dd>
          {% if user.is_active %}
            <span class="badge badge--success">–ê–∫—Ç–∏–≤–µ–Ω</span>
          {% else %}
            <span class="badge badge--muted">–û—Ç–∫–ª—é—á–µ–Ω</span>
          {% endif %}
        </dd>
      </div>
      <div>
        <dt>–ì–æ—Ä–æ–¥</dt>
        <dd>{{ user.city or '‚Äî' }}</dd>
      </div>
      <div>
        <dt>–û—Ç—á—ë—Ç –¢–µ—Å—Ç 1</dt>
        <dd>
          {% if user.test1_report_url %}
            <a class="btn btn-soft btn-xs" href="/candidates/{{ user.id }}/reports/test1" download>–°–∫–∞—á–∞—Ç—å</a>
          {% else %}
            <span class="muted">–Ω–µ—Ç –æ—Ç—á—ë—Ç–∞</span>
          {% endif %}
        </dd>
      </div>
      <div>
        <dt>–û—Ç—á—ë—Ç –¢–µ—Å—Ç 2</dt>
        <dd>
          {% if user.test2_report_url %}
            <a class="btn btn-soft btn-xs" href="/candidates/{{ user.id }}/reports/test2" download>–°–∫–∞—á–∞—Ç—å</a>
          {% else %}
            <span class="muted">–Ω–µ—Ç –æ—Ç—á—ë—Ç–∞</span>
          {% endif %}
        </dd>
      </div>
      <div>
        <dt>–¢–µ–ª–µ–º–æ—Å—Ç</dt>
        <dd>
          {% if telemost_url %}
            <a class="btn btn-primary btn-xs" href="{{ telemost_url }}" target="_blank" rel="noopener noreferrer">–ü–µ—Ä–µ–π—Ç–∏</a>
            {% if telemost_source == 'upcoming' %}
              <span class="muted">–ø—Ä–µ–¥—Å—Ç–æ—è—â–µ–µ –∏–Ω—Ç–µ—Ä–≤—å—é</span>
            {% elif telemost_source == 'recent' %}
              <span class="muted">–ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–ª–æ—Ç</span>
            {% endif %}
          {% else %}
            <span class="muted">–°—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞</span>
          {% endif %}
        </dd>
      </div>
      <div>
        <dt>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</dt>
        <dd>{{ avg_score_label }}</dd>
      </div>
    </dl>
  </article>

  <article class="glass grain candidate-card candidate-card--profile">
    <header class="candidate-card__header">
      <div>
        <h2 class="section-title">–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
        <p class="section-hint">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ ‚Äî –¥–∞–Ω–Ω—ã–µ —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
      </div>
      <span class="badge badge--muted">–¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ</span>
    </header>
    <p class="candidate-card__note">–ß—Ç–æ–±—ã —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –æ–±–Ω–æ–≤–∏—Ç–µ –∫–∞—Ä—Ç–æ—á–∫—É –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –≤ –∏—Å—Ö–æ–¥–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ.</p>
    <dl class="data-list data-list--grid">
      <div>
        <dt>–§–ò–û</dt>
        <dd>{{ user.fio }}</dd>
      </div>
      <div>
        <dt>Telegram ID</dt>
        <dd>
          <span class="candidate-card__code">{{ user.telegram_id }}</span>
          {% if user.username %}
          <a class="btn btn-primary btn-xs" href="https://t.me/{{ user.username }}" target="_blank" style="margin-left: 8px;">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</a>
          {% else %}
          <span style="margin-left: 8px; font-size: 0.85em; color: #666;">(–Ω–µ—Ç username)</span>
          {% endif %}
        </dd>
      </div>
      <div>
        <dt>–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID</dt>
        <dd><span class="candidate-card__code">{{ user.id }}</span></dd>
      </div>
      <div>
        <dt>–ì–æ—Ä–æ–¥</dt>
        <dd>{{ user.city or '‚Äî' }}</dd>
      </div>
      <div>
        <dt>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</dt>
        <dd>{{ fmt_local(user.last_activity, 'Europe/Moscow') if user.last_activity else '‚Äî' }}</dd>
      </div>
      <div>
        <dt>–°—Ç–∞—Ç—É—Å</dt>
        <dd>
          {% if user.is_active %}
            <span class="badge badge--success">–ê–∫—Ç–∏–≤–µ–Ω</span>
          {% else %}
            <span class="badge badge--muted">–û—Ç–∫–ª—é—á–µ–Ω</span>
          {% endif %}
        </dd>
      </div>
    </dl>
  </article>
</div>

<section class="surface glass grain mt-lg">
  <header class="section-header">
    <h2 class="section-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</h2>
    <p class="section-hint">–°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –∏ –ø–æ–¥—Ä–æ–±–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.</p>
  </header>
  {% set status_meta = {
    'passed': {'class': 'badge badge--success', 'icon': '‚úÖ', 'label': '–ü—Ä–æ–π–¥–µ–Ω'},
    'failed': {'class': 'badge badge--warning', 'icon': '‚ùå', 'label': '–ù–µ –ø—Ä–æ–π–¥–µ–Ω'},
    'in_progress': {'class': 'badge badge--info', 'icon': '‚è≥', 'label': '–í –ø—Ä–æ—Ü–µ—Å—Å–µ'},
    'not_started': {'class': 'badge badge--muted', 'icon': '‚Äî', 'label': '–ù–µ –ø—Ä–æ—Ö–æ–¥–∏–ª'}
  } %}
  <div class="test-results-grid">
    {% for section in test_sections %}
      {% set meta = status_meta.get(section.status, status_meta['not_started']) %}
      {% set stats = section.details.stats %}
      <article class="test-result-card">
        <header class="test-result-card__header">
          <div class="test-result-card__meta">
            <h3 class="test-result-card__title">{{ section.title }}</h3>
            <span class="{{ meta.class }}">{{ meta.icon }} {{ section.status_label or meta.label }}</span>
          </div>
          <div class="test-result-card__actions">
            {% if section.report_url %}
              <a class="btn btn-soft btn-xs" href="{{ section.report_url }}" download>–°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç</a>
            {% endif %}
          </div>
        </header>
        <div class="test-result-card__body">
          <dl>
            <div>
              <dt>–°—Ç–∞—Ç—É—Å</dt>
              <dd>{{ meta.icon }} {{ section.status_label or meta.label }}</dd>
            </div>
            <div>
              <dt>–ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ</dt>
              <dd>
                {% if section.completed_at %}
                  {{ fmt_local(section.completed_at, 'Europe/Moscow') }}
                {% else %}
                  <span class="muted">‚Äî</span>
                {% endif %}
              </dd>
            </div>
            <div>
              <dt>–ö—Ä–∞—Ç–∫–æ</dt>
              <dd>{{ section.summary }}</dd>
            </div>
          </dl>
        </div>
        {% if section.pending_since %}
          <p class="status-note">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {{ fmt_local(section.pending_since, 'Europe/Moscow') }}</p>
        {% endif %}
        {% set has_details = section.details.questions|length > 0 or section.history|length > 1 %}
        {% if has_details %}
          <details class="test-result-card__details">
            <summary>–û—Ç–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏</summary>
            <div class="test-result-card__stats">
              <span>–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤: {{ stats.total_questions }}</span>
              <span>–í–µ—Ä–Ω–æ: {{ stats.correct_answers }}</span>
              {% if stats.overtime_questions %}
                <span>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: {{ stats.overtime_questions }}</span>
              {% endif %}
              {% if stats.final_score is not none %}
                <span>–ë–∞–ª–ª—ã: {{ '%.1f'|format(stats.final_score) }}</span>
              {% endif %}
              {% if stats.total_time %}
                <span>–í—Ä–µ–º—è: {{ stats.total_time }} —Å–µ–∫</span>
              {% endif %}
            </div>
            <div class="test-result-card__questions list-table-wrapper">
              <table class="list-table">
                <thead>
                  <tr>
                    <th scope="col">–í–æ–ø—Ä–æ—Å</th>
                    <th scope="col">–û—Ç–≤–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</th>
                    <th scope="col">–ü—Ä–æ–≤–µ—Ä–∫–∞</th>
                  </tr>
                </thead>
                <tbody>
                  {% for question in section.details.questions %}
                    <tr>
                      <td>
                        <strong>{{ question.question_index }}.</strong>
                        <div class="text-prewrap">{{ question.question_text }}</div>
                      </td>
                      <td class="text-prewrap">{{ question.user_answer or '‚Äî' }}</td>
                      <td>
                        {% if question.correct_answer %}
                          <div class="text-prewrap">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {{ question.correct_answer }}</div>
                        {% endif %}
                        <div>
                          {% if question.is_correct %}
                            <span class="badge badge--success">–í–µ—Ä–Ω–æ</span>
                          {% else %}
                            <span class="badge badge--muted">–ù–µ–≤–µ—Ä–Ω–æ</span>
                          {% endif %}
                          {% if question.overtime %}
                            <span class="badge badge--warning">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
                          {% endif %}
                          {% if question.attempts_count and question.attempts_count > 1 %}
                            <span class="badge badge--soft">–ü–æ–ø—ã—Ç–æ–∫: {{ question.attempts_count }}</span>
                          {% endif %}
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% if section.history|length > 1 %}
            <div class="test-history">
              <strong>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–ø—ã—Ç–æ–∫</strong>
              <ul>
                {% for item in section.history %}
                  <li>
                    {% if item.completed_at %}
                      {{ fmt_local(item.completed_at, 'Europe/Moscow') }}
                    {% else %}
                      ‚Äî
                    {% endif %}
                    ¬∑ {{ '%.1f'|format(item.final_score) if item.final_score is not none else '‚Äî' }} –±–∞–ª–ª–æ–≤
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
          </details>
        {% else %}
          <p class="muted">–î–µ—Ç–∞–ª–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∞.</p>
        {% endif %}
      </article>
    {% endfor %}
  </div>
</section>

<section class="surface glass grain mt-lg">
  <header class="section-header">
    <h2 class="section-title">–°–æ–æ–±—â–µ–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç—É</h2>
    <p class="section-hint">–û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∞–≤—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –Ω–∞ Telegram ID –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.</p>
  </header>
  {% if messages %}
    <div class="list-table-wrapper">
      <table class="list-table">
        <thead>
          <tr>
            <th scope="col">–°–æ–∑–¥–∞–Ω–æ</th>
            <th scope="col">–û—Ç–ø—Ä–∞–≤–∫–∞</th>
            <th scope="col">–¢–µ–∫—Å—Ç</th>
            <th scope="col">–°—Ç–∞—Ç—É—Å</th>
          </tr>
        </thead>
        <tbody>
        {% for msg in messages %}
          <tr>
            <td>{{ msg.created_at.strftime('%d.%m.%Y %H:%M') if msg.created_at else '‚Äî' }}</td>
            <td>{{ msg.send_time }}</td>
            <td class="text-prewrap">{{ msg.message_text }}</td>
            <td>
              {% if msg.is_active %}
                <span class="badge badge--success">–ê–∫—Ç–∏–≤–Ω–æ</span>
              {% else %}
                <span class="badge badge--muted">–û—Ç–∫–ª—é—á–µ–Ω–æ</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted">–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</p>
  {% endif %}
</section>

<section class="surface glass grain mt-lg">
  <header class="section-header">
    <h2 class="section-title">–•—Ä–æ–Ω–æ–ª–æ–≥–∏—è –¥–µ–π—Å—Ç–≤–∏–π</h2>
    <p class="section-hint">–°–æ–±—ã—Ç–∏—è –æ–±—ä–µ–¥–∏–Ω—è—é—Ç –∏–Ω—Ç–µ—Ä–≤—å—é, —Ç–µ—Å—Ç—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è.</p>
  </header>
  {% if timeline %}
    <div class="timeline">
      {% for event in timeline %}
        <article class="timeline-item">
          <div class="timeline-item__meta">{{ fmt_local(event.dt, event.tz or 'Europe/Moscow') }}</div>
          {% if event.kind == 'slot' %}
            <strong>–ò–Ω—Ç–µ—Ä–≤—å—é ¬∑ {{ event.status|upper }}</strong>
            <span class="timeline-item__meta">{{ event.recruiter or '–†–µ–∫—Ä—É—Ç—ë—Ä –Ω–µ —É–∫–∞–∑–∞–Ω' }} ¬∑ {{ event.city or '–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω' }}</span>
          {% elif event.kind == 'test' %}
            <strong>–¢–µ—Å—Ç</strong>
            <span class="timeline-item__meta">–ë–∞–ª–ª—ã: {{ event.score }} ¬∑ –†–µ–π—Ç–∏–Ω–≥ {{ event.rating }}</span>
          {% elif event.kind == 'message' %}
            <strong>–°–æ–æ–±—â–µ–Ω–∏–µ</strong>
            <span class="timeline-item__meta">–ü–ª–∞–Ω: {{ event.send_time }}{% if not event.is_active %} ¬∑ –æ—Ç–∫–ª—é—á–µ–Ω–æ{% endif %}</span>
            <span class="text-prewrap">{{ event.text }}</span>
          {% endif %}
        </article>
      {% endfor %}
    </div>
  {% else %}
    <p class="muted">–°–æ–±—ã—Ç–∏—è –µ—â—ë –Ω–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã.</p>
  {% endif %}
</section>
{% endblock %}
