{% extends "base.html" %}
{% block title %}{{ user.fio }}{% endblock %}
{% block content %}
  {% set query_status = request.query_params.get('status') %}
  {% set query_notice = request.query_params.get('notice') %}
  {% if query_status %}
    {% set tone = {'success': 'success', 'error': 'danger', 'info': 'info'}.get(query_status, 'info') %}
    {% set default_notice = 'Тест 2 отправлен' if query_status == 'success' else ('Операция выполнена' if query_status == 'info' else 'Не удалось выполнить действие') %}
    <div class="surface glass grain alert" data-tone="{{ tone }}" role="alert">
      <p>{{ query_notice or default_notice }}</p>
    </div>
  {% endif %}

  <section class="page-header">
    <div>
      <a class="muted" href="/candidates">← К списку кандидатов</a>
      <h1 class="page-title">{{ user.fio }}</h1>
      <p class="page-description">Telegram ID {{ user.telegram_id }}</p>
    </div>
  </section>

  <div class="page-grid" data-page="candidate" aria-labelledby="candidate-summary">
    <div class="page-main">
      <section class="surface" aria-labelledby="candidate-summary">
        <header class="flex flex-col gap-2">
          <h2 id="candidate-summary" class="section-title">Сводка</h2>
          <p class="muted text-sm">Собрали ключевые параметры по кандидату на одном экране.</p>
        </header>
        <dl class="grid gap-4 md:grid-cols-3">
          <div>
            <dt class="muted text-sm">Статус</dt>
            <dd>
              {% if user.is_active %}
                <span class="badge badge--success">Активен</span>
              {% else %}
                <span class="badge badge--muted">Отключен</span>
              {% endif %}
            </dd>
          </div>
          <div>
            <dt class="muted text-sm">Город</dt>
            <dd>{{ user.city or 'Город не указан' }}</dd>
          </div>
          <div>
            <dt class="muted text-sm">Последняя активность</dt>
            <dd>
              {% if user.last_activity %}
                {{ fmt_local(user.last_activity, 'Europe/Moscow') }}
              {% else %}
                —
              {% endif %}
            </dd>
          </div>
          <div>
            <dt class="muted text-sm">Всего тестов</dt>
            <dd>{{ stats.tests_total }}</dd>
          </div>
          <div>
            <dt class="muted text-sm">Средний балл</dt>
            <dd>{{ '%.1f'|format(stats.average_score) if stats.average_score is not none else '—' }}</dd>
          </div>
          <div>
            <dt class="muted text-sm">Текущий этап</dt>
            <dd>{{ stage }}</dd>
          </div>
        </dl>
        {% if test_stage_summary %}
          <div class="mt-4">
            <h3 class="muted text-sm">Этапы тестов</h3>
            <ul class="stage-flow" role="list">
              {% for item in test_stage_summary %}
                <li>
                  <strong>{{ item.label }}</strong>
                  — {{ item.score }}{% if item.rating %} ({{ item.rating }}){% endif %}
                  {% if item.dt %}
                    — {{ fmt_local(item.dt, 'Europe/Moscow') }}
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      </section>

      <section class="surface" aria-labelledby="interview-title">
        <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div>
            <h2 id="interview-title" class="section-title">Интервью</h2>
            {% if latest_interview and latest_interview.start_utc %}
              <p class="muted text-sm">{{ fmt_local(latest_interview.start_utc, latest_interview.candidate_tz or 'Europe/Moscow') }}</p>
            {% else %}
              <p class="muted text-sm">Интервью пока не запланировано.</p>
            {% endif %}
          </div>
          {% if latest_interview and latest_interview.recruiter and latest_interview.recruiter.telemost_url %}
            <a class="btn btn-primary btn-sm" href="{{ latest_interview.recruiter.telemost_url }}" target="_blank" rel="noopener">Перейти в конференцию</a>
          {% endif %}
        </header>

        {% if latest_interview %}
          <form class="flex flex-wrap gap-3 mt-4" method="post" action="/candidates/{{ user.id }}/slots/{{ latest_interview.id }}/outcome">
            <button class="btn btn-primary btn-sm" type="submit" name="outcome" value="success">Прошёл</button>
            <button class="btn btn-soft btn-sm" type="submit" name="outcome" value="reject">Не прошёл</button>
          </form>

          {% set progress = namespace(total=interview_script|length, completed=0) %}
          {% set steps_state = namespace(items=[]) %}
          {% for step in interview_script %}
            {% set is_checked = False %}
            {% if interview_feedback.checklist %}
              {% set stored = interview_feedback.checklist.get(step.id) %}
              {% if stored is not none %}
                {% set is_checked = stored %}
              {% else %}
                {% set as_string = interview_feedback.checklist.get(step.id|string) %}
                {% if as_string is not none %}{% set is_checked = as_string %}{% endif %}
              {% endif %}
            {% endif %}
            {% if is_checked %}{% set progress.completed = progress.completed + 1 %}{% endif %}
            {% set _ = steps_state.items.append({'data': step, 'checked': is_checked}) %}
          {% endfor %}

          <form class="mt-6 flex flex-col gap-4" method="post" action="/candidates/{{ user.id }}/interview-feedback">
            <input type="hidden" name="slot_id" value="{{ latest_interview.id }}">
            <fieldset class="flex flex-col gap-3">
              <legend class="section-title text-base flex items-center justify-between gap-2">
                <span>Сценарий интервью</span>
                {% if progress.total %}
                  <span class="badge badge--soft text-xs">Выполнено {{ progress.completed }}/{{ progress.total }}</span>
                {% endif %}
              </legend>
              {% for step_state in steps_state.items %}
                {% set step = step_state.data %}
                {% set is_checked = step_state.checked %}
                <label class="panel panel--flush">
                  <div class="flex items-start gap-3">
                    <input id="interview-step-{{ step.id }}" name="checklist[]" value="{{ step.id }}" type="checkbox" {% if is_checked %}checked{% endif %}>
                    <div>
                      <span class="font-semibold">{{ step.title }}</span>
                      <p class="muted text-sm">{{ step.description }}</p>
                    </div>
                  </div>
                </label>
              {% endfor %}
            </fieldset>
            <label class="flex flex-col gap-2">
              <span class="section-title text-base">Заметки</span>
              <textarea class="textarea" name="notes" placeholder="Что важно запомнить для следующего этапа?">{{ interview_feedback.notes or '' }}</textarea>
            </label>
            <div class="flex items-center justify-between text-sm muted">
              {% if interview_feedback.updated_at %}
                <span>Обновлено {{ fmt_local(interview_feedback.updated_at, latest_interview.candidate_tz or 'Europe/Moscow') }}</span>
              {% endif %}
              <div class="flex items-center gap-3">
                {% if progress.total %}
                  <span>{{ progress.completed }}/{{ progress.total }} шагов</span>
                {% endif %}
                <button class="btn btn-soft btn-sm" type="submit">Сохранить</button>
              </div>
            </div>
          </form>
        {% endif %}
      </section>

      <section class="surface" aria-labelledby="tests-title">
        <header class="flex items-center justify-between">
          <h2 id="tests-title" class="section-title">Результаты тестов</h2>
          <span class="muted text-sm">{{ stats.tests_total }} попыток</span>
        </header>
        {% if tests %}
          <div class="table__wrap mt-4">
            <table class="table list-table">
              <thead>
                <tr>
                  <th scope="col">Дата</th>
                  <th scope="col">Баллы</th>
                  <th scope="col">Рейтинг</th>
                  <th scope="col">Время (сек)</th>
                  <th scope="col">Ответы</th>
                </tr>
              </thead>
              <tbody>
                {% for result in tests %}
                  {% set answers = answers_map.get(result.id) %}
                  <tr>
                    <td data-label="Дата">{{ fmt_local(result.created_at, 'Europe/Moscow') }}</td>
                    <td data-label="Баллы">{{ result.final_score }} / {{ result.raw_score }}</td>
                    <td data-label="Рейтинг">{{ result.rating or '—' }}</td>
                    <td data-label="Время">{{ result.total_time }}</td>
                    <td data-label="Ответы">
                      {% if answers %}
                        <button
                          type="button"
                          class="btn btn-soft btn-sm"
                          data-answer-modal-target="answers-modal"
                          data-answer-modal-payload="{{ {
                            'title': fmt_local(result.created_at, 'Europe/Moscow'),
                            'score': result.final_score,
                            'raw_score': result.raw_score,
                            'rating': result.rating,
                            'total_time': result.total_time,
                            'summary': {
                              'correct': answers.questions_correct,
                              'total': answers.questions_total,
                              'overtime': answers.questions_overtime,
                            },
                            'questions': answers.questions,
                          } | tojson }}"
                          aria-haspopup="dialog"
                          aria-controls="answers-modal"
                        >
                          Посмотреть ответы
                        </button>
                      {% else %}
                        <span class="muted">—</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="muted mt-4">Кандидат ещё не проходил тесты.</p>
        {% endif %}
      </section>

      <div class="modal" id="answers-modal" data-answer-modal hidden>
        <div
          class="modal__dialog"
          role="dialog"
          aria-modal="true"
          aria-labelledby="answers-modal-title"
          aria-describedby="answers-modal-description"
          tabindex="-1"
        >
          <div class="flex items-start justify-between gap-3">
            <div>
              <h3 id="answers-modal-title" class="section-title">Ответы теста</h3>
              <p id="answers-modal-description" class="muted text-sm">Детализация ответов кандидата.</p>
            </div>
            <button type="button" class="btn btn-ghost btn-sm" data-answer-modal-close aria-label="Закрыть модальное окно">Закрыть</button>
          </div>
          <div class="modal__body" data-answer-modal-body tabindex="0">
            <ol class="flex flex-col gap-4" data-answer-modal-list role="list"></ol>
          </div>
        </div>
      </div>

      {% if latest_interview and latest_interview.interview_outcome == 'success' and test2_completed %}
        <section class="surface" aria-labelledby="intro-day-title">
          <header>
            <h2 id="intro-day-title" class="section-title">Ознакомительный день</h2>
            <p class="muted text-sm">Отправьте кандидату приглашение с датой и временем.</p>
          </header>
          <form class="mt-4 flex flex-col gap-4" method="post" action="/candidates/{{ user.id }}/intro-day">
            <div class="grid gap-4 md:grid-cols-2">
              <label class="flex flex-col gap-2">
                <span class="muted text-sm">Дата</span>
                <input class="input" type="date" name="date_value" required>
              </label>
              <label class="flex flex-col gap-2">
                <span class="muted text-sm">Время</span>
                <input class="input" type="time" name="time_value" required>
              </label>
            </div>
            <label class="flex flex-col gap-2">
              <span class="muted text-sm">Сообщение кандидату</span>
              <textarea class="textarea" name="message_text" placeholder="{{ intro_message_template|format(fio=user.fio, date='дд.мм.гггг', time='чч:мм') }}"></textarea>
            </label>
            <div class="flex justify-end">
              <button class="btn btn-primary btn-sm" type="submit">Отправить приглашение</button>
            </div>
          </form>
        </section>
      {% endif %}
    </div>

    <aside class="page-aside" id="history">
      <section class="surface" aria-labelledby="history-title">
        <header>
          <h2 id="history-title" class="section-title">История событий</h2>
        </header>
        {% if timeline %}
          <ol class="flex flex-col gap-3 text-sm" role="list">
            {% for event in timeline %}
              <li class="panel panel--flush">
                <div class="flex items-center justify-between muted text-xs uppercase tracking-wide">
                  <span>
                    {% if event.kind == 'slot' %}
                      Интервью
                    {% elif event.kind == 'test' %}
                      Тест
                    {% elif event.kind == 'message' %}
                      Сообщение
                    {% else %}
                      Событие
                    {% endif %}
                  </span>
                  <time datetime="{{ event.dt.isoformat() if event.dt }}">{{ fmt_local(event.dt, event.tz or 'Europe/Moscow') if event.dt else '—' }}</time>
                </div>
                <div class="mt-2 space-y-1">
                  {% if event.kind == 'slot' %}
                    <p>Статус: {{ (event.status or '')|upper }}</p>
                    {% if event.recruiter %}<p>Рекрутёр: {{ event.recruiter }}</p>{% endif %}
                    {% if event.city %}<p>Город: {{ event.city }}</p>{% endif %}
                  {% elif event.kind == 'test' %}
                    <p>Баллы: {{ event.score }} ({{ event.rating or '—' }})</p>
                  {% elif event.kind == 'message' %}
                    <p class="whitespace-pre-line">{{ event.text }}</p>
                    {% if event.send_time %}<p class="muted text-xs">Запланировано: {{ event.send_time }}</p>{% endif %}
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          </ol>
        {% else %}
          <p class="muted text-sm mt-4">История пока пуста.</p>
        {% endif %}
      </section>
    </aside>
  </div>
{% endblock %}

{% block extra_js %}
  <script>
    (function () {
      const triggers = document.querySelectorAll('[data-answer-modal-target]');
      const modal = document.querySelector('[data-answer-modal]');
      if (!modal) {
        return;
      }

      const dialog = modal.querySelector('[role="dialog"]');
      const closeButtons = modal.querySelectorAll('[data-answer-modal-close]');
      const list = modal.querySelector('[data-answer-modal-list]');
      const modalBody = modal.querySelector('[data-answer-modal-body]');
      const titleEl = modal.querySelector('#answers-modal-title');
      const descriptionEl = modal.querySelector('#answers-modal-description');
      let lastTrigger = null;

      const displayValue = (value) => {
        if (value === 0 || value === '0') {
          return '0';
        }
        if (value === undefined || value === null) {
          return '—';
        }
        const stringified = `${value}`.trim();
        return stringified === '' ? '—' : stringified;
      };

      const formatSummary = (summary, payload) => {
        if (!summary) {
          return '';
        }
        const parts = [];
        parts.push(`Правильных: ${displayValue(summary.correct)} из ${displayValue(summary.total)}`);
        if (summary.overtime) {
          parts.push(`просрочено: ${summary.overtime}`);
        }
        if (payload.score !== undefined && payload.raw_score !== undefined) {
          parts.push(`баллы: ${displayValue(payload.score)} / ${displayValue(payload.raw_score)}`);
        }
        if (payload.rating !== undefined && payload.rating !== null && `${payload.rating}`.trim() !== '') {
          parts.push(`рейтинг: ${payload.rating}`);
        }
        if (payload.total_time !== undefined && payload.total_time !== null && `${payload.total_time}`.trim() !== '') {
          parts.push(`время: ${payload.total_time} сек`);
        }
        return parts.join(' · ');
      };

      const renderAnswers = (payload) => {
        if (!list) {
          return;
        }
        list.innerHTML = '';
        if (!payload || !Array.isArray(payload.questions) || payload.questions.length === 0) {
          const emptyState = document.createElement('li');
          emptyState.className = 'muted';
          emptyState.textContent = 'Ответы недоступны.';
          list.appendChild(emptyState);
          return;
        }

        payload.questions.forEach((question, index) => {
          const item = document.createElement('li');
          item.className = 'flex flex-col gap-2';

          const header = document.createElement('div');
          header.className = 'flex flex-wrap items-center gap-2';
          const title = document.createElement('span');
          title.className = 'font-semibold';
          title.textContent = `Вопрос ${index + 1}: ${question.question_text || ''}`;
          header.appendChild(title);

          const statusBadge = document.createElement('span');
          statusBadge.className = question.is_correct ? 'badge badge--success' : 'badge badge--muted';
          statusBadge.textContent = question.is_correct ? 'Верно' : 'Неверно';
          header.appendChild(statusBadge);

          if (question.overtime) {
            const overtimeBadge = document.createElement('span');
            overtimeBadge.className = 'badge badge--soft';
            overtimeBadge.textContent = 'Просрочено';
            header.appendChild(overtimeBadge);
          }

          item.appendChild(header);

          const userAnswer = document.createElement('p');
          const userAnswerLabel = document.createElement('span');
          userAnswerLabel.textContent = 'Ответ кандидата: ';
          const userAnswerValue = document.createElement('strong');
          userAnswerValue.textContent = question.user_answer || '—';
          userAnswer.appendChild(userAnswerLabel);
          userAnswer.appendChild(userAnswerValue);
          item.appendChild(userAnswer);

          if (!question.is_correct && question.correct_answer) {
            const correctAnswer = document.createElement('p');
            const correctAnswerLabel = document.createElement('span');
            correctAnswerLabel.textContent = 'Правильный ответ: ';
            const correctAnswerValue = document.createElement('strong');
            correctAnswerValue.textContent = question.correct_answer;
            correctAnswer.appendChild(correctAnswerLabel);
            correctAnswer.appendChild(correctAnswerValue);
            item.appendChild(correctAnswer);
          }

          const meta = document.createElement('p');
          meta.className = 'muted text-sm';
          const attempts = question.attempts_count !== undefined && question.attempts_count !== null ? question.attempts_count : '—';
          const timeSpent = question.time_spent !== undefined && question.time_spent !== null ? question.time_spent : '—';
          meta.textContent = `Время: ${timeSpent} сек · Попытки: ${attempts}`;
          item.appendChild(meta);

          list.appendChild(item);
        });
      };

      const openModal = (payload, trigger) => {
        if (!dialog) {
          return;
        }
        lastTrigger = trigger;
        const title = payload && payload.title ? `Ответы теста от ${payload.title}` : 'Ответы теста';
        if (titleEl) {
          titleEl.textContent = title;
        }
        if (descriptionEl) {
          const summaryText = formatSummary(payload && payload.summary, payload || {});
          descriptionEl.textContent = summaryText || 'Детализация ответов кандидата.';
        }
        renderAnswers(payload);
        modal.removeAttribute('hidden');
        dialog.focus();
        if (modalBody) {
          modalBody.scrollTop = 0;
        }
        document.body.style.overflow = 'hidden';
      };

      const closeModal = () => {
        modal.setAttribute('hidden', '');
        document.body.style.overflow = '';
        if (lastTrigger) {
          lastTrigger.focus();
          lastTrigger = null;
        }
      };

      closeButtons.forEach((button) => {
        button.addEventListener('click', closeModal);
      });

      modal.addEventListener('click', (event) => {
        if (event.target === modal) {
          closeModal();
        }
      });

      if (dialog) {
        dialog.addEventListener('click', (event) => {
          event.stopPropagation();
        });
        dialog.addEventListener('keydown', (event) => {
          if (event.key === 'Escape') {
            event.preventDefault();
            closeModal();
          }
        });
      }

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && !modal.hasAttribute('hidden')) {
          event.preventDefault();
          closeModal();
        }
      });

      triggers.forEach((trigger) => {
        trigger.addEventListener('click', () => {
          const payloadRaw = trigger.getAttribute('data-answer-modal-payload');
          if (!payloadRaw) {
            return;
          }
          try {
            const payload = JSON.parse(payloadRaw);
            openModal(payload, trigger);
          } catch (error) {
            console.error('Не удалось открыть модалку ответов', error);
          }
        });
      });
    })();
  </script>
{% endblock %}
