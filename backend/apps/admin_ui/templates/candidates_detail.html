{% extends "base.html" %}
{% from "page_primitives.html" import page_header, metric_grid, table_shell, toast, form_section, empty_state %}
{% block title %}{{ user.fio }}{% endblock %}
{% block content %}
  {% set query_status = request.query_params.get('status') %}
  {% set query_notice = request.query_params.get('notice') %}
  {% if query_status %}
    {% set tone = {'success': 'success', 'error': 'danger', 'info': 'info'}.get(query_status, 'info') %}
    {% set default_notice = 'Тест 2 отправлен' if query_status == 'success' else ('Операция выполнена' if query_status == 'info' else 'Не удалось выполнить действие') %}
    {{ toast(query_notice or default_notice, tone=tone, dismissible=True) }}
  {% endif %}

  {% set breadcrumbs = [
    {'label': 'Кандидаты', 'url': '/candidates'},
    {'label': user.fio}
  ] %}
  {% set summary_badges = [
    {'tone': 'success' if user.is_active else 'muted', 'label': 'Статус: ' ~ ('Активен' if user.is_active else 'Отключен')},
    {'tone': 'info', 'label': 'Этап: ' ~ stage},
    {'tone': 'soft', 'label': 'Тестов: ' ~ stats.tests_total}
  ] %}
  {% set header_meta = 'Последняя активность: ' ~ (fmt_local(user.last_activity, 'Europe/Moscow') if user.last_activity else '—') %}

  {% call page_header(
    title=user.fio,
    eyebrow='Кандидат',
    description='Telegram ID ' ~ user.telegram_id ~ ((' · ' ~ user.city) if user.city else ''),
    meta=header_meta,
    badges=summary_badges,
    trail=breadcrumbs
  ) %}
    <div class="header-actions">
      <a class="btn btn-ghost btn-sm" href="/candidates">Назад к списку</a>
    </div>
  {% endcall %}

<<<<<<< HEAD
  {% set summary_cards = [
    {'label': 'Всего тестов', 'value': stats.tests_total, 'meta': 'Средний балл: ' ~ ('%.1f'|format(stats.average_score) if stats.average_score is not none else '—')},
    {'label': 'Последнее интервью', 'value': fmt_local(latest_interview.start_utc, latest_interview.candidate_tz or 'Europe/Moscow') if latest_interview and latest_interview.start_utc else 'Не назначено', 'meta': latest_interview.recruiter.name if latest_interview and latest_interview.recruiter else ''},
    {'label': 'Сообщений за всё время', 'value': timeline|length, 'meta': 'История событий'}
  ] %}
  {{ metric_grid(items=summary_cards, class_name='metrics-overview') }}

  <div class="page-columns" id="candidate-summary" aria-live="polite">
    <div class="page-columns__main">
      <section class="surface panel" aria-labelledby="interview-title">
        <header class="panel__header">
=======
  <div class="page-grid" data-page="candidate" aria-labelledby="candidate-summary">
    <div class="page-main">
      <!-- Сводка -->
      <section class="surface" aria-labelledby="candidate-summary">
        <header class="flex flex-col gap-2">
          <h2 id="candidate-summary" class="section-title">Сводка</h2>
          <p class="muted text-sm">Собрали ключевые параметры по кандидату на одном экране.</p>
        </header>
        <dl class="grid gap-4 md:grid-cols-3">
          <div>
            <dt class="muted text-sm">Статус</dt>
            <dd>
              {% if user.is_active %}
                <span class="badge badge--success">Активен</span>
              {% else %}
                <span class="badge badge--muted">Отключен</span>
              {% endif %}
            </dd>
          </div>
          <div>
            <dt class="muted text-sm">Город</dt>
            <dd>{{ user.city or 'Город не указан' }}</dd>
          </div>
          <div>
            <dt class="muted text-sm">Последняя активность</dt>
            <dd>
              {% if user.last_activity %}
                {{ fmt_local(user.last_activity, 'Europe/Moscow') }}
              {% else %}
                —
              {% endif %}
            </dd>
          </div>
          <div>
            <dt class="muted text-sm">Всего тестов</dt>
            <dd>{{ stats.tests_total }}</dd>
          </div>
          <div>
            <dt class="muted text-sm">Средний балл</dt>
            <dd>{{ '%.1f'|format(stats.average_score) if stats.average_score is not none else '—' }}</dd>
          </div>
          <div>
            <dt class="muted text-sm">Текущий этап</dt>
            <dd>{{ stage }}</dd>
          </div>
        </dl>

        {% if test_stage_summary %}
          <div class="mt-4">
            <h3 class="muted text-sm">Этапы тестов</h3>
            <ul class="stage-flow" role="list">
              {% for item in test_stage_summary %}
                <li>
                  <strong>{{ item.label }}</strong>
                  — {{ item.score }}{% if item.rating %} ({{ item.rating }}){% endif %}
                  {% if item.dt %} — {{ fmt_local(item.dt, 'Europe/Moscow') }}{% endif %}
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      </section>

      <!-- Интервью -->
      <section class="surface" aria-labelledby="interview-title">
        <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
>>>>>>> 0577ef36064e13a8c9bb54a4ac5472a8685ccce7
          <div>
            <h2 id="interview-title" class="section-title">Интервью</h2>
            {% if latest_interview and latest_interview.start_utc %}
              <p class="muted">{{ fmt_local(latest_interview.start_utc, latest_interview.candidate_tz or 'Europe/Moscow') }}</p>
            {% else %}
              <p class="muted">Интервью пока не запланировано.</p>
            {% endif %}
          </div>
          {% if latest_interview and latest_interview.recruiter and latest_interview.recruiter.telemost_url %}
            <a class="btn btn-primary btn-sm" href="{{ latest_interview.recruiter.telemost_url }}" target="_blank" rel="noopener">Перейти в конференцию</a>
          {% endif %}
        </header>

        {% if latest_interview %}
<<<<<<< HEAD
          <div class="panel__actions">
            <form class="inline-form" method="post" action="/candidates/{{ user.id }}/slots/{{ latest_interview.id }}/outcome">
              <input type="hidden" name="outcome" value="success">
              <button class="btn btn-primary btn-sm" type="submit" data-outcome-button data-outcome="success">Прошёл</button>
            </form>
            <form class="inline-form" method="post" action="/candidates/{{ user.id }}/slots/{{ latest_interview.id }}/outcome">
              <input type="hidden" name="outcome" value="reject">
              <button class="btn btn-danger btn-sm" type="submit" data-outcome-button data-outcome="reject">Не прошёл</button>
            </form>
          </div>

          {% set raw_checklist = interview_feedback.checklist %}
          {% if raw_checklist is mapping %}
            {% set checklist_map = raw_checklist %}
            {% set checklist_list = [] %}
          {% elif raw_checklist %}
            {% set checklist_map = {} %}
            {% set checklist_list = raw_checklist %}
          {% else %}
            {% set checklist_map = {} %}
            {% set checklist_list = [] %}
          {% endif %}
          {% set checklist_ids = namespace(ids=[]) %}
          {% if checklist_map %}
            {% for key, value in checklist_map.items() %}
              {% if value %}
                {% set checklist_ids.ids = checklist_ids.ids + [key|string] %}
              {% endif %}
            {% endfor %}
          {% elif checklist_list %}
            {% for value in checklist_list %}
              {% set checklist_ids.ids = checklist_ids.ids + [value|string] %}
            {% endfor %}
          {% endif %}
          {% set total_steps = interview_script|length %}
          {% set checked_count = checklist_ids.ids|length %}

          <form class="interview-script" method="post" action="/candidates/{{ user.id }}/interview-feedback" data-interview-form>
            <input type="hidden" name="slot_id" value="{{ latest_interview.id }}">
            <div class="interview-script__header">
              <h3 class="section-title">Сценарий интервью</h3>
              <span class="pill pill--soft">Прогресс: <strong data-interview-progress>{{ checked_count }}/{{ total_steps }}</strong></span>
            </div>
            <div class="interview-script__list">
              {% for step in interview_script %}
                {% set is_checked = step.id|string in checklist_ids.ids %}
                <label class="interview-step surface{% if is_checked %} is-complete{% endif %}">
                  <span class="interview-step__checkbox">
=======
          <!-- Итог интервью -->
          <form class="flex flex-wrap gap-3 mt-4" method="post" action="/candidates/{{ user.id }}/slots/{{ latest_interview.id }}/outcome">
            <button class="btn btn-primary btn-sm" type="submit" name="outcome" value="success">Прошёл</button>
            <button class="btn btn-danger btn-sm" type="submit" name="outcome" value="reject">Не прошёл</button>
          </form>

          <!-- Прогресс чеклиста -->
          {% set progress = namespace(total=interview_script|length, completed=0) %}
          {% set steps_state = namespace(items=[]) %}
          {% for step in interview_script %}
            {% set is_checked = False %}
            {% if interview_feedback and interview_feedback.checklist %}
              {% set stored = interview_feedback.checklist.get(step.id) %}
              {% if stored is not none %}
                {% set is_checked = stored %}
              {% else %}
                {% set as_string = interview_feedback.checklist.get(step.id|string) %}
                {% if as_string is not none %}{% set is_checked = as_string %}{% endif %}
              {% endif %}
            {% endif %}
            {% if is_checked %}{% set progress.completed = progress.completed + 1 %}{% endif %}
            {% set _ = steps_state.items.append({'data': step, 'checked': is_checked}) %}
          {% endfor %}

          <!-- Скрипт интервью -->
          <form class="mt-6 flex flex-col gap-4" method="post" action="/candidates/{{ user.id }}/interview-feedback">
            <input type="hidden" name="slot_id" value="{{ latest_interview.id }}">
            <fieldset class="flex flex-col gap-3">
              <legend class="section-title text-base flex items-center justify-between gap-2">
                <span>Сценарий интервью</span>
                {% if progress.total %}
                  <span class="badge badge--soft text-xs">Выполнено {{ progress.completed }}/{{ progress.total }}</span>
                {% endif %}
              </legend>

              {% for step_state in steps_state.items %}
                {% set step = step_state.data %}
                {% set is_checked = step_state.checked %}
                <label class="panel panel--flush">
                  <div class="flex items-start gap-3">
>>>>>>> 0577ef36064e13a8c9bb54a4ac5472a8685ccce7
                    <input id="interview-step-{{ step.id }}" name="checklist[]" value="{{ step.id }}" type="checkbox" {% if is_checked %}checked{% endif %}>
                  </span>
                  <div class="interview-step__body">
                    <span class="interview-step__title">{{ step.title }}</span>
                    <p class="muted">{{ step.description }}</p>
                  </div>
                </label>
              {% endfor %}
<<<<<<< HEAD
            </div>
            <label class="form-field">
              <span class="form-field__label">Заметки</span>
              <textarea class="textarea" name="notes" placeholder="Что важно отметить?" rows="4">{{ interview_feedback.notes or '' }}</textarea>
            </label>
            <div class="form-footer">
              {% if interview_feedback.updated_at %}
                <span class="muted">Обновлено {{ interview_feedback.updated_at }}</span>
=======
            </fieldset>

            <label class="flex flex-col gap-2">
              <span class="section-title text-base">Заметки</span>
              <textarea class="textarea" name="notes" placeholder="Впечатления, риски, договорённости">{{ interview_feedback.notes or '' }}</textarea>
            </label>

            <div class="flex items-center justify-between text-sm muted">
              {% if interview_feedback and interview_feedback.updated_at %}
                <span>Обновлено {{ fmt_local(interview_feedback.updated_at, latest_interview.candidate_tz or 'Europe/Moscow') }}</span>
>>>>>>> 0577ef36064e13a8c9bb54a4ac5472a8685ccce7
              {% endif %}
              <div class="flex items-center gap-3">
                {% if progress.total %}
                  <span>{{ progress.completed }}/{{ progress.total }} шагов</span>
                {% endif %}
                <button class="btn btn-soft btn-sm" type="submit">Сохранить</button>
              </div>
            </div>
          </form>
        {% endif %}
      </section>

<<<<<<< HEAD
      <section class="surface panel" aria-labelledby="tests-title">
        <header class="panel__header">
=======
      <!-- Результаты тестов -->
      <section class="surface" aria-labelledby="tests-title">
        <header class="flex items-center justify-between">
>>>>>>> 0577ef36064e13a8c9bb54a4ac5472a8685ccce7
          <h2 id="tests-title" class="section-title">Результаты тестов</h2>
          <span class="muted">{{ stats.tests_total }} попыток</span>
        </header>

        {% if tests %}
<<<<<<< HEAD
          {% set columns = [
            {'label': 'Дата'},
            {'label': 'Баллы'},
            {'label': 'Рейтинг'},
            {'label': 'Время (сек)'},
            {'label': 'Ответы', 'class': 'col-actions'}
          ] %}
          {% call table_shell(columns=columns, caption='Результаты тестов кандидата', table_id='candidate-tests') %}
            {% for result in tests %}
              {% set answers = answers_map.get(result.id) %}
              <tr>
                <td data-label="Дата">{{ fmt_local(result.created_at, 'Europe/Moscow') }}</td>
                <td data-label="Баллы">{{ result.final_score }} / {{ result.raw_score }}</td>
                <td data-label="Рейтинг">{{ result.rating or '—' }}</td>
                <td data-label="Время">{{ result.total_time }}</td>
                <td data-label="Ответы" class="table-actions">
                  {% if answers %}
                    {% set payload = {
                      'title': 'Ответы теста от ' ~ fmt_local(result.created_at, 'Europe/Moscow'),
                      'stats': {
                        'total': answers.questions_total,
                        'correct': answers.questions_correct,
                        'overtime': answers.questions_overtime
                      },
                      'questions': answers.questions
                    } %}
                    <button
                      type="button"
                      class="btn btn-soft btn-sm"
                      data-answer-modal-trigger
                      data-answer-modal-payload='{{ payload | tojson }}'
                      aria-haspopup="dialog"
                    >
                      Посмотреть ответы
                    </button>
                  {% else %}
                    <span class="muted">—</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% endcall %}
=======
          <div class="table__wrap mt-4">
            <table class="table list-table">
              <thead>
                <tr>
                  <th scope="col">Дата</th>
                  <th scope="col">Баллы</th>
                  <th scope="col">Рейтинг</th>
                  <th scope="col">Время (сек)</th>
                  <th scope="col">Ответы</th>
                </tr>
              </thead>
              <tbody>
                {% for result in tests %}
                  {% set answers = answers_map.get(result.id) %}
                  <tr>
                    <td data-label="Дата">{{ fmt_local(result.created_at, 'Europe/Moscow') }}</td>
                    <td data-label="Баллы"><strong>{{ result.final_score }}</strong> / {{ result.raw_score }}</td>
                    <td data-label="Рейтинг">{{ result.rating or '—' }}</td>
                    <td data-label="Время">{{ result.total_time }}</td>
                    <td data-label="Ответы">
                      {% if answers %}
                        <button
                          type="button"
                          class="btn btn-soft btn-sm"
                          data-answer-modal-target="answers-modal"
                          data-answer-modal-payload="{{ {
                            'title': fmt_local(result.created_at, 'Europe/Moscow'),
                            'score': result.final_score,
                            'raw_score': result.raw_score,
                            'rating': result.rating,
                            'total_time': result.total_time,
                            'summary': {
                              'correct': answers.questions_correct,
                              'total': answers.questions_total,
                              'overtime': answers.questions_overtime,
                            },
                            'questions': answers.questions or []
                          } | tojson }}"
                          aria-haspopup="dialog"
                          aria-controls="answers-modal"
                        >
                          Посмотреть ответы
                        </button>
                      {% else %}
                        <span class="muted">—</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
>>>>>>> 0577ef36064e13a8c9bb54a4ac5472a8685ccce7
        {% else %}
          <p class="muted">Кандидат ещё не проходил тесты.</p>
        {% endif %}
      </section>

      <!-- Модалка детальных ответов (общая) -->
      <div class="modal" id="answers-modal" data-answer-modal hidden>
        <div
          class="modal__dialog"
          role="dialog"
          aria-modal="true"
          aria-labelledby="answers-modal-title"
          aria-describedby="answers-modal-description"
          tabindex="-1"
        >
          <div class="flex items-start justify-between gap-3">
            <div>
              <h3 id="answers-modal-title" class="section-title">Ответы теста</h3>
              <p id="answers-modal-description" class="muted text-sm">Детализация ответов кандидата.</p>
            </div>
            <button type="button" class="btn btn-ghost btn-sm" data-answer-modal-close aria-label="Закрыть модальное окно">Закрыть</button>
          </div>
          <div class="modal__body" data-answer-modal-body tabindex="0">
            <ol class="flex flex-col gap-4" data-answer-modal-list role="list"></ol>
          </div>
          <div class="flex justify-end mt-3">
            <button type="button" class="btn btn-soft btn-sm" data-answer-modal-close>Закрыть</button>
          </div>
        </div>
      </div>

      <!-- Ознакомительный день (после успешного интервью и завершённого Тест 2) -->
      {% if latest_interview and latest_interview.interview_outcome == 'success' and test2_completed %}
        <section class="surface panel" aria-labelledby="intro-day-title">
          <header class="panel__header">
            <div>
              <h2 id="intro-day-title" class="section-title">Ознакомительный день</h2>
              <p class="muted">Пригласите кандидата на ознакомительный день.</p>
            </div>
          </header>
          <form class="form-grid" method="post" action="/candidates/{{ user.id }}/intro-day">
            <div class="grid-cols">
              <label class="form-field">
                <span class="form-field__label">Дата</span>
                <input class="input" type="date" name="date_value" required>
              </label>
              <label class="form-field">
                <span class="form-field__label">Время</span>
                <input class="input" type="time" name="time_value" required>
              </label>
            </div>
            <label class="form-field">
              <span class="form-field__label">Сообщение кандидату</span>
              <textarea class="textarea" name="message_text" placeholder="{{ intro_message_template|format(fio=user.fio, date='дд.мм.гггг', time='чч:мм') }}" rows="3"></textarea>
            </label>
            <div class="form-footer">
              <button class="btn btn-primary btn-sm" type="submit">Отправить приглашение</button>
            </div>
          </form>
        </section>
      {% endif %}
    </div>

<<<<<<< HEAD
    <aside class="page-columns__aside" id="history">
      <section class="surface panel" aria-labelledby="history-title">
        <header class="panel__header">
=======
    <!-- История -->
    <aside class="page-aside" id="history">
      <section class="surface" aria-labelledby="history-title">
        <header>
>>>>>>> 0577ef36064e13a8c9bb54a4ac5472a8685ccce7
          <h2 id="history-title" class="section-title">История событий</h2>
        </header>
        {% if timeline %}
          <ol class="timeline" role="list">
            {% for event in timeline %}
              <li class="timeline__item">
                <div class="timeline__meta">
                  <span class="timeline__kind">
                    {% if event.kind == 'slot' %}
                      Интервью
                    {% elif event.kind == 'test' %}
                      Тест
                    {% elif event.kind == 'message' %}
                      Сообщение
                    {% else %}
                      Событие
                    {% endif %}
                  </span>
                  <time datetime="{{ event.dt.isoformat() if event.dt }}">{{ fmt_local(event.dt, event.tz or 'Europe/Moscow') if event.dt else '—' }}</time>
                </div>
                <div class="timeline__body">
                  {% if event.kind == 'slot' %}
                    <p>Статус: {{ (event.status or '')|upper }}</p>
                    {% if event.recruiter %}<p>Рекрутёр: {{ event.recruiter }}</p>{% endif %}
                    {% if event.city %}<p>Город: {{ event.city }}</p>{% endif %}
                  {% elif event.kind == 'test' %}
                    <p>Баллы: {{ event.score }}{% if event.rating %} ({{ event.rating }}){% endif %}</p>
                  {% elif event.kind == 'message' %}
                    <p class="whitespace-pre-line">{{ event.text }}</p>
                    {% if event.send_time %}<p class="muted text-xs">Запланировано: {{ event.send_time }}</p>{% endif %}
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          </ol>
        {% else %}
          <p class="muted">История пока пуста.</p>
        {% endif %}
      </section>
    </aside>
  </div>

  <div class="modal" data-answer-modal hidden>
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="answers-modal-title" aria-describedby="answers-modal-description" tabindex="-1">
      <div class="modal__header">
        <div>
          <h3 id="answers-modal-title" class="section-title" data-answer-modal-title>Ответы теста</h3>
          <p id="answers-modal-description" class="muted" data-answer-modal-meta></p>
        </div>
        <button type="button" class="btn btn-ghost btn-sm" data-answer-modal-close aria-label="Закрыть">Закрыть</button>
      </div>
      <div class="modal__body" data-answer-modal-body></div>
      <div class="modal__footer">
        <button type="button" class="btn btn-soft btn-sm" data-answer-modal-close>Закрыть</button>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<<<<<<< HEAD
  {{ super() }}
  <script type="module" src="/static/js/modules/answers-modal.js"></script>
  <script type="module" src="/static/js/modules/candidate-profile.js"></script>
{% endblock %}
=======
  <script>
    (function () {
      const triggers = document.querySelectorAll('[data-answer-modal-target]');
      const modal = document.querySelector('[data-answer-modal]');
      if (!modal) return;

      const dialog = modal.querySelector('[role="dialog"]');
      const closeButtons = modal.querySelectorAll('[data-answer-modal-close]');
      const list = modal.querySelector('[data-answer-modal-list]');
      const modalBody = modal.querySelector('[data-answer-modal-body]');
      const titleEl = modal.querySelector('#answers-modal-title');
      const descriptionEl = modal.querySelector('#answers-modal-description');
      let lastTrigger = null;

      const displayValue = (value) => {
        if (value === 0 || value === '0') return '0';
        if (value === undefined || value === null) return '—';
        const s = String(value).trim();
        return s === '' ? '—' : s;
      };

      const formatSummary = (summary, payload) => {
        if (!summary) return '';
        const parts = [];
        parts.push(`Правильных: ${displayValue(summary.correct)} из ${displayValue(summary.total)}`);
        if (summary.overtime) parts.push(`просрочено: ${summary.overtime}`);
        if (payload.score != null && payload.raw_score != null) parts.push(`баллы: ${payload.score} / ${payload.raw_score}`);
        if (payload.rating != null && String(payload.rating).trim() !== '') parts.push(`рейтинг: ${payload.rating}`);
        if (payload.total_time != null && String(payload.total_time).trim() !== '') parts.push(`время: ${payload.total_time} сек`);
        return parts.join(' · ');
      };

      const renderAnswers = (payload) => {
        list.innerHTML = '';
        const qs = (payload && Array.isArray(payload.questions)) ? payload.questions : [];
        if (!qs.length) {
          const li = document.createElement('li');
          li.className = 'muted';
          li.textContent = 'Ответы недоступны.';
          list.appendChild(li);
          return;
        }

        qs.forEach((q, i) => {
          const item = document.createElement('li');
          item.className = 'flex flex-col gap-2';

          const head = document.createElement('div');
          head.className = 'flex flex-wrap items-center gap-2';

          const title = document.createElement('span');
          title.className = 'font-semibold';
          title.textContent = `Вопрос ${i + 1}: ${q.question_text || ''}`;
          head.appendChild(title);

          const status = document.createElement('span');
          status.className = q.is_correct ? 'badge badge--success' : 'badge badge--muted';
          status.textContent = q.is_correct ? 'Верно' : 'Неверно';
          head.appendChild(status);

          if (q.overtime) {
            const ot = document.createElement('span');
            ot.className = 'badge badge--soft';
            ot.textContent = 'Просрочено';
            head.appendChild(ot);
          }

          item.appendChild(head);

          const ua = document.createElement('p');
          ua.innerHTML = `Ответ кандидата: <strong>${displayValue(q.user_answer)}</strong>`;
          item.appendChild(ua);

          if (!q.is_correct && q.correct_answer) {
            const ca = document.createElement('p');
            ca.innerHTML = `Правильный ответ: <strong>${q.correct_answer}</strong>`;
            item.appendChild(ca);
          }

          const meta = document.createElement('p');
          meta.className = 'muted text-sm';
          meta.textContent = `Время: ${displayValue(q.time_spent)} сек · Попытки: ${displayValue(q.attempts_count)}`;
          item.appendChild(meta);

          list.appendChild(item);
        });
      };

      const openModal = (payload, trigger) => {
        lastTrigger = trigger;
        if (titleEl) titleEl.textContent = payload && payload.title ? `Ответы теста от ${payload.title}` : 'Ответы теста';
        if (descriptionEl) {
          const s = formatSummary(payload && payload.summary, payload || {});
          descriptionEl.textContent = s || 'Детализация ответов кандидата.';
        }
        renderAnswers(payload);
        modal.removeAttribute('hidden');
        if (dialog) dialog.focus();
        if (modalBody) modalBody.scrollTop = 0;
        document.body.style.overflow = 'hidden';
      };

      const closeModal = () => {
        modal.setAttribute('hidden', '');
        document.body.style.overflow = '';
        if (lastTrigger) { try { lastTrigger.focus(); } catch (_) {} lastTrigger = null; }
      };

      closeButtons.forEach((btn) => btn.addEventListener('click', closeModal));
      modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
      if (dialog) dialog.addEventListener('click', (e) => e.stopPropagation());
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal.hasAttribute('hidden')) {
          e.preventDefault();
          closeModal();
        }
      });

      triggers.forEach((trigger) => {
        trigger.addEventListener('click', () => {
          const raw = trigger.getAttribute('data-answer-modal-payload');
          if (!raw) return;
          try {
            const payload = JSON.parse(raw);
            openModal(payload, trigger);
          } catch (err) {
            console.error('Не удалось распарсить ответы теста', err);
          }
        });
      });
    })();
  </script>
{% endblock %}
>>>>>>> 0577ef36064e13a8c9bb54a4ac5472a8685ccce7
