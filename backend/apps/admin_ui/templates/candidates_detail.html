{% extends "base.html" %}
{% from "page_primitives.html" import page_header, data_table %}
{% import "partials/form_shell.html" as forms %}
{% block title %}Кандидат {{ user.fio }}{% endblock %}
{% block content %}
{% set saved = request.query_params.get('saved') %}
{% set error = request.query_params.get('error') %}
{% if saved %}
  <div class="alert" data-tone="success" role="status">
    Данные кандидата обновлены.
  </div>
{% elif error %}
  <div class="alert" data-tone="danger" role="alert">
    Не удалось обновить данные кандидата.
  </div>
{% endif %}
{% call page_header(
  eyebrow="Кандидат",
  title=user.fio,
  description="Telegram ID " ~ user.telegram_id ~ " · " ~ (user.city or 'Город не указан'),
  meta='<a class="muted" href="/candidates">← К списку кандидатов</a>'|safe
) %}
  <form method="post" action="/candidates/{{ user.id }}/toggle" class="inline-form">
    {% if user.is_active %}
      <input type="hidden" name="active" value="false">
      <button class="btn btn-ghost" type="submit">Отключить</button>
    {% else %}
      <input type="hidden" name="active" value="true">
      <button class="btn btn-primary" type="submit">Активировать</button>
    {% endif %}
  </form>
  <form
    method="post"
    action="/candidates/{{ user.id }}/delete"
    class="inline-form"
    onsubmit="return confirm('Удалить кандидата {{ user.fio }}?');"
  >
    <button class="btn btn-soft" type="submit">Удалить</button>
  </form>
{% endcall %}

<div class="cards-grid">
  <article class="surface">
    <h2 class="section-title">Сводка</h2>
    <dl class="data-list">
      <div class="data-list__item">
        <dt>Статус</dt>
        <dd>
          {% if user.is_active %}
            <span class="badge badge--success">Активен</span>
          {% else %}
            <span class="badge badge--muted">Отключен</span>
          {% endif %}
        </dd>
      </div>
      <div class="data-list__item">
        <dt>Город</dt>
        <dd>{{ user.city or '—' }}</dd>
      </div>
      <div class="data-list__item">
        <dt>Последняя активность</dt>
        <dd>{{ user.last_activity.strftime('%d.%m.%Y %H:%M') if user.last_activity else '—' }}</dd>
      </div>
      <div class="data-list__item">
        <dt>Тестов пройдено</dt>
        <dd>{{ stats.tests_total }}</dd>
      </div>
      <div class="data-list__item">
        <dt>Средний балл</dt>
        <dd>{{ '%.2f'|format(stats.average_score) if stats.average_score is not none else '—' }}</dd>
      </div>
    </dl>
  </article>

  {% call forms.shell(
    title="Редактирование",
    description="Обновите данные кандидата.",
    form_id="candidate-update",
    action='/candidates/' ~ user.id ~ '/update',
    actions=[{"type": "submit", "text": "Сохранить", "variant": "primary"}]
  ) %}
    {% call forms.section("Основные поля") %}
      <div class="form-grid form-grid--two">
        {% call forms.field("ФИО") %}
          <input type="text" name="fio" value="{{ user.fio }}" required>
        {% endcall %}
        {% call forms.field("Telegram ID") %}
          <input type="number" name="telegram_id" value="{{ user.telegram_id }}" min="1" step="1" required>
        {% endcall %}
      </div>
      <div class="form-grid form-grid--two">
        {% call forms.field("Город") %}
          <input type="text" name="city" value="{{ user.city or '' }}" placeholder="Москва">
        {% endcall %}
        {% call forms.field("Статус") %}
          {{ forms.switch(name='is_active', value='true', checked=user.is_active, label='Активен') }}
        {% endcall %}
      </div>
    {% endcall %}
  {% endcall %}
</div>

<section class="surface">
  <header class="section-header">
    <h2 class="section-title">Результаты тестов</h2>
    <p class="section-hint">Полная история прохождений с ключевыми показателями.</p>
  </header>
  {% if tests %}
    {% set test_columns = [
      {"label": "Дата"},
      {"label": "Балл"},
      {"label": "Рейтинг"},
      {"label": "Время (сек)"},
      {"label": "Ответы"}
    ] %}
    {% call data_table({'columns': test_columns, 'caption': "Результаты тестов кандидата", 'table_class': "list-table"}) %}
      {% for result in tests %}
        {% set answers = answers_map.get(result.id, {}) %}
        <tr>
          <td>{{ result.created_at.strftime('%d.%m.%Y %H:%M') if result.created_at else '—' }}</td>
          <td><strong>{{ result.final_score }}</strong> из {{ result.raw_score }}</td>
          <td>{{ result.rating }}</td>
          <td>{{ result.total_time }}</td>
          <td>
            {% if answers %}
              {{ answers.questions_correct }}/{{ answers.questions_total }} верно
              {% if answers.questions_overtime %}
                · <span class="muted">{{ answers.questions_overtime }} проср.</span>
              {% endif %}
            {% else %}
              <span class="muted">—</span>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    {% endcall %}
  {% else %}
    <p class="muted">Тесты пока не пройдены.</p>
  {% endif %}
</section>

<section class="surface">
  <header class="section-header">
    <h2 class="section-title">Сообщения кандидату</h2>
    <p class="section-hint">Отображаются авто-сообщения, назначенные на Telegram ID кандидата.</p>
  </header>
  {% if messages %}
    {% set message_columns = [
      {"label": "Создано"},
      {"label": "Отправка"},
      {"label": "Текст"},
      {"label": "Статус"}
    ] %}
    {% call data_table({'columns': message_columns, 'caption': "Сообщения кандидату", 'table_class': "list-table"}) %}
      {% for msg in messages %}
        <tr>
          <td>{{ msg.created_at.strftime('%d.%m.%Y %H:%M') if msg.created_at else '—' }}</td>
          <td>{{ msg.send_time }}</td>
          <td class="text-prewrap">{{ msg.message_text }}</td>
          <td>
            {% if msg.is_active %}
              <span class="badge badge--success">Активно</span>
            {% else %}
              <span class="badge badge--muted">Отключено</span>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    {% endcall %}
  {% else %}
    <p class="muted">Сообщения не найдены.</p>
  {% endif %}
</section>
{% endblock %}
