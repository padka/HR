{% extends "base.html" %}
{% import "partials/form_shell.html" as forms with context %}
{% block title %}–ù–∞–∑–Ω–∞—á–∏—Ç—å –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω—å –¥–ª—è {{ candidate.fio }}{% endblock %}
{% block content %}
<section class="form-shell" data-tilt>
  <header class="form-shell__header">
    <div class="form-shell__heading">
      <h1 class="form-shell__title">–û–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω—å</h1>
      <p class="form-shell__description">–ù–∞–∑–Ω–∞—á—å—Ç–µ –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω—å –¥–ª—è {{ candidate.fio }}</p>
    </div>
    {% call forms.meta() %}
      <span class="chip" id="now_chip" title="–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–æ—è—Å–µ">‚è±Ô∏è <span id="now_text">‚Äî:‚Äî</span></span>
    {% endcall %}
  </header>
</section>

{% set tone_map = {'success': 'success', 'error': 'danger', 'info': 'info'} %}
{% if errors %}
  <div class="surface glass grain alert" data-tone="danger" role="alert">
    <ul>
      {% for error in errors %}
        <li>{{ error }}</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

{% if city_missing %}
  <div class="surface glass grain alert" role="alert">
    <h2 class="form-shell__section-title">–ì–æ—Ä–æ–¥ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω</h2>
    <p class="form-shell__section-hint">
      –£ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≥–æ—Ä–æ–¥. –î–æ–±–∞–≤—å—Ç–µ –≥–æ—Ä–æ–¥ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞, —á—Ç–æ–±—ã —Å–∏—Å—Ç–µ–º–∞ –º–æ–≥–ª–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ –≥–æ—Ä–æ–¥—Å–∫–æ–º—É —à–∞–±–ª–æ–Ω—É.
    </p>
    <div class="btn-group mt-sm">
      <a class="btn btn--primary" href="/candidates/{{ candidate.id }}">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–∞–Ω–¥–∏–¥–∞—Ç—É</a>
    </div>
  </div>
{% elif recruiter_missing %}
  <div class="surface glass grain alert" role="alert">
    <h2 class="form-shell__section-title">–ù–µ—Ç —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞ –¥–ª—è –≥–æ—Ä–æ–¥–∞</h2>
    <p class="form-shell__section-hint">
      –ö –≥–æ—Ä–æ–¥—É {{ candidate.city or (city.name_plain if city else '') }} –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –Ω–∏ –æ–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∫—Ä—É—Ç—ë—Ä. –î–æ–±–∞–≤—å—Ç–µ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≥–æ—Ä–æ–¥–∞, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.
    </p>
    <div class="btn-group mt-sm">
      <a class="btn btn--primary" href="/recruiters/new">+ –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞</a>
      <a class="btn btn--ghost" href="/candidates/{{ candidate.id }}">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–∞–Ω–¥–∏–¥–∞—Ç—É</a>
    </div>
  </div>
{% else %}
  {% call forms.shell(
    title="–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥–Ω—è",
    description="–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è ‚Äî –∫–∞–Ω–¥–∏–¥–∞—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º",
    form_id="form-intro-day",
    action="/candidates/" + candidate.id|string + "/schedule-intro-day",
    autocomplete="off",
    section_id="panel-intro-day",
    actions=[
      {"type": "submit", "text": "–ù–∞–∑–Ω–∞—á–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ", "variant": "primary", "id": "btn-schedule", "disabled": true},
      {"href": "/candidates/" + candidate.id|string, "text": "–û—Ç–º–µ–Ω–∞", "variant": "ghost"}
    ]
  ) %}
    {% call forms.section("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–Ω–¥–∏–¥–∞—Ç–µ") %}
      <div class="data-list">
        <div>
          <dt>–§–ò–û</dt>
          <dd><strong>{{ candidate.fio }}</strong></dd>
        </div>
        <div>
          <dt>–ì–æ—Ä–æ–¥</dt>
          <dd>{{ candidate.city or "–ù–µ —É–∫–∞–∑–∞–Ω" }}</dd>
        </div>
        <div>
          <dt>Telegram</dt>
          <dd>
            <span class="candidate-card__code">{{ candidate.telegram_id }}</span>
            {% if candidate.username %}
              <a class="btn btn-primary btn-xs" href="https://t.me/{{ candidate.username }}" target="_blank" style="margin-left: 8px;">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</a>
            {% endif %}
          </dd>
        </div>
        <div>
          <dt>–ì–æ—Ä–æ–¥/—à–∞–±–ª–æ–Ω</dt>
          <dd>{{ (city.name_plain if city else candidate.city) or "–ù–µ —É–∫–∞–∑–∞–Ω" }}</dd>
        </div>
        <div>
          <dt>–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –≥–æ—Ä–æ–¥–∞</dt>
          <dd id="tz_hint">–†–µ–≥–∏–æ–Ω: <strong>{{ city_timezone_label }}</strong></dd>
        </div>
        <div>
          <dt>–°–º–µ—â–µ–Ω–∏–µ –æ—Ç UTC</dt>
          <dd><span class="chip" id="offset_chip" title="–°–º–µ—â–µ–Ω–∏–µ –æ—Ç UTC">GMT <span id="offset_text">¬±0</span></span></dd>
        </div>
      </div>
    {% endcall %}

    {% call forms.section("–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è") %}
      <div class="form-grid form-grid--two">
        {% call forms.field("–î–∞—Ç–∞ (–ª–æ–∫–∞–ª—å–Ω–∞—è)", hint="–î–∞—Ç–∞ –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –≥–æ—Ä–æ–¥–∞ –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥–Ω—è") %}
          <input id="date" type="date" name="date" required>
          <div class="btn-group">
            <button class="btn btn--ghost btn--sm" type="button" data-quick="today">–°–µ–≥–æ–¥–Ω—è</button>
            <button class="btn btn--ghost btn--sm" type="button" data-quick="tomorrow">–ó–∞–≤—Ç—Ä–∞</button>
            <button class="btn btn--ghost btn--sm" type="button" data-quick="next-week">–ß–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é</button>
          </div>
        {% endcall %}
        {% call forms.field("–í—Ä–µ–º—è (–ª–æ–∫–∞–ª—å–Ω–æ–µ)", hint="–í—Ä–µ–º—è –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –≥–æ—Ä–æ–¥–∞") %}
          <input id="time" type="time" name="time" required value="10:00">
          <div class="btn-group">
            <button class="btn btn--ghost btn--sm" type="button" data-time="10:00">10:00</button>
            <button class="btn btn--ghost btn--sm" type="button" data-time="14:00">14:00</button>
            <button class="btn btn--ghost btn--sm" type="button" data-time="16:00">16:00</button>
          </div>
        {% endcall %}
      </div>
    {% endcall %}

    {% call forms.section("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –≤—Å—Ç—Ä–µ—á–µ") %}
      {% call forms.note() %}
        –ê–¥—Ä–µ—Å –ø–ª–æ—â–∞–¥–∫–∏ –∏ –∫–æ–Ω—Ç–∞–∫—Ç —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è –±—É–¥—É—Ç –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ —à–∞–±–ª–æ–Ω–∞ –≥–æ—Ä–æ–¥–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —à–∞–±–ª–æ–Ω <code>intro_day_invitation</code>, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã.
      {% endcall %}
    {% endcall %}

    <input type="hidden" name="candidate_id" value="{{ candidate.id }}">
    <input type="hidden" name="candidate_telegram_id" value="{{ candidate.telegram_id }}">
    <input type="hidden" name="candidate_fio" value="{{ candidate.fio }}">
    <input type="hidden" name="candidate_city" value="{{ candidate.city or '' }}">
    <input type="hidden" id="city_tz_value" value="{{ city_timezone }}" data-tz-label="{{ city_timezone_label }}">

    <div class="preview-panel" id="preview" aria-live="polite">
      <b>–ü—Ä–µ–≤—å—é</b><br>
      –£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è ‚Äî –ø–æ–∫–∞–∂–µ–º –ø–µ—Ä–µ–≤–æ–¥ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –≥–æ—Ä–æ–¥–∞ –∏ UTC.
    </div>
    {% call forms.note(id='submit_hint') %}–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è, —á—Ç–æ–±—ã –Ω–∞–∑–Ω–∞—á–∏—Ç—å –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω—å.{% endcall %}
  {% endcall %}
{% endif %}

<script>
  const dateInput = document.getElementById('date');
  const timeInput = document.getElementById('time');
  const preview = document.getElementById('preview');
  const submitBtn = document.getElementById('btn-schedule');
  const nowText = document.getElementById('now_text');
  const tzHint = document.getElementById('tz_hint');
  const offsetText = document.getElementById('offset_text');
  const cityTzInput = document.getElementById('city_tz_value');

  let currentTz = (cityTzInput && cityTzInput.value) || 'Europe/Moscow';

  function updateNow() {
    if (!currentTz || !nowText) return;
    const now = new Date();
    const formatter = new Intl.DateTimeFormat('ru-RU', {
      timeZone: currentTz,
      hour: '2-digit',
      minute: '2-digit',
    });
    nowText.textContent = formatter.format(now);
  }

  function getTzOffset(tz) {
    if (!tz) return '¬±0';
    const now = new Date();
    const formatter = new Intl.DateTimeFormat('en-US', {
      timeZone: tz,
      timeZoneName: 'short',
    });
    const parts = formatter.formatToParts(now);
    const tzPart = parts.find(p => p.type === 'timeZoneName');
    if (tzPart && tzPart.value.startsWith('GMT')) {
      return tzPart.value.replace('GMT', '');
    }
    const utcDate = new Date(now.toLocaleString('en-US', { timeZone: 'UTC' }));
    const tzDate = new Date(now.toLocaleString('en-US', { timeZone: tz }));
    const offset = (tzDate - utcDate) / (1000 * 60 * 60);
    return offset >= 0 ? `+${offset}` : `${offset}`;
  }

  function updatePreview() {
    const date = dateInput.value;
    const time = timeInput.value;

    if (!currentTz || !date || !time) {
      preview.innerHTML = '<b>–ü—Ä–µ–≤—å—é</b><br>–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥–Ω—è.';
      submitBtn.disabled = true;
      return;
    }

    const tzLabel = (cityTzInput && cityTzInput.dataset.tzLabel) || currentTz;
    if (tzHint) {
      tzHint.innerHTML = `–†–µ–≥–∏–æ–Ω: <strong>${tzLabel}</strong>`;
    }
    if (offsetText) {
      offsetText.textContent = getTzOffset(currentTz);
    }

    const localDatetime = new Date(`${date}T${time}`);
    const utcDatetime = new Date(localDatetime.toLocaleString('en-US', { timeZone: 'UTC' }));

    const formatterLocal = new Intl.DateTimeFormat('ru-RU', {
      timeZone: currentTz,
      dateStyle: 'long',
      timeStyle: 'short',
    });

    const formatterUTC = new Intl.DateTimeFormat('ru-RU', {
      timeZone: 'UTC',
      dateStyle: 'long',
      timeStyle: 'short',
    });

    preview.innerHTML = `
      <b>–ü—Ä–µ–≤—å—é</b><br>
      üïí ${formatterLocal.format(localDatetime)} (${tzLabel})<br>
      üåê ${formatterUTC.format(utcDatetime)} (UTC)<br>
      <br>
      –ê–¥—Ä–µ—Å –∏ –∫–æ–Ω—Ç–∞–∫—Ç –±—É–¥—É—Ç –≤–∑—è—Ç—ã –∏–∑ —à–∞–±–ª–æ–Ω–∞ –≥–æ—Ä–æ–¥–∞.
    `;

    submitBtn.disabled = false;
  }

  dateInput.addEventListener('change', updatePreview);
  timeInput.addEventListener('input', updatePreview);

  document.querySelectorAll('[data-quick]').forEach(btn => {
    btn.addEventListener('click', () => {
      const action = btn.dataset.quick;
      const now = new Date();
      const target = new Date(now);
      if (action === 'tomorrow') {
        target.setDate(now.getDate() + 1);
      } else if (action === 'next-week') {
        target.setDate(now.getDate() + 7);
      }
      const year = target.getFullYear();
      const month = String(target.getMonth() + 1).padStart(2, '0');
      const day = String(target.getDate()).padStart(2, '0');
      dateInput.value = `${year}-${month}-${day}`;
      updatePreview();
    });
  });

  document.querySelectorAll('[data-time]').forEach(btn => {
    btn.addEventListener('click', () => {
      timeInput.value = btn.dataset.time;
      updatePreview();
    });
  });

  setInterval(updateNow, 60000);
  updateNow();
  updatePreview();
</script>
{% endblock %}
