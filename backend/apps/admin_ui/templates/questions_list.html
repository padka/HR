{% extends "base.html" %}

{% block title %}Вопросы{% endblock %}

{% block content %}
<section class="page page--questions">
{% set stats = namespace(total=0, active=0) %}
{% for test in tests %}
    {% set stats.total = stats.total + test.questions|length %}
    {% for q in test.questions %}
      {% if q.is_active %}
        {% set stats.active = stats.active + 1 %}
      {% endif %}
    {% endfor %}
  {% endfor %}

  <header class="page-header page-header--balanced">
    <div>
      <h1 class="page-title">База вопросов</h1>
      <p class="page-description">
        Быстрый просмотр и редактирование формулировок для тестов. Фильтруйте по разделам или ищите по тексту.
      </p>
      <div class="pill-row">
        <span class="pill"><strong>{{ stats.total }}</strong> всего</span>
        <span class="pill pill--success"><strong>{{ stats.active }}</strong> активных</span>
        <span class="pill pill--muted"><strong>{{ stats.total - stats.active }}</strong> скрытых</span>
      </div>
    </div>
    <div class="questions-toolbar">
      <input type="search" id="q-search" placeholder="Поиск по тексту вопроса…" aria-label="Поиск">
      <div class="chip-group" id="q-chip-group" role="listbox">
        <button type="button" class="chip is-active" data-test="all">Все тесты</button>
        {% for test in tests %}
          <button type="button" class="chip" data-test="{{ test.test_id }}">{{ test.title }}</button>
        {% endfor %}
      </div>
    </div>
  </header>

  {% if tests %}
    {% for test in tests %}
      <section class="test-section" id="test-{{ test.test_id }}" data-tilt data-test="{{ test.test_id }}">
        <header class="test-section__header">
          <div>
            <h2 class="card-title">{{ test.title }}</h2>
            <p class="test-section__hint">Идентификатор теста: <code>{{ test.test_id }}</code></p>
          </div>
          <span class="badge">{{ test.questions|length }} вопрос(ов)</span>
        </header>

        <div class="question-list">
          {% for item in test.questions %}
            <article
              class="question-card"
              data-status="{{ 'active' if item.is_active else 'hidden' }}"
              data-test="{{ test.test_id }}"
              data-search="{{ (item.title ~ ' ' ~ (item.prompt or ''))|lower }}"
            >
              <header class="question-card__header">
                <div class="question-card__identity">
                  <span class="badge badge--index">№ {{ item.index }}</span>
                  <h3 class="question-title">{{ item.title }}</h3>
                </div>
                <div class="question-card__tags">
                  {% if item.kind == 'choice' %}
                    <span class="question-pill">С вариантами</span>
                  {% else %}
                    <span class="question-pill">Свободный ответ</span>
                  {% endif %}
                  {% if item.is_active %}
                    <span class="question-pill" data-tone="success">Активен</span>
                  {% else %}
                    <span class="question-pill" data-tone="danger">Скрыт</span>
                  {% endif %}
                </div>
              </header>

              <div class="question-card__body">
                {% if item.prompt %}
                  <p class="question-meta">{{ item.prompt }}</p>
                {% endif %}

                <dl class="question-facts">
                  <div>
                    <dt>Последнее изменение</dt>
                    <dd>{% if item.updated_at %}{{ fmt_utc(item.updated_at) }} UTC{% else %}—{% endif %}</dd>
                  </div>
                  {% if item.options_count %}
                    <div>
                      <dt>Вариантов</dt>
                      <dd>{{ item.options_count }}{% if item.correct_label %} · верный: <strong>{{ item.correct_label }}</strong>{% endif %}</dd>
                    </div>
                  {% endif %}
                </dl>
              </div>

              <footer class="question-card__footer">
                <a class="btn btn-soft btn--grow" href="/questions/{{ item.id }}/edit">Редактировать</a>
              </footer>
            </article>
          {% else %}
            <div class="muted question-empty">В этом тесте пока нет вопросов.</div>
          {% endfor %}
        </div>
      </section>
    {% endfor %}
  {% else %}
    <section class="test-section">
      <p class="page-description">Вопросы ещё не добавлены.</p>
    </section>
  {% endif %}
</section>

<style>
  .page-header--balanced { display:flex; justify-content:space-between; align-items:flex-start; gap:1.5rem; flex-wrap:wrap; }
  .pill-row { display:flex; gap:0.5rem; flex-wrap:wrap; margin-top:0.75rem; }
  .pill { padding:0.45rem 0.75rem; border-radius:999px; background:var(--surface-2, #121826); border:1px solid var(--border, rgba(255,255,255,.08)); font-size:0.9rem; }
  .pill--success { border-color:rgba(35, 209, 139, .4); color:#22c55e; }
  .pill--muted { opacity:0.7; }
  .questions-toolbar { display:flex; flex-direction:column; gap:0.75rem; min-width:280px; flex:1; }
  #q-search { width:100%; padding:0.65rem 0.9rem; border-radius:12px; border:1px solid var(--border, rgba(255,255,255,.12)); background:var(--field-bg, rgba(255,255,255,.03)); color:inherit; }
  .chip-group { display:flex; gap:0.5rem; flex-wrap:wrap; }
  .chip { padding:0.45rem 0.9rem; border-radius:999px; border:1px solid var(--border, rgba(255,255,255,.12)); background:var(--surface-1, rgba(255,255,255,.02)); color:inherit; cursor:pointer; }
  .chip.is-active { border-color:var(--accent, #3b82f6); background:rgba(59,130,246,.12); }
  .question-list { display:grid; gap:1rem; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr)); }
  .question-card { border:1px solid var(--border, rgba(255,255,255,.12)); border-radius:16px; padding:1rem; background:var(--surface-1, rgba(255,255,255,.02)); display:flex; flex-direction:column; gap:0.75rem; transition:transform 0.15s ease, border-color 0.15s ease; }
  .question-card[data-status="hidden"] { opacity:0.6; }
  .question-card:hover { transform:translateY(-2px); border-color:var(--accent, #3b82f6); }
  .question-card__header { display:flex; justify-content:space-between; gap:0.5rem; align-items:flex-start; }
  .question-card__identity { display:flex; align-items:center; gap:0.6rem; flex-wrap:wrap; }
  .question-card__tags { display:flex; align-items:center; gap:0.35rem; flex-wrap:wrap; }
  .question-pill { padding:0.25rem 0.6rem; border-radius:12px; background:var(--surface-2, rgba(255,255,255,.06)); font-size:0.85rem; }
  .question-pill[data-tone="success"] { color:#16a34a; background:rgba(22,163,74,.15); }
  .question-pill[data-tone="danger"] { color:#ef4444; background:rgba(239,68,68,.12); }
  .question-meta { margin:0; color:var(--muted, #9ca3af); }
  .question-facts { display:grid; gap:0.75rem; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); margin:0.5rem 0 0; }
  .question-facts dt { font-size:0.8rem; text-transform:uppercase; letter-spacing:.05em; opacity:0.7; }
  .question-card__footer { display:flex; justify-content:flex-end; }
  .badge--index { background:var(--accent, #3b82f6); color:#fff; }
  @media (max-width: 720px) {
    .page-header--balanced { flex-direction:column; }
    .questions-toolbar { width:100%; }
  }
</style>

{% raw %}
<script>
(function(){
  const search = document.getElementById('q-search');
  const chips = document.querySelectorAll('#q-chip-group .chip');
  const cards = Array.from(document.querySelectorAll('.question-card'));

  function applyFilter(){
    const term = (search?.value || '').trim().toLowerCase();
    const activeChip = document.querySelector('#q-chip-group .chip.is-active');
    const testFilter = activeChip ? activeChip.dataset.test : 'all';

    cards.forEach(card => {
      const matchesTest = testFilter === 'all' || card.dataset.test === testFilter;
      const matchesSearch = !term || (card.dataset.search || '').includes(term);
      card.style.display = matchesTest && matchesSearch ? '' : 'none';
    });
  }

  chips.forEach(chip => {
    chip.addEventListener('click', () => {
      chips.forEach(c => c.classList.remove('is-active'));
      chip.classList.add('is-active');
      applyFilter();
    });
  });

  search?.addEventListener('input', () => {
    applyFilter();
  });
})();
</script>
{% endraw %}
{% endblock %}
