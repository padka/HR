{% extends "base.html" %}
{% from "partials/list_toolbar.html" import list_toolbar %}
{% block title %}–ì–æ—Ä–æ–¥–∞{% endblock %}
{% block content %}
<section class="page">
  <header class="page-header">
    <div>
      <h1 class="page-title">–ì–æ—Ä–æ–¥–∞</h1>
      <p class="page-description">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º–∏, –ø–ª–∞–Ω–∞–º–∏ –∏ —Ç–µ–∫—Å—Ç–∞–º–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥–æ—Ä–æ–¥–∞.</p>
    </div>
    <div class="page-actions">
      <a class="btn btn--primary" href="/cities/new">+ –ù–æ–≤—ã–π –≥–æ—Ä–æ–¥</a>
    </div>
  </header>

  {% call list_toolbar(
    form_id="city_filters",
    method="get",
    mass_actions=[{'label': '–°–±—Ä–æ—Å–∏—Ç—å', 'type': 'button', 'variant': 'ghost', 'button_type': 'button', 'attrs': 'id="city_reset"'}],
    chips=[
      {'label': '–í—Å–µ–≥–æ', 'value': cities|length, 'tone': 'info', 'value_id': 'total_count'},
      {'label': '–ù–∞–π–¥–µ–Ω–æ', 'value': (cities|length|string) ~ ' / ' ~ (cities|length|string), 'tone': 'success', 'value_id': 'found_badge'}
    ]
  ) %}
    <div class="form-field form-field--wide">
      <label for="city_search">–ü–æ–∏—Å–∫</label>
      <input id="city_search" type="search" placeholder="–ú–æ—Å–∫–≤–∞, Novosibirsk, Europe/Moscow‚Ä¶">
    </div>
  {% endcall %}

  {% if not cities %}
    <div class="card glass grain">
      <h3 class="section-title">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</h3>
      <p class="page-description">–î–æ–±–∞–≤—å—Ç–µ –≥–æ—Ä–æ–¥, —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö.</p>
      <div class="page-actions">
        <a class="btn btn--primary" href="/cities/new">+ –ù–æ–≤—ã–π –≥–æ—Ä–æ–¥</a>
      </div>
    </div>
  {% else %}
    <div class="city-collection" id="cities_list">
      {% for c in cities %}
        {% set tz = c.tz or "Europe/Moscow" %}
        {% set criteria = c.criteria|default('') %}
        {% set experts = c.experts|default('') %}
        {% set plan_week = c.plan_week|default('') %}
        {% set plan_month = c.plan_month|default('') %}
        {% set owner_id = owners.get(c.id) %}
        {% set owner = rec_map.get(owner_id) if owner_id else None %}
        <article class="city-card"
                 data-id="{{ c.id }}"
                 data-name="{{ c.name|lower }}"
                 data-tz="{{ tz|lower }}"
                 data-criteria="{{ criteria|e }}"
                 data-experts="{{ experts|e }}"
                 data-plan-week="{{ plan_week }}"
                 data-plan-month="{{ plan_month }}"
                 data-owner-id="{{ owner_id or '' }}">
          <div class="city-card__header">
            <div class="city-card__title">
              <span class="city-name">{{ c.name }}</span>
              {% if not c.tz %}
                <span class="badge" title="–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è TZ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é">TZ: Europe/Moscow</span>
              {% endif %}
            </div>
            <div class="city-card__meta">
              <span class="city-tz">TZ: <code>{{ tz }}</code></span>
              <span class="city-owner {% if not owner %}muted{% endif %}">
                {% if owner %}
                  {{ owner.name }}
                {% else %}
                  –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω
                {% endif %}
              </span>
              <span class="badge plan-badge">
                {% if plan_week or plan_month %}
                  –ù–µ–¥: {{ plan_week or '‚Äî' }} ¬∑ –ú–µ—Å: {{ plan_month or '‚Äî' }}
                {% else %}
                  –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–µ –∑–∞–¥–∞–Ω—ã
                {% endif %}
              </span>
            </div>
            <div class="city-card__actions">
              <button class="btn btn--soft btn-edit" type="button" title="–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≥–æ—Ä–æ–¥">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</button>
            </div>
          </div>
          <div class="city-card__details" hidden>
            <form class="city-form" data-id="{{ c.id }}">
              <div class="city-sheet">
                <section class="city-panel">
                  <header class="city-panel__header">
                    <span class="city-panel__icon" aria-hidden="true">üß≠</span>
                    <div>
                      <h4 class="city-panel__title">–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h4>
                      <p class="city-panel__hint">–ö—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –≥–æ—Ä–æ–¥ –∏ –∫–∞–∫–∏–µ —Ü–µ–ª–∏ –ø–æ –Ω–∞–π–º—É.</p>
                    </div>
                  </header>
                  <div class="city-panel__body">
                    <div class="form-field">
                      <label for="owner_{{ c.id }}">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–µ–∫—Ä—É—Ç—ë—Ä</label>
                      <select id="owner_{{ c.id }}" name="responsible_id" class="responsible-select">
                        <option value="">‚Äî –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω ‚Äî</option>
                        {% for r in recruiters %}
                          <option value="{{ r.id }}" {% if owner_id == r.id %}selected{% endif %}>{{ r.name }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="city-form__row">
                      <div class="form-field form-field--compact">
                        <label for="pw_{{ c.id }}">–ü–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é</label>
                        <input id="pw_{{ c.id }}" name="plan_week" type="number" min="0" step="1" value="{{ plan_week }}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 12">
                      </div>
                      <div class="form-field form-field--compact">
                        <label for="pm_{{ c.id }}">–ü–ª–∞–Ω –Ω–∞ –º–µ—Å—è—Ü</label>
                        <input id="pm_{{ c.id }}" name="plan_month" type="number" min="0" step="1" value="{{ plan_month }}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 48">
                      </div>
                    </div>
                    <div class="info-badge muted">
                      <span class="dot"></span>
                      <span>–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É –∫–æ–º–∞–Ω–¥—ã –∏ –¥–∏–Ω–∞–º–∏–∫—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–æ–≤.</span>
                    </div>
                  </div>
                </section>

                <section class="city-panel">
                  <header class="city-panel__header">
                    <span class="city-panel__icon" aria-hidden="true">üìù</span>
                    <div>
                      <h4 class="city-panel__title">–ü—Ä–æ—Ñ–∏–ª—å –≥–æ—Ä–æ–¥–∞</h4>
                      <p class="city-panel__hint">–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º –∏ —Ä–µ—Å—É—Ä—Å—ã —ç–∫—Å–ø–µ—Ä—Ç–æ–≤.</p>
                    </div>
                  </header>
                  <div class="city-panel__body city-panel__body--stacked">
                    <details class="city-collapse" open>
                      <summary>–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ç–±–æ—Ä–∞</summary>
                      <div class="city-collapse__body">
                        <textarea id="crit_{{ c.id }}" name="criteria" rows="4" placeholder="–û–ø—ã—Ç –ø—Ä–æ–¥–∞–∂ –æ—Ç 6 –º–µ—Å, –≥—Ä–∞–º–æ—Ç–Ω–∞—è —Ä–µ—á—å, –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –≥–∏–±—Ä–∏–¥–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É‚Ä¶">{{ criteria }}</textarea>
                      </div>
                    </details>
                    <details class="city-collapse">
                      <summary>–†–µ—Å—É—Ä—Å—ã —ç–∫—Å–ø–µ—Ä—Ç–æ–≤</summary>
                      <div class="city-collapse__body">
                        <textarea id="exp_{{ c.id }}" name="experts" rows="4" placeholder="–≠–∫—Å–ø–µ—Ä—Ç A: 10 —á/–Ω–µ–¥; –≠–∫—Å–ø–µ—Ä—Ç B: 6 —á/–Ω–µ–¥; –ö–∞–Ω–∞–ª—ã: –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π, —è—Ä–º–∞—Ä–∫–∏ –≤–∞–∫–∞–Ω—Å–∏–π‚Ä¶">{{ experts }}</textarea>
                      </div>
                    </details>
                  </div>
                </section>

                <section class="city-panel city-panel--stages">
                  <header class="city-panel__header">
                    <span class="city-panel__icon" aria-hidden="true">üí¨</span>
                    <div>
                      <h4 class="city-panel__title">–®–∞–≥–∏ –∏ —à–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π</h4>
                      <p class="city-panel__hint">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç–µ–∫—Å—Ç—ã –¥–ª—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ –≤–æ—Ä–æ–Ω–∫–∏.</p>
                    </div>
                  </header>
                  <div class="city-panel__body">
                    {% set stages = city_stages.get(c.id, []) %}
                    <div class="stage-accordion">
                      {% for stage in stages %}
                        <details class="stage-item" data-stage="{{ stage.key }}">
                          <summary>
                            <div class="stage-item__summary">
                              <span class="stage-item__title">{{ stage.title }}</span>
                              <span class="stage-item__preview muted">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ–∫—Å—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
                            </div>
                          </summary>
                          <div class="stage-item__body">
                            <textarea
                              id="stage_{{ stage.key }}_{{ c.id }}"
                              name="stage__{{ stage.key }}"
                              data-stage="{{ stage.key }}"
                              data-default="{{ stage.default|e }}"
                              rows="5"
                              placeholder="{{ stage.default|e }}">{{ stage.value }}</textarea>
                            <div class="stage-controls">
                              <button type="button" class="btn btn--ghost btn--small stage-default-btn" data-stage="{{ stage.key }}">–í—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</button>
                              <span class="muted">{{ stage.description }}</span>
                            </div>
                          </div>
                        </details>
                      {% endfor %}
                    </div>
                    <p class="muted stage-hint">
                      {% raw %}
                      –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: <code>{{candidate_fio}}</code>, <code>{{city_name}}</code>, <code>{{interview_dt_hint}}</code>, <code>{{slot_date_local}}</code>, <code>{{slot_time_local}}</code>, <code>{{slot_datetime_local}}</code>, <code>{{recruiter_name}}</code>, <code>{{address}}</code>.
                      {% endraw %}
                    </p>
                  </div>
                </section>
              </div>

              <footer class="city-form__footer">
                <div class="form-actions">
                  <button type="submit" class="btn btn--primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                  <button type="button" class="btn btn--ghost btn-cancel">–û—Ç–º–µ–Ω–∞</button>
                  <span class="badge muted save-status">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>
                </div>
              </footer>
            </form>
          </div>
        </article>
      {% endfor %}
    </div>
  {% endif %}
</section>

<script>
(function(){
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

  const list = $('#cities_list');
  const search = $('#city_search');
  const reset = $('#city_reset');
  const foundBadge = $('#found_badge');

  if (!list) return;

  const cards = $$('.city-card', list);
  const totalCount = cards.length;

  function norm(s){ return (s||'').toString().trim().toLowerCase(); }

  function truncate(value, limit=120){
    if (!value) return '';
    return value.length > limit ? value.slice(0, limit).trimEnd() + '‚Ä¶' : value;
  }

  function updateStagePreview(details){
    if (!details) return;
    const textarea = details.querySelector('textarea[data-stage]');
    const preview = details.querySelector('.stage-item__preview');
    if (!textarea || !preview) return;
    const value = textarea.value.trim();
    if (value) {
      preview.textContent = truncate(value);
      details.classList.add('stage-item--custom');
    } else {
      preview.textContent = '–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ–∫—Å—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é';
      details.classList.remove('stage-item--custom');
    }
  }

  function bindStagePreviews(form){
    if (!form) return;
    const items = form.querySelectorAll('.stage-item');
    items.forEach(details => {
      const textarea = details.querySelector('textarea[data-stage]');
      if (!textarea) return;
      if (!textarea.dataset.previewBound) {
        textarea.addEventListener('input', () => updateStagePreview(details));
        textarea.dataset.previewBound = '1';
      }
      updateStagePreview(details);
    });
  }

  function closeAll(){
    cards.forEach(card => {
      card.classList.remove('open');
      const details = card.querySelector('.city-card__details');
      if (details) details.hidden = true;
    });
  }

  function applyFilter(){
    const q = norm(search?.value);
    let visible = 0;
    cards.forEach(card => {
      const name = card.dataset.name || '';
      const tz = card.dataset.tz || '';
      const ok = !q || name.includes(q) || tz.includes(q);
      if (ok) {
        card.style.display = '';
        visible++;
      } else {
        card.style.display = 'none';
        card.classList.remove('open');
        const details = card.querySelector('.city-card__details');
        if (details) details.hidden = true;
      }
    });
    if (foundBadge) foundBadge.textContent = visible + ' / ' + totalCount;
  }

  search && search.addEventListener('input', applyFilter);
  reset && reset.addEventListener('click', () => {
    if (search) search.value = '';
    applyFilter();
    search && search.focus();
  });

  list.addEventListener('click', (e)=>{
    const defBtn = e.target.closest('.stage-default-btn');
    if (defBtn) {
      const form = defBtn.closest('form.city-form');
      if (!form) return;
      const key = defBtn.dataset.stage;
      if (!key) return;
      const ta = form.querySelector(`textarea[data-stage="${CSS.escape(key)}"]`);
      if (ta) {
        ta.value = ta.dataset.default || '';
        ta.focus();
        ta.dispatchEvent(new Event('input', { bubbles: true }));
      }
      e.preventDefault();
      return;
    }

    const cancelBtn = e.target.closest('.btn-cancel');
    if (cancelBtn) {
      const card = cancelBtn.closest('.city-card');
      if (card) {
        card.classList.remove('open');
        const details = card.querySelector('.city-card__details');
        if (details) details.hidden = true;
      }
      return;
    }

    const btn = e.target.closest('.btn-edit');
    if (!btn) return;
    const card = btn.closest('.city-card');
    if (!card) return;
    const details = card.querySelector('.city-card__details');
    if (!details) return;

    const isOpen = card.classList.contains('open');
    closeAll();

    if (isOpen) return;

    const form = details.querySelector('form.city-form');
    if (form) {
      const criteriaField = form.querySelector('[name="criteria"]');
      const expertsField = form.querySelector('[name="experts"]');
      const planWeekField = form.querySelector('[name="plan_week"]');
      const planMonthField = form.querySelector('[name="plan_month"]');
      if (criteriaField) criteriaField.value = card.dataset.criteria || '';
      if (expertsField) expertsField.value = card.dataset.experts || '';
      if (planWeekField) planWeekField.value = card.dataset.planWeek || '';
      if (planMonthField) planMonthField.value = card.dataset.planMonth || '';
      const ownerSelect = form.querySelector('[name="responsible_id"]');
      if (ownerSelect) ownerSelect.value = card.dataset.ownerId || '';
      bindStagePreviews(form);
    }

    card.classList.add('open');
    details.hidden = false;
    const firstInput = details.querySelector('textarea, input, select');
    if (firstInput) firstInput.focus();
  });

  list.addEventListener('submit', async (e)=>{
    const form = e.target.closest('form.city-form');
    if (!form) return;
    e.preventDefault();

    const card = form.closest('.city-card');
    if (!card) return;

    const id = form.getAttribute('data-id');
    const criteria = form.criteria.value.trim();
    const experts = form.experts.value.trim();
    const plan_week = form.plan_week.value ? parseInt(form.plan_week.value, 10) : null;
    const plan_month = form.plan_month.value ? parseInt(form.plan_month.value, 10) : null;
    const ownerSelect = form.querySelector('[name="responsible_id"]');
    const ownerRaw = ownerSelect ? ownerSelect.value.trim() : '';
    const ownerId = ownerRaw && !Number.isNaN(Number(ownerRaw)) ? Number(ownerRaw) : null;
    const templates = {};

    form.querySelectorAll('textarea[data-stage]').forEach(ta => {
      const key = ta.dataset.stage;
      if (key) templates[key] = ta.value.trim();
    });

    const status = form.querySelector('.save-status');
    const badge = card.querySelector('.plan-badge');

    if (status) {
      status.style.display = 'inline-block';
      status.classList.remove('ok', 'err');
      status.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶';
    }

    try {
      const resp = await fetch(`/cities/${id}/settings`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          criteria,
          experts,
          plan_week,
          plan_month,
          templates,
          responsible_recruiter_id: ownerId,
        })
      });
      const json = await resp.json();

      if (!json || json.ok !== true) throw new Error(json && json.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');

      card.dataset.criteria = criteria;
      card.dataset.experts = experts;
      card.dataset.planWeek = plan_week ?? '';
      card.dataset.planMonth = plan_month ?? '';
      card.dataset.ownerId = ownerId ? String(ownerId) : '';

      if (badge) {
        if (plan_week || plan_month) {
          badge.textContent = `–ù–µ–¥: ${plan_week ?? '‚Äî'} ¬∑ –ú–µ—Å: ${plan_month ?? '‚Äî'}`;
        } else {
          badge.textContent = '–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–µ –∑–∞–¥–∞–Ω—ã';
        }
      }

      const ownerLabel = card.querySelector('.city-owner');
      if (ownerLabel) {
        if (ownerId) {
          const selector = `option[value="${ownerId}"]`;
          const option = ownerSelect ? ownerSelect.querySelector(selector) : null;
          ownerLabel.textContent = option ? option.textContent : '–ù–∞–∑–Ω–∞—á–µ–Ω';
          ownerLabel.classList.remove('muted');
        } else {
          ownerLabel.textContent = '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
          ownerLabel.classList.add('muted');
        }
      }

      if (status) {
        status.classList.add('ok');
        status.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
      }

      card.classList.remove('open');
      const details = card.querySelector('.city-card__details');
      if (details) details.hidden = true;

      setTimeout(()=>{
        if (status) {
          status.classList.remove('ok');
          status.style.display = 'none';
        }
      }, 1200);
    } catch (err) {
      if (status) {
        status.classList.add('err');
        status.textContent = '–û—à–∏–±–∫–∞';
      }
    }
  });

  applyFilter();
})();
</script>
{% endblock %}
