{% extends "base.html" %}
{% from "partials/list_toolbar.html" import list_toolbar %}
{% block title %}–ì–æ—Ä–æ–¥–∞{% endblock %}
{% block content %}
{% set city_count = cities|length %}
<section class="page page--cities" data-page="cities" aria-labelledby="cities-title">
  <header class="page-header">
    <div>
      <h1 id="cities-title" class="page-title">–ì–æ—Ä–æ–¥–∞</h1>
      <p class="page-description">
        –¢–∞–±–ª–∏—á–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ç–µ–∫—Å—Ç—ã –¥–ª—è —ç—Ç–∞–ø–æ–≤ ‚Äî –≤–æ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–π –ø–∞–Ω–µ–ª–∏ ¬´–ù–∞—Å—Ç—Ä–æ–∏—Ç—å¬ª.
      </p>
    </div>
    <div class="page-actions">
      <a class="btn btn-primary" href="/cities/new" aria-label="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –≥–æ—Ä–æ–¥">+ –ù–æ–≤—ã–π –≥–æ—Ä–æ–¥</a>
    </div>
  </header>

  {% call list_toolbar(
    form_id="city_filters",
    method="get",
    form_attrs='novalidate',
    chips=[
      {'label': '–í—Å–µ–≥–æ –≥–æ—Ä–æ–¥–æ–≤', 'value': city_count, 'tone': 'info', 'value_id': 'total_count'}
    ]
  ) %}
    <p class="form-note form-note--inline">
      –ù–∞–≤–µ–¥–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –∏–ª–∏ —â—ë–ª–∫–Ω–∏—Ç–µ –ø–æ —Å—Ç—Ä–æ–∫–µ —Ç–∞–±–ª–∏—Ü—ã, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏ –∏ –æ—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–ø—Ä–∞–≤–∞.
    </p>
  {% endcall %}

  {% if not cities %}
    <div class="card glass grain">
      <h3 class="section-title">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</h3>
      <p class="page-description">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –≥–æ—Ä–æ–¥, —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–ª–∞–Ω—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è.</p>
      <div class="page-actions">
        <a class="btn btn-primary" href="/cities/new">+ –ù–æ–≤—ã–π –≥–æ—Ä–æ–¥</a>
      </div>
    </div>
  {% else %}
    <article class="card glass grain city-table-card">
      <div class="list-table-wrapper">
        <table class="list-table list-table--responsive city-table" id="city_table">
          <thead>
            <tr>
              <th scope="col" class="col-toggle">
                <span class="visually-hidden">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</span>
              </th>
              <th scope="col" class="sortable">
                <button class="sort" type="button" data-key="name" aria-sort="ascending">
                  –ì–æ—Ä–æ–¥ <span class="arrow" aria-hidden="true"></span>
                </button>
              </th>
              <th scope="col" class="sortable">
                <button class="sort" type="button" data-key="tz" aria-sort="none">
                  –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å <span class="arrow" aria-hidden="true"></span>
                </button>
              </th>
              <th scope="col" class="sortable">
                <button class="sort" type="button" data-key="owner" aria-sort="none">
                  –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π <span class="arrow" aria-hidden="true"></span>
                </button>
              </th>
              <th scope="col" class="sortable col-align-end is-optional">
                <button class="sort" type="button" data-key="week" aria-sort="none">
                  –ü–ª–∞–Ω ¬∑ –Ω–µ–¥ <span class="arrow" aria-hidden="true"></span>
                </button>
              </th>
              <th scope="col" class="sortable col-align-end is-optional">
                <button class="sort" type="button" data-key="month" aria-sort="none">
                  –ü–ª–∞–Ω ¬∑ –º–µ—Å <span class="arrow" aria-hidden="true"></span>
                </button>
              </th>
              <th scope="col" class="col-actions">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody id="cities_tbody">
            {% for c in cities %}
              {% set tz = c.tz or "Europe/Moscow" %}
            {% set criteria = c.criteria or '' %}
            {% set experts = c.experts or '' %}
            {% set plan_week = c.plan_week %}
            {% set plan_month = c.plan_month %}
            {% set plan_week_data = plan_week if plan_week is not none else '' %}
            {% set plan_month_data = plan_month if plan_month is not none else '' %}
              {% set owner_id = owners.get(c.id) %}
              {% set owner = rec_map.get(owner_id) if owner_id else None %}
              {% set stages = city_stages.get(c.id, []) %}
              <tr class="city-row"
                  tabindex="0"
                  data-id="{{ c.id }}"
                  data-name="{{ c.name_plain|lower }}"
                  data-tz="{{ tz|lower }}"
                  data-owner="{{ (owner.name if owner else '')|lower }}"
                  data-criteria="{{ criteria|e }}"
                  data-experts="{{ experts|e }}"
                  data-plan-week="{{ plan_week_data }}"
                  data-plan-month="{{ plan_month_data }}"
                  data-owner-id="{{ owner_id or '' }}">
                <td class="col-toggle" data-label="">
                  <button type="button"
                          class="row-expand"
                          aria-expanded="false"
                          aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –ø–æ –≥–æ—Ä–æ–¥—É {{ c.name_plain }}">
                    <span class="row-expand__icon" aria-hidden="true"></span>
                  </button>
                </td>
                <td data-label="–ì–æ—Ä–æ–¥" class="col-name">
                  <span class="cell-title">{{ c.display_name }}</span>
                </td>
                <td data-label="–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å" class="col-tz">
                  <span class="badge badge--soft"><code>{{ tz }}</code></span>
                </td>
                <td data-label="–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π" class="col-owner">
                  <span class="owner-label {% if not owner %}muted{% endif %}">
                    {% if owner %}{{ owner.name }}{% else %}–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω{% endif %}
                  </span>
                </td>
                <td data-label="–ü–ª–∞–Ω ¬∑ –Ω–µ–¥" class="col-week is-optional" data-sort="{{ plan_week if plan_week is not none else 0 }}">
                  {{ plan_week if plan_week is not none else '‚Äî' }}
                </td>
                <td data-label="–ü–ª–∞–Ω ¬∑ –º–µ—Å" class="col-month is-optional" data-sort="{{ plan_month if plan_month is not none else 0 }}">
                  {{ plan_month if plan_month is not none else '‚Äî' }}
                </td>
                <td data-label="" class="cell-actions">
                  <button class="btn btn-soft btn--small btn-edit" type="button">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</button>
                </td>
              </tr>
              {% set stage_ns = namespace(custom=0, total=0) %}
              <tr class="city-row city-row--details" data-details-for="{{ c.id }}" hidden>
                <td colspan="7">
                  <section class="city-insight" aria-label="–î–µ—Ç–∞–ª–∏ –ø–æ –≥–æ—Ä–æ–¥—É {{ c.name_plain }}">
                    <header class="city-insight__header">
                      <div class="city-insight__title">
                        <h3>{{ c.display_name }}</h3>
                        <p class="muted">–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: {{ tz }}</p>
                      </div>
                      <div class="city-insight__meta">
                        <span class="badge badge--soft" data-field="id">ID {{ c.id }}</span>
                        <span class="badge badge--soft" data-field="plan-week">–ü–ª–∞–Ω –Ω–µ–¥: {{ plan_week or '‚Äî' }}</span>
                        <span class="badge badge--soft" data-field="plan-month">–ü–ª–∞–Ω –º–µ—Å: {{ plan_month or '‚Äî' }}</span>
                      </div>
                    </header>

                    <div class="city-insight__grid">
                      <article class="city-insight__block">
                        <h4>–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ç–±–æ—Ä–∞</h4>
                        {% set criteria_clean = criteria|trim %}
                        {% if criteria_clean %}
                          <p data-field="criteria">{{ criteria_clean|replace('\n','<br>')|safe }}</p>
                        {% else %}
                          <p class="muted" data-field="criteria">{{ render_or_empty('') }}</p>
                        {% endif %}
                      </article>
                      <article class="city-insight__block">
                        <h4>–†–µ—Å—É—Ä—Å—ã —ç–∫—Å–ø–µ—Ä—Ç–æ–≤</h4>
                        {% set experts_clean = experts|trim %}
                        {% if experts_clean %}
                          <p data-field="experts">{{ experts_clean|replace('\n','<br>')|safe }}</p>
                        {% else %}
                          <p class="muted" data-field="experts">{{ render_or_empty('') }}</p>
                        {% endif %}
                      </article>
                      <article class="city-insight__block city-insight__block--stages">
                        <h4>–≠—Ç–∞–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π</h4>
                        {% if stages %}
                          <ul class="stage-summary" role="list">
                            {% for stage in stages %}
                              {% set stage_ns.total = stage_ns.total + 1 %}
                              {% set stage_value = (stage.value or '')|trim %}
                              {% set stage_default = (stage.default or '')|trim %}
                              {% set is_custom = stage_value and stage_value != stage_default %}
                              {% if is_custom %}{% set stage_ns.custom = stage_ns.custom + 1 %}{% endif %}
                              <li class="stage-summary__item{% if is_custom %} is-custom{% endif %}"
                                  data-stage="{{ stage.key }}"
                                  data-default="{{ stage.default|e }}">
                                <span class="stage-summary__title">{{ stage.title }}</span>
                                <span class="stage-summary__status" data-role="stage-status">{{ '–°–≤–æ—è –≤–µ—Ä—Å–∏—è' if is_custom else '–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é' }}</span>
                                <p class="stage-summary__excerpt" data-role="stage-preview"{% if not is_custom %} hidden{% endif %}>{{ stage_value|truncate(120, True)|e }}</p>
                              </li>
                            {% endfor %}
                          </ul>
                        {% else %}
                          <p class="muted">–≠—Ç–∞–ø—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã</p>
                        {% endif %}
                      </article>
                    </div>

                    <footer class="city-insight__footer">
                      {% if owner %}
                        <span class="city-insight__owner">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: <strong>{{ owner.name }}</strong></span>
                      {% else %}
                        <span class="city-insight__owner muted">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
                      {% endif %}
                      <div class="city-insight__actions">
                        <button type="button" class="btn btn-soft btn--small btn-edit" data-action="open-sheet" data-target="{{ c.id }}">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</button>
                        {% if stage_ns.total %}
                          <span class="muted" data-role="stage-count">–ö–∞—Å—Ç–æ–º–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤: {{ stage_ns.custom }}/{{ stage_ns.total }}</span>
                        {% else %}
                          <span class="muted" data-role="stage-count">–≠—Ç–∞–ø—ã –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã</span>
                        {% endif %}
                      </div>
                    </footer>
                  </section>
                </td>
              </tr>
              <template id="tpl-stages-{{ c.id }}">
                <div class="stage-accordion">
                  {% for stage in stages %}
                    <details class="stage-item" data-stage="{{ stage.key }}">
                      <summary>
                        <div class="stage-item__summary">
                          <span class="stage-item__title">{{ stage.title }}</span>
                          <span class="stage-item__preview muted">–¢–µ–∫—Å—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
                        </div>
                      </summary>
                      <div class="stage-item__body">
                          <textarea
                          id="stage_{{ stage.key }}_{{ c.id }}"
                          name="stage__{{ stage.key }}"
                          data-stage="{{ stage.key }}"
                          data-default="{{ (stage.default or '')|e }}"
                          rows="5"
                          placeholder="{{ (stage.default or '')|e }}">{{ stage.value or '' }}</textarea>
                        <div class="stage-controls">
                          <button type="button" class="btn btn-ghost btn--small stage-default-btn" data-stage="{{ stage.key }}">–í—Å—Ç–∞–≤–∏—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</button>
                          <span class="muted">{{ stage.description }}</span>
                        </div>
                      </div>
                    </details>
                  {% endfor %}
                </div>
              </template>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </article>
  {% endif %}

  <div id="sheet_backdrop" class="sheet-backdrop" hidden></div>
  <aside id="sheet" class="sheet city-drawer" hidden aria-modal="true" role="dialog" aria-labelledby="sheet-title">
    <header class="sheet-header">
      <div>
        <h3 id="sheet-title" class="sheet-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–æ—Ä–æ–¥–∞</h3>
        <p id="sheet-sub" class="sheet-sub muted">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –≤ —Ç–∞–±–ª–∏—Ü–µ.</p>
      </div>
      <button id="sheet_close" class="btn btn-ghost btn--small" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
    </header>

    <form id="sheet_form" class="sheet-body city-sheet" novalidate>
      <input type="hidden" name="city_id" id="city_id">

      <section class="city-overview" aria-live="polite">
        <div class="city-overview__top">
          <div class="city-overview__identity">
            <span class="badge badge--soft city-overview__id" id="city_overview_id">ID ‚Äî</span>
            <h4 class="city-overview__title" id="city_overview_name">–ì–æ—Ä–æ–¥ –Ω–µ –≤—ã–±—Ä–∞–Ω</h4>
            <p class="city-overview__tz muted" id="city_overview_tz">–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: ‚Äî</p>
          </div>
          <div class="city-overview__metrics">
            <span class="badge badge--soft" id="city_overview_week">–ü–ª–∞–Ω –Ω–µ–¥: ‚Äî</span>
            <span class="badge badge--soft" id="city_overview_month">–ü–ª–∞–Ω –º–µ—Å: ‚Äî</span>
          </div>
        </div>
        <div class="city-overview__foot">
          <p class="city-overview__owner muted" id="city_overview_owner">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</p>
          <span class="badge badge--soft" id="city_overview_stages">–≠—Ç–∞–ø—ã –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã</span>
        </div>
      </section>

      <section class="city-panel">
        <div class="city-panel__header">
          <span class="city-panel__icon" aria-hidden="true">üèô</span>
          <div>
            <h4 class="city-panel__title">–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h4>
            <p class="city-panel__hint">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∏ —Ü–µ–ª–∏ –ø–æ –Ω–∞–π–º—É.</p>
          </div>
        </div>
        <div class="city-panel__body">
          <div class="form-field">
            <label for="owner_select">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–µ–∫—Ä—É—Ç—ë—Ä</label>
            <select id="owner_select" name="responsible_id">
              <option value="">‚Äî –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω ‚Äî</option>
              {% for r in recruiters %}
                <option value="{{ r.id }}">{{ r.name }}</option>
              {% endfor %}
            </select>
            <p class="form-note">–ù–∞–∑–Ω–∞—á—å—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ, —á—Ç–æ–±—ã –∑–∞—è–≤–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞–¥–∞–ª–∏ –∫ –Ω—É–∂–Ω–æ–º—É —Ä–µ–∫—Ä—É—Ç—ë—Ä—É.</p>
          </div>
            <div class="form-grid form-grid--two">
              <div class="form-field form-field--compact">
                <label for="plan_week">–ü–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é</label>
              <input id="plan_week" name="plan_week" type="number" inputmode="numeric" min="0" step="1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 12">
              <p class="form-error" id="plan_week_error" role="alert" hidden></p>
              <p class="form-note">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –æ—Ç—á—ë—Ç–∞—Ö –∏ —Å–≤–æ–¥–∫–∞—Ö.</p>
              </div>
              <div class="form-field form-field--compact">
                <label for="plan_month">–ü–ª–∞–Ω –Ω–∞ –º–µ—Å—è—Ü</label>
              <input id="plan_month" name="plan_month" type="number" inputmode="numeric" min="0" step="1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 48">
              <p class="form-error" id="plan_month_error" role="alert" hidden></p>
                <p class="form-note">–ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –ø–æ–∫–∞ –Ω–µ—Ç —Ü–µ–ª–∏.</p>
              </div>
            </div>
        </div>
      </section>

      <section class="city-panel">
        <div class="city-panel__header">
          <span class="city-panel__icon" aria-hidden="true">üóÇ</span>
          <div>
            <h4 class="city-panel__title">–ü—Ä–æ—Ñ–∏–ª—å –≥–æ—Ä–æ–¥–∞</h4>
            <p class="city-panel__hint">–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∏ —Ä–µ—Å—É—Ä—Å—ã.</p>
          </div>
        </div>
        <div class="city-panel__body city-panel__body--stacked">
          <details class="city-collapse" open>
            <summary>
              <span>–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ç–±–æ—Ä–∞</span>
              <span id="crit_preview" class="muted">‚Äî</span>
            </summary>
            <div class="city-collapse__body">
              <textarea id="criteria" name="criteria" rows="4" placeholder="–û–ø—ã—Ç –ø—Ä–æ–¥–∞–∂ –æ—Ç 6 –º–µ—Å, –≥—Ä–∞–º–æ—Ç–Ω–∞—è —Ä–µ—á—å, –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –≥–∏–±—Ä–∏–¥–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É‚Ä¶"></textarea>
            </div>
          </details>
          <details class="city-collapse">
            <summary>
              <span>–†–µ—Å—É—Ä—Å—ã —ç–∫—Å–ø–µ—Ä—Ç–æ–≤</span>
              <span id="exp_preview" class="muted">‚Äî</span>
            </summary>
            <div class="city-collapse__body">
              <textarea id="experts" name="experts" rows="4" placeholder="–≠–∫—Å–ø–µ—Ä—Ç A: 10 —á/–Ω–µ–¥; –≠–∫—Å–ø–µ—Ä—Ç B: 6 —á/–Ω–µ–¥; –ö–∞–Ω–∞–ª—ã: —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π, —è—Ä–º–∞—Ä–∫–∏ –≤–∞–∫–∞–Ω—Å–∏–π‚Ä¶"></textarea>
            </div>
          </details>
        </div>
      </section>

      <section class="city-panel city-panel--stages" id="sheet_stages">
        <div class="city-panel__header">
          <span class="city-panel__icon" aria-hidden="true">‚úâÔ∏è</span>
          <div class="city-panel__headline">
            <h4 class="city-panel__title">–≠—Ç–∞–ø—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è</h4>
            <p class="city-panel__hint">–¢–µ–∫—Å—Ç—ã –¥–ª—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ —Å–ø—Ä–∞–≤–∞, —á—Ç–æ–±—ã —Ä–∞—Å–∫—Ä—ã—Ç—å –∏–ª–∏ —Å–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ —Å–µ–∫—Ü–∏–∏.</p>
          </div>
          <div class="city-panel__header-actions">
            <button id="stages_expand" class="btn btn-soft btn--small" type="button" disabled>–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å</button>
            <button id="stages_collapse" class="btn btn-ghost btn--small" type="button" disabled>–°–≤–µ—Ä–Ω—É—Ç—å</button>
          </div>
        </div>
        <div id="sheet_stages_body" class="city-panel__body city-panel__body--stacked">
          <p class="muted stage-placeholder">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –≤ —Ç–∞–±–ª–∏—Ü–µ, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç—ã.</p>
        </div>
      </section>
    </form>

    <footer class="sheet-footer">
      <span id="save_status" class="save-status muted" aria-live="polite">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>
      <div class="form-actions">
        <button id="btn_delete" class="btn btn-danger" type="button" disabled>–£–¥–∞–ª–∏—Ç—å</button>
        <button id="btn_save" class="btn btn-primary" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="btn_cancel" class="btn btn-ghost" type="button">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </footer>
  </aside>

  <div id="confirm_modal" class="modal" hidden role="dialog" aria-modal="true" aria-labelledby="confirm_modal_title">
    <div id="confirm_modal_backdrop" class="modal__backdrop" data-action="dismiss-confirm"></div>
    <div class="modal__dialog glass">
      <div class="modal__content">
        <h3 id="confirm_modal_title" class="modal__title">–£–¥–∞–ª–∏—Ç—å –≥–æ—Ä–æ–¥?</h3>
        <p id="confirm_modal_text" class="modal__text">–ì–æ—Ä–æ–¥ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–∏–º –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?</p>
        <div class="modal__actions">
          <button id="confirm_modal_submit" class="btn btn-danger" type="button">–£–¥–∞–ª–∏—Ç—å</button>
          <button id="confirm_modal_cancel" class="btn btn-ghost" type="button">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toasts" class="toast-stack" aria-live="polite" aria-atomic="true"></div>
</section>

<script>
(function(){
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const on = (el, ev, cb, opts)=>el && el.addEventListener(ev, cb, opts);

  const table = $('#city_table');
  const tbody = $('#cities_tbody');

  const sheet = $('#sheet');
  const sheetBackdrop = $('#sheet_backdrop');
  const sheetForm = $('#sheet_form');
  const sheetStages = $('#sheet_stages');
  const sheetStagesBody = $('#sheet_stages_body');
  const sheetTitle = $('#sheet-title');
  const sheetSub = $('#sheet-sub');
  const sheetClose = $('#sheet_close');
  const btnSave = $('#btn_save');
  const btnCancel = $('#btn_cancel');
  const btnDelete = $('#btn_delete');
  const saveStatus = $('#save_status');

  const inputId = $('#city_id');
  const selOwner = $('#owner_select');
  const inWeek = $('#plan_week');
  const inMonth = $('#plan_month');
  const taCriteria = $('#criteria');
  const taExperts = $('#experts');
  const prevCrit = $('#crit_preview');
  const prevExp = $('#exp_preview');
  const errWeek = $('#plan_week_error');
  const errMonth = $('#plan_month_error');
  const confirmModal = $('#confirm_modal');
  const confirmBackdrop = $('#confirm_modal_backdrop');
  const confirmSubmit = $('#confirm_modal_submit');
  const confirmCancel = $('#confirm_modal_cancel');
  const confirmText = $('#confirm_modal_text');

  const overviewName = $('#city_overview_name');
  const overviewTz = $('#city_overview_tz');
  const overviewId = $('#city_overview_id');
  const overviewOwner = $('#city_overview_owner');
  const overviewWeek = $('#city_overview_week');
  const overviewMonth = $('#city_overview_month');
  const overviewStages = $('#city_overview_stages');
  const btnExpandStages = $('#stages_expand');
  const btnCollapseStages = $('#stages_collapse');
  const totalCountEl = $('#total_count');

  if (!tbody) return;

  clearOverview();

  const rows = $$('.city-row[data-id]', tbody);

  const truncate = (v, n=120)=>!v ? '‚Äî' : (v.length>n ? v.slice(0,n).trimEnd()+'‚Ä¶' : v);

  const planFieldMap = {
    plan_week: { input: inWeek, error: errWeek },
    plan_month: { input: inMonth, error: errMonth },
  };

  function hidePlanError(field){
    const config = planFieldMap[field];
    if (!config) return;
    if (config.input) config.input.classList.remove('is-invalid');
    if (config.error){
      config.error.hidden = true;
      config.error.textContent = '';
    }
  }

  function clearPlanErrors(){
    Object.keys(planFieldMap).forEach(hidePlanError);
  }

  function showPlanError(field, message){
    const config = planFieldMap[field];
    if (!config) return;
    if (config.input) config.input.classList.add('is-invalid');
    if (config.error){
      config.error.textContent = message || '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ';
      config.error.hidden = false;
    }
  }

  const confirmDefaultLabel = confirmSubmit ? confirmSubmit.textContent : '–£–¥–∞–ª–∏—Ç—å';

  function resetConfirmButton(){
    if (!confirmSubmit) return;
    confirmSubmit.disabled = false;
    confirmSubmit.textContent = confirmDefaultLabel;
  }

  function openDeleteConfirm(){
    if (!currentRow || !confirmModal) return;
    const cityName = sheetTitle.textContent?.trim() || '–≥–æ—Ä–æ–¥';
    if (confirmText){
      confirmText.textContent = `–ì–æ—Ä–æ–¥ ¬´${cityName}¬ª –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–∏–º –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`;
    }
    confirmModal.hidden = false;
    requestAnimationFrame(()=>{
      confirmModal.classList.add('open');
      confirmSubmit?.focus();
    });
  }

  function closeDeleteModal(focusBack = true){
    if (!confirmModal) return;
    confirmModal.classList.remove('open');
    const focusTarget = btnDelete;
    setTimeout(()=>{
      confirmModal.hidden = true;
      if (focusBack && focusTarget) focusTarget.focus();
    }, 180);
  }

  const stagePlaceholderHTML = '<p class="muted stage-placeholder">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –≤ —Ç–∞–±–ª–∏—Ü–µ, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç—ã.</p>';
  function resetStagePlaceholder(){
    if (sheetStagesBody){
      sheetStagesBody.innerHTML = stagePlaceholderHTML;
    }
    setStageControlsDisabled(true);
  }

  function setStageControlsDisabled(disabled){
    if (btnExpandStages) btnExpandStages.disabled = disabled;
    if (btnCollapseStages) btnCollapseStages.disabled = disabled;
  }

  function toggleAllStageDetails(expand){
    const scope = sheetStagesBody || sheetStages;
    if (!scope) return;
    scope.querySelectorAll('details.stage-item').forEach(item=>{
      if (expand) item.setAttribute('open','');
      else item.removeAttribute('open');
    });
  }

  function updateTotalCount(){
    if (totalCountEl) totalCountEl.textContent = rows.length;
  }

  function renderEmptyState(){
    if (!tbody || rows.length) return;
    if (tbody.querySelector('.city-row--empty')) return;
    const emptyRow = document.createElement('tr');
    emptyRow.className = 'city-row city-row--empty';
    const cell = document.createElement('td');
    cell.colSpan = 7;
    cell.className = 'city-empty-cell';
    cell.innerHTML = `
      <div class="city-empty card glass grain">
        <h3 class="section-title">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</h3>
        <p class="page-description">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –≥–æ—Ä–æ–¥, —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–ª–∞–Ω—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è.</p>
        <div class="page-actions">
          <a class="btn btn-primary" href="/cities/new">+ –ù–æ–≤—ã–π –≥–æ—Ä–æ–¥</a>
        </div>
      </div>
    `;
    emptyRow.appendChild(cell);
    tbody.appendChild(emptyRow);
  }

  function setOverviewStages(custom, total){
    if (!overviewStages) return;
    if (!total){
      overviewStages.textContent = '–≠—Ç–∞–ø—ã –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã';
      return;
    }
    overviewStages.textContent = `–ö–∞—Å—Ç–æ–º–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤: ${custom}/${total}`;
  }

  function clearOverview(){
    if (overviewName) overviewName.textContent = '–ì–æ—Ä–æ–¥ –Ω–µ –≤—ã–±—Ä–∞–Ω';
    if (overviewTz) overviewTz.textContent = '–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: ‚Äî';
    if (overviewId) overviewId.textContent = 'ID ‚Äî';
    if (overviewWeek) overviewWeek.textContent = '–ü–ª–∞–Ω –Ω–µ–¥: ‚Äî';
    if (overviewMonth) overviewMonth.textContent = '–ü–ª–∞–Ω –º–µ—Å: ‚Äî';
    if (overviewOwner){
      overviewOwner.textContent = '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
      overviewOwner.classList.add('muted');
    }
    setOverviewStages(0, 0);
    setStageControlsDisabled(true);
  }

  function updateOverviewFromRow(row){
    if (!row) return;
    const id = row.dataset.id || '‚Äî';
    const nameText = row.querySelector('.col-name .cell-title')?.textContent?.trim() || '–ì–æ—Ä–æ–¥';
    const tzText = row.querySelector('.col-tz code')?.textContent?.trim() || 'Europe/Moscow';
    const ownerNode = row.querySelector('.owner-label');
    const ownerText = ownerNode?.textContent?.trim() || '';
    const weekText = row.querySelector('.col-week')?.textContent?.trim() || '‚Äî';
    const monthText = row.querySelector('.col-month')?.textContent?.trim() || '‚Äî';

    if (overviewName) overviewName.textContent = nameText;
    if (overviewTz) overviewTz.textContent = `–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: ${tzText}`;
    if (overviewId) overviewId.textContent = `ID ${id}`;
    if (overviewWeek) overviewWeek.textContent = `–ü–ª–∞–Ω –Ω–µ–¥: ${weekText || '‚Äî'}`;
    if (overviewMonth) overviewMonth.textContent = `–ü–ª–∞–Ω –º–µ—Å: ${monthText || '‚Äî'}`;

    if (overviewOwner){
      if (ownerNode && !ownerNode.classList.contains('muted') && ownerText){
        overviewOwner.innerHTML = `–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: <strong>${escapeHTML(ownerText)}</strong>`;
        overviewOwner.classList.remove('muted');
      } else {
        overviewOwner.textContent = '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
        overviewOwner.classList.add('muted');
      }
    }

    updateOverviewStagesFromDetails(row);
  }

  function updateOverviewStagesFromDetails(row){
    if (!overviewStages) return;
    const details = getDetailsRow(row);
    if (!details){
      setOverviewStages(0, 0);
      return;
    }
    const stageItems = Array.from(details.querySelectorAll('.stage-summary__item'));
    if (!stageItems.length){
      setOverviewStages(0, 0);
      return;
    }
    let customCount = 0;
    stageItems.forEach(item=>{
      if (item.classList.contains('is-custom')) customCount += 1;
    });
    setOverviewStages(customCount, stageItems.length);
  }

  function refreshStageSummaryFromEditor(){
    if (!sheetStagesBody){
      setOverviewStages(0, 0);
      setStageControlsDisabled(true);
      return;
    }
    const areas = sheetStagesBody.querySelectorAll('textarea[data-stage]');
    if (!areas.length){
      setOverviewStages(0, 0);
      setStageControlsDisabled(true);
      return;
    }
    setStageControlsDisabled(false);
    let total = 0;
    let custom = 0;
    areas.forEach(ta=>{
      total += 1;
      const val = ta.value.trim();
      const def = (ta.dataset.default || '').trim();
      if (val && val !== def) custom += 1;
    });
    setOverviewStages(custom, total);
  }

  function syncOverviewFromForm(){
    if (!overviewWeek || !overviewMonth || !overviewOwner) return;
    const weekVal = (inWeek?.value || '').trim();
    const monthVal = (inMonth?.value || '').trim();
    overviewWeek.textContent = `–ü–ª–∞–Ω –Ω–µ–¥: ${weekVal || '‚Äî'}`;
    overviewMonth.textContent = `–ü–ª–∞–Ω –º–µ—Å: ${monthVal || '‚Äî'}`;

    if (!selOwner) return;
    const ownerId = (selOwner.value || '').trim();
    const option = selOwner.options?.[selOwner.selectedIndex] || null;
    const label = option ? option.textContent.trim() : '';

    if (ownerId && label){
      overviewOwner.innerHTML = `–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: <strong>${escapeHTML(label)}</strong>`;
      overviewOwner.classList.remove('muted');
    } else {
      overviewOwner.textContent = '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
      overviewOwner.classList.add('muted');
    }
  }

  function getDetailsRow(row){
    if (!row) return null;
    const next = row.nextElementSibling;
    if (next && next.classList?.contains('city-row--details') && next.dataset.detailsFor === row.dataset.id){
      return next;
    }
    return null;
  }

  let expandedRow = null;

  function collapseRow(row){
    if (!row) return;
    const details = getDetailsRow(row);
    if (!details) return;
    details.hidden = true;
    details.classList.remove('is-visible');
    row.classList.remove('is-expanded');
    row.querySelector('.row-expand')?.setAttribute('aria-expanded', 'false');
    if (expandedRow === row) expandedRow = null;
  }

  function expandRow(row){
    if (!row) return;
    const details = getDetailsRow(row);
    if (!details) return;
    if (expandedRow && expandedRow !== row){
      collapseRow(expandedRow);
    }
    details.hidden = false;
    details.classList.add('is-visible');
    row.classList.add('is-expanded');
    row.querySelector('.row-expand')?.setAttribute('aria-expanded', 'true');
    expandedRow = row;
  }

  function toggleRow(row){
    if (!row) return;
    if (row.classList.contains('is-expanded')) collapseRow(row);
    else expandRow(row);
  }

  function escapeHTML(str=''){
    return str.replace(/[&<>"']/g, (ch)=>({
      '&':'&amp;',
      '<':'&lt;',
      '>':'&gt;',
      '"':'&quot;',
      "'":'&#39;'
    }[ch] || ch));
  }

  function toast(text, kind='info'){
    const wrap = $('#toasts');
    if (!wrap) return;
    const t = document.createElement('div');
    t.className = 'toast';
    t.dataset.kind = kind;
    t.role = 'status';
    t.textContent = text;
    wrap.appendChild(t);
    setTimeout(()=>{ t.classList.add('toast--hide'); }, 2000);
    setTimeout(()=>{ t.remove(); }, 2600);
  }

  const sortState = { key: 'name', dir: 'asc' };
  function getCellValue(row, key){
    switch(key){
      case 'name':  return row.dataset.name || '';
      case 'tz':    return row.dataset.tz || '';
      case 'owner': return row.dataset.owner || '';
      case 'week':  return Number(row.querySelector('.col-week')?.dataset.sort || 0);
      case 'month': return Number(row.querySelector('.col-month')?.dataset.sort || 0);
      default: return '';
    }
  }
  function applySort(){
    const rowsArr = Array.from(rows).filter(r=>r.style.display !== 'none');
    rowsArr.sort((a,b)=>{
      const av = getCellValue(a, sortState.key);
      const bv = getCellValue(b, sortState.key);
      if (typeof av === 'number' || typeof bv === 'number'){
        return sortState.dir === 'asc' ? (av - bv) : (bv - av);
      }
      const cmp = String(av).localeCompare(String(bv), 'ru', { sensitivity:'base' });
      return sortState.dir === 'asc' ? cmp : -cmp;
    });
    rowsArr.forEach(r=>{
      const details = getDetailsRow(r);
      tbody.appendChild(r);
      if (details){
        tbody.appendChild(details);
      }
    });
    $$('.sort', table).forEach(btn=>{
      const dir = (btn.dataset.key === sortState.key) ? (sortState.dir==='asc'?'ascending':'descending') : 'none';
      btn.setAttribute('aria-sort', dir);
      btn.classList.toggle('is-active', btn.dataset.key === sortState.key);
    });
  }

  on(table, 'click', (e)=>{
    const btn = e.target.closest('button.sort'); if (!btn) return;
    const key = btn.dataset.key;
    if (!key) return;
    if (sortState.key === key){
      sortState.dir = (sortState.dir === 'asc') ? 'desc' : 'asc';
    } else {
      sortState.key = key; sortState.dir = 'asc';
    }
    applySort();
  });

  let currentRow = null;
  let isDirty = false;
  function setDirty(v){
    isDirty = v;
    saveStatus.textContent = v ? '–ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è' : '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
    saveStatus.classList.toggle('ok', !v);
    saveStatus.classList.toggle('err', false);
  }

  if (selOwner){
    selOwner.addEventListener('change', ()=>{
      setDirty(true);
      if (!sheet.hidden) syncOverviewFromForm();
    });
  }
  [inWeek, inMonth].forEach(input=>{
    if (!input) return;
    const fieldKey = (input === inWeek) ? 'plan_week' : 'plan_month';
    input.addEventListener('input', ()=>{
      hidePlanError(fieldKey);
      setDirty(true);
      if (!sheet.hidden) syncOverviewFromForm();
    });
  });
  on(btnExpandStages, 'click', ()=> toggleAllStageDetails(true));
  on(btnCollapseStages, 'click', ()=> toggleAllStageDetails(false));

  function openSheetForRow(row){
    currentRow = row;
    const id = row.dataset.id;
    const name = row.querySelector('.col-name .cell-title')?.textContent?.trim() || '–ì–æ—Ä–æ–¥';
    const tzLabel = row.querySelector('.col-tz code')?.textContent?.trim() || 'Europe/Moscow';
    sheetTitle.textContent = name;
    sheetSub.textContent = `–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: ${tzLabel}`;
    updateOverviewFromRow(row);
    inputId.value = id;
    if (btnDelete){
      btnDelete.disabled = false;
      btnDelete.textContent = '–£–¥–∞–ª–∏—Ç—å';
    }

    selOwner.value = row.dataset.ownerId || '';
    inWeek.value = row.dataset.planWeek || '';
    inMonth.value = row.dataset.planMonth || '';
    taCriteria.value = row.dataset.criteria || '';
    taExperts.value = row.dataset.experts || '';
    prevCrit.textContent = truncate(taCriteria.value);
    prevExp.textContent = truncate(taExperts.value);
    clearPlanErrors();

    if (sheetStagesBody){
      sheetStagesBody.innerHTML = '';
      const tplEl = document.getElementById(`tpl-stages-${id}`);
      if (tplEl instanceof HTMLTemplateElement && tplEl.content){
        const frag = tplEl.content.cloneNode(true);
        sheetStagesBody.appendChild(frag);
        sheetStagesBody.querySelectorAll('details.stage-item').forEach(d=>{
          const ta = d.querySelector('textarea[data-stage]');
          const prev = d.querySelector('.stage-item__preview');
          const updatePrev = ()=>{ prev.textContent = (ta.value.trim() ? truncate(ta.value) : '–¢–µ–∫—Å—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é'); };
          if (ta){
            ta.addEventListener('input', ()=>{ setDirty(true); updatePrev(); refreshStageSummaryFromEditor(); });
            updatePrev();
          }
        });
        sheetStagesBody.querySelectorAll('.stage-default-btn').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const key = btn.getAttribute('data-stage');
            if (!key) return;
            const ta = sheetStagesBody.querySelector(`textarea[data-stage="${CSS.escape(key)}"]`);
            if (ta){
              ta.value = ta.dataset.default || '';
              ta.dispatchEvent(new Event('input',{bubbles:true}));
              ta.focus();
            }
          });
        });
        refreshStageSummaryFromEditor();
      } else {
        resetStagePlaceholder();
        refreshStageSummaryFromEditor();
      }
    }

    sheet.hidden = false; sheetBackdrop.hidden = false;
    document.body.classList.add('sheet-open');
    requestAnimationFrame(()=>{
      sheet.classList.add('open'); sheetBackdrop.classList.add('open');
    });
    setDirty(false);
    selOwner.focus();
    syncOverviewFromForm();
  }

  function tryCloseSheet(){
    if (isDirty){
      const ok = confirm('–ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –ó–∞–∫—Ä—ã—Ç—å –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è?');
      if (!ok) return;
    }
    closeSheet(true);
  }
  function closeSheet(reset=false){
    sheet.classList.remove('open'); sheetBackdrop.classList.remove('open');
    resetConfirmButton();
    if (confirmModal && !confirmModal.hidden){
      closeDeleteModal(false);
    }
    setTimeout(()=>{
      sheet.hidden = true; sheetBackdrop.hidden = true;
      document.body.classList.remove('sheet-open');
      if (reset){ sheetForm.reset(); resetStagePlaceholder(); prevCrit.textContent = '‚Äî'; prevExp.textContent = '‚Äî'; }
      sheetTitle.textContent = '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–æ—Ä–æ–¥–∞';
      sheetSub.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –≤ —Ç–∞–±–ª–∏—Ü–µ.';
      if (btnDelete){
        btnDelete.disabled = true;
        btnDelete.textContent = '–£–¥–∞–ª–∏—Ç—å';
      }
      clearOverview();
      refreshStageSummaryFromEditor();
      currentRow = null; isDirty = false;
    }, 220);
  }

  on(sheetBackdrop, 'click', tryCloseSheet);
  on(sheetClose, 'click', tryCloseSheet);
  on(btnCancel, 'click', tryCloseSheet);

  on(document, 'keydown', (e)=>{
    if (!sheet.hidden){
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's'){ e.preventDefault(); doSave(); }
      if (e.key === 'Escape'){ e.preventDefault(); tryCloseSheet(); }
    } else {
      const focusRow = document.activeElement?.closest?.('tr.city-row[data-id]');
      if (e.code === 'Space' && focusRow){ e.preventDefault(); toggleRow(focusRow); return; }
      if (e.key === 'Enter' && focusRow){ e.preventDefault(); focusRow.querySelector('.btn-edit')?.click(); }
      if (['ArrowDown','ArrowUp'].includes(e.key)){
        e.preventDefault();
        const visibleRows = rows;
        const idx = visibleRows.indexOf(focusRow);
        let next = null;
        if (e.key === 'ArrowDown'){ next = visibleRows[Math.min(idx+1, visibleRows.length-1)] || visibleRows[0]; }
        else { next = visibleRows[Math.max(idx-1, 0)] || visibleRows[0]; }
        next?.focus();
      }
    }
  });

  on(tbody,'click',(e)=>{
    const expandBtn = e.target.closest('.row-expand');
    if (expandBtn){
      const row = expandBtn.closest('tr.city-row[data-id]');
      toggleRow(row);
      return;
    }

    const explicitOpen = e.target.closest('[data-action="open-sheet"]');
    if (explicitOpen){
      const targetId = explicitOpen.getAttribute('data-target');
      let row = explicitOpen.closest('tr.city-row[data-id]');
      if (!row && targetId){
        row = tbody.querySelector(`tr.city-row[data-id="${CSS.escape(targetId)}"]`);
      }
      if (row) openSheetForRow(row);
      return;
    }

    const btn = e.target.closest('.btn-edit');
    if (!btn) return;
    const row = btn.closest('tr.city-row[data-id]');
    if (!row) return;
    openSheetForRow(row);
  });
  on(tbody,'dblclick',(e)=>{
    const row = e.target.closest('tr.city-row[data-id]');
    if (!row) return;
    openSheetForRow(row);
  });

  async function doSave(){
    if (!currentRow) return;
    const id = inputId.value;
    const ownerIdRaw = (selOwner.value || '').trim();
    const ownerId = ownerIdRaw ? Number(ownerIdRaw) : null;
    const planWeekValue = inWeek.value === '' ? null : inWeek.valueAsNumber;
    const planMonthValue = inMonth.value === '' ? null : inMonth.valueAsNumber;

    const templates = {};
    const stageValues = {};
    const stageDefaults = {};
    const stageScope = sheetStagesBody || sheetStages;
    stageScope?.querySelectorAll('textarea[data-stage]').forEach(ta=>{
      const k = ta.dataset.stage; if (!k) return;
      const val = ta.value.trim();
      const def = (ta.dataset.default || '').trim();
      templates[k] = val;
      stageValues[k] = val;
      stageDefaults[k] = def;
    });

    clearPlanErrors();
    saveStatus.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶';
    saveStatus.classList.add('ok');
    saveStatus.classList.remove('err');

    try{
      const resp = await fetch(`/cities/${id}/settings`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({
          criteria: taCriteria.value.trim(),
          experts: taExperts.value.trim(),
          plan_week: planWeekValue,
          plan_month: planMonthValue,
          templates,
          responsible_recruiter_id: ownerId
        })
      });
      let json = null;
      try {
        json = await resp.json();
      } catch(_err) {
        json = null;
      }
      if (resp.status === 422 && json && json.error){
        const field = json.error.field || 'plan_week';
        showPlanError(field, json.error.message);
        saveStatus.textContent = '–ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏';
        saveStatus.classList.remove('ok');
        saveStatus.classList.add('err');
        if (navigator.vibrate) navigator.vibrate(50);
        toast(json.error.message || '–ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏', 'error');
        return;
      }
      if (!resp.ok || !json || json.ok !== true){
        throw new Error(json && json.error ? json.error : '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
      }

      const cityData = json.city || {};
      const ownerData = cityData.responsible_recruiter || null;
      const criteriaValue = (cityData.criteria || '').trim();
      const expertsValue = (cityData.experts || '').trim();
      const planWeekNormalized = typeof cityData.plan_week === 'number' ? cityData.plan_week : null;
      const planMonthNormalized = typeof cityData.plan_month === 'number' ? cityData.plan_month : null;

      if (selOwner){
        selOwner.value = cityData.responsible_recruiter_id ? String(cityData.responsible_recruiter_id) : '';
      }
      inWeek.value = planWeekNormalized ?? '';
      inMonth.value = planMonthNormalized ?? '';
      taCriteria.value = criteriaValue;
      taExperts.value = expertsValue;
      prevCrit.textContent = truncate(criteriaValue);
      prevExp.textContent = truncate(expertsValue);

      const ownerLabel = currentRow.querySelector('.owner-label');
      const colWeek = currentRow.querySelector('.col-week');
      const colMonth = currentRow.querySelector('.col-month');

      currentRow.dataset.criteria = criteriaValue;
      currentRow.dataset.experts = expertsValue;
      currentRow.dataset.planWeek = planWeekNormalized ?? '';
      currentRow.dataset.planMonth = planMonthNormalized ?? '';
      currentRow.dataset.ownerId = cityData.responsible_recruiter_id ? String(cityData.responsible_recruiter_id) : '';
      currentRow.dataset.owner = ownerData && ownerData.name ? ownerData.name.trim().toLowerCase() : '';

      if (ownerLabel){
        if (ownerData && ownerData.name){
          ownerLabel.textContent = ownerData.name;
          ownerLabel.classList.remove('muted');
        } else {
          ownerLabel.textContent = '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
          ownerLabel.classList.add('muted');
        }
      }
      if (colWeek){
        colWeek.textContent = planWeekNormalized ?? '‚Äî';
        colWeek.dataset.sort = String(planWeekNormalized ?? 0);
      }
      if (colMonth){
        colMonth.textContent = planMonthNormalized ?? '‚Äî';
        colMonth.dataset.sort = String(planMonthNormalized ?? 0);
      }

      const detailsRow = getDetailsRow(currentRow);
      if (detailsRow){
        const updateRich = (field, value, emptyLabel)=>{
          const target = detailsRow.querySelector(`[data-field="${field}"]`);
          if (!target) return;
          const text = (value || '').trim();
          if (text){
            target.innerHTML = escapeHTML(text).replace(/\n/g, '<br>');
            target.classList.remove('muted');
          } else {
            target.textContent = emptyLabel;
            target.classList.add('muted');
          }
        };
        updateRich('criteria', criteriaValue, '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è');
        updateRich('experts', expertsValue, '–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ');

        const weekBadge = detailsRow.querySelector('[data-field="plan-week"]');
        if (weekBadge){
          weekBadge.textContent = `–ü–ª–∞–Ω –Ω–µ–¥: ${planWeekNormalized ?? '‚Äî'}`;
        }
        const monthBadge = detailsRow.querySelector('[data-field="plan-month"]');
        if (monthBadge){
          monthBadge.textContent = `–ü–ª–∞–Ω –º–µ—Å: ${planMonthNormalized ?? '‚Äî'}`;
        }

        const ownerInfo = detailsRow.querySelector('.city-insight__owner');
        if (ownerInfo){
          if (ownerData && ownerData.name){
            ownerInfo.innerHTML = `–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: <strong>${escapeHTML(ownerData.name)}</strong>`;
            ownerInfo.classList.remove('muted');
          } else {
            ownerInfo.textContent = '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
            ownerInfo.classList.add('muted');
          }
        }

        const stageItems = Array.from(detailsRow.querySelectorAll('.stage-summary__item'));
        let customCount = 0;
        stageItems.forEach(item=>{
          const key = item.dataset.stage;
          const status = item.querySelector('[data-role="stage-status"]');
          const preview = item.querySelector('[data-role="stage-preview"]');
          const val = (stageValues[key] || '').trim();
          const def = (stageDefaults[key] || '').trim();
          const isCustom = Boolean(val) && val !== def;
          item.classList.toggle('is-custom', isCustom);
          if (status) status.textContent = isCustom ? '–°–≤–æ—è –≤–µ—Ä—Å–∏—è' : '–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é';
          if (preview){
            if (isCustom){
              const compact = val.replace(/\s+/g,' ').trim();
              preview.textContent = truncate(compact, 120);
              preview.hidden = false;
            } else {
              preview.hidden = true;
            }
          }
          if (isCustom) customCount += 1;
        });
        const countLabel = detailsRow.querySelector('[data-role="stage-count"]');
        if (countLabel){
          if (stageItems.length){
            countLabel.textContent = `–ö–∞—Å—Ç–æ–º–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤: ${customCount}/${stageItems.length}`;
          } else {
            countLabel.textContent = '–≠—Ç–∞–ø—ã –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã';
          }
        }
      }

      setDirty(false);
      saveStatus.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
      saveStatus.classList.add('ok');
      saveStatus.classList.remove('err');
      updateOverviewFromRow(currentRow);

      toast('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
      closeSheet(false);
      applySort();
    }catch(err){
      console.error(err);
      saveStatus.textContent = '–û—à–∏–±–∫–∞';
      saveStatus.classList.remove('ok'); saveStatus.classList.add('err');
      if (navigator.vibrate) navigator.vibrate(60);
      toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å', 'error');
    }
  }

  async function doDelete(){
    if (!currentRow || !btnDelete) return;
    const id = inputId.value;
    const prevSheetLabel = btnDelete.textContent;
    btnDelete.disabled = true;
    btnDelete.textContent = '–£–¥–∞–ª–µ–Ω–∏–µ‚Ä¶';
    if (confirmSubmit){
      confirmSubmit.disabled = true;
      confirmSubmit.textContent = '–£–¥–∞–ª–µ–Ω–∏–µ‚Ä¶';
    }

    try{
      const resp = await fetch(`/cities/${id}/delete?confirm=1`, {
        method: 'POST',
        headers: { 'Accept': 'application/json' }
      });
      let json = null;
      try {
        json = await resp.json();
      } catch(_err) {
        json = null;
      }
      if (!resp.ok || !json || json.ok !== true){
        throw new Error(json && json.error ? json.error : 'delete_failed');
      }

      resetConfirmButton();
      closeDeleteModal(false);

      const detailsRow = getDetailsRow(currentRow);
      if (detailsRow){
        detailsRow.remove();
      }
      const tplEl = document.getElementById(`tpl-stages-${id}`);
      tplEl?.remove();

      const idx = rows.indexOf(currentRow);
      if (idx >= 0){
        rows.splice(idx, 1);
      }
      if (expandedRow === currentRow){
        expandedRow = null;
      }
      currentRow.remove();

      updateTotalCount();
      renderEmptyState();
      toast('–ì–æ—Ä–æ–¥ —É–¥–∞–ª—ë–Ω', 'success');
      closeSheet(true);
      applySort();
    } catch(err){
      console.error(err);
      toast('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å', 'error');
      btnDelete.disabled = false;
      btnDelete.textContent = prevSheetLabel;
      resetConfirmButton();
      return;
    }
  }

  on(btnSave, 'click', doSave);
  on(btnDelete, 'click', (e)=>{
    if (!btnDelete || btnDelete.disabled) return;
    e.preventDefault();
    resetConfirmButton();
    openDeleteConfirm();
  });
  on(confirmSubmit, 'click', doDelete);
  on(confirmCancel, 'click', ()=>{ resetConfirmButton(); closeDeleteModal(true); });
  on(confirmBackdrop, 'click', ()=>{ resetConfirmButton(); closeDeleteModal(true); });
  on(confirmModal, 'keydown', (e)=>{
    if (e.key === 'Escape'){
      e.preventDefault();
      resetConfirmButton();
      closeDeleteModal(true);
    }
  });
  on(taCriteria, 'input', ()=>{ prevCrit.textContent = truncate(taCriteria.value); setDirty(true); });
  on(taExperts, 'input', ()=>{ prevExp.textContent = truncate(taExperts.value); setDirty(true); });

  window.addEventListener('beforeunload', (e)=>{
    if (!sheet.hidden && isDirty){ e.preventDefault(); e.returnValue = ''; }
  });

  resetStagePlaceholder();
  applySort();
  refreshStageSummaryFromEditor();
  updateTotalCount();
  renderEmptyState();
})();
</script>
{% endblock %}
