{% extends "base.html" %}
{% block title %}Города{% endblock %}
{% block content %}
{% set city_count = cities|length %}
<section class="space-y-8" data-page="cities" aria-labelledby="cities-title">
  <header class="flex flex-wrap items-center justify-between gap-6">
    <div>
      <h1 id="cities-title" class="text-3xl font-semibold tracking-tight text-fg-primary">Города</h1>
      <p class="text-sm text-fg-muted">Рабочие площадки и ответственные.</p>
    </div>
    <a class="btn btn-primary" href="/cities/new" aria-label="Добавить новый город">+ Новый город</a>
  </header>

  <section class="glass-card gap-5" data-cities-board data-density="standard">
    <div class="flex flex-wrap items-center gap-3">
      <div class="relative flex-1 min-w-[220px] max-w-md">
        <label for="cities_search" class="sr-only">Поиск городов</label>
        <input
          id="cities_search"
          type="search"
          name="q"
          placeholder="Поиск города или таймзоны"
          autocomplete="off"
          class="w-full rounded-xl border border-white/20 bg-white/10 px-4 py-2.5 text-sm text-fg-primary placeholder:text-fg-muted focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/40"
          data-cities-search
        >
        <button
          type="button"
          class="absolute inset-y-0 right-2 flex items-center rounded-lg px-2 text-xs font-medium text-fg-muted transition hover:text-fg-primary"
          data-clear-search
          aria-label="Очистить поиск"
          hidden
        >
          Очистить
        </button>
      </div>
      <div class="flex flex-wrap items-center gap-2" role="group" aria-label="Быстрые фильтры">
        <button type="button" class="filter-chip is-active" data-cities-filter="all">Все</button>
        <button type="button" class="filter-chip" data-cities-filter="assigned">С ответственным</button>
        <button type="button" class="filter-chip" data-cities-filter="unassigned">Без ответственного</button>
        <button type="button" class="filter-chip" data-cities-filter="active">Активные</button>
      </div>
      <div class="ml-auto flex flex-wrap items-center gap-3 text-sm text-fg-secondary">
        <div class="flex items-center gap-2" role="group" aria-label="Плотность">
          <button type="button" class="toggle-pill is-active" data-density-option="standard" aria-pressed="true">Стандарт</button>
          <button type="button" class="toggle-pill" data-density-option="compact" aria-pressed="false">Компактный</button>
        </div>
        <span class="inline-flex items-center gap-1 rounded-xl border border-white/10 bg-white/10 px-3 py-1 text-xs font-medium uppercase tracking-[0.18em] text-fg-secondary">Показано: <span data-visible-count>{{ city_count }}</span></span>
        <div class="flex items-center gap-3" role="group" aria-label="Дополнительные колонки">
          <label class="inline-flex cursor-pointer items-center gap-2 rounded-xl border border-white/10 bg-white/10 px-3 py-1.5 text-xs font-medium text-fg-secondary transition hover:border-accent/40 hover:text-fg-primary">
            <input type="checkbox" class="h-4 w-4 rounded border-white/30 bg-transparent text-accent focus:ring-accent/40" data-toggle-column="active">
            <span>Активен</span>
          </label>
          <label class="inline-flex cursor-pointer items-center gap-2 rounded-xl border border-white/10 bg-white/10 px-3 py-1.5 text-xs font-medium text-fg-secondary transition hover:border-accent/40 hover:text-fg-primary">
            <input type="checkbox" class="h-4 w-4 rounded border-white/30 bg-transparent text-accent focus:ring-accent/40" data-toggle-column="stages">
            <span>Шаблоны</span>
          </label>
        </div>
      </div>
    </div>

    <div class="relative overflow-hidden rounded-2xl border border-white/10 bg-white/5 shadow-glass backdrop-blur-glass" data-cities-surface>
      <div class="overflow-x-auto">
        <table class="min-w-full text-left text-sm text-fg-primary" data-cities-table data-density="standard">
          <thead class="sticky top-0 z-10 bg-white/10 text-xs font-semibold uppercase tracking-[0.18em] text-fg-secondary backdrop-blur-glass">
            <tr>
              <th scope="col" class="px-5 py-4">
                <button type="button" class="inline-flex items-center gap-2 font-semibold uppercase tracking-[0.18em] text-fg-secondary transition hover:text-fg-primary" data-sort="name" aria-sort="ascending">
                  Город
                  <span class="sort-indicator" aria-hidden="true"></span>
                </button>
              </th>
              <th scope="col" class="px-5 py-4">Таймзона</th>
              <th scope="col" class="px-5 py-4">
                <button type="button" class="inline-flex items-center gap-2 font-semibold uppercase tracking-[0.18em] text-fg-secondary transition hover:text-fg-primary" data-sort="owner" aria-sort="none">
                  Ответственный
                  <span class="sort-indicator" aria-hidden="true"></span>
                </button>
              </th>
              <th scope="col" class="px-5 py-4 text-right">Действие</th>
              <th scope="col" class="hidden px-5 py-4" data-col="active">Активен</th>
              <th scope="col" class="hidden px-5 py-4" data-col="stages">Шаблоны</th>
            </tr>
          </thead>
          <tbody>
            {% for c in cities %}
              {% set tz = c.tz or "Europe/Moscow" %}
              {% set owner_id = owners.get(c.id) %}
              {% set owner = rec_map.get(owner_id) if owner_id else None %}
              {% set stages = city_stages.get(c.id, []) %}
              {% set stage_counts = namespace(total=0, custom=0) %}
              {% for stage in stages %}
                {% set stage_counts.total = stage_counts.total + 1 %}
                {% if stage.is_custom %}
                  {% set stage_counts.custom = stage_counts.custom + 1 %}
                {% endif %}
              {% endfor %}
              {% set stage_label = stage_counts.custom and stage_counts.total and stage_counts.custom ~ '/' ~ stage_counts.total %}
              <tr
                data-city-row
                data-name="{{ c.name|lower }}"
                data-tz="{{ tz|lower }}"
                data-owner="{{ (owner.name if owner else '')|lower }}"
                data-owner-state="{{ 1 if owner else 0 }}"
                data-active="{{ 1 if c.active else 0 }}"
                data-has-stages="{{ 1 if stage_counts.custom else 0 }}"
                data-href="/cities/{{ c.id }}/edit"
                class="group cursor-pointer transition-colors duration-150 ease-snap odd:bg-white/5 focus-visible:outline focus-visible:outline-2 focus-visible:outline-accent/60 focus-visible:-outline-offset-2"
                tabindex="0"
                role="link"
              >
                <td class="px-5 py-4">
                  <div class="flex flex-col gap-1">
                    <span class="text-base font-medium text-fg-primary">{{ c.name }}</span>
                    <span class="text-xs uppercase tracking-[0.18em] text-fg-muted">ID {{ c.id }}</span>
                  </div>
                </td>
                <td class="px-5 py-4">
                  <span class="chip chip--accent">
                    <span class="h-2 w-2 rounded-full bg-[rgba(147,254,191,0.85)]"></span>
                    {{ tz }}
                  </span>
                </td>
                <td class="px-5 py-4">
                  {% if owner %}
                    <span class="text-sm font-medium text-fg-primary">{{ owner.name }}</span>
                  {% else %}
                    <span class="text-sm text-fg-muted">Не назначен</span>
                  {% endif %}
                </td>
                <td class="px-5 py-4 text-right">
                  <a href="/cities/{{ c.id }}/edit" class="inline-flex items-center gap-2 rounded-xl border border-white/20 bg-white/10 px-4 py-2 text-sm font-medium text-fg-primary transition hover:border-accent/40 hover:bg-accent/10" aria-label="Настроить {{ c.name }}">
                    Настроить
                    <span aria-hidden="true" class="text-xs">↗</span>
                  </a>
                </td>
                <td class="hidden px-5 py-4 text-sm font-medium" data-col="active">
                  {% if c.active %}
                    <span class="inline-flex items-center gap-2 rounded-full border border-white/30 bg-[rgba(147,254,191,0.18)] px-3 py-1 text-xs font-semibold uppercase tracking-[0.18em] text-[rgb(147,254,191)]">Активен</span>
                  {% else %}
                    <span class="inline-flex items-center gap-2 rounded-full border border-white/30 bg-[rgba(249,110,101,0.18)] px-3 py-1 text-xs font-semibold uppercase tracking-[0.18em] text-[rgb(249,110,101)]">Выключен</span>
                  {% endif %}
                </td>
                <td class="hidden px-5 py-4 text-sm text-fg-secondary" data-col="stages">
                  {% if stage_label %}
                    Кастом: {{ stage_label }}
                  {% else %}
                    —
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="border-t border-white/10 bg-white/5 px-5 py-4 text-sm text-fg-muted" data-empty-state hidden>
        <p>Не найдено ни одного города.</p>
        <a href="/cities/new" class="mt-2 inline-flex items-center gap-2 text-sm font-medium text-accent hover:text-accent-strong">Создать город</a>
      </div>
    </div>
  </section>
</section>
{% endblock %}
{% block extra_js %}
  <script type="module" src="/static/js/cities-table.js"></script>
{% endblock %}
