{% extends "base.html" %}
{% from "partials/list_toolbar.html" import list_toolbar %}
{% block title %}Города{% endblock %}
{% block content %}
<section class="page page--cities" data-page="cities" aria-labelledby="cities-title">
  <style>
    :root{
      --maxw: 1200px;
      --bg: #f7f8fa;
      --surface: #fff;
      --text: #0b0c0e;
      --muted: #6b7280;
      --border: #e6e7eb;
      --primary: #0a84ff;
      --success: #34c759;
      --danger: #ff3b30;

      --radius-sm: 10px;
      --radius-md: 14px;

      --shadow-1: 0 1px 2px rgba(0,0,0,.04), 0 3px 10px rgba(0,0,0,.05);
      --ring: 0 0 0 3px rgba(10,132,255,.18);

      --t: 180ms cubic-bezier(.22,.61,.36,1);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0e0f12; --surface:#15161a; --text:#eceef1; --muted:#9aa3af; --border:#26272c;
        --ring: 0 0 0 3px rgba(10,132,255,.28);
        --shadow-1: 0 1px 2px rgba(0,0,0,.5), 0 6px 18px rgba(0,0,0,.35);
      }
    }

    .page--cities{ background:var(--bg); padding-bottom:48px; }

    /* Header */
    .page-header{
      max-width:var(--maxw);
      margin:18px auto 12px;
      padding:16px clamp(16px,4vw,24px);
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      background:var(--surface); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow-1);
    }
    .page-title{ margin:0 0 4px; font-size:clamp(22px,2.4vw,28px); font-weight:700; letter-spacing:-.01em; color:var(--text); }
    .page-description{ margin:0; color:var(--muted); font-size:14px; }

    /* Buttons */
    .btn{
      --btn-bg:var(--surface); --btn-bd:var(--border); --btn-text:var(--text);
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:9px 12px; border-radius:10px; border:1px solid var(--btn-bd);
      background:var(--btn-bg); color:var(--btn-text); font-weight:600; font-size:14px; line-height:1;
      transition:box-shadow var(--t), transform var(--t), background var(--t), border-color var(--t);
    }
    .btn:hover{ transform:translateY(-1px); box-shadow:var(--shadow-1); }
    .btn:focus-visible{ outline:none; box-shadow:var(--ring); }
    .btn-primary{ --btn-bg:var(--primary); --btn-bd:var(--primary); --btn-text:#fff; }
    .btn-soft{ --btn-bg:rgba(10,132,255,.1); --btn-bd:rgba(10,132,255,.18); --btn-text:var(--primary); }
    .btn-ghost{ --btn-bg:transparent; --btn-bd:transparent; --btn-text:var(--muted); }
    .btn--small{ padding:7px 10px; font-size:13px; }

    /* Toolbar */
    .toolbar{
      max-width:var(--maxw);
      margin:8px auto 14px;
      padding:0 clamp(16px,4vw,24px);
      display:grid; grid-template-columns: 1fr auto auto; gap:12px; align-items:center;
    }
    .form-field{ display:grid; gap:6px; }
    .form-field--wide{ width:min(560px, 100%); }
    .form-field input[type="search"]{
      border:1px solid var(--border); background:var(--surface); color:var(--text);
      border-radius:10px; padding:10px 12px; font-size:14.5px; transition:border-color var(--t), box-shadow var(--t);
    }
    .form-field input::placeholder{ color:var(--muted); opacity:.75; }
    .form-field input:focus-visible{ outline:none; border-color:var(--primary); box-shadow:var(--ring); }

    .segmented{
      display:inline-flex; border:1px solid var(--border); border-radius:10px; overflow:hidden; background:var(--surface);
    }
    .segmented button{
      padding:8px 10px; font-size:12.5px; border:0; background:transparent; color:var(--muted); cursor:pointer;
    }
    .segmented button[aria-pressed="true"]{ background:rgba(10,132,255,.1); color:var(--primary); }

    .chips{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; font-size:12.5px; font-weight:600; border:1px solid var(--border); border-radius:999px; color:var(--muted); background:var(--surface); }
    .chip .dot{ width:6px; height:6px; border-radius:50%; background:var(--muted); }
    .chip select{
      border:1px solid var(--border); border-radius:8px; padding:6px 8px; background:var(--surface); color:var(--text); font-size:12.5px;
    }

    /* Table */
    .table-wrap{ max-width:var(--maxw); margin:0 auto; padding:0 clamp(16px,4vw,24px) 28px; }
    .table-scroll{ overflow:auto; border-radius:14px; border:1px solid var(--border); box-shadow:var(--shadow-1); background:var(--surface); }
    table.city-table{ width:100%; border-collapse:separate; border-spacing:0; }
    thead th{
      position:sticky; top:0; z-index:1;
      background:var(--surface);
      border-bottom:1px solid var(--border);
      text-align:left; font-weight:700; letter-spacing:-.01em;
      color:var(--muted); font-size:12.5px; padding:10px 12px; user-select:none; cursor: default;
    }
    th.sortable{ cursor:pointer; }
    th.sortable:after{
      content:""; display:inline-block; margin-left:6px; width:8px; height:8px; border-right:2px solid currentColor; border-bottom:2px solid currentColor; transform:rotate(-45deg) translateY(-1px); opacity:.25;
    }
    th.sort-asc:after{ transform:rotate(135deg) translateY(1px); opacity:.9; color:var(--primary); }
    th.sort-desc:after{ transform:rotate(-45deg) translateY(-1px); opacity:.9; color:var(--primary); }

    tbody td{
      padding:10px 12px; border-top:1px solid var(--border); vertical-align:middle; font-size:14px; color:var(--text);
    }
    .density-compact tbody td{ padding:6px 10px; font-size:13.5px; }
    tr.city-row:hover{ background:color-mix(in srgb, var(--surface) 92%, #000 8%); }
    .col-name{ font-weight:700; letter-spacing:-.01em; }
    .col-tz code{
      padding:2px 6px; border:1px solid var(--border); border-radius:8px;
      font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12.5px; color:var(--muted); background:transparent;
    }
    .muted{ color:var(--muted); }
    .empty-row td{ text-align:center; color:var(--muted); padding:18px 12px; }

    .pager{
      display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:10px;
      color:var(--muted); font-size:12.5px;
    }

    /* Drawer (editor) */
    .drawer{ position:fixed; inset:0; display:grid; grid-template-columns: 1fr min(520px, 96vw); z-index:50; }
    .drawer[hidden]{ display:none; }
    .drawer__backdrop{ background:rgba(0,0,0,.35); }
    .drawer__panel{
      background:var(--surface); border-left:1px solid var(--border);
      display:grid; grid-template-rows: auto 1fr auto; height:100%;
    }
    .drawer__header{ padding:12px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .drawer__title{ margin:0; font-size:16px; font-weight:700; color:var(--text); }
    .drawer__content{ padding:12px; overflow:auto; }
    .drawer__footer{ padding:12px; border-top:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:var(--muted); }

    .panel{ border:1px solid var(--border); border-radius:12px; padding:10px; background:transparent; display:grid; gap:8px; }
    .panel h4{ margin:0; font-size:15px; font-weight:700; color:var(--text); }
    .panel .hint{ margin:0; font-size:12.5px; color:var(--muted); }
    .panel .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:700px){ .panel .grid2{ grid-template-columns:1fr; } }
    .panel textarea, .panel select, .panel input[type="number"]{
      border:1px solid var(--border); background:var(--surface); color:var(--text);
      border-radius:10px; padding:10px 12px; font-size:14px; transition:border-color var(--t), box-shadow var(--t);
    }
    .panel textarea{ min-height:94px; }
    .panel :is(textarea,select,input):focus-visible{ outline:none; border-color:var(--primary); box-shadow:var(--ring); }

    .stage-accordion{ display:grid; gap:8px; }
    details.stage-item{ border:1px solid var(--border); border-radius:10px; background:transparent; transition:border-color var(--t); }
    details.stage-item[open]{ border-color:var(--primary); }
    details.stage-item > summary{ list-style:none; cursor:pointer; user-select:none; padding:10px 12px; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    details.stage-item > summary::-webkit-details-marker{ display:none; }
    .stage-item__title{ font-weight:700; font-size:14px; color:var(--text); }
    .stage-item__preview{ font-size:12.5px; color:var(--muted); max-width:60ch; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .stage-item__body{ padding:10px 12px 12px; display:grid; gap:8px; }
    .stage-hint{ margin:6px 0 0; font-size:12.5px; color:var(--muted); }

    .toast{ position:fixed; bottom:18px; left:50%; transform:translateX(-50%); background:var(--surface); border:1px solid var(--border); border-radius:999px; padding:8px 12px; box-shadow:var(--shadow-1); font-size:13.5px; color:var(--text); z-index:60; }
  </style>

  <header class="page-header">
    <div>
      <h1 id="cities-title" class="page-title">Города</h1>
      <p class="page-description">Чистая таблица. Все настройки открываются только при редактировании.</p>
    </div>
    <div class="page-actions">
      <a class="btn btn-primary" href="/cities/new" aria-label="Добавить новый город">+ Новый город</a>
    </div>
  </header>

  {% call list_toolbar(
    form_id="city_filters",
    method="get",
    mass_actions=[{'label': 'Сбросить', 'type': 'button', 'variant': 'ghost', 'button_type': 'button', 'attrs': 'id="city_reset" class="btn btn-ghost btn--small"'}],
    chips=[
      {'label': 'Всего', 'value': cities|length, 'tone': 'info', 'value_id': 'total_count'},
      {'label': 'Найдено', 'value': (cities|length|string) ~ ' / ' ~ (cities|length|string), 'tone': 'success', 'value_id': 'found_badge'}
    ]
  ) %}
    <div class="toolbar">
      <div class="form-field form-field--wide">
        <label for="city_search" class="visually-hidden">Поиск по городам</label>
        <input id="city_search" type="search" placeholder="Поиск: Москва, Novosibirsk, Europe/Moscow…" autocomplete="off" enterkeyhint="search">
        <small class="page-description">Горячие клавиши: <code>/</code> — фокус, <code>Esc</code> — очистка.</small>
      </div>

      <div class="segmented" role="group" aria-label="Плотность">
        <button id="density_comfy" type="button" aria-pressed="true">Обычный</button>
        <button id="density_compact" type="button" aria-pressed="false">Компактный</button>
      </div>

      <div class="chips">
        <span class="chip"><span class="dot"></span> Всего: <strong id="total_count">{{ cities|length }}</strong></span>
        <span class="chip">Найдено: <strong id="found_badge">{{ cities|length }} / {{ cities|length }}</strong></span>
        <span class="chip">На странице:
          <select id="per_page">
            <option value="10">10</option>
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="0">Все</option>
          </select>
        </span>
        <button id="city_reset" type="button" class="btn btn-ghost btn--small">Сбросить</button>
      </div>
    </div>
  {% endcall %}

  {% if not cities %}
    <div class="table-wrap">
      <div class="empty" role="status" aria-live="polite" style="text-align:center; padding:16px; background:var(--surface); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow-1);">
        <h3 class="page-title" style="font-size:18px">Пока пусто</h3>
        <p class="page-description" style="margin:6px 0 12px">Добавьте первый город, чтобы настроить планы и сообщения.</p>
        <a class="btn btn-primary" href="/cities/new">+ Новый город</a>
      </div>
    </div>
  {% else %}
    <div class="table-wrap">
      <div class="table-scroll" role="region" aria-label="Таблица городов">
        <table class="city-table" id="city_table" aria-describedby="cities-title">
          <thead>
            <tr>
              <th class="sortable" data-sort="name" aria-sort="none" style="min-width:220px">Город</th>
              <th class="sortable" data-sort="tz" aria-sort="none" style="min-width:180px">Часовой пояс</th>
              <th class="sortable" data-sort="owner" aria-sort="none" style="min-width:220px">Ответственный</th>
              <th class="sortable" data-sort="week" aria-sort="none" style="min-width:130px">План · нед</th>
              <th class="sortable" data-sort="month" aria-sort="none" style="min-width:130px">План · мес</th>
              <th style="min-width:140px; text-align:right;">Действия</th>
            </tr>
          </thead>
          <tbody id="cities_tbody">
            {% for c in cities %}
              {% set tz = c.tz or "Europe/Moscow" %}
              {% set criteria = c.criteria|default('') %}
              {% set experts = c.experts|default('') %}
              {% set plan_week = c.plan_week|default('') %}
              {% set plan_month = c.plan_month|default('') %}
              {% set owner_id = owners.get(c.id) %}
              {% set owner = rec_map.get(owner_id) if owner_id else None %}
              <tr class="city-row"
                  data-id="{{ c.id }}"
                  data-name="{{ c.name|lower }}"
                  data-tz="{{ tz|lower }}"
                  data-criteria="{{ criteria|e }}"
                  data-experts="{{ experts|e }}"
                  data-plan-week="{{ plan_week }}"
                  data-plan-month="{{ plan_month }}"
                  data-owner-id="{{ owner_id or '' }}">
                <td class="col-name">{{ c.name }}</td>
                <td class="col-tz"><code>{{ tz }}</code></td>
                <td class="col-owner">
                  <span class="owner-label {% if not owner %}muted{% endif %}">
                    {% if owner %}{{ owner.name }}{% else %}Не назначен{% endif %}
                  </span>
                </td>
                <td class="col-week" data-sort="{{ plan_week or 0 }}">{{ plan_week or '—' }}</td>
                <td class="col-month" data-sort="{{ plan_month or 0 }}">{{ plan_month or '—' }}</td>
                <td class="col-actions" style="text-align:right;">
                  <button class="btn btn-soft btn--small btn-edit" type="button" data-id="{{ c.id }}">Редактировать</button>
                </td>
              </tr>

              <!-- Шаблон формы для drawer (рендерим один раз на сервере, монтируем в drawer при открытии) -->
              <template id="tmpl-city-form-{{ c.id }}">
                <form class="city-form" data-id="{{ c.id }}" novalidate>
                  <div class="panel">
                    <h4>Основные параметры</h4>
                    <p class="hint">Ответственный и цели по найму.</p>
                    <div class="form-field">
                      <label for="owner_{{ c.id }}">Ответственный рекрутёр</label>
                      <select id="owner_{{ c.id }}" name="responsible_id">
                        <option value="">— Не назначен —</option>
                        {% for r in recruiters %}
                          <option value="{{ r.id }}" {% if owner_id == r.id %}selected{% endif %}>{{ r.name }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="panel grid2">
                      <div class="form-field">
                        <label for="pw_{{ c.id }}">План на неделю</label>
                        <input id="pw_{{ c.id }}" name="plan_week" type="number" inputmode="numeric" min="0" step="1" value="{{ plan_week }}" placeholder="Например, 12">
                      </div>
                      <div class="form-field">
                        <label for="pm_{{ c.id }}">План на месяц</label>
                        <input id="pm_{{ c.id }}" name="plan_month" type="number" inputmode="numeric" min="0" step="1" value="{{ plan_month }}" placeholder="Например, 48">
                      </div>
                    </div>
                  </div>

                  <div class="panel">
                    <h4>Профиль города</h4>
                    <p class="hint">Критерии и ресурсы.</p>

                    <details class="stage-item" open>
                      <summary>
                        <span class="stage-item__title">Критерии отбора</span>
                        <span class="stage-item__preview muted"></span>
                      </summary>
                      <div class="stage-item__body">
                        <textarea id="crit_{{ c.id }}" name="criteria" rows="4" placeholder="Опыт продаж от 6 мес, грамотная речь, готовность к гибридному формату…">{{ criteria }}</textarea>
                      </div>
                    </details>

                    <details class="stage-item">
                      <summary>
                        <span class="stage-item__title">Ресурсы экспертов</span>
                        <span class="stage-item__preview muted"></span>
                      </summary>
                      <div class="stage-item__body">
                        <textarea id="exp_{{ c.id }}" name="experts" rows="4" placeholder="Эксперт A: 10 ч/нед; Эксперт B: 6 ч/нед; Каналы: реферальный, ярмарки вакансий…">{{ experts }}</textarea>
                      </div>
                    </details>
                  </div>

                  <div class="panel">
                    <h4>Этапы и сообщения</h4>
                    <p class="hint">Тексты для кандидатов.</p>
                    {% set stages = city_stages.get(c.id, []) %}
                    <div class="stage-accordion">
                      {% for stage in stages %}
                        <details class="stage-item" data-stage="{{ stage.key }}">
                          <summary>
                            <span class="stage-item__title">{{ stage.title }}</span>
                            <span class="stage-item__preview muted">Текст по умолчанию</span>
                          </summary>
                          <div class="stage-item__body">
                            <textarea
                              id="stage_{{ stage.key }}_{{ c.id }}"
                              name="stage__{{ stage.key }}"
                              data-stage="{{ stage.key }}"
                              data-default="{{ stage.default|e }}"
                              rows="5"
                              placeholder="{{ stage.default|e }}">{{ stage.value }}</textarea>
                            <div class="form-actions">
                              <button type="button" class="btn btn-ghost btn--small stage-default-btn" data-stage="{{ stage.key }}">Вставить по умолчанию</button>
                              <span class="page-description">{{ stage.description }}</span>
                            </div>
                          </div>
                        </details>
                      {% endfor %}
                    </div>
                    <p class="stage-hint">
                      {% raw %}
                      Переменные: <code>{{candidate_fio}}</code>, <code>{{city_name}}</code>, <code>{{interview_dt_hint}}</code>, <code>{{slot_date_local}}</code>, <code>{{slot_time_local}}</code>, <code>{{slot_datetime_local}}</code>, <code>{{recruiter_name}}</code>, <code>{{address}}</code>.
                      {% endraw %}
                    </p>
                  </div>

                  <div class="drawer__footer">
                    <div class="badge save-status" aria-live="polite">Готово к сохранению</div>
                    <div class="form-actions">
                      <button type="button" class="btn btn-ghost btn-cancel">Отмена</button>
                      <button type="submit" class="btn btn-primary">Сохранить</button>
                    </div>
                  </div>
                </form>
              </template>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="pager" id="pager" aria-live="polite">
        <div><strong id="pager_info">Стр. 1 / 1</strong></div>
        <div class="form-actions">
          <button class="btn btn-ghost btn--small" id="prev_page" type="button">← Назад</button>
          <button class="btn btn-ghost btn--small" id="next_page" type="button">Вперёд →</button>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Drawer -->
  <div class="drawer" id="drawer" hidden aria-hidden="