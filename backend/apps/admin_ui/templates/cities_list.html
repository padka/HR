{% extends "base.html" %}
{% from "partials/list_toolbar.html" import list_toolbar %}
{% block title %}–ì–æ—Ä–æ–¥–∞{% endblock %}
{% block content %}
{% set city_count = cities|length %}
<section class="page page--cities" data-page="cities" aria-labelledby="cities-title">
  <header class="page-header">
    <div>
      <h1 id="cities-title" class="page-title">–ì–æ—Ä–æ–¥–∞</h1>
      <p class="page-description">
        –¢–∞–±–ª–∏—á–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ç–µ–∫—Å—Ç—ã –¥–ª—è —ç—Ç–∞–ø–æ–≤ ‚Äî –≤–æ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–π –ø–∞–Ω–µ–ª–∏ ¬´–ù–∞—Å—Ç—Ä–æ–∏—Ç—å¬ª.
      </p>
    </div>
    <div class="page-actions">
      <a class="btn btn-primary" href="/cities/new" aria-label="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –≥–æ—Ä–æ–¥">+ –ù–æ–≤—ã–π –≥–æ—Ä–æ–¥</a>
    </div>
  </header>

  {% call list_toolbar(
    form_id="city_filters",
    method="get",
    form_attrs='novalidate',
    mass_actions=[{'label': '–°–±—Ä–æ—Å–∏—Ç—å', 'type': 'button', 'variant': 'ghost', 'button_type': 'button', 'attrs': 'id="city_reset"'}],
    chips=[
      {'label': '–í—Å–µ–≥–æ', 'value': city_count, 'tone': 'info', 'value_id': 'total_count'},
      {'label': '–ù–∞–π–¥–µ–Ω–æ', 'value': (city_count|string) ~ ' / ' ~ (city_count|string), 'tone': 'success', 'value_id': 'found_badge'}
    ]
  ) %}
    <div class="form-field form-field--wide">
      <label for="city_search">–ü–æ–∏—Å–∫ –ø–æ –≥–æ—Ä–æ–¥–∞–º</label>
      <input id="city_search" type="search" placeholder="–ü–æ–∏—Å–∫: –ú–æ—Å–∫–≤–∞, Novosibirsk, Europe/Moscow‚Ä¶" autocomplete="off" enterkeyhint="search">
      <p class="form-note form-note--inline">–°–æ—á–µ—Ç–∞–Ω–∏—è: <code>/</code> ‚Äî —Ñ–æ–∫—É—Å –ø–æ–∏—Å–∫–∞, <code>‚Üë/‚Üì</code> ‚Äî –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–æ–∫–∞–º, <code>Enter</code> ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å.</p>
    </div>
  {% endcall %}

  {% if not cities %}
    <div class="card glass grain">
      <h3 class="section-title">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</h3>
      <p class="page-description">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –≥–æ—Ä–æ–¥, —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–ª–∞–Ω—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è.</p>
      <div class="page-actions">
        <a class="btn btn-primary" href="/cities/new">+ –ù–æ–≤—ã–π –≥–æ—Ä–æ–¥</a>
      </div>
    </div>
  {% else %}
    <article class="card glass grain city-table-card">
      <div class="list-table-wrapper">
        <table class="list-table list-table--responsive city-table" id="city_table">
          <thead>
            <tr>
              <th scope="col" class="sortable">
                <button class="sort" type="button" data-key="name" aria-sort="ascending">
                  –ì–æ—Ä–æ–¥ <span class="arrow" aria-hidden="true"></span>
                </button>
              </th>
              <th scope="col" class="sortable">
                <button class="sort" type="button" data-key="tz" aria-sort="none">
                  –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å <span class="arrow" aria-hidden="true"></span>
                </button>
              </th>
              <th scope="col" class="sortable">
                <button class="sort" type="button" data-key="owner" aria-sort="none">
                  –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π <span class="arrow" aria-hidden="true"></span>
                </button>
              </th>
              <th scope="col" class="sortable col-align-end">
                <button class="sort" type="button" data-key="week" aria-sort="none">
                  –ü–ª–∞–Ω ¬∑ –Ω–µ–¥ <span class="arrow" aria-hidden="true"></span>
                </button>
              </th>
              <th scope="col" class="sortable col-align-end">
                <button class="sort" type="button" data-key="month" aria-sort="none">
                  –ü–ª–∞–Ω ¬∑ –º–µ—Å <span class="arrow" aria-hidden="true"></span>
                </button>
              </th>
              <th scope="col" class="col-actions">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody id="cities_tbody">
            {% for c in cities %}
              {% set tz = c.tz or "Europe/Moscow" %}
              {% set criteria = c.criteria|default('') %}
              {% set experts = c.experts|default('') %}
              {% set plan_week = c.plan_week|default('') %}
              {% set plan_month = c.plan_month|default('') %}
              {% set owner_id = owners.get(c.id) %}
              {% set owner = rec_map.get(owner_id) if owner_id else None %}
              {% set stages = city_stages.get(c.id, []) %}
              <tr class="city-row"
                  tabindex="0"
                  data-id="{{ c.id }}"
                  data-name="{{ c.name|lower }}"
                  data-tz="{{ tz|lower }}"
                  data-owner="{{ (owner.name if owner else '')|lower }}"
                  data-criteria="{{ criteria|e }}"
                  data-experts="{{ experts|e }}"
                  data-plan-week="{{ plan_week }}"
                  data-plan-month="{{ plan_month }}"
                  data-owner-id="{{ owner_id or '' }}">
                <td data-label="–ì–æ—Ä–æ–¥" class="col-name">
                  <span class="cell-title">{{ c.name }}</span>
                </td>
                <td data-label="–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å" class="col-tz">
                  <span class="badge badge--soft"><code>{{ tz }}</code></span>
                </td>
                <td data-label="–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π" class="col-owner">
                  <span class="owner-label {% if not owner %}muted{% endif %}">
                    {% if owner %}{{ owner.name }}{% else %}–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω{% endif %}
                  </span>
                </td>
                <td data-label="–ü–ª–∞–Ω ¬∑ –Ω–µ–¥" class="col-week" data-sort="{{ plan_week or 0 }}">
                  {{ plan_week or '‚Äî' }}
                </td>
                <td data-label="–ü–ª–∞–Ω ¬∑ –º–µ—Å" class="col-month" data-sort="{{ plan_month or 0 }}">
                  {{ plan_month or '‚Äî' }}
                </td>
                <td data-label="" class="cell-actions">
                  <button class="btn btn-soft btn--small btn-edit" type="button">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</button>
                </td>
              </tr>
              <template id="tpl-stages-{{ c.id }}">
                <div class="stage-accordion">
                  {% for stage in stages %}
                    <details class="stage-item" data-stage="{{ stage.key }}">
                      <summary>
                        <div class="stage-item__summary">
                          <span class="stage-item__title">{{ stage.title }}</span>
                          <span class="stage-item__preview muted">–¢–µ–∫—Å—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
                        </div>
                      </summary>
                      <div class="stage-item__body">
                        <textarea
                          id="stage_{{ stage.key }}_{{ c.id }}"
                          name="stage__{{ stage.key }}"
                          data-stage="{{ stage.key }}"
                          data-default="{{ stage.default|e }}"
                          rows="5"
                          placeholder="{{ stage.default|e }}">{{ stage.value }}</textarea>
                        <div class="stage-controls">
                          <button type="button" class="btn btn-ghost btn--small stage-default-btn" data-stage="{{ stage.key }}">–í—Å—Ç–∞–≤–∏—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</button>
                          <span class="muted">{{ stage.description }}</span>
                        </div>
                      </div>
                    </details>
                  {% endfor %}
                </div>
                <p class="stage-hint muted">
                  {% raw %}
                  –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: <code>{{candidate_fio}}</code>, <code>{{city_name}}</code>, <code>{{interview_dt_hint}}</code>, <code>{{slot_date_local}}</code>, <code>{{slot_time_local}}</code>, <code>{{slot_datetime_local}}</code>, <code>{{recruiter_name}}</code>, <code>{{address}}</code>.
                  {% endraw %}
                </p>
              </template>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </article>
  {% endif %}

  <div id="sheet_backdrop" class="sheet-backdrop" hidden></div>
  <aside id="sheet" class="sheet city-drawer" hidden aria-modal="true" role="dialog" aria-labelledby="sheet-title">
    <header class="sheet-header">
      <div>
        <h3 id="sheet-title" class="sheet-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞</h3>
        <p id="sheet-sub" class="sheet-sub muted"></p>
      </div>
      <button id="sheet_close" class="btn btn-ghost btn--small" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
    </header>

    <form id="sheet_form" class="sheet-body city-sheet" novalidate>
      <input type="hidden" name="city_id" id="city_id">

      <section class="city-panel">
        <div class="city-panel__header">
          <span class="city-panel__icon" aria-hidden="true">üèô</span>
          <div>
            <h4 class="city-panel__title">–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h4>
            <p class="city-panel__hint">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∏ —Ü–µ–ª–∏ –ø–æ –Ω–∞–π–º—É.</p>
          </div>
        </div>
        <div class="city-panel__body">
          <div class="form-field">
            <label for="owner_select">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–µ–∫—Ä—É—Ç—ë—Ä</label>
            <select id="owner_select" name="responsible_id">
              <option value="">‚Äî –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω ‚Äî</option>
              {% for r in recruiters %}
                <option value="{{ r.id }}">{{ r.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="city-form__row">
            <div class="form-field form-field--compact">
              <label for="plan_week">–ü–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é</label>
              <input id="plan_week" name="plan_week" type="number" inputmode="numeric" min="0" step="1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 12">
            </div>
            <div class="form-field form-field--compact">
              <label for="plan_month">–ü–ª–∞–Ω –Ω–∞ –º–µ—Å—è—Ü</label>
              <input id="plan_month" name="plan_month" type="number" inputmode="numeric" min="0" step="1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 48">
            </div>
          </div>
        </div>
      </section>

      <section class="city-panel">
        <div class="city-panel__header">
          <span class="city-panel__icon" aria-hidden="true">üóÇ</span>
          <div>
            <h4 class="city-panel__title">–ü—Ä–æ—Ñ–∏–ª—å –≥–æ—Ä–æ–¥–∞</h4>
            <p class="city-panel__hint">–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∏ —Ä–µ—Å—É—Ä—Å—ã.</p>
          </div>
        </div>
        <div class="city-panel__body city-panel__body--stacked">
          <details class="city-collapse" open>
            <summary>
              <span>–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ç–±–æ—Ä–∞</span>
              <span id="crit_preview" class="muted">‚Äî</span>
            </summary>
            <div class="city-collapse__body">
              <textarea id="criteria" name="criteria" rows="4" placeholder="–û–ø—ã—Ç –ø—Ä–æ–¥–∞–∂ –æ—Ç 6 –º–µ—Å, –≥—Ä–∞–º–æ—Ç–Ω–∞—è —Ä–µ—á—å, –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –≥–∏–±—Ä–∏–¥–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É‚Ä¶"></textarea>
            </div>
          </details>
          <details class="city-collapse">
            <summary>
              <span>–†–µ—Å—É—Ä—Å—ã —ç–∫—Å–ø–µ—Ä—Ç–æ–≤</span>
              <span id="exp_preview" class="muted">‚Äî</span>
            </summary>
            <div class="city-collapse__body">
              <textarea id="experts" name="experts" rows="4" placeholder="–≠–∫—Å–ø–µ—Ä—Ç A: 10 —á/–Ω–µ–¥; –≠–∫—Å–ø–µ—Ä—Ç B: 6 —á/–Ω–µ–¥; –ö–∞–Ω–∞–ª—ã: —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π, —è—Ä–º–∞—Ä–∫–∏ –≤–∞–∫–∞–Ω—Å–∏–π‚Ä¶"></textarea>
            </div>
          </details>
        </div>
      </section>

      <section class="city-panel city-panel--stages" id="sheet_stages">
        <div class="city-panel__header">
          <span class="city-panel__icon" aria-hidden="true">‚úâÔ∏è</span>
          <div>
            <h4 class="city-panel__title">–≠—Ç–∞–ø—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è</h4>
            <p class="city-panel__hint">–¢–µ–∫—Å—Ç—ã –¥–ª—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤. –ú–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –≤–µ—Ä–Ω—É—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç.</p>
          </div>
        </div>
        <div id="sheet_stages_body" class="city-panel__body city-panel__body--stacked">
          <p class="muted stage-placeholder">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –≤ —Ç–∞–±–ª–∏—Ü–µ, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç—ã.</p>
        </div>
      </section>
    </form>

    <footer class="sheet-footer">
      <span id="save_status" class="save-status muted" aria-live="polite">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>
      <div class="form-actions">
        <button id="btn_save" class="btn btn-primary" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="btn_cancel" class="btn btn-ghost" type="button">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </footer>
  </aside>

  <div id="toasts" class="toast-stack" aria-live="polite" aria-atomic="true"></div>
</section>

<script>
(function(){
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const on = (el, ev, cb, opts)=>el && el.addEventListener(ev, cb, opts);

  const table = $('#city_table');
  const tbody = $('#cities_tbody');
  const search = $('#city_search');
  const reset = $('#city_reset');
  const foundBadge = $('#found_badge');

  const sheet = $('#sheet');
  const sheetBackdrop = $('#sheet_backdrop');
  const sheetForm = $('#sheet_form');
  const sheetStages = $('#sheet_stages');
  const sheetStagesBody = $('#sheet_stages_body');
  const sheetTitle = $('#sheet-title');
  const sheetSub = $('#sheet-sub');
  const sheetClose = $('#sheet_close');
  const btnSave = $('#btn_save');
  const btnCancel = $('#btn_cancel');
  const saveStatus = $('#save_status');

  const inputId = $('#city_id');
  const selOwner = $('#owner_select');
  const inWeek = $('#plan_week');
  const inMonth = $('#plan_month');
  const taCriteria = $('#criteria');
  const taExperts = $('#experts');
  const prevCrit = $('#crit_preview');
  const prevExp = $('#exp_preview');

  if (!tbody) return;

  const rows = $$('.city-row', tbody);
  const totalCount = rows.length;

  const debounce = (fn, ms=180)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
  const norm = (s)=> (s||'').toString().trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

  const truncate = (v, n=120)=>!v ? '‚Äî' : (v.length>n ? v.slice(0,n).trimEnd()+'‚Ä¶' : v);

  const stagePlaceholderHTML = '<p class="muted stage-placeholder">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –≤ —Ç–∞–±–ª–∏—Ü–µ, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç—ã.</p>';
  function resetStagePlaceholder(){
    if (sheetStagesBody){
      sheetStagesBody.innerHTML = stagePlaceholderHTML;
    }
  }

  function toast(text, kind='info'){
    const wrap = $('#toasts');
    if (!wrap) return;
    const t = document.createElement('div');
    t.className = 'toast';
    t.dataset.kind = kind;
    t.role = 'status';
    t.textContent = text;
    wrap.appendChild(t);
    setTimeout(()=>{ t.classList.add('toast--hide'); }, 2000);
    setTimeout(()=>{ t.remove(); }, 2600);
  }

  const sortState = { key: 'name', dir: 'asc' };
  function getCellValue(row, key){
    switch(key){
      case 'name':  return row.dataset.name || '';
      case 'tz':    return row.dataset.tz || '';
      case 'owner': return row.dataset.owner || '';
      case 'week':  return Number(row.querySelector('.col-week')?.dataset.sort || 0);
      case 'month': return Number(row.querySelector('.col-month')?.dataset.sort || 0);
      default: return '';
    }
  }
  function applySort(){
    const rowsArr = Array.from(rows).filter(r=>r.style.display !== 'none');
    rowsArr.sort((a,b)=>{
      const av = getCellValue(a, sortState.key);
      const bv = getCellValue(b, sortState.key);
      if (typeof av === 'number' || typeof bv === 'number'){
        return sortState.dir === 'asc' ? (av - bv) : (bv - av);
      }
      const cmp = String(av).localeCompare(String(bv), 'ru', { sensitivity:'base' });
      return sortState.dir === 'asc' ? cmp : -cmp;
    });
    rowsArr.forEach(r=> tbody.appendChild(r));
    $$('.sort', table).forEach(btn=>{
      const dir = (btn.dataset.key === sortState.key) ? (sortState.dir==='asc'?'ascending':'descending') : 'none';
      btn.setAttribute('aria-sort', dir);
      btn.classList.toggle('is-active', btn.dataset.key === sortState.key);
    });
  }

  on(table, 'click', (e)=>{
    const btn = e.target.closest('button.sort'); if (!btn) return;
    const key = btn.dataset.key;
    if (!key) return;
    if (sortState.key === key){
      sortState.dir = (sortState.dir === 'asc') ? 'desc' : 'asc';
    } else {
      sortState.key = key; sortState.dir = 'asc';
    }
    applySort();
  });

  function applyFilter(){
    const q = norm(search?.value);
    let visible = 0;
    rows.forEach(r=>{
      const ok = !q || (r.dataset.name||'').includes(q) || (r.dataset.tz||'').includes(q) || (r.dataset.owner||'').includes(q);
      r.style.display = ok ? '' : 'none';
      if (ok) visible++;
    });
    if (foundBadge) foundBadge.textContent = visible + ' / ' + totalCount;
    applySort();
  }
  const applyFilterDebounced = debounce(applyFilter, 120);

  on(search, 'input', applyFilterDebounced);
  on(reset, 'click', ()=>{ if (search) search.value=''; applyFilter(); search?.focus(); });

  let currentRow = null;
  let isDirty = false;
  function setDirty(v){
    isDirty = v;
    saveStatus.textContent = v ? '–ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è' : '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
    saveStatus.classList.toggle('ok', !v);
    saveStatus.classList.toggle('err', false);
  }

  function openSheetForRow(row){
    currentRow = row;
    const id = row.dataset.id;
    const name = row.querySelector('.col-name')?.textContent?.trim() || '–ì–æ—Ä–æ–¥';
    sheetTitle.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${name}`;
    sheetSub.textContent = `ID: ${id}`;
    inputId.value = id;

    selOwner.value = row.dataset.ownerId || '';
    inWeek.value = row.dataset.planWeek || '';
    inMonth.value = row.dataset.planMonth || '';
    taCriteria.value = row.dataset.criteria || '';
    taExperts.value = row.dataset.experts || '';
    prevCrit.textContent = truncate(taCriteria.value);
    prevExp.textContent = truncate(taExperts.value);

    if (sheetStagesBody){
      sheetStagesBody.innerHTML = '';
      const tplEl = document.getElementById(`tpl-stages-${id}`);
      if (tplEl instanceof HTMLTemplateElement && tplEl.content){
        const frag = tplEl.content.cloneNode(true);
        sheetStagesBody.appendChild(frag);
        sheetStagesBody.querySelectorAll('details.stage-item').forEach(d=>{
          const ta = d.querySelector('textarea[data-stage]');
          const prev = d.querySelector('.stage-item__preview');
          const updatePrev = ()=>{ prev.textContent = (ta.value.trim() ? truncate(ta.value) : '–¢–µ–∫—Å—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é'); };
          if (ta){
            ta.addEventListener('input', ()=>{ setDirty(true); updatePrev(); });
            updatePrev();
          }
        });
        sheetStagesBody.querySelectorAll('.stage-default-btn').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const key = btn.getAttribute('data-stage');
            if (!key) return;
            const ta = sheetStagesBody.querySelector(`textarea[data-stage="${CSS.escape(key)}"]`);
            if (ta){
              ta.value = ta.dataset.default || '';
              ta.dispatchEvent(new Event('input',{bubbles:true}));
              ta.focus();
            }
          });
        });
      } else {
        resetStagePlaceholder();
      }
    }

    [selOwner,inWeek,inMonth,taCriteria,taExperts].forEach(el=>{
      el.addEventListener('input', ()=> setDirty(true), { once:false });
    });

    sheet.hidden = false; sheetBackdrop.hidden = false;
    document.body.classList.add('sheet-open');
    requestAnimationFrame(()=>{
      sheet.classList.add('open'); sheetBackdrop.classList.add('open');
    });
    setDirty(false);
    selOwner.focus();
  }

  function tryCloseSheet(){
    if (isDirty){
      const ok = confirm('–ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –ó–∞–∫—Ä—ã—Ç—å –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è?');
      if (!ok) return;
    }
    closeSheet(true);
  }
  function closeSheet(reset=false){
    sheet.classList.remove('open'); sheetBackdrop.classList.remove('open');
    setTimeout(()=>{
      sheet.hidden = true; sheetBackdrop.hidden = true;
      document.body.classList.remove('sheet-open');
      if (reset){ sheetForm.reset(); resetStagePlaceholder(); prevCrit.textContent = '‚Äî'; prevExp.textContent = '‚Äî'; }
      currentRow = null; isDirty = false;
    }, 220);
  }

  on(sheetBackdrop, 'click', tryCloseSheet);
  on(sheetClose, 'click', tryCloseSheet);
  on(btnCancel, 'click', tryCloseSheet);

  on(document, 'keydown', (e)=>{
    if (!sheet.hidden){
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's'){ e.preventDefault(); doSave(); }
      if (e.key === 'Escape'){ e.preventDefault(); tryCloseSheet(); }
    } else {
      if (e.key === '/' && document.activeElement !== search){ e.preventDefault(); search?.focus(); }
      const focusRow = document.activeElement?.closest?.('tr.city-row');
      if (e.key === 'Enter' && focusRow){ e.preventDefault(); focusRow.querySelector('.btn-edit')?.click(); }
      if (['ArrowDown','ArrowUp'].includes(e.key)){
        e.preventDefault();
        const visibleRows = rows.filter(r=>r.style.display !== 'none');
        const idx = visibleRows.indexOf(focusRow);
        let next = null;
        if (e.key === 'ArrowDown'){ next = visibleRows[Math.min(idx+1, visibleRows.length-1)] || visibleRows[0]; }
        else { next = visibleRows[Math.max(idx-1, 0)] || visibleRows[0]; }
        next?.focus();
      }
    }
  });

  on(tbody,'click',(e)=>{
    const btn = e.target.closest('.btn-edit');
    if (!btn) return;
    const row = btn.closest('tr.city-row');
    if (!row) return;
    openSheetForRow(row);
  });
  on(tbody,'dblclick',(e)=>{
    const row = e.target.closest('tr.city-row');
    if (!row) return;
    openSheetForRow(row);
  });

  async function doSave(){
    if (!currentRow) return;
    const id = inputId.value;

    const ownerId = (selOwner.value || '').trim();
    const plan_week = inWeek.value ? parseInt(inWeek.value,10) : null;
    const plan_month = inMonth.value ? parseInt(inMonth.value,10) : null;

    const templates = {};
    const stageScope = sheetStagesBody || sheetStages;
    stageScope?.querySelectorAll('textarea[data-stage]').forEach(ta=>{
      const k = ta.dataset.stage; if (k) templates[k] = ta.value.trim();
    });

    const ownerLabel = currentRow.querySelector('.owner-label');
    const colWeek = currentRow.querySelector('.col-week');
    const colMonth = currentRow.querySelector('.col-month');

    const prev = {
      criteria: currentRow.dataset.criteria,
      experts: currentRow.dataset.experts,
      planWeek: currentRow.dataset.planWeek,
      planMonth: currentRow.dataset.planMonth,
      ownerId: currentRow.dataset.ownerId,
      ownerText: ownerLabel?.textContent,
      weekText: colWeek?.textContent,
      monthText: colMonth?.textContent,
      weekSort: colWeek?.dataset.sort,
      monthSort: colMonth?.dataset.sort
    };

    saveStatus.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶';
    saveStatus.classList.add('ok'); saveStatus.classList.remove('err');

    currentRow.dataset.criteria = taCriteria.value.trim();
    currentRow.dataset.experts = taExperts.value.trim();
    currentRow.dataset.planWeek = plan_week ?? '';
    currentRow.dataset.planMonth = plan_month ?? '';
    currentRow.dataset.ownerId = ownerId ? String(Number(ownerId)) : '';
    currentRow.dataset.owner = ownerId ? selOwner.options[selOwner.selectedIndex].textContent.trim().toLowerCase() : '';

    if (ownerLabel){
      if (ownerId){
        ownerLabel.textContent = selOwner.options[selOwner.selectedIndex].textContent;
        ownerLabel.classList.remove('muted');
      } else {
        ownerLabel.textContent = '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
        ownerLabel.classList.add('muted');
      }
    }
    if (colWeek){ colWeek.textContent = plan_week ?? '‚Äî'; colWeek.dataset.sort = String(plan_week ?? 0); }
    if (colMonth){ colMonth.textContent = plan_month ?? '‚Äî'; colMonth.dataset.sort = String(plan_month ?? 0); }

    try{
      const resp = await fetch(`/cities/${id}/settings`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({
          criteria: taCriteria.value.trim(),
          experts: taExperts.value.trim(),
          plan_week, plan_month,
          templates,
          responsible_recruiter_id: ownerId ? Number(ownerId) : null
        })
      });
      const json = await resp.json();
      if (!json || json.ok !== true) throw new Error(json && json.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');

      setDirty(false);
      saveStatus.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
      saveStatus.classList.add('ok'); saveStatus.classList.remove('err');

      toast('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
      closeSheet(false);
      applySort();
    }catch(err){
      currentRow.dataset.criteria = prev.criteria ?? '';
      currentRow.dataset.experts = prev.experts ?? '';
      currentRow.dataset.planWeek = prev.planWeek ?? '';
      currentRow.dataset.planMonth = prev.planMonth ?? '';
      currentRow.dataset.ownerId = prev.ownerId ?? '';
      if (ownerLabel){ ownerLabel.textContent = prev.ownerText ?? ownerLabel.textContent; }
      if (colWeek){ colWeek.textContent = prev.weekText ?? colWeek.textContent; colWeek.dataset.sort = prev.weekSort ?? '0'; }
      if (colMonth){ colMonth.textContent = prev.monthText ?? colMonth.textContent; colMonth.dataset.sort = prev.monthSort ?? '0'; }
      saveStatus.textContent = '–û—à–∏–±–∫–∞';
      saveStatus.classList.remove('ok'); saveStatus.classList.add('err');
      if (navigator.vibrate) navigator.vibrate(60);
      toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å', 'error');
    }
  }
  on(btnSave, 'click', doSave);

  on(taCriteria, 'input', ()=>{ prevCrit.textContent = truncate(taCriteria.value); setDirty(true); });
  on(taExperts, 'input', ()=>{ prevExp.textContent = truncate(taExperts.value); setDirty(true); });

  window.addEventListener('beforeunload', (e)=>{
    if (!sheet.hidden && isDirty){ e.preventDefault(); e.returnValue = ''; }
  });

  resetStagePlaceholder();
  applyFilter();
})();
</script>
{% endblock %}
