{% extends "base.html" %}
{% from "partials/list_toolbar.html" import list_toolbar %}
{% block title %}Города{% endblock %}
{% block content %}
<section class="page">
  <header class="page-header">
    <div>
      <h1 class="page-title">Города</h1>
      <p class="page-description">Управляйте ответственными, планами и текстами сообщений для каждого города.</p>
    </div>
    <div class="page-actions">
      <a class="btn btn-primary" href="/cities/new">+ Новый город</a>
    </div>
  </header>

  {% call list_toolbar(
    form_id="city_filters",
    method="get",
    mass_actions=[{'label': 'Сбросить', 'type': 'button', 'variant': 'ghost', 'button_type': 'button', 'attrs': 'id="city_reset"'}],
    chips=[
      {'label': 'Всего', 'value': cities|length, 'tone': 'info', 'value_id': 'total_count'},
      {'label': 'Найдено', 'value': (cities|length|string) ~ ' / ' ~ (cities|length|string), 'tone': 'success', 'value_id': 'found_badge'}
    ]
  ) %}
    <div class="form-field form-field--wide">
      <label for="city_search">Поиск</label>
      <input id="city_search" type="search" placeholder="Москва, Novosibirsk, Europe/Moscow…">
    </div>
  {% endcall %}

  {% if not cities %}
    <div class="card glass grain">
      <h3 class="section-title">Пока пусто</h3>
      <p class="page-description">Добавьте город, чтобы настроить сообщения и ответственных.</p>
      <div class="page-actions">
        <a class="btn btn-primary" href="/cities/new">+ Новый город</a>
      </div>
    </div>
  {% else %}
    <div class="city-collection" id="cities_list">
      {% for c in cities %}
        {% set tz = c.tz or "Europe/Moscow" %}
        {% set criteria = c.criteria|default('') %}
        {% set experts = c.experts|default('') %}
        {% set plan_week = c.plan_week|default('') %}
        {% set plan_month = c.plan_month|default('') %}
        {% set owner_id = owners.get(c.id) %}
        {% set owner = rec_map.get(owner_id) if owner_id else None %}
        <article class="city-card"
                 data-id="{{ c.id }}"
                 data-name="{{ c.name|lower }}"
                 data-tz="{{ tz|lower }}"
                 data-criteria="{{ criteria|e }}"
                 data-experts="{{ experts|e }}"
                 data-plan-week="{{ plan_week }}"
                 data-plan-month="{{ plan_month }}"
                 data-owner-id="{{ owner_id or '' }}">
          <div class="city-card__header">
            <div class="city-card__title">
              <span class="city-name">{{ c.name }}</span>
              {% if not c.tz %}
                <span class="badge" title="Используется TZ по умолчанию">TZ: Europe/Moscow</span>
              {% endif %}
            </div>
            <div class="city-card__meta">
              <span class="city-tz">TZ: <code>{{ tz }}</code></span>
              <span class="city-owner {% if not owner %}muted{% endif %}">
                {% if owner %}
                  {{ owner.name }}
                {% else %}
                  Не назначен
                {% endif %}
              </span>
              <span class="badge plan-badge">
                {% if plan_week or plan_month %}
                  Нед: {{ plan_week or '—' }} · Мес: {{ plan_month or '—' }}
                {% else %}
                  Параметры не заданы
                {% endif %}
              </span>
            </div>
            <div class="city-card__actions">
              <button class="btn btn-soft btn-edit" type="button" title="Настроить город">Настроить</button>
            </div>
          </div>
          <div class="city-card__details" hidden>
            <form class="city-form" data-id="{{ c.id }}">
              <div class="form-field">
                <label for="owner_{{ c.id }}">Ответственный рекрутёр</label>
                <select id="owner_{{ c.id }}" name="responsible_id" class="responsible-select">
                  <option value="">— Не назначен —</option>
                  {% for r in recruiters %}
                    <option value="{{ r.id }}" {% if owner_id == r.id %}selected{% endif %}>{{ r.name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="form-grid">
                <div class="form-field">
                  <label for="crit_{{ c.id }}">Критерии отбора</label>
                  <textarea id="crit_{{ c.id }}" name="criteria" rows="4" placeholder="Опыт продаж от 6 мес, грамотная речь, готовность к гибридному формату…">{{ criteria }}</textarea>
                </div>
                <div class="form-field">
                  <label for="exp_{{ c.id }}">Ресурсы экспертов</label>
                  <textarea id="exp_{{ c.id }}" name="experts" rows="4" placeholder="Эксперт A: 10 ч/нед; Эксперт B: 6 ч/нед; Каналы: внутренний реферальный, ярмарки вакансий…">{{ experts }}</textarea>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-field">
                  <label for="pw_{{ c.id }}">План набора (неделя)</label>
                  <input id="pw_{{ c.id }}" name="plan_week" type="number" min="0" step="1" value="{{ plan_week }}" placeholder="Например, 12">
                </div>
                <div class="form-field">
                  <label for="pm_{{ c.id }}">План набора (месяц)</label>
                  <input id="pm_{{ c.id }}" name="plan_month" type="number" min="0" step="1" value="{{ plan_month }}" placeholder="Например, 48">
                </div>
              </div>

              <div class="stage-block">
                <h4>Шаги и шаблоны сообщений</h4>
                <p class="muted">Настройте тексты, которые бот отправит кандидату на каждом этапе. Оставьте поле пустым, чтобы использовать текст по умолчанию.</p>
                {% set stages = city_stages.get(c.id, []) %}
                {% for stage in stages %}
                  <div class="stage-field" data-stage="{{ stage.key }}">
                    <label for="stage_{{ stage.key }}_{{ c.id }}">{{ stage.title }}</label>
                    <textarea
                      id="stage_{{ stage.key }}_{{ c.id }}"
                      name="stage__{{ stage.key }}"
                      data-stage="{{ stage.key }}"
                      data-default="{{ stage.default|e }}"
                      rows="6"
                      placeholder="{{ stage.default|e }}">{{ stage.value }}</textarea>
                    <div class="stage-controls">
                      <button type="button" class="btn btn-ghost btn--small stage-default-btn" data-stage="{{ stage.key }}">Вставить текст по умолчанию</button>
                      <span class="muted">{{ stage.description }}</span>
                    </div>
                  </div>
                {% endfor %}
                <p class="muted">
                  {% raw %}
                  Доступные переменные: <code>{{candidate_fio}}</code>, <code>{{city_name}}</code>, <code>{{interview_dt_hint}}</code>, <code>{{slot_date_local}}</code>, <code>{{slot_time_local}}</code>, <code>{{slot_datetime_local}}</code>, <code>{{recruiter_name}}</code>, <code>{{address}}</code>.
                  {% endraw %}
                </p>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn-primary">Сохранить</button>
                <button type="button" class="btn btn-ghost btn-cancel">Отмена</button>
                <span class="badge muted save-status">Сохранено</span>
              </div>
            </form>
          </div>
        </article>
      {% endfor %}
    </div>
  {% endif %}
</section>

<script>
(function(){
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

  const list = $('#cities_list');
  const search = $('#city_search');
  const reset = $('#city_reset');
  const foundBadge = $('#found_badge');

  if (!list) return;

  const cards = $$('.city-card', list);
  const totalCount = cards.length;

  function norm(s){ return (s||'').toString().trim().toLowerCase(); }

  function closeAll(){
    cards.forEach(card => {
      card.classList.remove('open');
      const details = card.querySelector('.city-card__details');
      if (details) details.hidden = true;
    });
  }

  function applyFilter(){
    const q = norm(search?.value);
    let visible = 0;
    cards.forEach(card => {
      const name = card.dataset.name || '';
      const tz = card.dataset.tz || '';
      const ok = !q || name.includes(q) || tz.includes(q);
      if (ok) {
        card.style.display = '';
        visible++;
      } else {
        card.style.display = 'none';
        card.classList.remove('open');
        const details = card.querySelector('.city-card__details');
        if (details) details.hidden = true;
      }
    });
    if (foundBadge) foundBadge.textContent = visible + ' / ' + totalCount;
  }

  search && search.addEventListener('input', applyFilter);
  reset && reset.addEventListener('click', () => {
    if (search) search.value = '';
    applyFilter();
    search && search.focus();
  });

  list.addEventListener('click', (e)=>{
    const defBtn = e.target.closest('.stage-default-btn');
    if (defBtn) {
      const form = defBtn.closest('form.city-form');
      if (!form) return;
      const key = defBtn.dataset.stage;
      if (!key) return;
      const ta = form.querySelector(`textarea[data-stage="${CSS.escape(key)}"]`);
      if (ta) {
        ta.value = ta.dataset.default || '';
        ta.focus();
      }
      e.preventDefault();
      return;
    }

    const cancelBtn = e.target.closest('.btn-cancel');
    if (cancelBtn) {
      const card = cancelBtn.closest('.city-card');
      if (card) {
        card.classList.remove('open');
        const details = card.querySelector('.city-card__details');
        if (details) details.hidden = true;
      }
      return;
    }

    const btn = e.target.closest('.btn-edit');
    if (!btn) return;
    const card = btn.closest('.city-card');
    if (!card) return;
    const details = card.querySelector('.city-card__details');
    if (!details) return;

    const isOpen = card.classList.contains('open');
    closeAll();

    if (isOpen) return;

    const form = details.querySelector('form.city-form');
    if (form) {
      const criteriaField = form.querySelector('[name="criteria"]');
      const expertsField = form.querySelector('[name="experts"]');
      const planWeekField = form.querySelector('[name="plan_week"]');
      const planMonthField = form.querySelector('[name="plan_month"]');
      if (criteriaField) criteriaField.value = card.dataset.criteria || '';
      if (expertsField) expertsField.value = card.dataset.experts || '';
      if (planWeekField) planWeekField.value = card.dataset.planWeek || '';
      if (planMonthField) planMonthField.value = card.dataset.planMonth || '';
      const ownerSelect = form.querySelector('[name="responsible_id"]');
      if (ownerSelect) ownerSelect.value = card.dataset.ownerId || '';
    }

    card.classList.add('open');
    details.hidden = false;
    const firstInput = details.querySelector('textarea, input, select');
    if (firstInput) firstInput.focus();
  });

  list.addEventListener('submit', async (e)=>{
    const form = e.target.closest('form.city-form');
    if (!form) return;
    e.preventDefault();

    const card = form.closest('.city-card');
    if (!card) return;

    const id = form.getAttribute('data-id');
    const criteria = form.criteria.value.trim();
    const experts = form.experts.value.trim();
    const plan_week = form.plan_week.value ? parseInt(form.plan_week.value, 10) : null;
    const plan_month = form.plan_month.value ? parseInt(form.plan_month.value, 10) : null;
    const ownerSelect = form.querySelector('[name="responsible_id"]');
    const ownerRaw = ownerSelect ? ownerSelect.value.trim() : '';
    const ownerId = ownerRaw && !Number.isNaN(Number(ownerRaw)) ? Number(ownerRaw) : null;
    const templates = {};

    form.querySelectorAll('textarea[data-stage]').forEach(ta => {
      const key = ta.dataset.stage;
      if (key) templates[key] = ta.value.trim();
    });

    const status = form.querySelector('.save-status');
    const badge = card.querySelector('.plan-badge');

    if (status) {
      status.style.display = 'inline-block';
      status.classList.remove('ok', 'err');
      status.textContent = 'Сохранение…';
    }

    try {
      const resp = await fetch(`/cities/${id}/settings`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          criteria,
          experts,
          plan_week,
          plan_month,
          templates,
          responsible_recruiter_id: ownerId,
        })
      });
      const json = await resp.json();

      if (!json || json.ok !== true) throw new Error(json && json.error || 'Ошибка сохранения');

      card.dataset.criteria = criteria;
      card.dataset.experts = experts;
      card.dataset.planWeek = plan_week ?? '';
      card.dataset.planMonth = plan_month ?? '';
      card.dataset.ownerId = ownerId ? String(ownerId) : '';

      if (badge) {
        if (plan_week || plan_month) {
          badge.textContent = `Нед: ${plan_week ?? '—'} · Мес: ${plan_month ?? '—'}`;
        } else {
          badge.textContent = 'Параметры не заданы';
        }
      }

      const ownerLabel = card.querySelector('.city-owner');
      if (ownerLabel) {
        if (ownerId) {
          const selector = `option[value="${ownerId}"]`;
          const option = ownerSelect ? ownerSelect.querySelector(selector) : null;
          ownerLabel.textContent = option ? option.textContent : 'Назначен';
          ownerLabel.classList.remove('muted');
        } else {
          ownerLabel.textContent = 'Не назначен';
          ownerLabel.classList.add('muted');
        }
      }

      if (status) {
        status.classList.add('ok');
        status.textContent = 'Сохранено';
      }

      card.classList.remove('open');
      const details = card.querySelector('.city-card__details');
      if (details) details.hidden = true;

      setTimeout(()=>{
        if (status) {
          status.classList.remove('ok');
          status.style.display = 'none';
        }
      }, 1200);
    } catch (err) {
      if (status) {
        status.classList.add('err');
        status.textContent = 'Ошибка';
      }
    }
  });

  applyFilter();
})();
</script>
{% endblock %}
