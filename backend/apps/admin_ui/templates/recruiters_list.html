{% extends "base.html" %}
{% block title %}–†–µ–∫—Ä—É—Ç—ë—Ä—ã{% endblock %}
{% block content %}
{% set city_filter_options = city_filter_options if city_filter_options is defined else [] %}
{% set selected_city_ids = selected_city_ids if selected_city_ids is defined else [] %}
<section class="page">
  <header class="page-header">
    <div>
      <h1 class="page-title">–†–µ–∫—Ä—É—Ç—ë—Ä—ã</h1>
      <p class="page-description">
        –°–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–∞–≥—Ä—É–∑–∫–æ–π, –±–ª–∏–∂–∞–π—à–∏–º–∏ —Å–ª–æ—Ç–∞–º–∏ –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –≥–æ—Ä–æ–¥–∞–º–∏ –∫–∞–∂–¥–æ–≥–æ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞.
      </p>
    </div>
    <div class="page-actions">
      <a class="liquid-glass-btn liquid-glass-btn--primary" href="/recruiters/new">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞</a>
    </div>
  </header>

{% if not recruiter_rows %}
    <div class="liquid-glass-card" data-animate-in style="text-align: center; padding: 48px 24px;">
      <h3 class="section-title">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</h3>
      <p class="page-description">–ó–∞–ø–∏—Å–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É.</p>
      <div class="page-actions" style="margin-top: 24px;">
        <a class="liquid-glass-btn liquid-glass-btn--primary" href="/recruiters/new">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞</a>
      </div>
    </div>
  {% else %}
    <div id="recs_grid" class="card-grid">
      {% for item in recruiter_rows %}
        {% set r = item.rec %}
        {% set stats = item.stats %}
        {% set active = r.active if r.active is not none else False %}
        {% set city_count = item.cities|length if item.cities else 0 %}
        {% set name_parts = r.name.split() if r.name else [] %}
        {% set initials = ((name_parts[0][0] if name_parts else 'R') ~ (name_parts[1][0] if name_parts|length > 1 else ''))[:2].upper() %}
        {% set total_slots = stats.total or 0 %}
        {% set load_percent = (stats.booked / total_slots * 100) if total_slots else 0 %}
        {% if item.next_free_local %}
          {% set next_slot_label = item.next_free_local ~ (" ¬∑ –∏—Å—Ç—ë–∫" if not item.next_is_future else "") %}
        {% else %}
          {% set next_slot_label = None %}
        {% endif %}
        <article class="liquid-glass-card liquid-glass-card--interactive recruiter-card" data-animate-in data-parallax>
          <header class="recruiter-card__header">
            <div class="recruiter-card__identity">
              <div class="recruiter-card__avatar" aria-hidden="true">{{ initials }}</div>
              <div>
                <h2 class="recruiter-card__name">{{ r.name }}</h2>
                <div class="recruiter-card__meta">
                  <span class="recruiter-card__badge">ID #{{ r.id }}</span>
                  <span class="recruiter-card__badge" title="–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å">{{ tz_display(r.tz) }}</span>
                  {% if r.tg_chat_id %}
                    <span class="recruiter-card__badge recruiter-card__badge--ghost">chat {{ r.tg_chat_id }}</span>
                  {% endif %}
                </div>
              </div>
            </div>
            <span class="recruiter-card__status" data-variant="{{ 'active' if active else 'inactive' }}">
              <span class="status-dot"></span>
              {{ '–ê–∫—Ç–∏–≤–µ–Ω' if active else '–û—Ç–∫–ª—é—á–µ–Ω' }}
            </span>
          </header>

          <div class="recruiter-card__body">
            <div class="recruiter-card__stats">
              <div class="recruiter-card__stat-pill" data-tone="primary">
                <span>–°–≤–æ–±–æ–¥–Ω–æ</span>
                <strong>{{ stats.free }}</strong>
              </div>
              <div class="recruiter-card__stat-pill" data-tone="amber">
                <span>–û–∂–∏–¥–∞—é—Ç</span>
                <strong>{{ stats.pending }}</strong>
              </div>
              <div class="recruiter-card__stat-pill" data-tone="rose">
                <span>–ó–∞–Ω—è—Ç–æ</span>
                <strong>{{ stats.booked }}</strong>
              </div>
              <div class="recruiter-card__stat-pill" data-tone="slate">
                <span>–í—Å–µ–≥–æ</span>
                <strong>{{ stats.total }}</strong>
              </div>
            </div>

            <div class="recruiter-card__highlights">
              <div class="recruiter-card__highlight" data-tone="accent">
                <div class="recruiter-card__highlight-icon">‚ö°</div>
                <div>
                  <p class="recruiter-card__highlight-label">–ó–∞–Ω—è—Ç–æ—Å—Ç—å</p>
                  <p class="recruiter-card__highlight-value">{{ load_percent|round(0, 'ceil') }}%</p>
                </div>
              </div>
              <div class="recruiter-card__highlight" data-tone="info">
                <div class="recruiter-card__highlight-icon">üóì</div>
                <div>
                  <p class="recruiter-card__highlight-label">–ë–ª–∏–∂–∞–π—à–∏–π —Å–ª–æ—Ç</p>
                  <p class="recruiter-card__highlight-value">{{ next_slot_label if next_slot_label else '–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö' }}</p>
                </div>
              </div>
              <div class="recruiter-card__highlight" data-tone="muted">
                <div class="recruiter-card__highlight-icon">üåç</div>
                <div>
                  {% if city_count %}
                    {% set city_word = '–≥–æ—Ä–æ–¥' if city_count % 10 == 1 and city_count % 100 != 11 else ('–≥–æ—Ä–æ–¥–∞' if city_count % 10 in [2, 3, 4] and city_count % 100 not in [12, 13, 14] else '–≥–æ—Ä–æ–¥–æ–≤') %}
                    <p class="recruiter-card__highlight-label">–ì–æ—Ä–æ–¥–∞</p>
                    <p class="recruiter-card__highlight-value">{{ city_count }} {{ city_word }}</p>
                  {% else %}
                    <p class="recruiter-card__highlight-label">–ì–æ—Ä–æ–¥–∞</p>
                    <p class="recruiter-card__highlight-value">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</p>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="recruiter-card__details">
              <div class="recruiter-card__load" aria-live="polite">
                <div class="recruiter-card__load-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ load_percent|round(0, 'floor') }}">
                  <span style="width: {{ load_percent }}%;"></span>
                </div>
                <p class="recruiter-card__load-hint">
                  {{ stats.booked }} –∑–∞–Ω—è—Ç–æ ¬∑ {{ stats.free }} —Å–≤–æ–±–æ–¥–Ω–æ ¬∑ {{ stats.pending }} –æ–∂–∏–¥–∞—é—Ç
                </p>
              </div>
              <div class="recruiter-card__cities">
                {% if item.cities %}
                  {% for city_entry in item.cities[:6] %}
                    {% set city_name = city_entry[0] %}
                    {% set city_tz = city_entry[1] %}
                    <span class="recruiter-card__city-pill" title="–¢–∞–π–º–∑–æ–Ω–∞: {{ city_tz }}">
                      {{ city_name }}
                    </span>
                  {% endfor %}
                  {% if city_count > 6 %}
                    <span class="recruiter-card__city-pill">+{{ city_count - 6 }}</span>
                  {% endif %}
                {% else %}
                  <span class="muted">–ì–æ—Ä–æ–¥–∞ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</span>
                {% endif %}
              </div>
            </div>
          </div>

          <footer class="recruiter-card__footer">
            <a class="liquid-glass-btn liquid-glass-btn--secondary btn--grow" href="/recruiters/{{ r.id }}/edit">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
              –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </a>
            <form class="inline-form" method="post" action="/recruiters/{{ r.id }}/delete" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞ {{ r.name }}?');">
              {{ csrf_input(request) }}
              <button class="liquid-glass-btn liquid-glass-btn--danger btn--grow" type="submit">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                –£–¥–∞–ª–∏—Ç—å
              </button>
            </form>
          </footer>
        </article>
      {% endfor %}
    </div>
  {% endif %}
</section>

{% if recruiter_rows %}
<script>
(function () {
  const BREAKPOINT = 600;
  const folds = Array.from(document.querySelectorAll('.recruiter-card [data-collapsible]'));
  if (!folds.length) return;

  let isWide = window.innerWidth >= BREAKPOINT;

  function applyState(forceOpen) {
    folds.forEach((fold) => {
      if (forceOpen) {
        fold.setAttribute('open', '');
      } else {
        fold.removeAttribute('open');
      }
    });
  }

  applyState(isWide);

  window.addEventListener('resize', () => {
    const next = window.innerWidth >= BREAKPOINT;
    if (next === isWide) return;
    isWide = next;
    applyState(isWide);
  });
})();

(function () {
  const filter = document.querySelector('[data-city-filter]');
  if (!filter) return;
  const search = filter.querySelector('[data-filter-search]');
  const options = Array.from(filter.querySelectorAll('[data-filter-option]'));
  const emptyHint = filter.querySelector('[data-filter-empty]');
  const selectedPanel = filter.querySelector('[data-filter-selected]');
  const counter = filter.querySelector('[data-filter-counter]');
  const checkboxes = options
    .map((option) => option.querySelector('input[type="checkbox"]'))
    .filter(Boolean);

  function renderSelected() {
    const checked = checkboxes.filter((cb) => cb.checked);
    if (counter) {
      counter.textContent = checked.length
        ? `${checked.length} ${checked.length === 1 ? '–≤—ã–±—Ä–∞–Ω' : '–≤—ã–±—Ä–∞–Ω–æ'}`
        : '–ì–æ—Ä–æ–¥–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã';
    }
    if (!selectedPanel) {
      return;
    }
    selectedPanel.innerHTML = '';
    if (!checked.length) {
      const empty = document.createElement('span');
      empty.className = 'muted';
      empty.textContent = '–ì–æ—Ä–æ–¥–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã';
      selectedPanel.appendChild(empty);
      return;
    }
    const maxVisible = 4;
    checked.slice(0, maxVisible).forEach((cb) => {
      const label = cb.closest('.choice-tile');
      const titleNode = label ? label.querySelector('.choice-tile__title') : null;
      const pill = document.createElement('span');
      pill.className = 'recruiter-city-picker__pill';
      pill.textContent = titleNode ? titleNode.textContent.trim() : `ID ${cb.value}`;
      selectedPanel.appendChild(pill);
    });
    if (checked.length > maxVisible) {
      const remainder = document.createElement('span');
      remainder.className = 'recruiter-city-picker__pill recruiter-city-picker__pill--ghost';
      remainder.textContent = `+${checked.length - maxVisible}`;
      selectedPanel.appendChild(remainder);
    }
  }

  checkboxes.forEach((cb) => {
    cb.addEventListener('change', renderSelected);
  });
  renderSelected();

  if (search && options.length) {
    search.addEventListener('input', () => {
      const term = search.value.trim().toLowerCase();
      let visible = 0;
      options.forEach((option) => {
        const haystack = option.getAttribute('data-filter') || '';
        const match = !term || haystack.indexOf(term) !== -1;
        option.hidden = !match;
        if (match) visible += 1;
      });
      if (emptyHint) {
        emptyHint.hidden = visible !== 0;
      }
    });
  } else if (emptyHint) {
    emptyHint.hidden = true;
  }
})();
</script>
{% endif %}
{% endblock %}
