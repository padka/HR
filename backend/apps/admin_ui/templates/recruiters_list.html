{% extends "base.html" %}
{% from "partials/components.html" import status_pill, meta_list, badge_row %}
{% block title %}Рекрутёры{% endblock %}
{% block content %}
<section class="page">
  <header class="page-header">
    <div>
      <h1 class="page-title">Рекрутёры</h1>
      <p class="page-description">
        Следите за нагрузкой, ближайшими слотами и ответственными городами каждого рекрутёра.
      </p>
    </div>
    <div class="page-actions">
      <a class="btn btn-primary" href="/recruiters/new">Добавить рекрутёра</a>
    </div>
  </header>

  {% if not recruiter_rows %}
    <div class="liquid-glass-card" data-animate-in style="text-align: center; padding: 48px 24px;">
      <h3 class="section-title">Пока пусто</h3>
      <p class="page-description">Записи отсутствуют. Создайте первого рекрутёра, чтобы начать работу.</p>
      <div class="page-actions" style="margin-top: 24px;">
        <a class="liquid-glass-btn liquid-glass-btn--primary" href="/recruiters/new">Добавить рекрутёра</a>
      </div>
    </div>
  {% else %}
    <div id="recs_grid" class="card-grid">
      {% for item in recruiter_rows %}
        {% set r = item.rec %}
        {% set stats = item.stats %}
        {% set active = r.active if r.active is not none else False %}
        {% set city_count = item.cities|length if item.cities else 0 %}
        {% if item.next_free_local %}
          {% set next_slot_label = item.next_free_local ~ (" · истёк" if not item.next_is_future else "") %}
        {% else %}
          {% set next_slot_label = None %}
        {% endif %}
        <article class="liquid-glass-card liquid-glass-card--interactive recruiter-card" data-animate-in data-parallax>
          <header class="recruiter-card__header">
            <div class="recruiter-card__identity">
              <h2 class="recruiter-card__name">{{ r.name }}</h2>
              {% call meta_list() %}
                <span>#{{ r.id }}</span>
              <span title="Часовой пояс">{{ tz_display(r.tz) }}</span>
                {% if r.tg_chat_id %}
                  <span title="ID чата в Telegram">chat_id {{ r.tg_chat_id }}</span>
                {% endif %}
              {% endcall %}
            </div>
            <span class="liquid-glass-badge liquid-glass-badge--{{ 'success' if active else 'neutral' }}">
              {{ 'Активен' if active else 'Отключен' }}
            </span>
          </header>

          <div class="recruiter-card__body">
            <section class="card-surface recruiter-card__section recruiter-card__section--metrics">
              <h3 class="section-title">Нагрузка</h3>
              <dl class="recruiter-metrics">
                <div>
                  <dt>Свободно</dt>
                  <dd>{{ stats.free }}</dd>
                </div>
                <div>
                  <dt>Ожидают</dt>
                  <dd>{{ stats.pending }}</dd>
                </div>
                <div>
                  <dt>Занято</dt>
                  <dd>{{ stats.booked }}</dd>
                </div>
                <div>
                  <dt>Всего</dt>
                  <dd>{{ stats.total }}</dd>
                </div>
              </dl>
            </section>

            <details class="recruiter-card__fold recruiter-card__section" data-collapsible open>
              <summary>
                <div class="recruiter-card__fold-head">
                  <h3 class="section-title">Города</h3>
                  {% if city_count %}
                    {% set city_word = 'город' if city_count % 10 == 1 and city_count % 100 != 11 else ('города' if city_count % 10 in [2, 3, 4] and city_count % 100 not in [12, 13, 14] else 'городов') %}
                    <span class="recruiter-card__fold-hint">{{ city_count }} {{ city_word }}</span>
                  {% else %}
                    <span class="recruiter-card__fold-hint">Нет городов</span>
                  {% endif %}
                </div>
              </summary>
              <div class="recruiter-card__fold-body">
                {% if item.cities %}
                  <p>{{ item.cities_display }}</p>
                {% else %}
                  <span class="muted">не назначены</span>
                {% endif %}
              </div>
            </details>

            <details class="recruiter-card__fold recruiter-card__section" data-collapsible open>
              <summary>
                <div class="recruiter-card__fold-head">
                  <h3 class="section-title">Ближайший свободный слот</h3>
                  <span class="recruiter-card__fold-hint">{{ next_slot_label if next_slot_label else 'Нет слотов' }}</span>
                </div>
              </summary>
              <div class="recruiter-card__fold-body">
                {% if next_slot_label %}
                  <span class="liquid-glass-badge liquid-glass-badge--info">{{ next_slot_label }}</span>
                {% else %}
                  <span class="muted">Нет свободных слотов</span>
                {% endif %}
              </div>
            </details>
          </div>

          <footer class="recruiter-card__footer">
            <a class="liquid-glass-btn liquid-glass-btn--soft btn--grow" href="/recruiters/{{ r.id }}/edit">Редактировать</a>
            <form class="inline-form" method="post" action="/recruiters/{{ r.id }}/delete" onsubmit="return confirm('Удалить рекрутёра {{ r.name }}?');">
              {{ csrf_input(request) }}
              <button class="liquid-glass-btn liquid-glass-btn--danger btn--grow" type="submit">Удалить</button>
            </form>
          </footer>
        </article>
      {% endfor %}
    </div>
  {% endif %}
</section>

{% if recruiter_rows %}
<script>
(function () {
  const BREAKPOINT = 600;
  const folds = Array.from(document.querySelectorAll('.recruiter-card [data-collapsible]'));
  if (!folds.length) return;

  let isWide = window.innerWidth >= BREAKPOINT;

  function applyState(forceOpen) {
    folds.forEach((fold) => {
      if (forceOpen) {
        fold.setAttribute('open', '');
      } else {
        fold.removeAttribute('open');
      }
    });
  }

  applyState(isWide);

  window.addEventListener('resize', () => {
    const next = window.innerWidth >= BREAKPOINT;
    if (next === isWide) return;
    isWide = next;
    applyState(isWide);
  });
})();
</script>
{% endif %}
{% endblock %}
