{% extends "base.html" %}
{% import "partials/form_shell.html" as forms %}
{% block title %}Новый город{% endblock %}
{% block content %}
{% call forms.shell(
  title="Новый город",
  description="Поддерживается кириллица, таймзона подставится автоматически (можно изменить вручную).",
  form_id="cityForm",
  action="/cities/create",
  autocomplete="off",
  back_href="/cities",
  back_label="К списку городов",
  actions=[
    {"type": "submit", "text": "Создать", "variant": "primary"},
    {"href": "/cities", "text": "Отмена", "variant": "ghost"}
  ]
) %}
  {% call forms.section("Параметры") %}
    {% call forms.field("Название", hint="Например: Новосибирск") %}
      <input id="name" type="text" name="name" placeholder="Новосибирск" required autofocus>
    {% endcall %}

    {% call forms.field("Часовой пояс (IANA)", hint="Например: Europe/Moscow, Asia/Novosibirsk") %}
      <input id="tz"
             type="text"
             name="tz"
             value="Europe/Moscow"
             placeholder="Asia/Novosibirsk"
             list="tz-list"
             inputmode="text"
             pattern="[A-Za-z_]+(?:\/[A-Za-z_\-]+)+"
             title="Например: Europe/Moscow, Europe/Samara, Asia/Novosibirsk"
             required>
      <datalist id="tz-list">
        <option value="Europe/Moscow"></option>
        <option value="Europe/Samara"></option>
        <option value="Europe/Kaliningrad"></option>
        <option value="Asia/Yekaterinburg"></option>
        <option value="Asia/Novosibirsk"></option>
        <option value="Asia/Krasnoyarsk"></option>
        <option value="Asia/Irkutsk"></option>
        <option value="Asia/Vladivostok"></option>
        <option value="Asia/Almaty"></option>
        <option value="Europe/Minsk"></option>
      </datalist>
      <div class="form-field__meta" aria-live="polite">
        <span id="tz_status" class="badge" title="Валидация TZ">Проверка TZ…</span>
        <span id="tz_now" class="hint"></span>
      </div>
      <div class="hint">
        Примеры: <code>Europe/Moscow</code>, <code>Europe/Samara</code>, <code>Asia/Novosibirsk</code>, <code>Asia/Almaty</code>
      </div>
    {% endcall %}
  {% endcall %}
{% endcall %}

<script type="module">
import { bindSubmitHotkey } from "/static/js/modules/form-hotkeys.js";

(function(){
  const form = document.getElementById('cityForm');
  const nameInput = document.getElementById('name');
  const tzInput = document.getElementById('tz');
  const tzStatus = document.getElementById('tz_status');
  const tzNow = document.getElementById('tz_now');

  bindSubmitHotkey(form, { key: 'enter' });

  const CITY_TZ_MAP = {
    'москва': 'Europe/Moscow',
    'санкт-петербург': 'Europe/Moscow',
    'питер': 'Europe/Moscow',
    'спб': 'Europe/Moscow',
    'калининград': 'Europe/Kaliningrad',
    'самара': 'Europe/Samara',
    'екатеринбург': 'Asia/Yekaterinburg',
    'новосибирск': 'Asia/Novosibirsk',
    'красноярск': 'Asia/Krasnoyarsk',
    'иркутск': 'Asia/Irkutsk',
    'владивосток': 'Asia/Vladivostok',
    'сочи': 'Europe/Moscow',
    'краснодар': 'Europe/Moscow',
    'ростов-на-дону': 'Europe/Moscow',
    'нижний новгород': 'Europe/Moscow',
    'минск': 'Europe/Minsk',
    'алматы': 'Asia/Almaty',
    'алма-ата': 'Asia/Almaty'
  };

  function normalizeCity(s){
    return (s || '')
      .toString()
      .trim()
      .toLowerCase()
      .replace(/\s+/g, ' ');
  }

  let tzTouched = false;
  tzInput?.addEventListener('input', ()=> { tzTouched = true; validateTZ(); });
  nameInput?.addEventListener('input', () => {
    const key = normalizeCity(nameInput.value);
    const guess = CITY_TZ_MAP[key];
    if (guess && !tzTouched) {
      tzInput.value = guess;
      validateTZ();
    }
  });

  function isValidTimeZone(tz){
    try {
      new Intl.DateTimeFormat('ru-RU', { timeZone: tz }).format();
      return true;
    } catch(e) { return false; }
  }

  function formatNow(tz){
    try {
      return new Intl.DateTimeFormat('ru-RU', {
        timeZone: tz,
        hour: '2-digit', minute: '2-digit',
        day: '2-digit', month: '2-digit', year: 'numeric'
      }).format(new Date());
    } catch { return ''; }
  }

  function validateTZ(){
    const tz = tzInput.value.trim();
    if (!tz){
      tzStatus.textContent = 'Укажите TZ';
      tzStatus.style.borderColor = 'var(--border)';
      tzNow.textContent = '';
      return;
    }
    if (isValidTimeZone(tz)){
      tzStatus.textContent = 'TZ OK';
      tzStatus.style.borderColor = 'var(--ok)';
      const now = formatNow(tz);
      tzNow.textContent = now ? ('Сейчас там: ' + now) : '';
    } else {
      tzStatus.textContent = 'Некорректная TZ';
      tzStatus.style.borderColor = 'var(--bad)';
      tzNow.textContent = '';
    }
  }

  validateTZ();

  form?.addEventListener('submit', (e) => {
    const name = (nameInput.value || '').trim();
    const tz = (tzInput.value || '').trim();
    if (!name){
      alert('Укажите название города');
      e.preventDefault(); return;
    }
    if (!isValidTimeZone(tz)){
      alert('Укажите корректную IANA TZ (например, Europe/Moscow, Asia/Novosibirsk)');
      e.preventDefault(); return;
    }
  });
})();
</script>
{% endblock %}
