{% extends "base.html" %}
{% block title %}–ù–æ–≤—ã–π –≥–æ—Ä–æ–¥{% endblock %}
{% block content %}

<div class="card glass grain" data-tilt style="margin: 8px 0 16px;">
  <h3 style="margin:0 0 12px 0; display:flex; align-items:center; gap:10px;">
    üèôÔ∏è –ù–æ–≤—ã–π –≥–æ—Ä–æ–¥
    <span class="badge" title="–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å">TZ</span>
  </h3>

  <form id="cityForm" method="post" action="/cities/create" autocomplete="off">
    <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
    <div class="field" style="margin-top:8px;">
      <label for="name" style="display:block; margin-bottom:6px;">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input id="name"
             type="text"
             name="name"
             placeholder="–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫"
             required
             autofocus
             style="width:100%;">
      <p class="muted" style="margin:6px 0 0;">
        –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∫–∏—Ä–∏–ª–ª–∏—Ü–∞. –î–ª—è –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ —Ç–∞–π–º–∑–æ–Ω–∞ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é).
      </p>
    </div>

    <!-- TZ -->
    <div class="field" style="margin-top:12px;">
      <label for="tz" style="display:block; margin-bottom:6px;">–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å (IANA TZ)</label>
      <input id="tz"
             type="text"
             name="tz"
             value="Europe/Moscow"
             placeholder="Asia/Novosibirsk"
             list="tz-list"
             inputmode="text"
             pattern="[A-Za-z_]+(?:\/[A-Za-z_\-]+)+"
             title="–ù–∞–ø—Ä–∏–º–µ—Ä: Europe/Moscow, Europe/Samara, Asia/Novosibirsk"
             required
             style="width:100%;">
      <datalist id="tz-list">
        <option value="Europe/Moscow"></option>
        <option value="Europe/Samara"></option>
        <option value="Europe/Kaliningrad"></option>
        <option value="Asia/Yekaterinburg"></option>
        <option value="Asia/Novosibirsk"></option>
        <option value="Asia/Krasnoyarsk"></option>
        <option value="Asia/Irkutsk"></option>
        <option value="Asia/Vladivostok"></option>
        <option value="Asia/Almaty"></option>
        <option value="Europe/Minsk"></option>
      </datalist>

      <!-- –°—Ç–∞—Ç—É—Å –≤–∞–ª–∏–¥–∞—Ü–∏–∏ + –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤—Ä–µ–º–µ–Ω–∏ -->
      <div style="display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap;">
        <span id="tz_status" class="badge" title="–í–∞–ª–∏–¥–∞—Ü–∏—è TZ">–ü—Ä–æ–≤–µ—Ä–∫–∞ TZ‚Ä¶</span>
        <span id="tz_now" class="muted"></span>
      </div>

      <p class="muted" style="margin:6px 0 0;">
        –ü—Ä–∏–º–µ—Ä—ã: <code>Europe/Moscow</code>, <code>Europe/Samara</code>, <code>Asia/Novosibirsk</code>, <code>Asia/Almaty</code>.
      </p>
    </div>

    <div style="display:flex; gap:8px; margin-top:16px;">
      <button type="submit">–°–æ–∑–¥–∞—Ç—å</button>
      <a class="btn" href="/cities">–û—Ç–º–µ–Ω–∞</a>
    </div>
  </form>
</div>

<script>
(function(){
  const form = document.getElementById('cityForm');
  const nameInput = document.getElementById('name');
  const tzInput = document.getElementById('tz');
  const tzStatus = document.getElementById('tz_status');
  const tzNow = document.getElementById('tz_now');

  // –ö–∞—Ä—Ç–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ ‚Üí IANA TZ
  const CITY_TZ_MAP = {
    '–º–æ—Å–∫–≤–∞': 'Europe/Moscow',
    '—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥': 'Europe/Moscow',
    '–ø–∏—Ç–µ—Ä': 'Europe/Moscow',
    '—Å–ø–±': 'Europe/Moscow',
    '–∫–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥': 'Europe/Kaliningrad',
    '—Å–∞–º–∞—Ä–∞': 'Europe/Samara',
    '–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥': 'Asia/Yekaterinburg',
    '–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫': 'Asia/Novosibirsk',
    '–∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫': 'Asia/Krasnoyarsk',
    '–∏—Ä–∫—É—Ç—Å–∫': 'Asia/Irkutsk',
    '–≤–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫': 'Asia/Vladivostok',
    '—Å–æ—á–∏': 'Europe/Moscow',
    '–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä': 'Europe/Moscow',
    '—Ä–æ—Å—Ç–æ–≤-–Ω–∞-–¥–æ–Ω—É': 'Europe/Moscow',
    '–Ω–∏–∂–Ω–∏–π –Ω–æ–≤–≥–æ—Ä–æ–¥': 'Europe/Moscow',
    '–º–∏–Ω—Å–∫': 'Europe/Minsk',
    '–∞–ª–º–∞—Ç—ã': 'Asia/Almaty',
    '–∞–ª–º–∞-–∞—Ç–∞': 'Asia/Almaty'
  };

  function normalizeCity(s){
    return (s || '')
      .toString()
      .trim()
      .toLowerCase()
      .replace(/\s+/g, ' ');
  }

  // –ê–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ TZ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –≥–æ—Ä–æ–¥–∞ (–µ—Å–ª–∏ TZ –Ω–µ –º–µ–Ω—è–ª–∏ –≤—Ä—É—á–Ω—É—é)
  let tzTouched = false;
  tzInput.addEventListener('input', ()=> { tzTouched = true; validateTZ(); });
  nameInput.addEventListener('input', () => {
    const key = normalizeCity(nameInput.value);
    const guess = CITY_TZ_MAP[key];
    if (guess && !tzTouched) {
      tzInput.value = guess;
      validateTZ();
    }
  });

  // –í–∞–ª–∏–¥–∞—Ü–∏—è TZ + –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤—Ä–µ–º–µ–Ω–∏ –≤ —ç—Ç–æ–π –∑–æ–Ω–µ
  function isValidTimeZone(tz){
    try {
      // –ë—Ä–æ—Å–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –µ—Å–ª–∏ TZ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è
      new Intl.DateTimeFormat('ru-RU', { timeZone: tz }).format();
      return true;
    } catch(e) { return false; }
  }

  function formatNow(tz){
    try {
      const nowStr = new Intl.DateTimeFormat('ru-RU', {
        timeZone: tz,
        hour: '2-digit', minute: '2-digit',
        day: '2-digit', month: '2-digit', year: 'numeric'
      }).format(new Date());
      return nowStr;
    } catch { return ''; }
  }

  function validateTZ(){
    const tz = tzInput.value.trim();
    if (!tz){
      tzStatus.textContent = '–£–∫–∞–∂–∏—Ç–µ TZ';
      tzStatus.style.borderColor = 'var(--border)';
      tzNow.textContent = '';
      return;
    }
    if (isValidTimeZone(tz)){
      tzStatus.textContent = 'TZ OK';
      tzStatus.style.borderColor = 'var(--ok)';
      const now = formatNow(tz);
      tzNow.textContent = now ? ('–°–µ–π—á–∞—Å —Ç–∞–º: ' + now) : '';
    } else {
      tzStatus.textContent = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è TZ';
      tzStatus.style.borderColor = 'var(--bad)';
      tzNow.textContent = '';
    }
  }

  // –ü–µ—Ä–≤–∏—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
  validateTZ();

  // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏: Ctrl/Cmd+Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞
  window.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'enter') {
      e.preventDefault();
      form?.requestSubmit();
    }
  });

  // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
  form.addEventListener('submit', (e) => {
    const name = (nameInput.value || '').trim();
    const tz = (tzInput.value || '').trim();
    if (!name){
      alert('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞');
      e.preventDefault(); return;
    }
    if (!isValidTimeZone(tz)){
      alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é IANA TZ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Europe/Moscow, Asia/Novosibirsk)');
      e.preventDefault(); return;
    }
  });
})();
</script>

{% endblock %}