{% extends "base.html" %}
{% import "partials/form_shell.html" as forms %}
{% block title %}Новый шаблон{% endblock %}
{% block content %}
{% set has_cities = (cities|length) > 0 %}
{% call forms.shell(
  title="Новый шаблон",
  description="Создайте сообщение для коммуникации с кандидатами.",
  form_id="tmplForm",
  action="/templates/create",
  autocomplete="off",
  actions=[
    {"type": "submit", "text": "Создать", "variant": "primary"},
    {"href": "/templates", "text": "Отмена", "variant": "ghost"}
  ]
) %}
  {% call forms.section("Назначение") %}
    <div class="form-field__meta">
      <label class="badge" for="is_global">
        <input id="is_global" name="is_global" type="checkbox" {% if not has_cities %}checked disabled{% endif %}>
        Глобальный (без города)
      </label>
      <span class="hint">Используется до выбора города кандидатом.</span>
    </div>
    {% if not has_cities %}
      <div class="alert mt-sm">Городов пока нет: можно создать только <strong>глобальные</strong> шаблоны. Добавьте города в разделе «Города».</div>
    {% endif %}
    {% call forms.field("Город") %}
      <div class="form-shell__grid form-shell__grid--two">
        <select id="city_id" name="city_id" {% if not has_cities %}disabled{% else %}required{% endif %}>
          <option value="" selected disabled>— выберите город —</option>
          {% for c in cities %}
            <option value="{{ c.id }}">{{ c.name }} ({{ c.tz or "Europe/Moscow" }})</option>
          {% endfor %}
        </select>
        <input id="city_filter" type="text" placeholder="Поиск по городам…" {% if not has_cities %}disabled{% endif %}>
      </div>
      <span class="form-field__hint" id="city_hint">Для глобального шаблона город не требуется — включите переключатель «Глобальный».</span>
    {% endcall %}
    <input id="key" type="hidden" name="key" value="">
  {% endcall %}

  {% call forms.section("Содержимое сообщения") %}
    {% call forms.field("Быстрый шаблон", hint="Выберите пресет — текст можно отредактировать") %}
      <select id="preset">
        <option value="">— не выбирать пресет —</option>
        <option value="invite_interview">Приглашение на интервью</option>
        <option value="confirm_2h">Подтверждение за 2 часа</option>
        <option value="reminder_1h">Напоминание за 1 час</option>
        <option value="after_meeting">После согласования руководителем</option>
        <option value="day_intro">Напоминание про ознакомительный день</option>
        <option value="slot_rejected">Слот отклонён (выбрать заново)</option>
        <option value="city_welcome">Приветствие по городу</option>
      </select>
    {% endcall %}

    {% call forms.field("Текст", hint="Поддерживаются плейсхолдеры: имя, город, дата/время, контакты.") %}
      <textarea id="text" name="text" rows="14" required placeholder="Текст сообщения. Поддерживаются переносы строк." class="mt-sm text-mono"></textarea>
      <div class="hint mt-sm">Доступные плейсхолдеры (клик вставит в текст):</div>
      <div class="btn-group">
        {% raw %}
        <button type="button" class="btn btn--ghost btn--sm" data-role="insert-var" data-insert="{{candidate_fio}}">{{candidate_fio}}</button>
        <button type="button" class="btn btn--ghost btn--sm" data-role="insert-var" data-insert="{{city_name}}">{{city_name}}</button>
        <button type="button" class="btn btn--ghost btn--sm" data-role="insert-var" data-insert="{{slot_date_local}}">{{slot_date_local}}</button>
        <button type="button" class="btn btn--ghost btn--sm" data-role="insert-var" data-insert="{{slot_time_local}}">{{slot_time_local}}</button>
        <button type="button" class="btn btn--ghost btn--sm" data-role="insert-var" data-insert="{{recruiter_name}}">{{recruiter_name}}</button>
        <button type="button" class="btn btn--ghost btn--sm" data-role="insert-var" data-insert="{{recruiter_phone}}">{{recruiter_phone}}</button>
        <button type="button" class="btn btn--ghost btn--sm" data-role="insert-var" data-insert="{{address}}">{{address}}</button>
        <button type="button" class="btn btn--ghost btn--sm" data-role="insert-var" data-insert="{{whatsapp_link}}">{{whatsapp_link}}</button>
        {% endraw %}
      </div>
      <div class="form-field__meta mt-sm">
        <span class="badge" data-overflow="false"><span id="char_count">0</span> / 4096</span>
        <span class="hint">Telegram ограничивает сообщения ≈ 4096 символами.</span>
      </div>
    {% endcall %}

    <details class="form-advanced mt-md">
      <summary class="hint">Предпросмотр</summary>
      <div class="form-shell__grid form-shell__grid--three mt-sm">
        <label class="form-field">
          <span class="form-field__label">Имя</span>
          <input id="pv_fio" type="text" value="Иван Иванов">
        </label>
        <label class="form-field">
          <span class="form-field__label">Город</span>
          <input id="pv_city" type="text" value="Москва">
        </label>
        <label class="form-field">
          <span class="form-field__label">Дата</span>
          <input id="pv_date" type="text" value="21.09">
        </label>
        <label class="form-field">
          <span class="form-field__label">Время</span>
          <input id="pv_time" type="text" value="10:30">
        </label>
        <label class="form-field">
          <span class="form-field__label">Рекрутёр</span>
          <input id="pv_rec" type="text" value="Михаил">
        </label>
        <label class="form-field">
          <span class="form-field__label">Телефон</span>
          <input id="pv_phone" type="text" value="+7 (900) 000-00-00">
        </label>
        <label class="form-field">
          <span class="form-field__label">Адрес</span>
          <input id="pv_addr" type="text" value="ул. Пушкина, 10">
        </label>
        <label class="form-field">
          <span class="form-field__label">WhatsApp</span>
          <input id="pv_wa" type="text" value="https://wa.me/79000000000">
        </label>
      </div>
      <div id="preview" class="preview-panel mt-sm" aria-live="polite"></div>
    </details>
  {% endcall %}
{% endcall %}

<script type="module">
import { initTemplateEditor } from "/static/js/modules/template-editor.js";
import { TEMPLATE_PRESETS } from "/static/js/modules/template-presets.js";

initTemplateEditor({
  formId: 'tmplForm',
  textareaId: 'text',
  counterId: 'char_count',
  previewId: 'preview',
  placeholderSelector: '[data-role="insert-var"]',
  presets: TEMPLATE_PRESETS,
  presetSelectId: 'preset',
  keyInputId: 'key',
  isGlobalCheckboxId: 'is_global',
  citySelectId: 'city_id',
  cityFilterId: 'city_filter',
  charLimit: 4096,
  showLimit: true
});
</script>
{% endblock %}
