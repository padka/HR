{% extends "base.html" %}
{% block title %}–ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω{% endblock %}
{% block content %}
<h3 style="margin:0 0 12px 0;">–ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω</h3>

<form id="tmplForm" method="post" action="/templates/create" autocomplete="off">
  <div class="glass tilt" style="padding:16px; max-width:860px; margin:0;">
    {% set has_cities = (cities|length) > 0 %}

    <!-- –¢–∏–ø —à–∞–±–ª–æ–Ω–∞ -->
    <div class="field" style="display:flex; gap:14px; align-items:center; flex-wrap:wrap;">
      <label style="margin-right:8px;">–¢–∏–ø:</label>
      <label class="badge" style="cursor:pointer; display:flex; align-items:center; gap:6px;">
        <input
          id="is_global"
          name="is_global"
          type="checkbox"
          {% if not has_cities %}checked disabled{% endif %}
        >
        –ì–ª–æ–±–∞–ª—å–Ω—ã–π (–±–µ–∑ –≥–æ—Ä–æ–¥–∞)
      </label>
      <span class="muted">‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è –æ–±—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –≥–æ—Ä–æ–¥–∞</span>
    </div>

    {% if not has_cities %}
      <div class="badge" style="margin:6px 0 0;">
        –ì–æ—Ä–æ–¥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç: –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ç–æ–ª—å–∫–æ <b>–≥–ª–æ–±–∞–ª—å–Ω—ã–µ</b> —à–∞–±–ª–æ–Ω—ã. –î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä–æ–¥–∞: ¬´–ì–æ—Ä–æ–¥–∞ ‚Üí +¬ª.
      </div>
    {% endif %}

    <!-- –ì–æ—Ä–æ–¥ (–¥–ª—è –≥–æ—Ä–æ–¥—Å–∫–∏—Ö —à–∞–±–ª–æ–Ω–æ–≤) -->
    <div class="field" style="margin-top:10px;">
      <label for="city_id">–ì–æ—Ä–æ–¥</label>
      <div style="display:flex; gap:8px; align-items:center;">
        <select id="city_id" name="city_id" {% if not has_cities %}disabled{% else %}required{% endif %}>
          <option value="" selected disabled>‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ ‚Äî</option>
          {% for c in cities %}
            <option value="{{ c.id }}">{{ c.name }} ({{ c.tz or "Europe/Moscow" }})</option>
          {% endfor %}
        </select>
        <input id="city_filter" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –≥–æ—Ä–æ–¥–∞–º‚Ä¶" style="min-width:200px;" {% if not has_cities %}disabled{% endif %}>
      </div>
      <p class="muted" id="city_hint" style="margin:6px 0 0;">
        –î–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞ –≥–æ—Ä–æ–¥ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è ‚Äî –≤–∫–ª—é—á–∏—Ç–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å ¬´–ì–ª–æ–±–∞–ª—å–Ω—ã–π¬ª.
      </p>
    </div>

    <input id="key" type="hidden" name="key" value="">

    <!-- –ü—Ä–µ—Å–µ—Ç—ã —Ç–µ–∫—Å—Ç–∞ -->
    <div class="field" style="margin-top:12px;">
      <label for="preset">–ë—ã—Å—Ç—Ä—ã–π —à–∞–±–ª–æ–Ω</label>
      <select id="preset">
        <option value="">‚Äî –Ω–µ –≤—ã–±–∏—Ä–∞—Ç—å –ø—Ä–µ—Å–µ—Ç ‚Äî</option>
        <option value="invite_interview">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –Ω–∞ –∏–Ω—Ç–µ—Ä–≤—å—é</option>
        <option value="confirm_2h">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞ 2 —á–∞—Å–∞</option>
        <option value="reminder_1h">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 1 —á–∞—Å</option>
        <option value="after_meeting">–ü–æ—Å–ª–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–º</option>
        <option value="day_intro">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø—Ä–æ –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω—å</option>
        <option value="slot_rejected">–°–ª–æ—Ç –æ—Ç–∫–ª–æ–Ω—ë–Ω (–≤—ã–±—Ä–∞—Ç—å –∑–∞–Ω–æ–≤–æ)</option>
        <option value="city_welcome">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ –≥–æ—Ä–æ–¥—É</option>
      </select>
      <p class="muted" style="margin:6px 0 0;">–ü—Ä–µ—Å–µ—Ç –∑–∞–ø–æ–ª–Ω–∏—Ç ¬´–¢–µ–∫—Å—Ç¬ª. –¢–µ–∫—Å—Ç –º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å.</p>
    </div>

    <!-- –¢–µ–∫—Å—Ç -->
    <div class="field" style="margin-top:12px;">
      <label for="text">–¢–µ–∫—Å—Ç</label>
      <textarea id="text" name="text" rows="14" required placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫." style="width:100%; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;"></textarea>

      <!-- –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã -->
      <div class="muted" style="margin:8px 0 6px;">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã (–∫–ª–∏–∫ –≤—Å—Ç–∞–≤–∏—Ç –≤ –∫—É—Ä—Å–æ—Ä):</div>
      <div style="display:flex; gap:6px; flex-wrap:wrap;">
        {% raw %}
        <button type="button" class="btn" data-insert="{{candidate_fio}}" data-role="insert-var">{{candidate_fio}}</button>
        <button type="button" class="btn" data-insert="{{city_name}}" data-role="insert-var">{{city_name}}</button>
        <button type="button" class="btn" data-insert="{{slot_date_local}}" data-role="insert-var">{{slot_date_local}}</button>
        <button type="button" class="btn" data-insert="{{slot_time_local}}" data-role="insert-var">{{slot_time_local}}</button>
        <button type="button" class="btn" data-insert="{{recruiter_name}}" data-role="insert-var">{{recruiter_name}}</button>
        <button type="button" class="btn" data-insert="{{recruiter_phone}}" data-role="insert-var">{{recruiter_phone}}</button>
        <button type="button" class="btn" data-insert="{{address}}" data-role="insert-var">{{address}}</button>
        <button type="button" class="btn" data-insert="{{whatsapp_link}}" data-role="insert-var">{{whatsapp_link}}</button>
        {% endraw %}
      </div>

      <!-- –°—á—ë—Ç—á–∏–∫ / –ª–∏–º–∏—Ç -->
      <div style="display:flex; align-items:center; gap:10px; margin-top:8px;">
        <span class="badge"><span id="char_count">0</span> / 4096</span>
        <span class="muted">Telegram –ª–∏–º–∏—Ç ‚âà 4096 —Å–∏–º–≤–æ–ª–æ–≤. ‚åò/Ctrl+S ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å.</span>
      </div>
    </div>

    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä + –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π -->
    <details style="margin-top:10px;">
      <summary class="badge" style="cursor:pointer;">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</summary>
      <div class="glass" style="padding:12px; margin-top:8px;">
        <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:8px; margin-bottom:8px;">
          <div><label class="muted">–ò–º—è</label><input id="pv_fio" type="text" value="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"></div>
          <div><label class="muted">–ì–æ—Ä–æ–¥</label><input id="pv_city" type="text" value="–ú–æ—Å–∫–≤–∞"></div>
          <div><label class="muted">–î–∞—Ç–∞</label><input id="pv_date" type="text" value="21.09"></div>
          <div><label class="muted">–í—Ä–µ–º—è</label><input id="pv_time" type="text" value="10:30"></div>
          <div><label class="muted">–†–µ–∫—Ä—É—Ç—ë—Ä</label><input id="pv_rec" type="text" value="–ú–∏—Ö–∞–∏–ª"></div>
          <div><label class="muted">–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="pv_phone" type="text" value="+7 (900) 000-00-00"></div>
          <div><label class="muted">–ê–¥—Ä–µ—Å</label><input id="pv_addr" type="text" value="—É–ª. –ü—É—à–∫–∏–Ω–∞, 10"></div>
          <div><label class="muted">WhatsApp</label><input id="pv_wa" type="text" value="https://wa.me/79000000000"></div>
        </div>
        <div id="preview" style="white-space:pre-wrap; overflow-wrap:anywhere;"></div>
      </div>
    </details>

    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
    <div style="display:flex; gap:10px; margin-top:14px;">
      <button type="submit">–°–æ–∑–¥–∞—Ç—å</button>
      <a class="btn" href="/templates">–û—Ç–º–µ–Ω–∞</a>
    </div>
  </div>
</form>

<script>
(function(){
  const form   = document.getElementById('tmplForm');
  const isGlob = document.getElementById('is_global');
  const citySel= document.getElementById('city_id');
  const cityFilter = document.getElementById('city_filter');
  const keyInp = document.getElementById('key');
  const textTa = document.getElementById('text');
  const count  = document.getElementById('char_count');
  const preview= document.getElementById('preview');
  const presetSel = document.getElementById('preset');

  function randomKey(){
    const stamp = Date.now().toString(36);
    const random = Math.random().toString(36).replace(/[^a-z0-9]/g, '').slice(0, 6);
    return `tmpl_${stamp}_${random}`;
  }

  function ensureKey(force = false){
    if (!keyInp) return;
    if (force || !(keyInp.value || '').trim()){
      keyInp.value = randomKey();
    }
  }
  ensureKey(true);

  // ---- –°–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ vs –≥–ª–æ–±–∞–ª—å–Ω—ã–π ----
  function applyGlobalState() {
    const g = isGlob && isGlob.checked;
    if (citySel){
      citySel.disabled = g || !citySel.options.length;
      if (g) citySel.removeAttribute('required'); else citySel.setAttribute('required','');
      if (g) citySel.value = '';
    }
    if (cityFilter){
      cityFilter.disabled = g || !citySel || !citySel.options.length;
    }
  }
  isGlob && isGlob.addEventListener('change', applyGlobalState);
  applyGlobalState();

  // ---- –§–∏–ª—å—Ç—Ä –ø–æ –≥–æ—Ä–æ–¥–∞–º ----
  if (cityFilter && citySel){
    const original = Array.from(citySel.options);
    cityFilter.addEventListener('input', () => {
      const q = (cityFilter.value || '').toLowerCase().trim();
      citySel.innerHTML = '';
      const filtered = original.filter(o => !q || o.text.toLowerCase().includes(q));
      filtered.forEach(o => citySel.appendChild(o));
      if (!citySel.value && filtered.length) citySel.value = filtered[0].value;
    });
  }

  // ---- –í—Å—Ç–∞–≤–∫–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤ ----
  function insertAtCursor(el, text){
    el.focus();
    const s = el.selectionStart ?? el.value.length;
    const e = el.selectionEnd ?? el.value.length;
    el.value = el.value.slice(0,s) + text + el.value.slice(e);
    el.selectionStart = el.selectionEnd = s + text.length;
    updatePreview();
  }
  document.querySelectorAll('[data-role="insert-var"]').forEach(btn=>{
    btn.addEventListener('click', ()=> insertAtCursor(textTa, btn.getAttribute('data-insert') || ''));
  });

  // ---- –ü—Ä–µ—Å–µ—Ç—ã —Ç–µ–∫—Å—Ç–∞ ----
  const PRESETS = {
    invite_interview:
`{{candidate_fio}} üëã

–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º ‚Äî –≤—ã —à–∞–≥ –±–ª–∏–∂–µ –∫ –∫–æ–º–∞–Ω–¥–µ <b>SMART SERVICE</b>!

üóì <b>{{slot_date_local}}, {{slot_time_local}}</b> (–≤–∞—à–µ –≤—Ä–µ–º—è)

üí¨ <b>–§–æ—Ä–º–∞—Ç:</b> –≤–∏–¥–µ–æ—á–∞—Ç WhatsApp | 15‚Äì20 –º–∏–Ω

‚ö° –ß—Ç–æ –Ω—É–∂–Ω–æ –∑–∞—Ä–∞–Ω–µ–µ:
‚Ä¢ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
‚Ä¢ —Ä–∞–±–æ—á–∏–π WhatsApp
‚Ä¢ 2‚Äì3 –≤–æ–ø—Ä–æ—Å–∞ –æ –≤–∞–∫–∞–Ω—Å–∏–∏

üîî –ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω.

‚úâÔ∏è <b>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É—á–∞—Å—Ç–∏–µ</b> –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º ¬´–î–∞¬ª –∏–ª–∏ —ç–º–æ–¥–∑–∏ üëç ‚Äî –±—Ä–æ–Ω–∏—Ä—É—é —Å–ª–æ—Ç.`,
    confirm_2h:
`–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, {{candidate_fio}}! üòä

‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞—é: —Å–µ–≥–æ–¥–Ω—è –≤ {{slot_time_local}} (–≤–∞—à–µ –≤—Ä–µ–º—è) ‚Äî –≤–∏–¥–µ–æ—Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–º–ø–∞–Ω–∏–∏ SMART‚ö°

üìå –ü–ª–∞–Ω: –∫—Ä–∞—Ç–∫–æ –æ –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –≤–∞–∫–∞–Ω—Å–∏–∏ ‚Üí –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã ‚Üí –æ–∂–∏–¥–∞–Ω–∏—è –∏ —Ä–æ—Å—Ç.
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç + –∫–∞–º–µ—Ä—É.

üëâ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É—á–∞—Å—Ç–∏–µ –æ–¥–Ω–∏–º ¬´–î–∞¬ª –∏–ª–∏ üëç ‚Äî –∂–¥—ë–º –Ω–∞ —Å–≤—è–∑–∏!`,
    reminder_1h:
`‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: –≤—Å—Ç—Ä–µ—á–∞ —á–µ—Ä–µ–∑ 1 —á–∞—Å ‚Äî {{slot_time_local}} (–≤–∞—à–µ –≤—Ä–µ–º—è).
–ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è ‚Äî –¥–∞–π—Ç–µ –∑–Ω–∞—Ç—å –∏ –ø–æ–¥–±–µ—Ä—ë–º –¥—Ä—É–≥–æ–π —Å–ª–æ—Ç.`,
    after_meeting:
`–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–ª–∏ –≤–∏–¥–µ–æ–∏–Ω—Ç–µ—Ä–≤—å—é –≤ –∫–æ–º–ø–∞–Ω–∏–∏ <b>SMART</b>! üéâ

–ó–∞–≤—Ç—Ä–∞ –≤ <b>{{slot_time_local}}</b> —É –≤–∞—Å –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –≤—Å—Ç—Ä–µ—á–∞ —Å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–º –ø–æ –∞–¥—Ä–µ—Å—É: <b>{{address}}</b>.

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏—Ö–æ–¥–∏—Ç–µ –≤ –ø—Ä–µ–∑–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ–º –≤–∏–¥–µ –∏ —Å –æ—Ç–ª–∏—á–Ω—ã–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º! üòä
–≠—Ç–æ –Ω–µ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ, –∞ <b>–æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω—å</b> (~2 —á–∞—Å–∞).

üíº –ö–æ–Ω—Ç–∞–∫—Ç —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è: {{recruiter_name}}, {{recruiter_phone}}

üëâ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ ¬´–ï–¥—É¬ª –∏–ª–∏ üëç. –í–æ–ø—Ä–æ—Å—ã ‚Äî —Å—é–¥–∞.`,
    day_intro:
`–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! ‚òÄÔ∏è

–ù–∞–ø–æ–º–∏–Ω–∞—é, —á—Ç–æ —Å–µ–≥–æ–¥–Ω—è –≤ <b>{{slot_time_local}}</b> —É –≤–∞—Å –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω <b>–æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω—å –≤ –∫–æ–º–ø–∞–Ω–∏–∏ SMART</b>.

üåü –ß—Ç–æ –≤–∞—Å –∂–¥—ë—Ç:
‚Ä¢ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–≤–∏–¥–µ—Ç—å —Ä–∞–±–æ—Ç—É –∏–∑–Ω—É—Ç—Ä–∏
‚Ä¢ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –∫–æ–º–∞–Ω–¥–æ–π
‚Ä¢ –ø–æ–≥—Ä—É–∂–µ–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏

üíº –û–¥–µ–∂–¥–∞: –¥–µ–ª–æ–≤–æ–π —Å—Ç–∏–ª—å.
üëâ –£—Å–ø–µ–≤–∞–µ—Ç–µ?`,
    slot_rejected:
`–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–ª–æ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –î–∞–≤–∞–π—Ç–µ –ø–æ–¥–±–µ—Ä—ë–º –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è.
–ù–∞–ø–∏—à–∏—Ç–µ —É–¥–æ–±–Ω—ã–π –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π —Å–ª–æ—Ç –≤ —Å–∏—Å—Ç–µ–º–µ.`,
    city_welcome:
`{{candidate_fio}}, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ–º –≤ {{city_name}}!
–°–∫–æ—Ä–æ –ø—Ä–∏—à–ª—ë–º –¥–µ—Ç–∞–ª–∏ –ø–æ –∞–¥—Ä–µ—Å—É –∏ –≤—Ä–µ–º–µ–Ω–∏.`
  };

  if (presetSel){
    presetSel.addEventListener('change', () => {
      const v = presetSel.value;
      if (!v) return;
      textTa.value = PRESETS[v] || '';
      updatePreview();
    });
  }

  // ---- –°—á—ë—Ç—á–∏–∫ –∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (—Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏) ----
  const SAMPLE = () => ({
    '{{candidate_fio}}': document.getElementById('pv_fio')?.value || '–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω',
    '{{city_name}}':     document.getElementById('pv_city')?.value || '–ú–æ—Å–∫–≤–∞',
    '{{slot_date_local}}': document.getElementById('pv_date')?.value || '12.10',
    '{{slot_time_local}}': document.getElementById('pv_time')?.value || '10:30',
    '{{recruiter_name}}':  document.getElementById('pv_rec')?.value || '–ú–∏—Ö–∞–∏–ª',
    '{{recruiter_phone}}': document.getElementById('pv_phone')?.value || '+7 (900) 000-00-00',
    '{{address}}':         document.getElementById('pv_addr')?.value || '—É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, 1',
    '{{whatsapp_link}}':   document.getElementById('pv_wa')?.value || 'https://wa.me/79990000000'
  });
  function renderPreview(){
    if (!preview) return;
    let s = textTa.value || '';
    const map = SAMPLE();
    Object.keys(map).forEach(k => { s = s.split(k).join(map[k]); });
    // –±–µ–∑–æ–ø–∞—Å–Ω–æ: –±–µ–∑ HTML-–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏
    preview.textContent = s;
  }
  function updateCount(){
    const len = (textTa.value || '').length;
    count.textContent = String(len);
    if (len > 4096){
      // –º—è–≥–∫–æ –ø–æ–¥—Å–≤–µ—Ç–∏–º –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ
      count.parentElement.style.border = '1px solid var(--bad)';
    } else {
      count.parentElement.style.border = '1px solid transparent';
    }
  }
  function updatePreview(){
    updateCount();
    renderPreview();
  }

  textTa.addEventListener('input', updatePreview);
  ['pv_fio','pv_city','pv_date','pv_time','pv_rec','pv_phone','pv_addr','pv_wa']
    .forEach(id => document.getElementById(id)?.addEventListener('input', renderPreview));
  updatePreview();

  // ---- Ctrl/Cmd+S -> submit ----
  window.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 's') {
      e.preventDefault();
      form?.requestSubmit();
    }
  });

  // ---- –ú–∏–Ω–∏-–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π ----
  form.addEventListener('submit', (e) => {
    const g = isGlob && isGlob.checked;
    ensureKey();
    if (!textTa.value.trim()){
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–∫—Å—Ç —à–∞–±–ª–æ–Ω–∞');
      e.preventDefault(); return;
    }
    if (!g){
      if (!citySel || !citySel.value){
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏–ª–∏ –≤–∫–ª—é—á–∏—Ç–µ ¬´–ì–ª–æ–±–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω¬ª.');
        e.preventDefault(); return;
      }
    }
    if ((textTa.value || '').length > 4096){
      if (!confirm('–¢–µ–∫—Å—Ç –¥–ª–∏–Ω–Ω–µ–µ 4096 —Å–∏–º–≤–æ–ª–æ–≤ –∏ –º–æ–∂–µ—Ç –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è –≤ Telegram. –í—Å—ë —Ä–∞–≤–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å?')) {
        e.preventDefault(); return;
      }
    }
  });
})();
</script>
{% endblock %}