{% extends "base.html" %}
{% import "partials/form_shell.html" as forms with context %}
{% block title %}Новый шаблон{% endblock %}
{% block content %}
{% set has_cities = (cities|length) > 0 %}
{% set form_data = form_data or {} %}
{% call forms.shell(
  title="Новый шаблон",
  description="Создайте сообщение для коммуникации с кандидатами.",
  form_id="tmplForm",
  action="/templates/create",
  autocomplete="off",
  actions=[
    {"type": "submit", "text": "Создать", "variant": "primary"},
    {"href": "/templates", "text": "Отмена", "variant": "ghost"}
  ]
) %}
  {% if errors %}
    <div class="alert alert--danger mt-sm">
      <ul>
        {% for err in errors %}
          <li>{{ err }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
  {% call forms.section("Назначение") %}
    {% call forms.meta() %}
      {{ forms.switch(
        id='is_global',
        name='is_global',
        checked=form_data.is_global or (not has_cities),
        disabled=not has_cities,
        label='Глобальный (без города)'
      ) }}
      {% call forms.note(inline=True) %}Используется до выбора города кандидатом.{% endcall %}
    {% endcall %}
    {% if not has_cities %}
      <div class="alert mt-sm">Городов пока нет: можно создать только <strong>глобальные</strong> шаблоны. Добавьте города в разделе «Города».</div>
    {% endif %}
    {% call forms.field("Город") %}
      <div class="form-grid form-grid--two">
        <select id="city_id" name="city_id" {% if not has_cities %}disabled{% else %}required{% endif %}>
          <option value="" {% if not form_data.city_id %}selected{% endif %} disabled>— выберите город —</option>
          {% for c in cities %}
            <option value="{{ c.id }}" {% if form_data.city_id == c.id %}selected{% endif %}>{{ c.display_name }} ({{ c.tz or "Europe/Moscow" }})</option>
          {% endfor %}
        </select>
        <input id="city_filter" type="text" placeholder="Поиск по городам…" {% if not has_cities %}disabled{% endif %}>
      </div>
      {% call forms.note(id='city_hint') %}Для глобального шаблона город не требуется — включите переключатель «Глобальный».{% endcall %}
    {% endcall %}
  {% endcall %}

  {% call forms.section("Содержимое сообщения", span='full') %}
    {% call forms.field("Быстрый шаблон", hint="Выберите пресет — текст можно отредактировать") %}
      <select id="preset">
        <option value="">— не выбирать пресет —</option>
        <option value="invite_interview">Приглашение на интервью</option>
        <option value="confirm_2h">Подтверждение за 2 часа</option>
        <option value="after_meeting">После согласования руководителем</option>
        <option value="day_intro">Напоминание про ознакомительный день</option>
        <option value="slot_rejected">Слот отклонён (выбрать заново)</option>
        <option value="city_welcome">Приветствие по городу</option>
      </select>
    {% endcall %}

    {% call forms.field("Текст", hint="Поддерживаются плейсхолдеры: имя, город, дата/время, контакты.", required=True) %}
      <textarea id="text" name="text" rows="14" required aria-required="true" placeholder="Текст сообщения. Поддерживаются переносы строк." class="text-mono">{{ form_data.text or '' }}</textarea>
      {% call forms.note() %}Доступные плейсхолдеры (клик вставит в текст):{% endcall %}
      <div class="btn-group">
        {% raw %}
        <button type="button" class="btn btn--ghost btn--sm" data-role="insert-var" data-insert="{{candidate_fio}}">{{candidate_fio}}</button>
        <button type="button" class="btn btn--ghost btn--sm" data-role="insert-var" data-insert="{{city_name}}">{{city_name}}</button>
        <button type="button" class="btn btn--ghost btn--sm" data-role="insert-var" data-insert="{{slot_date_local}}">{{slot_date_local}}</button>
        <button type="button" class="btn btn--ghost btn--sm" data-role="insert-var" data-insert="{{slot_time_local}}">{{slot_time_local}}</button>
        <button type="button" class="btn btn--ghost btn--sm" data-role="insert-var" data-insert="{{recruiter_name}}">{{recruiter_name}}</button>
        <button type="button" class="btn btn--ghost btn--sm" data-role="insert-var" data-insert="{{recruiter_phone}}">{{recruiter_phone}}</button>
        <button type="button" class="btn btn--ghost btn--sm" data-role="insert-var" data-insert="{{address}}">{{address}}</button>
        <button type="button" class="btn btn--ghost btn--sm" data-role="insert-var" data-insert="{{intro_address}}">{{intro_address}}</button>
        <button type="button" class="btn btn--ghost btn--sm" data-role="insert-var" data-insert="{{intro_contact}}">{{intro_contact}}</button>
        <button type="button" class="btn btn--ghost btn--sm" data-role="insert-var" data-insert="{{whatsapp_link}}">{{whatsapp_link}}</button>
        {% endraw %}
      </div>
      {% call forms.meta() %}
        <span class="badge" data-overflow="false"><span id="char_count">0</span> / 4096</span>
        {% call forms.note(inline=True) %}Telegram ограничивает сообщения ≈ 4096 символами.{% endcall %}
      {% endcall %}
    {% endcall %}

    <details class="form-advanced mt-md">
      <summary class="hint">Предпросмотр</summary>
      <div class="form-grid form-grid--three mt-sm">
        {% call forms.field("Имя") %}
          <input id="pv_fio" type="text" value="Иван Иванов">
        {% endcall %}
        {% call forms.field("Город") %}
          <input id="pv_city" type="text" value="Москва">
        {% endcall %}
        {% call forms.field("Дата") %}
          <input id="pv_date" type="text" value="21.09">
        {% endcall %}
        {% call forms.field("Время") %}
          <input id="pv_time" type="text" value="10:30">
        {% endcall %}
        {% call forms.field("Рекрутёр") %}
          <input id="pv_rec" type="text" value="Михаил">
        {% endcall %}
        {% call forms.field("Телефон") %}
          <input id="pv_phone" type="text" value="+7 (900) 000-00-00">
        {% endcall %}
        {% call forms.field("Адрес") %}
          <input id="pv_addr" type="text" value="ул. Пушкина, 10">
        {% endcall %}
        {% call forms.field("WhatsApp") %}
          <input id="pv_wa" type="text" value="https://wa.me/79000000000">
        {% endcall %}
      </div>
      <div id="preview" class="preview-panel mt-sm" aria-live="polite"></div>
    </details>
  {% endcall %}
{% endcall %}

<script type="module" nonce="{{ request.state.csp_nonce }}">
import { initTemplateEditor } from "/static/js/modules/template-editor.js";
import { TEMPLATE_PRESETS } from "/static/js/modules/template-presets.js";

initTemplateEditor({
  formId: 'tmplForm',
  textareaId: 'text',
  counterId: 'char_count',
  previewId: 'preview',
  placeholderSelector: '[data-role="insert-var"]',
  presets: TEMPLATE_PRESETS,
  presetSelectId: 'preset',
  isGlobalCheckboxId: 'is_global',
  citySelectId: 'city_id',
  cityFilterId: 'city_filter',
  charLimit: 4096,
  showLimit: true
});
</script>
{% endblock %}
