{%- macro breadcrumbs(trail=None) -%}
  {% if trail %}
    <nav class="breadcrumbs" aria-label="Хлебные крошки">
      <ol class="breadcrumbs__list">
        {% for item in trail %}
          <li class="breadcrumbs__item">
            {% if item.url and not loop.last %}
              <a href="{{ item.url }}" class="breadcrumbs__link">{{ item.label }}</a>
            {% else %}
              <span class="breadcrumbs__current" aria-current="page">{{ item.label }}</span>
            {% endif %}
          </li>
        {% endfor %}
      </ol>
    </nav>
  {% endif %}
{%- endmacro %}

{%- macro page_header(title, eyebrow=None, description=None, meta=None, badges=None, trail=None) -%}
  <header class="page-header">
    {{ breadcrumbs(trail) }}
    <div class="page-header__text">
      {% if eyebrow %}<p class="page-header__eyebrow muted">{{ eyebrow }}</p>{% endif %}
      <h1 class="page-header__title">{{ title }}</h1>
      {% if description %}<p class="page-header__description muted">{{ description }}</p>{% endif %}
      {% if meta %}<p class="page-header__meta muted">{{ meta }}</p>{% endif %}
      {% if badges %}
        <ul class="page-header__badges" role="list">
          {% for item in badges %}
            <li>
              <span class="badge badge-{{ item.tone | default('muted') }}">
                {% if item.icon %}<span class="badge__icon" aria-hidden="true">{{ item.icon }}</span>{% endif %}
                <span class="badge__label">{{ item.label }}</span>
              </span>
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>
    {% if caller is defined %}
      <div class="page-header__actions">
        {{ caller() }}
      </div>
    {% endif %}
  </header>
{%- endmacro %}

{%- macro tabs(items=None, active=None) -%}
  {% if items %}
    <div class="tabs" role="tablist">
      {% for tab in items %}
        {% set is_active = (tab.key == active) %}
        {% set href = tab.url or '#' %}
        <a
          class="tabs__link{% if is_active %} is-active{% endif %}"
          href="{{ href }}"
          role="tab"
          aria-selected="{{ 'true' if is_active else 'false' }}"
          {% if tab.id %}id="{{ tab.id }}"{% endif %}
        >
          {% if tab.icon %}<span class="tabs__icon" aria-hidden="true">{{ tab.icon }}</span>{% endif %}
          <span class="tabs__label">{{ tab.label }}</span>
          {% if tab.badge %}<span class="tabs__badge">{{ tab.badge }}</span>{% endif %}
        </a>
      {% endfor %}
    </div>
  {% endif %}
{%- endmacro %}

{%- macro kpi_grid(section_id, eyebrow=None, title=None, meta=None, cards=None, empty_text=None, placeholder_text=None, is_placeholder=False, default_hint=None) -%}
  <section class="kpi-section panel" aria-labelledby="{{ section_id }}">
    <header class="kpi-section__header">
      <div class="kpi-section__heading">
        {% if eyebrow %}<p class="kpi-section__eyebrow">{{ eyebrow }}</p>{% endif %}
        {% if title %}<h2 id="{{ section_id }}" class="kpi-section__title">{{ title }}</h2>{% endif %}
        {% if meta %}<p class="kpi-section__meta muted">{{ meta }}</p>{% endif %}
      </div>
      {% if caller is defined %}
        <div class="kpi-section__actions">
          {{ caller() }}
        </div>
      {% endif %}
    </header>
    <div class="kpi-section__grid">
      {% if is_placeholder and placeholder_text %}
        <p class="kpi-section__placeholder muted">{{ placeholder_text }}</p>
      {% elif cards %}
        {% for card in cards %}
          {% set trend = card.trend %}
          <button
            type="button"
            class="kpi-card surface focus-ring tone-{{ card.tone | default('info') }}"
            {% if card.key %}data-metric="{{ card.key }}"{% endif %}
            {% if card.dialog_id %}aria-controls="{{ card.dialog_id }}"{% endif %}
            {% if card.dialog_id %}aria-haspopup="dialog"{% endif %}
            aria-label="{{ card.label }}: {{ card.value }}{% if trend %}. {{ trend.label }}{% endif %}"
          >
            <span class="kpi-card__body">
              <span class="kpi-card__label">{{ card.label }}</span>
              <span class="kpi-card__value"{% if card.value_id %} id="{{ card.value_id }}"{% endif %}>{{ card.value }}</span>
              {% set hint = card.hint if card.hint is not none else default_hint %}
              {% if hint %}<span class="kpi-card__hint">{{ hint }}</span>{% endif %}
            </span>
            <span class="kpi-card__aside">
              {% if trend %}<span class="kpi-card__trend trend--{{ trend.direction }}" aria-label="{{ trend.label }}">{{ trend.display }}</span>{% endif %}
              {% if card.icon %}<span class="kpi-card__icon" aria-hidden="true">{{ card.icon }}</span>{% endif %}
            </span>
          </button>
        {% endfor %}
      {% elif empty_text %}
        <p class="kpi-section__empty muted">{{ empty_text }}</p>
      {% endif %}
    </div>
  </section>
{%- endmacro %}

{%- macro metric_grid(items=None, class_name=None) -%}
  <section class="metric-grid{% if class_name %} {{ class_name }}{% endif %}">
    {% if items is not none %}
      {% for card in items %}
        <article class="metric-tile surface">
          <span class="metric-tile__label">{{ card.label }}</span>
          <span class="metric-tile__value">{{ card.value }}</span>
          {% if card.meta %}<span class="metric-tile__meta muted">{{ card.meta }}</span>{% endif %}
        </article>
      {% endfor %}
    {% elif caller is defined %}
      {{ caller() }}
    {% endif %}
  </section>
{%- endmacro %}

{%- macro filter_bar(title=None, hint=None, class_name=None) -%}
  <section class="filter-bar panel{% if class_name %} {{ class_name }}{% endif %}">
    {% if title or hint %}
      <header class="filter-bar__header">
        {% if title %}<h2 class="filter-bar__title">{{ title }}</h2>{% endif %}
        {% if hint %}<p class="filter-bar__hint muted">{{ hint }}</p>{% endif %}
      </header>
    {% endif %}
    <div class="filter-bar__controls">
      {% if caller is defined %}
        {{ caller() }}
      {% endif %}
    </div>
  </section>
{%- endmacro %}

{%- macro table_shell(columns=None, caption=None, sticky_header=True, table_class=None, table_id=None, body_id=None) -%}
  <div class="table-shell" role="region">
    <table{% if table_id %} id="{{ table_id }}"{% endif %} class="data-table{% if sticky_header %} data-table--sticky{% endif %}{% if table_class %} {{ table_class }}{% endif %}">
      {% if caption %}<caption class="visually-hidden">{{ caption }}</caption>{% endif %}
      {% if columns %}
        <thead>
          <tr>
            {% for column in columns %}
              {% if column is mapping %}
                <th scope="col"{% if column.class %} class="{{ column.class }}"{% endif %}>
                  {{ column.html | default(column.label) | safe }}
                </th>
              {% else %}
                <th scope="col">{{ column }}</th>
              {% endif %}
            {% endfor %}
          </tr>
        </thead>
      {% endif %}
      <tbody{% if body_id %} id="{{ body_id }}"{% endif %}>
        {% if caller is defined %}
          {{ caller() }}
        {% endif %}
      </tbody>
    </table>
  </div>
{%- endmacro %}

{%- macro empty_state(icon=None, title=None, description=None, actions=None, tone='muted') -%}
  <section class="empty-state panel tone-{{ tone }}" role="status" aria-live="polite">
    {% if icon %}<div class="empty-state__icon" aria-hidden="true">{{ icon }}</div>{% endif %}
    {% if title %}<h2 class="empty-state__title">{{ title }}</h2>{% endif %}
    {% if description %}<p class="empty-state__description muted">{{ description }}</p>{% endif %}
    {% if actions %}
      <div class="empty-state__actions">
        {% for action in actions %}
          <a class="btn {{ action.class or 'btn-primary' }}" href="{{ action.href }}">{{ action.label }}</a>
        {% endfor %}
      </div>
    {% endif %}
  </section>
{%- endmacro %}

{%- macro toast(message, tone='info', dismissible=True, icon=None, id=None) -%}
  <div class="toast toast--{{ tone }}"{% if id %} id="{{ id }}"{% endif %} role="status" aria-live="polite">
    {% if icon %}<span class="toast__icon" aria-hidden="true">{{ icon }}</span>{% endif %}
    <span class="toast__message">{{ message }}</span>
    {% if dismissible %}
      <button class="toast__close" type="button" data-dismiss="toast" aria-label="Закрыть уведомление">×</button>
    {% endif %}
  </div>
{%- endmacro %}

{%- macro form_shell(title=None, description=None, meta=None, trail=None, actions=None) -%}
  <section class="form-shell panel">
    {{ breadcrumbs(trail) }}
    <header class="form-shell__header">
      {% if title %}<h1 class="form-shell__title">{{ title }}</h1>{% endif %}
      {% if description %}<p class="form-shell__description muted">{{ description }}</p>{% endif %}
      {% if meta %}<p class="form-shell__meta muted">{{ meta }}</p>{% endif %}
      {% if actions %}
        <div class="form-shell__actions">
          {% for action in actions %}
            <a class="btn {{ action.class or 'btn-ghost' }}" href="{{ action.href }}">{{ action.label }}</a>
          {% endfor %}
        </div>
      {% endif %}
    </header>
    <div class="form-shell__body">
      {% if caller is defined %}
        {{ caller() }}
      {% endif %}
    </div>
  </section>
{%- endmacro %}

{%- macro form_section(title=None, hint=None, span=None) -%}
  <section class="form-section{% if span == 'full' %} form-section--full{% endif %}">
    {% if title or hint %}
      <header class="form-section__header">
        {% if title %}<h2 class="form-section__title">{{ title }}</h2>{% endif %}
        {% if hint %}<p class="form-section__hint muted">{{ hint }}</p>{% endif %}
      </header>
    {% endif %}
    <div class="form-section__content">
      {% if caller is defined %}
        {{ caller() }}
      {% endif %}
    </div>
  </section>
{%- endmacro %}

{# Legacy aliases for backwards compatibility #}
{%- macro kpi_section(section_id, eyebrow=None, title=None, meta=None, cards=None, empty_text=None, placeholder_text=None, is_placeholder=False, default_hint=None) -%}
  {% if caller is defined %}
    {% call kpi_grid(section_id, eyebrow, title, meta, cards, empty_text, placeholder_text, is_placeholder, default_hint) %}
      {{ caller() }}
    {% endcall %}
  {% else %}
    {{ kpi_grid(section_id, eyebrow, title, meta, cards, empty_text, placeholder_text, is_placeholder, default_hint) }}
  {% endif %}
{%- endmacro %}

{%- macro stat_cards(items=None, class_name=None) -%}
  {% if caller is defined %}
    {% call metric_grid(items=items, class_name=class_name) %}
      {{ caller() }}
    {% endcall %}
  {% else %}
    {{ metric_grid(items=items, class_name=class_name) }}
  {% endif %}
{%- endmacro %}

{%- macro data_table(columns=None, caption=None, sticky_header=True, table_class=None, table_id=None, body_id=None) -%}
  {% if caller is defined %}
    {% call table_shell(columns=columns, caption=caption, sticky_header=sticky_header, table_class=table_class, table_id=table_id, body_id=body_id) %}
      {{ caller() }}
    {% endcall %}
  {% else %}
    {{ table_shell(columns=columns, caption=caption, sticky_header=sticky_header, table_class=table_class, table_id=table_id, body_id=body_id) }}
  {% endif %}
{%- endmacro %}
