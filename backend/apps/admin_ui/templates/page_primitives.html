{% macro page_header(opts_or_title, eyebrow=None, description=None, meta=None, badges=None) -%}
  {% if opts_or_title is mapping %}
    {% set options = opts_or_title %}
  {% else %}
    {% set options = {
      'title': opts_or_title,
      'eyebrow': eyebrow,
      'description': description,
      'meta': meta,
      'badges': badges
    } %}
  {% endif %}
  <header class="page-header">
    <div class="page-header__text">
      {% if options.eyebrow %}<p class="page-header__eyebrow muted">{{ options.eyebrow }}</p>{% endif %}
      <h1 class="page-header__title">{{ options.title }}</h1>
      {% if options.description %}<p class="page-header__description muted">{{ options.description }}</p>{% endif %}
      {% if options.meta %}<p class="page-header__meta muted">{{ options.meta }}</p>{% endif %}
      {% if options.badges %}
        <ul class="page-header__badges" role="list">
          {% for item in options.badges %}
            <li>
              <span class="badge badge-{{ item.tone | default('muted') }}">
                <span class="badge__dot" aria-hidden="true"></span>
                {{ item.label }}
              </span>
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>
    {% if caller is defined %}
      <div class="page-header__actions">
        {{ caller() }}
      </div>
    {% endif %}
  </header>
{%- endmacro %}

{% macro kpi_section(opts_or_id, eyebrow=None, title=None, meta=None, cards=None, empty_text=None, placeholder_text=None, is_placeholder=False, default_hint=None) -%}
  {% if opts_or_id is mapping %}
    {% set options = opts_or_id %}
  {% else %}
    {% set options = {
      'section_id': opts_or_id,
      'eyebrow': eyebrow,
      'title': title,
      'meta': meta,
      'cards': cards,
      'empty_text': empty_text,
      'placeholder_text': placeholder_text,
      'is_placeholder': is_placeholder,
      'default_hint': default_hint
    } %}
  {% endif %}
  {% set section_id = options.get('section_id', options.get('id')) %}
  <section class="kpi-section panel" aria-labelledby="{{ section_id }}">
    <header class="kpi-section__header">
      <div class="kpi-section__heading">
        {% if options.eyebrow %}<p class="kpi-section__eyebrow">{{ options.eyebrow }}</p>{% endif %}
        {% if options.title %}<h2 id="{{ section_id }}" class="kpi-section__title">{{ options.title }}</h2>{% endif %}
        {% if options.meta %}<p class="kpi-section__meta">{{ options.meta }}</p>{% endif %}
      </div>
      {% if caller is defined %}
        <div class="kpi-section__actions">
          {{ caller() }}
        </div>
      {% endif %}
    </header>
    <div class="kpi-section__grid">
      {% if options.is_placeholder and options.placeholder_text %}
        <p class="kpi-section__placeholder muted">{{ options.placeholder_text }}</p>
      {% elif options.cards %}
        {% for card in options.cards %}
          {% set trend = card.trend %}
          <button
            type="button"
            class="kpi-card surface focus-ring tone-{{ card.tone }}"
            data-metric="{{ card.key }}"
            aria-haspopup="dialog"
            aria-controls="kpi_drawer"
            aria-label="{{ card.label }}: {{ card.value }}. {{ trend.label if trend else '' }}"
          >
            <span class="kpi-card__body">
              <span class="kpi-card__label">{{ card.label }}</span>
              <span class="kpi-card__value"{% if card.value_id %} id="{{ card.value_id }}"{% endif %}>{{ card.value }}</span>
              {% set hint = card.hint if card.hint is not none else options.default_hint %}
              {% if hint %}<span class="kpi-card__hint">{{ hint }}</span>{% endif %}
            </span>
            <span class="kpi-card__aside">
              {% if trend %}<span class="kpi-card__trend trend--{{ trend.direction }}" aria-label="{{ trend.label }}">{{ trend.display }}</span>{% endif %}
              {% if card.icon %}<span class="kpi-card__icon" aria-hidden="true">{{ card.icon }}</span>{% endif %}
            </span>
          </button>
        {% endfor %}
      {% elif options.empty_text %}
        <p class="kpi-section__empty muted">{{ options.empty_text }}</p>
      {% endif %}
    </div>
  </section>
{%- endmacro %}

{% macro stat_cards(opts_or_items=None, class_name=None) -%}
  {% if opts_or_items is mapping %}
    {% set options = opts_or_items %}
  {% else %}
    {% set options = {
      'items': opts_or_items,
      'class_name': class_name
    } %}
  {% endif %}
  <section class="stat-grid{% if options.class_name %} {{ options.class_name }}{% endif %}">
    {% if options.items is not none %}
      {% for card in options.items %}
        <article class="stat-card surface">
          <span class="stat-card__label">{{ card.label }}</span>
          <span class="stat-card__value">{{ card.value }}</span>
          {% if card.meta %}<span class="stat-card__meta">{{ card.meta }}</span>{% endif %}
        </article>
      {% endfor %}
    {% elif caller is defined %}
      {{ caller() }}
    {% endif %}
  </section>
{%- endmacro %}

{% macro filter_bar(opts_or_title=None, hint=None, class_name=None) -%}
  {% if opts_or_title is mapping %}
    {% set options = opts_or_title %}
  {% else %}
    {% set options = {
      'title': opts_or_title,
      'hint': hint,
      'class_name': class_name
    } %}
  {% endif %}
  <section class="filter-bar panel{% if options.class_name %} {{ options.class_name }}{% endif %}">
    {% if options.title or options.hint %}
      <header class="filter-bar__header">
        {% if options.title %}<h2 class="filter-bar__title">{{ options.title }}</h2>{% endif %}
        {% if options.hint %}<p class="filter-bar__hint muted">{{ options.hint }}</p>{% endif %}
      </header>
    {% endif %}
    <div class="filter-bar__controls">
      {% if caller is defined %}
        {{ caller() }}
      {% endif %}
    </div>
  </section>
{%- endmacro %}

{% macro data_table(opts_or_columns=None, caption=None, sticky_header=True, table_class=None, table_id=None, body_id=None) -%}
  {% if opts_or_columns is mapping %}
    {% set options = opts_or_columns %}
  {% else %}
    {% set options = {
      'columns': opts_or_columns,
      'caption': caption,
      'sticky_header': sticky_header,
      'table_class': table_class,
      'table_id': table_id,
      'body_id': body_id
    } %}
  {% endif %}
  <div class="table-shell">
    <table{% if options.table_id %} id="{{ options.table_id }}"{% endif %} class="data-table{% if options.sticky_header %} data-table--sticky{% endif %}{% if options.table_class %} {{ options.table_class }}{% endif %}">
      {% if options.caption %}<caption class="visually-hidden">{{ options.caption }}</caption>{% endif %}
      {% if options.columns %}
        <thead>
          <tr>
            {% for column in options.columns %}
              {% if column is mapping %}
                <th scope="col"{% if column.class %} class="{{ column.class }}"{% endif %}>
                  {{ column.html | default(column.label) | safe }}
                </th>
              {% else %}
                <th scope="col">{{ column }}</th>
              {% endif %}
            {% endfor %}
          </tr>
        </thead>
      {% endif %}
      <tbody{% if options.body_id %} id="{{ options.body_id }}"{% endif %}>
        {% if caller is defined %}
          {{ caller() }}
        {% endif %}
      </tbody>
    </table>
  </div>
{%- endmacro %}
