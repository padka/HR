{% extends "base.html" %}
{% import "partials/form_shell.html" as forms with context %}
{% block title %}–ù–æ–≤—ã–π —Å–ª–æ—Ç{% endblock %}
{% block content %}

<style>
  /* === Liquid Glass Variables === */
  :root {
    --liquid-glass-bg: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.06) 100%);
    --liquid-glass-bg-hover: linear-gradient(135deg, rgba(255, 255, 255, 0.18) 0%, rgba(255, 255, 255, 0.10) 100%);
    --liquid-glass-border: linear-gradient(135deg, rgba(255, 255, 255, 0.20) 0%, rgba(255, 255, 255, 0.10) 50%, rgba(255, 255, 255, 0.05) 100%);
    --liquid-glass-highlight: linear-gradient(180deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.05) 30%, rgba(255, 255, 255, 0) 60%);
    --liquid-glass-shadow: 0 2px 8px -2px rgba(0, 0, 0, 0.08), 0 8px 24px -4px rgba(0, 0, 0, 0.12), inset 0 1px 2px 0 rgba(255, 255, 255, 0.15);
    --liquid-glass-shadow-hover: 0 4px 12px -2px rgba(0, 0, 0, 0.10), 0 12px 32px -4px rgba(0, 0, 0, 0.15), 0 24px 64px -8px rgba(0, 0, 0, 0.20), inset 0 1px 3px 0 rgba(255, 255, 255, 0.20);
    --liquid-glass-blur: blur(28px);
    --liquid-glass-saturate: saturate(180%);
    --liquid-glass-brightness: brightness(1.05);
    --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
    --ease-modal: cubic-bezier(0.34, 1.26, 0.64, 1);
    --ease-fade: cubic-bezier(0.25, 0.46, 0.45, 0.94);
    --duration-fast: 0.18s;
    --duration-normal: 0.3s;
    --duration-slow: 0.5s;
  }

  /* === Enhanced Segmented Control === */
  .segmented {
    position: relative;
    display: inline-flex;
    gap: 6px;
    padding: 6px;
    background: var(--liquid-glass-bg);
    backdrop-filter: var(--liquid-glass-blur) var(--liquid-glass-saturate);
    -webkit-backdrop-filter: var(--liquid-glass-blur) var(--liquid-glass-saturate);
    border: 1px solid transparent;
    border-radius: 16px;
    box-shadow: var(--liquid-glass-shadow);
    isolation: isolate;
  }

  /* Gradient border */
  .segmented::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    padding: 1px;
    background: var(--liquid-glass-border);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    pointer-events: none;
    z-index: 0;
  }

  /* Sliding indicator */
  .segmented::after {
    content: '';
    position: absolute;
    top: 6px;
    left: 6px;
    height: calc(100% - 12px);
    border-radius: 12px;
    background: linear-gradient(135deg, rgba(var(--accent-rgb, 15, 98, 254), 0.25) 0%, rgba(var(--accent-rgb, 15, 98, 254), 0.15) 100%);
    backdrop-filter: blur(16px) saturate(150%);
    -webkit-backdrop-filter: blur(16px) saturate(150%);
    border: 1px solid rgba(var(--accent-rgb, 15, 98, 254), 0.3);
    box-shadow: 0 2px 8px rgba(var(--accent-rgb, 15, 98, 254), 0.15), inset 0 1px 2px rgba(255, 255, 255, 0.3);
    transition: all 0.4s var(--ease-spring);
    z-index: 1;
  }

  .segmented[data-active="0"]::after {
    width: calc(50% - 9px);
    transform: translateX(0);
  }

  .segmented[data-active="1"]::after {
    width: calc(50% - 9px);
    transform: translateX(calc(100% + 6px));
  }

  .segmented button {
    position: relative;
    z-index: 2;
    padding: 10px 28px;
    border: none;
    background: transparent;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    color: var(--muted);
    cursor: pointer;
    transition: color var(--duration-normal) ease;
    white-space: nowrap;
  }

  .segmented button:hover {
    color: var(--fg);
  }

  .segmented button.active {
    color: var(--accent, #0f62fe);
    text-shadow: 0 0 20px rgba(var(--accent-rgb, 15, 98, 254), 0.3);
  }

  /* === Preview Panel with Glass Effect === */
  .preview-panel {
    position: relative;
    padding: 20px;
    margin-top: 20px;
    background: var(--liquid-glass-bg);
    backdrop-filter: var(--liquid-glass-blur) var(--liquid-glass-saturate) var(--liquid-glass-brightness);
    -webkit-backdrop-filter: var(--liquid-glass-blur) var(--liquid-glass-saturate) var(--liquid-glass-brightness);
    border: 1px solid transparent;
    border-radius: 20px;
    box-shadow: var(--liquid-glass-shadow);
    font-size: 14px;
    line-height: 1.6;
  }

  /* Gradient border for preview */
  .preview-panel::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    padding: 1px;
    background: var(--liquid-glass-border);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    pointer-events: none;
  }

  /* Specular highlight */
  .preview-panel::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background: var(--liquid-glass-highlight);
    pointer-events: none;
    opacity: 0.6;
    mix-blend-mode: overlay;
  }

  .preview-panel b {
    display: inline-block;
    margin-bottom: 8px;
    font-size: 15px;
    background: linear-gradient(135deg, var(--fg-strong) 0%, var(--accent) 80%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .preview-panel .ok {
    color: var(--success, #24a148);
    font-weight: 600;
  }

  .preview-panel .bad {
    color: var(--danger, #da1e28);
    font-weight: 600;
  }

  .preview-panel .warn {
    color: var(--warning, #f1c21b);
    font-weight: 600;
  }

  .preview-panel .hint {
    color: var(--muted);
    font-size: 13px;
  }

  .preview-panel code {
    padding: 2px 6px;
    background: rgba(var(--accent-rgb, 15, 98, 254), 0.1);
    border: 1px solid rgba(var(--accent-rgb, 15, 98, 254), 0.2);
    border-radius: 6px;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
    font-size: 12px;
  }

  /* === Panel Transitions === */
  .form-shell[id^="panel-"] {
    animation: panel-fade-in 0.5s var(--ease-modal) backwards;
  }

  @keyframes panel-fade-in {
    from {
      opacity: 0;
      transform: translateY(20px) scale(0.98);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  /* === Chip Styling === */
  .chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    background: var(--liquid-glass-bg);
    backdrop-filter: blur(20px) saturate(150%);
    -webkit-backdrop-filter: blur(20px) saturate(150%);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    font-size: 13px;
    font-weight: 500;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08), inset 0 1px 1px rgba(255, 255, 255, 0.15);
  }

  /* === Kbd Styling === */
  .kbd {
    display: inline-block;
    padding: 3px 8px;
    background: var(--liquid-glass-bg);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    font-family: 'SF Mono', Monaco, monospace;
    font-size: 12px;
    font-weight: 600;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), inset 0 1px 1px rgba(255, 255, 255, 0.2);
  }

  /* === Form Note Enhancement === */
  .form-note {
    font-size: 13px;
    color: var(--muted);
    margin-top: 8px;
    padding-left: 4px;
  }

  /* === Button Group Enhancement === */
  .btn-group {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 10px;
  }

  .btn--ghost.btn--sm {
    padding: 6px 12px;
    font-size: 13px;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    transition: all var(--duration-fast) var(--ease-spring);
  }

  .btn--ghost.btn--sm:hover {
    background: rgba(255, 255, 255, 0.10);
    border-color: rgba(255, 255, 255, 0.15);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12);
  }

  .btn--ghost.btn--sm:active {
    transform: translateY(-1px) scale(0.98);
  }

  /* === Advanced Settings === */
  .form-advanced summary {
    cursor: pointer;
    user-select: none;
    padding: 10px 16px;
    background: var(--liquid-glass-bg);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    transition: all var(--duration-normal) ease;
  }

  .form-advanced summary:hover {
    background: var(--liquid-glass-bg-hover);
    border-color: rgba(255, 255, 255, 0.12);
  }

  .form-advanced[open] summary {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
    margin-bottom: 16px;
  }

  /* === Accessibility === */
  @media (prefers-reduced-motion: reduce) {
    .segmented::after,
    .segmented button,
    .preview-panel,
    .form-shell[id^="panel-"],
    .btn--ghost.btn--sm {
      transition-duration: 0.01s;
      animation-duration: 0.01s;
    }
  }

  /* === Focus States === */
  .segmented button:focus-visible {
    outline: 2px solid var(--accent, #0f62fe);
    outline-offset: 4px;
  }

  /* === Modal Windows === */
  .slot-modal {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s var(--ease-fade);
  }

  .slot-modal.is-open {
    opacity: 1;
    pointer-events: auto;
  }

  /* Modal backdrop */
  .slot-modal__backdrop {
    position: absolute;
    inset: 0;
    background: rgba(8, 12, 18, 0.40);
    backdrop-filter: blur(12px) saturate(120%);
    -webkit-backdrop-filter: blur(12px) saturate(120%);
    opacity: 0;
    transition: all 0.4s var(--ease-fade);
  }

  .slot-modal.is-open .slot-modal__backdrop {
    opacity: 1;
  }

  /* Modal panel */
  .slot-modal__panel {
    position: relative;
    width: min(900px, 100%);
    max-width: 900px;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
    background: var(--liquid-glass-bg);
    backdrop-filter: var(--liquid-glass-blur) var(--liquid-glass-saturate);
    -webkit-backdrop-filter: var(--liquid-glass-blur) var(--liquid-glass-saturate);
    border: 1px solid transparent;
    border-radius: 28px;
    box-shadow:
      0 8px 32px -4px rgba(0, 0, 0, 0.20),
      0 24px 64px -8px rgba(0, 0, 0, 0.28),
      inset 0 2px 4px 0 rgba(255, 255, 255, 0.12);

    /* Initial state for animation */
    opacity: 0;
    transform: scale(0.95) translateY(20px);
    transition: all 0.4s var(--ease-modal);
  }

  .slot-modal.is-open .slot-modal__panel {
    opacity: 1;
    transform: scale(1) translateY(0);
  }

  /* Gradient border */
  .slot-modal__panel::before {
    content: '';
    position: absolute;
    inset: -1px;
    border-radius: inherit;
    padding: 1px;
    background: var(--liquid-glass-border);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    pointer-events: none;
    z-index: 1;
  }

  /* Specular highlight */
  .slot-modal__panel::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 50%;
    background: var(--liquid-glass-highlight);
    border-radius: 28px 28px 0 0;
    pointer-events: none;
    opacity: 0.7;
    mix-blend-mode: overlay;
    z-index: 0;
  }

  /* Modal header */
  .slot-modal__header {
    position: sticky;
    top: 0;
    z-index: 10;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px 32px;
    background: rgba(var(--surface-rgb, 15, 23, 42), 0.95);
    backdrop-filter: blur(20px) saturate(150%);
    -webkit-backdrop-filter: blur(20px) saturate(150%);
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 28px 28px 0 0;
  }

  .slot-modal__title {
    margin: 0;
    font-size: 24px;
    font-weight: 700;
    background: linear-gradient(135deg, var(--fg-strong) 0%, var(--accent) 80%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .slot-modal__close {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    background: var(--liquid-glass-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 50%;
    font-size: 20px;
    cursor: pointer;
    color: var(--muted);
    transition: all 0.3s ease;
  }

  .slot-modal__close:hover {
    background: var(--liquid-glass-bg-hover);
    border-color: rgba(255, 255, 255, 0.15);
    color: var(--fg);
    transform: rotate(90deg);
  }

  .slot-modal__body {
    padding: 32px;
  }

  /* Hide scrollbar but keep functionality */
  .slot-modal__panel {
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
  }

  .slot-modal__panel::-webkit-scrollbar {
    width: 8px;
  }

  .slot-modal__panel::-webkit-scrollbar-track {
    background: transparent;
  }

  .slot-modal__panel::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
  }

  .slot-modal__panel::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  /* Prevent body scroll when modal is open */
  body.modal-open {
    overflow: hidden;
  }

  /* Update accessibility */
  @media (prefers-reduced-motion: reduce) {
    .slot-modal,
    .slot-modal__backdrop,
    .slot-modal__panel {
      transition-duration: 0.01s;
    }
  }
</style>
<section class="form-shell" id="slot-switcher" data-tilt>
  <header class="form-shell__header">
    <div class="form-shell__heading">
      <h1 class="form-shell__title">–°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ—Ç–æ–≤</h1>
      <p class="form-shell__description">–õ–æ–∫–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ UTC.</p>
    </div>
    {% call forms.meta() %}
      <span class="chip" id="now_chip" title="–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–æ—è—Å–µ">‚è±Ô∏è <span id="now_text">‚Äî:‚Äî</span></span>
    {% endcall %}
  </header>
  <div class="form-shell__body">
    {% call forms.meta('role="tablist" aria-label="–†–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è"') %}
      <div class="segmented" data-active="0">
        <button id="btn-open-one" type="button" role="tab" aria-selected="true" aria-controls="modal-one">–û–¥–∏–Ω —Å–ª–æ—Ç</button>
        <button id="btn-open-bulk" type="button" role="tab" aria-selected="false" aria-controls="modal-bulk">–°–µ—Ä–∏—è</button>
      </div>
      {% call forms.note(inline=True) %}–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏: <span class="kbd">/</span> ‚Äî —Ñ–æ–∫—É—Å –Ω–∞ –¥–∞—Ç–µ, <span class="kbd">‚åò/Ctrl+Enter</span> ‚Äî —Å–æ–∑–¥–∞—Ç—å.{% endcall %}
    {% endcall %}
  </div>
</section>

{% set tone_map = {'success': 'success', 'error': 'danger', 'info': 'info'} %}
{% if flash %}
  {% set tone = tone_map.get(flash.status, 'info') %}
  <div class="surface glass grain alert" data-tone="{{ tone }}" role="alert">
    <p class="form-shell__section-hint">{{ flash.message }}</p>
  </div>
{% endif %}

<!-- Modal: –û–¥–∏–Ω —Å–ª–æ—Ç -->
<div class="slot-modal" id="modal-one" aria-labelledby="modal-one-title" aria-hidden="true">
  <div class="slot-modal__backdrop" data-modal-close></div>
  <div class="slot-modal__panel">
    <div class="slot-modal__header">
      <h2 class="slot-modal__title" id="modal-one-title">–°–æ–∑–¥–∞–Ω–∏–µ –æ–¥–Ω–æ–≥–æ —Å–ª–æ—Ç–∞</h2>
      <button class="slot-modal__close" type="button" data-modal-close aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
    </div>
    <div class="slot-modal__body">
      {% if not recruiters %}
  <div class="surface glass grain alert" role="alert">
    <h2 class="form-shell__section-title">–ù–µ—Ç —Ä–µ–∫—Ä—É—Ç—ë—Ä–æ–≤</h2>
    <p class="form-shell__section-hint">–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞, –∑–∞—Ç–µ–º —Å–æ–∑–¥–∞–π—Ç–µ —Å–ª–æ—Ç.</p>
    <div class="btn-group mt-sm">
      <a class="btn btn--primary" href="/recruiters/new">+ –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞</a>
    </div>
  </div>
{% else %}
  {% call forms.shell(
    title="–û–¥–∏–Ω —Å–ª–æ—Ç",
    description="–£–∫–∞–∂–∏—Ç–µ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞, –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è ‚Äî –ø–æ–∫–∞–∂–µ–º UTC.",
    form_id="form-one",
    action="/slots/create",
    autocomplete="off",
    section_id="panel-one",
    actions=[
      {"type": "submit", "text": "–°–æ–∑–¥–∞—Ç—å", "variant": "primary", "id": "btn-create-one", "disabled": true},
      {"href": "/slots", "text": "–û—Ç–º–µ–Ω–∞", "variant": "ghost"}
    ]
  ) %}
    {% call forms.section("–†–µ–∫—Ä—É—Ç—ë—Ä") %}
      {% call forms.field("–†–µ–∫—Ä—É—Ç—ë—Ä", hint="–í—ã–±–µ—Ä–∏—Ç–µ, –¥–ª—è –∫–æ–≥–æ —Å–æ–∑–¥–∞—ë–º —Å–ª–æ—Ç", required=True) %}
        <select id="recruiter_id" name="recruiter_id" required aria-required="true">
          <option value="" disabled selected>‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞ ‚Äî</option>
          {% for item in recruiters %}
            {% set r = item.rec %}
            {% set tz_value = r.tz or 'Europe/Moscow' %}
            {% set tz_label = tz_display(tz_value) %}
            <option value="{{ r.id }}"
                    data-tz="{{ tz_value }}"
                    data-tz-label="{{ tz_label }}"
                    data-hascities="{{ 1 if item.cities else 0 }}">{{ r.name }} ({{ tz_label }})</option>
          {% endfor %}
        </select>
      {% endcall %}
      {% call forms.field("–ì–æ—Ä–æ–¥", hint="–°–ª–æ—Ç –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞", required=True) %}
        <select id="city_id" name="city_id" required aria-required="true" disabled>
          <option value="" disabled selected>‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ ‚Äî</option>
          {% for item in recruiters %}
            {% set r = item.rec %}
            {% for city in item.cities %}
              <option value="{{ city.id }}" data-rec="{{ r.id }}" data-tz="{{ city.tz or 'Europe/Moscow' }}">{{ city.display_name }} ({{ city.tz or "Europe/Moscow" }})</option>
            {% endfor %}
          {% endfor %}
        </select>
        <p class="form-note" id="city_hint_one">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞.</p>
      {% endcall %}
      {% call forms.meta() %}
        {% call forms.note(inline=True, id='tz_one_hint') %}–†–µ–≥–∏–æ–Ω: ‚Äî{% endcall %}
        <span class="chip" id="offset_chip" title="–°–º–µ—â–µ–Ω–∏–µ –æ—Ç UTC">GMT <span id="offset_text">¬±0</span></span>
      {% endcall %}
    {% endcall %}

    {% call forms.section("–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è") %}
      <div class="form-grid form-grid--two">
        {% call forms.field("–î–∞—Ç–∞ (–ª–æ–∫–∞–ª—å–Ω–∞—è)", required=True) %}
          <input id="date" type="date" name="date" required aria-required="true">
          <div class="btn-group">
            <button class="btn btn--ghost btn--sm" type="button" data-quick="today">–°–µ–≥–æ–¥–Ω—è</button>
            <button class="btn btn--ghost btn--sm" type="button" data-quick="tomorrow">–ó–∞–≤—Ç—Ä–∞</button>
          </div>
        {% endcall %}
        {% call forms.field("–í—Ä–µ–º—è (–ª–æ–∫–∞–ª—å–Ω–æ–µ)", required=True) %}
          <input id="time" type="time" name="time" required aria-required="true">
          <div class="btn-group">
            <button class="btn btn--ghost btn--sm" type="button" data-time="next30">+30 –º–∏–Ω</button>
            <button class="btn btn--ghost btn--sm" type="button" data-time="next60">+1 —á–∞—Å</button>
            <button class="btn btn--ghost btn--sm" type="button" data-time="13:00">13:00</button>
            <button class="btn btn--ghost btn--sm" type="button" data-time="15:00">15:00</button>
          </div>
        {% endcall %}
      </div>
    {% endcall %}

    <div class="slot-preview" id="preview-one" aria-live="polite">
      <div class="slot-preview__title-row">
        <b>–ü—Ä–µ–≤—å—é</b>
        <span class="slot-preview__status slot-preview__status--idle">–û–∂–∏–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
      </div>
      <p class="slot-preview__hint">–£–∫–∞–∂–∏—Ç–µ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞, –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è ‚Äî –ø–æ–∫–∞–∂–µ–º UTC.</p>
    </div>
    {% call forms.note(id='one_submit_hint') %}–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞, –≥–æ—Ä–æ–¥, –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —Å–ª–æ—Ç.{% endcall %}
  {% endcall %}
{% endif %}
    </div>
  </div>
</div>

<!-- Modal: –°–µ—Ä–∏—è —Å–ª–æ—Ç–æ–≤ -->
<div class="slot-modal" id="modal-bulk" aria-labelledby="modal-bulk-title" aria-hidden="true">
  <div class="slot-modal__backdrop" data-modal-close></div>
  <div class="slot-modal__panel">
    <div class="slot-modal__header">
      <h2 class="slot-modal__title" id="modal-bulk-title">–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–∏–∏ —Å–ª–æ—Ç–æ–≤</h2>
      <button class="slot-modal__close" type="button" data-modal-close aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
    </div>
    <div class="slot-modal__body">
      {% if not recruiters %}
  <div class="surface glass grain alert" role="alert">
    <h2 class="form-shell__section-title">–ù–µ—Ç —Ä–µ–∫—Ä—É—Ç—ë—Ä–æ–≤</h2>
    <p class="form-shell__section-hint">–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞, –∑–∞—Ç–µ–º —Å–æ–∑–¥–∞–π—Ç–µ —Å–ª–æ—Ç—ã.</p>
    <div class="btn-group mt-sm">
      <a class="btn btn--primary" href="/recruiters/new">+ –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞</a>
    </div>
  </div>
{% else %}
  {% call forms.shell(
    title="–°–µ—Ä–∏—è —Å–ª–æ—Ç–æ–≤",
    description="–°–æ–∑–¥–∞—Å—Ç —Å–ª–æ—Ç—ã –∫–∞–∂–¥—ã–π –±—É–¥–Ω–∏–π –¥–µ–Ω—å —Å 10:00 –¥–æ 16:00, –ø–µ—Ä–µ—Ä—ã–≤ 12:00‚Äì13:00, —à–∞–≥ 30 –º–∏–Ω—É—Ç. –î—É–±–ª–∏–∫–∞—Ç—ã –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è.",
    form_id="form-bulk",
    action="/slots/bulk_create",
    autocomplete="off",
    section_id="panel-bulk",
    actions=[
      {"type": "submit", "text": "–°–æ–∑–¥–∞—Ç—å —Å–ª–æ—Ç—ã –ø–∞–∫–µ—Ç–æ–º", "variant": "primary", "id": "btn-create-bulk", "disabled": true},
      {"href": "/slots", "text": "–û—Ç–º–µ–Ω–∞", "variant": "ghost"}
    ]
  ) %}
    {% call forms.section("–†–µ–∫—Ä—É—Ç—ë—Ä") %}
      {% call forms.field("–†–µ–∫—Ä—É—Ç—ë—Ä", hint="–°–ª–æ—Ç—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –≤ –µ–≥–æ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ", required=True) %}
        <select id="recruiter_id_bulk" name="recruiter_id" required aria-required="true">
          <option value="" disabled selected>‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞ ‚Äî</option>
          {% for item in recruiters %}
            {% set r = item.rec %}
            {% set tz_value = r.tz or 'Europe/Moscow' %}
            {% set tz_label = tz_display(tz_value) %}
            <option value="{{ r.id }}"
                    data-tz="{{ tz_value }}"
                    data-tz-label="{{ tz_label }}"
                    data-hascities="{{ 1 if item.cities else 0 }}">{{ r.name }} ({{ tz_label }})</option>
          {% endfor %}
        </select>
      {% endcall %}
      {% call forms.field("–ì–æ—Ä–æ–¥", hint="–°–ª–æ—Ç—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞", required=True) %}
        <select id="city_id_bulk" name="city_id" required aria-required="true" disabled>
          <option value="" disabled selected>‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ ‚Äî</option>
          {% for item in recruiters %}
            {% set r = item.rec %}
            {% for city in item.cities %}
              <option value="{{ city.id }}" data-rec="{{ r.id }}" data-tz="{{ city.tz or 'Europe/Moscow' }}">{{ city.display_name }} ({{ city.tz or "Europe/Moscow" }})</option>
            {% endfor %}
          {% endfor %}
        </select>
        <p class="form-note" id="city_hint_bulk">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞.</p>
      {% endcall %}
      {% call forms.note(id='tz_bulk_hint') %}–†–µ–≥–∏–æ–Ω: ‚Äî{% endcall %}
    {% endcall %}

    {% call forms.section("–ü–µ—Ä–∏–æ–¥") %}
      <div class="form-grid form-grid--two">
        {% call forms.field("–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞", required=True) %}
          <input id="start_date" type="date" name="start_date" required aria-required="true">
        {% endcall %}
        {% call forms.field("–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è", required=True) %}
          <input id="end_date" type="date" name="end_date" required aria-required="true">
        {% endcall %}
      </div>
      {% call forms.meta() %}
        {{ forms.switch(id='include_weekends', name='include_weekends', label='–í–∫–ª—é—á–∞—Ç—å –≤—ã—Ö–æ–¥–Ω—ã–µ', inline=True) }}
        {{ forms.switch(id='use_break', name='use_break', label='–£—á–∏—Ç—ã–≤–∞—Ç—å –ø–µ—Ä–µ—Ä—ã–≤ 12:00‚Äì13:00', checked=True, inline=True) }}
      {% endcall %}
    {% endcall %}

    <input type="hidden" name="start_time" id="bulk_start_time" value="10:00">
    <input type="hidden" name="end_time"   id="bulk_end_time"   value="16:00">
    <input type="hidden" name="break_start" id="bulk_break_start" value="12:00">
    <input type="hidden" name="break_end"   id="bulk_break_end"   value="13:00">
    <input type="hidden" name="step_min"    id="bulk_step"        value="30">

    <details class="form-advanced mt-md">
      <summary class="hint">–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</summary>
      <div class="form-grid form-grid--two mt-sm">
        {% call forms.field("–û–∫–Ω–æ (—Å)") %}
          <input type="time" id="adv_start_time" value="10:00">
        {% endcall %}
        {% call forms.field("–û–∫–Ω–æ (–¥–æ)") %}
          <input type="time" id="adv_end_time" value="16:00">
        {% endcall %}
      </div>
      <div class="form-grid form-grid--two mt-sm">
        {% call forms.field("–ü–µ—Ä–µ—Ä—ã–≤ (—Å)") %}
          <input type="time" id="adv_break_start" value="12:00" disabled>
        {% endcall %}
        {% call forms.field("–ü–µ—Ä–µ—Ä—ã–≤ (–¥–æ)") %}
          <input type="time" id="adv_break_end" value="13:00" disabled>
        {% endcall %}
      </div>
      {% call forms.field("–®–∞–≥ (–º–∏–Ω)") %}
        <input type="number" id="adv_step" min="5" step="5" value="30">
      {% endcall %}
      {% call forms.note() %}–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫ —Å–æ–∑–¥–∞–≤–∞–µ–º–æ–π —Å–µ—Ä–∏–∏.{% endcall %}
    </details>

    <div class="slot-preview" id="preview-bulk" aria-live="polite">
      <div class="slot-preview__title-row">
        <b>–ü—Ä–µ–≤—å—é</b>
        <span class="slot-preview__status slot-preview__status--idle">–û–∂–∏–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
      </div>
      <p class="slot-preview__hint">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ ‚Äî –ø–æ—Å—á–∏—Ç–∞–µ–º –ø—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ—Ç–æ–≤ (–ø–æ –±—É–¥–Ω—è–º).</p>
    </div>
    {% call forms.note(id='bulk_submit_hint') %}–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞, –≥–æ—Ä–æ–¥ –∏ –ø–µ—Ä–∏–æ–¥, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —Å–µ—Ä–∏—é —Å–ª–æ—Ç–æ–≤.{% endcall %}
  {% endcall %}
{% endif %}
    </div>
  </div>
</div>

{% raw %}
<script nonce="{{ request.state.csp_nonce }}">
(function(){
  console.log('üöÄ Script started loading');
  console.log('  DOM state:', document.readyState);

  const $ = (s, r=document)=>r.querySelector(s);
  const $$= (s, r=document)=>Array.from(r.querySelectorAll(s));

  // Test selector function
  console.log('üîç Testing selector function:');
  const testBtn = document.getElementById('btn-open-one');
  console.log('  getElementById("btn-open-one"):', !!testBtn, testBtn);
  const testBtnQuery = document.querySelector('#btn-open-one');
  console.log('  querySelector("#btn-open-one"):', !!testBtnQuery, testBtnQuery);
  const testBtn$ = $('#btn-open-one');
  console.log('  $("#btn-open-one"):', !!testBtn$, testBtn$);

  const LS = {
    tab: 'slots_new.tab',
    recOne: 'slots_new.recOne',
    recBulk: 'slots_new.recBulk',
    cityOne: 'slots_new.cityOne',
    cityBulk: 'slots_new.cityBulk',
    date: 'slots_new.date',
    time: 'slots_new.time'
  };

  const storage = (()=>{
    try { return window.localStorage; }
    catch { return null; }
  })();
  const storageGet = (key)=>{
    if (!storage) return null;
    try { return storage.getItem(key); }
    catch { return null; }
  };
  const storageSet = (key, value)=>{
    if (!storage) return;
    try { storage.setItem(key, value); }
    catch { /* ignore */ }
  };

  const HTML_ESCAPES = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
  function escapeHtml(value){
    return String(value ?? '').replace(/[&<>"']/g, (match) => HTML_ESCAPES[match] || match);
  }

  // Modal management
  const btnOpenOne = $('#btn-open-one');
  const btnOpenBulk = $('#btn-open-bulk');
  const modalOne = $('#modal-one');
  const modalBulk = $('#modal-bulk');
  const segmentedControl = $('.segmented');

  console.log('üö™ Modal elements:');
  console.log('  btn-open-one:', !!btnOpenOne, btnOpenOne);
  console.log('  btn-open-bulk:', !!btnOpenBulk, btnOpenBulk);
  console.log('  modal-one:', !!modalOne, modalOne);
  console.log('  modal-bulk:', !!modalBulk, modalBulk);
  console.log('  segmented control:', !!segmentedControl, segmentedControl);

  function openModal(modal, index) {
    console.log('üîì openModal called:', modal?.id, 'index:', index);
    if (!modal) {
      console.log('  ‚ùå Modal is null!');
      return;
    }
    modal.classList.add('is-open');
    modal.setAttribute('aria-hidden', 'false');
    document.body.classList.add('modal-open');
    if (segmentedControl) segmentedControl.setAttribute('data-active', String(index));
    storageSet(LS.tab, index === 0 ? 'one' : 'bulk');
    console.log('  ‚úÖ Modal opened:', modal.classList.contains('is-open'));
  }

  function closeModal(modal) {
    if (!modal) return;
    modal.classList.remove('is-open');
    modal.setAttribute('aria-hidden', 'true');
    document.body.classList.remove('modal-open');
  }

  function closeAllModals() {
    closeModal(modalOne);
    closeModal(modalBulk);
  }

  // Open modal on button click
  if (btnOpenOne) {
    console.log('‚úÖ Adding click handler to btn-open-one');
    btnOpenOne.addEventListener('click', (e) => {
      console.log('üñ±Ô∏è Click on "–û–¥–∏–Ω —Å–ª–æ—Ç" button detected!');
      e.preventDefault();
      e.stopPropagation();
      closeAllModals();
      openModal(modalOne, 0);
      btnOpenOne.classList.add('active');
      btnOpenOne.setAttribute('aria-selected', 'true');
      if (btnOpenBulk) {
        btnOpenBulk.classList.remove('active');
        btnOpenBulk.setAttribute('aria-selected', 'false');
      }
    });
  } else {
    console.log('‚ùå btn-open-one not found!');
  }

  if (btnOpenBulk) {
    console.log('‚úÖ Adding click handler to btn-open-bulk');
    btnOpenBulk.addEventListener('click', (e) => {
      console.log('üñ±Ô∏è Click on "–°–µ—Ä–∏—è" button detected!');
      e.preventDefault();
      e.stopPropagation();
      closeAllModals();
      openModal(modalBulk, 1);
      btnOpenBulk.classList.add('active');
      btnOpenBulk.setAttribute('aria-selected', 'true');
      if (btnOpenOne) {
        btnOpenOne.classList.remove('active');
        btnOpenOne.setAttribute('aria-selected', 'false');
      }
    });
  } else {
    console.log('‚ùå btn-open-bulk not found!');
  }

  // Close on backdrop or close button click
  $$('[data-modal-close]').forEach(el => {
    el.addEventListener('click', (e) => {
      const modal = e.target.closest('.slot-modal');
      if (modal) closeModal(modal);
    });
  });

  // Keyboard shortcuts
  window.addEventListener('keydown', (e) => {
    // Escape: close modals
    if (e.key === 'Escape') {
      closeAllModals();
    }
    // Cmd/Ctrl+Enter: submit active form
    if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'enter') {
      const activeTab = storageGet(LS.tab) || 'one';
      const form = activeTab === 'one' ? document.getElementById('form-one') : document.getElementById('form-bulk');
      if (form) {
        e.preventDefault();
        form.requestSubmit();
      }
    }
    // /: focus on date field
    if (e.key === '/' && !e.metaKey && !e.ctrlKey && !e.altKey) {
      e.preventDefault();
      (document.getElementById('date') || document.body).focus();
    }
  });

  const fmt2 = (n)=> String(n).padStart(2,'0');
  const browserTZ = (()=>{
    try { return Intl.DateTimeFormat().resolvedOptions().timeZone || null; }
    catch { return null; }
  })();
  function parseISODate(s){ try{ return s ? new Date(s+'T00:00:00') : null; }catch{ return null; } }
  function parseTime(s){ if(!s) return null; const [h,m] = s.split(':').map(x=>parseInt(x,10)); if(isNaN(h)||isNaN(m)) return null; return {h,m}; }

  function offsetParts(tz, d){
    try {
      const parts = new Intl.DateTimeFormat('en-US', {
        timeZone: tz,
        hour: '2-digit',
        minute: '2-digit',
        timeZoneName: 'shortOffset'
      }).formatToParts(d);
      const name = parts.find((p)=>p.type==='timeZoneName');
      const raw = (name ? name.value : '').replace('GMT','').replace('UTC','').trim();
      if (!raw) return { minutes: 0, label: '¬±0' };
      const match = raw.match(/^([+-])(\d{1,2})(?::?(\d{2}))?$/);
      if (!match) return { minutes: 0, label: '¬±0' };
      const sign = match[1] === '-' ? -1 : 1;
      const hours = parseInt(match[2], 10);
      const minutes = match[3] ? parseInt(match[3], 10) : 0;
      const total = sign * (hours * 60 + minutes);
      const label = total === 0
        ? '¬±0'
        : `${sign === 1 ? '+' : '-'}${String(hours).padStart(2,'0')}${minutes ? ':' + String(minutes).padStart(2,'0') : ''}`;
      return { minutes: total, label };
    } catch {
      return { minutes: 0, label: '¬±0' };
    }
  }

  function getOffsetLabel(tz, d){
    return offsetParts(tz, d).label;
  }

  function toUTCInfo(localISO, tz){
    if (!localISO) return null;
    const [datePart, timePart] = localISO.split('T');
    if (!datePart || !timePart) return null;
    const [year, month, day] = datePart.split('-').map((n)=>parseInt(n, 10));
    const [hour, minute, second='00'] = timePart.split(':');
    const sec = parseInt(second, 10) || 0;
    if (Number.isNaN(year) || Number.isNaN(month) || Number.isNaN(day)) return null;
    const hNum = parseInt(hour, 10);
    const mNum = parseInt(minute, 10);
    if (Number.isNaN(hNum) || Number.isNaN(mNum)) return null;
    const base = Date.UTC(year, month - 1, day, hNum, mNum, sec);
    const { minutes: offsetMinutes, label: offsetLabel } = offsetParts(tz, new Date(base));
    const utcMillis = base - offsetMinutes * 60000;
    return {
      utc: new Date(utcMillis),
      offsetMinutes,
      offsetLabel,
    };
  }

  function formatInZone(date, tz){
    if (!date) return '‚Äî';
    try {
      return new Intl.DateTimeFormat('ru-RU', {
        timeZone: tz,
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      }).format(date);
    } catch {
      if (tz === 'UTC'){
        return `${fmt2(date.getUTCDate())}.${fmt2(date.getUTCMonth()+1)} ${fmt2(date.getUTCHours())}:${fmt2(date.getUTCMinutes())}`;
      }
      return `${fmt2(date.getDate())}.${fmt2(date.getMonth()+1)} ${fmt2(date.getHours())}:${fmt2(date.getMinutes())}`;
    }
  }

  function tzNowText(tz){
    try{
      const d = new Date();
      const f = new Intl.DateTimeFormat('ru-RU', { timeZone: tz, hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit' });
      return f.format(d);
    }catch{ return '‚Äî:‚Äî'; }
  }

  function toISOZ(d){ if(!d) return ''; const s = d.toISOString(); return s.replace('.000',''); }

  const nowChip = $('#now_text');
  const nowChipWrap = $('#now_chip');
  function updateNowChip(){
    const selector = $('#recruiter_id');
    const hasSelection = !!(selector && selector.value);
    const tz = hasSelection ? currentTZ(selector) : null;
    nowChip.textContent = tz ? tzNowText(tz) : '‚Äî:‚Äî';
    if (nowChipWrap){
      nowChipWrap.title = hasSelection ? currentTZLabel(selector) : '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞';
    }
  }

  const selOne = $('#recruiter_id');
  const cityOne = $('#city_id');
  const cityHintOne = $('#city_hint_one');
  const dateOne= $('#date');
  const timeOne= $('#time');
  const tzOne  = $('#tz_one_hint');
  const prevOne= $('#preview-one');
  const btnOne = $('#btn-create-one');
  const hintSubmitOne = $('#one_submit_hint');
  const offsetText = $('#offset_text');
  let canSubmitOne = false;

  console.log('üéØ Form elements initialized:');
  console.log('  recruiter select:', !!selOne, selOne);
  console.log('  city select:', !!cityOne, cityOne);
  console.log('  date input:', !!dateOne, dateOne);
  console.log('  time input:', !!timeOne, timeOne);
  console.log('  submit button:', !!btnOne, btnOne);
  console.log('  button initially disabled:', btnOne?.disabled);

  function currentTZ(selectEl){
    const el = selectEl || selOne;
    const opt = el ? el.selectedOptions[0] : null;
    return opt ? (opt.getAttribute('data-tz') || 'Europe/Moscow') : 'Europe/Moscow';
  }

  function currentTZLabel(selectEl){
    const el = selectEl || selOne;
    const opt = el ? el.selectedOptions[0] : null;
    if (!opt) return '‚Äî';
    const raw = opt.getAttribute('data-tz-label') || opt.textContent;
    if (raw && raw.trim()) return raw.trim();
    const tz = opt.getAttribute('data-tz');
    if (tz && tz.trim()){
      return `${tz.trim()} (UTC${getOffsetLabel(tz.trim(), new Date())})`;
    }
    return '‚Äî';
  }

  // Get effective timezone: city timezone if city is selected, otherwise recruiter timezone
  function getEffectiveTimezone(citySelect, recruiterSelect){
    // Try to get timezone from selected city first
    if (citySelect && citySelect.value) {
      const cityOpt = citySelect.selectedOptions[0];
      const cityTz = cityOpt ? cityOpt.getAttribute('data-tz') : null;
      if (cityTz) return cityTz;
    }
    // Fallback to recruiter timezone
    return currentTZ(recruiterSelect);
  }

  // Get effective timezone label: city name+tz if city is selected, otherwise recruiter label
  function getEffectiveTimezoneLabel(citySelect, recruiterSelect){
    if (citySelect && citySelect.value) {
      const cityOpt = citySelect.selectedOptions[0];
      if (cityOpt) {
        return cityOpt.textContent.trim();
      }
    }
    return currentTZLabel(recruiterSelect);
  }

  function updateCityOptions(recSelect, citySelect, hintEl){
    if (!citySelect) return false;
    const recId = recSelect?.value || '';
    const options = Array.from(citySelect.querySelectorAll('option[data-rec]'));
    let hasMatches = false;
    options.forEach(opt => {
      const match = recId && opt.getAttribute('data-rec') === recId;
      opt.hidden = !match;
      opt.disabled = !match;
      if (!match && opt.selected) opt.selected = false;
      if (match) hasMatches = true;
    });

    if (!recId){
      citySelect.value = '';
      citySelect.disabled = true;
      if (hintEl) hintEl.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞.';
      return false;
    }

    if (!hasMatches){
      citySelect.value = '';
      citySelect.disabled = true;
      if (hintEl) hintEl.textContent = '–î–ª—è —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞ –Ω–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤.';
      return false;
    }

    if (hintEl) hintEl.textContent = '';
    citySelect.disabled = false;

    if (!options.some(opt => !opt.disabled && opt.value === citySelect.value)){
      const first = options.find(opt => !opt.disabled);
      if (first){
        first.selected = true;
        citySelect.value = first.value;
      }
    }
    return !!citySelect.value;
  }

  function snapToHalfHour(h, m){
    const minutes = h*60 + m;
    const snapped = Math.round(minutes / 30) * 30;
    return { h: Math.floor(snapped/60)%24, m: snapped%60 };
  }

  function updateOne(){
    console.log('üîÑ updateOne() called');
    const hasCities = updateCityOptions(selOne, cityOne, cityHintOne);
    // Use city timezone if city is selected, otherwise use recruiter timezone
    const tz = getEffectiveTimezone(cityOne, selOne);
    const hasRecruiter = !!selOne?.value;
    const tzLabel = hasRecruiter ? getEffectiveTimezoneLabel(cityOne, selOne) : '‚Äî';
    tzOne.textContent = `–†–µ–≥–∏–æ–Ω: ${tzLabel}`;
    offsetText.textContent = hasRecruiter ? getOffsetLabel(tz, new Date()) : '¬±0';
    updateNowChip();

    const d = dateOne.value, t = timeOne.value;
    const cityVal = cityOne ? cityOne.value : '';
    if (cityOne) storageSet(LS.cityOne, cityVal || '');
    const ready = !!(selOne.value && hasCities && cityVal && d && t);

    console.log('  Validation check:');
    console.log('    recruiter selected:', !!selOne.value, '‚Üí', selOne.value);
    console.log('    hasCities:', hasCities);
    console.log('    city selected:', !!cityVal, '‚Üí', cityVal);
    console.log('    date filled:', !!d, '‚Üí', d);
    console.log('    time filled:', !!t, '‚Üí', t);
    console.log('    ‚Üí ready:', ready);

    canSubmitOne = ready;
    btnOne.disabled = !ready;
    console.log('  ‚Üí canSubmitOne set to:', canSubmitOne);
    console.log('  ‚Üí button disabled:', btnOne.disabled);

    if (hintSubmitOne){
      hintSubmitOne.hidden = ready;
    }

    if (!ready){
      prevOne.innerHTML = `
        <div class="slot-preview__title-row">
          <b>–ü—Ä–µ–≤—å—é</b>
          <span class="slot-preview__status slot-preview__status--idle">–û–∂–∏–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
        </div>
        <p class="slot-preview__hint">–£–∫–∞–∂–∏—Ç–µ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞, –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è ‚Äî –ø–æ–∫–∞–∂–µ–º UTC.</p>`;
      return;
    }
    const localIso = `${d}T${t}:00`;
    const info = toUTCInfo(localIso, tz);
    offsetText.textContent = info ? info.offsetLabel : '¬±0';
    if (!info){
      prevOne.innerHTML = `
        <div class="slot-preview__title-row">
          <b>–ü—Ä–µ–≤—å—é</b>
          <span class="slot-preview__status slot-preview__status--danger">–û—à–∏–±–∫–∞</span>
        </div>
        <p class="slot-preview__hint">–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å UTC ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å.</p>`;
      return;
    }
    const utc = info.utc;

    let statusClass = 'slot-preview__status--ok';
    let statusText = '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω';
    let statusNote = '—Å–ª–æ—Ç –≤ –±—É–¥—É—â–µ–º';
    try {
      if (utc < new Date()) {
        statusClass = 'slot-preview__status--danger';
        statusText = '–í –ø—Ä–æ—à–ª–æ–º';
        statusNote = '—Å–ª–æ—Ç –≤ –ø—Ä–æ—à–ª–æ–º';
      }
    } catch {}

    const isoZ = toISOZ(utc);
    const localText = formatInZone(utc, tz);
    const utcText = formatInZone(utc, 'UTC');
    const sameAsBrowser = !!(browserTZ && tz && browserTZ === tz);
    const displayUtcText = sameAsBrowser ? localText : utcText;
    const utcHint = sameAsBrowser
      ? `UTC –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞–∫ –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è (—Å–º–µ—â–µ–Ω–∏–µ ${escapeHtml(info.offsetLabel)})`
      : `UTC –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ: ${escapeHtml(utcText)}`;
    prevOne.innerHTML =
      `<div class="slot-preview__title-row">
         <b>–ü—Ä–µ–≤—å—é</b>
         <span class="slot-preview__status ${statusClass}">${statusText}</span>
       </div>
       <div class="slot-preview__grid">
         <div class="slot-preview__metric">
           <span class="slot-preview__label">–õ–æ–∫–∞–ª—å–Ω–æ (${escapeHtml(tzLabel)})</span>
           <strong>${escapeHtml(localText)}</strong>
           <p class="slot-preview__hint">IANA: <code>${escapeHtml(tz)}</code></p>
         </div>
         <div class="slot-preview__metric">
           <span class="slot-preview__label">UTC</span>
           <strong>${escapeHtml(displayUtcText)}</strong>
           <p class="slot-preview__hint">ISO: <code>${escapeHtml(isoZ)}</code></p>
         </div>
       </div>
       <p class="slot-preview__note">–°–º–µ—â–µ–Ω–∏–µ ${escapeHtml(info.offsetLabel)} ¬∑ ${escapeHtml(statusNote)}</p>
       <p class="slot-preview__hint">${utcHint}</p>`;

    storageSet(LS.recOne, selOne.value || '');
    storageSet(LS.date, d);
    storageSet(LS.time, t);
  }

  $$('#form-one [data-quick]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const now = new Date();
      if (btn.dataset.quick==='tomorrow') now.setDate(now.getDate()+1);
      dateOne.value = `${now.getFullYear()}-${fmt2(now.getMonth()+1)}-${fmt2(now.getDate())}`;
      updateOne();
    });
  });

  $$('#form-one [data-time]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const kind = btn.getAttribute('data-time');
      const tz = currentTZ(selOne);
      let base = new Date(new Date().toLocaleString('en-US', { timeZone: tz }));
      if (dateOne.value){ base = new Date(`${dateOne.value}T${timeOne.value||'09:00'}:00`); }
      if (kind==='next30') base = new Date(base.getTime() + 30*60000);
      else if (kind==='next60') base = new Date(base.getTime() + 60*60000);
      else if (/^\d{2}:\d{2}$/.test(kind)){
        if (!dateOne.value){
          const now = new Date(new Date().toLocaleString('en-US', { timeZone: tz }));
          dateOne.value = `${now.getFullYear()}-${fmt2(now.getMonth()+1)}-${fmt2(now.getDate())}`;
        }
        timeOne.value = kind; updateOne(); return;
      }
      const hh = fmt2(base.getHours()), mm = fmt2(base.getMinutes());
      timeOne.value = `${hh}:${mm}`;
      if (!dateOne.value){
        dateOne.value = `${base.getFullYear()}-${fmt2(base.getMonth()+1)}-${fmt2(base.getDate())}`;
      }
      updateOne();
    });
  });

  timeOne?.addEventListener('blur', ()=>{
    const t = parseTime(timeOne.value); if(!t) return;
    const s = snapToHalfHour(t.h, t.m);
    timeOne.value = `${fmt2(s.h)}:${fmt2(s.m)}`;
  });

  selOne?.addEventListener('change', ()=>{
    storageSet(LS.recOne, selOne.value||'');
    updateCityOptions(selOne, cityOne, cityHintOne);
    updateOne();
  });
  dateOne?.addEventListener('input', updateOne);
  timeOne?.addEventListener('input', updateOne);
  cityOne?.addEventListener('change', ()=>{
    storageSet(LS.cityOne, cityOne.value||'');
    updateOne();
  });

  (function restoreOne(){
    console.log('üîß Initializing form from localStorage');
    const r = storageGet(LS.recOne);
    console.log('  Saved recruiter:', r);
    if (r) selOne.value = r;
    updateCityOptions(selOne, cityOne, cityHintOne);
    const savedCity = storageGet(LS.cityOne);
    console.log('  Saved city:', savedCity);
    if (savedCity && cityOne){
      const match = cityOne.querySelector(`option[value="${savedCity}"][data-rec="${selOne.value}"]`);
      if (match && !match.disabled){
        cityOne.value = savedCity;
        console.log('  ‚úì City restored:', savedCity);
      }
    }
    const d = storageGet(LS.date);
    console.log('  Saved date:', d);
    if (d) dateOne.value = d;
    const t = storageGet(LS.time);
    console.log('  Saved time:', t);
    if (t) timeOne.value = t;
    console.log('  Calling updateOne() to validate...');
    updateOne();
  })();

  const selBulk = $('#recruiter_id_bulk');
  const cityBulk = $('#city_id_bulk');
  const cityHintBulk = $('#city_hint_bulk');
  const tzBulk  = $('#tz_bulk_hint');
  const sd = $('#start_date'), ed = $('#end_date');
  const prevBulk = $('#preview-bulk');
  const btnBulk = $('#btn-create-bulk');
  const hintSubmitBulk = $('#bulk_submit_hint');
  const includeWeekends = $('#include_weekends');
  const useBreak = $('#use_break');
  let canSubmitBulk = false;

  const adv = {
    start:  $('#adv_start_time'),
    end:    $('#adv_end_time'),
    bstart: $('#adv_break_start'),
    bend:   $('#adv_break_end'),
    step:   $('#adv_step')
  };
  const hid = {
    start:  $('#bulk_start_time'),
    end:    $('#bulk_end_time'),
    bstart: $('#bulk_break_start'),
    bend:   $('#bulk_break_end'),
    step:   $('#bulk_step')
  };
  Object.entries(adv).forEach(([k,el])=>{
    el?.addEventListener('input', ()=>{
      hid[k].value = el.value;
      updateBulk();
    });
  });

  includeWeekends?.addEventListener('change', updateBulk);
  useBreak?.addEventListener('change', ()=>{
    adv.bstart.disabled = adv.bend.disabled = !useBreak.checked;
    updateBulk();
  });

  function weekdaysBetween(a,b, includeWkd){
    let d = new Date(a), cnt = 0;
    while (d <= b){
      const w = d.getDay();
      if (includeWkd || (w>=1 && w<=5)) cnt++;
      d.setDate(d.getDate()+1);
    }
    return cnt;
  }
  function slotsPerDay(start,end,brs,bre,step, useBr){
    const st = parseTime(start), en = parseTime(end);
    if (!st||!en) return 0;
    const toMin = ({h,m})=>h*60+m;
    const rng = (a,b,step)=> Math.max(0, Math.floor((b-a)/step));
    if (!useBr){
      return rng(toMin(st), toMin(en), step);
    }
    const bs=parseTime(brs), be=parseTime(bre);
    if (!bs||!be) return 0;
    const before = rng(toMin(st), toMin(bs), step);
    const after  = rng(toMin(be), toMin(en), step);
    return before + after;
  }

  function dayTimes(start,end,brs,bre,step,useBr){
    const out=[]; const st=parseTime(start), en=parseTime(end);
    if(!st||!en) return out; const toMin=({h,m})=>h*60+m; const fromMin=(x)=>({h:Math.floor(x/60),m:x%60});
    const s=toMin(st), e=toMin(en), stepm=step;
    let cur=s;
    while(cur+stepm <= e){
      const {h,m}=fromMin(cur);
      if(!useBr || cur < toMin(parseTime(brs)) || cur >= toMin(parseTime(bre))) out.push(`${fmt2(h)}:${fmt2(m)}`);
      cur+=stepm;
    }
    return out;
  }

  function updateBulk(){
    const hasCities = updateCityOptions(selBulk, cityBulk, cityHintBulk);
    const hasRecruiter = !!selBulk?.value;
    // Use city timezone if city is selected, otherwise use recruiter timezone
    const tz = getEffectiveTimezone(cityBulk, selBulk);
    const tzLabel = hasRecruiter ? getEffectiveTimezoneLabel(cityBulk, selBulk) : '‚Äî';
    tzBulk.textContent = `–†–µ–≥–∏–æ–Ω: ${tzLabel}`;

    const s = sd.value, e = ed.value;
    const cityVal = cityBulk ? cityBulk.value : '';
    if (cityBulk) storageSet(LS.cityBulk, cityVal || '');
    const ready = !!(selBulk.value && hasCities && cityVal && s && e);
    canSubmitBulk = ready;
    btnBulk.disabled = !ready;
    if (hintSubmitBulk){
      hintSubmitBulk.hidden = ready;
    }

    const st = hid.start.value, en = hid.end.value, bs = hid.bstart.value, be = hid.bend.value, step = parseInt(hid.step.value||'30',10);

    if (!ready){
      prevBulk.innerHTML = `
        <div class="slot-preview__title-row">
          <b>–ü—Ä–µ–≤—å—é</b>
          <span class="slot-preview__status slot-preview__status--idle">–û–∂–∏–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
        </div>
        <p class="slot-preview__hint">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ ‚Äî –ø–æ—Å—á–∏—Ç–∞–µ–º –ø—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ—Ç–æ–≤ (–ø–æ –±—É–¥–Ω—è–º).</p>`;
      return;
    }
    const d0 = parseISODate(s), d1 = parseISODate(e);
    if (!d0 || !d1){ return; }
    const a = d0 < d1 ? d0 : d1, b = d0 < d1 ? d1 : d0;

    const wd = weekdaysBetween(a,b, !!includeWeekends.checked);
    const perDay = slotsPerDay(st,en,bs,be,step, !!useBreak.checked);
    const total = wd * perDay;

    const times = dayTimes(st,en,bs,be,step, !!useBreak.checked);
    const previewTimes = times.slice(0,6).join(', ') + (times.length>6 ? ` ‚Ä¶ –∏ –µ—â—ë ${times.length-6}` : '');
    const warnLarge = total > 300;
    const statusClassBulk = warnLarge ? 'slot-preview__status--warn' : 'slot-preview__status--ok';
    const statusTextBulk = warnLarge ? '–ö—Ä—É–ø–Ω–∞—è —Å–µ—Ä–∏—è' : '–ì–æ—Ç–æ–≤–æ';
    const noteBulk = warnLarge
      ? `–í–Ω–∏–º–∞–Ω–∏–µ: ${escapeHtml(String(total))} —Å–ª–æ—Ç–æ–≤ ‚Äî —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –æ–∂–∏–¥–∞–µ–º–æ.`
      : `–ù–µ–¥–µ–ª—è –≤–∫–ª—é—á–∞–µ—Ç ${includeWeekends.checked ? '–≤—ã—Ö–æ–¥–Ω—ã–µ' : '—Ç–æ–ª—å–∫–æ –±—É–¥–Ω–∏'}.`;

    prevBulk.innerHTML =
      `<div class="slot-preview__title-row">
         <b>–ü—Ä–µ–≤—å—é</b>
         <span class="slot-preview__status ${statusClassBulk}">${statusTextBulk}</span>
       </div>
       <div class="slot-preview__grid">
         <div class="slot-preview__metric">
           <span class="slot-preview__label">–î–Ω–µ–π</span>
           <strong>${escapeHtml(String(wd))}</strong>
           <p class="slot-preview__hint">${includeWeekends.checked ? '–≤–∫–ª—é—á–∞—è –≤—ã—Ö–æ–¥–Ω—ã–µ' : '–±—É–¥–Ω–∏'}</p>
         </div>
         <div class="slot-preview__metric">
           <span class="slot-preview__label">–°–ª–æ—Ç–æ–≤ –≤ –¥–µ–Ω—å</span>
           <strong>${escapeHtml(String(perDay))}</strong>
           <p class="slot-preview__hint">–®–∞–≥ ${escapeHtml(String(step))} –º–∏–Ω</p>
         </div>
         <div class="slot-preview__metric">
           <span class="slot-preview__label">–ò—Ç–æ–≥–æ</span>
           <strong>${escapeHtml(String(total))}</strong>
           <p class="slot-preview__hint">${warnLarge ? '–û—á–µ–Ω—å –±–æ–ª—å—à–∞—è —Å–µ—Ä–∏—è' : '–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä—ë–º'}</p>
         </div>
       </div>
       <p class="slot-preview__note">${noteBulk}</p>
       <p class="slot-preview__hint">–ü—Ä–∏–º–µ—Ä—ã –≤—Ä–µ–º–µ–Ω–∏ –≤ –¥–µ–Ω—å: ${escapeHtml(previewTimes || '‚Äî')}</p>`;

    storageSet(LS.recBulk, selBulk.value||'');
  }

  selBulk?.addEventListener('change', ()=>{
    storageSet(LS.recBulk, selBulk.value||'');
    updateCityOptions(selBulk, cityBulk, cityHintBulk);
    updateBulk();
  });
  sd?.addEventListener('input', ()=>{ if(!ed.value) ed.value = sd.value; updateBulk(); });
  ed?.addEventListener('input', updateBulk);
  cityBulk?.addEventListener('change', ()=>{
    storageSet(LS.cityBulk, cityBulk.value||'');
    updateBulk();
  });

  (function restoreBulk(){
    const r = storageGet(LS.recBulk);
    if(r) selBulk.value = r;
    updateCityOptions(selBulk, cityBulk, cityHintBulk);
    const savedCity = storageGet(LS.cityBulk);
    if (savedCity && cityBulk){
      const match = cityBulk.querySelector(`option[value="${savedCity}"][data-rec="${selBulk.value}"]`);
      if (match && !match.disabled){
        cityBulk.value = savedCity;
      }
    }
    updateBulk();
  })();

  const formOne = document.getElementById('form-one');
  if (formOne){
    formOne.addEventListener('submit', (event)=>{
      console.log('üîç Form submit triggered');
      console.log('  canSubmitOne:', canSubmitOne);
      console.log('  recruiter:', selOne?.value);
      console.log('  city:', cityOne?.value);
      console.log('  date:', dateOne?.value);
      console.log('  time:', timeOne?.value);

      if (!canSubmitOne){
        console.log('‚ùå Form submission blocked - canSubmitOne is false');
        event.preventDefault();
        if (hintSubmitOne){
          hintSubmitOne.hidden = false;
          hintSubmitOne.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞, –≥–æ—Ä–æ–¥, –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —Å–ª–æ—Ç.';
        }
        formOne.reportValidity();
        const focusTarget = !selOne?.value
          ? selOne
          : (!cityOne?.value ? cityOne : (!dateOne?.value ? dateOne : (!timeOne?.value ? timeOne : null)));
        focusTarget?.focus();
      } else {
        console.log('‚úÖ Form submission allowed');
      }
    });
  } else {
    console.log('‚ö†Ô∏è  Form #form-one not found!');
  }

  const formBulk = document.getElementById('form-bulk');
  if (formBulk){
    formBulk.addEventListener('submit', (event)=>{
      if (!canSubmitBulk){
        event.preventDefault();
        if (hintSubmitBulk){
          hintSubmitBulk.hidden = false;
          hintSubmitBulk.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞, –≥–æ—Ä–æ–¥ –∏ –ø–µ—Ä–∏–æ–¥, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —Å–µ—Ä–∏—é —Å–ª–æ—Ç–æ–≤.';
        }
        formBulk.reportValidity();
        const focusTarget = !selBulk?.value
          ? selBulk
          : (!cityBulk?.value ? cityBulk : (!sd?.value ? sd : (!ed?.value ? ed : null)));
        focusTarget?.focus();
      }
    });
  }

  updateNowChip(); setInterval(updateNowChip, 60000);

  // Auto-open modal on page load based on saved tab or default to first tab
  console.log('üîÑ Auto-opening modal on page load');
  const savedTab = storageGet(LS.tab) || 'one';
  console.log('  Saved tab:', savedTab);
  if (savedTab === 'bulk' && modalBulk) {
    console.log('  ‚Üí Opening "–°–µ—Ä–∏—è" modal');
    openModal(modalBulk, 1);
    if (btnOpenBulk) {
      btnOpenBulk.classList.add('active');
      btnOpenBulk.setAttribute('aria-selected', 'true');
    }
    if (btnOpenOne) {
      btnOpenOne.classList.remove('active');
      btnOpenOne.setAttribute('aria-selected', 'false');
    }
  } else if (modalOne) {
    console.log('  ‚Üí Opening "–û–¥–∏–Ω —Å–ª–æ—Ç" modal');
    openModal(modalOne, 0);
    if (btnOpenOne) {
      btnOpenOne.classList.add('active');
      btnOpenOne.setAttribute('aria-selected', 'true');
    }
    if (btnOpenBulk) {
      btnOpenBulk.classList.remove('active');
      btnOpenBulk.setAttribute('aria-selected', 'false');
    }
  } else {
    console.log('  ‚ùå No modals found to auto-open!');
  }

  console.log('‚úÖ Script initialization complete');
})();
</script>
{% endraw %}
{% endblock %}
