{% extends "base.html" %}
{% block title %}Шаблоны{% endblock %}
{% block content %}

<h2 style="margin:0 0 12px;">Шаблоны</h2>

<!-- Панель управления -->
<div class="card glass tilt" style="margin-bottom:12px; display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
  <div>
    <div style="font-weight:700; margin-bottom:6px;">Управление шаблонами сообщений</div>
    <div class="badge" style="display:inline-block; margin-right:6px;">Глобальные и городские шаблоны</div>
    <div class="badge" style="display:inline-block;">
      Доступные плейсхолдеры:
      {% raw %}
      <code>{{candidate_fio}}</code>, <code>{{city_name}}</code>, <code>{{slot_date_local}}</code>, <code>{{slot_time_local}}</code>, <code>{{recruiter_name}}</code>, <code>{{recruiter_phone}}</code>, <code>{{address}}</code>, <code>{{whatsapp_link}}</code>
      {% endraw %}
    </div>
  </div>
  <div style="display:flex; gap:8px; flex-wrap:wrap;">
    <a class="btn" href="/templates/new">+ Новый шаблон</a>
  </div>
</div>

<!-- Фильтры -->
<div class="card glass" style="margin-bottom:12px;">
  <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
    <div class="field" style="min-width:180px;">
      <label for="flt_type">Тип</label>
      <select id="flt_type">
        <option value="all" selected>Все</option>
        <option value="global">Глобальные</option>
        <option value="city">Городские</option>
      </select>
    </div>
    <div class="field" style="min-width:260px;">
      <label for="flt_city">Город</label>
      <select id="flt_city">
        <option value="">Все города</option>
        {% for c in cities %}
          <option value="{{ c.id }}">{{ c.name }} ({{ c.tz or "Europe/Moscow" }})</option>
        {% endfor %}
      </select>
    </div>
    <div class="field" style="min-width:260px; flex:1;">
      <label for="flt_key">Поиск по ключу/тексту</label>
      <input id="flt_key" type="text" placeholder="например: confirm_2h, invite, «Напоминание…»">
    </div>
    <button id="flt_reset" class="btn" type="button">Сбросить</button>
  </div>
</div>

{% if not items %}
  <div class="card glass tilt">
    <h4 style="margin:0 0 6px;">Пусто</h4>
    <p style="margin:0;">Шаблонов пока нет. Нажмите «Новый шаблон», чтобы добавить первый.</p>
  </div>
{% else %}

<div id="tmpl_list" class="cards">
  {% for t in items %}
  {% set is_global = (t.city is none) %}
  <div class="card glass tilt tmpl-card"
       data-type="{{ 'global' if is_global else 'city' }}"
       data-city="{{ t.city_id or '' }}"
       data-key="{{ (t.key or '')|lower }}"
       data-text="{{ (t.content or '')|e }}">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; flex-wrap:wrap;">
      <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <span class="badge">ID: {{ t.id }}</span>

        {% if is_global %}
          <span class="badge">Тип: глобальный</span>
        {% else %}
          <span class="badge">Город: {{ t.city.name }} ({{ t.city.tz or "Europe/Moscow" }})</span>
          <span class="badge">Тип: городской</span>
        {% endif %}

        <span class="badge">Ключ: <code>{{ t.key }}</code></span>
        <button class="btn" type="button" data-copy="{{ t.key }}">Скопировать ключ</button>
      </div>

      <div style="display:flex; gap:6px; flex-wrap:wrap;">
        <a class="btn" href="/templates/{{ t.id }}/edit">Редактировать</a>
        <form method="post" action="/templates/{{ t.id }}/delete" onsubmit="return confirm('Удалить шаблон?');">
          <button type="submit" style="background: var(--bad); border-color: var(--bad);">Удалить</button>
        </form>
      </div>
    </div>

    <div style="font-size:13px; color: var(--muted); margin-bottom:6px;">Превью текста</div>

    <!-- Краткий превью (обрезка на 4 строки) -->
    <div style="margin-bottom:8px; border:1px solid var(--border); border-radius:8px; background:#0e1118; padding:10px;">
      <div class="preview-short" style="white-space:pre-wrap; overflow:hidden; display:-webkit-box; -webkit-line-clamp:4; -webkit-box-orient:vertical;">
        {{ t.content }}
      </div>
    </div>

    <!-- Полный текст -->
    <details>
      <summary style="cursor:pointer; color:var(--accent);">Показать полный текст</summary>
      <pre style="margin-top:8px; white-space:pre-wrap; border:1px solid var(--border); border-radius:8px; background:#0e1118; padding:10px;">{{ t.content }}</pre>
    </details>
  </div>
  {% endfor %}
</div>

{% endif %}

{% raw %}
<script>
(function(){
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const list = $('#tmpl_list');
  if (!list) return;

  const typeSel = $('#flt_type');
  const citySel = $('#flt_city');
  const keyInp  = $('#flt_key');
  const resetBtn= $('#flt_reset');

  function normalize(s){ return (s||'').toString().toLowerCase().trim(); }

  function matchCard(card){
    const t = typeSel.value;
    const city = citySel.value;
    const q = normalize(keyInp.value);

    const cType = card.dataset.type;           // 'global' | 'city'
    const cCity = card.dataset.city || '';     // 'id' | ''
    const cKey  = (card.dataset.key || '').toLowerCase();
    const cTxt  = normalize(card.dataset.text || '');

    if (t !== 'all' && cType !== t) return false;
    if (t !== 'global' && city) {
      if (cCity !== city) return false;
    }
    if (q) {
      if (!cKey.includes(q) && !cTxt.includes(q)) return false;
    }
    return true;
  }

  function applyFilter(){
    const cards = $$('.tmpl-card', list);
    cards.forEach(card => {
      card.style.display = matchCard(card) ? '' : 'none';
    });
  }

  [typeSel, citySel].forEach(el => el && el.addEventListener('change', applyFilter));
  keyInp && keyInp.addEventListener('input', applyFilter);
  resetBtn && resetBtn.addEventListener('click', () => {
    if (typeSel) typeSel.value = 'all';
    if (citySel) citySel.value = '';
    if (keyInp)  keyInp.value  = '';
    applyFilter();
    keyInp && keyInp.focus();
  });

  // Копирование ключа
  $$('.tmpl-card [data-copy]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const v = btn.getAttribute('data-copy') || '';
      try {
        await navigator.clipboard.writeText(v);
        const old = btn.textContent;
        btn.textContent = 'Скопировано';
        setTimeout(()=> btn.textContent = old, 1200);
      } catch(e) {
        alert('Не удалось скопировать');
      }
    });
  });

  applyFilter();
})();
</script>
{% endraw %}

{% endblock %}