{% extends "base.html" %}
{% block title %}Шаблоны сообщений{% endblock %}
{% block content %}
<section class="page-grid" data-page="templates" aria-labelledby="templates-title">
  <aside class="page-aside">
    <div class="panel">
      <div class="template-aside-note">
        <h1 id="templates-title" class="page-title">Шаблоны сообщений</h1>
        <p class="page-description">
          Управляйте текстами, которые бот отправляет кандидату на каждом шаге процесса. Изменения сразу становятся
          доступными боту и автоматической рассылке.
        </p>
      </div>
      <div class="page-actions">
        <a class="btn btn-primary" href="/templates/new">Новый шаблон</a>
      </div>
    </div>

    <div class="panel panel--flush">
      <h2 class="section-title">Этапы коммуникации</h2>
      <p class="section-subtitle">Ключевые шаги, на которых кандидат взаимодействует с ботом.</p>
      <ol class="stage-flow" role="list">
        <li><strong>Шаг 1.</strong> Приглашение выбрать время для видеоинтервью.</li>
        <li><strong>Шаг 2.</strong> Напоминание за 2 часа до интервью с подтверждением.</li>
        <li><strong>Шаг 3.</strong> Приглашение на ознакомительный день после согласования даты.</li>
        <li><strong>Шаг 4.</strong> Напоминание и подтверждение явки за 2 часа до ознакомительного дня.</li>
      </ol>
    </div>

    <div class="panel panel--flush template-aside-note">
      <h2 class="section-title">Доступные переменные</h2>
      <p class="section-subtitle">Плейсхолдеры можно вставлять в текст — значения подставятся автоматически.</p>
      <div class="template-vars">
        {% raw %}
        <code>{{candidate_fio}}</code>
        <code>{{city_name}}</code>
        <code>{{interview_dt_hint}}</code>
        <code>{{slot_date_local}}</code>
        <code>{{slot_time_local}}</code>
        <code>{{slot_datetime_local}}</code>
        <code>{{recruiter_name}}</code>
        <code>{{address}}</code>
        <code>{{recruiter_phone}}</code>
        <code>{{whatsapp_link}}</code>
        {% endraw %}
      </div>
    </div>
  </aside>

  <div class="page-main">
    <div class="panel">
      <nav class="template-tabs" role="tablist" aria-label="Типы шаблонов">
        <button type="button" class="template-tab is-active" data-tab-target="global" aria-selected="true">Глобальные шаблоны</button>
        <button type="button" class="template-tab" data-tab-target="cities" aria-selected="false">Шаблоны городов</button>
      </nav>
    </div>

    <div class="panel template-panel is-active" data-panel="global">
      <header class="template-panel__header">
        <div>
          <h2 class="card-title">Глобальные шаблоны</h2>
          <p class="page-description">Используются, если для города нет собственного текста.</p>
        </div>
      </header>
      <div class="template-panel__body">
        <div class="table__wrap">
          <table class="table template-table" data-template-table="global">
            <thead>
              <tr>
                <th scope="col" class="col-name">Этап</th>
                <th scope="col" class="is-optional">Описание</th>
                <th scope="col">Текст</th>
                <th scope="col" class="col-actions">Действия</th>
              </tr>
            </thead>
            <tbody>
              {% for stage in overview.global.stages %}
                {% set preview_text = stage.value or stage.default %}
                <tr
                  class="template-row{% if stage.is_custom %} is-custom{% endif %}"
                  data-template-row
                  data-stage="{{ stage.key }}"
                  data-stage-title="{{ stage.title }}"
                  data-city=""
                  data-default="{{ stage.default|e }}"
                  data-current="{{ stage.value|e }}"
                >
                  <td data-label="Этап" class="template-cell col-name">
                    <div class="template-stage">
                      <strong>{{ stage.title }}</strong>
                      <span class="template-stage__key"><code class="text-mono">{{ stage.key }}</code></span>
                    </div>
                  </td>
                  <td data-label="Описание" class="template-description is-optional">{{ stage.description }}</td>
                  <td data-label="Текст" class="template-cell">
                    <div class="template-preview" data-role="preview">{{ preview_text or "—" }}</div>
                    <div class="template-status-line">
                      <span class="template-status{% if stage.is_custom %} template-status--custom{% endif %}" data-role="status">
                        {% if stage.is_custom %}Свой текст{% else %}По умолчанию{% endif %}
                      </span>
                      <span class="template-save-indicator" data-role="save-indicator" hidden>Сохранено</span>
                    </div>
                    <textarea
                      class="template-editor"
                      data-role="editor"
                      data-default="{{ stage.default|e }}"
                      rows="6"
                      hidden
                    >{{ stage.value or "" }}</textarea>
                  </td>
                  <td data-label="Действия" class="col-actions">
                    <div class="template-actions" data-role="view-actions">
                      <button type="button" class="btn btn-soft btn-sm" data-action="edit">Редактировать</button>
                      <button type="button" class="btn btn-ghost btn-sm" data-action="clear">Удалить</button>
                    </div>
                    <div class="template-actions" data-role="edit-actions" hidden>
                      <button type="button" class="btn btn-primary btn-sm" data-action="save">Сохранить</button>
                      <button type="button" class="btn btn-soft btn-sm" data-action="cancel">Отмена</button>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <footer class="template-panel__footer">
        <p class="template-hint">Удаление очищает текст и возвращает стандартный шаблон.</p>
      </footer>
    </div>

    <div class="panel template-panel" data-panel="cities">
      <header class="template-panel__header">
        <div>
          <h2 class="card-title">Шаблоны по городам</h2>
          <p class="page-description">Локальные тексты перекрывают глобальные шаблоны.</p>
        </div>
        {% if overview.cities %}
          <div class="template-filters">
            <label class="form-field form-field--inline">
              <span>Город</span>
              <select id="city-filter" class="template-filter">
                <option value="">Все города</option>
                {% for entry in overview.cities %}
                  <option value="{{ entry.city.id }}">{{ entry.city.name }}</option>
                {% endfor %}
              </select>
            </label>
          </div>
        {% endif %}
      </header>
      <div class="template-panel__body">
        {% if overview.cities %}
          <div class="table__wrap">
            <table class="table template-table" data-template-table="cities">
              <thead>
                <tr>
                  <th scope="col" class="col-name">Город</th>
                  <th scope="col">Этап</th>
                  <th scope="col">Текст</th>
                  <th scope="col" class="col-actions">Действия</th>
                </tr>
              </thead>
              <tbody>
                {% for entry in overview.cities %}
                  {% for stage in entry.stages %}
                    {% set preview_text = stage.value or stage.default %}
                    <tr
                      class="template-row{% if stage.is_custom %} is-custom{% endif %}"
                      data-template-row
                      data-city="{{ entry.city.id }}"
                      data-city-name="{{ entry.city.name }}"
                      data-stage="{{ stage.key }}"
                      data-stage-title="{{ stage.title }}"
                      data-default="{{ stage.default|e }}"
                      data-current="{{ stage.value|e }}"
                    >
                      <td data-label="Город" class="template-cell col-name">
                        <div class="template-city">
                          <strong>{{ entry.city.name }}</strong>
                          <span class="badge badge--soft" title="Часовой пояс">{{ entry.city.tz or "Europe/Moscow" }}</span>
                        </div>
                      </td>
                      <td data-label="Этап" class="template-cell">
                        <div class="template-stage">
                          <strong>{{ stage.title }}</strong>
                          <span class="template-stage__key"><code class="text-mono">{{ stage.key }}</code></span>
                        </div>
                      </td>
                      <td data-label="Текст" class="template-cell">
                        <div class="template-preview" data-role="preview">{{ preview_text or "—" }}</div>
                        <div class="template-status-line">
                          <span class="template-status{% if stage.is_custom %} template-status--custom{% endif %}" data-role="status">
                            {% if stage.is_custom %}Свой текст{% else %}По умолчанию{% endif %}
                          </span>
                          <span class="template-save-indicator" data-role="save-indicator" hidden>Сохранено</span>
                        </div>
                        <textarea
                          class="template-editor"
                          data-role="editor"
                          data-default="{{ stage.default|e }}"
                          rows="6"
                          hidden
                        >{{ stage.value or "" }}</textarea>
                      </td>
                      <td data-label="Действия" class="col-actions">
                        <div class="template-actions" data-role="view-actions">
                          <button type="button" class="btn btn-soft btn-sm" data-action="edit">Редактировать</button>
                          <button type="button" class="btn btn-ghost btn-sm" data-action="clear">Удалить</button>
                        </div>
                        <div class="template-actions" data-role="edit-actions" hidden>
                          <button type="button" class="btn btn-primary btn-sm" data-action="save">Сохранить</button>
                          <button type="button" class="btn btn-soft btn-sm" data-action="cancel">Отмена</button>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="alert" data-role="city-empty" hidden>Для выбранного города нет шаблонов.</div>
        {% else %}
          <div class="alert">Добавьте город, чтобы настроить локальные сообщения.</div>
        {% endif %}
      </div>
    </div>

    <div class="panel template-table-card">
      <div>
        <h2 class="section-title">Индивидуальные шаблоны</h2>
        <p class="section-subtitle">Свободные сообщения, которые можно использовать в интеграциях и ручных рассылках.</p>
      </div>
      {% if custom_templates %}
        <div class="table__wrap">
          <table class="table" data-template-table="custom">
            <thead>
              <tr>
                <th scope="col" class="col-id">ID</th>
                <th scope="col">Ключ</th>
                <th scope="col" class="col-name">Назначение</th>
                <th scope="col" class="is-optional">Фрагмент</th>
                <th scope="col" class="col-actions">Действия</th>
              </tr>
            </thead>
            <tbody>
              {% for item in custom_templates %}
                <tr>
                  <td data-label="ID" class="col-id">#{{ item.id }}</td>
                  <td data-label="Ключ"><code class="text-mono">{{ item.key }}</code></td>
                  <td data-label="Назначение" class="template-cell">
                    {% if item.is_global %}
                      <span class="badge badge--soft">Глобальный</span>
                    {% elif item.city_name %}
                      <span class="badge badge--soft">{{ item.city_name }}</span>
                      {% if item.city_tz %}
                        <span class="muted">({{ item.city_tz }})</span>
                      {% endif %}
                    {% else %}
                      <span class="muted">Город удалён</span>
                    {% endif %}
                  </td>
                  <td data-label="Фрагмент" class="is-optional template-cell">{{ item.preview }}</td>
                  <td data-label="Действия" class="col-actions">
                    <a class="btn btn-soft btn-sm" href="/templates/{{ item.id }}/edit">Редактировать</a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert">Дополнительных шаблонов пока нет. Создайте первый, чтобы использовать его в интеграциях.</div>
      {% endif %}
    </div>
  </div>
</section>

<script>
(function () {
  const tabButtons = Array.from(document.querySelectorAll('[data-tab-target]'));
  const panels = Array.from(document.querySelectorAll('[data-panel]'));
  const rows = Array.from(document.querySelectorAll('[data-template-row]'));
  const cityFilter = document.getElementById('city-filter');
  const cityEmptyState = document.querySelector('[data-role="city-empty"]');

  function activateTab(target) {
    tabButtons.forEach((btn) => {
      const isActive = btn.dataset.tabTarget === target;
      btn.classList.toggle('is-active', isActive);
      btn.setAttribute('aria-selected', String(isActive));
    });
    panels.forEach((panel) => {
      panel.classList.toggle('is-active', panel.dataset.panel === target);
    });
  }

  tabButtons.forEach((btn) => {
    btn.addEventListener('click', () => activateTab(btn.dataset.tabTarget));
  });

  function updateRowPreview(row, value) {
    const preview = row.querySelector('[data-role="preview"]');
    const status = row.querySelector('[data-role="status"]');
    const indicator = row.querySelector('[data-role="save-indicator"]');
    const defaultText = row.dataset.default || '';
    const trimmed = value.trim();
    const hasCustom = Boolean(trimmed);
    const text = hasCustom ? trimmed : (defaultText || '');
    row.dataset.current = value;
    row.classList.toggle('is-custom', hasCustom);
    if (preview) {
      preview.textContent = text || '—';
    }
    if (status) {
      status.textContent = hasCustom ? 'Свой текст' : 'По умолчанию';
      status.classList.toggle('template-status--custom', hasCustom);
    }
    if (indicator) {
      indicator.hidden = true;
      indicator.classList.remove('is-ok', 'is-error');
    }
  }

  function setEditing(row, editing) {
    const editor = row.querySelector('[data-role="editor"]');
    const viewActions = row.querySelector('[data-role="view-actions"]');
    const editActions = row.querySelector('[data-role="edit-actions"]');
    row.classList.toggle('is-editing', editing);
    if (editor) {
      editor.hidden = !editing;
      if (editing) {
        editor.focus();
        editor.setSelectionRange(editor.value.length, editor.value.length);
      }
    }
    if (viewActions) viewActions.hidden = editing;
    if (editActions) editActions.hidden = !editing;
  }

  function setLoading(row, loading) {
    row.classList.toggle('is-loading', loading);
    row.querySelectorAll('button').forEach((btn) => {
      btn.disabled = loading;
    });
  }

  async function persistRow(row, nextValue) {
    const key = row.dataset.stage;
    if (!key) return false;
    const cityId = row.dataset.city;
    const indicator = row.querySelector('[data-role="save-indicator"]');
    const payload = {
      city_id: cityId ? cityId : null,
      templates: { [key]: nextValue.trim() },
    };

    if (indicator) {
      indicator.hidden = false;
      indicator.textContent = 'Сохранение…';
      indicator.classList.remove('is-ok', 'is-error');
    }

    setLoading(row, true);
    try {
      const response = await fetch('/templates/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await response.json().catch(() => ({}));
      if (!response.ok || !data || data.ok !== true) {
        throw new Error(data && data.error ? data.error : 'Ошибка сохранения');
      }
      if (indicator) {
        indicator.textContent = 'Сохранено';
        indicator.classList.add('is-ok');
        window.setTimeout(() => {
          indicator.hidden = true;
          indicator.classList.remove('is-ok');
        }, 1400);
      }
      updateRowPreview(row, nextValue);
      setEditing(row, false);
      return true;
    } catch (err) {
      if (indicator) {
        indicator.textContent = 'Ошибка';
        indicator.classList.add('is-error');
      }
      console.error(err);
      return false;
    } finally {
      setLoading(row, false);
    }
  }

  function handleAction(event) {
    const actionEl = event.target.closest('[data-action]');
    if (!actionEl) return;
    const row = actionEl.closest('[data-template-row]');
    if (!row) return;

    const editor = row.querySelector('[data-role="editor"]');
    const action = actionEl.dataset.action;
    if (action === 'edit') {
      if (editor) editor.value = row.dataset.current || '';
      setEditing(row, true);
      return;
    }
    if (action === 'cancel') {
      if (editor) editor.value = row.dataset.current || '';
      setEditing(row, false);
      return;
    }
    if (action === 'save') {
      if (!editor) return;
      const value = editor.value || '';
      void persistRow(row, value);
      return;
    }
    if (action === 'clear') {
      const stageTitle = row.dataset.stageTitle || 'шаг';
      const cityName = row.dataset.cityName;
      const question = cityName
        ? `Удалить текст для «${stageTitle}» в городе «${cityName}»?`
        : `Удалить текст для «${stageTitle}» и вернуть стандартное сообщение?`;
      if (!window.confirm(question)) {
        return;
      }
      void persistRow(row, '');
    }
  }

  function handleInput(event) {
    const editor = event.target.closest('[data-role="editor"]');
    if (!editor) return;
    const row = editor.closest('[data-template-row]');
    if (!row) return;
    updateRowPreview(row, editor.value || '');
  }

  function filterByCity(cityId) {
    let visible = 0;
    rows.forEach((row) => {
      if (!row.dataset.city) return;
      const match = !cityId || row.dataset.city === cityId;
      row.hidden = !match;
      if (match) visible += 1;
    });
    if (cityEmptyState) {
      cityEmptyState.hidden = visible > 0;
    }
  }

  document.addEventListener('click', handleAction);
  document.addEventListener('input', handleInput);

  if (cityFilter) {
    filterByCity(cityFilter.value || '');
    cityFilter.addEventListener('change', (event) => {
      filterByCity(event.target.value || '');
    });
  }
})();
</script>
{% endblock %}
