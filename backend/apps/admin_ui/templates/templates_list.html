{% extends "base.html" %}
{% block title %}Шаблоны сообщений{% endblock %}
{% block content %}

<div class="card glass grain" style="margin-bottom:16px; padding:16px;">
  <h2 style="margin:0 0 8px;">Шаблоны по этапам</h2>
  <p class="muted" style="margin:0;">
    Здесь можно настроить тексты, которые бот отправляет кандидату на каждом шаге: после анкеты, перед интервью,
    при приглашении на ознакомительный день и перед его стартом.
    Пустое поле означает использование текста по умолчанию.
  </p>
  <div class="badge" style="margin-top:12px; display:inline-flex; gap:8px; align-items:center;">
    {% raw %}
    Доступные переменные: <code>{{candidate_fio}}</code>, <code>{{city_name}}</code>, <code>{{slot_date_local}}</code>,
    <code>{{slot_time_local}}</code>, <code>{{recruiter_name}}</code>, <code>{{address}}</code>.
    {% endraw %}
  </div>
</div>

<section class="card glass tilt" data-tilt data-tilt-max="4" data-tilt-speed="400" style="margin-bottom:18px;">
  <header style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
    <div>
      <h3 style="margin:0;">Глобальные шаблоны</h3>
      <p class="muted" style="margin:4px 0 0;">Используются, если для города нет своего текста.</p>
    </div>
  </header>
  <form class="template-form" data-city="" autocomplete="off" style="margin-top:14px;">
    {% for stage in overview.global.stages %}
      <div class="field stage-field" data-stage="{{ stage.key }}">
        <label for="global_{{ stage.key }}">{{ stage.title }}</label>
        <textarea
          id="global_{{ stage.key }}"
          data-stage="{{ stage.key }}"
          data-default="{{ stage.default|e }}"
          rows="6"
          placeholder="{{ stage.default|e }}">{{ stage.value }}</textarea>
        <div class="stage-controls">
          <button type="button" class="btn mini ghost stage-default">Вставить стандартный текст</button>
          <span class="muted">{{ stage.description }}</span>
        </div>
      </div>
    {% endfor %}
    <div class="actions">
      <button type="submit">Сохранить глобальные</button>
      <span class="badge muted save-status" style="display:none;">Сохранено</span>
    </div>
  </form>
</section>

<section class="cards city-templates">
  {% for entry in overview.cities %}
    <article class="card glass grain city-card" data-city="{{ entry.city.id }}">
      <header class="city-header">
        <h4 style="margin:0;">{{ entry.city.name }}</h4>
        <span class="badge" title="Часовой пояс">{{ entry.city.tz or "Europe/Moscow" }}</span>
      </header>
      <form class="template-form" data-city="{{ entry.city.id }}" autocomplete="off">
        {% for stage in entry.stages %}
          <div class="field stage-field" data-stage="{{ stage.key }}">
            <label for="stage_{{ entry.city.id }}_{{ stage.key }}">{{ stage.title }}</label>
            <textarea
              id="stage_{{ entry.city.id }}_{{ stage.key }}"
              data-stage="{{ stage.key }}"
              data-default="{{ stage.default|e }}"
              rows="6"
              placeholder="{{ stage.default|e }}">{{ stage.value }}</textarea>
            <div class="stage-controls">
              <button type="button" class="btn mini ghost stage-default">Вставить стандартный текст</button>
              <span class="muted">{{ stage.description }}</span>
            </div>
          </div>
        {% endfor %}
        <div class="actions">
          <button type="submit">Сохранить</button>
          <span class="badge muted save-status" style="display:none;">Сохранено</span>
        </div>
      </form>
    </article>
  {% else %}
    <div class="card glass grain">
      <h4 style="margin:0 0 6px;">Пока нет городов</h4>
      <p class="muted" style="margin:0;">Добавьте город, чтобы настроить городские сообщения.</p>
    </div>
  {% endfor %}
</section>

<style>
  .city-templates { display:grid; gap:16px; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr)); }
  .stage-field { display:flex; flex-direction:column; gap:6px; margin-bottom:14px; }
  .stage-field textarea { min-height:140px; resize:vertical; }
  .stage-controls { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .actions { display:flex; gap:10px; align-items:center; margin-top:12px; }
  .city-header { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:12px; }
  .city-card form { margin-top:4px; }
  .stage-default { border-color:var(--row-sep); background:transparent; }
  .save-status.ok { color: var(--ok); }
  .save-status.err { color: var(--bad); }
</style>

<script>
(function(){
  const forms = Array.from(document.querySelectorAll('.template-form'));

  function gatherPayload(form){
    const templates = {};
    form.querySelectorAll('textarea[data-stage]').forEach(ta => {
      const key = ta.dataset.stage;
      if (key) templates[key] = ta.value.trim();
    });
    return templates;
  }

  forms.forEach(form => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const saveBadge = form.querySelector('.save-status');
      if (saveBadge) {
        saveBadge.style.display = 'inline-block';
        saveBadge.classList.remove('ok', 'err');
        saveBadge.textContent = 'Сохранение…';
      }
      const cityId = form.dataset.city || null;
      try {
        const resp = await fetch('/templates/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ city_id: cityId && cityId !== 'undefined' ? cityId : null, templates: gatherPayload(form) })
        });
        const json = await resp.json();
        if (!json || json.ok !== true) throw new Error(json && json.error || 'Ошибка сохранения');
        if (saveBadge) {
          saveBadge.textContent = 'Сохранено';
          saveBadge.classList.add('ok');
          setTimeout(() => { saveBadge.style.display = 'none'; saveBadge.classList.remove('ok'); }, 1400);
        }
      } catch (err) {
        if (saveBadge) {
          saveBadge.textContent = 'Ошибка';
          saveBadge.classList.add('err');
        }
      }
    });
  });

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.stage-default');
    if (!btn) return;
    const field = btn.closest('.stage-field');
    const textarea = field ? field.querySelector('textarea[data-stage]') : null;
    if (textarea) {
      textarea.value = textarea.dataset.default || '';
      textarea.focus();
    }
  });
})();
</script>

{% endblock %}
