{% extends "base.html" %}
{% block title %}Шаблоны сообщений{% endblock %}
{% block content %}
<section class="page">
  <header class="page-header">
    <div>
      <h1 class="page-title">Шаблоны сообщений</h1>
      <p class="page-description">
        Настройте тексты, которые бот отправляет кандидату на каждом шаге процесса. Пустые поля используют текст по умолчанию.
      </p>
    </div>
  </header>

  <div class="card glass grain">
    <h2 class="section-title">Этапы коммуникации</h2>
    <ol class="stage-flow muted">
      <li><strong>Шаг 1.</strong> После Теста 1 кандидат получает приглашение выбрать время для видеоинтервью.</li>
      <li><strong>Шаг 2.</strong> За 2 часа до интервью бот отправляет напоминание с запросом подтверждения.</li>
      <li><strong>Шаг 3.</strong> После успешного собеседования и согласования даты бот приглашает на ознакомительный день.</li>
      <li><strong>Шаг 4.</strong> За 2 часа до ознакомительного дня бот просит подтвердить явку (кнопки «Подтверждаю/Не смогу»).</li>
    </ol>
    <div class="badge info-badge">
      {% raw %}
      Доступные переменные: <code>{{candidate_fio}}</code>, <code>{{city_name}}</code>, <code>{{interview_dt_hint}}</code>,
      <code>{{slot_date_local}}</code>, <code>{{slot_time_local}}</code>, <code>{{slot_datetime_local}}</code>,
      <code>{{recruiter_name}}</code>, <code>{{address}}</code>.
      {% endraw %}
    </div>
  </div>

  <section class="card glass tilt" data-tilt data-tilt-max="4" data-tilt-speed="400">
    <header class="page-header">
      <div>
        <h3 class="card-title">Глобальные шаблоны</h3>
        <p class="page-description">Используются, если для города нет собственного текста.</p>
      </div>
    </header>
    <form class="template-form" data-city="" autocomplete="off">
      {% for stage in overview.global.stages %}
        <div class="stage-field" data-stage="{{ stage.key }}">
          <label for="global_{{ stage.key }}">{{ stage.title }}</label>
          <textarea
            id="global_{{ stage.key }}"
            data-stage="{{ stage.key }}"
            data-default="{{ stage.default|e }}"
            rows="6"
            placeholder="{{ stage.default|e }}">{{ stage.value }}</textarea>
          <div class="stage-controls">
            <button type="button" class="btn btn-ghost btn--small stage-default">Вставить стандартный текст</button>
            <span class="muted">{{ stage.description }}</span>
          </div>
        </div>
      {% endfor %}
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Сохранить глобальные</button>
        <span class="badge muted save-status">Сохранено</span>
      </div>
    </form>
  </section>

  <section class="city-collection">
    {% for entry in overview.cities %}
      <article class="card glass grain city-card" data-city="{{ entry.city.id }}">
        <header class="city-card__header">
          <div class="city-card__title">
            <span class="city-name">{{ entry.city.name }}</span>
            <span class="badge" title="Часовой пояс">{{ entry.city.tz or "Europe/Moscow" }}</span>
          </div>
        </header>
        <form class="template-form" data-city="{{ entry.city.id }}" autocomplete="off">
          {% for stage in entry.stages %}
            <div class="stage-field" data-stage="{{ stage.key }}">
              <label for="stage_{{ entry.city.id }}_{{ stage.key }}">{{ stage.title }}</label>
              <textarea
                id="stage_{{ entry.city.id }}_{{ stage.key }}"
                data-stage="{{ stage.key }}"
                data-default="{{ stage.default|e }}"
                rows="6"
                placeholder="{{ stage.default|e }}">{{ stage.value }}</textarea>
              <div class="stage-controls">
                <button type="button" class="btn btn-ghost btn--small stage-default">Вставить стандартный текст</button>
                <span class="muted">{{ stage.description }}</span>
              </div>
            </div>
          {% endfor %}
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Сохранить</button>
            <span class="badge muted save-status">Сохранено</span>
          </div>
        </form>
      </article>
    {% else %}
      <div class="card glass grain">
        <h3 class="section-title">Пока нет городов</h3>
        <p class="page-description">Добавьте город, чтобы настроить городские сообщения.</p>
      </div>
    {% endfor %}
  </section>
</section>

<script>
(function(){
  const forms = Array.from(document.querySelectorAll('.template-form'));

  function gatherPayload(form){
    const templates = {};
    form.querySelectorAll('textarea[data-stage]').forEach(ta => {
      const key = ta.dataset.stage;
      if (key) templates[key] = ta.value.trim();
    });
    return templates;
  }

  forms.forEach(form => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const saveBadge = form.querySelector('.save-status');
      if (saveBadge) {
        saveBadge.style.display = 'inline-block';
        saveBadge.classList.remove('ok', 'err');
        saveBadge.textContent = 'Сохранение…';
      }
      const cityId = form.dataset.city || null;
      try {
        const resp = await fetch('/templates/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ city_id: cityId && cityId !== 'undefined' ? cityId : null, templates: gatherPayload(form) })
        });
        const json = await resp.json();
        if (!json || json.ok !== true) throw new Error(json && json.error || 'Ошибка сохранения');
        if (saveBadge) {
          saveBadge.textContent = 'Сохранено';
          saveBadge.classList.add('ok');
          setTimeout(() => { saveBadge.style.display = 'none'; saveBadge.classList.remove('ok'); }, 1400);
        }
      } catch (err) {
        if (saveBadge) {
          saveBadge.textContent = 'Ошибка';
          saveBadge.classList.add('err');
        }
      }
    });
  });

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.stage-default');
    if (!btn) return;
    const field = btn.closest('.stage-field');
    const textarea = field ? field.querySelector('textarea[data-stage]') : null;
    if (textarea) {
      textarea.value = textarea.dataset.default || '';
      textarea.focus();
    }
  });
})();
</script>
{% endblock %}
