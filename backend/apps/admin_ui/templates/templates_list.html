{% extends "base_liquid.html" %}
{% block title %}Шаблоны сообщений{% endblock %}
{% block content %}
<section class="page">
  <header class="page-header">
    <div>
      <h1 class="page-title">Шаблоны сообщений</h1>
      <p class="page-description">
        Управляйте текстами, которые бот отправляет кандидату на каждом шаге процесса. Любые изменения
        сразу становятся доступными боту и автоматической рассылке.
      </p>
    </div>
    <div class="page-actions">
      <a class="btn btn-primary" href="/templates/new">Новый шаблон</a>
    </div>
  </header>

  <div class="card glass grain">
    <h2 class="section-title">Этапы коммуникации</h2>
    <p class="section-subtitle">Ключевые шаги, на которых кандидат взаимодействует с ботом.</p>
    <ol class="stage-flow muted">
      <li><strong>Шаг 1.</strong> Приглашение выбрать время для видеоинтервью.</li>
      <li><strong>Шаг 2.</strong> Напоминание за 2 часа до интервью с подтверждением.</li>
      <li><strong>Шаг 3.</strong> Приглашение на ознакомительный день после согласования даты.</li>
      <li><strong>Шаг 4.</strong> Напоминание и подтверждение явки за 2 часа до ознакомительного дня.</li>
    </ol>
    <div class="badge info-badge">
      {% raw %}
      Доступные переменные: <code>{{candidate_fio}}</code>, <code>{{city_name}}</code>, <code>{{interview_dt_hint}}</code>,
      <code>{{slot_date_local}}</code>, <code>{{slot_time_local}}</code>, <code>{{slot_datetime_local}}</code>,
      <code>{{recruiter_name}}</code>, <code>{{address}}</code>.
      {% endraw %}
    </div>
  </div>

  <nav class="template-tabs" role="tablist" aria-label="Типы шаблонов">
    <button type="button" class="template-tab is-active" data-tab-target="global">Глобальные шаблоны</button>
    <button type="button" class="template-tab" data-tab-target="cities">Шаблоны городов</button>
  </nav>

  <section class="card glass grain template-panel is-active" data-panel="global">
    <header class="template-panel__header">
      <div>
        <h3 class="card-title">Глобальные шаблоны</h3>
        <p class="page-description">Используются, если для города нет собственного текста.</p>
      </div>
    </header>
    <div class="list-table-wrapper">
      <table class="list-table template-table" data-template-table="global">
        <thead>
          <tr>
            <th scope="col">Этап</th>
            <th scope="col" class="is-optional">Описание</th>
            <th scope="col">Текст</th>
            <th scope="col" class="col-align-end">Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for stage in overview.global.stages %}
            {% set preview_text = stage.value or stage.default %}
            <tr
              class="template-row{% if stage.is_custom %} is-custom{% endif %}"
              data-template-row
              data-stage="{{ stage.key }}"
              data-stage-title="{{ stage.title }}"
              data-city=""
              data-default="{{ stage.default|e }}"
              data-current="{{ stage.value|e }}"
            >
              <td data-label="Этап">
                <div class="template-stage">
                  <strong>{{ stage.title }}</strong>
                  <span class="template-stage__key"><code class="text-mono">{{ stage.key }}</code></span>
                </div>
              </td>
              <td data-label="Описание" class="template-description is-optional">{{ stage.description }}</td>
              <td data-label="Текст" class="template-cell">
                <div class="template-preview" data-role="preview">{{ preview_text or "—" }}</div>
                <div class="template-status-line">
                  <span class="badge template-status{% if stage.is_custom %} template-status--custom{% endif %}" data-role="status">
                    {% if stage.is_custom %}Свой текст{% else %}По умолчанию{% endif %}
                  </span>
                  <span class="badge muted template-save-indicator" data-role="save-indicator" hidden>Сохранено</span>
                </div>
                <textarea
                  class="template-editor"
                  data-role="editor"
                  data-default="{{ stage.default|e }}"
                  rows="6"
                  hidden
                >{{ stage.value or "" }}</textarea>
              </td>
              <td data-label="Действия" class="col-align-end">
                <div class="template-actions" data-role="view-actions">
                  <button type="button" class="btn btn-soft btn--small" data-action="edit">Редактировать</button>
                  <button type="button" class="btn btn-ghost btn--small template-action--danger" data-action="clear">Удалить</button>
                </div>
                <div class="template-actions" data-role="edit-actions" hidden>
                  <button type="button" class="btn btn-primary btn--small" data-action="save">Сохранить</button>
                  <button type="button" class="btn btn-soft btn--small" data-action="cancel">Отмена</button>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <footer class="template-hint muted">Удаление очищает текст и возвращает стандартный шаблон.</footer>
  </section>

  <section class="card glass grain template-panel" data-panel="cities">
    <header class="template-panel__header">
      <div>
        <h3 class="card-title">Шаблоны по городам</h3>
        <p class="page-description">Локальные тексты перекрывают глобальные шаблоны.</p>
      </div>
      {% if overview.cities %}
        <div class="template-filters">
          <label class="form-field form-field--wide">
            <span>Город</span>
            <select id="city-filter" class="template-filter">
              <option value="">Все города</option>
              {% for entry in overview.cities %}
                <option value="{{ entry.city.id }}">{{ entry.city.name }}</option>
              {% endfor %}
            </select>
          </label>
        </div>
      {% endif %}
    </header>
    {% if overview.cities %}
      <div class="list-table-wrapper">
        <table class="list-table template-table" data-template-table="cities">
          <thead>
            <tr>
              <th scope="col">Город</th>
              <th scope="col">Этап</th>
              <th scope="col">Текст</th>
              <th scope="col" class="col-align-end">Действия</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in overview.cities %}
              {% for stage in entry.stages %}
                {% set preview_text = stage.value or stage.default %}
                <tr
                  class="template-row{% if stage.is_custom %} is-custom{% endif %}"
                  data-template-row
                  data-city="{{ entry.city.id }}"
                  data-city-name="{{ entry.city.name }}"
                  data-stage="{{ stage.key }}"
                  data-stage-title="{{ stage.title }}"
                  data-default="{{ stage.default|e }}"
                  data-current="{{ stage.value|e }}"
                >
                  <td data-label="Город">
                    <div class="template-city">
                      <strong>{{ entry.city.name }}</strong>
                      <span class="badge" title="Часовой пояс">{{ entry.city.tz or "Europe/Moscow" }}</span>
                    </div>
                  </td>
                  <td data-label="Этап">
                    <div class="template-stage">
                      <strong>{{ stage.title }}</strong>
                      <span class="template-stage__key"><code class="text-mono">{{ stage.key }}</code></span>
                    </div>
                  </td>
                  <td data-label="Текст" class="template-cell">
                    <div class="template-preview" data-role="preview">{{ preview_text or "—" }}</div>
                    <div class="template-status-line">
                      <span class="badge template-status{% if stage.is_custom %} template-status--custom{% endif %}" data-role="status">
                        {% if stage.is_custom %}Свой текст{% else %}По умолчанию{% endif %}
                      </span>
                      <span class="badge muted template-save-indicator" data-role="save-indicator" hidden>Сохранено</span>
                    </div>
                    <textarea
                      class="template-editor"
                      data-role="editor"
                      data-default="{{ stage.default|e }}"
                      rows="6"
                      hidden
                    >{{ stage.value or "" }}</textarea>
                  </td>
                  <td data-label="Действия" class="col-align-end">
                    <div class="template-actions" data-role="view-actions">
                      <button type="button" class="btn btn-soft btn--small" data-action="edit">Редактировать</button>
                      <button type="button" class="btn btn-ghost btn--small template-action--danger" data-action="clear">Удалить</button>
                    </div>
                    <div class="template-actions" data-role="edit-actions" hidden>
                      <button type="button" class="btn btn-primary btn--small" data-action="save">Сохранить</button>
                      <button type="button" class="btn btn-soft btn--small" data-action="cancel">Отмена</button>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="alert mt-sm" data-role="city-empty" hidden>Для выбранного города нет шаблонов.</div>
      <footer class="template-hint muted">Удаление очищает текст и включает глобальный шаблон.</footer>
    {% else %}
      <div class="alert mt-sm">Добавьте город, чтобы настроить локальные сообщения.</div>
    {% endif %}
  </section>

  <section class="card glass grain template-table-card">
    <h2 class="section-title">Индивидуальные шаблоны</h2>
    <p class="section-subtitle">Свободные сообщения, которые можно использовать в интеграциях и ручных рассылках.</p>

    {% if custom_templates %}
      <div class="list-table-wrapper">
        <table class="list-table list-table--responsive">
          <thead>
            <tr>
              <th scope="col">ID</th>
              <th scope="col">Ключ</th>
              <th scope="col">Назначение</th>
              <th scope="col" class="is-optional">Фрагмент</th>
              <th scope="col" class="col-align-end">Действия</th>
            </tr>
          </thead>
          <tbody>
            {% for item in custom_templates %}
              <tr>
                <td data-label="ID">#{{ item.id }}</td>
                <td data-label="Ключ"><code class="text-mono">{{ item.key }}</code></td>
                <td data-label="Назначение">
                  {% if item.is_global %}
                    <span class="badge">Глобальный</span>
                  {% elif item.city_name %}
                    <span class="badge">{{ item.city_name }}</span>
                    {% if item.city_tz %}
                      <span class="muted">({{ item.city_tz }})</span>
                    {% endif %}
                  {% else %}
                    <span class="muted">Город удалён</span>
                  {% endif %}
                </td>
                <td data-label="Фрагмент" class="is-optional">{{ item.preview }}</td>
                <td data-label="Действия" class="col-align-end">
                  <a class="btn btn-soft btn--small" href="/templates/{{ item.id }}/edit">Редактировать</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert mt-sm">Дополнительных шаблонов пока нет. Создайте первый, чтобы использовать его в интеграциях.</div>
    {% endif %}
  </section>
</section>

<script>
(function () {
  const tabButtons = Array.from(document.querySelectorAll('[data-tab-target]'));
  const panels = Array.from(document.querySelectorAll('[data-panel]'));
  const rows = Array.from(document.querySelectorAll('[data-template-row]'));
  const cityFilter = document.getElementById('city-filter');
  const cityEmptyState = document.querySelector('[data-role="city-empty"]');

  function activateTab(target) {
    tabButtons.forEach((btn) => {
      const isActive = btn.dataset.tabTarget === target;
      btn.classList.toggle('is-active', isActive);
      btn.setAttribute('aria-selected', String(isActive));
    });
    panels.forEach((panel) => {
      panel.classList.toggle('is-active', panel.dataset.panel === target);
    });
  }

  tabButtons.forEach((btn) => {
    btn.addEventListener('click', () => activateTab(btn.dataset.tabTarget));
  });

  function updateRowPreview(row, value) {
    const preview = row.querySelector('[data-role="preview"]');
    const status = row.querySelector('[data-role="status"]');
    const indicator = row.querySelector('[data-role="save-indicator"]');
    const defaultText = row.dataset.default || '';
    const trimmed = value.trim();
    const hasCustom = Boolean(trimmed);
    const text = hasCustom ? trimmed : (defaultText || '');
    row.dataset.current = value;
    row.classList.toggle('is-custom', hasCustom);
    if (preview) {
      preview.textContent = text || '—';
    }
    if (status) {
      status.textContent = hasCustom ? 'Свой текст' : 'По умолчанию';
      status.classList.toggle('template-status--custom', hasCustom);
    }
    if (indicator) {
      indicator.hidden = true;
      indicator.classList.remove('is-ok', 'is-error');
    }
  }

  function setEditing(row, editing) {
    const editor = row.querySelector('[data-role="editor"]');
    const viewActions = row.querySelector('[data-role="view-actions"]');
    const editActions = row.querySelector('[data-role="edit-actions"]');
    row.classList.toggle('is-editing', editing);
    if (editor) {
      editor.hidden = !editing;
      if (editing) {
        editor.focus();
        editor.setSelectionRange(editor.value.length, editor.value.length);
      }
    }
    if (viewActions) viewActions.hidden = editing;
    if (editActions) editActions.hidden = !editing;
  }

  function setLoading(row, loading) {
    row.classList.toggle('is-loading', loading);
    row.querySelectorAll('button').forEach((btn) => {
      btn.disabled = loading;
    });
  }

  async function persistRow(row, nextValue) {
    const key = row.dataset.stage;
    if (!key) return false;
    const cityId = row.dataset.city;
    const indicator = row.querySelector('[data-role="save-indicator"]');
    const payload = {
      city_id: cityId ? cityId : null,
      templates: { [key]: nextValue.trim() },
    };

    if (indicator) {
      indicator.hidden = false;
      indicator.textContent = 'Сохранение…';
      indicator.classList.remove('is-ok', 'is-error');
    }

    setLoading(row, true);
    try {
      const response = await fetch('/templates/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await response.json().catch(() => ({}));
      if (!response.ok || !data || data.ok !== true) {
        throw new Error(data && data.error ? data.error : 'Ошибка сохранения');
      }
      if (indicator) {
        indicator.textContent = 'Сохранено';
        indicator.classList.add('is-ok');
        window.setTimeout(() => {
          indicator.hidden = true;
          indicator.classList.remove('is-ok');
        }, 1400);
      }
      updateRowPreview(row, nextValue);
      setEditing(row, false);
      return true;
    } catch (err) {
      if (indicator) {
        indicator.textContent = 'Ошибка';
        indicator.classList.add('is-error');
      }
      console.error(err);
      return false;
    } finally {
      setLoading(row, false);
    }
  }

  function handleAction(event) {
    const actionEl = event.target.closest('[data-action]');
    if (!actionEl) return;
    const row = actionEl.closest('[data-template-row]');
    if (!row) return;

    const editor = row.querySelector('[data-role="editor"]');
    const action = actionEl.dataset.action;
    if (action === 'edit') {
      if (editor) editor.value = row.dataset.current || '';
      setEditing(row, true);
      return;
    }
    if (action === 'cancel') {
      if (editor) editor.value = row.dataset.current || '';
      setEditing(row, false);
      return;
    }
    if (action === 'save') {
      if (!editor) return;
      const value = editor.value || '';
      void persistRow(row, value);
      return;
    }
    if (action === 'clear') {
      const stageTitle = row.dataset.stageTitle || 'шаг';
      const cityName = row.dataset.cityName;
      const message = cityName
        ? `Удалить текст для города «${cityName}» (${stageTitle}) и использовать глобальный шаблон?`
        : `Удалить глобальный текст для «${stageTitle}» и вернуться к стандартному шаблону?`;
      if (!window.confirm(message)) {
        return;
      }
      if (editor) editor.value = '';
      void persistRow(row, '');
    }
  }

  document.addEventListener('click', handleAction);

  function applyCityFilter() {
    if (!cityFilter) return;
    const value = cityFilter.value;
    const table = document.querySelector('[data-template-table="cities"]');
    if (!table) return;
    const tableRows = Array.from(table.querySelectorAll('[data-template-row]'));
    let visibleCount = 0;
    tableRows.forEach((row) => {
      const matches = !value || row.dataset.city === value;
      row.hidden = !matches;
      if (matches) visibleCount += 1;
    });
    if (cityEmptyState) {
      cityEmptyState.hidden = visibleCount !== 0;
    }
  }

  if (cityFilter) {
    cityFilter.addEventListener('change', applyCityFilter);
  }

  rows.forEach((row) => {
    updateRowPreview(row, row.dataset.current || '');
  });

  applyCityFilter();
})();
</script>
{% endblock %}
