{% extends "base.html" %}
{% block title %}Детализация кандидатов{% endblock %}
{% block content %}
<section class="page page--candidates-detail" aria-labelledby="detail-title">
  <header class="page-header">
    <div>
      <h1 id="detail-title" class="page-title">Детализация кандидатов</h1>
      <p class="page-description">Статусы закрепления на обучение: закреплён / не закреплён.</p>
    </div>
    <a class="liquid-glass-btn liquid-glass-btn--ghost" href="/candidates">← К кандидатам</a>
  </header>

  <section class="detail-controls">
    <form class="detail-filters" method="get">
      <label class="detail-filters__search">
        <span class="detail-filters__label">Поиск</span>
        <input type="search" name="search" placeholder="ФИО, город, TG ID..." value="{{ search_query }}">
      </label>
      <div class="detail-filters__statuses" role="tablist" aria-label="Статусы закрепления">
        {% set tabs = [
          {'key': 'all', 'label': 'Все', 'slug': None},
          {'key': 'hired', 'label': 'Закреплён', 'slug': 'hired'},
          {'key': 'not_hired', 'label': 'Не закреплён', 'slug': 'not_hired'},
        ] %}
        {% for tab in tabs %}
          {% set is_active = selected_status == tab.slug or (tab.key == 'all' and selected_status == 'all') %}
          <button type="submit"
                  name="status"
                  value="{{ tab.slug or '' }}"
                  class="detail-tab{% if is_active %} is-active{% endif %}"
                  aria-pressed="{{ 'true' if is_active else 'false' }}">
            <span>{{ tab.label }}</span>
            {% if tab.slug %}
              <span class="detail-tab__count">{{ status_totals.get(tab.slug, 0) }}</span>
            {% endif %}
          </button>
        {% endfor %}
      </div>
      <div class="detail-filters__actions">
        <button type="submit" class="liquid-glass-btn liquid-glass-btn--primary">Применить</button>
        <a class="liquid-glass-btn liquid-glass-btn--ghost" href="/candidates/detailization">Сбросить</a>
      </div>
    </form>
  </section>

  <section class="detail-table" aria-label="Список кандидатов">
    <div class="detail-grid">
      {% if list_groups %}
        {% for group in list_groups.values() %}
          {% for card in group.candidates %}
            <article class="detail-card" data-status="{{ card.status.slug }}">
              <header class="detail-card__header">
                <div>
                  <h3 class="detail-card__name">{{ card.fio }}</h3>
                  <p class="detail-card__meta">{{ card.city or 'Город не указан' }}</p>
                </div>
                <span class="status-pill" data-tone="{{ card.status.tone }}">
                  {% if card.status.icon %}<span class="status-pill__icon">{{ card.status.icon }}</span>{% endif %}
                  {{ card.status.label }}
                </span>
              </header>
              <dl class="detail-card__info">
                <div>
                  <dt>Телеграм</dt>
                  <dd>
                    {% if card.telegram_username %}
                      <a href="https://t.me/{{ card.telegram_username }}" target="_blank" rel="noopener">@{{ card.telegram_username }}</a>
                    {% elif card.telegram_id %}
                      {{ card.telegram_id }}
                    {% else %}
                      —
                    {% endif %}
                  </dd>
                </div>
                <div>
                  <dt>Рекрутер</dt>
                  <dd>{{ card.recruiter.name if card.recruiter else '—' }}</dd>
                </div>
                <div>
                  <dt>Тесты</dt>
                  <dd>{{ card.tests.test1.label }} / {{ card.tests.test2.label }}</dd>
                </div>
                <div>
                  <dt>Интервью</dt>
                  <dd>
                    {% if card.upcoming_slot %}
                      {{ fmt_local(card.upcoming_slot.start_utc, card.upcoming_slot.candidate_tz or 'Europe/Moscow') }}
                    {% elif card.latest_slot %}
                      {{ fmt_local(card.latest_slot.start_utc, card.latest_slot.candidate_tz or 'Europe/Moscow') }}
                    {% else %}
                      —
                    {% endif %}
                  </dd>
                </div>
              </dl>
              <div class="detail-card__actions">
                <a class="liquid-glass-btn liquid-glass-btn--secondary liquid-glass-btn--small" href="/candidates/{{ card.id }}">Профиль</a>
                {% if card.upcoming_slot %}
                  <a class="liquid-glass-btn liquid-glass-btn--ghost liquid-glass-btn--small" href="/candidates/{{ card.id }}/schedule">Перенести слот</a>
                {% endif %}
              </div>
            </article>
          {% endfor %}
        {% endfor %}
      {% else %}
        <div class="detail-empty">
          <p>Кандидаты не найдены по текущим фильтрам.</p>
          <a class="liquid-glass-btn liquid-glass-btn--ghost" href="/candidates/detailization">Сбросить фильтры</a>
        </div>
      {% endif %}
    </div>
  </section>
</section>

<style>
  .detail-controls {
    margin: 18px 0 12px;
    padding: 14px;
    border-radius: 18px;
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
  }
  .detail-filters {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 12px;
    align-items: end;
  }
  .detail-filters__label { color: var(--muted); font-size: 12px; letter-spacing: 0.04em; }
  .detail-filters__search input {
    width: 100%;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(10, 12, 22, 0.8);
    color: var(--fg);
  }
  .detail-filters__statuses {
    display: inline-flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }
  .detail-tab {
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.04);
    color: var(--fg);
    padding: 8px 12px;
    border-radius: 12px;
    cursor: pointer;
    display: inline-flex;
    gap: 8px;
    align-items: center;
    transition: all 0.2s ease;
  }
  .detail-tab__count {
    padding: 4px 8px;
    border-radius: 10px;
    background: rgba(255,255,255,0.08);
    font-size: 12px;
  }
  .detail-tab.is-active {
    border-color: var(--accent);
    box-shadow: 0 8px 24px rgba(105, 183, 255, 0.25);
    background: rgba(105, 183, 255, 0.16);
  }
  .detail-filters__actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }
  .detail-table { margin-top: 10px; }
  .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 12px; }
  .detail-card {
    padding: 14px;
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    background: linear-gradient(145deg, rgba(20,24,38,0.95), rgba(15,18,30,0.92));
    box-shadow: 0 12px 32px rgba(0,0,0,0.25);
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .detail-card__header { display: flex; justify-content: space-between; gap: 10px; align-items: center; }
  .detail-card__name { margin: 0; font-size: 17px; font-weight: 800; }
  .detail-card__meta { margin: 0; color: rgba(255,255,255,0.7); }
  .detail-card__info { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px,1fr)); gap: 8px; margin: 0; }
  .detail-card__info dt { font-size: 12px; color: var(--muted); }
  .detail-card__info dd { margin: 0; font-size: 13px; color: rgba(255,255,255,0.9); }
  .detail-card__actions { display: flex; gap: 8px; justify-content: flex-end; flex-wrap: wrap; }
  .detail-empty { padding: 20px; border-radius: 16px; border: 1px dashed rgba(255,255,255,0.14); text-align: center; }
</style>
{% endblock %}
