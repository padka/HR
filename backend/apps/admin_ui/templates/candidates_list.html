{% extends "base.html" %}
{% from "page_primitives.html" import page_header, data_table %}
{% import "partials/list_toolbar.html" as toolbars %}
{% block title %}Кандидаты{% endblock %}
{% block content %}
  {% call page_header(
    title="Кандидаты",
    description="Единая база кандидатов с аналитикой и быстрыми действиями."
  ) %}
    <a class="btn btn-primary" href="/candidates/new">Добавить кандидата</a>
  {% endcall %}

  {% call toolbars.list_toolbar(
    form_id="candidates-toolbar",
    form_action="/candidates",
    method="get"
  ) %}
    <label class="input-pill">
      <span class="input-pill__label">Поиск</span>
      <input
        class="input-pill__control"
        type="search"
        name="search"
        value="{{ filters.search }}"
        placeholder="Поиск по ФИО или TG ID"
      >
    </label>
  {% endcall %}

  {% if analytics %}
    <section class="analytics-grid">
      <a class="metric-card" href="/candidates">
        <span class="metric-card__label">Всего кандидатов</span>
        <span class="metric-card__value">{{ analytics.total }}</span>
        <span class="metric-card__meta">Активны: {{ analytics.active }} • Отключены: {{ analytics.inactive }}</span>
      </a>
      <a class="metric-card" href="/candidates?stage=interviews">
        <span class="metric-card__label">Интервью</span>
        <span class="metric-card__value">{{ analytics.upcoming_interviews }}</span>
        <span class="metric-card__meta">В ожидании подтверждения: {{ analytics.awaiting_confirmation }} • Завершено: {{ analytics.completed_interviews }}</span>
      </a>
      <article class="metric-card">
        <span class="metric-card__label">Активность за 7 дней</span>
        <span class="metric-card__value">{{ analytics.tests_week }}</span>
        <span class="metric-card__meta">Тестов • Сообщений: {{ analytics.messages_week }}</span>
      </article>
      <a class="metric-card" href="/candidates?stage=alerts">
        <span class="metric-card__label">Нужно внимание</span>
        <span class="metric-card__value">{{ analytics.need_followup }}</span>
        <span class="metric-card__meta">Без сообщений: {{ analytics.need_followup }} • Без тестов: {{ analytics.no_tests }}</span>
      </a>
    </section>

    <section class="pipeline-board">
      <h2 class="section-title">Воронка интервью</h2>
      <div class="pipeline-grid">
        {% for stage in analytics.pipeline %}
          {% if stage.slug %}
            <a class="pipeline-item" href="/candidates?stage={{ stage.slug }}">
              <span>{{ stage.label }}</span>
              <strong>{{ stage.count }}</strong>
            </a>
          {% else %}
            <div class="pipeline-item">
              <span>{{ stage.label }}</span>
              <strong>{{ stage.count }}</strong>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </section>
  {% endif %}

  {% if items %}
    {% set columns = [
      {"label": "Кандидат"},
      {"label": "Telegram ID"},
      {"label": "Город"},
      {"label": "Последняя активность"},
      {"label": "Этап"},
      {"label": "Следующий шаг"},
      {"label": "Тесты"},
      {"label": "Последний результат"},
      {"label": "Сообщения"},
      {"label": "Карточка", "class": "col-actions"}
    ] %}
    {% call data_table(columns=columns, caption="Список кандидатов") %}
      {% for row in items %}
        {% set user = row.user %}
        {% set result = row.latest_result %}
        {% set message = row.latest_message %}
        <tr>
          <td>
            <div class="entity">
              <span class="entity__title">{{ user.fio }}</span>
              <span class="entity__meta">
                {% if user.is_active %}
                  <span class="badge badge--success">Активен</span>
                {% else %}
                  <span class="badge badge--muted">Отключен</span>
                {% endif %}
              </span>
            </div>
          </td>
          <td>{{ user.telegram_id }}</td>
          <td>{{ user.city or '—' }}</td>
          <td>{{ user.last_activity.strftime('%d.%m.%Y %H:%M') if user.last_activity else '—' }}</td>
          <td>
            <div class="stack">
              <span class="badge badge--soft">{{ row.stage }}</span>
              {% if row.latest_slot %}
                <span class="muted">{{ row.latest_slot.status|upper }} · {{ fmt_local(row.latest_slot.start_utc, row.latest_slot.candidate_tz or 'Europe/Moscow') }}</span>
              {% else %}
                <span class="muted">Нет слотов</span>
              {% endif %}
            </div>
          </td>
          <td>
            {% if row.next_action %}
              {{ row.next_action }}
            {% else %}
              <span class="muted">—</span>
            {% endif %}
          </td>
          <td>
            {% if row.tests_count %}
              {{ row.tests_count }}
            {% else %}
              <span class="muted">—</span>
            {% endif %}
          </td>
          <td>
            {% if result %}
              {{ result.final_score }} / {{ result.raw_score }}
            {% else %}
              <span class="muted">—</span>
            {% endif %}
          </td>
          <td>
            {% if message %}
              {{ message.message_text[:42] }}{% if message.message_text|length > 42 %}…{% endif %}
            {% else %}
              <span class="muted">—</span>
            {% endif %}
          </td>
          <td>
            <a class="btn btn-ghost btn-sm" href="/candidates/{{ user.id }}">Открыть</a>
          </td>
        </tr>
      {% endfor %}
    {% endcall %}
  {% else %}
    <div class="surface">
      <h2 class="section-title">Кандидатов пока нет</h2>
      <p class="section-hint">Добавьте кандидата вручную или пригласите через бота, чтобы начать работу.</p>
      <div class="page-actions">
        <a class="btn btn-primary" href="/candidates/new">Добавить кандидата</a>
      </div>
    </div>
  {% endif %}
{% endblock %}
