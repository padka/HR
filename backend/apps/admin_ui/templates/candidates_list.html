{% extends "base.html" %}
{% block title %}Кандидаты{% endblock %}
{% block content %}
  <section class="surface" aria-labelledby="candidates-title">
    <header class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
      <div>
        <h1 id="candidates-title" class="section-title">Кандидаты</h1>
      </div>
      <form class="flex w-full flex-col gap-3 md:w-auto md:flex-row md:items-center" method="get" action="/candidates">
        <label class="w-full md:w-64">
          <span class="sr-only">Поиск по ФИО или TG ID</span>
          <input
            class="input"
            type="search"
            name="search"
            value="{{ filters.search }}"
            placeholder="Поиск по ФИО или TG ID"
          >
        </label>
        <button class="btn btn-primary btn-sm" type="submit">Найти</button>
      </form>
    </header>

    {% if items %}
      <div class="table__wrap mt-6">
        <table class="table list-table" aria-describedby="candidates-title">
          <thead>
            <tr>
              <th scope="col">ФИО</th>
              <th scope="col">TG ID</th>
              <th scope="col">Город</th>
              <th scope="col">Последняя активность</th>
              <th scope="col">Этап</th>
              <th scope="col">Следующий шаг</th>
              <th scope="col">Тесты</th>
              <th scope="col">Последний результат</th>
              <th scope="col">Сообщения</th>
              <th scope="col">История</th>
              <th scope="col">Карточка</th>
            </tr>
          </thead>
          <tbody>
            {% for row in items %}
              {% set user = row.user %}
              {% set result = row.latest_result %}
              {% set message = row.latest_message %}
              <tr>
                <td data-label="ФИО">
                  <div class="flex flex-col gap-1">
                    <span class="font-semibold">{{ user.fio }}</span>
                    <span class="text-sm muted">
                      {% if user.is_active %}
                        Активен
                      {% else %}
                        Отключен
                      {% endif %}
                    </span>
                  </div>
                </td>
                <td data-label="TG ID">{{ user.telegram_id }}</td>
                <td data-label="Город">{{ user.city or '—' }}</td>
                <td data-label="Последняя активность">
                  {% if user.last_activity %}
                    {{ fmt_local(user.last_activity, 'Europe/Moscow') }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td data-label="Этап">
                  <div class="flex flex-col gap-1">
                    <span class="badge badge--soft">{{ row.stage }}</span>
                    {% if row.latest_slot %}
                      <span class="text-sm muted">
                        {{ (row.latest_slot.status or '')|upper }} · {{ fmt_local(row.latest_slot.start_utc, row.latest_slot.candidate_tz or 'Europe/Moscow') if row.latest_slot.start_utc else '—' }}
                      </span>
                    {% else %}
                      <span class="text-sm muted">Нет интервью</span>
                    {% endif %}
                  </div>
                </td>
                <td data-label="Следующий шаг">
                  {% if row.upcoming_slot and row.upcoming_slot.start_utc %}
                    Интервью {{ fmt_local(row.upcoming_slot.start_utc, row.upcoming_slot.candidate_tz or 'Europe/Moscow') }}
                  {% else %}
                    <span class="muted">—</span>
                  {% endif %}
                </td>
                <td data-label="Тесты">{{ row.tests_total or '—' }}</td>
                <td data-label="Последний результат">
                  {% if result %}
                    {{ result.final_score }} / {{ result.raw_score }}
                  {% else %}
                    <span class="muted">—</span>
                  {% endif %}
                </td>
                <td data-label="Сообщения">
                  {% if message %}
                    {{ message.message_text[:42] }}{% if message.message_text|length > 42 %}…{% endif %}
                  {% else %}
                    <span class="muted">—</span>
                  {% endif %}
                </td>
                <td data-label="История">
                  <a class="btn btn-soft btn-sm" href="/candidates/{{ user.id }}#history">История</a>
                </td>
                <td data-label="Карточка">
                  <a class="btn btn-primary btn-sm" href="/candidates/{{ user.id }}">Перейти</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="muted mt-6">Кандидатов пока нет — новые пользователи появятся после регистрации в боте.</p>
    {% endif %}
  </section>
{% endblock %}
