{% extends "base.html" %}
{% block title %}Кандидаты{% endblock %}
{% block content %}
  <section class="space-y-8">
    <header class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
      <div class="space-y-1">
        <h1 class="text-2xl font-semibold tracking-tight text-slate-900 dark:text-slate-50">Кандидаты</h1>
        <p class="text-sm text-slate-600 dark:text-slate-400">Поиск по базе и быстрый доступ к профилю кандидата.</p>
      </div>
      <form class="flex w-full flex-col gap-2 sm:w-auto sm:flex-row sm:items-center sm:gap-3" method="get" action="/candidates">
        <label class="flex w-full items-center gap-3">
          <span class="sr-only">Поиск по ФИО или TG ID</span>
          <input
            class="w-full rounded-xl border border-slate-200 bg-white/80 px-4 py-2.5 text-sm text-slate-900 shadow-sm outline-none transition focus:border-sky-400 focus:ring-2 focus:ring-sky-200 dark:border-slate-700 dark:bg-slate-800/80 dark:text-slate-100 dark:focus:border-sky-500 dark:focus:ring-sky-500/40"
            type="search"
            name="search"
            value="{{ filters.search }}"
            placeholder="Поиск по ФИО или TG ID"
          >
        </label>
        <button class="inline-flex items-center justify-center rounded-full bg-sky-600 px-5 py-2 text-sm font-semibold text-white shadow focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-500 dark:bg-sky-500" type="submit">
          Найти
        </button>
      </form>
    </header>

    {% if items %}
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-200 text-sm leading-6 dark:divide-slate-700">
          <thead class="bg-slate-50/70 text-left text-xs font-semibold uppercase tracking-wide text-slate-600 dark:bg-slate-800/70 dark:text-slate-300">
            <tr>
              <th scope="col" class="px-4 py-3.5">ФИО</th>
              <th scope="col" class="px-4 py-3.5">TG ID</th>
              <th scope="col" class="px-4 py-3.5">Город</th>
              <th scope="col" class="px-4 py-3.5">Последняя активность</th>
              <th scope="col" class="px-4 py-3.5">Этап</th>
              <th scope="col" class="px-4 py-3.5">Следующий шаг</th>
              <th scope="col" class="px-4 py-3.5">Тесты</th>
              <th scope="col" class="px-4 py-3.5">Последний результат</th>
              <th scope="col" class="px-4 py-3.5">Сообщения</th>
              <th scope="col" class="px-4 py-3.5">История</th>
              <th scope="col" class="px-4 py-3.5">Карточка</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100 bg-white/70 text-slate-700 dark:divide-slate-800 dark:bg-slate-900/60 dark:text-slate-200">
            {% for row in items %}
              {% set user = row.user %}
              {% set result = row.latest_result %}
              {% set message = row.latest_message %}
              <tr class="transition hover:bg-sky-50/50 dark:hover:bg-slate-800/60">
                <td class="px-4 py-3.5">
                  <div class="flex flex-col gap-1">
                    <span class="font-medium text-slate-900 dark:text-slate-50">{{ user.fio }}</span>
                    <span class="text-xs font-medium text-slate-500 dark:text-slate-400">
                      {% if user.is_active %}
                        Активен
                      {% else %}
                        Отключен
                      {% endif %}
                    </span>
                  </div>
                </td>
                <td class="px-4 py-3.5 text-slate-600 dark:text-slate-300">{{ user.telegram_id }}</td>
                <td class="px-4 py-3.5">{{ user.city or '—' }}</td>
                <td class="px-4 py-3.5">
                  {% if user.last_activity %}
                    {{ fmt_local(user.last_activity, 'Europe/Moscow') }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td class="px-4 py-3.5">
                  <div class="flex flex-col gap-1">
                    <span class="inline-flex w-fit rounded-full border border-slate-200 px-2 py-1 text-xs font-semibold uppercase tracking-wide text-slate-600 dark:border-slate-600 dark:text-slate-300">{{ row.stage }}</span>
                    {% if row.latest_slot %}
                      <span class="text-xs text-slate-500 dark:text-slate-400">
                        {{ (row.latest_slot.status or '')|upper }} · {{ fmt_local(row.latest_slot.start_utc, row.latest_slot.candidate_tz or 'Europe/Moscow') if row.latest_slot.start_utc else '—' }}
                      </span>
                    {% else %}
                      <span class="text-xs text-slate-500 dark:text-slate-400">Нет интервью</span>
                    {% endif %}
                  </div>
                </td>
                <td class="px-4 py-3.5">
                  {% if row.upcoming_slot and row.upcoming_slot.start_utc %}
                    Интервью {{ fmt_local(row.upcoming_slot.start_utc, row.upcoming_slot.candidate_tz or 'Europe/Moscow') }}
                  {% else %}
                    <span class="text-slate-400 dark:text-slate-500">—</span>
                  {% endif %}
                </td>
                <td class="px-4 py-3.5">{{ row.tests_total or '—' }}</td>
                <td class="px-4 py-3.5">
                  {% if result %}
                    {{ result.final_score }} / {{ result.raw_score }}
                  {% else %}
                    <span class="text-slate-400 dark:text-slate-500">—</span>
                  {% endif %}
                </td>
                <td class="px-4 py-3.5">
                  {% if message %}
                    {{ message.message_text[:42] }}{% if message.message_text|length > 42 %}…{% endif %}
                  {% else %}
                    <span class="text-slate-400 dark:text-slate-500">—</span>
                  {% endif %}
                </td>
                <td class="px-4 py-3.5">
                  <a class="inline-flex items-center justify-center rounded-full border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-700 transition hover:border-sky-400 hover:text-sky-600 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-500 dark:border-slate-600 dark:text-slate-200 dark:hover:border-sky-500 dark:hover:text-sky-400" href="/candidates/{{ user.id }}#history">История</a>
                </td>
                <td class="px-4 py-3.5">
                  <a class="inline-flex items-center justify-center rounded-full bg-slate-900 px-4 py-1.5 text-xs font-semibold text-white shadow-sm transition hover:bg-slate-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-600 dark:bg-slate-100 dark:text-slate-900 dark:hover:bg-slate-300" href="/candidates/{{ user.id }}">Перейти</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="rounded-2xl border border-dashed border-slate-200 bg-white/70 p-8 text-center text-slate-500 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-400">
        Кандидатов пока нет — новые пользователи появятся после регистрации в боте.
      </div>
    {% endif %}
  </section>
{% endblock %}
