{% extends "base.html" %}
{% import "partials/form_shell.html" as forms %}
{% block title %}Шаблон #{{ tmpl.id }}{% endblock %}
{% block content %}
{% call forms.shell(
  title="Редактирование шаблона",
  description="Обновите текст и назначение шаблона.",
  form_id="tmplForm",
  action="/templates/{{ tmpl.id }}/update",
  autocomplete="off",
  back_href="/templates",
  back_label="К списку шаблонов",
  meta=['ID #' ~ tmpl.id, 'Ключ ' ~ tmpl.key],
  actions=[
    {"type": "submit", "text": "Сохранить", "variant": "primary"},
    {"href": "/templates", "text": "Отмена", "variant": "ghost"}
  ]
) %}
  {% call forms.section("Назначение") %}
    {% call forms.field("Глобальный шаблон", hint="Если включено — используется по умолчанию для всех городов") %}
      <label class="badge">
        <input type="checkbox" id="is_global" name="is_global" value="1" {% if tmpl.is_global or (tmpl.city_id is none) %}checked{% endif %}>
        Глобальный (без привязки к городу)
      </label>
    {% endcall %}

    {% call forms.field("Город") %}
      <select id="city_id" name="city_id" {% if tmpl.is_global or (tmpl.city_id is none) %}disabled{% else %}required{% endif %}>
        {% for c in cities %}
          <option value="{{ c.id }}" {% if c.id == tmpl.city_id %}selected{% endif %}>{{ c.name }} ({{ c.tz or "Europe/Moscow" }})</option>
        {% endfor %}
      </select>
      <span class="form-field__hint">Для глобального шаблона город не нужен.</span>
    {% endcall %}

    {% call forms.field("Ключ", hint="Ключ используют бот и админка для поиска нужного сообщения") %}
      <input id="key" type="text" name="key" required value="{{ tmpl.key }}" placeholder="например: intro, confirm_2h, reminder_1h" list="key_suggestions">
      <datalist id="key_suggestions">
        <option value="invite_interview"></option>
        <option value="confirm_2h"></option>
        <option value="reminder_1h"></option>
        <option value="after_meeting"></option>
        <option value="followup_missed"></option>
        <option value="slot_rejected"></option>
      </datalist>
    {% endcall %}
  {% endcall %}

  {% call forms.section("Содержимое сообщения") %}
    <div class="hint">Поддерживаются плейсхолдеры: имя, город, дата/время, контакты.</div>
    {% call forms.field("Текст") %}
      <textarea id="text" name="text" rows="14" required class="mt-sm text-mono">{{ tmpl.text_field }}</textarea>
      <div class="hint mt-sm">Вставить плейсхолдер:</div>
      <div class="btn-group">
        {% raw %}
        <button class="btn btn--ghost btn--sm" type="button" data-role="insert-var" data-insert="{{candidate_fio}}">{{candidate_fio}}</button>
        <button class="btn btn--ghost btn--sm" type="button" data-role="insert-var" data-insert="{{city_name}}">{{city_name}}</button>
        <button class="btn btn--ghost btn--sm" type="button" data-role="insert-var" data-insert="{{slot_date_local}}">{{slot_date_local}}</button>
        <button class="btn btn--ghost btn--sm" type="button" data-role="insert-var" data-insert="{{slot_time_local}}">{{slot_time_local}}</button>
        <button class="btn btn--ghost btn--sm" type="button" data-role="insert-var" data-insert="{{recruiter_name}}">{{recruiter_name}}</button>
        <button class="btn btn--ghost btn--sm" type="button" data-role="insert-var" data-insert="{{recruiter_phone}}">{{recruiter_phone}}</button>
        <button class="btn btn--ghost btn--sm" type="button" data-role="insert-var" data-insert="{{address}}">{{address}}</button>
        <button class="btn btn--ghost btn--sm" type="button" data-role="insert-var" data-insert="{{whatsapp_link}}">{{whatsapp_link}}</button>
        {% endraw %}
      </div>
      <div class="form-field__meta mt-sm">
        <span class="badge" data-overflow="false"><span id="char_count">0</span> символов</span>
        <span class="hint">Предпросмотр ниже. ⌘/Ctrl+S — сохранить.</span>
      </div>
    {% endcall %}

    <details class="form-advanced mt-md">
      <summary class="hint">Предпросмотр</summary>
      <div class="form-shell__grid form-shell__grid--three mt-sm">
        <label class="form-field">
          <span class="form-field__label">Имя</span>
          <input id="pv_fio" type="text" value="Иван Иванов">
        </label>
        <label class="form-field">
          <span class="form-field__label">Город</span>
          <input id="pv_city" type="text" value="Москва">
        </label>
        <label class="form-field">
          <span class="form-field__label">Дата</span>
          <input id="pv_date" type="text" value="21.09">
        </label>
        <label class="form-field">
          <span class="form-field__label">Время</span>
          <input id="pv_time" type="text" value="10:30">
        </label>
        <label class="form-field">
          <span class="form-field__label">Рекрутёр</span>
          <input id="pv_rec" type="text" value="Михаил">
        </label>
        <label class="form-field">
          <span class="form-field__label">Телефон</span>
          <input id="pv_phone" type="text" value="+7 (900) 000-00-00">
        </label>
        <label class="form-field">
          <span class="form-field__label">Адрес</span>
          <input id="pv_addr" type="text" value="ул. Пушкина, 10">
        </label>
        <label class="form-field">
          <span class="form-field__label">WhatsApp</span>
          <input id="pv_wa" type="text" value="https://wa.me/79000000000">
        </label>
      </div>
      <div id="preview" class="preview-panel mt-sm" aria-live="polite"></div>
    </details>
  {% endcall %}
{% endcall %}

<div class="surface glass grain alert alert--danger mt-md">
  <h2 class="form-shell__section-title">Опасная зона</h2>
  <p class="form-shell__section-hint">Удаление шаблона безвозвратно.</p>
  <form method="post" action="/templates/{{ tmpl.id }}/delete" onsubmit="return confirm('Удалить шаблон безвозвратно?');" class="mt-sm">
    <button type="submit" class="btn btn--danger">Удалить шаблон</button>
  </form>
</div>

<script type="module">
import { initTemplateEditor } from "/static/js/modules/template-editor.js";

initTemplateEditor({
  formId: 'tmplForm',
  textareaId: 'text',
  counterId: 'char_count',
  previewId: 'preview',
  placeholderSelector: '[data-role="insert-var"]',
  keyInputId: 'key',
  isGlobalCheckboxId: 'is_global',
  citySelectId: 'city_id',
  charLimit: 4096,
  submitHotkey: { key: 's', ctrlOrMeta: true }
});
</script>
{% endblock %}
