{% extends "base.html" %}
{% block title %}–®–∞–±–ª–æ–Ω #{{ tmpl.id }}{% endblock %}
{% block content %}
<h3 style="margin-top:0;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ <span class="badge">#{{ tmpl.id }}</span></h3>

<div class="card glass">
  <form method="post" action="/templates/{{ tmpl.id }}/update" autocomplete="off" id="tmplForm">
    <!-- –¢–∏–ø —à–∞–±–ª–æ–Ω–∞ -->
    <div class="field" style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
      <input type="checkbox" id="is_global" name="is_global" value="1"
             {% if tmpl.is_global or (tmpl.city_id is none) %}checked{% endif %}>
      <label for="is_global" style="margin:0;">–ì–ª–æ–±–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω (–±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –≥–æ—Ä–æ–¥—É)</label>
      <span class="badge">–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–æ–≤</span>
    </div>

    <!-- –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –≥–æ—Ä–æ–¥—É -->
    <div class="field">
      <label for="city_id">–ì–æ—Ä–æ–¥</label>
      <select id="city_id" name="city_id" {% if tmpl.is_global or (tmpl.city_id is none) %}disabled{% endif %} {% if not (tmpl.is_global or (tmpl.city_id is none)) %}required{% endif %}>
        {% for c in cities %}
          <option value="{{ c.id }}" {% if c.id == tmpl.city_id %}selected{% endif %}>
            {{ c.name }} ({{ c.tz or "Europe/Moscow" }})
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- –ö–ª—é—á -->
    <div class="field" style="margin-top:12px;">
      <label for="key">–ö–ª—é—á</label>
      <input id="key" type="text" name="key" required value="{{ tmpl.key }}"
             placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: intro, confirm_2h, reminder_1h" list="key_suggestions">
      <datalist id="key_suggestions">
        <option value="invite_interview"></option>
        <option value="confirm_2h"></option>
        <option value="reminder_1h"></option>
        <option value="after_meeting"></option>
        <option value="followup_missed"></option>
        <option value="slot_rejected"></option>
      </datalist>
      <p class="muted" style="margin:6px 0 0;">–ö–ª—é—á –∏—Å–ø–æ–ª—å–∑—É—é—Ç –±–æ—Ç –∏ –∞–¥–º–∏–Ω–∫–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω—É–∂–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.</p>
    </div>

    <!-- –ë—ã—Å—Ç—Ä—ã–µ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã -->
    <div class="field" style="margin-top:10px;">
      <div class="muted" style="margin-bottom:6px;">–í—Å—Ç–∞–≤–∏—Ç—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä:</div>
      <div style="display:flex; gap:6px; flex-wrap:wrap;">
        {% raw %}
        <button class="btn ph" type="button" data-ph="{{candidate_fio}}">{{candidate_fio}}</button>
        <button class="btn ph" type="button" data-ph="{{city_name}}">{{city_name}}</button>
        <button class="btn ph" type="button" data-ph="{{slot_date_local}}">{{slot_date_local}}</button>
        <button class="btn ph" type="button" data-ph="{{slot_time_local}}">{{slot_time_local}}</button>
        <button class="btn ph" type="button" data-ph="{{recruiter_name}}">{{recruiter_name}}</button>
        <button class="btn ph" type="button" data-ph="{{recruiter_phone}}">{{recruiter_phone}}</button>
        <button class="btn ph" type="button" data-ph="{{address}}">{{address}}</button>
        <button class="btn ph" type="button" data-ph="{{whatsapp_link}}">{{whatsapp_link}}</button>
        {% endraw %}
      </div>
    </div>

    <!-- –¢–µ–∫—Å—Ç —à–∞–±–ª–æ–Ω–∞ -->
    <div class="field" style="margin-top:12px;">
      <label for="text">–¢–µ–∫—Å—Ç —à–∞–±–ª–æ–Ω–∞</label>
      <textarea id="text" name="text" rows="14" required style="width:100%; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;">{{ tmpl.text_field }}</textarea>
      <p class="muted" style="margin:6px 0 0;">
        –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã:
        {% raw %}
        <code>{{candidate_fio}}</code>, <code>{{city_name}}</code>, <code>{{slot_date_local}}</code>, <code>{{slot_time_local}}</code>, <code>{{recruiter_name}}</code>, <code>{{recruiter_phone}}</code>, <code>{{address}}</code>, <code>{{whatsapp_link}}</code>
        {% endraw %}
      </p>
      <div style="display:flex; align-items:center; gap:10px; margin-top:6px;">
        <span class="badge"><span id="char_count">0</span> —Å–∏–º–≤–æ–ª–æ–≤</span>
        <span class="muted">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–∏–∂–µ. ‚åò/Ctrl+S ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å.</span>
      </div>
    </div>

    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä + –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π -->
    <details style="margin-top:2px;">
      <summary class="badge" style="cursor:pointer;">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</summary>
      <div class="glass" style="padding:12px; margin-top:8px;">
        <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:8px; margin-bottom:8px;">
          <div><label class="muted">–ò–º—è</label><input id="pv_fio" type="text" value="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"></div>
          <div><label class="muted">–ì–æ—Ä–æ–¥</label><input id="pv_city" type="text" value="–ú–æ—Å–∫–≤–∞"></div>
          <div><label class="muted">–î–∞—Ç–∞</label><input id="pv_date" type="text" value="21.09"></div>
          <div><label class="muted">–í—Ä–µ–º—è</label><input id="pv_time" type="text" value="10:30"></div>
          <div><label class="muted">–†–µ–∫—Ä—É—Ç—ë—Ä</label><input id="pv_rec" type="text" value="–ú–∏—Ö–∞–∏–ª"></div>
          <div><label class="muted">–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="pv_phone" type="text" value="+7 (900) 000-00-00"></div>
          <div><label class="muted">–ê–¥—Ä–µ—Å</label><input id="pv_addr" type="text" value="—É–ª. –ü—É—à–∫–∏–Ω–∞, 10"></div>
          <div><label class="muted">WhatsApp</label><input id="pv_wa" type="text" value="https://wa.me/79000000000"></div>
        </div>
        <div id="preview" style="white-space:pre-wrap; overflow-wrap:anywhere;"></div>
      </div>
    </details>

    <!-- –ö–Ω–æ–ø–∫–∏ -->
    <div style="margin-top:16px; display:flex; gap:8px; align-items:center;">
      <button type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <a class="btn" href="/templates">–û—Ç–º–µ–Ω–∞</a>
    </div>
  </form>
</div>

<div class="card glass" style="margin-top:14px;">
  <h4 style="margin:0 0 8px 0;">–û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</h4>
  <form method="post" action="/templates/{{ tmpl.id }}/delete" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ?');">
    <button type="submit" style="border-color: var(--bad); color: var(--bad);">–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
  </form>
</div>

<script>
(function(){
  // –¢–æ–≥–≥–ª "–ì–ª–æ–±–∞–ª—å–Ω—ã–π" ‚Üî –≥–æ—Ä–æ–¥
  const chk = document.getElementById('is_global');
  const sel = document.getElementById('city_id');
  function syncCityState() {
    const g = chk && chk.checked;
    if (!sel) return;
    sel.disabled = g;
    if (g) sel.removeAttribute('required');
    else sel.setAttribute('required', '');
  }
  chk && chk.addEventListener('change', syncCityState);
  syncCityState();

  // –í—Å—Ç–∞–≤–∫–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞ –ø–æ –∫–ª–∏–∫—É
  function insertAtCursor(input, text) {
    const start = input.selectionStart ?? input.value.length;
    const end = input.selectionEnd ?? input.value.length;
    const before = input.value.slice(0, start);
    const after  = input.value.slice(end);
    input.value = before + text + after;
    const pos = start + text.length;
    input.selectionStart = input.selectionEnd = pos;
    input.focus();
    input.dispatchEvent(new Event('input', {bubbles:true}));
  }
  const ta = document.getElementById('text');
  document.querySelectorAll('.btn.ph').forEach(btn => {
    btn.addEventListener('click', () => {
      if (!ta) return;
      insertAtCursor(ta, btn.getAttribute('data-ph') || '');
    });
  });

  // –õ—ë–≥–∫–∏–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ —Å—á—ë—Ç—á–∏–∫
  const cnt = document.getElementById('char_count');
  const prev = document.getElementById('preview');
  const esc = (s) => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  function renderPreview() {
    if (!ta || !prev) return;
    let tpl = ta.value || '';
    const map = {
      '{{candidate_fio}}': document.getElementById('pv_fio')?.value || '',
      '{{city_name}}': document.getElementById('pv_city')?.value || '',
      '{{slot_date_local}}': document.getElementById('pv_date')?.value || '',
      '{{slot_time_local}}': document.getElementById('pv_time')?.value || '',
      '{{recruiter_name}}': document.getElementById('pv_rec')?.value || '',
      '{{recruiter_phone}}': document.getElementById('pv_phone')?.value || '',
      '{{address}}': document.getElementById('pv_addr')?.value || '',
      '{{whatsapp_link}}': document.getElementById('pv_wa')?.value || '',
    };
    for (const k in map) {
      const val = map[k];
      tpl = tpl.split(k).join(val);
    }
    prev.innerHTML = esc(tpl).replace(/\n/g,'<br>');
  }

  function updateMeta() {
    cnt && (cnt.textContent = String(ta.value.length));
    renderPreview();
  }

  ta && ta.addEventListener('input', updateMeta);
  ['pv_fio','pv_city','pv_date','pv_time','pv_rec','pv_phone','pv_addr','pv_wa']
    .forEach(id => document.getElementById(id)?.addEventListener('input', renderPreview));

  updateMeta();

  // Ctrl/Cmd+S -> submit
  const form = document.getElementById('tmplForm');
  window.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 's') {
      e.preventDefault();
      form?.requestSubmit();
    }
  });
})();
</script>
{% endblock %}