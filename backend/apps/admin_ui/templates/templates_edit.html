{% extends "base.html" %}
{% import "partials/form_shell.html" as forms %}
{% block title %}Шаблон #{{ tmpl.id }}{% endblock %}
{% block content %}
{% call forms.shell(
  title="Редактирование шаблона",
  description="Обновите текст и назначение шаблона.",
  form_id="tmplForm",
  action='/templates/' ~ tmpl.id ~ '/update',
  autocomplete="off",
  back_href="/templates",
  back_label="К списку шаблонов",
  meta=['ID #' ~ tmpl.id, 'Ключ ' ~ tmpl.key],
  actions=[
    {"type": "submit", "text": "Сохранить", "variant": "primary"},
    {"href": "/templates", "text": "Отмена", "variant": "ghost"}
  ]
) %}
  {% if errors %}
    <div class="alert alert--danger mt-sm">
      <ul>
        {% for err in errors %}
          <li>{{ err }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
  {% call forms.section("Назначение") %}
    {% call forms.field("Глобальный шаблон", hint="Если включено — используется по умолчанию для всех городов") %}
      {{ forms.switch(
        id='is_global',
        name='is_global',
        value='1',
        checked=tmpl.is_global or (tmpl.city_id is none),
        label='Глобальный (без привязки к городу)'
      ) }}
    {% endcall %}

    {% call forms.field("Город", hint="Для глобального шаблона город не нужен.") %}
      <select id="city_id" name="city_id" {% if tmpl.is_global or (tmpl.city_id is none) %}disabled{% else %}required{% endif %}>
        {% for c in cities %}
          <option value="{{ c.id }}" {% if c.id == tmpl.city_id %}selected{% endif %}>{{ c.name }} ({{ c.tz or "Europe/Moscow" }})</option>
        {% endfor %}
      </select>
    {% endcall %}

    {% call forms.field("Ключ", hint="Ключ используют бот и админка для поиска нужного сообщения") %}
      <input id="key" type="text" name="key" required value="{{ tmpl.key }}" placeholder="например: intro, confirm_2h, reminder_1h" list="key_suggestions">
      <datalist id="key_suggestions">
        <option value="invite_interview"></option>
        <option value="confirm_2h"></option>
        <option value="reminder_1h"></option>
        <option value="after_meeting"></option>
        <option value="followup_missed"></option>
        <option value="slot_rejected"></option>
      </datalist>
    {% endcall %}
  {% endcall %}

  {% call forms.section("Содержимое сообщения", span='full') %}
    {% call forms.note() %}Поддерживаются плейсхолдеры: имя, город, дата/время, контакты.{% endcall %}
    {% call forms.field("Текст") %}
      <textarea id="text" name="text" rows="14" required class="text-mono">{{ tmpl.text_field }}</textarea>
      {% call forms.note() %}Вставить плейсхолдер:{% endcall %}
      <div class="btn-group">
        {% raw %}
        <button class="btn btn--ghost btn--sm" type="button" data-role="insert-var" data-insert="{{candidate_fio}}">{{candidate_fio}}</button>
        <button class="btn btn--ghost btn--sm" type="button" data-role="insert-var" data-insert="{{city_name}}">{{city_name}}</button>
        <button class="btn btn--ghost btn--sm" type="button" data-role="insert-var" data-insert="{{slot_date_local}}">{{slot_date_local}}</button>
        <button class="btn btn--ghost btn--sm" type="button" data-role="insert-var" data-insert="{{slot_time_local}}">{{slot_time_local}}</button>
        <button class="btn btn--ghost btn--sm" type="button" data-role="insert-var" data-insert="{{recruiter_name}}">{{recruiter_name}}</button>
        <button class="btn btn--ghost btn--sm" type="button" data-role="insert-var" data-insert="{{recruiter_phone}}">{{recruiter_phone}}</button>
        <button class="btn btn--ghost btn--sm" type="button" data-role="insert-var" data-insert="{{address}}">{{address}}</button>
        <button class="btn btn--ghost btn--sm" type="button" data-role="insert-var" data-insert="{{whatsapp_link}}">{{whatsapp_link}}</button>
        {% endraw %}
      </div>
      {% call forms.meta() %}
        <span class="badge" data-overflow="false"><span id="char_count">0</span> символов</span>
        {% call forms.note(inline=True) %}Предпросмотр ниже. ⌘/Ctrl+S — сохранить.{% endcall %}
      {% endcall %}
    {% endcall %}

    <details class="form-advanced mt-md">
      <summary class="hint">Предпросмотр</summary>
      <div class="form-grid form-grid--three mt-sm">
        {% call forms.field("Имя") %}
          <input id="pv_fio" type="text" value="Иван Иванов">
        {% endcall %}
        {% call forms.field("Город") %}
          <input id="pv_city" type="text" value="Москва">
        {% endcall %}
        {% call forms.field("Дата") %}
          <input id="pv_date" type="text" value="21.09">
        {% endcall %}
        {% call forms.field("Время") %}
          <input id="pv_time" type="text" value="10:30">
        {% endcall %}
        {% call forms.field("Рекрутёр") %}
          <input id="pv_rec" type="text" value="Михаил">
        {% endcall %}
        {% call forms.field("Телефон") %}
          <input id="pv_phone" type="text" value="+7 (900) 000-00-00">
        {% endcall %}
        {% call forms.field("Адрес") %}
          <input id="pv_addr" type="text" value="ул. Пушкина, 10">
        {% endcall %}
        {% call forms.field("WhatsApp") %}
          <input id="pv_wa" type="text" value="https://wa.me/79000000000">
        {% endcall %}
      </div>
      <div id="preview" class="preview-panel mt-sm" aria-live="polite"></div>
    </details>
  {% endcall %}
{% endcall %}

<div class="surface glass grain alert alert--danger mt-md">
  <h2 class="form-shell__section-title">Опасная зона</h2>
  <p class="form-shell__section-hint">Удаление шаблона безвозвратно.</p>
  <form method="post" action="/templates/{{ tmpl.id }}/delete" onsubmit="return confirm('Удалить шаблон безвозвратно?');" class="mt-sm">
    <button type="submit" class="btn btn--danger">Удалить шаблон</button>
  </form>
</div>

<script type="module">
import { initTemplateEditor } from "/static/js/modules/template-editor.js";

initTemplateEditor({
  formId: 'tmplForm',
  textareaId: 'text',
  counterId: 'char_count',
  previewId: 'preview',
  placeholderSelector: '[data-role="insert-var"]',
  keyInputId: 'key',
  isGlobalCheckboxId: 'is_global',
  citySelectId: 'city_id',
  charLimit: 4096,
  submitHotkey: { key: 's', ctrlOrMeta: true }
});
</script>
{% endblock %}
