"""Template helpers for bot messages."""

from __future__ import annotations

from typing import Any, Dict, Optional, Tuple

from backend.domain.repositories import get_template
from backend.domain.template_stages import STAGE_DEFAULTS

DEFAULT_TEMPLATES: Dict[str, str] = {
    # –û–±—â–∏–µ
    "choose_recruiter": (
        "üë§ <b>–í—ã–±–æ—Ä —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞</b>\n"
        "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–º—è –∫–æ–ª–ª–µ–≥–∏, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –æ–∫–Ω–∞."
    ),
    "slot_taken": "–°–ª–æ—Ç —É–∂–µ –∑–∞–Ω—è—Ç. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π:",
    "slot_sent": "–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.",
    "slot_reschedule": (
        "‚è≥ –†–µ–∫—Ä—É—Ç—ë—Ä –æ—Å–≤–æ–±–æ–¥–∏–ª –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ {dt}.\n"
        "–î–∞–≤–∞–π—Ç–µ –ø–æ–¥–±–µ—Ä—ë–º –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è –≤–º–µ—Å—Ç–µ."
    ),
    "manual_schedule_prompt": (
        "–°–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –≤ –≤–∞—à–µ–º –≥–æ—Ä–æ–¥–µ —Å–µ–π—á–∞—Å –Ω–µ—Ç.\n"
        "–ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∫–æ–≥–¥–∞ –≤–∞–º —É–¥–æ–±–Ω–æ, –∏ –º—ã –ø–æ—Å—Ç–∞—Ä–∞–µ–º—Å—è –≤—ã–¥–µ–ª–∏—Ç—å –≤—Ä–µ–º—è.\n"
        "–ß—Ç–æ–±—ã —É—Å–∫–æ—Ä–∏—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ, –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –¥–∏–∞–ø–∞–∑–æ–Ω –≤—Ä–µ–º–µ–Ω–∏, –∫–æ–≥–¥–∞ –≤–∞–º —É–¥–æ–±–Ω–æ –ø—Ä–æ–π—Ç–∏ –æ–Ω–ª–∞–π–Ω —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ. "
        "–ù–∞–ø—Ä–∏–º–µ—Ä: 25.07 12:00-16:00 –∏–ª–∏ –∑–∞–≤—Ç—Ä–∞ 10:00-13:00."
    ),
    "approved_msg": (
        "‚úÖ <b>–í—Å—Ç—Ä–µ—á–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</b>\n"
        "üóì {dt}\n"
        "–°—Å—ã–ª–∫–∞/–∞–¥—Ä–µ—Å –ø—Ä–∏–¥—É—Ç –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —è–≤–∫–∏ –∑–∞ 2 —á–∞—Å–∞."
    ),
    "existing_reservation": (
        "üôå –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –±—Ä–æ–Ω—å —É {recruiter_name} –Ω–∞ {dt}.\n"
        "–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è, –æ—Ç–º–µ–Ω–∏—Ç–µ —Ç–µ–∫—É—â—É—é –∑–∞–ø–∏—Å—å –∏–ª–∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è."
    ),
    "reminder_2h": "–ß–µ—Ä–µ–∑ 2 —á–∞—Å–∞ —Å—Ç–∞—Ä—Ç—É–µ–º. –í—Å—Ç—Ä–µ—á–∞–µ–º—Å—è {slot_datetime_local}.",
    "reminder_30m": "–°—Ç–∞—Ä—Ç —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç! –ì–æ—Ç–æ–≤—å—Ç–µ—Å—å –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ {slot_time_local}.",
    "confirm_6h": (
        "‚è∞ –°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è –≤ {slot_datetime_local}.\n"
        "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É—á–∞—Å—Ç–∏–µ, —á—Ç–æ–±—ã –º—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ –≤—Å—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ."
    ),
    "confirm_2h": (
        "‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞ ‚Äî {dt_local}.\n"
        "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É—á–∞—Å—Ç–∏–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞. –°—Å—ã–ª–∫–∞ –ø—Ä–∏–¥—ë—Ç –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è."
    ),
    "att_confirmed_link": "üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–¢–µ–ª–µ–º–æ—Å—Ç: {link}\n–í—Å—Ç—Ä–µ—á–∞–µ–º—Å—è {dt}",
    "att_declined": "–ü–æ–Ω–∏–º–∞—é. –î–∞–≤–∞–π—Ç–µ –ø–æ–¥–±–µ—Ä—ë–º –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è.",
    "att_confirmed_ack": "–°–ø–∞—Å–∏–±–æ, –±—É–¥–µ–º –≤–∞—Å –∂–¥–∞—Ç—å!",
    "result_fail": (
        "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤—Ä–µ–º—è! –ù–∞ —Ç–µ–∫—É—â–µ–º —ç—Ç–∞–ø–µ –º—ã –Ω–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å.\n"
        "–ú—ã —Å–æ—Ö—Ä–∞–Ω–∏–º –≤–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏ —Å–≤—è–∂–µ–º—Å—è –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ä–æ–ª–µ–π."
    ),
    "intro_day_invitation": (
        "–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–ª–∏ –≤–∏–¥–µ–æ–∏–Ω—Ç–µ—Ä–≤—å—é –≤ –∫–æ–º–ø–∞–Ω–∏—é <b>SMART</b>! üéâ\n\n"
        "–í—Å—Ç—Ä–µ—á–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –Ω–∞ <b>{slot_datetime_local}</b>.\n"
        "üìç –ê–¥—Ä–µ—Å: <b>{intro_address}</b>\n\n"
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏—Ö–æ–¥–∏—Ç–µ –≤ –ø—Ä–µ–∑–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ–º –≤–∏–¥–µ –∏ —Å –æ—Ç–ª–∏—á–Ω—ã–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º ‚Äî —ç—Ç–æ –Ω–µ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ, "
        "–∞ <b>–æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω—å</b> (~2 —á–∞—Å–∞).\n\n"
        "‚ú® <b>–ü—Ä–µ–∂–¥–µ –≤—Å–µ–≥–æ:</b>\n"
        "‚Ä¢ –ø—Ä–æ—è–≤–∏—Ç–µ —Å–µ–±—è ‚Äî –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤–∞–∂–Ω—ã;\n"
        "‚Ä¢ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —à–∞–Ω—Å –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∏ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É.\n\n"
        "üíº <b>–ö–æ–Ω—Ç–∞–∫—Ç —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è —Ä–µ–≥–∏–æ–Ω–∞:</b>\n"
        "{intro_contact}\n\n"
        "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É—á–∞—Å—Ç–∏–µ. –ï—Å–ª–∏ –ø–ª–∞–Ω—ã –º–µ–Ω—è—é—Ç—Å—è ‚Äî —Å–æ–æ–±—â–∏—Ç–µ –∑–∞—Ä–∞–Ω–µ–µ.\n\n"
        "–° —É–≤–∞–∂–µ–Ω–∏–µ–º,\n"
        "–®–µ–Ω—à–∏–Ω –ú–∏—Ö–∞–∏–ª –ê–ª–µ–∫—Å–µ–µ–≤–∏—á\n"
        "<b>–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å HR-–¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ SMART</b>"
    ),
    "intro_day_reminder": (
        "‚è∞ –ß–µ—Ä–µ–∑ 3 —á–∞—Å–∞ –Ω–∞—á–Ω—ë—Ç—Å—è –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω—å ({slot_datetime_local}). "
        "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É—á–∞—Å—Ç–∏–µ."
    ),

    # –¢–µ—Å—Ç 1
    "t1_intro": (
        "‚ú® <b>SMART: –º–∏–Ω–∏-–∞–Ω–∫–µ—Ç–∞</b>\n"
        "–û—Ç–≤–µ—Ç—å—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤ ‚Äî —ç—Ç–æ –∑–∞–π–º—ë—Ç 2‚Äì3 –º–∏–Ω—É—Ç—ã –∏ –ø–æ–º–æ–∂–µ—Ç –Ω–∞–∑–Ω–∞—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é."
    ),
    "t1_progress": "<i>–í–æ–ø—Ä–æ—Å {n}/{total}</i>",
    "t1_done": (
        "üéØ –°–ø–∞—Å–∏–±–æ! –ê–Ω–∫–µ—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞.\n"
        "–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞ –∏ –≤—Ä–µ–º—è –¥–ª—è –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –≤–∏–¥–µ–æ-–∏–Ω—Ç–µ—Ä–≤—å—é (15‚Äì20 –º–∏–Ω—É—Ç)."
    ),
    "t1_format_reject": (
        "–ü–æ–Ω–∏–º–∞—é, –≥–∏–±—Ä–∏–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–æ–∫–∞ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç.\n"
        "–ï—Å–ª–∏ –ø–ª–∞–Ω—ã –∏–∑–º–µ–Ω—è—Ç—Å—è ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ, –º—ã –±—É–¥–µ–º —Ä–∞–¥—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—â–µ–Ω–∏–µ."
    ),
    "t1_format_clarify": (
        "–§–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π: 70% –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –∏ 30% –≤ –æ—Ñ–∏—Å–µ.\n"
        "–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã –ø—Ä–æ–≤–æ–¥–∏–º —Ç–æ–ª—å–∫–æ face to face, –ø–æ—ç—Ç–æ–º—É –≥–∏–±–∫–∏–π –≥—Ä–∞—Ñ–∏–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."
    ),
    "t1_schedule_reject": (
        "–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ—Å—Ç—å! –ì—Ä–∞—Ñ–∏–∫ 5/2 —Å 9:00 –¥–æ 18:00 —Å–µ–π—á–∞—Å –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç.\n"
        "–°–æ—Ö—Ä–∞–Ω–∏–º –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏ –≤–µ—Ä–Ω—ë–º—Å—è, –∫–æ–≥–¥–∞ –ø–æ—è–≤—è—Ç—Å—è –≥–∏–±–∫–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏."
    ),

    # –¢–µ—Å—Ç 2
    "t2_intro": (
        "üìò <b>–û–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ—Å—Ç</b>\n"
        "–í–æ–ø—Ä–æ—Å–æ–≤: {qcount} ‚Ä¢ –õ–∏–º–∏—Ç: {timelimit} –º–∏–Ω/–≤–æ–ø—Ä–æ—Å ‚Ä¢ –ú–∞–∫—Å. –ø–æ–ø—ã—Ç–æ–∫: {attempts}\n"
        "–£—á–∏—Ç—ã–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –∏ —á–∏—Å–ª–æ –ø–æ–ø—ã—Ç–æ–∫."
    ),
    "t2_result": (
        "üéØ <b>–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç</b>\n\n"
        "‚ñ´Ô∏è <b>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:</b> {correct}\n"
        "‚ñ´Ô∏è <b>–ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª:</b> {score}\n"
        "‚ñ´Ô∏è <b>–£—Ä–æ–≤–µ–Ω—å:</b> {rating}"
    ),

    # –í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ (–ø–æ—Å–ª–µ –¢–µ—Å—Ç–∞ 2)
    "no_slots": (
        "–ü–æ–∫–∞ –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ —É –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∫—Ä—É—Ç—ë—Ä–∞.\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–≥–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
    ),
}

DEFAULT_TEMPLATES.update(STAGE_DEFAULTS)

_TEMPLATE_CACHE: Dict[Tuple[Optional[int], str], Optional[str]] = {}

__all__ = ["DEFAULT_TEMPLATES", "tpl", "clear_cache"]


async def _fetch_template(city_id: Optional[int], key: str) -> Optional[str]:
    """Return template text from DB (city specific or global)."""
    cache_key = (city_id, key)
    if cache_key in _TEMPLATE_CACHE:
        return _TEMPLATE_CACHE[cache_key]

    try:
        template = await get_template(city_id, key)
    except Exception:
        template = None
    if template is None:
        result = None
    if isinstance(template, str):
        result = template
    else:
        result = getattr(template, "text", None) or getattr(template, "content", None)

    _TEMPLATE_CACHE[cache_key] = result
    return result


async def tpl(city_id: Optional[int], key: str, **fmt: Any) -> str:
    text = await _fetch_template(city_id, key) or DEFAULT_TEMPLATES.get(key, "")
    if not fmt:
        return text
    try:
        return text.format(**fmt)
    except Exception:
        return text


def clear_cache() -> None:
    """Reset template cache."""
    _TEMPLATE_CACHE.clear()
