# Bugfix: –°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç —Å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–º –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –±–æ—Ç–∞ –≤–º–µ—Å—Ç–æ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

**–î–∞—Ç–∞:** 2025-11-05
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
**Severity:** Medium (UX issue –¥–ª—è —Ä–µ–∫—Ä—É—Ç–µ—Ä–æ–≤)

---

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### –°–∏–º–ø—Ç–æ–º—ã

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç —Å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–º –∏–∑ –∞–¥–º–∏–Ω–∫–∏ (–∫–Ω–æ–ø–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç"), —Ä–µ–∫—Ä—É—Ç–µ—Ä–∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–ª–æ **–≤ —á–∞—Ç —Å –±–æ—Ç–æ–º**, –∞ –Ω–µ –≤ **–ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–º**.

**–ü—Ä–∏–º–µ—Ä:**
```
–ê–¥–º–∏–Ω–∫–∞ ‚Üí –ö–∞–Ω–¥–∏–¥–∞—Ç ‚Üí [–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç]
         ‚Üì
   Telegram –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —á–∞—Ç —Å –ë–û–¢–û–ú ‚ùå
   –í–º–µ—Å—Ç–æ: —á–∞—Ç —Å –ö–ê–ù–î–ò–î–ê–¢–û–ú ‚úÖ
```

### –í–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–æ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–º –∏–∑ –∞–¥–º–∏–Ω–∫–∏
- ‚ùå –†–µ–∫—Ä—É—Ç–µ—Ä –≤—ã–Ω—É–∂–¥–µ–Ω –≤—Ä—É—á–Ω—É—é –∏—Å–∫–∞—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –≤ Telegram –ø–æ ID
- ‚ùå –¢–µ—Ä—è–µ—Ç—Å—è –≤—Ä–µ–º—è –ø—Ä–∏ —Ñ–æ—Ä—Å-–º–∞–∂–æ—Ä–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö

---

## –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞

–í —à–∞–±–ª–æ–Ω–µ `candidates_detail.html` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å —Å—Å—ã–ª–∫–∞:

```html
<a href="tg://user?id={{ user.telegram_id }}">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</a>
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ—Ç–æ–∫–æ–ª `tg://user?id=` –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç **–ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** –≤ Telegram, –Ω–æ **–Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç —á–∞—Ç** —Å –Ω–∏–º.

### –ü–æ—á–µ–º—É —ç—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

Telegram API –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
1. `tg://user?id={id}` - –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å, –Ω–æ –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç —á–∞—Ç
2. –î–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞ –Ω—É–∂–Ω–∞ —Å—Å—ã–ª–∫–∞ `https://t.me/{username}`
3. **Username –Ω–∏–≥–¥–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª—Å—è** –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### Sequence Diagram

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –†–µ–∫—Ä—É—Ç–µ—Ä‚îÇ                ‚îÇ  –ê–¥–º–∏–Ω–∫–∞ ‚îÇ                ‚îÇ Telegram ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ                          ‚îÇ                           ‚îÇ
     ‚îÇ  –ö–ª–∏–∫–∞–µ—Ç "–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç"   ‚îÇ                           ‚îÇ
     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                           ‚îÇ
     ‚îÇ                          ‚îÇ                           ‚îÇ
     ‚îÇ                          ‚îÇ  tg://user?id=123456789   ‚îÇ
     ‚îÇ                          ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
     ‚îÇ                          ‚îÇ                           ‚îÇ
     ‚îÇ                          ‚îÇ   –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –±–æ—Ç–∞  ‚îÇ
     ‚îÇ                          ‚îÇ       (–Ω–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞!) ‚ùå  ‚îÇ
     ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
     ‚îÇ                                                      ‚îÇ
```

---

## –†–µ—à–µ–Ω–∏–µ

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

**–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `username` –≤ —Ç–∞–±–ª–∏—Ü—É `users`:**

1. –°–æ—Ö—Ä–∞–Ω—è—Ç—å Telegram username –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É `https://t.me/{username}` –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞
3. –ï—Å–ª–∏ username –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ—è—Å–Ω–µ–Ω–∏–µ

### –ö–æ–¥ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

#### 1. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î (0020_add_user_username.py)

```python
def upgrade(conn: Connection) -> None:
    """Add username field to users table for direct Telegram chat links."""
    context = MigrationContext.configure(connection=conn)
    op = Operations(context)

    op.add_column(
        "users",
        sa.Column("username", sa.String(length=32), nullable=True)
    )
    op.create_index(
        op.f("ix_users_username"),
        "users",
        ["username"],
        unique=False
    )
```

#### 2. –ú–æ–¥–µ–ª—å User

**–§–∞–π–ª:** `backend/domain/candidates/models.py:27`

```python
class User(Base):
    __tablename__ = "users"

    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    telegram_id: Mapped[int] = mapped_column(BigInteger, unique=True, index=True, nullable=False)
    username: Mapped[Optional[str]] = mapped_column(String(32), index=True, nullable=True)  # ‚úÖ –ù–û–í–û–ï
    fio: Mapped[str] = mapped_column(String(160), nullable=False)
    # ...
```

#### 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ username –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

**–§–∞–π–ª:** `backend/apps/bot/handlers/common.py:30-31`

```python
@router.message(Command("start"))
async def cmd_start(message: Message) -> None:
    user = message.from_user
    # ...
    username = getattr(user, "username", None)  # ‚úÖ –ù–û–í–û–ï: –ø–æ–ª—É—á–∞–µ–º username
    await services.begin_interview(user_id, username=username)
```

**–§–∞–π–ª:** `backend/apps/bot/services.py:2421-2442`

```python
async def begin_interview(user_id: int, username: Optional[str] = None) -> None:
    state_manager = get_state_manager()
    await state_manager.set(
        user_id,
        State(
            flow="interview",
            # ...
            username=username or "",  # ‚úÖ –ù–û–í–û–ï: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ state
        ),
    )
    # ...
```

**–§–∞–π–ª:** `backend/apps/bot/services.py:3048-3053`

```python
# –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ Test 1
fio = state.get("fio") or f"TG {user_id}"
city_name = state.get("city_name") or ""
username = state.get("username") or None  # ‚úÖ –ù–û–í–û–ï: –±–µ—Ä–µ–º –∏–∑ state
candidate = await candidate_services.create_or_update_user(
    telegram_id=user_id,
    fio=fio,
    city=city_name,
    username=username,  # ‚úÖ –ù–û–í–û–ï: –ø–µ—Ä–µ–¥–∞–µ–º –≤ —Ñ—É–Ω–∫—Ü–∏—é
)
```

#### 4. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π create_or_update_user

**–§–∞–π–ª:** `backend/domain/candidates/services.py:12-41`

```python
async def create_or_update_user(
    telegram_id: int,
    fio: str,
    city: str,
    username: Optional[str] = None  # ‚úÖ –ù–û–í–û–ï: –ø—Ä–∏–Ω–∏–º–∞–µ–º username
) -> User:
    async with async_session() as session:
        result = await session.execute(
            select(User).where(User.telegram_id == telegram_id)
        )
        user = result.scalar_one_or_none()
        if user:
            user.fio = fio
            user.city = city
            user.last_activity = datetime.now(timezone.utc)
            # ‚úÖ –ù–û–í–û–ï: –æ–±–Ω–æ–≤–ª—è–µ–º username
            if username is not None:
                user.username = username
        else:
            user = User(
                telegram_id=telegram_id,
                username=username,  # ‚úÖ –ù–û–í–û–ï: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
                fio=fio,
                city=city,
                last_activity=datetime.now(timezone.utc),
            )
            session.add(user)
        await session.commit()
        await session.refresh(user)
        return user
```

#### 5. –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –≤ –∞–¥–º–∏–Ω–∫–µ

**–§–∞–π–ª:** `backend/apps/admin_ui/templates/candidates_detail.html:463-467`

**–ë–´–õ–û:**
```html
<a href="tg://user?id={{ user.telegram_id }}">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</a>
```

**–°–¢–ê–õ–û:**
```html
{% if user.username %}
<a class="btn btn-primary btn-xs"
   href="https://t.me/{{ user.username }}"
   target="_blank"
   style="margin-left: 8px;">
  –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç
</a>
{% else %}
<span style="margin-left: 8px; font-size: 0.85em; color: #666;">
  (–Ω–µ—Ç username)
</span>
{% endif %}
```

---

## –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ö–∞–Ω–¥–∏–¥–∞—Ç —Å username

```
1. –ö–∞–Ω–¥–∏–¥–∞—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞: /start
2. –ë–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç:
   - telegram_id: 123456789
   - username: "ivan_petrov" ‚úÖ

3. –ö–∞–Ω–¥–∏–¥–∞—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç –¢–µ—Å—Ç 1
4. –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ –ë–î:
   User(telegram_id=123456789, username="ivan_petrov")

5. –†–µ–∫—Ä—É—Ç–µ—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –≤ –∞–¥–º–∏–Ω–∫–µ
6. –í–∏–¥–∏—Ç —Å—Å—ã–ª–∫—É:
   [–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç] ‚Üí https://t.me/ivan_petrov

7. –ö–ª–∏–∫–∞–µ—Ç ‚Üí Telegram –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ª–∏—á–Ω—ã–π —á–∞—Ç —Å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–º ‚úÖ
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ö–∞–Ω–¥–∏–¥–∞—Ç –±–µ–∑ username

```
1. –ö–∞–Ω–¥–∏–¥–∞—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞: /start
2. –£ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –ù–ï–¢ @username –≤ Telegram
3. –ë–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç:
   - telegram_id: 987654321
   - username: None

4. –†–µ–∫—Ä—É—Ç–µ—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
5. –í–∏–¥–∏—Ç:
   Telegram ID: 987654321 (–Ω–µ—Ç username)

6. –†–µ–∫—Ä—É—Ç–µ—Ä –ù–ï –º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º ‚ö†Ô∏è
   (—ç—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Telegram API)
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –°—Ç–∞—Ä—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã (–¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)

```
1. –ö–∞–Ω–¥–∏–¥–∞—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è –î–û –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
2. –í –ë–î: username = NULL

3. –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å –±–æ—Ç–æ–º:
   - –ë–æ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç username –≤ state
   - create_or_update_user –æ–±–Ω–æ–≤–∏—Ç –ø–æ–ª–µ username

4. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Å—Å—ã–ª–∫–∞ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ
```

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–¢–µ—Å—Ç 1: –ù–æ–≤—ã–π –∫–∞–Ω–¥–∏–¥–∞—Ç —Å username**
1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π Telegram –∞–∫–∫–∞—É–Ω—Ç —Å @username
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞: /start
3. –ü—Ä–æ–π—Ç–∏ –¢–µ—Å—Ç 1
4. –†–µ–∫—Ä—É—Ç–µ—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –≤ –∞–¥–º–∏–Ω–∫–µ
5. ‚úÖ –ö–ª–∏–∫–∞–µ—Ç "–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç"
6. ‚úÖ Telegram –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ª–∏—á–Ω—ã–π —á–∞—Ç —Å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–º

**–¢–µ—Å—Ç 2: –ù–æ–≤—ã–π –∫–∞–Ω–¥–∏–¥–∞—Ç –±–µ–∑ username**
1. –°–æ–∑–¥–∞—Ç—å Telegram –∞–∫–∫–∞—É–Ω—Ç –ë–ï–ó @username
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞: /start
3. –ü—Ä–æ–π—Ç–∏ –¢–µ—Å—Ç 1
4. –†–µ–∫—Ä—É—Ç–µ—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å
5. ‚úÖ –í–∏–¥–∏—Ç "(–Ω–µ—Ç username)" –≤–º–µ—Å—Ç–æ –∫–Ω–æ–ø–∫–∏

**–¢–µ—Å—Ç 3: –°—Ç–∞—Ä—ã–π –∫–∞–Ω–¥–∏–¥–∞—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç username**
1. –í–∑—è—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ (username = NULL)
2. –ö–∞–Ω–¥–∏–¥–∞—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å –±–æ—Ç–æ–º (–ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î: username –¥–æ–ª–∂–µ–Ω –æ–±–Ω–æ–≤–∏—Ç—å—Å—è
4. –†–µ–∫—Ä—É—Ç–µ—Ä –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—Ñ–∏–ª—è
5. ‚úÖ –¢–µ–ø–µ—Ä—å –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç"

---

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

### Modified

1. **`backend/domain/candidates/models.py`**
   - –°—Ç—Ä–æ–∫–∞ 27: –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `username`

2. **`backend/domain/candidates/services.py`**
   - –°—Ç—Ä–æ–∫–∏ 12-41: `create_or_update_user` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç username

3. **`backend/apps/bot/services.py`**
   - –°—Ç—Ä–æ–∫–∞ 2421: `begin_interview` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç username
   - –°—Ç—Ä–æ–∫–∞ 2442: username —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ State
   - –°—Ç—Ä–æ–∫–∏ 3048-3053: username –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ create_or_update_user
   - –°—Ç—Ä–æ–∫–∏ 3266-3283: –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è Test 2

4. **`backend/apps/bot/handlers/common.py`**
   - –°—Ç—Ä–æ–∫–∏ 30-31: –ø–æ–ª—É—á–µ–Ω–∏–µ username –∏–∑ message.from_user

5. **`backend/apps/admin_ui/templates/candidates_detail.html`**
   - –°—Ç—Ä–æ–∫–∏ 463-467: —É—Å–ª–æ–≤–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç –∏–ª–∏ –ø–æ—è—Å–Ω–µ–Ω–∏–µ

### Added

6. **`backend/migrations/versions/0020_add_user_username.py`**
   - –ú–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è username + –∏–Ω–¥–µ–∫—Å

7. **`run_migrations.py`**
   - –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π

---

## Deployment Notes

### Breaking Changes
**–ù–µ—Ç** - –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.

### Database Changes
**–î–∞** - —Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏ 0020:

```bash
python run_migrations.py
```

–ò–ª–∏ —á–µ—Ä–µ–∑ runner:
```python
from backend.migrations.runner import upgrade_to_head
upgrade_to_head()
```

### Configuration Changes
**–ù–µ—Ç**

### Rollback Plan

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –ø—Ä–æ–±–ª–µ–º—ã:

```bash
git revert 08c86ec
```

–û—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é (–≤—Ä—É—á–Ω—É—é):
```sql
DROP INDEX ix_users_username;
ALTER TABLE users DROP COLUMN username;
DELETE FROM alembic_version WHERE version_num = '0020_add_user_username';
UPDATE alembic_version SET version_num = '0019_fix_notification_log_unique_index';
```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ–ª–µ —Å–æ–∑–¥–∞–Ω–æ
PRAGMA table_info(users);
-- –î–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å: username | VARCHAR(32) | 1 | NULL

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–µ–∫—Å
PRAGMA index_list(users);
-- –î–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å: ix_users_username
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å–∫–æ–ª—å–∫–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –∏–º–µ—é—Ç username
SELECT
  COUNT(*) AS total_users,
  COUNT(username) AS users_with_username,
  ROUND(COUNT(username) * 100.0 / COUNT(*), 2) AS percentage
FROM users;
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –î–ª—è –Ω–æ–≤—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤: username –∑–∞–ø–æ–ª–Ω–µ–Ω
- –î–ª—è —Å—Ç–∞—Ä—ã—Ö: –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è –ø—Ä–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏

### 3. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ù–æ–≤—ã–π –∫–∞–Ω–¥–∏–¥–∞—Ç —Å username
1. –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞
2. –ü—Ä–æ—Ö–æ–¥–∏—Ç –¢–µ—Å—Ç 1
3. –†–µ–∫—Ä—É—Ç–µ—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å
4. ‚úÖ –í–∏–¥–∏—Ç –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç"
5. ‚úÖ –ö–ª–∏–∫ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ª–∏—á–Ω—ã–π —á–∞—Ç —Å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–º

---

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ Known Issues

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 1: Telegram API

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –ª–∏—á–Ω—ã–π —á–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º **–ø–æ ID** –±–µ–∑ username.

**–û–±—Ö–æ–¥–Ω–æ–π –ø—É—Ç—å:** –ï—Å–ª–∏ —É –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –Ω–µ—Ç @username, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "(–Ω–µ—Ç username)" –∏ —Ä–µ–∫—Ä—É—Ç–µ—Ä –¥–æ–ª–∂–µ–Ω –∏—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤:**
```
"–î–ª—è –±—ã—Å—Ç—Ä–æ–π —Å–≤—è–∑–∏ —Å —Ä–µ–∫—Ä—É—Ç–µ—Ä–æ–º —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å @username –≤ Telegram:
–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å ‚Üí –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
```

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 2: –°—Ç–∞—Ä—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–∞–Ω–¥–∏–¥–∞—Ç—ã, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –î–û –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –Ω–µ –∏–º–µ—é—Ç username –≤ –ë–î.

**–†–µ—à–µ–Ω–∏–µ:** Username –æ–±–Ω–æ–≤–∏—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å –±–æ—Ç–æ–º.

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:** –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è username —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ Telegram Bot API).

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 3: –°–º–µ–Ω–∞ username

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç –∏–∑–º–µ–Ω–∏—Ç @username –≤ Telegram, —Å—Å—ã–ª–∫–∞ –≤ –∞–¥–º–∏–Ω–∫–µ –±—É–¥–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–µ–π.

**–†–µ—à–µ–Ω–∏–µ:** Username –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å –±–æ—Ç–æ–º (—Å–º. –∫–æ–¥ create_or_update_user).

**–ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** –ö–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç—É.

---

## Lessons Learned

### 1. Telegram URL schemes

- `tg://user?id={id}` - –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å, **–Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç —á–∞—Ç**
- `https://t.me/{username}` - –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ª–∏—á–Ω—ã–π —á–∞—Ç ‚úÖ
- –î–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞ –ø–æ ID –±–µ–∑ username - **–Ω–µ—Ç —Ä–µ—à–µ–Ω–∏—è**

### 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–•–æ—Ä–æ—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞:**
```python
# –°–æ—Ö—Ä–∞–Ω—è—Ç—å –í–°–ï –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—è –æ—Ç Telegram
user = User(
    telegram_id=tg_user.id,
    username=tg_user.username,        # ‚úÖ
    first_name=tg_user.first_name,    # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
    last_name=tg_user.last_name,      # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
    language_code=tg_user.language_code,  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
)
```

**–ü–ª–æ—Ö–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞:**
```python
# –°–æ—Ö—Ä–∞–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ ID
user = User(telegram_id=tg_user.id)  # ‚ùå –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–í–∞–∂–Ω–æ:** –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –∏–∑–º–µ–Ω—è–µ–º—ã–µ –ø–æ–ª—è (username, first_name, last_name).

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
```python
if username is not None:
    user.username = username  # ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏
```

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –±—É–¥—É—â–µ–µ

### Immediate
1. ‚úÖ –î–µ–ø–ª–æ–∏—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–Ω
2. ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å % –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ —Å username

### Short-term
1. üìã –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É –≤ –±–æ—Ç–µ: "–î–ª—è –±—ã—Å—Ç—Ä–æ–π —Å–≤—è–∑–∏ —Å–æ–∑–¥–∞–π—Ç–µ @username"
2. üìã –°–æ–∑–¥–∞—Ç—å –º–µ—Ç—Ä–∏–∫—É: % –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ —Å username
3. üìã –î–æ–±–∞–≤–∏—Ç—å –≤ –∞–¥–º–∏–Ω–∫—É –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–∫–∞–Ω–¥–∏–¥–∞—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø—Ä—è–º–æ–π —Å–≤—è–∑–∏"

### Long-term
1. üìã –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ deep link —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –¥–ª—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –±–µ–∑ username
2. üìã –î–æ–±–∞–≤–∏—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏ (email, —Ç–µ–ª–µ—Ñ–æ–Ω)
3. üìã –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å username –≤—Å–µ—Ö —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (batch job)

### Nice to have

**Feature:** –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ username —Å—Ç–∞—Ä—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤

```python
async def backfill_usernames_from_telegram_api():
    """–û–±–Ω–æ–≤–∏—Ç—å username –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ Telegram Bot API."""
    bot = get_bot()
    users = await get_all_users_without_username()

    for user in users:
        try:
            tg_user = await bot.get_chat(user.telegram_id)
            if tg_user.username:
                await update_user_username(user.id, tg_user.username)
                logger.info(f"Updated username for user {user.telegram_id}")
        except Exception as e:
            logger.warning(f"Failed to update user {user.telegram_id}: {e}")
```

---

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [BUGFIX_FORM_DUPLICATION.md](./BUGFIX_FORM_DUPLICATION.md) - –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–∫–µ—Ç –∏ Telegram —Å—Å—ã–ª–∫–∞ (–ø–µ—Ä–≤–∞—è –≤–µ—Ä—Å–∏—è)

---

## Commit Reference

**Commit:** `08c86ec`
**Title:** –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ username –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —á–∞—Ç —Å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–º
**Author:** Claude Code
**Date:** 2025-11-05

---

## Conclusion

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É**

–ü—Ä–æ–±–ª–µ–º–∞ —Å –æ—Ç–∫—Ä—ã—Ç–∏–µ–º —á–∞—Ç–∞ —Ä–µ—à–µ–Ω–∞:

1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ username –≤ –ë–î
2. ‚úÖ –ë–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç username –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
3. ‚úÖ –ê–¥–º–∏–Ω–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É `https://t.me/{username}`
4. ‚úÖ –î–ª—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –±–µ–∑ username –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—è—Å–Ω–µ–Ω–∏–µ
5. ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
6. ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –æ–±–µ—Å–ø–µ—á–µ–Ω–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –†–µ–∫—Ä—É—Ç–µ—Ä –º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å –ª–∏—á–Ω—ã–π —á–∞—Ç —Å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–º –∏–∑ –∞–¥–º–∏–Ω–∫–∏ –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º! üéâ

---

**–ü–æ–¥–≥–æ—Ç–æ–≤–∏–ª:** Claude Code (Backend Development)
**–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞:** 2025-11-05
