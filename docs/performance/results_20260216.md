# Performance Results (local) — 2026-02-16

Цель: доказуемые улучшения latency/throughput + устойчивости, без изменения публичных URL/контрактов.

Окружение:
- local `uvicorn` (single process)
- `BOT_ENABLED=false` (чтобы исключить внешние Telegram вызовы)
- метрики включены: `METRICS_ENABLED=1`, `PERF_DIAGNOSTIC_HEADERS=1`
- профиль нагрузки: `scripts/loadtest_http_capacity.sh` (`TARGET_TOTALS="500 800 1200"`, `DURATION_SECONDS=30`)

Артефакты (сырье):
- baseline: `.local/loadtest/capacity_20260216_230448/total_*/summary.txt`
- ASGI middlewares (без stale): `.local/loadtest/capacity_20260216_232006_asgi2/total_*/summary.txt`
- stale-while-revalidate: `.local/loadtest/capacity_20260216_233208_stale/total_*/summary.txt`
- Prometheus snapshots per step: `.../total_*/metrics.txt`

## До / После (step total=800)

Источник: `summary.txt` в директориях выше.

| run | achieved RPS (total) | dashboard_summary p99 | dashboard_incoming p99 | health p99 | notes |
|---|---:|---:|---:|---:|---|
| baseline | 307 | 14482 ms | 14486 ms | 10707 ms | сильная деградация, много client timeouts/errors |
| ASGI (no stale) | 1052 | 8134 ms | 10012 ms | 6900 ms | крупный прирост throughput за счет отказа от BaseHTTPMiddleware |
| ASGI + stale | 931 | 1297 ms | 5943 ms | 8930 ms | резко улучшен tail у `dashboard_summary` (SWR), но health в этом synthetic-профиле перегружен (health rate слишком высокий) |

## Основные выводы

1. Главный bottleneck baseline: middleware overhead (`BaseHTTPMiddleware`) + очереди событийного цикла под high concurrency.
   - Фикс: перевели perf/security/degraded middlewares на ASGI стиль.
   - Эффект: +3.4x achieved RPS на шаге total=800 (307 → 1052).

2. Tail latency на hot endpoints во многом определяется поведением микрокэша на expiry (head-of-line blocking).
   - Фикс: stale-while-revalidate (SWR) для microcache через `stale_seconds`.
   - Эффект: `dashboard_summary` p99 на step total=800 улучшился (8134 ms → 1297 ms) при сопоставимом achieved RPS.

3. Health-check нагрузка в текущем synthetic mix завышена (не “похоже на жизнь”), поэтому health p99/timeouts могут выглядеть хуже в SWR run.
   - Рекомендация: добавить отдельный “life-like” профиль с низкой долей `/health` и `/auth/token` (см. `docs/performance/loadtesting.md`).

