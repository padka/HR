# Диагностика

1. **Зависимости для бота и форм**  
   • **Симптом:** импорт `apscheduler` и `python-multipart` роняет приложение и тесты при неполной установке.  
   • **Причина:** модули используются в коде (`apscheduler` в бот-сервисах, `Form` в роутерах) и должны присутствовать в базовых зависимостях.  
   • **Подтверждение:** импорт `AsyncIOScheduler` из `apscheduler` в `backend/apps/bot/services.py`, обработка HTML-форм в `backend/apps/admin_ui/routers/candidates.py`.  
   • **Ориентировочный фикс:** держать обязательные пакеты (`apscheduler`, `python-multipart`) в `[project.dependencies]` и устанавливать через `pip install -e ".[dev]"`.

2. **Миграции не применяются при чистом старте**  
   • **Симптом:** сервер не поднимается без предварительно созданной базы — старт ломается на таблице `slot_reminder_jobs`.  
   • **Причина:** bootstrap запускает alembic-миграции (`backend/migrations/runner.py`), но `alembic` не включён в установку по умолчанию, поэтому на свежей среде таблицы напоминаний отсутствуют.  
   • **Подтверждение:** новая база падает в `slot_reminder_jobs` (см. `audit/smoke_no_db.log`), при этом миграция `0008_add_slot_reminder_jobs.py` ожидает alembic.  
   • **Ориентировочный фикс:** добавить `alembic` в зависимости, включить smoke-тест на пустой `dev.db`, убедиться что `ensure_database_ready()` прогоняет весь стек миграций.

3. **API админки зависит от базовой аутентификации без дефолтных учётных данных**  
   • **Симптом:** защищённые роуты сразу отвечают 503/401 пока не заведены переменные окружения `ADMIN_USER`/`ADMIN_PASSWORD`.  
   • **Причина:** `require_admin` жёстко требует настройки HTTP Basic (`backend/apps/admin_ui/security.py`), в `.env.example` лежат демо-логин/пароль.  
   • **Подтверждение:** описание проверок в `backend/apps/admin_ui/security.py` и дефолт `ADMIN_USER=admin` в `.env.example`.  
   • **Ориентировочный фикс:** задокументировать обязательность переопределения, добавить проверку на запуск в prod без настоящих секретов, рассмотреть modern auth (session/JWT).

4. **Пользовательские тесты не совместимы с Starlette 0.37**  
   • **Симптом:** `pytest` падает на `TypeError: TestClient.request() got an unexpected keyword argument 'allow_redirects'`.  
   • **Причина:** тесты написаны под API `allow_redirects`, который удалён в текущей версии `TestClient`.  
   • **Подтверждение:** trace в `audit/pytest.log`.  
   • **Ориентировочный фикс:** обновить хелпер `_async_request` с использованием `client.request(..., follow_redirects=...)` или ручной обработки редиректов; зафиксировать версию starlette/fastapi в requirements если изменить тесты нельзя.

5. **Автотесты Playwright не воспроизводимы из коробки**  
   • **Симптом:** `test_ui_screenshots` падает с ошибкой об отсутствии `chromium` binary.  
   • **Причина:** CI/документация не выполняют `playwright install`, бинарники не кешируются.  
   • **Подтверждение:** лог ошибки в `audit/pytest.log`.  
   • **Ориентировочный фикс:** добавить шаг `playwright install --with-deps` в setup (Makefile/CI), либо зафиксировать снимки без реального браузера.

6. **Локализация Liquid Glass неполная**  
   • **Симптом:** генерация CSS (Tailwind) выдаёт только ~60 уникальных селекторов, токены используются частично, нет build-артефактов для js.  
   • **Причина:** Tailwind конфиг расширен под стекло, но шаблоны всё ещё содержат «обычные» классы, нет проверки дизайна в CI.  
   • **Подтверждение:** `tailwind.config.js` и метрики `audit/METRICS.md`.  
   • **Ориентировочный фикс:** провести ревизию шаблонов, внедрить гайды Liquid Glass (градиенты, blur, состояния), добавить визуальные снапшоты в тесты.
