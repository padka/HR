# Агент Scheduler Architect

## Цель
Перестроить планировщик слотов: учесть квоты по городам, нормализацию часовых поясов и сценарии напоминаний, обеспечить надёжную статус-машину для кандидатов.

## Контекст
- Слоты и расписание обслуживаются `backend/apps/admin_ui/routers/slots.py` и сервисами `services/dashboard_calendar.py`, `services/kpis.py`.
- Данные городов и TZ: модели в `backend/domain/models.py`, справочник и утилиты в `backend/apps/admin_ui/timezones.py`.
- Напоминания бот-сервиса управляются через `backend/apps/admin_ui/services/bot_service.py` и state-manager (`app.state.reminder_service`).
- KPI и календарь отображаются в шаблоне `templates/index.html` и `templates/slots_list.html`.

## Основные направления
1. **Модель квот**
   - Описать хранение квот на слоты по городам/датам (`City`, `Slot`, дополнительные таблицы при необходимости).
   - Предусмотреть API для изменения квот (PATCH/PUT) и отображение в UI.
2. **Нормализация часовых поясов**
   - Все расчёты приводить к recruiter_tz (по умолчанию `settings.timezone`, см. `timezones.py`).
   - Для кандидатов хранить tz в карточке кандидата; добавить конверсию recruiter↔candidate при подтверждении слота.
   - Описать стратегию хранения `tz` в БД и передачу в UI (фильтры, отображение дат, ISO-строки).
3. **Напоминания и follow-up**
   - Сформировать очередь задач: приглашения, подтверждения, напоминания, итоговые сообщения.
   - Прописать SLA и триггеры (например, T-24, T-1, T-0.5) с учётом локальных TZ.
   - Указать точки интеграции с ботом (`bot_service`), логирование событий.
4. **Статус-машина**
   - Определить состояния кандидата в процессе интервью (PENDING → BOOKED → CONFIRMED_BY_CANDIDATE → PASSED/FAILED → COMPLETED/CANCELED).
   - Определить переходы и проверки (квота, наличие слота, блокировки по городу).
5. **API и события**
   - Указать какие REST/GraphQL/Background tasks требуются, какие доменные события эмитить (например, `slot.booked`, `candidate.no_show`).
   - Описать аудит-лог (таблица + UI) и уведомления для рекрутёров.

## Готовность
- Документируйте решения в ADR при изменениях схемы.
- Обновите `codex/context/decisions.log.md` после согласования.
- Подготовьте DoD чеклист (см. `codex/context/audit.md`) и включите smoke-тест слотов в `codex/tasks/e2e_basics.yaml`.
