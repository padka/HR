# Руководство по разработке

## Стиль кода
- **Python:** PEP 8 + типы. Используем `mypy`, `ruff` (или эквивалент) и форматирование `black`. Асинхронные роуты должны возвращать `TemplateResponse`/`JSONResponse` с явным контекстом.
- **Jinja:** все шаблоны расширяют `base.html` и используют макросы из `page_primitives.html`. Запрещены inline-стили и `<script>` внутри шаблонов после миграции на Vite — только `{% vite_asset %}` (см. manifest-helper).
- **CSS:** основной слой уходит в `tokens.css` (дизайн-токены), `components.css` (UI-core), `pages/*.css` (специфика страниц). Tailwind utility-классы допускаются, но кастомные правила должны быть сгруппированы по токенам.
- **JS:** модули ES в `static/js/modules/` или Vite entrypoints. В коде используем `data-*` селекторы и событийную модель без глобальных побочных эффектов.

## Ветвление и коммиты
- `main` — продакшн.
- `develop` — интеграционный стенд.
- `feature/*` — задачи и спайки.
- Коммиты — Conventional Commits (`type(scope): message`). В этом репозитории используем `feat`, `fix`, `chore`, `docs`, `refactor`, `test`.

## Definition of Done
1. Линтеры и тесты (`npm run lint`, `npm run test`, `pytest`, `mypy`) — зелёные.
2. Vite бандл собран, манифест обновлён, шаблоны используют manifest-helper.
3. Нет inline CSS/JS, все ассеты подключаются через Vite.
4. Скриншоты/видео ключевых экранов и отчёт axe (минимум для изменённых страниц).
5. Обновлённые ADR/решения добавлены в `codex/context/decisions.log.md`, риски — в `codex/context/risks.md`.
6. Обновлён чеклист ревью в PR, задачи связаны с трекером.

## Code review чеклист
- ✅ Проверить доступность: клавиатура, focus-trap, `aria-*`, prefers-reduced-motion.
- ✅ Убедиться, что фильтры/таблицы используют новые UI-core компоненты.
- ✅ Проверить отсутствие дублирования CSS и неиспользуемых классов.
- ✅ Подтвердить корректность работы TZ-конверсий и форматов дат.
- ✅ Проверить, что системные логи и телеметрия не сломаны (`static/js/ux-telemetry.js`).
- ✅ Верифицировать миграции БД (если добавлены) в sandbox, но в Codex-PR миграции запрещены.

## Оргструктура и процессы
- **Роли:** см. `codex/context/dev_department.md` (Frontend Refactorer, Scheduler Architect, QA E2E, DevOps CI).
- **Бранчи:** `main` → прод, `develop` → staging, `feature/*` → задачи. Мердж через PR с ревью минимум от двух ролей (домен + QA/DevOps по необходимости).
- **Процессы:** недельные спринты, планирование по чеклисту из `codex/tasks/*.yaml`, демо по пятницам, ретро понедельник. Для каждой фичи формируется RACI-матрица (см. dev_department.md).
- **DoD:** описан выше; дополнительно — снапшоты UI и логирование изменений в `decisions.log.md`.
- **PR-правила:** описание проблемы, ссылки на задачи, чеклист ревью, результат тестов с командами и логами.

## Запреты
- Нет inline `<style>` и `<script>` в шаблонах (кроме временных заглушек, описанных в ADR и audit).
- Не коммитим собранные артефакты Vite в `static/build/`.
- Не меняем миграции и схемы БД в Codex PR.
- Не используем прямые обращения `/static/...` в шаблонах — только `url_for` или manifest-helper.

## Полезные ссылки
- `codex/context/audit.md` — полный аудит и план фиксов.
- `codex/context/guide_full.md` — детальное описание архитектуры и процессов.
- `codex/tasks/*.yaml` — стартовые дорожные карты и сценарии автоматизации.
