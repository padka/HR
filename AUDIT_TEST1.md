# Тест 1 → слот → решение рекрутёра → уведомления → подтверждение кандидата — аудит

## Резюме
- Проведён полный разбор сквозного сценария: бот (Test 1, выбор слота, уведомления), API/админка (подтверждение/перенос/отказ), модели/миграции, планировщик напоминаний.
- Найдено 2 критичных дефекта (P0–P1), подтверждённых красными тестами в `tests/audit_failing_tests/`.
- Подготовлены диаграммы, контрактная матрица, чек-листы и пошаговый план фиксов/миграций.

## Находки

### P0 — NotificationLog не очищается при повторном использовании слота
- **Evidence:**
  - `handle_approve_slot()` проверяет только наличие записи `notification_logs` и полностью пропускает рассылку/напоминания, если она осталась с прошлого кандидата.【F:backend/apps/bot/services.py†L1831-L1919】
  - `reject_slot()` (используется при переносе, отказе, отмене кандидатом) сбрасывает только поля слота и блокировки, но не удаляет NotificationLog.【F:backend/domain/repositories.py†L520-L535】
  - `confirm_slot_by_candidate()` также полагается на `NotificationLog` без привязки к кандидату; старая запись приводит к статусу `already_confirmed`.【F:backend/domain/repositories.py†L316-L360】
  - Красный сценарный тест `test_reapprove_after_reschedule_notifies_new_candidate` демонстрирует тишину при повторной отправке слота другому кандидату.【F:tests/audit_failing_tests/test_notification_logs.py†L1-L115】
- **Impact:**
  - Новый кандидат не получает сообщение о согласовании и напоминания; рекрутёр уверен, что уведомление ушло. SLA сорвано, кандидат просто не приходит.
  - При попытке подтвердить участие с того же `slot_id` бот отвечает «Уже подтверждено», ссылка/клавиатура не высылаются.
  - Напоминания (t-2h/t-1h) тоже не планируются, т.к. `schedule_for_slot()` вызывается только внутри ветки «еще не отправляли».【F:backend/apps/bot/services.py†L1886-L1917】
- **Repro:**
  1. Кандидат А бронирует слот → рекрутёр жмёт «Согласовано» → бот шлёт сообщение (формируется запись NotificationLog).
  2. Рекрутёр жмёт «Перенести» → слот очищен, NotificationLog остался.
  3. Кандидат B бронирует этот же слот → рекрутёр снова жмёт «Согласовано» → бот ничего не шлёт, напоминания не создаются. (См. тест `test_notification_logs.py`).
  4. Кандидат B пытается подтвердить участие → `confirm_slot_by_candidate` возвращает `already_confirmed`, клавиатура снимается без ссылки.
- **Root cause:**
  - Idempotency реализована через `notification_logs` с ключом `(type, booking_id)` без учёта текущего кандидата. Очистка логов при смене кандидата отсутствует.
  - Повторные действия рекрутёра/кандидата интерпретируются как дубликат прошлой сессии и блокируют критические уведомления.
- **Fix plan:**
  - Добавить очистку (`DELETE FROM notification_logs WHERE booking_id=:slot_id`) в `reject_slot()` и при других сценариях освобождения/переноса.
  - Расширить модель `NotificationLog` (и миграцией) полем `candidate_tg_id`, использовать составной ключ `(type, booking_id, candidate_tg_id)`.
  - Обновить `notification_log_exists`/`add_notification_log`, `confirm_slot_by_candidate`, `handle_approve_slot` на работу с новым ключом.
  - Покрыть тестами happy-path и рескейл (включая новый `tests/audit_failing_tests/test_notification_logs.py`).
- **Risk & Rollback:**
  - Миграция с изменением уникального индекса требует аккуратной разовой очистки «зависших» логов; предусмотреть бэкап таблицы.
  - При откате — удалить новое поле, вернуть старый индекс и восстановить старую логику.

### P1 — Кандидат с подтверждённым слотом может забронировать второй слот того же рекрутёра
- **Evidence:**
  - В `reserve_slot()` поиск активной брони фильтрует только `PENDING` и `BOOKED`, игнорируя `CONFIRMED_BY_CANDIDATE`, поэтому подтверждённая встреча не блокирует новую бронь.【F:backend/domain/repositories.py†L364-L420】
  - Уникальный индекс `uq_slots_candidate_recruiter_active` также исключает статус `confirmed_by_candidate`, что позволяет обходить проверку на уровне БД.【F:backend/migrations/versions/0007_prevent_duplicate_slot_reservations.py†L20-L50】
  - Красный тест `test_confirmed_candidate_cannot_double_book_same_recruiter` фиксирует возможность второй брони после подтверждения первой.【F:tests/audit_failing_tests/test_double_booking.py†L1-L55】
- **Impact:**
  - Один кандидат занимает несколько слотов одного рекрутёра; расписание разъезжается, планировщик напоминаний работает с обоими слотами, возникает риск «no show».
  - Аналитика по конверсии/выполнению плана искажается (дублирующиеся брони).
- **Repro:**
  1. Забронировать слот и довести до `confirmed_by_candidate` (Test 1 → слот → «Согласовано» → «Подтверждаю»).
  2. Выбрать второй слот того же рекрутёра — бот успешно резервирует, возвращает `reserved` (см. тест `test_double_booking.py`).
- **Root cause:**
  - Логика и уникальный индекс не рассматривают `CONFIRMED_BY_CANDIDATE` как «активную» бронь.
  - Нет дополнительной проверки по кандидату вне зависимости от рекрутёра (миграция ограничивает только пару кандидат–рекрутёр, но не сценарий «несколько рекрутёров»).
- **Fix plan:**
  - В `reserve_slot()` расширить фильтр `existing_active` на `SlotStatus.CONFIRMED_BY_CANDIDATE` (и при необходимости на все «живые» статусы).
  - Обновить индекс `uq_slots_candidate_recruiter_active` (миграция с `WHERE lower(status) IN ('pending','booked','confirmed_by_candidate')`).
  - Добавить интеграционный тест «подтверждён → повторная бронь» (см. красный тест) и happy-path.
  - Подумать о дополнительном ограничении «кандидат не может бронировать несколько рекрутёров одновременно» (при необходимости бизнеса).
- **Risk & Rollback:**
  - Миграция изменяет условный индекс — выполнять в низкую нагрузку или с `CONCURRENTLY` (PostgreSQL). Откат — вернуть старый индекс.

### P2 — В админке не видны подтверждённые слоты в сводных счётчиках
- **Evidence:** на списке слотов отображаются только `FREE/PENDING/BOOKED`; `CONFIRMED_BY_CANDIDATE` не выводится в статистике сверху.【F:backend/apps/admin_ui/routers/slots.py†L82-L104】
- **Impact:** рекрутёры/лиды не видят фактическое число подтверждённых интервью, сложнее отслеживать выполнение плана и плотность расписания.
- **Repro:** в админке открыть `/slots` после подтверждения кандидатом — счётчики не меняются.
- **Root cause:** словарь `status_counts` заполняется вручную без ключа `CONFIRMED`.
- **Fix plan:** расширить словарь и шаблон, добавить тест шаблона/сервиса `list_slots`.
- **Risk & Rollback:** минимальны, UI-изменение; при откате вернуть старый словарь.

## Покрытие тестами
- Добавлены красные тесты в `tests/audit_failing_tests/` для обоих критичных сценариев (рескейл/уведомления, повторная бронь).
- Нужны дополнительные регрессионные тесты после фиксов (отправка уведомлений, подтверждение кандидата, работа напоминаний, UI счётчики).

## Дополнительные наблюдения
- Планировщик (`ReminderService`) корректно пересоздаёт задания при переносе, работает в UTC (см. `schedule_for_slot`).
- Анти-дубли callback’ов реализованы через `TelegramCallbackLog` и работают штатно.
- Кэш городов/рекрутёров отсутствует, бот всегда обращается к БД (инвалидация не требуется).
- Все временные поля в моделях (`Slot`, `SlotReminderJob`, `NotificationLog`) хранятся в UTC с `timezone=True`.
